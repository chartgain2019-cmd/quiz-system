<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">    
	
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© html2canvas Ù„ØªØ­ÙˆÙŠÙ„ HTML Ø¥Ù„Ù‰ ØµÙˆØ±Ø© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
	    /* Ø¥ØµÙ„Ø§Ø­ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        button {
          border: none !important;
          outline: none !important;
        }

        .bg-gradient-to-r {
          background-image: linear-gradient(to right, var(--tw-gradient-from), var(--tw-gradient-to)) !important;
        }

        /* ØªØ£ÙƒÙŠØ¯ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .from-orange-500 {
          --tw-gradient-from: #f97316 !important;
        }

        .to-red-500 {
            --tw-gradient-to: #ef4444 !important;
        }

       .hover\:from-orange-600:hover {
          --tw-gradient-from: #ea580c !important;
       }

       .hover\:to-red-600:hover {
           --tw-gradient-to: #dc2626 !important;
        }
	    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© */
		.btn-retake {
           background: linear-gradient(to right, #f59e0b, #f97316) !important;
           color: white !important;
            padding: 12px 24px !important;
            border-radius: 12px !important;
            font-weight: 600 !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.2) !important;
        }

        .btn-retake:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 8px rgba(245, 158, 11, 0.3) !important;
           background: linear-gradient(to right, #d97706, #ea580c) !important;
        }

        .btn-clear-filters {
            background: linear-gradient(to right, #ef4444, #dc2626);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2);
        }

        .btn-clear-filters:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(239, 68, 68, 0.3);
            background: linear-gradient(to right, #dc2626, #b91c1c);
        }
		
        .result-details-modal {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
           from { opacity: 0; }
           to { opacity: 1; }
        }
		/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        .tab-content {
           min-height: 400px;
        }

        #settingsContent {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
		
		@keyframes fadeOut {
           from { opacity: 1; }
           to { opacity: 0; }
        }
		
		/* ØªØ®ØµÙŠØµ Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© */
        .feedback-time-up {
           background: linear-gradient(135deg, #fed7aa, #fdba74) !important;
           border: 2px solid #f97316 !important;
           color: #7c2d12 !important;
        }

        .feedback-correct {
            background: linear-gradient(135deg, #bbf7d0, #86efac) !important;
            border: 2px solid #16a34a !important;
            color: #166534 !important;
        }

        .feedback-wrong {
            background: linear-gradient(135deg, #fecaca, #fca5a5) !important;
            border: 2px solid #dc2626 !important;
            color: #991b1b !important;
        }

        /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ */
        #settingsContent input:not([readonly]):focus,
        #settingsContent select:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }

        #settingsContent input[readonly] {
            background-color: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }

        /* ØªØ­Ø³ÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tab-btn.active {
           box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¸Ø§Ù‡Ø± */
        #settingsContent:not(.hidden) {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .result-details-modal > div {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { 
               opacity: 0;
               transform: translateY(20px);
            }
            to { 
               opacity: 1;
               transform: translateY(0);
            }
        }
		
		/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ */
        #customDateRange {
            animation: slideDown 0.3s ease-out;
        }
		
		#customDateFilter {
           animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® */
        input[type="date"] {
            direction: ltr;
            text-align: right;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
           filter: invert(0.5);
           cursor: pointer;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰ */
        .btn-whatsapp {
            background: linear-gradient(to right, #22c55e, #16a34a);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(34, 197, 94, 0.2);
        }

        .btn-whatsapp:hover {
           transform: translateY(-2px);
           box-shadow: 0 6px 8px rgba(34, 197, 94, 0.3);
           background: linear-gradient(to right, #16a34a, #15803d);
        }

        .btn-certificate {
            background: linear-gradient(to right, #3b82f6, #1d4ed8);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
        }

        .btn-certificate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(59, 130, 246, 0.3);
            background: linear-gradient(to right, #2563eb, #1e40af);
        }
		
		/* Ø¥ØµÙ„Ø§Ø­ Ø£Ø²Ø±Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ */
        .bg-orange-500 {
           background-color: #f97316 !important;
        }

        .hover\:bg-orange-600:hover {
            background-color: #ea580c !important;
        }

        .bg-red-500 {
            background-color: #ef4444 !important;
        }

       .hover\:bg-red-600:hover {
           background-color: #dc2626 !important;
        }

       .bg-green-500 {
            background-color: #10b981 !important;
        }

       .hover\:bg-green-600:hover {
           background-color: #059669 !important;
        }

       .bg-blue-500 {
            background-color: #3b82f6 !important;
        }

        .hover\:bg-blue-600:hover {
            background-color: #2563eb !important;
        }

        .bg-purple-500 {
            background-color: #8b5cf6 !important;
        }

        .hover\:bg-purple-600:hover {
            background-color: #7c3aed !important;
        }
		
      	/* ØªØ­Ø³ÙŠÙ† ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .flex.gap-2 .bg-blue-500, 
        .flex.gap-2 .bg-red-500 {
           min-width: 80px;
           justify-content: center;
        }

        .flex.gap-2 .bg-blue-500:hover, 
        .flex.gap-2 .bg-red-500:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        body {
            box-sizing: border-box;
        }
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        * { font-family: 'Cairo', sans-serif; }
        
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .pulse-red { animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 
            0%, 100% { background-color: #ef4444; } 
            50% { background-color: #dc2626; } 
        }
        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ø§Ù„Ù…Ø¨Ø³Ø·Ø© */
		/* ========== Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© ÙˆØ§Ù„Ù…Ø¯Ù…Ø¬Ø© ========== */

        .question-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: grab;
            user-select: none;
            position: relative;
        }

        .question-item:active {
            cursor: grabbing;
        }

        .question-item.dragging {
            opacity: 0.6;
            transform: scale(0.95) rotate(1deg);
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe) !important;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3) !important;
            z-index: 1000;
        }

        .question-item.drag-over {
            border: 2px dashed #3b82f6 !important;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7) !important;
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
        }

        /* Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ø¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª */
        .question-item.drag-target {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9) !important;
        }

        .drag-handle {
            opacity: 0.6;
            cursor: grab;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drag-handle:hover {
            opacity: 1;
            background: rgba(59, 130, 246, 0.15) !important;
            transform: scale(1.05);
        }

        .question-item.dragging .drag-handle {
            cursor: grabbing;
            opacity: 0.9;
            background: rgba(59, 130, 246, 0.2) !important;
        }

        .question-item:hover .drag-handle {
            opacity: 0.9;
        }

        /* Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø³Ø­Ø¨ */
        .drop-indicator {
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            margin: 8px 0;
            border-radius: 3px;
            animation: pulse-blue 1.5s infinite;
        }

        @keyframes pulse-blue {
            0%, 100% { 
              opacity: 0.6;
              transform: scaleX(0.95);
            }
            50% { 
             opacity: 1;
             transform: scaleX(1);
            }
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨ØµØ±ÙŠ */
        .question-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .question-item.drag-over::before {
            opacity: 1;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© */
        @media (max-width: 768px) {
            .question-item {
              cursor: pointer;
            }
    
            .question-item.dragging {
               transform: scale(0.93);
            }
    
            .drag-handle {
               padding: 10px;
               opacity: 0.8;
            }
        }

        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù†Ø´Ø· */
        .question-item.dragging { 
           border: 2px solid #3b82f6 !important;
           box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4) !important;
        }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø³Ù„Ø³ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ */
       .questions-list {
           transition: all 0.3s ease;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„Ø´Ù‡Ø§Ø¯Ø© */
        @media print {
            body * {
                visibility: hidden;
            }
            #certificateContent, #certificateContent * {
                visibility: visible;
            }
            #certificateContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 2cm;
            }
            .no-print {
                display: none !important;
            }
        }
		
		/* Ù…Ø¤Ø´Ø±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù… */
        #serverStatusIndicator {
           animation: slideInUp 0.5s ease-out;
           font-family: 'Cairo', sans-serif;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
           to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #serverStatusIndicator.offline {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
        }

        #serverStatusIndicator.online {
            background: linear-gradient(135deg, #10b981, #059669) !important;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div id="welcomeScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700">
    <div class="container mx-auto px-6 py-12">
        <div class="max-w-4xl mx-auto text-center text-white">
            <div class="mb-8">
                <div class="w-24 h-24 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h1 class="text-5xl font-bold mb-4">Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</h1>
                <p class="text-xl mb-12 text-blue-100">Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø´Ø§Ù…Ù„Ø© ÙˆØ¢Ù…Ù†Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙƒÙŠØ© Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø§ÙØ³</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-12">
                <!-- Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
                <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-8 hover:bg-opacity-20 transition-all cursor-pointer" onclick="showStudentAccess()">
                    <div class="text-6xl mb-6">ğŸ‘¨â€ğŸ“</div>
                    <h3 class="text-2xl font-bold mb-4">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                    <p class="text-blue-100 mb-6">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</p>
                    <button class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-xl font-semibold transition-all">
                        Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†
                    </button>
                </div>

                <!-- Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† -->
                <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-8 hover:bg-opacity-20 transition-all cursor-pointer" onclick="showTeacherLogin()">
                    <div class="text-6xl mb-6">ğŸ‘¨â€ğŸ’¼</div>
                    <h3 class="text-2xl font-bold mb-4">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
                    <p class="text-blue-100 mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</p>
                    <button class="bg-purple-500 hover:bg-purple-600 text-white px-8 py-3 rounded-xl font-semibold transition-all">
                        Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                    </button>
                </div>
            </div>

            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-yellow-300" id="statsSchools">5</div>
                    <div class="text-sm text-blue-100">Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</div>
                </div>
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-green-300" id="statsTeachers">12</div>
                    <div class="text-sm text-blue-100">Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</div>
                </div>
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-pink-300" id="statsTests">48</div>
                    <div class="text-sm text-blue-100">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
                </div>
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-orange-300" id="statsResults">156</div>
                    <div class="text-sm text-blue-100">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…Ø¶Ø§Ù -->
    <footer class="absolute bottom-0 left-0 right-0 bg-gradient-to-r from-blue-800 to-purple-900 text-white py-4 text-center border-t border-blue-600">
        <div class="container mx-auto px-6">
            <p class="text-sm text-blue-200">
                Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© | ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ø£ØºØ±Ø§Ø¶ ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ù‡Ø±ÙŠ
            </p>
        </div>
    </footer>
</div>
<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† -->
<div id="teacherLoginScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-8 text-center">
            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…</h2>
        </div>
        
        <div class="p-8">
            <form id="teacherLoginForm" onsubmit="return teacherLogin(event)">
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="teacherEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"  required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="teacherPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"  required>
                </div>
                
                
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-xl font-semibold hover:from-purple-700 hover:to-blue-700 transition-all">
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </button>
                    <button type="button" onclick="closeTeacherLogin()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
                
                <div class="text-center mt-6 pt-6 border-t border-gray-200">
                    <p class="text-gray-600 mb-4">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</p>
                    <button type="button" onclick="showTeacherSignup()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-all">
                        Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </form>
            
            <div id="loginError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¹Ù„Ù… Ø¬Ø¯ÙŠØ¯ -->
<div id="teacherSignupScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-8 text-center">
            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¹Ù„Ù… Ø¬Ø¯ÙŠØ¯</h2>
        </div>
        
        <div class="p-8">
            <form id="teacherSignupForm" onsubmit="return teacherSignup(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="newTeacherName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="newTeacherEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
                    <input type="text" id="newTeacherSchool" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" required>
                </div>
                
                <!-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
                    <select id="newTeacherStage" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</option>
                        <option value="Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©">Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©</option>
                        <option value="Ù…ØªÙˆØ³Ø·Ø©">Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©</option>
                        <option value="Ø«Ø§Ù†ÙˆÙŠØ©">Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="newTeacherPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="confirmTeacherPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                </div>
                
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 text-white py-3 rounded-xl font-semibold hover:from-green-700 hover:to-blue-700 transition-all">
                        Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
                    </button>
                    <button type="button" onclick="closeTeacherSignup()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </form>
            
            <div id="signupError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
            <div id="signupSuccess" class="hidden mt-4 p-4 bg-green-50 border border-green-200 text-green-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ù„Ø·Ù„Ø§Ø¨ -->
<div id="studentAccessScreen" class="hidden container mx-auto px-6 py-12">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-8 text-center relative">
                <!-- Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
                <button onclick="goBackToWelcome()" class="absolute top-6 right-6 bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-xl transition-all">
                    â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </button>
                <div class="text-5xl mb-4">ğŸ“</div>
                <h1 class="text-3xl font-bold mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø·Ø§Ù„Ø¨</h1>
                <p class="text-blue-100">Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø±Ø³ØªÙƒ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</p>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl p-8 mb-8">
            <label class="block text-gray-800 font-bold mb-4 text-xl">ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø±Ø³ØªÙƒ</label>
            <!-- ØªØºÙŠÙŠØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¥Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« -->
            <input type="text" id="schoolSearch" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:border-blue-500 focus:outline-none" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù…Ø¯Ø±Ø³ØªÙƒ Ù„Ù„Ø¨Ø­Ø«..." oninput="searchSchools()">
            <p class="text-sm text-gray-500 mt-2">Ø§Ø¨Ø¯Ø£ Ø¨ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§</p>
            
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« -->
            <div id="schoolSearchResults" class="mt-4 max-h-60 overflow-y-auto hidden border border-gray-200 rounded-xl">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ù‡Ù†Ø§ -->
            </div>
        </div>

        <div id="selectedSchoolInfo" class="hidden bg-white rounded-3xl shadow-xl p-8">
            <div class="bg-green-50 p-6 rounded-2xl mb-6 border border-green-200">
                <h3 class="text-xl font-bold text-green-800 mb-4">Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-green-600 font-semibold">ğŸ« Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</span>
                        <span id="chosenSchoolName" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-green-600 font-semibold">ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…:</span>
                        <span id="chosenTeacher" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-gray-800 font-bold mb-4">ğŸ“ Ø§Ø®ØªØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
                <select id="testSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:border-blue-500 focus:outline-none" onchange="selectTest()">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</option>
                </select>
            </div>

            <div id="testInfo" class="hidden bg-blue-50 p-6 rounded-2xl mb-6 border border-blue-200">
                <h3 class="font-bold text-blue-800 mb-4">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-blue-600 font-semibold">ğŸ“– Ø§Ù„Ù…Ø§Ø¯Ø©:</span>
                        <span id="testSubject" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">â“ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</span>
                        <span id="testQuestions" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">ğŸ’ Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</span>
                        <span id="testGrade" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">â±ï¸ ÙˆÙ‚Øª Ø§Ù„Ø³Ø¤Ø§Ù„:</span>
                        <span id="testTimer" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                </div>
            </div>

            <div id="studentForm" class="hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-6">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ *</label>
                        <input type="text" id="studentName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
                    </div>
                    <!-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø¨Ø¹Ø¯ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ *</label>
                        <select id="studentGrade" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            <option value="">Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„ÙØµÙ„ *</label>
                        <input type="text" id="studentClass" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Ù…Ø«Ø§Ù„: 6Ø£">
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="startTest()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-12 py-4 rounded-xl text-xl font-bold hover:from-green-600 hover:to-blue-600 transition-all shadow-lg">
                        ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
<div id="testScreen" class="hidden container mx-auto px-6 py-8">
    <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
            <div class="flex justify-between items-center text-sm">
                <div class="flex gap-4">
                    <span>ğŸ« <span id="testSchoolName"></span></span>
                    <span>ğŸ“– <span id="testSubjectName"></span></span>
                    <span>ğŸ’ <span id="testGradeLevel"></span></span>
                    <span>ğŸ‘¤ <span id="testStudentName"></span></span>
                </div>
                <div class="flex gap-4">
                    <span>â“ <span id="currentQuestion">1</span> Ù…Ù† <span id="totalQuestions">5</span></span>
                    <span>â­ <span id="currentScore">0</span></span>
                </div>
            </div>
        </div>
        
        <div class="p-4 bg-gray-50">
            <div class="bg-gray-200 rounded-full h-3">
                <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl p-8">
            <div class="text-center mb-8">
                <div id="timer" class="inline-block bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-2xl font-bold">30</div>
                <p class="text-gray-600 mt-2">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</p>
            </div>
            
            <div class="mb-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center" id="questionText">Ù…Ø§ Ù‡Ùˆ Ù†Ø§ØªØ¬ 2 + 2ØŸ</h3>
                
                <div class="grid gap-4" id="optionsContainer">
                    <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù‡Ù†Ø§ -->
                </div>
            </div>
            
            <div id="feedbackArea" class="hidden text-center p-4 rounded-xl mb-6"></div>
            
            <div class="text-center pt-6 border-t border-gray-200">
                <button onclick="confirmExitTest()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                    ğŸšª Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ -->
<div id="exitTestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl max-w-md w-full overflow-hidden">
        <div class="bg-red-500 text-white p-6 text-center">
            <div class="text-4xl mb-2">âš ï¸</div>
            <h2 class="text-xl font-bold">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬</h2>
        </div>
        <div class="p-6 text-center">
            <p class="text-gray-700 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ</p>
            <div class="flex gap-4">
                <button onclick="exitTest()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold transition-all">
                    Ù†Ø¹Ù…ØŒ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
                <button onclick="cancelExitTest()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
<div id="resultsScreen" class="hidden container mx-auto px-6 py-12">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden text-center">
            <div class="bg-gradient-to-r from-green-500 to-blue-500 text-white p-12">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <h2 class="text-3xl font-bold mb-2">ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ Ø¹Ù„Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h2>
                <p class="text-green-100">Ø¥Ù„ÙŠÙƒ Ù†ØªØ§Ø¦Ø¬Ùƒ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</p>
            </div>
            
            <div class="p-12">
                <div class="grid md:grid-cols-3 gap-8 mb-8">
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-200">
                        <div class="text-4xl mb-2">ğŸ“Š</div>
                        <h3 class="font-bold text-blue-800 mb-2">Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
                        <p class="text-3xl font-bold text-blue-600" id="finalScore">0</p>
                    </div>
                    
                    <div class="bg-green-50 p-6 rounded-2xl border border-green-200">
                        <div class="text-4xl mb-2">ğŸ“ˆ</div>
                        <h3 class="font-bold text-green-800 mb-2">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</h3>
                        <p class="text-3xl font-bold text-green-600" id="percentage">0%</p>
                    </div>
                    
                    <div class="bg-purple-50 p-6 rounded-2xl border border-purple-200">
                        <div class="text-4xl mb-2">ğŸ†</div>
                        <h3 class="font-bold text-purple-800 mb-2">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</h3>
                        <p class="text-2xl font-bold text-purple-600" id="grade">-</p>
                    </div>
                </div>
                
                <div class="flex flex-wrap justify-center gap-4">
                    <button onclick="showCertificate()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-600 transition-all">
                        ğŸ… Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
                    </button>
                    
                    <button onclick="shareWhatsApp()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        ğŸ“± Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
                    </button>
					
                    <button onclick="retakeTest()" class="btn-retake">
                       ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </button>
                    
                    <button onclick="goBackToSchoolSelection()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        â† Ø§Ù„Ø¹ÙˆØ¯Ø©
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Canvas Ø§Ù„Ù…Ø­Ø³Ù†Ø© -->
<div id="certificateScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl max-w-4xl w-full max-h-screen overflow-y-auto no-print">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 text-center no-print">
            <h2 class="text-2xl font-bold">ğŸ† Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø² Ù…Ø­Ø³Ù†Ø©</h2>
        </div>
        
        <div class="p-8">
            <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© -->
            <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-4 border-blue-300 rounded-2xl p-8 mb-6">
                <div id="certificatePreview" class="text-center">
                    <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù‡Ù†Ø§ -->
                </div>
            </div>
            
            <!-- canvas Ù…Ø®ÙÙŠ Ù„Ø±Ø³Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© -->
            <canvas id="certificateCanvas" class="hidden" width="2480" height="3508"></canvas>
        </div>
        
        <div class="p-6 text-center border-t border-gray-200 no-print">
            <button onclick="generateCertificateImage('png')" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all mr-4">
                ğŸ“¸ Ø­ÙØ¸ ÙƒØµÙˆØ±Ø© PNG
            </button>
            <button onclick="generateCertificateImage('jpg')" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl font-semibold transition-all mr-4">
                ğŸ–¼ï¸ Ø­ÙØ¸ ÙƒØµÙˆØ±Ø© JPG
            </button>
            <button onclick="closeCertificate()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                Ø¥ØºÙ„Ø§Ù‚
            </button>
        </div>
    </div>
</div>

<!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù… -->
<div id="teacherDashboard" class="hidden container mx-auto px-6 py-8">
    <!-- Ù…Ø­ØªÙˆÙ‰ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù… -->
    <div class="bg-white rounded-3xl shadow-xl">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-8 rounded-t-3xl">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</h1>
                    <p class="text-purple-100" id="teacherWelcome">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ù‡Ø±ÙŠ</p>
                </div>
                <button onclick="teacherLogout()" class="bg-red-500 hover:bg-red-600 px-6 py-3 rounded-xl font-semibold transition-all">
                    ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>
        
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
        <div class="bg-gray-50 px-8 py-4 border-b border-gray-200">
            <div class="flex gap-2 overflow-x-auto">
                <button onclick="showTab('dashboard')" id="dashboardTab" class="tab-btn active bg-white text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                </button>
                <button onclick="showTab('tests')" id="testsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                </button>
                <button onclick="showTab('questions')" id="questionsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    â“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                </button>
                <button onclick="showTab('results')" id="resultsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    ğŸ“ˆ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨
                </button>
                <button onclick="showTab('settings')" id="settingsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
                </button>
            </div>
        </div>
        
        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
        <div class="p-8">
            <!-- ØªØ¨ÙˆÙŠØ¨ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
            <div id="dashboardContent" class="tab-content">
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded-2xl text-center border border-blue-200">
                        <div class="text-4xl mb-2">ğŸ“</div>
                        <div class="text-3xl font-bold text-blue-600" id="totalTests">1</div>
                        <div class="text-gray-600">Ø§Ø®ØªØ¨Ø§Ø±Ø§ØªÙŠ</div>
                    </div>
                    <div class="bg-green-50 p-6 rounded-2xl text-center border border-green-200">
                        <div class="text-4xl mb-2">ğŸ‘¥</div>
                        <div class="text-3xl font-bold text-green-600" id="totalStudents">0</div>
                        <div class="text-gray-600">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-2xl text-center border border-purple-200">
                        <div class="text-4xl mb-2">ğŸ“Š</div>
                        <div class="text-3xl font-bold text-purple-600" id="averageScore">0%</div>
                        <div class="text-gray-600">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
                    </div>
                    <div class="bg-orange-50 p-6 rounded-2xl text-center border border-orange-200">
                        <div class="text-4xl mb-2">ğŸ¯</div>
                        <div class="text-3xl font-bold text-orange-600" id="passRate">0%</div>
                        <div class="text-gray-600">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-6 rounded-2xl border border-blue-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª:</span>
                                <span class="font-bold text-blue-600" id="totalAttempts">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©:</span>
                                <span class="font-bold text-green-600" id="highestScore">0%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø©:</span>
                                <span class="font-bold text-red-600" id="lowestScore">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-50 to-blue-50 p-6 rounded-2xl border border-green-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ¯ Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ØªØ­Ø³ÙŠÙ†</h3>
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded-xl">
                                <div class="text-sm text-gray-600 mb-1">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                                    </div>
                                    <span class="text-sm font-bold">85%</span>
                                </div>
                            </div>
                            <div class="bg-white p-3 rounded-xl">
                                <div class="text-sm text-gray-600 mb-1">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: 80%"></div>
                                    </div>
                                    <span class="text-sm font-bold">80%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª -->
            <div id="testsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h3>
                    <button onclick="showCreateTestModal()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-600 transition-all">
                        â• Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
                
                <div id="testsGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‡Ù†Ø§ -->
                </div>
            </div>
            
            <!-- ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
            <div id="questionsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">â“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
                    <div class="flex gap-4">
                        <select id="questionTestSelect" class="border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="loadTestQuestions()">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</option>
                        </select>
                        <button onclick="showAddQuestionModal()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-green-600 hover:to-blue-600 transition-all">
                            â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„
                        </button>
                    </div>
                </div>
                
                <div id="questionsContainer">
                    <div class="text-center text-gray-500 py-12">
                        <div class="text-6xl mb-4">â“</div>
                        <p>Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p>
                    </div>
                </div>
            </div>
            
            <!-- ØªØ¨ÙˆÙŠØ¨ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
            <div id="resultsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">ğŸ“ˆ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                            ğŸ“Š Excel
                        </button>
                        <button onclick="exportFilteredToExcel()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                            ğŸ” Excel Ù…ÙÙ„ØªØ±
                        </button>
                        <button onclick="exportResults()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                            ğŸ“ CSV
                        </button>
                        <button onclick="clearAllFilters()" class="btn-clear-filters">
                            ğŸ”„ Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
                        </button>
                    </div>
                </div>
                
                <!-- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù… -->
                <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="text-2xl">ğŸ”</div>
                        <h4 class="text-lg font-bold text-gray-800">Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h4>
                        <div class="flex-1"></div>
                        <button onclick="toggleAdvancedFilters()" id="toggleFiltersBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-all">
                            Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
                        </button>
                    </div>
                    
                    <!-- Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                        <input type="text" id="searchStudentName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø¨Ø­Ø«..." oninput="filterResults()">
                    </div>
                    
                    <!-- Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
                    <div id="advancedFilters" class="hidden">
                        <div class="grid md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <!-- ÙÙ„ØªØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">ğŸ“ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
                                <select id="filterTestSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</option>
                                </select>
                            </div>
                            
                            <!-- ÙÙ„ØªØ± Ø§Ù„ÙØµÙ„ -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">ğŸ« Ø§Ù„ÙØµÙ„</label>
                                <select id="filterClassSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                                </select>
                            </div>
                            
                            <!-- ÙÙ„ØªØ± Ø§Ù„ØªÙ‚Ø¯ÙŠØ± -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">ğŸ† Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</label>
                                <select id="filterGradeSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª</option>
                                    <option value="Ù…Ù…ØªØ§Ø²">Ù…Ù…ØªØ§Ø²</option>
                                    <option value="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</option>
                                    <option value="Ø¬ÙŠØ¯">Ø¬ÙŠØ¯</option>
                                    <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„</option>
                                    <option value="Ø¶Ø¹ÙŠÙ">Ø¶Ø¹ÙŠÙ</option>
                                </select>
                            </div>
                            
                            <!-- ÙÙ„ØªØ± Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">ğŸ“Š Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</label>
                                <select id="filterPercentageSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨</option>
                                    <option value="90-100">90% - 100%</option>
                                    <option value="80-89">80% - 89%</option>
                                    <option value="70-79">70% - 79%</option>
                                    <option value="60-69">60% - 69%</option>
                                    <option value="0-59">Ø£Ù‚Ù„ Ù…Ù† 60%</option>
                                </select>
                            </div>
                            
							<!-- ÙÙ„ØªØ± Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© -->
                            <div>
                               <label class="block text-gray-700 font-semibold mb-2">ğŸ¯ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø©</label>
                               <select id="filterScoreSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value=""> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª </option>
                                    <option value="score-desc">Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø© (ØªØµØ§Ø¹Ø¯ÙŠ)</option>
                                    <option value="score-asc">Ø§Ù„Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø© (ØªÙ†Ø§Ø²Ù„ÙŠ)</option>
                                </select>
                            </div>
                            
                            <!-- ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                                <select id="filterDateSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</option>
                                    <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                                    <option value="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
                                    <option value="month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
                                    <option value="custom">ØªØ§Ø±ÙŠØ® Ù…Ø­Ø¯Ø¯</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ù…Ø­Ø¯Ø¯ -->
                        <div id="customDateFilter" class="hidden mt-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                                    <input type="date" id="filterDateFrom" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                                    <input type="date" id="filterDateTo" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ÙÙ„ØªØ±Ø© -->
                    <div id="filterStats" class="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-blue-600" id="filteredCount">0</div>
                                <div class="text-sm text-blue-600">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-green-600" id="filteredAverage">0%</div>
                                <div class="text-sm text-green-600">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†Ø³Ø¨</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-purple-600" id="filteredPassRate">0%</div>
                                <div class="text-sm text-purple-600">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-orange-600" id="filteredHighest">0%</div>
                                <div class="text-sm text-orange-600">Ø£Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø©</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-6 rounded-2xl">
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white rounded-xl overflow-hidden">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‡Ù†Ø§ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
            <div id="settingsContent" class="tab-content hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h4>
                        <form onsubmit="return updateProfile(event)">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                                <input type="text" id="profileName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                <input type="email" id="profileEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 bg-gray-100" readonly>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
                                <input type="text" id="profileSchool" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
                                <select id="profileStage" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                                    <option value="Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©</option>
                                    <option value="Ù…ØªÙˆØ³Ø·Ø©">Ù…ØªÙˆØ³Ø·Ø©</option>
                                    <option value="Ø«Ø§Ù†ÙˆÙŠØ©">Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition-all">
                                Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                            </button>
                        </form>
                    </div>
					<!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØµØ­ÙŠØ­ - Ø³ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù€ chartgain2019@gmail.com -->
                    <div id="debugToolsSection" class="hidden">
                       <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                           <h4 class="text-lg font-bold text-yellow-800 mb-2">ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØµØ­ÙŠØ­ (Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„)</h4>
                           <div class="flex gap-2">
                                <button onclick="initializeDefaultData()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                   Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                </button>
                                <button onclick="debugData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                   ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                </button>
                                <button onclick="debugSystem()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…
                                </button>
                                <button onclick="showAllSchools()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                                </button>
								<!-- Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
                                <button onclick="createBackup()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                                </button>
                                <button onclick="showRestoreBackupModal()" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    ğŸ“¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                                </button>
                                <button onclick="showBackupManager()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold transition-all shadow-sm">   
                                    ğŸ—‚ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø®
                                </button>
                            </div>
                            <p class="text-xs text-yellow-700 mt-2">
							    Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙˆØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ø­Ø³Ø§Ø¨ chartgain2019@gmail.com
							</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">ğŸ”’ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h4>
                        <form onsubmit="return changePassword(event)">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
                                <input type="password" id="currentPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                                <input type="password" id="newPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                                <input type="password" id="confirmNewPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-all">
                                ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ========== -->

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
<div id="testModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center sticky top-0 z-10">
            <h2 class="text-2xl font-bold" id="testModalTitle">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</h2>
        </div>
        
        <div class="p-8">
            <form id="testModalForm" onsubmit="return handleTestFormSubmit(event)">
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
                        <input type="text" id="modalTestName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                        <input type="text" id="modalTestSubject" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§ØªØŒ Ø§Ù„Ø¹Ù„ÙˆÙ…ØŒ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©..." required>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ğŸ’ Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                        <select id="modalTestGrade" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</option>
                            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø© -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">â±ï¸ ÙˆÙ‚Øª ÙƒÙ„ Ø³Ø¤Ø§Ù„ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ)</label>
                        <input type="number" id="modalTestTimer" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="30" min="10" max="300" value="30" required>
                        <p class="text-xs text-gray-500 mt-1">Ù…Ù† 10 Ø¥Ù„Ù‰ 300 Ø«Ø§Ù†ÙŠØ©</p>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ğŸ“Š Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</label>
                        <select id="modalTestDifficulty" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none">
                            <option value="Ø³Ù‡Ù„">Ø³Ù‡Ù„</option>
                            <option value="Ù…ØªÙˆØ³Ø·" selected>Ù…ØªÙˆØ³Ø·</option>
                            <option value="ØµØ¹Ø¨">ØµØ¹Ø¨</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">ÙˆØµÙ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
                    <textarea id="modalTestDescription" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" rows="3" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±..."></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </button>
                    <button type="button" onclick="closeTestModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </form>
            
            <div id="testModalError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„ -->
<div id="questionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 text-center sticky top-0 z-10">
            <h2 class="text-2xl font-bold" id="questionModalTitle">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h2>
        </div>
        
        <div class="p-8">
            <form id="questionModalForm" onsubmit="return handleQuestionFormSubmit(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                    <textarea id="modalQuestionText" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..." required></textarea>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„</label>
                        <input type="text" id="modalOption1" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
                        <input type="text" id="modalOption2" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«</label>
                        <input type="text" id="modalOption3" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹</label>
                        <input type="text" id="modalOption4" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
                    <select id="modalCorrectAnswer" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</option>
                        <option value="0">Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„</option>
                        <option value="1">Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                        <option value="2">Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«</option>
                        <option value="3">Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
                    </select>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„
                    </button>
                    <button type="button" onclick="closeQuestionModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </form>
            
            <div id="questionModalError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<script>
// ========== Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± ÙˆØ§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ø­Ø³Ù†Ø© ==========

// Ù†Ø¸Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ
const ErrorHandler = {
    logError: function(error, context = '') {
        console.error(`[SYSTEM_ERROR] ÙÙŠ ${context}:`, error);
        this.showUserError(error, context);
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„ØªØ­Ù„ÙŠÙ„
        this.logToStorage(error, context);
    },
    
    showUserError: function(error, context = '') {
        try {
            const errorMessage = this.getUserFriendlyMessage(error);
            this.displayErrorModal(errorMessage, context);
        } catch (modalError) {
            console.error('Failed to show error modal:', modalError);
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø³ÙŠØ·Ø©
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
        }
    },
    
    getUserFriendlyMessage: function(error) {
        if (error.name === 'QuotaExceededError') {
            return 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø³Ø¹Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†. ÙŠØ±Ø¬Ù‰ Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.';
        } else if (error.name === 'SyntaxError') {
            return 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.';
        } else if (error.message && error.message.includes('network')) {
            return 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
        } else {
            return 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        }
    },
    
    displayErrorModal: function(message, context = '') {
        const modalId = 'errorModal-' + Date.now();
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-3xl max-w-md w-full overflow-hidden">
                    <div class="bg-red-500 text-white p-6 text-center">
                        <div class="text-4xl mb-2">âš ï¸</div>
                        <h2 class="text-xl font-bold">${context ? `Ø®Ø·Ø£ ÙÙŠ ${context}` : 'Ø­Ø¯Ø« Ø®Ø·Ø£'}</h2>
                    </div>
                    <div class="p-6 text-center">
                        <p class="text-gray-700 mb-6">${message}</p>
                        <div class="flex gap-4">
                            <button onclick="document.getElementById('${modalId}').remove()" 
                                    class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold transition-all">
                                Ù…ÙˆØ§ÙÙ‚
                            </button>
                            <button onclick="location.reload()" 
                                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition-all">
                                ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    },
    
    logToStorage: function(error, context) {
        try {
            const errorLog = {
                timestamp: new Date().toISOString(),
                context: context,
                error: {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                },
                userAgent: navigator.userAgent
            };
            
            const existingLogs = StorageManager.getItem('errorLogs') || [];
            existingLogs.push(errorLog);
            
            // Ø­ÙØ¸ Ø¢Ø®Ø± 50 Ø®Ø·Ø£ ÙÙ‚Ø·
            if (existingLogs.length > 50) {
                existingLogs.splice(0, existingLogs.length - 50);
            }
            
            StorageManager.setItem('errorLogs', existingLogs);
        } catch (logError) {
            console.error('Failed to log error:', logError);
        }
    }
};

// Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
const ResourceManager = {
    timers: new Set(),
    eventListeners: new Map(),
    activeSessions: new Set(),
    
    addTimer: function(timer) {
        this.timers.add(timer);
        return timer;
    },
    
    clearAllTimers: function() {
        this.timers.forEach(timer => {
            try {
                clearInterval(timer);
                clearTimeout(timer);
            } catch (error) {
                console.warn('Error clearing timer:', error);
            }
        });
        this.timers.clear();
    },
    
    addEventListener: function(element, event, handler) {
        if (!element || !element.addEventListener) {
            console.warn('Invalid element for event listener');
            return;
        }
        
        try {
            element.addEventListener(event, handler);
            const key = `${element.id || 'unknown'}-${event}`;
            if (!this.eventListeners.has(key)) {
                this.eventListeners.set(key, []);
            }
            this.eventListeners.get(key).push({element, event, handler});
        } catch (error) {
            ErrorHandler.logError(error, 'addEventListener');
        }
    },
    
    clearAllEventListeners: function() {
        this.eventListeners.forEach((listeners, key) => {
            listeners.forEach(({element, event, handler}) => {
                try {
                    if (element && element.removeEventListener) {
                        element.removeEventListener(event, handler);
                    }
                } catch (error) {
                    console.warn('Error removing event listener:', error);
                }
            });
        });
        this.eventListeners.clear();
    },
    
    registerSession: function(sessionId) {
        this.activeSessions.add(sessionId);
    },
    
    cleanupSession: function(sessionId) {
        this.activeSessions.delete(sessionId);
    },
    
    cleanup: function() {
        this.clearAllTimers();
        this.clearAllEventListeners();
        this.activeSessions.clear();
    }
};


// ========== Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø´Ø§Ø´Ø§Øª ==========
function showStudentAccess() {
    try {
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('studentAccessScreen').classList.remove('hidden');
    } catch (error) {
        console.error('Error in showStudentAccess:', error);
    }
}

function showTeacherLogin() {
    try {
        document.getElementById('teacherLoginScreen').classList.remove('hidden');
    } catch (error) {
        console.error('Error in showTeacherLogin:', error);
    }
}

function closeTeacherLogin() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        const loginError = document.getElementById('loginError');
        if (loginError) loginError.classList.add('hidden');
    } catch (error) {
        console.error('Error in closeTeacherLogin:', error);
    }
}

function showTeacherSignup() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        document.getElementById('teacherSignupScreen').classList.remove('hidden');
    } catch (error) {
        console.error('Error in showTeacherSignup:', error);
    }
}

function closeTeacherSignup() {
    try {
        document.getElementById('teacherSignupScreen').classList.add('hidden');
        const signupError = document.getElementById('signupError');
        const signupSuccess = document.getElementById('signupSuccess');
        const signupForm = document.getElementById('teacherSignupForm');
        
        if (signupError) signupError.classList.add('hidden');
        if (signupSuccess) signupSuccess.classList.add('hidden');
        if (signupForm) signupForm.reset();
    } catch (error) {
        console.error('Error in closeTeacherSignup:', error);
    }
}

function goBackToWelcome() {
    try {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø£ÙˆÙ„Ø§Ù‹
        if (typeof ResourceManager !== 'undefined') {
            ResourceManager.cleanup();
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª
        const screens = [
            'studentAccessScreen',
            'teacherDashboard', 
            'testScreen',
            'resultsScreen'
        ];
        
        screens.forEach(screen => {
            const element = document.getElementById(screen);
            if (element) element.classList.add('hidden');
        });
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø«
        const schoolSearch = document.getElementById('schoolSearch');
        const searchResults = document.getElementById('schoolSearchResults');
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        
        if (schoolSearch) schoolSearch.value = '';
        if (searchResults) searchResults.classList.add('hidden');
        if (selectedSchoolInfo) selectedSchoolInfo.classList.add('hidden');
        
    } catch (error) {
        console.error('Error in goBackToWelcome:', error);
    }
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…Ø¹ ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡
function closeModal(modalId) {
    try {
        const modal = document.getElementById(modalId);
        if (modal) {
            // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± fadeOut Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (!modal.style.animation) {
                modal.style.animation = 'fadeOut 0.3s ease-out';
            }
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ø«ÙŠØ±
            setTimeout(() => {
                if (modal && modal.parentNode) {
                    modal.remove();
                }
            }, 300);
        }
    } catch (error) {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… ErrorHandler Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… console.error
        if (typeof ErrorHandler !== 'undefined' && ErrorHandler.logError) {
            ErrorHandler.logError(error, 'closeModal');
        } else {
            console.error('Error closing modal:', error);
        }
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨ ==========
function updateResultsTable(filteredResults) {
    try {
        const tableBody = document.getElementById('resultsTableBody');
        if (!tableBody) return;

        if (!filteredResults || filteredResults.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                        <div class="text-4xl mb-2">ğŸ“­</div>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«</p>
                    </td>
                </tr>
            `;
            return;
        }

        let tableHTML = '';
        filteredResults.forEach(result => {
            const percentage = result.percentage || Math.round((result.score / result.total) * 100);
            const grade = result.gradeLevel || calculateGrade(percentage);
            
            tableHTML += `
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-all">
                    <td class="px-6 py-4 text-right">
                        <div class="font-semibold text-gray-800">${result.name}</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-sm">
                            ${result.grade} - ${result.class}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="font-semibold">${result.test}</div>
                        <div class="text-sm text-gray-600">${result.subject}</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-bold text-blue-600">${result.score}/${result.total}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-bold ${percentage >= 60 ? 'text-green-600' : 'text-red-600'}">
                            ${percentage}%
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="px-2 py-1 rounded-full text-sm font-semibold ${getGradeColor(grade)}">
                            ${grade}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right text-sm text-gray-600">
                        ${result.date || new Date(result.timestamp).toLocaleDateString('ar-SA')}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex gap-2 justify-end">
                            <button onclick="showResultDetails(${result.id})" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-semibold transition-all">
                                ØªÙØ§ØµÙŠÙ„
                            </button>
                            <button onclick="deleteResult(${result.id})" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-semibold transition-all">
                                Ø­Ø°Ù
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        tableBody.innerHTML = tableHTML;
    } catch (error) {
        console.error('Error updating results table:', error);
        ErrorHandler.logError(error, 'updateResultsTable');
    }
}

function getGradeColor(grade) {
    const colors = {
        'Ù…Ù…ØªØ§Ø²': 'bg-green-100 text-green-600',
        'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹': 'bg-blue-100 text-blue-600',
        'Ø¬ÙŠØ¯': 'bg-yellow-100 text-yellow-600',
        'Ù…Ù‚Ø¨ÙˆÙ„': 'bg-orange-100 text-orange-600',
        'Ø¶Ø¹ÙŠÙ': 'bg-red-100 text-red-600'
    };
    return colors[grade] || 'bg-gray-100 text-gray-600';
}

function calculateGrade(percentage) {
    if (percentage >= 90) return 'Ù…Ù…ØªØ§Ø²';
    else if (percentage >= 80) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
    else if (percentage >= 70) return 'Ø¬ÙŠØ¯';
    else if (percentage >= 60) return 'Ù…Ù‚Ø¨ÙˆÙ„';
    else return 'Ø¶Ø¹ÙŠÙ';
}

function showResultDetails(resultId) {
    try {
        const results = getResultsSync();
        const result = results.find(r => r.id === resultId);
        
        if (!result) {
            alert('Ø§Ù„Ù†ØªÙŠØ¬Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        const modalId = 'resultDetailsModal_' + Date.now();
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center">
                        <h2 class="text-2xl font-bold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©</h2>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-xl">
                                    <div class="text-gray-600">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div>
                                    <div class="font-bold">${result.name}</div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-xl">
                                    <div class="text-gray-600">Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„</div>
                                    <div class="font-bold">${result.grade} - ${result.class}</div>
                                </div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-xl">
                                <div class="text-blue-600">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
                                <div class="font-bold">${result.test} - ${result.subject}</div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-green-50 p-4 rounded-xl text-center">
                                    <div class="text-green-600">Ø§Ù„Ø¯Ø±Ø¬Ø©</div>
                                    <div class="font-bold text-2xl">${result.score}/${result.total}</div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-xl text-center">
                                    <div class="text-purple-600">Ø§Ù„Ù†Ø³Ø¨Ø©</div>
                                    <div class="font-bold text-2xl">${result.percentage}%</div>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-xl text-center">
                                    <div class="text-orange-600">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</div>
                                    <div class="font-bold text-xl">${result.gradeLevel}</div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <button onclick="closeModal('${modalId}')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                                Ø¥ØºÙ„Ø§Ù‚
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    } catch (error) {
        console.error('Error showing result details:', error);
        ErrorHandler.logError(error, 'showResultDetails');
    }
}

function deleteResult(resultId) {
    try {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŸ')) {
            return;
        }
        
        const results = getResultsSync();
        const updatedResults = results.filter(r => r.id !== resultId);
        
        const success = StorageManager.setItem('testResults', updatedResults);
        if (success) {
            showSuccessMessage('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ù†Ø¬Ø§Ø­');
            filterResults(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        } else {
            showErrorMessage('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©');
        }
    } catch (error) {
        console.error('Error deleting result:', error);
        ErrorHandler.logError(error, 'deleteResult');
    }
}

// ========== Ù†Ø¸Ø§Ù… API Ù„Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ ==========
// ========== Ù†Ø¸Ø§Ù… API Ù„Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø³Ù† ==========
// ========== Ù†Ø¸Ø§Ù… API Ù„Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø³Ù† ==========
// ========== Ù†Ø¸Ø§Ù… API Ù„Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¯Ø« ==========
// ========== Ù†Ø¸Ø§Ù… API Ù„Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¯Ø« ==========
const RemoteAPI = {
    baseURL: 'https://quiz-system-api.onrender.com',
    isAvailable: false,
    endpointsChecked: false,
    
    async request(endpoint, options = {}) {
        const apiEndpoint = endpoint.startsWith('/api') ? endpoint : `/api${endpoint}`;
        const url = `${this.baseURL}${apiEndpoint}`;
        
        try {
            const response = await fetch(url, {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers,
                },
                ...options,
            });

            if (!response.ok) {
                if (response.status === 404) {
                    console.log(`â„¹ï¸ Endpoint ${apiEndpoint} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
                    return null;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.warn(`ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ${apiEndpoint}:`, error.message);
            this.isAvailable = false;
            return null;
        }
    },

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø®Ø§Ø¯Ù…
    async checkEndpoints() {
        if (this.endpointsChecked) return this.isAvailable;
        
        try {
            console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø®Ø§Ø¯Ù…...');
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
            const testResponse = await fetch(`${this.baseURL}/api/health`, { 
                method: 'GET'
            }).catch(() => null);
            
            this.isAvailable = testResponse && testResponse.ok;
            this.endpointsChecked = true;
            
            console.log(`âœ… Ø§Ù„Ø®Ø§Ø¯Ù… ${this.isAvailable ? 'Ù…ØªÙˆÙØ±' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}`);
            return this.isAvailable;
            
        } catch (error) {
            console.log('âŒ Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±:', error.message);
            this.isAvailable = false;
            this.endpointsChecked = true;
            return false;
        }
    },

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø®Ø§Ø¯Ù…
    async getHealth() {
        try {
            const response = await fetch(`${this.baseURL}/api/health`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            return response.ok;
        } catch (error) {
            return false;
        }
    },

    // ========== Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ==========
    async getSchools() {
        if (!this.isAvailable) return {};
        const result = await this.request('/all-schools');
        return result || [];
    },

    async createSchool(schoolData) {
        if (!this.isAvailable) {
            console.log('ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±)');
            return null;
        }
        return this.request('/schools', {
            method: 'POST',
            body: JSON.stringify(schoolData),
        });
    },

    // ========== Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ==========
    async getTeachers() {
        if (!this.isAvailable) return {};
        const result = await this.request('/teachers');
        return result || {};
    },

    async createTeacher(teacherData) {
        if (!this.isAvailable) {
            console.log('ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„Ù… Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±)');
            return null;
        }
        return this.request('/register', {
            method: 'POST',
            body: JSON.stringify(teacherData),
        });
    },

    // ========== Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ==========
    async getResults() {
        if (!this.isAvailable) return [];
        const result = await this.request('/results');
        return result || [];
    },

    async createResult(resultData) {
        if (!this.isAvailable) {
            console.log('ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±)');
            return null;
        }
        return this.request('/results', {
            method: 'POST',
            body: JSON.stringify(resultData),
        });
    },

    // ========== Ø¯ÙˆØ§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ==========
    async login(loginData) {
        if (!this.isAvailable) {
            console.log('ğŸ” Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ');
            return null;
        }
        return this.request('/login', {
            method: 'POST',
            body: JSON.stringify(loginData),
        });
    },

    async changePassword(passwordData) {
        if (!this.isAvailable) {
            console.log('ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø­Ù„ÙŠØ§Ù‹');
            return null;
        }
        return this.request('/change-password', {
            method: 'POST',
            body: JSON.stringify(passwordData),
        });
    }
};

// ========== Ø¯ÙˆØ§Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø§ØªØµØ§Ù„ ==========

// Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§ØªØµØ§Ù„ Ø§Ù„Ø®Ø§Ø¯Ù…
function showServerStatus() {
    const status = RemoteAPI.isAvailable ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„';
    console.log(`Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯: ${status}`);
    
    // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ù…Ø±Ø¦ÙŠ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    if (!RemoteAPI.isAvailable) {
        console.log('ğŸ’¡ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ');
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ù…Ø±Ø¦ÙŠ ÙÙŠ Ø§Ù„ØµÙØ­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        const statusIndicator = document.createElement('div');
        statusIndicator.id = 'serverStatusIndicator';
        statusIndicator.className = 'fixed bottom-4 left-4 bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg z-40 flex items-center gap-2';
        statusIndicator.innerHTML = `
            <span class="text-sm">ğŸ”´ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„</span>
            <span class="text-xs">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹</span>
        `;
        document.body.appendChild(statusIndicator);
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
            if (document.body.contains(statusIndicator)) {
                statusIndicator.remove();
            }
        }, 5000);
    } else {
        console.log('âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ù†Ø´Ø·');
        
        // Ù…Ø¤Ø´Ø± Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        const statusIndicator = document.createElement('div');
        statusIndicator.id = 'serverStatusIndicator';
        statusIndicator.className = 'fixed bottom-4 left-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-40 flex items-center gap-2';
        statusIndicator.innerHTML = `
            <span class="text-sm">ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</span>
            <span class="text-xs">Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù†Ø´Ø·Ø©</span>
        `;
        document.body.appendChild(statusIndicator);
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
            if (document.body.contains(statusIndicator)) {
                statusIndicator.remove();
            }
        }, 3000);
    }
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø³Ù†
// Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© initializeSystem Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ
async function initializeSystem() {
    try {
        showLoadingMessage('Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...');
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙØ©
        cleanupCorruptedData();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (Ù„Ù„Ø³Ø±Ø¹Ø©)
        const storedTeachers = StorageManager.getItem('teacherAccounts');
        const storedSchools = StorageManager.getItem('demoSchoolsData');
        const storedResults = StorageManager.getItem('testResults');
        
        if (storedTeachers) Object.assign(demoData.users, storedTeachers);
        if (storedSchools) Object.assign(demoData.schools, storedSchools);
        
        console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ');
        
        // Ø«Ù… Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ (ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)
        setTimeout(async () => {
            try {
                console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯...');
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø®Ø§Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹
                const isServerAvailable = await RemoteAPI.checkEndpoints();
                
                if (isServerAvailable) {
                    await Promise.all([
                        loadTeacherAccounts(),
                        loadSchools(),
                        loadResults()
                    ]);
                    
                    // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…
                    await RemoteAPI.syncLocalDataToRemote();
                    
                    console.log('âœ… Ø§ÙƒØªÙ…Ù„Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯');
                } else {
                    console.log('â„¹ï¸ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
                }
                
            } catch (syncError) {
                console.log('â„¹ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ ØºÙŠØ± Ù…ØªØ§Ø­Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
            }
            
            // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            showServerStatus();
        }, 1000);
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†
        loadSchoolsForExistingTeachers();
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹
        SystemRecovery.initialize();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateWelcomeStatistics();
        
        hideLoadingMessage();
        
        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ø®Ø§Ø¯Ù…
        showServerStatus();
        
        console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
        
    } catch (error) {
        hideLoadingMessage();
        ErrorHandler.logError(error, 'initializeSystem');
        showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©', 'ØªØ¹Ø°Ø± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„');
        
        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù… Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        showServerStatus();
    }
}

// Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
function loadSchoolsForExistingTeachers() {
    try {
        console.log('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†...');
        
        // Ù„ÙƒÙ„ Ù…Ø¹Ù„Ù…ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¯Ø±Ø³ØªÙ‡
        Object.values(demoData.users).forEach(teacher => {
            if (teacher.school && teacher.name) {
                let schoolExists = false;
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø¹Ù„Ù…
                for (const schoolId in demoData.schools) {
                    if (demoData.schools[schoolId].teacher === teacher.name) {
                        schoolExists = true;
                        break;
                    }
                }
                
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ø¯Ø±Ø³Ø©ØŒ Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§
                if (!schoolExists) {
                    const newSchoolId = 'school_' + Date.now();
                    demoData.schools[newSchoolId] = {
                        id: newSchoolId,
                        name: teacher.school,
                        teacher: teacher.name,
                        tests: []
                    };
                    console.log(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø¹Ù„Ù…: ${teacher.name}`);
                }
            }
        });
        
        // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        StorageManager.setItem('demoSchoolsData', demoData.schools);
        console.log('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:', Object.keys(demoData.schools).length, 'Ù…Ø¯Ø±Ø³Ø©');
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†:', error);
        ErrorHandler.logError(error, 'loadSchoolsForExistingTeachers');
    }
}

// Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ø³Ù‘Ù†
const StorageManager = {
    setItem: function(key, value) {
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¹Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­Ø©
            if (!this.isStorageAvailable()) {
                throw new Error('LocalStorage not available');
            }
            
            const data = JSON.stringify({
                value: value,
                timestamp: Date.now(),
                version: '1.0'
            });
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (data.length > 5000000) { // 5MB
                console.warn(`Large data detected for ${key}: ${data.length} bytes`);
                this.handleLargeData(key, value);
                return false;
            }
            
            localStorage.setItem(key, data);
            return true;
        } catch (error) {
            if (error.name === 'QuotaExceededError') {
                this.handleQuotaExceeded();
            }
            ErrorHandler.logError(error, `StorageManager.setItem(${key})`);
            return false;
        }
    },
	getItem: function(key) {
       try {
          if (!this.isStorageAvailable()) return null;
        
          const item = localStorage.getItem(key);
          if (!item) return null;
        
          // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
           if (key === 'authToken' && item.startsWith('eyJ')) {
               return item;
            }
        
           try {
              return JSON.parse(item).value;
            } catch {
                return item; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„
            }
        } catch (error) {
            ErrorHandler.logError(error, `StorageManager.getItem(${key})`);
            return null;
        }
    },
    
    tryRecoverData: function(key) {
        try {
            const item = localStorage.getItem(key);
            if (!item) return null;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­ JSON ØªØ§Ù„Ù
            const fixedJson = item
                .replace(/[\u0000-\u0019]+/g, "")
                .replace(/([{,]\s*)([a-zA-Z0-9_]+)(\s*:)/g, '$1"$2"$3');
                
            const parsed = JSON.parse(fixedJson);
            return parsed.value || parsed;
        } catch (recoveryError) {
            console.error(`Failed to recover data for ${key}:`, recoveryError);
            // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙØ©
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.error('Failed to remove corrupted data:', e);
            }
            return null;
        }
    },
    
    isStorageAvailable: function() {
        try {
            const test = 'storage_test';
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
            return true;
        } catch (error) {
            return false;
        }
    },
    
    handleQuotaExceeded: function() {
        // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        const cleared = this.clearOldData();
        if (cleared) {
            ErrorHandler.showUserError(new Error('ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ®Ø²ÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'));
        } else {
            ErrorHandler.showUserError(new Error('Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦. ÙŠØ±Ø¬Ù‰ Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹.'));
        }
    },
    
    handleLargeData: function(key, value) {
        // Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ¨ÙŠØ±Ø©ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¶ØºØ·Ù‡Ø§ Ø£Ùˆ ØªÙ‚Ø³ÙŠÙ…Ù‡Ø§
        if (Array.isArray(value) && value.length > 1000) {
            // Ø­ÙØ¸ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£Ø®ÙŠØ± ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
            const trimmedValue = value.slice(-1000);
            return this.setItem(key, trimmedValue);
        }
        return false;
    },
    
    clearOldData: function() {
        try {
            const oneWeekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            let cleared = false;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('testResult_')) {
                    try {
                        const item = localStorage.getItem(key);
                        if (item) {
                            const parsed = JSON.parse(item);
                            if (parsed.timestamp && parsed.timestamp < oneWeekAgo) {
                                localStorage.removeItem(key);
                                cleared = true;
                            }
                        }
                    } catch (e) {
                        // ØªØ®Ø·ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙØ©
                        continue;
                    }
                }
            }
            
            return cleared;
        } catch (error) {
            ErrorHandler.logError(error, 'clearOldData');
            return false;
        }
    },
    
    getStorageInfo: function() {
        let totalSize = 0;
        const items = [];
        
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            const value = localStorage.getItem(key);
            totalSize += key.length + (value ? value.length : 0);
            items.push({
                key: key,
                size: (key.length + (value ? value.length : 0)) / 1024, // KB
                timestamp: this.getItem(key)?.timestamp || 'unknown'
            });
        }
        
        return {
            totalSize: totalSize / 1024 / 1024, // MB
            itemCount: localStorage.length,
            items: items.sort((a, b) => b.size - a.size)
        };
    }
};

function cleanupCorruptedData() {
    try {
        const keysToCheck = ['authToken', 'sessionData', 'userData'];
        
        keysToCheck.forEach(key => {
            try {
                const item = localStorage.getItem(key);
                if (item) {
                    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù„ÙŠÙ„ JSON Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡
                    JSON.parse(item);
                }
            } catch (error) {
                // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙØ©
                console.warn(`Removing corrupted data for key: ${key}`);
                localStorage.removeItem(key);
            }
        });
    } catch (error) {
        console.error('Error in cleanupCorruptedData:', error);
    }
}

// Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const DataValidator = {
    validateStudentData: function(data) {
        const errors = [];
        
        if (!data.name || data.name.trim().length < 2) {
            errors.push('Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø­Ø±ÙÙŠÙ†');
        }
        
        if (data.name && data.name.trim().length > 100) {
            errors.push('Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 100 Ø­Ø±Ù)');
        }
        
        if (!data.grade) {
            errors.push('Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù…Ø·Ù„ÙˆØ¨');
        }
        
        if (!data.class || data.class.trim().length === 0) {
            errors.push('Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù…Ø·Ù„ÙˆØ¨');
        }
        
        if (data.class && data.class.trim().length > 50) {
            errors.push('Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 50 Ø­Ø±Ù)');
        }
        
        return {
            isValid: errors.length === 0,
            errors: errors
        };
    },
    
    validateTestData: function(test) {
        const errors = [];
        
        if (!test.questions || test.questions.length === 0) {
            errors.push('Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø©');
        }
        
        if (test.questions && test.questions.length > 100) {
            errors.push('Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 100 Ø³Ø¤Ø§Ù„)');
        }
        
        if (!test.timerPerQuestion || test.timerPerQuestion < 10) {
            errors.push('ÙˆÙ‚Øª Ø§Ù„Ø³Ø¤Ø§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 10 Ø«ÙˆØ§Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        }
        
        if (test.timerPerQuestion > 300) {
            errors.push('ÙˆÙ‚Øª Ø§Ù„Ø³Ø¤Ø§Ù„ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 300 Ø«Ø§Ù†ÙŠØ©)');
        }
        
        if (!test.name || test.name.trim().length < 2) {
            errors.push('Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø­Ø±ÙÙŠÙ†');
        }
        
        return {
            isValid: errors.length === 0,
            errors: errors
        };
    },
    
    validateEmail: function(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    },
    
    validatePassword: function(password) {
        if (password.length < 6) {
            return 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
        }
        if (password.length > 50) {
            return 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹';
        }
        return null;
    },
    
    sanitizeInput: function(input) {
        if (typeof input !== 'string') return input;
        
        return input
            .trim()
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/'/g, '&#39;')
            .replace(/"/g, '&#34;')
            .substring(0, 1000); // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø£Ø·ÙˆØ§Ù„
    }
};

// Ù†Ø¸Ø§Ù… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù…
const SystemRecovery = {
    initialize: function() {
        this.setupErrorHandling();
        this.setupPerformanceMonitoring();
        
        if (!this.checkSystemHealth()) {
            this.showSystemWarning();
        }
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        this.recoverPreviousSession();
    },
    
    setupErrorHandling: function() {
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ JavaScript Ø§Ù„ØºÙŠØ± Ù…Ø¹Ø§Ù„Ø¬Ø©
        window.addEventListener('error', (event) => {
            ErrorHandler.logError(event.error, 'Unhandled Global Error');
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¹ÙˆØ¯ Ù…Ø±ÙÙˆØ¶Ø© ØºÙŠØ± Ù…Ø¹Ø§Ù„Ø¬Ø©
        window.addEventListener('unhandledrejection', (event) => {
            ErrorHandler.logError(event.reason, 'Unhandled Promise Rejection');
        });
        
        // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙØ´Ù„ ÙÙŠÙ‡Ø§
        window.addEventListener('error', (event) => {
            if (event.target && (event.target.tagName === 'IMG' || event.target.tagName === 'SCRIPT' || event.target.tagName === 'LINK')) {
                console.warn('Failed to load resource:', event.target.src || event.target.href);
            }
        }, true);
    },
    
    setupPerformanceMonitoring: function() {
        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…
        if ('performance' in window) {
            const navTiming = performance.getEntriesByType('navigation')[0];
            if (navTiming) {
                console.log(`Page loaded in ${navTiming.loadEventEnd - navTiming.navigationStart}ms`);
            }
        }
        
        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        if ('memory' in performance) {
            setInterval(() => {
                const memory = performance.memory;
                if (memory.usedJSHeapSize > memory.jsHeapSizeLimit * 0.8) {
                    console.warn('High memory usage detected:', memory);
                }
            }, 30000);
        }
    },
    
    checkSystemHealth: function() {
        const checks = {
            localStorage: this.checkLocalStorage(),
            json: this.checkJSON(),
            timers: this.checkTimers(),
            dom: this.checkDOM()
        };
        
        const failedChecks = Object.entries(checks).filter(([_, passed]) => !passed).map(([check]) => check);
        
        if (failedChecks.length > 0) {
            console.warn('System health check failed for:', failedChecks);
            return false;
        }
        
        return true;
    },
    
    checkLocalStorage: function() {
        return StorageManager.isStorageAvailable();
    },
    
    checkJSON: function() {
        try {
            JSON.parse('{"test": true}');
            JSON.stringify({test: true});
            return true;
        } catch {
            return false;
        }
    },
    
    checkTimers: function() {
        try {
            const testTimer = setTimeout(() => {}, 100);
            clearTimeout(testTimer);
            return true;
        } catch {
            return false;
        }
    },
    
    checkDOM: function() {
        try {
            document.createElement('div');
            return true;
        } catch {
            return false;
        }
    },
    
    showSystemWarning: function() {
        const warning = document.createElement('div');
        warning.className = 'fixed top-4 left-4 right-4 bg-yellow-500 text-white p-4 rounded-xl shadow-lg z-40';
        warning.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">âš ï¸</span>
                    <div>
                        <div class="font-bold">ØªØ­Ø°ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                        <div class="text-sm">Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ ÙÙŠ Ø¨ÙŠØ¦ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                    âœ•
                </button>
            </div>
        `;
        document.body.appendChild(warning);
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†
        setTimeout(() => {
            if (document.body.contains(warning)) {
                warning.remove();
            }
        }, 10000);
    },
    
    recoverPreviousSession: function() {
        try {
            const session = StorageManager.getItem('currentSession');
            if (session && this.isValidSession(session)) {
                console.log('Recovered previous session:', session);
                return session;
            }
        } catch (error) {
            console.warn('Session recovery failed:', error);
        }
        return null;
    },
    
    isValidSession: function(session) {
        return session && 
               session.timestamp && 
               Date.now() - session.timestamp < 30 * 60 * 1000; // 30 Ø¯Ù‚ÙŠÙ‚Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
    },
    
    saveSession: function(sessionData) {
        try {
            const session = {
                ...sessionData,
                timestamp: Date.now(),
                url: window.location.href
            };
            StorageManager.setItem('currentSession', session);
        } catch (error) {
            console.warn('Failed to save session:', error);
        }
    },
    
    clearSession: function() {
        try {
            localStorage.removeItem('currentSession');
        } catch (error) {
            console.warn('Failed to clear session:', error);
        }
    }
};

// ========== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù… ==========
// ========== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù… ==========
// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
let currentUser = null;
let currentTest = null;
let currentQuestionIndex = 0;
let timer = null;
let timeLeft = 30;
let studentData = {
    name: '',
    grade: '',
    class: '',
    score: 0,
    answers: []
};

// Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
let currentManagingTest = null;
let currentManagingTestSchoolId = null;

// Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
const demoData = {
    schools: {},
    users: {
        'chartgain2019@gmail.com': {
            email: 'chartgain2019@gmail.com',
            password: '123456',
            name: 'Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
            school: 'Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙˆÙ„ÙŠØ¯ Ø¨Ù† Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©',
            stage: 'Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©'
        }
    }
};

function updateGradeOptions(stage, targetElementId) {
    try {
        const gradeSelect = document.getElementById(targetElementId);
        if (!gradeSelect) {
            console.warn(`Element not found: ${targetElementId}`);
            return;
        }
        
        gradeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</option>';
        
        if (stage) {
            const grades = getGradeOptions(stage);
            grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeSelect.appendChild(option);
            });
        }
    } catch (error) {
        ErrorHandler.logError(error, 'updateGradeOptions');
    }
}


// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ==========
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø³Ù†
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ¶Ù…Ø§Ù† Ø¥Ø±Ø¬Ø§Ø¹ Ù…ØµÙÙˆÙØ©
async function loadResults() {
    try {
        console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬...');
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©
        if (!RemoteAPI.isAvailable) {
            const localResults = StorageManager.getItem('testResults');
            console.log('ğŸ’¾ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', Array.isArray(localResults) ? localResults.length : 0, 'Ù†ØªÙŠØ¬Ø©');
            return Array.isArray(localResults) ? localResults : [];
        }

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
        console.log('ğŸŒ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…...');
        const remoteResults = await RemoteAPI.getResults();
        
        if (remoteResults && Array.isArray(remoteResults) && remoteResults.length > 0) {
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…:', remoteResults.length, 'Ù†ØªÙŠØ¬Ø©');
            
            // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
            StorageManager.setItem('testResults', remoteResults);
            return remoteResults;
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù†ØªØ§Ø¦Ø¬ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            console.log('ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
            const localResults = StorageManager.getItem('testResults');
            return Array.isArray(localResults) ? localResults : [];
        }
        
    } catch (error) {
        console.warn('âŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ù†ØªØ§Ø¦Ø¬:', error.message);
        const localResults = StorageManager.getItem('testResults');
        return Array.isArray(localResults) ? localResults : [];
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø´ÙƒÙ„ Ù…ØªØ²Ø§Ù…Ù† (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ØºÙŠØ± Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©)
// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø´ÙƒÙ„ Ù…ØªØ²Ø§Ù…Ù† - Ù…Ø­Ø¯Ø«Ø©
function getResultsSync() {
    try {
        const results = StorageManager.getItem('testResults');
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ù…ØµÙÙˆÙØ©
        if (Array.isArray(results)) {
            return results;
        } else if (results && typeof results === 'object') {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙƒØ§Ø¦Ù†ØŒ ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
            return Object.values(results);
        } else {
            return [];
        }
    } catch (error) {
        console.warn('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø´ÙƒÙ„ Ù…ØªØ²Ø§Ù…Ù†:', error);
        return [];
    }
}

// Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
// Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ¶Ù…Ø§Ù† Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
async function saveResult(result) {
    try {
        result.timestamp = Date.now();
        
        // Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
        const results = getResultsSync();
        results.push(result);
        const localSuccess = StorageManager.setItem('testResults', results);
        
        if (!localSuccess) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ');
        }
        
        console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­');
        
        // Ø«Ø§Ù†ÙŠØ§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹)
        if (RemoteAPI.isAvailable) {
            try {
                await RemoteAPI.createResult(result);
                console.log('ğŸŒ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯');
            } catch (apiError) {
                console.warn('âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯:', apiError.message);
                // Ù„Ø§ Ù†Ø±Ù…ÙŠ Ø®Ø·Ø£ Ù‡Ù†Ø§ Ù„Ø£Ù† Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù†Ø¬Ø­
            }
        } else {
            console.log('ğŸ’¡ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· (Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±)');
        }
        
        return true;
        
    } catch (error) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©:', error);
        ErrorHandler.logError(error, 'saveResult');
        return false;
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
// ØªØ­Ù…ÙŠÙ„ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø³Ù†
async function loadTeacherAccounts() {
    try {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©
        if (!RemoteAPI.isAvailable) {
            const localTeachers = StorageManager.getItem('teacherAccounts') || {};
            console.log('ğŸ’¾ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠÙŠÙ†:', Object.keys(localTeachers).length, 'Ù…Ø¹Ù„Ù…');
            Object.assign(demoData.users, localTeachers);
            return;
        }

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
        console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…...');
        const remoteTeachers = await RemoteAPI.getTeachers();
        
        if (remoteTeachers && Object.keys(remoteTeachers).length > 0) {
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…:', Object.keys(remoteTeachers).length, 'Ù…Ø¹Ù„Ù…');
            Object.assign(demoData.users, remoteTeachers);
            
            // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
            StorageManager.setItem('teacherAccounts', remoteTeachers);
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø¹Ù„Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠÙŠÙ†
            console.log('ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…');
            const localTeachers = StorageManager.getItem('teacherAccounts') || {};
            Object.assign(demoData.users, localTeachers);
        }
        
    } catch (error) {
        console.warn('âŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†:', error.message);
        const localTeachers = StorageManager.getItem('teacherAccounts') || {};
        Object.assign(demoData.users, localTeachers);
    }
}


function checkAdminPermissions() {
    try {
        const debugToolsSection = document.getElementById('debugToolsSection');
        
        if (!debugToolsSection) {
            console.warn('Ø¹Ù†ØµØ± Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØµØ­ÙŠØ­ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        if (currentUser && currentUser.email === 'chartgain2019@gmail.com') {
            debugToolsSection.classList.remove('hidden');
            console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØµØ­ÙŠØ­ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„');
        } else {
            debugToolsSection.classList.add('hidden');
        }
    } catch (error) {
        ErrorHandler.logError(error, 'checkAdminPermissions');
    }
}

// ========== Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØµØ­ÙŠØ­ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ==========

function initializeDefaultData() {
    try {
        if (!confirm('âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ Ù‡Ø°Ø§ Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
            return;
        }
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const defaultUsers = {
            'chartgain2019@gmail.com': {
                email: 'chartgain2019@gmail.com',
                password: '123456',
                name: 'Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
                school: 'Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙˆÙ„ÙŠØ¯ Ø¨Ù† Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©',
                stage: 'Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©'
            }
        };
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const defaultSchools = {
            'school_default_1': {
                id: 'school_default_1',
                name: 'Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙˆÙ„ÙŠØ¯ Ø¨Ù† Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©',
                teacher: 'Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
                tests: []
            }
        };
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        StorageManager.setItem('teacherAccounts', defaultUsers);
        StorageManager.setItem('demoSchoolsData', defaultSchools);
        StorageManager.setItem('testResults', []);
        
        showSuccessMessage('ØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø©', 'ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        setTimeout(() => {
            location.reload();
        }, 2000);
        
    } catch (error) {
        ErrorHandler.logError(error, 'initializeDefaultData');
    }
}

function debugData() {
    try {
        const storageInfo = StorageManager.getStorageInfo();
        const results = loadResults();
        const errorLogs = StorageManager.getItem('errorLogs') || [];

        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…ØµØºØ±Ø©
        const modalId = 'debugDataModal_' + Date.now();
        
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[85vh] overflow-y-auto"> <!-- ØªÙ… ØªØµØºÙŠØ± max-w Ù…Ù† 6xl Ø¥Ù„Ù‰ 2xl -->
                    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 text-center sticky top-0 z-10"> <!-- ØªÙ… ØªØµØºÙŠØ± padding -->
                        <h2 class="text-xl font-bold">ğŸ” ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2> <!-- ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· -->
                        <p class="text-purple-100 text-sm">Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</p> <!-- ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· -->
                    </div>
                    
                    <div class="p-4"> <!-- ØªÙ… ØªØµØºÙŠØ± padding -->
                        <!-- Ù‚Ø³Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† - Ù…ØµØºØ± -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ’¾ Ø§Ù„ØªØ®Ø²ÙŠÙ†</h3> <!-- ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· -->
                            <div class="grid grid-cols-3 gap-3"> <!-- ØªÙ… ØªØµØºÙŠØ± gap -->
                                <div class="bg-blue-50 p-3 rounded-xl border border-blue-200 text-center"> <!-- ØªÙ… ØªØµØºÙŠØ± padding -->
                                    <div class="text-blue-600 font-semibold text-sm">Ø§Ù„Ø­Ø¬Ù…</div> <!-- ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· -->
                                    <div class="text-lg font-bold text-blue-600">${storageInfo.totalSize.toFixed(2)} MB</div> <!-- ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· -->
                                </div>
                                <div class="bg-green-50 p-3 rounded-xl border border-green-200 text-center">
                                    <div class="text-green-600 font-semibold text-sm">Ø§Ù„Ø¹Ù†Ø§ØµØ±</div>
                                    <div class="text-lg font-bold text-green-600">${storageInfo.itemCount}</div>
                                </div>
                                <div class="bg-purple-50 p-3 rounded-xl border border-purple-200 text-center">
                                    <div class="text-purple-600 font-semibold text-sm">Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div>
                                    <div class="text-lg font-bold text-purple-600">${errorLogs.length}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Ù‚Ø³Ù… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ù…ØµØºØ± -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-orange-50 p-3 rounded-xl border border-orange-200 text-center">
                                    <div class="text-orange-600 font-semibold text-sm">Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</div>
                                    <div class="text-lg font-bold text-orange-600">${Object.keys(demoData.schools).length}</div>
                                </div>
                                <div class="bg-red-50 p-3 rounded-xl border border-red-200 text-center">
                                    <div class="text-red-600 font-semibold text-sm">Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</div>
                                    <div class="text-lg font-bold text-red-600">${Object.keys(demoData.users).length}</div>
                                </div>
                                <div class="bg-green-50 p-3 rounded-xl border border-green-200 text-center">
                                    <div class="text-green-600 font-semibold text-sm">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
                                    <div class="text-lg font-bold text-green-600">${results.length}</div>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-xl border border-blue-200 text-center">
                                    <div class="text-blue-600 font-semibold text-sm">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
                                    <div class="text-xs font-bold text-blue-600 truncate" title="${currentUser?.name || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}">
                                        ${currentUser?.name ? currentUser.name.split(' ').slice(-1)[0] : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®Ø²Ù†Ø© - Ù…ØµØºØ± -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ—‚ï¸ Ø§Ù„Ø¹Ù†Ø§ØµØ±</h3>
                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 max-h-40 overflow-y-auto"> <!-- ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ -->
                                <div class="space-y-2">
                                    ${storageInfo.items.slice(0, 6).map(item => ` <!-- Ø¹Ø±Ø¶ 6 Ø¹Ù†Ø§ØµØ± ÙÙ‚Ø· -->
                                        <div class="flex justify-between items-center bg-white p-2 rounded border text-xs"> <!-- ØªÙ… ØªØµØºÙŠØ± padding ÙˆØ§Ù„Ø®Ø· -->
                                            <span class="truncate flex-1 mr-2" title="${item.key}">${item.key}</span>
                                            <span class="text-blue-600 font-semibold whitespace-nowrap">${item.size.toFixed(1)} KB</span>
                                        </div>
                                    `).join('')}
                                    ${storageInfo.items.length > 6 ? 
                                        `<div class="text-center text-gray-500 text-xs mt-2">+ ${storageInfo.items.length - 6} Ø¹Ù†ØµØ± Ø¥Ø¶Ø§ÙÙŠ</div>` : 
                                        ''
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Ù‚Ø³Ù… Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ - Ù…ØµØºØ± -->
                        ${errorLogs.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">âš ï¸ Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h3>
                            <div class="bg-red-50 p-3 rounded-xl border border-red-200 max-h-32 overflow-y-auto"> <!-- ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ -->
                                <div class="space-y-2">
                                    ${errorLogs.slice(-3).reverse().map(log => ` <!-- Ø¹Ø±Ø¶ 3 Ø£Ø®Ø·Ø§Ø¡ ÙÙ‚Ø· -->
                                        <div class="bg-white p-2 rounded border border-red-200">
                                            <div class="flex justify-between items-center">
                                                <span class="text-red-600 text-xs font-semibold truncate">${log.context}</span>
                                                <span class="text-gray-500 text-xs">${new Date(log.timestamp).toLocaleTimeString('ar-SA')}</span>
                                            </div>
                                            <div class="text-xs text-gray-700 truncate mt-1">${log.error.message}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª - Ù…ØµØºØ±Ø© -->
                        <div class="flex gap-2 justify-center mt-6 pt-4 border-t border-gray-200"> <!-- ØªÙ… ØªØµØºÙŠØ± gap Ùˆpadding -->
                            <button onclick="copyDebugDataToClipboard()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                ğŸ“‹ Ù†Ø³Ø®
                            </button>
                            <button onclick="exportDebugData()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                ğŸ“¤ ØªØµØ¯ÙŠØ±
                            </button>
                            <button onclick="closeDebugModal('${modalId}')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all">
                                Ø¥ØºÙ„Ø§Ù‚
                            </button>
                        </div>

                        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø© -->
                        <div class="text-center mt-4">
                            <p class="text-xs text-gray-500">
                                Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString('ar-SA')}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¥Ù„Ù‰ body
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeDebugModal(modalId);
            }
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ù„Ø²Ø± ESC
        const closeOnEscape = function(e) {
            if (e.key === 'Escape') {
                closeDebugModal(modalId);
                document.removeEventListener('keydown', closeOnEscape);
            }
        };
        document.addEventListener('keydown', closeOnEscape);

    } catch (error) {
        ErrorHandler.logError(error, 'debugData');
        showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØ­Øµ', 'ØªØ¹Ø°Ø± ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeDebugModal(modalId) {
    try {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                modal.remove();
            }, 300);
        }
    } catch (error) {
        ErrorHandler.logError(error, 'closeDebugModal');
    }
}

// Ø¯Ø§Ù„Ø© Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©
function copyDebugDataToClipboard() {
    try {
        const storageInfo = StorageManager.getStorageInfo();
        const results = loadResults();
        const errorLogs = StorageManager.getItem('errorLogs') || [];

        const report = `
ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ
ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ: ${new Date().toLocaleString('ar-SA')}

ğŸ’¾ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†:
- Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒÙ„ÙŠ: ${storageInfo.totalSize.toFixed(2)} MB
- Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±: ${storageInfo.itemCount}

ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:
- Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${Object.keys(demoData.schools).length}
- Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†: ${Object.keys(demoData.users).length}
- Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${results.length}
- Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: ${errorLogs.length}

ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:
${JSON.stringify(currentUser, null, 2)}

ğŸ—‚ï¸ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®Ø²Ù†Ø©:
${storageInfo.items.map(item => `- ${item.key}: ${item.size.toFixed(2)} KB`).join('\n')}
        `.trim();

        navigator.clipboard.writeText(report).then(() => {
            showSuccessMessage('ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­');
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = report;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showSuccessMessage('ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­');
        });
    } catch (error) {
        ErrorHandler.logError(error, 'copyDebugDataToClipboard');
        showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø®', 'ØªØ¹Ø°Ø± Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
    }
}

// Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
function exportDebugData() {
    try {
        const storageInfo = StorageManager.getStorageInfo();
        const results = loadResults();
        const errorLogs = StorageManager.getItem('errorLogs') || [];

        const report = {
            timestamp: new Date().toISOString(),
            storage: storageInfo,
            statistics: {
                schools: Object.keys(demoData.schools).length,
                teachers: Object.keys(demoData.users).length,
                results: results.length,
                errors: errorLogs.length
            },
            currentUser: currentUser,
            items: storageInfo.items
        };

        const dataStr = JSON.stringify(report, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `debug_report_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showSuccessMessage('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        ErrorHandler.logError(error, 'exportDebugData');
        showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±', 'ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
    }
}

function debugSystem() {
    try {
        // Ø¬Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø§Ù…Ù„Ø© Ø¹Ù† Ø§Ù„Ù†Ø¸Ø§Ù…
        const systemInfo = {
            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
            browser: {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cookiesEnabled: navigator.cookieEnabled,
                online: navigator.onLine
            },
            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø©
            screen: {
                width: window.screen.width,
                height: window.screen.height,
                innerWidth: window.innerWidth,
                innerHeight: window.innerHeight,
                colorDepth: window.screen.colorDepth + ' bit'
            },
            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
            performance: {
                memory: performance.memory ? {
                    used: Math.round(performance.memory.usedJSHeapSize / 1048576) + ' MB',
                    total: Math.round(performance.memory.totalJSHeapSize / 1048576) + ' MB',
                    limit: Math.round(performance.memory.jsHeapSizeLimit / 1048576) + ' MB'
                } : 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                timing: performance.timing ? {
                    loadTime: (performance.timing.loadEventEnd - performance.timing.navigationStart) + ' ms',
                    domReady: (performance.timing.domContentLoadedEventStart - performance.timing.navigationStart) + ' ms'
                } : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'
            },
            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†
            storage: StorageManager.getStorageInfo(),
            // ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
            tests: {
                localStorage: StorageManager.isStorageAvailable(),
                sessionStorage: (() => {
                    try {
                        sessionStorage.setItem('test', 'test');
                        sessionStorage.removeItem('test');
                        return true;
                    } catch {
                        return false;
                    }
                })(),
                JSON: (() => {
                    try { JSON.parse('{"test": true}'); return true; } catch { return false; }
                })(),
                DOM: (() => {
                    try { document.createElement('div'); return true; } catch { return false; }
                })(),
                Canvas: (() => {
                    try { document.createElement('canvas').getContext('2d'); return true; } catch { return false; }
                })()
            },
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            appData: {
                schoolsCount: Object.keys(demoData.schools).length,
                teachersCount: Object.keys(demoData.users).length,
                resultsCount: loadResults().length,
                currentUser: currentUser ? currentUser.name : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„',
                activeTimers: ResourceManager.timers.size,
                activeSessions: ResourceManager.activeSessions.size
            },
            // Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©
            errorLogs: StorageManager.getItem('errorLogs') || []
        };

        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…ØµØºØ±Ø©
        const modalId = 'systemDebugModal_' + Date.now();
        let modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-4xl max-h-[85vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 text-center sticky top-0 z-10">
                        <h2 class="text-xl font-bold">ğŸ” ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
                        <p class="text-purple-100 text-sm">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø®ØªØµØ±Ø© Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                    </div>
                    <div class="p-4">
                        <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù…ØµØºØ±Ø© -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ -->
                            <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                <h3 class="font-bold text-blue-800 text-sm mb-2">ğŸŒ Ø§Ù„Ù…ØªØµÙØ­</h3>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„Ù„ØºØ©:</span>
                                        <span class="font-semibold">${systemInfo.browser.language}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„Ù…Ù†ØµØ©:</span>
                                        <span class="font-semibold">${systemInfo.browser.platform}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„Ø§ØªØµØ§Ù„:</span>
                                        <span class="${systemInfo.browser.online ? 'text-green-600' : 'text-red-600'} font-semibold">
                                            ${systemInfo.browser.online ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„ÙƒÙˆÙƒÙŠØ²:</span>
                                        <span>${systemInfo.browser.cookiesEnabled ? 'Ù…ÙØ¹Ù„Ø©' : 'ØºÙŠØ± Ù…ÙØ¹Ù„Ø©'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Ø­Ø§Ù„Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† -->
                            <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                                <h3 class="font-bold text-yellow-800 text-sm mb-2">ğŸ’¾ Ø§Ù„ØªØ®Ø²ÙŠÙ†</h3>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„Ø­Ø¬Ù…:</span>
                                        <span class="font-semibold">${systemInfo.storage.totalSize.toFixed(1)} MB</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„Ø¹Ù†Ø§ØµØ±:</span>
                                        <span class="font-semibold">${systemInfo.storage.itemCount}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                                        <span class="${systemInfo.tests.localStorage ? 'text-green-600' : 'text-red-600'} font-semibold">
                                            ${systemInfo.tests.localStorage ? 'ğŸŸ¢ Ù†Ø´Ø·' : 'ğŸ”´ Ù…Ø¹Ø·Ù„'}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
                            <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                                <h3 class="font-bold text-purple-800 text-sm mb-2">ğŸ“Š Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:</span>
                                        <span class="font-semibold">${systemInfo.appData.schoolsCount}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ†:</span>
                                        <span class="font-semibold">${systemInfo.appData.teachersCount}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„Ù†ØªØ§Ø¦Ø¬:</span>
                                        <span class="font-semibold">${systemInfo.appData.resultsCount}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span>
                                        <span class="font-semibold">${systemInfo.appData.currentUser}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
                            <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                                <h3 class="font-bold text-green-800 text-sm mb-2">ğŸ”§ Ø§Ù„ÙØ­ÙˆØµØ§Øª</h3>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„ØªØ®Ø²ÙŠÙ†:</span>
                                        <span class="${systemInfo.tests.localStorage ? 'text-green-600' : 'text-red-600'} font-semibold">
                                            ${systemInfo.tests.localStorage ? 'ğŸŸ¢' : 'ğŸ”´'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Ø§Ù„Ø¬Ù„Ø³Ø§Øª:</span>
                                        <span class="${systemInfo.tests.sessionStorage ? 'text-green-600' : 'text-red-600'} font-semibold">
                                            ${systemInfo.tests.sessionStorage ? 'ğŸŸ¢' : 'ğŸ”´'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>JSON:</span>
                                        <span class="${systemInfo.tests.JSON ? 'text-green-600' : 'text-red-600'} font-semibold">
                                            ${systemInfo.tests.JSON ? 'ğŸŸ¢' : 'ğŸ”´'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Canvas:</span>
                                        <span class="${systemInfo.tests.Canvas ? 'text-green-600' : 'text-red-600'} font-semibold">
                                            ${systemInfo.tests.Canvas ? 'ğŸŸ¢' : 'ğŸ”´'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯ -->
                        <div class="bg-gray-50 p-3 rounded-lg mb-3">
                            <h3 class="font-bold text-gray-800 text-sm mb-2">âš¡ Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
                            <div class="grid grid-cols-3 gap-2 text-xs">
                                <div class="text-center">
                                    <div class="font-semibold">${systemInfo.appData.activeTimers}</div>
                                    <div class="text-gray-600">Ù…Ø¤Ù‚Øª</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold">${systemInfo.appData.activeSessions}</div>
                                    <div class="text-gray-600">Ø¬Ù„Ø³Ø©</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold">${systemInfo.performance.memory.used ? systemInfo.performance.memory.used.split(' ')[0] : 'N/A'}</div>
                                    <div class="text-gray-600">Ø°Ø§ÙƒØ±Ø©</div>
                                </div>
                            </div>
                        </div>

                        <!-- Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø­Ø¯ÙŠØ«Ø© Ù…ØµØºØ±Ø© -->
                        <div class="bg-red-50 p-3 rounded-lg mb-3">
                            <h3 class="font-bold text-red-800 text-sm mb-2">âš ï¸ Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h3>
                            <div class="space-y-1 max-h-20 overflow-y-auto">
                                ${systemInfo.errorLogs.length === 0 ? 
                                    '<p class="text-gray-500 text-center text-xs py-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡</p>' : 
                                    systemInfo.errorLogs.slice(-3).reverse().map(log => `
                                        <div class="bg-white p-2 rounded border border-red-200">
                                            <div class="flex justify-between items-center">
                                                <span class="text-red-600 text-xs font-semibold truncate">${log.context}</span>
                                                <span class="text-gray-500 text-xs">${new Date(log.timestamp).toLocaleTimeString('ar-SA')}</span>
                                            </div>
                                            <div class="text-xs text-gray-700 truncate mt-1">${log.error.message}</div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>

                        <!-- Ø£ÙƒØ¨Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…ØµØºØ±Ø© -->
                        <div class="bg-orange-50 p-3 rounded-lg mb-4">
                            <h3 class="font-bold text-orange-800 text-sm mb-2">ğŸ—ƒï¸ Ø£ÙƒØ¨Ø± Ø§Ù„Ù…Ù„ÙØ§Øª</h3>
                            <div class="space-y-1">
                                ${systemInfo.storage.items.slice(0, 3).map(item => `
                                    <div class="flex justify-between items-center bg-white p-2 rounded border text-xs">
                                        <span class="truncate flex-1 mr-2" title="${item.key}">${item.key}</span>
                                        <span class="text-orange-600 font-semibold whitespace-nowrap">${item.size.toFixed(1)} KB</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…ØµØºØ±Ø© -->
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-3 rounded-lg border border-blue-200">
                            <h3 class="font-bold text-blue-800 text-sm mb-2">ğŸ› ï¸ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="runSystemCleanup()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-1">
                                    ğŸ§¹ ØªÙ†Ø¸ÙŠÙ
                                </button>
                                <button onclick="clearResultsOnly()" class="bg-orange-500 hover:bg-orange-600 text-white py-2 px-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-1">
                                    ğŸ—‘ï¸ Ù†ØªØ§Ø¦Ø¬
                                </button>
                                <button onclick="location.reload()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-1">
                                    ğŸ”„ ØªØ­Ø¯ÙŠØ«
                                </button>
                                <button onclick="closeModal('${modalId}')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-1">
                                    Ø¥ØºÙ„Ø§Ù‚
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(modalId);
            }
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ù„Ø²Ø± ESC
        const closeOnEscape = function(e) {
            if (e.key === 'Escape') {
                closeModal(modalId);
                document.removeEventListener('keydown', closeOnEscape);
            }
        };
        document.addEventListener('keydown', closeOnEscape);

        console.log('ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…:', systemInfo);

    } catch (error) {
        ErrorHandler.logError(error, 'debugSystem');
        showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØ­Øµ', 'ØªØ¹Ø°Ø± ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…. Ø±Ø§Ø¬Ø¹ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ….');
    }
}

// Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø¸Ø§Ù…
function runSystemCleanup() {
    try {
        showLoadingMessage('Ø¬Ø§Ø±ÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø¸Ø§Ù…...');
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        ResourceManager.cleanup();
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        StorageManager.clearOldData();
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø­ØªÙØ¸ Ø¨Ø¢Ø®Ø± 10 ÙÙ‚Ø·)
        const errorLogs = StorageManager.getItem('errorLogs') || [];
        if (errorLogs.length > 10) {
            StorageManager.setItem('errorLogs', errorLogs.slice(-10));
        }
        
        setTimeout(() => {
            hideLoadingMessage();
            showSuccessMessage('ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ', 'ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙØ­Øµ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ
            const existingModal = document.querySelector('[id^="systemDebugModal_"]');
            if (existingModal) {
                existingModal.remove();
            }
            setTimeout(() => {
                debugSystem();
            }, 500);
        }, 1000);
        
    } catch (error) {
        hideLoadingMessage();
        ErrorHandler.logError(error, 'runSystemCleanup');
        showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ', 'ØªØ¹Ø°Ø± ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø¸Ø§Ù…');
    }
}

// Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø¸Ø§Ù…
function runSystemCleanup() {
    try {
        showLoadingMessage('Ø¬Ø§Ø±ÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø¸Ø§Ù…...');
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        ResourceManager.cleanup();
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        StorageManager.clearOldData();
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø­ØªÙØ¸ Ø¨Ø¢Ø®Ø± 10 ÙÙ‚Ø·)
        const errorLogs = StorageManager.getItem('errorLogs') || [];
        if (errorLogs.length > 10) {
            StorageManager.setItem('errorLogs', errorLogs.slice(-10));
        }
        
        setTimeout(() => {
            hideLoadingMessage();
            showSuccessMessage('ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ', 'ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­');
            debugSystem(); // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙØ­Øµ
        }, 1000);
        
    } catch (error) {
        hideLoadingMessage();
        ErrorHandler.logError(error, 'runSystemCleanup');
    }
}

function showAllSchools() {
    try {
        console.log('=== Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ===');
        console.log('Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:', demoData.schools);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
        const modalId = 'schoolsModal_' + Date.now();
        let modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-6xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 text-center sticky top-0 z-10">
                        <h2 class="text-2xl font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</h2>
                        <p class="text-purple-100">Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                    </div>
                    <div class="p-6">
                        <div class="mb-6 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</h3>
                            <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm">
                                ${Object.keys(demoData.schools).length} Ù…Ø¯Ø±Ø³Ø©
                            </span>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full bg-white rounded-xl overflow-hidden">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>
                                        <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                                        <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</th>
                                        <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody>
        `;
        
        // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„ Ù…Ø¯Ø±Ø³Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        Object.values(demoData.schools).forEach((school, index) => {
            modalHTML += `
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-all">
                    <td class="px-6 py-4 text-right">
                        <div class="font-bold text-gray-800">${school.name}</div>
                    </td>
                    <td class="px-6 py-4 text-right">${school.teacher}</td>
                    <td class="px-6 py-4 text-right">
                        <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-sm">
                            ${school.tests ? school.tests.length : 0} Ø§Ø®ØªØ¨Ø§Ø±
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex gap-2 justify-end">
                            <button onclick="showSchoolDetails('${school.id}')" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                ØªÙØ§ØµÙŠÙ„
                            </button>
                            <button onclick="deleteSchool('${school.id}')" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"></path>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                    <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                Ø­Ø°Ù
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        modalHTML += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="text-center mt-8 pt-6 border-t border-gray-200">
                            <button onclick="closeModal('${modalId}')" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-3 rounded-xl font-semibold transition-all shadow-lg">
                                Ø¥ØºÙ„Ø§Ù‚
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(modalId);
            }
        });
        
        console.log('ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ù…Ø¯Ø§Ø±Ø³');
        
    } catch (error) {
        ErrorHandler.logError(error, 'showAllSchools');
    }
}

// ========== Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ ==========

// Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
// Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
async function createBackup() {
    try {
        showLoadingMessage('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...');
        
        // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        let remoteData = {};
        try {
            remoteData = {
                teacherAccounts: await RemoteAPI.getTeachers(),
                schools: await RemoteAPI.getSchools(),
                results: await RemoteAPI.getResults()
            };
        } catch (apiError) {
            console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:', apiError);
        }
        
        const backupData = {
            version: '2.0',
            timestamp: new Date().toISOString(),
            createdBy: currentUser?.email || 'unknown',
            source: 'remote_and_local',
            
            // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ ÙˆØ§Ù„Ù…Ø­Ù„ÙŠ
            teacherAccounts: remoteData.teacherAccounts || demoData.users,
            schools: remoteData.schools || demoData.schools,
            testResults: remoteData.results || loadResults(),
            
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
            systemSettings: StorageManager.getItem('systemSettings') || {},
            errorLogs: StorageManager.getItem('errorLogs') || []
        };

        // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ JSON Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚
        const backupJson = JSON.stringify(backupData, null, 2);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù„Ù„ØªØ­Ù…ÙŠÙ„
        const blob = new Blob([backupJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `Ù†Ø¸Ø§Ù…_Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª_Ø§Ù„Ù†Ø³Ø®Ø©_Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // ØªØ­Ø±ÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        
        // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        saveBackupInfo(backupData);
        
        hideLoadingMessage();
        showSuccessMessage('ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
        
    } catch (error) {
        hideLoadingMessage();
        ErrorHandler.logError(error, 'createBackup');
        showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø®', 'ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
    }
}

// Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
function saveBackupInfo(backupData) {
    try {
        const backupHistory = StorageManager.getItem('backupHistory') || [];
        
        const backupInfo = {
            id: Date.now(),
            timestamp: backupData.timestamp,
            size: JSON.stringify(backupData).length,
            items: {
                teachers: Object.keys(backupData.teacherAccounts || {}).length,
                schools: Object.keys(backupData.demoSchoolsData || {}).length,
                results: (backupData.testResults || []).length,
                errors: (backupData.errorLogs || []).length
            },
            createdBy: backupData.createdBy
        };
        
        backupHistory.unshift(backupInfo); // Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        
        // Ø­ÙØ¸ Ø¢Ø®Ø± 10 Ù†Ø³Ø® ÙÙ‚Ø·
        if (backupHistory.length > 10) {
            backupHistory.splice(10);
        }
        
        StorageManager.setItem('backupHistory', backupHistory);
        
    } catch (error) {
        console.warn('Failed to save backup info:', error);
    }
}

// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
function showRestoreBackupModal() {
    try {
        const modalId = 'restoreBackupModal_' + Date.now();
        
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-md">
                    <div class="bg-gradient-to-r from-pink-600 to-purple-600 text-white p-6 text-center">
                        <h2 class="text-xl font-bold">ğŸ“¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h2>
                        <p class="text-pink-100 text-sm">Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (.json)</label>
                            <input type="file" id="backupFileInput" accept=".json" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-pink-500 focus:outline-none">
                            <p class="text-xs text-gray-500 mt-2">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ù…Ù† Ù†ÙˆØ¹ JSON Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</p>
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-4">
                            <div class="flex items-start gap-2">
                                <span class="text-yellow-600">âš ï¸</span>
                                <div class="text-sm text-yellow-700">
                                    <strong>ØªØ­Ø°ÙŠØ±:</strong> Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø³ØªØ³ØªØ¨Ø¯Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§!
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="restoreBackup('${modalId}')" class="flex-1 bg-pink-500 hover:bg-pink-600 text-white py-3 rounded-xl font-semibold transition-all">
                                Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                            </button>
                            <button onclick="closeModal('${modalId}')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(modalId);
            }
        });
        
    } catch (error) {
        ErrorHandler.logError(error, 'showRestoreBackupModal');
    }
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
function restoreBackup(modalId) {
    try {
        const fileInput = document.getElementById('backupFileInput');
        const file = fileInput?.files[0];
        
        if (!file) {
            showErrorMessage('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        if (!file.name.endsWith('.json')) {
            showErrorMessage('Ø®Ø·Ø£', 'Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ù† Ù†ÙˆØ¹ JSON');
            return;
        }
        
        if (!confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©!\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ')) {
            return;
        }
        
        showLoadingMessage('Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...');
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const backupData = JSON.parse(e.target.result);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (!isValidBackup(backupData)) {
                    throw new Error('Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­');
                }
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (backupData.teacherAccounts) {
                    StorageManager.setItem('teacherAccounts', backupData.teacherAccounts);
                    demoData.users = backupData.teacherAccounts;
                }
                
                if (backupData.demoSchoolsData) {
                    StorageManager.setItem('demoSchoolsData', backupData.demoSchoolsData);
                    demoData.schools = backupData.demoSchoolsData;
                }
                
                if (backupData.testResults) {
                    StorageManager.setItem('testResults', backupData.testResults);
                }
                
                if (backupData.systemSettings) {
                    StorageManager.setItem('systemSettings', backupData.systemSettings);
                }
                
                if (backupData.errorLogs) {
                    StorageManager.setItem('errorLogs', backupData.errorLogs);
                }
                
                closeModal(modalId);
                hideLoadingMessage();
                
                showSuccessMessage('ØªÙ… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } catch (error) {
                hideLoadingMessage();
                ErrorHandler.logError(error, 'restoreBackup.parse');
                showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªØ§Ù„Ù Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­');
            }
        };
        
        reader.onerror = function() {
            hideLoadingMessage();
            showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', 'ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
        };
        
        reader.readAsText(file);
        
    } catch (error) {
        hideLoadingMessage();
        ErrorHandler.logError(error, 'restoreBackup');
        showErrorMessage('Ø®Ø·Ø£', 'ØªØ¹Ø°Ø± Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
    }
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
function isValidBackup(backupData) {
    return backupData && 
           typeof backupData === 'object' &&
           backupData.version &&
           backupData.timestamp &&
           (backupData.teacherAccounts || backupData.demoSchoolsData || backupData.testResults);
}

// Ø¹Ø±Ø¶ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
function showBackupManager() {
    try {
        const backupHistory = StorageManager.getItem('backupHistory') || [];
        
        const modalId = 'backupManagerModal_' + Date.now();
        
        let historyHTML = '';
        if (backupHistory.length === 0) {
            historyHTML = `
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-2">ğŸ“­</div>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø³Ø§Ø¨Ù‚Ø©</p>
                </div>
            `;
        } else {
            historyHTML = `
                <div class="space-y-3 max-h-60 overflow-y-auto">
                    ${backupHistory.map(backup => `
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">Ù†Ø³Ø®Ø© ${new Date(backup.timestamp).toLocaleString('ar-SA')}</div>
                                    <div class="text-sm text-gray-600">Ø¨ÙˆØ§Ø³Ø·Ø©: ${backup.createdBy}</div>
                                </div>
                                <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-xs">${(backup.size / 1024).toFixed(2)} KB</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 text-xs">
                                <div class="text-center">
                                    <div class="font-bold">${backup.items.teachers}</div>
                                    <div class="text-gray-500">Ù…Ø¹Ù„Ù…</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold">${backup.items.schools}</div>
                                    <div class="text-gray-500">Ù…Ø¯Ø±Ø³Ø©</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold">${backup.items.results}</div>
                                    <div class="text-gray-500">Ù†ØªÙŠØ¬Ø©</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold">${backup.items.errors}</div>
                                    <div class="text-gray-500">Ø®Ø·Ø£</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-teal-600 to-blue-600 text-white p-6 text-center sticky top-0 z-10">
                        <h2 class="text-2xl font-bold">ğŸ—‚ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h2>
                        <p class="text-teal-100">Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</p>
                    </div>
                    
                    <div class="p-6">
                        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-blue-600">${backupHistory.length}</div>
                                <div class="text-sm text-blue-600">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-green-600">${Math.max(...backupHistory.map(b => b.items.teachers)) || 0}</div>
                                <div class="text-sm text-green-600">Ø£ÙƒØ«Ø± Ù…Ø¹Ù„Ù…</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-purple-600">${new Date(Math.max(...backupHistory.map(b => new Date(b.timestamp).getTime()))).toLocaleDateString('ar-SA') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div>
                                <div class="text-sm text-purple-600">Ø¢Ø®Ø± Ù†Ø³Ø®Ø©</div>
                            </div>
                        </div>
                        
                        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø® -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ“‹ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
                            ${historyHTML}
                        </div>
                        
                        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
                        <div class="flex gap-2 justify-center border-t border-gray-200 pt-6">
                            <button onclick="createBackup()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                                ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø©
                            </button>
                            <button onclick="showRestoreBackupModal()" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                                ğŸ“¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©
                            </button>
                            <button onclick="closeModal('${modalId}')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                                Ø¥ØºÙ„Ø§Ù‚
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(modalId);
            }
        });
        
    } catch (error) {
        ErrorHandler.logError(error, 'showBackupManager');
    }
}


// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
function showSchoolDetails(schoolId) {
    try {
        const school = demoData.schools[schoolId];
        if (!school) {
            alert('Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        const modalId = 'schoolDetailsModal_' + Date.now();
        let detailsHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 text-center sticky top-0 z-10">
                        <h2 class="text-2xl font-bold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h2>
                    </div>
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-blue-50 p-4 rounded-xl">
                                <div class="text-blue-600 font-semibold">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
                                <div class="font-bold text-lg">${school.name}</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl">
                                <div class="text-green-600 font-semibold">Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
                                <div class="font-bold text-lg">${school.teacher}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-xl mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (${school.tests ? school.tests.length : 0})</h3>
        `;
        
        if (!school.tests || school.tests.length === 0) {
            detailsHTML += `
                <div class="text-center text-gray-500 py-4">
                    <div class="text-4xl mb-2">ğŸ“</div>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</p>
                </div>
            `;
        } else {
            detailsHTML += `<div class="space-y-3">`;
            
            school.tests.forEach((test, index) => {
                detailsHTML += `
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-gray-800">${test.name}</h4>
                            <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-sm">${test.subject}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                            <div>Ø§Ù„ØµÙ: ${test.grade}</div>
                            <div>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${test.questions ? test.questions.length : 0}</div>
                            <div>Ø§Ù„ÙˆÙ‚Øª: ${test.timerPerQuestion || 30} Ø«Ø§Ù†ÙŠØ©</div>
                            <div>Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${test.difficulty || 'Ù…ØªÙˆØ³Ø·'}</div>
                        </div>
                    </div>
                `;
            });
            
            detailsHTML += `</div>`;
        }
        
        detailsHTML += `
                        </div>
                        
                        <div class="text-center mt-6">
                            <button onclick="closeModal('${modalId}')" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                                Ø¥ØºÙ„Ø§Ù‚
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailsHTML);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(modalId);
            }
        });
        
    } catch (error) {
        ErrorHandler.logError(error, 'showSchoolDetails');
    }
}

// Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
function deleteSchool(schoolId) {
    try {
        const school = demoData.schools[schoolId];
        if (!school) {
            alert('Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ\n\nØ§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${school.name}\nØ§Ù„Ù…Ø¹Ù„Ù…: ${school.teacher}\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`)) {
            return;
        }
        
        // Ø­Ø°Ù Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
        delete demoData.schools[schoolId];
        
        // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        if (success) {
            showSuccessMessage('ØªÙ… Ø§Ù„Ø­Ø°Ù', `ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¯Ø±Ø³Ø© "${school.name}" Ø¨Ù†Ø¬Ø§Ø­`);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ù…Ø¯Ø§Ø±Ø³
            closeAllModals();
            setTimeout(() => {
                showAllSchools();
            }, 500);
        } else {
            alert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø¯Ø±Ø³Ø©');
        }
        
    } catch (error) {
        ErrorHandler.logError(error, 'deleteSchool');
    }
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
function closeAllModals() {
    try {
        const modals = document.querySelectorAll('[id^="schoolsModal_"], [id^="schoolDetailsModal_"]');
        modals.forEach(modal => modal.remove());
    } catch (error) {
        ErrorHandler.logError(error, 'closeAllModals');
    }
}

// ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
function searchSchools() {
    try {
        const searchTerm = document.getElementById('schoolSearch')?.value.toLowerCase().trim() || '';
        const resultsContainer = document.getElementById('schoolSearchResults');
        
        if (!resultsContainer) {
            console.warn('Search results container not found');
            return;
        }
        
        if (searchTerm.length < 2) {
            resultsContainer.classList.add('hidden');
            return;
        }
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙ‚Ø· ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ù„Ù…Ø¹Ù„Ù…
        const matchingSchools = Object.values(demoData.schools).filter(school => 
            school.name.toLowerCase().includes(searchTerm) || 
            school.teacher.toLowerCase().includes(searchTerm)
        );
        
        if (matchingSchools.length === 0) {
            resultsContainer.innerHTML = '<div class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</div>';
            resultsContainer.classList.remove('hidden');
            return;
        }
        
        let resultsHTML = '';
        matchingSchools.forEach(school => {
            resultsHTML += `
                <div class="p-4 border-b border-gray-200 hover:bg-blue-50 cursor-pointer transition-all" onclick="selectSearchedSchool('${school.id}')">
                    <div class="font-bold text-gray-800">${school.name}</div>
                    <div class="text-sm text-gray-600">${school.teacher}</div>
                </div>
            `;
        });
        
        resultsContainer.innerHTML = resultsHTML;
        resultsContainer.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'searchSchools');
    }
}

// ÙˆØ¸ÙŠÙØ© Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ø±Ø³Ø© Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
function selectSearchedSchool(schoolId) {
    try {
        const school = demoData.schools[schoolId];
        if (!school) {
            console.warn('School not found:', schoolId);
            return;
        }
        
        const schoolSearch = document.getElementById('schoolSearch');
        const searchResults = document.getElementById('schoolSearchResults');
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        
        if (schoolSearch) schoolSearch.value = school.name;
        if (searchResults) searchResults.classList.add('hidden');
        
        // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙŠ Ø­Ù‚Ù„ Ù…Ø®ÙÙŠ
        if (selectedSchoolInfo) {
            selectedSchoolInfo.dataset.schoolId = schoolId;
            
            // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            selectedSchoolInfo.classList.remove('hidden');
            document.getElementById('chosenSchoolName').textContent = school.name;
            document.getElementById('chosenTeacher').textContent = school.teacher;
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
            const testSelect = document.getElementById('testSelect');
            if (testSelect) {
                testSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</option>';
                
                school.tests.forEach((test, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
                    testSelect.appendChild(option);
                });
            }
        }
    } catch (error) {
        ErrorHandler.logError(error, 'selectSearchedSchool');
    }
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

// ÙˆØ¸Ø§Ø¦Ù Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…
function showTeacherSignup() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        document.getElementById('teacherSignupScreen').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherSignup');
    }
}

function closeTeacherSignup() {
    try {
        document.getElementById('teacherSignupScreen').classList.add('hidden');
        const signupError = document.getElementById('signupError');
        const signupSuccess = document.getElementById('signupSuccess');
        const signupForm = document.getElementById('teacherSignupForm');
        
        if (signupError) signupError.classList.add('hidden');
        if (signupSuccess) signupSuccess.classList.add('hidden');
        if (signupForm) signupForm.reset();
    } catch (error) {
        ErrorHandler.logError(error, 'closeTeacherSignup');
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¹Ù„Ù… Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
// Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¹Ù„Ù… Ù…Ø­Ø¯Ø« Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
async function teacherSignup(event) {
    try {
        event.preventDefault();
        
        const name = DataValidator.sanitizeInput(document.getElementById('newTeacherName').value);
        const email = DataValidator.sanitizeInput(document.getElementById('newTeacherEmail').value);
        const school = DataValidator.sanitizeInput(document.getElementById('newTeacherSchool').value);
        const stage = document.getElementById('newTeacherStage').value;
        const password = document.getElementById('newTeacherPassword').value;
        const confirmPassword = document.getElementById('confirmTeacherPassword').value;
        
        const errorDiv = document.getElementById('signupError');
        const successDiv = document.getElementById('signupSuccess');
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        if (errorDiv) errorDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const validationErrors = [];
        
        if (!DataValidator.validateEmail(email)) {
            validationErrors.push('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
        }
        
        const passwordError = DataValidator.validatePassword(password);
        if (passwordError) {
            validationErrors.push(passwordError);
        }
        
        if (password !== confirmPassword) {
            validationErrors.push('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†');
        }
        
        if (!stage) {
            validationErrors.push('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©');
        }
        
        if (validationErrors.length > 0) {
            if (errorDiv) {
                errorDiv.textContent = validationErrors.join('\n');
                errorDiv.classList.remove('hidden');
            }
            return false;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¨Ù‚Ø§Ù‹
        if (demoData.users[email]) {
            if (errorDiv) {
                errorDiv.textContent = 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹';
                errorDiv.classList.remove('hidden');
            }
            return false;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const teacherData = {
            name: name,
            email: email,
            password: password,
            school: school,
            stage: stage
        };

        try {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹
            const signupResult = await RemoteAPI.createTeacher(teacherData);
            
            if (signupResult && signupResult.success) {
                // Ø§Ù„Ù†Ø¬Ø§Ø­ - Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø£ÙŠØ¶Ø§Ù‹
                currentUser = {
                    email: email,
                    password: password,
                    name: name,
                    school: school,
                    stage: stage
                };
                
                demoData.users[email] = currentUser;
                StorageManager.setItem('teacherAccounts', demoData.users);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø­Ù„ÙŠØ§Ù‹
                const schoolData = {
                    id: 'school_' + Date.now(),
                    name: school,
                    teacher: name,
                    tests: []
                };
                
                demoData.schools[schoolData.id] = schoolData;
                StorageManager.setItem('demoSchoolsData', demoData.schools);
                
            } else {
                throw new Error(signupResult?.error || 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨');
            }
            
        } catch (apiError) {
            // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ØŒ Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
            console.warn('ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ:', apiError);
            
            demoData.users[email] = {
                email: email,
                password: password,
                name: name,
                school: school,
                stage: stage
            };
            
            const schoolData = {
                id: 'school_' + Date.now(),
                name: school,
                teacher: name,
                tests: []
            };
            
            demoData.schools[schoolData.id] = schoolData;
            
            StorageManager.setItem('teacherAccounts', demoData.users);
            StorageManager.setItem('demoSchoolsData', demoData.schools);
        }
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        if (successDiv) {
            successDiv.textContent = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            successDiv.classList.remove('hidden');
        }
        
        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
        setTimeout(() => {
            closeTeacherSignup();
            showTeacherLogin();
        }, 2000);
        
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'teacherSignup');
        return false;
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø³Ù†
async function loadSchools() {
    try {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©
        if (!RemoteAPI.isAvailable) {
            const localSchools = StorageManager.getItem('demoSchoolsData') || {};
            console.log('ğŸ’¾ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', Object.keys(localSchools).length, 'Ù…Ø¯Ø±Ø³Ø©');
            Object.assign(demoData.schools, localSchools);
            return;
        }

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
        console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…...');
        const remoteSchools = await RemoteAPI.getSchools();
        
        if (remoteSchools && Object.keys(remoteSchools).length > 0) {
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…:', Object.keys(remoteSchools).length, 'Ù…Ø¯Ø±Ø³Ø©');
            Object.assign(demoData.schools, remoteSchools);
            
            // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
            StorageManager.setItem('demoSchoolsData', remoteSchools);
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø¯Ø§Ø±Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            console.log('ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯Ø§Ø±Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…');
            const localSchools = StorageManager.getItem('demoSchoolsData') || {};
            Object.assign(demoData.schools, localSchools);
        }
        
    } catch (error) {
        console.warn('âŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ù…Ø¯Ø§Ø±Ø³:', error.message);
        const localSchools = StorageManager.getItem('demoSchoolsData') || {};
        Object.assign(demoData.schools, localSchools);
    }
}

// ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…
// ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
// ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø­Ø¯Ø« Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
async function teacherLogin(event) {
    try {
        event.preventDefault();
        
        const email = document.getElementById('teacherEmail').value;
        const password = document.getElementById('teacherPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        if (!errorDiv) {
            ErrorHandler.logError(new Error('Login error element not found'), 'teacherLogin');
            return false;
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        errorDiv.classList.add('hidden');
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ (Ù„Ù„Ø³Ø±Ø¹Ø©)
        if (demoData.users[email] && demoData.users[email].password === password) {
            currentUser = demoData.users[email];
            closeTeacherLogin();
            showTeacherDashboard();
            return true;
        }
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
        try {
            const loginResult = await RemoteAPI.login({ email, password });
            
            if (loginResult && loginResult.success) {
                currentUser = {
                    email: loginResult.user.email,
                    password: password, // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                    name: loginResult.user.name,
                    school: loginResult.user.school,
                    stage: loginResult.user.stage
                };
                
                // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                demoData.users[email] = currentUser;
                StorageManager.setItem('teacherAccounts', demoData.users);
                
                closeTeacherLogin();
                showTeacherDashboard();
                return true;
            } else {
                errorDiv.textContent = loginResult?.error || 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                errorDiv.classList.remove('hidden');
                return false;
            }
        } catch (apiError) {
            // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·
            console.warn('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯:', apiError);
            errorDiv.textContent = 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
            errorDiv.classList.remove('hidden');
            return false;
        }
    } catch (error) {
        ErrorHandler.logError(error, 'teacherLogin');
        return false;
    }
}

function teacherLogout() {
    try {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        ResourceManager.cleanup();
        SystemRecovery.clearSession();
        
        currentUser = null;
        document.getElementById('teacherDashboard').classList.add('hidden');
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateWelcomeStatistics();
    } catch (error) {
        ErrorHandler.logError(error, 'teacherLogout');
    }
}

// Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
function selectTest() {
    try {
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const testSelect = document.getElementById('testSelect');
        
        if (!selectedSchoolInfo || !testSelect) {
            console.warn('Required elements not found for selectTest');
            return;
        }
        
        const schoolId = selectedSchoolInfo.dataset.schoolId;
        const testIndex = testSelect.value;
        
        if (!schoolId || testIndex === '') {
            const testInfo = document.getElementById('testInfo');
            const studentForm = document.getElementById('studentForm');
            
            if (testInfo) testInfo.classList.add('hidden');
            if (studentForm) studentForm.classList.add('hidden');
            return;
        }
        
        const school = demoData.schools[schoolId];
        const test = school.tests[testIndex];
        
        if (test) {
            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            const testInfo = document.getElementById('testInfo');
            if (testInfo) {
                testInfo.innerHTML = `
                    <h3 class="font-bold text-blue-800 mb-4">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <span class="text-blue-600 font-semibold">ğŸ“– Ø§Ù„Ù…Ø§Ø¯Ø©:</span>
                            <span class="font-bold text-gray-800 mr-2">${test.subject}</span>
                        </div>
                        <div>
                            <span class="text-blue-600 font-semibold">â“ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</span>
                            <span class="font-bold text-gray-800 mr-2">${test.questions.length}</span>
                        </div>
                        <div>
                            <span class="text-blue-600 font-semibold">ğŸ’ Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</span>
                            <span class="font-bold text-gray-800 mr-2">${test.grade}</span>
                        </div>
                        <div>
                            <span class="text-blue-600 font-semibold">â±ï¸ ÙˆÙ‚Øª Ø§Ù„Ø³Ø¤Ø§Ù„:</span>
                            <span class="font-bold text-gray-800 mr-2">${test.timerPerQuestion || 30} Ø«Ø§Ù†ÙŠØ©</span>
                        </div>
                    </div>
                `;
                testInfo.classList.remove('hidden');
            }
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ø§Ù„Ø¨
            const studentGradeSelect = document.getElementById('studentGrade');
            if (studentGradeSelect) {
                studentGradeSelect.innerHTML = `<option value="${test.grade}" selected>${test.grade}</option>`;
            }
            
            const studentForm = document.getElementById('studentForm');
            if (studentForm) studentForm.classList.remove('hidden');
        }
    } catch (error) {
        ErrorHandler.logError(error, 'selectTest');
    }
}

// Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
function startTest() {
    try {
        const name = DataValidator.sanitizeInput(document.getElementById('studentName')?.value || '');
        const studentGrade = document.getElementById('studentGrade')?.value || '';
        const studentClass = DataValidator.sanitizeInput(document.getElementById('studentClass')?.value || '');
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const testSelect = document.getElementById('testSelect');
        
        if (!selectedSchoolInfo || !testSelect) {
            alert('Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
            return;
        }
        
        const schoolId = selectedSchoolInfo.dataset.schoolId;
        const testIndex = testSelect.value;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const validation = DataValidator.validateStudentData({
            name: name,
            grade: studentGrade,
            class: studentClass
        });
        
        if (!validation.isValid) {
            alert(`ÙŠØ±Ø¬Ù‰ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ§Ù„ÙŠØ©:\n${validation.errors.join('\n')}`);
            return;
        }
        
        if (!schoolId || testIndex === '') {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        const school = demoData.schools[schoolId];
        if (!school) {
            alert('Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        currentTest = school.tests[testIndex];
        if (!currentTest) {
            alert('Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const testValidation = DataValidator.validateTestData(currentTest);
        if (!testValidation.isValid) {
            alert(`Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:\n${testValidation.errors.join('\n')}`);
            return;
        }
        
        studentData = {
            name: name,
            grade: studentGrade,
            class: studentClass,
            score: 0,
            answers: [],
            school: school.name,
            teacher: school.teacher
        };
        
        currentQuestionIndex = 0;
        
        document.getElementById('studentAccessScreen').classList.add('hidden');
        document.getElementById('testScreen').classList.remove('hidden');
        
        updateTestInfo();
        showQuestion();
        
        // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
        SystemRecovery.saveSession({
            testInProgress: true,
            studentData: studentData,
            currentTest: currentTest.name,
            currentQuestionIndex: currentQuestionIndex
        });
    } catch (error) {
        ErrorHandler.logError(error, 'startTest');
        alert('ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
}

function updateTestInfo() {
    try {
        const elements = {
            testSchoolName: document.getElementById('testSchoolName'),
            testSubjectName: document.getElementById('testSubjectName'),
            testGradeLevel: document.getElementById('testGradeLevel'),
            testStudentName: document.getElementById('testStudentName'),
            totalQuestions: document.getElementById('totalQuestions')
        };
        
        if (elements.testSchoolName) elements.testSchoolName.textContent = studentData.school;
        if (elements.testSubjectName) elements.testSubjectName.textContent = currentTest.subject;
        if (elements.testGradeLevel) elements.testGradeLevel.textContent = currentTest.grade;
        if (elements.testStudentName) elements.testStudentName.textContent = studentData.name;
        if (elements.totalQuestions) elements.totalQuestions.textContent = currentTest.questions.length;
    } catch (error) {
        ErrorHandler.logError(error, 'updateTestInfo');
    }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„
function showQuestion() {
    try {
        if (currentQuestionIndex >= currentTest.questions.length) {
            endTest();
            return;
        }
        
        const question = currentTest.questions[currentQuestionIndex];
        
        const currentQuestionElement = document.getElementById('currentQuestion');
        const currentScoreElement = document.getElementById('currentScore');
        const questionTextElement = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedbackArea = document.getElementById('feedbackArea');
        const progressBar = document.getElementById('progressBar');
        
        if (currentQuestionElement) currentQuestionElement.textContent = currentQuestionIndex + 1;
        if (currentScoreElement) currentScoreElement.textContent = studentData.score;
        if (questionTextElement) questionTextElement.textContent = question.question;
        
        if (optionsContainer) {
            optionsContainer.innerHTML = '';
            
            const optionLabels = ['Ø£', 'Ø¨', 'Ø¬', 'Ø¯'];
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn bg-gray-50 hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 p-4 rounded-xl text-right transition-all';
                button.onclick = () => selectAnswer(index);
                button.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">${optionLabels[index]}</span>
                        <span class="flex-1">${option}</span>
                    </div>
                `;
                optionsContainer.appendChild(button);
            });
        }
        
        if (feedbackArea) {
            feedbackArea.classList.add('hidden');
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        if (progressBar) {
            const progress = ((currentQuestionIndex + 1) / currentTest.questions.length) * 100;
            progressBar.style.width = progress + '%';
        }
        
        startTimer();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©
        SystemRecovery.saveSession({
            testInProgress: true,
            studentData: studentData,
            currentTest: currentTest.name,
            currentQuestionIndex: currentQuestionIndex
        });
    } catch (error) {
        ErrorHandler.logError(error, 'showQuestion');
    }
}

function startTimer() {
    try {  
        // ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ø³Ø§Ø¨Ù‚
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆÙ‚Øª Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© 30 Ø«Ø§Ù†ÙŠØ©
        timeLeft = currentTest.timerPerQuestion || 30;
        const timerElement = document.getElementById('timer');
        if (!timerElement) return;
        
        timerElement.textContent = timeLeft;
        timerElement.className = 'inline-block bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-2xl font-bold';
        
        timer = setInterval(() => {
            timeLeft--;
            timerElement.textContent = timeLeft;
            
            // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ø¹Ù†Ø¯Ù…Ø§ ÙŠØµÙ„ Ø¥Ù„Ù‰ 10 Ø«ÙˆØ§Ù†ÙŠ ÙÙ‚Ø·
            const warningTime = 10; // Ø«Ø§Ø¨Øª Ø¹Ù†Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø±Ø¨Ø¹ Ø§Ù„ÙˆÙ‚Øª
            if (timeLeft <= warningTime) {
                timerElement.className = 'inline-block bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-full text-2xl font-bold pulse-red';
            }
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                ResourceManager.timers.delete(timer);
                timer = null;
                timeUp();
            }
        }, 1000);
        
        ResourceManager.addTimer(timer);
    } catch (error) {
        ErrorHandler.logError(error, 'startTimer');
    }
}

function selectAnswer(selectedIndex) {
    try {
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        const question = currentTest.questions[currentQuestionIndex];
        const isCorrect = selectedIndex === question.correct;
        
        studentData.answers.push({
            questionIndex: currentQuestionIndex,
            selected: selectedIndex,
            correct: question.correct,
            isCorrect: isCorrect
        });
        
        if (isCorrect) {
            studentData.score++;
        }
        
        showFeedback(selectedIndex, question.correct, isCorrect);
        disableOptions();
        
        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
        }, 2000);
    } catch (error) {
        ErrorHandler.logError(error, 'selectAnswer');
    }
}

function timeUp() {
    try {
        const question = currentTest.questions[currentQuestionIndex];
        
        studentData.answers.push({
            questionIndex: currentQuestionIndex,
            selected: -1,
            correct: question.correct,
            isCorrect: false
        });
        
        showTimeUpFeedback(question.correct);
        disableOptions();
        
        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
        }, 2000);
    } catch (error) {
        ErrorHandler.logError(error, 'timeUp');
    }
}

function showFeedback(selectedIndex, correctIndex, isCorrect) {
    try {
        const feedbackArea = document.getElementById('feedbackArea');
        const options = document.querySelectorAll('.option-btn');
        
        if (!feedbackArea) return;
        
        if (isCorrect) {
            feedbackArea.innerHTML = '<div class="text-green-600 font-bold text-xl">âœ… Ø£Ø­Ø³Ù†Øª! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</div>';
            feedbackArea.className = 'text-center p-4 rounded-xl mb-6 feedback-correct';
            if (options[selectedIndex]) {
                options[selectedIndex].className = 'option-btn bg-green-100 border-2 border-green-500 p-4 rounded-xl text-right';
            }
        } else {
            feedbackArea.innerHTML = '<div class="text-red-600 font-bold text-xl">âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© - Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ' + currentTest.questions[currentQuestionIndex].options[correctIndex] + '</div>';
            feedbackArea.className = 'text-center p-4 rounded-xl mb-6 feedback-wrong';
            if (options[selectedIndex]) {
                options[selectedIndex].className = 'option-btn bg-red-100 border-2 border-red-500 p-4 rounded-xl text-right';
            }
            if (options[correctIndex]) {
                options[correctIndex].className = 'option-btn bg-green-100 border-2 border-green-500 p-4 rounded-xl text-right';
            }
        }
        
        feedbackArea.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showFeedback');
    }
}

function showTimeUpFeedback(correctIndex) {
    try {
        const feedbackArea = document.getElementById('feedbackArea');
        const options = document.querySelectorAll('.option-btn');
        
        if (!feedbackArea) return;
        
        feedbackArea.innerHTML = '<div class="text-orange-600 font-bold text-xl">â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ' + currentTest.questions[currentQuestionIndex].options[correctIndex] + '</div>';
        feedbackArea.className = 'text-center p-4 rounded-xl mb-6 feedback-time-up';
        
        if (options[correctIndex]) {
            options[correctIndex].className = 'option-btn bg-green-100 border-2 border-green-500 p-4 rounded-xl text-right';
        }
        
        feedbackArea.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTimeUpFeedback');
    }
}

function disableOptions() {
    try {
        const options = document.querySelectorAll('.option-btn');
        options.forEach(option => {
            option.disabled = true;
            option.onclick = null;
            option.style.cursor = 'not-allowed';
        });
    } catch (error) {
        ErrorHandler.logError(error, 'disableOptions');
    }
}

// Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
function endTest() {
    try {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¤Ù‚Øª
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        const percentage = Math.round((studentData.score / currentTest.questions.length) * 100);
        let grade = '';
        
        if (percentage >= 90) grade = 'Ù…Ù…ØªØ§Ø²';
        else if (percentage >= 80) grade = 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
        else if (percentage >= 70) grade = 'Ø¬ÙŠØ¯';
        else if (percentage >= 60) grade = 'Ù…Ù‚Ø¨ÙˆÙ„';
        else grade = 'Ø¶Ø¹ÙŠÙ';
        
        // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        const result = {
            id: Date.now(),
            name: studentData.name,
            grade: studentData.grade,
            class: studentData.class,
            school: studentData.school,
            teacher: studentData.teacher,
            test: currentTest.name,
            subject: currentTest.subject,
            score: studentData.score,
            total: currentTest.questions.length,
            percentage: percentage,
            gradeLevel: grade,
            date: new Date().toLocaleDateString('ar-SA'),
            answers: studentData.answers,
            timestamp: Date.now()
        };
        
        const saveSuccess = saveResult(result);
        
        if (!saveSuccess) {
            alert('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.');
        }
        
        document.getElementById('testScreen').classList.add('hidden');
        document.getElementById('resultsScreen').classList.remove('hidden');
        
        const finalScoreElement = document.getElementById('finalScore');
        const percentageElement = document.getElementById('percentage');
        const gradeElement = document.getElementById('grade');
        
        if (finalScoreElement) finalScoreElement.textContent = studentData.score + ' Ù…Ù† ' + currentTest.questions.length;
        if (percentageElement) percentageElement.textContent = percentage + '%';
        if (gradeElement) gradeElement.textContent = grade;
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ù„Ø³Ø©
        SystemRecovery.clearSession();
    } catch (error) {
        ErrorHandler.logError(error, 'endTest');
    }
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬
function shareWhatsApp() {
    try {
        const percentage = Math.round((studentData.score / currentTest.questions.length) * 100);
        let grade = '';
        
        if (percentage >= 90) grade = 'Ù…Ù…ØªØ§Ø²';
        else if (percentage >= 80) grade = 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
        else if (percentage >= 70) grade = 'Ø¬ÙŠØ¯';
        else if (percentage >= 60) grade = 'Ù…Ù‚Ø¨ÙˆÙ„';
        else grade = 'Ø¶Ø¹ÙŠÙ';
        
        const message = `ğŸ‰ Ø£ØªÙ…Ù…Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${currentTest.name}\nğŸ‰ Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentData.name}\n\nğŸ‰ ÙÙŠ Ù…Ø§Ø¯Ø©: ${currentTest.subject}\nğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${studentData.score} Ù…Ù† ${currentTest.questions.length}\nğŸ“ˆ Ø§Ù„Ù†Ø³Ø¨Ø©: ${percentage}%\nğŸ† Ø§Ù„ØªÙ‚Ø¯ÙŠØ±: ${grade}\nğŸ’ Ø§Ù„ØµÙ: ${studentData.grade}\n\n#${studentData.school}`;
        
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
    } catch (error) {
        ErrorHandler.logError(error, 'shareWhatsApp');
    }
}

function retakeTest() {
    try {
        studentData.score = 0;
        studentData.answers = [];
        currentQuestionIndex = 0;
        
        document.getElementById('resultsScreen').classList.add('hidden');
        document.getElementById('testScreen').classList.remove('hidden');
        
        showQuestion();
    } catch (error) {
        ErrorHandler.logError(error, 'retakeTest');
    }
}

function goBackToSchoolSelection() {
    try {
        document.getElementById('testScreen').classList.add('hidden');
        document.getElementById('resultsScreen').classList.add('hidden');
        document.getElementById('studentAccessScreen').classList.remove('hidden');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const schoolSearch = document.getElementById('schoolSearch');
        
        if (selectedSchoolInfo) selectedSchoolInfo.classList.add('hidden');
        if (schoolSearch) schoolSearch.value = '';
    } catch (error) {
        ErrorHandler.logError(error, 'goBackToSchoolSelection');
    }
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
function confirmExitTest() {
    try {
        document.getElementById('exitTestModal').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'confirmExitTest');
    }
}

function cancelExitTest() {
    try {
        document.getElementById('exitTestModal').classList.add('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'cancelExitTest');
    }
}

function exitTest() {
    try {
        // ØªÙ†Ø¸ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        ResourceManager.cleanup();
        SystemRecovery.clearSession();
        
        currentTest = null;
        currentQuestionIndex = 0;
        studentData = { name: '', grade: '', class: '', score: 0, answers: [] };
        
        document.getElementById('exitTestModal').classList.add('hidden');
        document.getElementById('testScreen').classList.add('hidden');
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateWelcomeStatistics();
    } catch (error) {
        ErrorHandler.logError(error, 'exitTest');
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Canvas Ø§Ù„Ù…Ø­Ø³Ù†Ø© ==========

async function generateCertificateImage(format) {
    try {
        showLoadingMessage('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©...');
        
        const canvas = document.getElementById('certificateCanvas');
        if (!canvas) {
            throw new Error('Canvas element not found');
        }
        
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            throw new Error('Canvas context not available');
        }
        
        // Ù…Ø³Ø­ Canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ========== Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ==========
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#f8fafc');
        gradient.addColorStop(0.5, '#f0f4ff');
        gradient.addColorStop(1, '#fdf2ff');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ========== Ø§Ù„Ø²Ø®Ø§Ø±Ù Ø§Ù„Ø®Ù„ÙÙŠØ© ==========
        ctx.fillStyle = 'rgba(139, 92, 246, 0.03)';
        ctx.font = 'bold 120px Arial';
        ctx.textAlign = 'center';
        
        // Ø²Ø®Ø§Ø±Ù Ù…ÙˆØ²Ø¹Ø© Ø¨Ø´ÙƒÙ„ Ù…ØªØ³Ø§Ùˆ
        ctx.fillText('ğŸ“', canvas.width/2, 350);
        ctx.fillText('â­', canvas.width/4, 450);
        ctx.fillText('ğŸ“š', canvas.width * 3/4, 400);
        ctx.fillText('ğŸ†', canvas.width/3, 1400);
        ctx.fillText('ğŸ’«', canvas.width * 2/3, 1500);
        ctx.fillText('ğŸ¯', canvas.width/2, 2800);
        ctx.fillText('âœ¨', canvas.width/5, 2700);
        ctx.fillText('ğŸŒŸ', canvas.width * 4/5, 2750);
        
        // ========== Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ==========
        const borderGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        borderGradient.addColorStop(0, '#3b82f6');
        borderGradient.addColorStop(0.25, '#8b5cf6');
        borderGradient.addColorStop(0.5, '#ec4899');
        borderGradient.addColorStop(0.75, '#f59e0b');
        borderGradient.addColorStop(1, '#10b981');
        
        ctx.strokeStyle = borderGradient;
        ctx.lineWidth = 25;
        ctx.strokeRect(50, 50, canvas.width - 100, canvas.height - 100);
        
        // Ø¥Ø·Ø§Ø± Ø¯Ø§Ø®Ù„ÙŠ Ø°Ù‡Ø¨ÙŠ
        ctx.strokeStyle = '#f59e0b';
        ctx.lineWidth = 8;
        ctx.strokeRect(100, 100, canvas.width - 200, canvas.height - 200);
        
        // ========== Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ==========
        const titleGradient = ctx.createLinearGradient(canvas.width/2 - 300, 200, canvas.width/2 + 300, 200);
        titleGradient.addColorStop(0, '#f59e0b');
        titleGradient.addColorStop(0.5, '#fbbf24');
        titleGradient.addColorStop(1, '#f59e0b');
        
        ctx.fillStyle = titleGradient;
        ctx.font = 'bold 140px "Cairo"';
        ctx.textAlign = 'center';
        ctx.fillText('Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø²', canvas.width/2, 280);
        
        // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
        ctx.fillStyle = '#6b7280';
        ctx.font = 'italic 45px "Cairo"';
        ctx.fillText('Certificate of Achievement', canvas.width/2, 380);
        
        // Ø®Ø· Ø²Ø®Ø±ÙÙŠ ØªØ­Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 - 250, 410);
        ctx.lineTo(canvas.width/2 + 250, 410);
        ctx.stroke();
        
        // ========== Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ==========
        ctx.fillStyle = '#7c3aed';
        ctx.font = 'bold 75px "Cairo"';
        ctx.fillText(studentData.school, canvas.width/2, 530);
        
        // ========== Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆÙ„: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ==========
        const section1Y = 700;
        
        // Ø§Ù„Ù†Øµ Ø§Ù„ØªÙ…Ù‡ÙŠØ¯ÙŠ
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('ØªØ´Ù‡Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø¨Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©', canvas.width/2, section1Y);
        
        // Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
        const nameGradient = ctx.createLinearGradient(canvas.width/2 - 400, section1Y + 100, canvas.width/2 + 400, section1Y + 220);
        nameGradient.addColorStop(0, '#7c3aed');
        nameGradient.addColorStop(0.5, '#3b82f6');
        nameGradient.addColorStop(1, '#7c3aed');
        
        ctx.fillStyle = nameGradient;
        ctx.font = 'bold 120px "Cairo"';
        ctx.fillText(studentData.name, canvas.width/2, section1Y + 180);
        
        // Ø®Ø· ØªØ­Øª Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
        ctx.strokeStyle = '#c4b5fd';
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 - 350, section1Y + 210);
        ctx.lineTo(canvas.width/2 + 350, section1Y + 210);
        ctx.stroke();
        
        // ========== Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ==========
        const section2Y = 1050;
        
        // Ø§Ù„ØµÙ ÙˆØ§Ù„ÙØµÙ„
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText(`Ù…Ù† Ø§Ù„ØµÙ ${studentData.grade} ÙˆØ§Ù„ÙØµÙ„ ${studentData.class}`, canvas.width/2, section2Y);
        
        // Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ
        ctx.fillText('Ù‚Ø¯ Ø£ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', canvas.width/2, section2Y + 100);
        
        // Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        ctx.fillStyle = '#3b82f6';
        ctx.font = 'bold 70px "Cairo"';
        ctx.fillText(currentTest.name, canvas.width/2, section2Y + 200);
        
        // Ø§Ù„Ù…Ø§Ø¯Ø©
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('ÙÙŠ Ù…Ø§Ø¯Ø©', canvas.width/2, section2Y + 300);
        
        ctx.fillStyle = '#10b981';
        ctx.font = 'bold 60px "Cairo"';
        ctx.fillText(currentTest.subject, canvas.width/2, section2Y + 380);
        
        // ========== Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ==========
        const resultsBox = {
            x: canvas.width/2 - 450,
            y: 1550,
            width: 900,
            height: 280
        };
        
        // Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø±Ø¨Ø¹
        ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
        ctx.strokeStyle = '#d1d5db';
        ctx.lineWidth = 3;
        
        // Ø¸Ù„ Ù„Ù„Ù…Ø±Ø¨Ø¹
        ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
        ctx.shadowBlur = 20;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 10;
        ctx.fillRect(resultsBox.x, resultsBox.y, resultsBox.width, resultsBox.height);
        ctx.shadowColor = 'transparent';
        ctx.strokeRect(resultsBox.x, resultsBox.y, resultsBox.width, resultsBox.height);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±
        const percentage = Math.round((studentData.score / currentTest.questions.length) * 100);
        const grade = calculateGrade(percentage);
        
        // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¥Ù„Ù‰ 3 Ø£Ø¬Ø²Ø§Ø¡
        const sectionWidth = resultsBox.width / 3;
        
        // Ø§Ù„Ø¯Ø±Ø¬Ø©
        ctx.fillStyle = '#3b82f6';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('Ø§Ù„Ø¯Ø±Ø¬Ø©', resultsBox.x + sectionWidth/2, resultsBox.y + 90);
        ctx.font = 'bold 75px "Cairo"';
        ctx.fillText(`${studentData.score}/${currentTest.questions.length}`, resultsBox.x + sectionWidth/2, resultsBox.y + 180);
        
        // Ø§Ù„Ù†Ø³Ø¨Ø©
        ctx.fillStyle = '#10b981';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('Ø§Ù„Ù†Ø³Ø¨Ø©', resultsBox.x + sectionWidth + sectionWidth/2, resultsBox.y + 90);
        ctx.font = 'bold 75px "Cairo"';
        ctx.fillText(`${percentage}%`, resultsBox.x + sectionWidth + sectionWidth/2, resultsBox.y + 180);
        
        // Ø§Ù„ØªÙ‚Ø¯ÙŠØ±
        ctx.fillStyle = '#8b5cf6';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('Ø§Ù„ØªÙ‚Ø¯ÙŠØ±', resultsBox.x + 2 * sectionWidth + sectionWidth/2, resultsBox.y + 90);
        ctx.font = 'bold 65px "Cairo"';
        ctx.fillText(grade, resultsBox.x + 2 * sectionWidth + sectionWidth/2, resultsBox.y + 180);
        
        // Ø®Ø·ÙˆØ· ÙØ§ØµÙ„Ø©
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(resultsBox.x + sectionWidth, resultsBox.y + 30);
        ctx.lineTo(resultsBox.x + sectionWidth, resultsBox.y + resultsBox.height - 30);
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(resultsBox.x + 2 * sectionWidth, resultsBox.y + 30);
        ctx.lineTo(resultsBox.x + 2 * sectionWidth, resultsBox.y + resultsBox.height - 30);
        ctx.stroke();
        
        // ========== Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø±Ø³Ø§Ù„Ø© ØªÙ‡Ù†Ø¦Ø© Ù…ÙˆØ³Ø¹Ø© ==========
        const congratulationY = 1950;
        
        ctx.fillStyle = '#7c3aed';
        ctx.font = 'bold 65px "Cairo"';
        ctx.fillText('Ù…Ø¨Ø±ÙˆÙƒ Ø¹Ù„Ù‰ Ø¥Ù†Ø¬Ø§Ø²Ùƒ!', canvas.width/2, congratulationY);
        
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('Ù†Ø­Ù† Ù†ÙØªØ®Ø± Ø¨Ø¥Ù†Ø¬Ø§Ø²Ùƒ Ø§Ù„Ù…ØªÙ…ÙŠØ² ÙˆÙ†Ø³Ø£Ù„ Ø§Ù„Ù„Ù‡ Ù„Ùƒ Ø¯ÙˆØ§Ù… Ø§Ù„ØªÙˆÙÙŠÙ‚ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­', canvas.width/2, congratulationY + 90);
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '42px "Cairo"';
        ctx.fillText('Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹ Ø²Ø§Ù‡Ø±Ø§Ù‹ Ù…Ù„ÙŠØ¦Ø§Ù‹ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª ÙˆØ§Ù„ØªÙÙˆÙ‚', canvas.width/2, congratulationY + 180);
        
        // ========== Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø³: Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª ==========
        const signaturesY = 2300;
        
        // Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†)
        ctx.textAlign = 'right';
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©', 700, signaturesY);
        ctx.fillStyle = '#1f2937';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('Ø£. Ø®Ø§Ù„Ø¯ Ø§Ù„Ø­Ù…Ø±ÙŠÙ†', 700, signaturesY + 90);
        
        // Ø®Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
        ctx.strokeStyle = '#9ca3af';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(500, signaturesY + 130);
        ctx.lineTo(800, signaturesY + 130);
        ctx.stroke();
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '38px "Cairo"';
        ctx.fillText('Ø§Ù„ØªÙˆÙ‚ÙŠØ¹', 650, signaturesY + 180);
        
        // Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø© (Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±)
        ctx.textAlign = 'left';
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø©', canvas.width - 700, signaturesY);
        ctx.fillStyle = '#1f2937';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText(studentData.teacher, canvas.width - 700, signaturesY + 90);
        
        // Ø®Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
        ctx.beginPath();
        ctx.moveTo(canvas.width - 800, signaturesY + 130);
        ctx.lineTo(canvas.width - 500, signaturesY + 130);
        ctx.stroke();
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '38px "Cairo"';
        ctx.fillText('Ø§Ù„ØªÙˆÙ‚ÙŠØ¹', canvas.width - 650, signaturesY + 180);
        
        // ========== Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø³Ø§Ø¯Ø³: Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ==========
        const infoY = 2650;
        
        ctx.textAlign = 'center';
        ctx.fillStyle = '#6b7280';
        ctx.font = '38px "Cairo"';
        const date = new Date().toLocaleDateString('ar-SA');
        ctx.fillText(`ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${date}`, canvas.width/2, infoY);
        ctx.fillText(`Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: CERT-${Date.now()}`, canvas.width/2, infoY + 70);
        
        // ========== Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø³Ø§Ø¨Ø¹: Ø²Ø®Ø±ÙØ© Ø®ØªØ§Ù…ÙŠØ© ==========
        const decorationY = 2850;
        
        // Ø®Ø· Ø²Ø®Ø±ÙÙŠ
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 - 300, decorationY);
        ctx.lineTo(canvas.width/2 + 300, decorationY);
        ctx.stroke();
        
        // Ù†Ù‚Ø§Ø· Ø²Ø®Ø±ÙÙŠØ©
        ctx.fillStyle = '#3b82f6';
        for (let i = -4; i <= 4; i++) {
            const x = canvas.width/2 + (i * 75);
            ctx.beginPath();
            ctx.arc(x, decorationY, 12, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Ø±Ø³Ø§Ù„Ø© Ø´ÙƒØ±
        ctx.fillStyle = '#4b5563';
        ctx.font = '42px "Cairo"';
        ctx.fillText('Ø´ÙƒØ±Ø§Ù‹ Ù„Ø¬Ù‡ÙˆØ¯ÙƒÙ… Ø§Ù„Ù…Ø¨Ø°ÙˆÙ„Ø©', canvas.width/2, decorationY + 90);

        // ========== Ø§Ù„Ø²Ø®Ø±ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ==========
        ctx.fillStyle = 'rgba(139, 92, 246, 0.1)';
        ctx.font = 'bold 130px Arial';
        ctx.fillText('ğŸ‰', canvas.width/2, canvas.height - 150);

        // ØªØ­ÙˆÙŠÙ„ Canvas Ø¥Ù„Ù‰ ØµÙˆØ±Ø©
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const imageData = canvas.toDataURL(`image/${format}`, 1.0);
        downloadImage(imageData, format);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        updateCertificatePreview(imageData);
        
        hideLoadingMessage();
        showSuccessMessage('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', `ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙƒØµÙˆØ±Ø© ${format.toUpperCase()}`);
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:', error);
        hideLoadingMessage();
        showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', 'ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙƒØµÙˆØ±Ø©');
    }
}

// Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±
function calculateGrade(percentage) {
    if (percentage >= 90) return 'Ù…Ù…ØªØ§Ø²';
    else if (percentage >= 80) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
    else if (percentage >= 70) return 'Ø¬ÙŠØ¯';
    else if (percentage >= 60) return 'Ù…Ù‚Ø¨ÙˆÙ„';
    else return 'Ø¶Ø¹ÙŠÙ';
}

// Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
function downloadImage(imageData, format) {
    try {
        const downloadLink = document.createElement('a');
        const fileName = `Ø´Ù‡Ø§Ø¯Ø©_${studentData.name}_${currentTest.name}_${new Date().toLocaleDateString('ar-SA')}.${format}`;
        
        downloadLink.href = imageData;
        downloadLink.download = fileName;
        
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    } catch (error) {
        ErrorHandler.logError(error, 'downloadImage');
    }
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
function updateCertificatePreview(imageData) {
    try {
        const preview = document.getElementById('certificatePreview');
        if (preview) {
            preview.innerHTML = `
                <div class="text-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©</h3>
                    <p class="text-gray-600">Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© - ØªØµÙ…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ</p>
                </div>
                <img src="${imageData}" alt="Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø²" class="w-full h-auto rounded-lg shadow-2xl border-4 border-gold-200 max-h-96 object-contain mx-auto">
                <div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                    <p class="text-green-700 text-sm"><strong>âœ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­:</strong> Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© Ø¨Ø¯Ù‚Ø© 2480Ã—3508 Ø¨ÙƒØ³Ù„</p>
                </div>
            `;
        }
    } catch (error) {
        ErrorHandler.logError(error, 'updateCertificatePreview');
    }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function showLoadingMessage(message) {
    try {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingOverlay';
        loadingDiv.className = 'loading-overlay';
        loadingDiv.innerHTML = `
            <div class="bg-white rounded-2xl p-8 text-center shadow-2xl">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-gray-800 font-semibold text-xl">${message}</p>
            </div>
        `;
        document.body.appendChild(loadingDiv);
    } catch (error) {
        ErrorHandler.logError(error, 'showLoadingMessage');
    }
}

function hideLoadingMessage() {
    try {
        const loadingDiv = document.getElementById('loadingOverlay');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'hideLoadingMessage');
    }
}

function showSuccessMessage(title, message) {
    try {
        const messageId = 'successMessage-' + Date.now();
        const messageHTML = `
            <div id="${messageId}" class="fixed top-4 left-4 right-4 bg-green-500 text-white p-4 rounded-xl shadow-lg z-50 flex items-center gap-3">
                <span class="text-2xl">âœ…</span>
                <div class="flex-1">
                    <div class="font-bold">${title}</div>
                    <div class="text-sm">${message}</div>
                </div>
                <button onclick="document.getElementById('${messageId}').remove()" class="text-white hover:text-gray-200">
                    âœ•
                </button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', messageHTML);
        
        setTimeout(() => {
            const element = document.getElementById(messageId);
            if (element) element.remove();
        }, 5000);
    } catch (error) {
        ErrorHandler.logError(error, 'showSuccessMessage');
    }
}

function showErrorMessage(title, message) {
    try {
        const messageId = 'errorMessage-' + Date.now();
        const messageHTML = `
            <div id="${messageId}" class="fixed top-4 left-4 right-4 bg-red-500 text-white p-4 rounded-xl shadow-lg z-50 flex items-center gap-3">
                <span class="text-2xl">âŒ</span>
                <div class="flex-1">
                    <div class="font-bold">${title}</div>
                    <div class="text-sm">${message}</div>
                </div>
                <button onclick="document.getElementById('${messageId}').remove()" class="text-white hover:text-gray-200">
                    âœ•
                </button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', messageHTML);
        
        setTimeout(() => {
            const element = document.getElementById(messageId);
            if (element) element.remove();
        }, 5000);
    } catch (error) {
        ErrorHandler.logError(error, 'showErrorMessage');
    }
}

// ========== Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø­Ø³Ù†Ø© ==========

function showTeacherDashboard() {
    try {
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('teacherDashboard').classList.remove('hidden');
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…
        const teacherWelcome = document.getElementById('teacherWelcome');
        if (teacherWelcome) {
            teacherWelcome.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}`;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        updateTeacherSchoolData();
        
        // ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        loadDashboardData();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
        loadTeacherTests();
        
        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„ÙÙ„ØªØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        loadTestSelectForQuestions();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        loadResultsForTeacher();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        loadTeacherSettings();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
        checkAdminPermissions();
        
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherDashboard');
    }
}

function updateTeacherSchoolData() {
    try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        let teacherSchool = null;
        
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === currentUser.name) {
                teacherSchool = demoData.schools[schoolId];
                currentManagingTestSchoolId = schoolId;
                break;
            }
        }
        
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ø¯Ø±Ø³Ø© Ù„Ù„Ù…Ø¹Ù„Ù…ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§
        if (!teacherSchool) {
            const newSchoolId = 'school_' + Date.now();
            teacherSchool = {
                id: newSchoolId,
                name: currentUser.school,
                teacher: currentUser.name,
                tests: []
            };
            
            demoData.schools[newSchoolId] = teacherSchool;
            currentManagingTestSchoolId = newSchoolId;
            
            // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
            StorageManager.setItem('demoSchoolsData', demoData.schools);
        }
        
        console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ù„Ù…Ø¹Ù„Ù…:', currentUser.name);
    } catch (error) {
        ErrorHandler.logError(error, 'updateTeacherSchoolData');
    }
}

function showTab(tabName) {
    try {
        const tabs = ['dashboard', 'tests', 'questions', 'results', 'settings'];
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        tabs.forEach(tab => {
            const tabBtn = document.getElementById(tab + 'Tab');
            const content = document.getElementById(tab + 'Content');
            
            if (tabBtn && content) {
                if (tab === tabName) {
                    tabBtn.classList.add('active', 'bg-white', 'text-blue-600');
                    tabBtn.classList.remove('bg-transparent', 'text-gray-600');
                    content.classList.remove('hidden');
                } else {
                    tabBtn.classList.remove('active', 'bg-white', 'text-blue-600');
                    tabBtn.classList.add('bg-transparent', 'text-gray-600');
                    content.classList.add('hidden');
                }
            }
        });
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒÙ„ ØªØ¨ÙˆÙŠØ¨
        if (tabName === 'dashboard') {
            loadDashboardData();
        } else if (tabName === 'questions') {
            loadTestSelectForQuestions();
        } else if (tabName === 'results') {
            loadResultsForTeacher();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'showTab');
    }
}

function loadDashboardData() {
    try {
        const results = getResultsSync(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const totalTests = currentManagingTestSchoolId ? 
            demoData.schools[currentManagingTestSchoolId]?.tests.length || 0 : 0;
        const totalStudents = teacherResults.length;
        const totalScore = teacherResults.reduce((sum, result) => sum + result.percentage, 0);
        const averageScore = totalStudents > 0 ? Math.round(totalScore / totalStudents) : 0;
        const passRate = totalStudents > 0 ? 
            Math.round((teacherResults.filter(r => r.percentage >= 60).length / totalStudents) * 100) : 0;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ±
        const elements = {
            totalTests: document.getElementById('totalTests'),
            totalStudents: document.getElementById('totalStudents'),
            averageScore: document.getElementById('averageScore'),
            passRate: document.getElementById('passRate'),
            totalAttempts: document.getElementById('totalAttempts'),
            highestScore: document.getElementById('highestScore'),
            lowestScore: document.getElementById('lowestScore')
        };
        
        if (elements.totalTests) elements.totalTests.textContent = totalTests;
        if (elements.totalStudents) elements.totalStudents.textContent = totalStudents;
        if (elements.averageScore) elements.averageScore.textContent = averageScore + '%';
        if (elements.passRate) elements.passRate.textContent = passRate + '%';
        if (elements.totalAttempts) elements.totalAttempts.textContent = totalStudents;
        
        if (totalStudents > 0) {
            const highest = Math.max(...teacherResults.map(r => r.percentage));
            const lowest = Math.min(...teacherResults.map(r => r.percentage));
            
            if (elements.highestScore) elements.highestScore.textContent = highest + '%';
            if (elements.lowestScore) elements.lowestScore.textContent = lowest + '%';
        }
    } catch (error) {
        ErrorHandler.logError(error, 'loadDashboardData');
    }
}

function loadTeacherTests() {
    try {
        const testsGrid = document.getElementById('testsGrid');
        if (!testsGrid) return;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests) {
            testsGrid.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-12">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯</div>';
            return;
        }
        
        if (school.tests.length === 0) {
            testsGrid.innerHTML = `
                <div class="col-span-3 text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">ğŸ“</div>
                    <p class="text-lg mb-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯</p>
                    <button onclick="showCreateTestModal()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-600 transition-all">
                        â• Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ Ø§Ø®ØªØ¨Ø§Ø±
                    </button>
                </div>
            `;
            return;
        }
        
        let testsHTML = '';
        
        school.tests.forEach((test, index) => {
            testsHTML += `
                <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 hover:shadow-lg transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-xl text-gray-800">${test.name}</h4>
                        <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm">${test.subject}</span>
                    </div>
                    
                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ø§Ù„Ù…Ø§Ø¯Ø©:</span>
                            <span class="font-semibold">${test.subject}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ø§Ù„ØµÙ:</span>
                            <span class="font-semibold">${test.grade}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</span>
                            <span class="font-semibold">${test.questions.length}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ø§Ù„ÙˆÙ‚Øª:</span>
                            <span class="font-semibold">${test.timerPerQuestion || 30} Ø«Ø§Ù†ÙŠØ©</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="editTest(${index})" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold transition-all">
                            ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button onclick="deleteTest(${index})" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg text-sm font-semibold transition-all">
                            Ø­Ø°Ù
                        </button>
                    </div>
                </div>
            `;
        });
        
        testsGrid.innerHTML = testsHTML;
    } catch (error) {
        ErrorHandler.logError(error, 'loadTeacherTests');
    }
}

// ========== Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ==========

function showCreateTestModal() {
    try {
        currentEditingTestId = null;
        
        const modal = document.getElementById('testModal');
        const modalTitle = document.getElementById('testModalTitle');
        const form = document.getElementById('testModalForm');
        const errorDiv = document.getElementById('testModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Test modal elements not found');
        }
        
        modalTitle.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯';
        form.reset();
        errorDiv.classList.add('hidden');
        
        // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙÙˆÙ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø¹Ù„Ù…
        updateGradeOptions(currentUser.stage, 'modalTestGrade');
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showCreateTestModal');
    }
}

function editTest(testIndex) {
    try {
        currentEditingTestId = testIndex;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[testIndex]) {
            alert('Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const test = school.tests[testIndex];
        const modal = document.getElementById('testModal');
        const modalTitle = document.getElementById('testModalTitle');
        const form = document.getElementById('testModalForm');
        const errorDiv = document.getElementById('testModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Test modal elements not found');
        }
        
        modalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
        errorDiv.classList.add('hidden');
        
        // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        document.getElementById('modalTestName').value = test.name || '';
        document.getElementById('modalTestSubject').value = test.subject || '';
        document.getElementById('modalTestTimer').value = test.timerPerQuestion || 30;
        document.getElementById('modalTestDescription').value = test.description || '';
        
        // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙÙˆÙ
        updateGradeOptions(currentUser.stage, 'modalTestGrade');
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const gradeSelect = document.getElementById('modalTestGrade');
        if (gradeSelect && test.grade) {
            gradeSelect.value = test.grade;
        }
        
        // ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©
        const difficultySelect = document.getElementById('modalTestDifficulty');
        if (difficultySelect && test.difficulty) {
            difficultySelect.value = test.difficulty;
        }
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'editTest');
    }
}

function closeTestModal() {
    try {
        const modal = document.getElementById('testModal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        currentEditingTestId = null;
    } catch (error) {
        ErrorHandler.logError(error, 'closeTestModal');
    }
}

// Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
async function handleTestFormSubmit(event) {
    try {
        event.preventDefault();
        
        const name = DataValidator.sanitizeInput(document.getElementById('modalTestName').value);
        const subject = DataValidator.sanitizeInput(document.getElementById('modalTestSubject').value);
        const grade = document.getElementById('modalTestGrade').value;
        const timerPerQuestion = parseInt(document.getElementById('modalTestTimer').value) || 30;
        const description = DataValidator.sanitizeInput(document.getElementById('modalTestDescription').value);
        const difficulty = document.getElementById('modalTestDifficulty').value;
        
        const errorDiv = document.getElementById('testModalError');
        if (!errorDiv) {
            throw new Error('Error div not found');
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!name || !subject || !grade) {
            errorDiv.textContent = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        if (timerPerQuestion < 10 || timerPerQuestion > 300) {
            errorDiv.textContent = 'ÙˆÙ‚Øª Ø§Ù„Ø³Ø¤Ø§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 10 Ùˆ 300 Ø«Ø§Ù†ÙŠØ©';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school) {
            errorDiv.textContent = 'Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const newTest = {
            name: name,
            subject: subject,
            grade: grade,
            timerPerQuestion: timerPerQuestion,
            description: description,
            difficulty: difficulty,
            questions: []
        };
        
        if (currentEditingTestId === null) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
            school.tests.push(newTest);
        } else {
            // ØªØ¹Ø¯ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯
            school.tests[currentEditingTestId] = {
                ...school.tests[currentEditingTestId],
                ...newTest
            };
        }
        
        try {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
            await RemoteAPI.updateSchool(currentManagingTestSchoolId, school);
            
            // Ø«Ù… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            
        } catch (apiError) {
            // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ØŒ Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
            console.warn('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ:', apiError);
            const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
            if (!success) {
                errorDiv.textContent = 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
                errorDiv.classList.remove('hidden');
                return false;
            }
        }
        
        closeTestModal();
        loadTeacherTests();
        
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'handleTestFormSubmit');
        return false;
    }
}

function deleteTest(testIndex) {
    try {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) {
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (school && school.tests[testIndex]) {
            school.tests.splice(testIndex, 1);
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
            loadTeacherTests();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'deleteTest');
    }
}

// ========== Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø£Ø³Ø¦Ù„Ø© ==========

function loadTestSelectForQuestions() {
    try {
        const testSelect = document.getElementById('questionTestSelect');
        if (!testSelect) return;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school) {
            testSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</option>';
            return;
        }
        
        testSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</option>';
        
        school.tests.forEach((test, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
            testSelect.appendChild(option);
        });
    } catch (error) {
        ErrorHandler.logError(error, 'loadTestSelectForQuestions');
    }
}

function loadTestQuestions() {
    try {
        console.log('ğŸ¯ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...');
        
        const testIndex = document.getElementById('questionTestSelect').value;
        const questionsContainer = document.getElementById('questionsContainer');
        
        if (!questionsContainer) {
            console.error('âŒ questionsContainer ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        if (testIndex === '') {
            questionsContainer.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">â“</div>
                    <p>Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p>
                </div>
            `;
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school) {
            console.error('âŒ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            questionsContainer.innerHTML = '<div class="text-center text-red-500 py-12">Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</div>';
            return;
        }
        
        if (!school.tests || !school.tests[testIndex]) {
            console.error('âŒ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            questionsContainer.innerHTML = '<div class="text-center text-red-500 py-12">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>';
            return;
        }
        
        const test = school.tests[testIndex];
        currentManagingTest = testIndex;
        
        console.log('ğŸ“ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', test.name);
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        if (!test.questions || !Array.isArray(test.questions)) {
            console.warn('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©ØŒ ÙŠØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ Ù…Ù† Ø¬Ø¯ÙŠØ¯');
            test.questions = [];
        }
        
        if (test.questions.length === 0) {
            questionsContainer.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">ğŸ“</div>
                    <p class="text-lg mb-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</p>
                    <button onclick="showAddQuestionModal()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-green-600 hover:to-blue-600 transition-all">
                        â• Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø³Ø¤Ø§Ù„
                    </button>
                </div>
            `;
            return;
        }
        
        let questionsHTML = `
            <div class="mb-6">
                <h4 class="font-bold text-xl text-gray-800 mb-2">Ø£Ø³Ø¦Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±: ${test.name}</h4>
                <p class="text-gray-600">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${test.questions.length}</p>
            </div>
            
            <div id="questionsList" class="space-y-4">
        `;
        
        test.questions.forEach((question, index) => {
            if (!question) {
                console.warn(`âš ï¸ Ø³Ø¤Ø§Ù„ ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³ ${index} ØºÙŠØ± Ù…Ø¹Ø±ÙØŒ ÙŠØªÙ… ØªØ®Ø·ÙŠÙ‡`);
                return;
            }
            
            const optionLabels = ['Ø£', 'Ø¨', 'Ø¬', 'Ø¯'];
            const correctAnswer = question.correct !== undefined ? question.correct : 0;
            const correctAnswerLabel = optionLabels[correctAnswer] || 'Ø£';
            
            questionsHTML += `
                <div class="question-item bg-white border-2 border-gray-200 rounded-2xl p-6 transition-all duration-300 hover:shadow-lg"
                     data-question-index="${index}">
                    
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="flex-1">
                                <h5 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                    <span class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">${index + 1}</span>
                                    Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}
                                </h5>
                            </div>
                        </div>
                        <span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-sm font-semibold">
                            âœ“ ${correctAnswerLabel}
                        </span>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-gray-700 text-lg bg-gray-50 p-4 rounded-xl border">${question.question || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù„Ø³Ø¤Ø§Ù„'}</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-3 mb-4">
                        ${(question.options || ['', '', '', '']).map((option, optIndex) => `
                            <div class="flex items-center gap-3 p-3 rounded-xl border-2 ${
                                optIndex === correctAnswer 
                                ? 'bg-green-50 border-green-300 text-green-700' 
                                : 'bg-gray-50 border-gray-200 text-gray-700'
                            } transition-all">
                                <span class="w-8 h-8 ${
                                    optIndex === correctAnswer 
                                    ? 'bg-green-500 text-white' 
                                    : 'bg-gray-300 text-gray-600'
                                } rounded-full flex items-center justify-center font-bold text-sm">
                                    ${optionLabels[optIndex]}
                                </span>
                                <span class="flex-1 ${optIndex === correctAnswer ? 'font-semibold' : ''}">${option || 'Ø®ÙŠØ§Ø± ÙØ§Ø±Øº'}</span>
                                ${optIndex === correctAnswer ? 
                                    '<span class="text-green-500 text-lg">âœ“</span>' : 
                                    ''
                                }
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex gap-2 pt-4 border-t border-gray-200">
                        <button onclick="editQuestion(${index})" 
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                            ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button onclick="deleteQuestion(${index})" 
                                class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                            Ø­Ø°Ù
                        </button>
                    </div>
                </div>
            `;
        });
        
        questionsHTML += `</div>`; // Ø¥ØºÙ„Ø§Ù‚ questionsList
        
        questionsContainer.innerHTML = questionsHTML;
        
        // Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù…Ø¹Ø·Ù„ ØªÙ…Ø§Ù…Ø§Ù‹
        console.log('ğŸš« Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù…Ø¹Ø·Ù„ - Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªÙ…Ù„');
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:', error);
        ErrorHandler.logError(error, 'loadTestQuestions');
        
        questionsContainer.innerHTML = `
            <div class="text-center text-red-500 py-12">
                <div class="text-6xl mb-4">âŒ</div>
                <p class="text-lg mb-4">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p>
                <button onclick="loadTestQuestions()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                    ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                </button>
            </div>
        `;
    }
}

// ========== Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù„Ø£Ø³Ø¦Ù„Ø© ==========
function initializeDragAndDrop() {
    try {
        console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª...');
        
        const questionsList = document.getElementById('questionsList');
        if (!questionsList) {
            console.log('â³ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯');
            return false;
        }

        // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
        const newQuestionsList = questionsList.cloneNode(true);
        questionsList.parentNode.replaceChild(newQuestionsList, questionsList);

        const questionItems = newQuestionsList.querySelectorAll('.question-item');
        if (questionItems.length === 0) {
            console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ø³Ø­Ø¨Ù‡Ø§');
            return false;
        }

        console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${questionItems.length} Ø³Ø¤Ø§Ù„ Ù„Ù„ØªÙ‡ÙŠØ¦Ø©`);
        
        let draggedItem = null;
        let dragStartIndex = null;

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„Ø³Ø­Ø¨
        questionItems.forEach(item => {
            item.setAttribute('draggable', 'true');
            item.classList.remove('dragging', 'drag-over');
        });

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥ÙÙ„Ø§Øª
        function createDropIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'drop-indicator';
            indicator.style.height = '3px';
            indicator.style.background = 'linear-gradient(90deg, #3b82f6, #8b5cf6)';
            indicator.style.margin = '8px 0';
            indicator.style.borderRadius = '3px';
            return indicator;
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø°ÙŠ ÙŠÙ„ÙŠ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø­Ø¨
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.question-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ø­Ø¨ - Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„Ø§Ù†ØªØ´Ø§Ø±
        newQuestionsList.addEventListener('dragstart', function(e) {
            draggedItem = e.target.closest('.question-item');
            if (!draggedItem) return;
            
            e.stopPropagation();
            dragStartIndex = parseInt(draggedItem.dataset.questionIndex);
            draggedItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedItem.dataset.questionIndex);
            
            console.log('ğŸ“¦ Ø¨Ø¯Ø¡ Ø³Ø­Ø¨ Ø§Ù„Ø³Ø¤Ø§Ù„:', dragStartIndex);
        });

        newQuestionsList.addEventListener('dragend', function(e) {
            e.stopPropagation();
            if (!draggedItem) return;
            
            draggedItem.classList.remove('dragging');
            draggedItem.style.opacity = '1';
            draggedItem.style.transform = 'none';
            
            // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¥ÙÙ„Ø§Øª
            const indicators = newQuestionsList.querySelectorAll('.drop-indicator');
            indicators.forEach(indicator => indicator.remove());
            
            // Ø¥Ø²Ø§Ù„Ø© ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            const allItems = newQuestionsList.querySelectorAll('.question-item');
            allItems.forEach(item => {
                item.classList.remove('drag-over');
            });
            
            draggedItem = null;
            dragStartIndex = null;
            
            console.log('âœ… Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨');
        });

        newQuestionsList.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!draggedItem) return;
            
            const afterElement = getDragAfterElement(newQuestionsList, e.clientY);
            const draggable = newQuestionsList.querySelector('.dragging');
            
            if (!draggable) return;

            // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¥ÙÙ„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            const oldIndicators = newQuestionsList.querySelectorAll('.drop-indicator');
            oldIndicators.forEach(indicator => indicator.remove());

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥ÙÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
            if (afterElement == null) {
                const indicator = createDropIndicator();
                newQuestionsList.appendChild(indicator);
            } else {
                const indicator = createDropIndicator();
                newQuestionsList.insertBefore(indicator, afterElement);
            }
        });

        newQuestionsList.addEventListener('dragenter', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!draggedItem) return;
            
            const target = e.target.closest('.question-item');
            if (target && target !== draggedItem) {
                target.classList.add('drag-over');
            }
        });

        newQuestionsList.addEventListener('dragleave', function(e) {
            e.stopPropagation();
            if (!e.relatedTarget || !newQuestionsList.contains(e.relatedTarget)) {
                const allItems = newQuestionsList.querySelectorAll('.question-item');
                allItems.forEach(item => {
                    item.classList.remove('drag-over');
                });
            }
        });

        newQuestionsList.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!draggedItem) return;
            
            console.log('ğŸ¯ Ø¥ÙÙ„Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„');
            
            const afterElement = getDragAfterElement(newQuestionsList, e.clientY);
            const dragEndIndex = afterElement ? 
                parseInt(afterElement.dataset.questionIndex) : 
                newQuestionsList.children.length - 1;
            
            // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¥ÙÙ„Ø§Øª
            const indicators = newQuestionsList.querySelectorAll('.drop-indicator');
            indicators.forEach(indicator => indicator.remove());
            
            // Ø¥Ø²Ø§Ù„Ø© ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø³Ø­Ø¨
            const allItems = newQuestionsList.querySelectorAll('.question-item');
            allItems.forEach(item => {
                item.classList.remove('drag-over');
            });
            
            if (afterElement == null) {
                newQuestionsList.appendChild(draggedItem);
            } else {
                newQuestionsList.insertBefore(draggedItem, afterElement);
            }
            
            // ØªØ­Ø¯ÙŠØ« ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            updateQuestionsOrder(dragStartIndex, dragEndIndex);
            
            console.log('ğŸ”„ ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ù†', dragStartIndex, 'Ø¥Ù„Ù‰', dragEndIndex);
        });

        console.log('ğŸ‰ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
        return true;
        
    } catch (error) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª:', error);
        ErrorHandler.logError(error, 'initializeDragAndDrop');
        return false;
    }
}

// ========== Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø£Ø³Ø¦Ù„Ø© ==========
function showAddQuestionModal() {
    try {
        if (currentManagingTest === null) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        currentEditingQuestionIndex = null;
        
        const modal = document.getElementById('questionModal');
        const modalTitle = document.getElementById('questionModalTitle');
        const form = document.getElementById('questionModalForm');
        const errorDiv = document.getElementById('questionModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Question modal elements not found');
        }
        
        modalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯';
        form.reset();
        errorDiv.classList.add('hidden');
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showAddQuestionModal');
    }
}

function editQuestion(questionIndex) {
    try {
        if (currentManagingTest === null) {
            alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø­Ø¯Ø¯');
            return;
        }
        
        currentEditingQuestionIndex = questionIndex;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) {
            alert('Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const test = school.tests[currentManagingTest];
        const question = test.questions[questionIndex];
        
        if (!question) {
            alert('Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.getElementById('questionModal');
        const modalTitle = document.getElementById('questionModalTitle');
        const form = document.getElementById('questionModalForm');
        const errorDiv = document.getElementById('questionModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Question modal elements not found');
        }
        
        modalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„';
        errorDiv.classList.add('hidden');
        
        // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„
        document.getElementById('modalQuestionText').value = question.question || '';
        document.getElementById('modalOption1').value = question.options[0] || '';
        document.getElementById('modalOption2').value = question.options[1] || '';
        document.getElementById('modalOption3').value = question.options[2] || '';
        document.getElementById('modalOption4').value = question.options[3] || '';
        document.getElementById('modalCorrectAnswer').value = question.correct || '';
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'editQuestion');
    }
}

function closeQuestionModal() {
    try {
        const modal = document.getElementById('questionModal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        currentEditingQuestionIndex = null;
    } catch (error) {
        ErrorHandler.logError(error, 'closeQuestionModal');
    }
}

function handleQuestionFormSubmit(event) {
    try {
        event.preventDefault();
        
        if (currentManagingTest === null) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹');
            return false;
        }
        
        const questionText = DataValidator.sanitizeInput(document.getElementById('modalQuestionText').value);
        const option1 = DataValidator.sanitizeInput(document.getElementById('modalOption1').value);
        const option2 = DataValidator.sanitizeInput(document.getElementById('modalOption2').value);
        const option3 = DataValidator.sanitizeInput(document.getElementById('modalOption3').value);
        const option4 = DataValidator.sanitizeInput(document.getElementById('modalOption4').value);
        const correctAnswer = parseInt(document.getElementById('modalCorrectAnswer').value);
        
        const errorDiv = document.getElementById('questionModalError');
        if (!errorDiv) {
            throw new Error('Error div not found');
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!questionText || !option1 || !option2 || !option3 || !option4 || isNaN(correctAnswer)) {
            errorDiv.textContent = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        if (correctAnswer < 0 || correctAnswer > 3) {
            errorDiv.textContent = 'Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 3';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) {
            errorDiv.textContent = 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const test = school.tests[currentManagingTest];
        const newQuestion = {
            question: questionText,
            options: [option1, option2, option3, option4],
            correct: correctAnswer
        };
        
        if (currentEditingQuestionIndex === null) {
            // Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯
            test.questions.push(newQuestion);
        } else {
            // ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¤Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯
            test.questions[currentEditingQuestionIndex] = newQuestion;
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
        if (!success) {
            errorDiv.textContent = 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        closeQuestionModal();
        loadTestQuestions();
        
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'handleQuestionFormSubmit');
        return false;
    }
}

function deleteQuestion(questionIndex) {
    try {
        if (currentManagingTest === null) {
            alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø­Ø¯Ø¯');
            return;
        }
        
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')) {
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (school && school.tests[currentManagingTest] && school.tests[currentManagingTest].questions[questionIndex]) {
            school.tests[currentManagingTest].questions.splice(questionIndex, 1);
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            loadTestQuestions();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'deleteQuestion');
    }
}

// ========== Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª ==========
function updateQuestionsOrder(oldIndex, newIndex) {
    try {
        if (currentManagingTest === null) {
            console.warn('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø­Ø¯Ø¯ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ±ØªÙŠØ¨');
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) {
            console.warn('âŒ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const questions = school.tests[currentManagingTest].questions;
        
        if (oldIndex === newIndex) {
            console.log('â„¹ï¸ Ù„Ù… ÙŠØªØºÙŠØ± ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
            return;
        }
        
        // Ù†Ù‚Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ù† Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const [movedQuestion] = questions.splice(oldIndex, 1);
        questions.splice(newIndex, 0, movedQuestion);
        
        // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        if (success) {
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„
            updateQuestionsUI();
            
            showSuccessMessage('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
        } else {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
            showErrorMessage('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯');
        }
        
    } catch (error) {
        ErrorHandler.logError(error, 'updateQuestionsOrder');
    }
}

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„
function updateQuestionsUI() {
    try {
        const questionsList = document.getElementById('questionsList');
        if (!questionsList) return;

        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) return;

        const test = school.tests[currentManagingTest];
        const questionItems = questionsList.querySelectorAll('.question-item');

        // ØªØ­Ø¯ÙŠØ« Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        questionItems.forEach((item, index) => {
            const questionNumber = item.querySelector('.bg-blue-500');
            if (questionNumber) {
                questionNumber.textContent = index + 1;
            }
            
            const questionTitle = item.querySelector('h5');
            if (questionTitle) {
                questionTitle.innerHTML = `<span class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">${index + 1}</span> Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}`;
            }

            // ØªØ­Ø¯ÙŠØ« data-question-index
            item.dataset.questionIndex = index;
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        setTimeout(() => {
            initializeDragAndDrop();
        }, 100);
    } catch (error) {
        ErrorHandler.logError(error, 'updateQuestionsUI');
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… ==========
function changePassword(event) {
    event.preventDefault();
    
    try {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!currentPassword || !newPassword || !confirmNewPassword) {
            showErrorMessage('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
            return false;
        }
        
        if (newPassword !== confirmNewPassword) {
            showErrorMessage('Ø®Ø·Ø£', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©');
            return false;
        }
        
        if (newPassword.length < 6) {
            showErrorMessage('Ø®Ø·Ø£', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
            return false;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if (currentUser.password !== currentPassword) {
            showErrorMessage('Ø®Ø·Ø£', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            return false;
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        currentUser.password = newPassword;
        demoData.users[currentUser.email] = currentUser;
        
        // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        const success = StorageManager.setItem('teacherAccounts', demoData.users);
        
        if (success) {
            showSuccessMessage('ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ±', 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        } else {
            showErrorMessage('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
        }
        
        return success;
        
    } catch (error) {
        ErrorHandler.logError(error, 'changePassword');
        showErrorMessage('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
        return false;
    }
}

function updateProfile(event) {
    event.preventDefault();
    
    try {
        const name = DataValidator.sanitizeInput(document.getElementById('profileName').value);
        const email = DataValidator.sanitizeInput(document.getElementById('profileEmail').value);
        const school = DataValidator.sanitizeInput(document.getElementById('profileSchool').value);
        const stage = document.getElementById('profileStage').value;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!name || !email || !school || !stage) {
            showErrorMessage('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            return false;
        }
        
        if (!DataValidator.validateEmail(email)) {
            showErrorMessage('Ø®Ø·Ø£', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
            return false;
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„ØªØ±Ø§Ø¬Ø¹ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        const oldEmail = currentUser.email;
        const oldName = currentUser.name;
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        currentUser.name = name;
        currentUser.email = email;
        currentUser.school = school;
        currentUser.stage = stage;
        
        // Ø¥Ø°Ø§ ØªØºÙŠØ± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (oldEmail !== email) {
            delete demoData.users[oldEmail];
        }
        
        demoData.users[email] = currentUser;
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === oldName) {
                demoData.schools[schoolId].name = school;
                demoData.schools[schoolId].teacher = name;
                break;
            }
        }
        
        // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        const success1 = StorageManager.setItem('teacherAccounts', demoData.users);
        const success2 = StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        if (success1 && success2) {
            showSuccessMessage('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            const teacherWelcome = document.getElementById('teacherWelcome');
            if (teacherWelcome) {
                teacherWelcome.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}`;
            }
        } else {
            showErrorMessage('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª');
            // Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            currentUser.email = oldEmail;
            currentUser.name = oldName;
        }
        
        return success1 && success2;
        
    } catch (error) {
        ErrorHandler.logError(error, 'updateProfile');
        showErrorMessage('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
        return false;
    }
}

// ========== Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù…Ø¹Ø·Ù„ ==========
function initializeDragAndDrop() {
    console.log('ğŸš« Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù…Ø¹Ø·Ù„ ØªÙ…Ø§Ù…Ø§Ù‹ ÙˆÙ„Ø§ ÙŠØ¹Ù…Ù„');
    return false;
}

function updateQuestionsOrder(oldIndex, newIndex) {
    console.log('ğŸš« Ù†Ø¸Ø§Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ø¹Ø·Ù„ ØªÙ…Ø§Ù…Ø§Ù‹');
    return false;
}

function updateQuestionsUI() {
    console.log('ğŸš« Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¹Ø·Ù„ ØªÙ…Ø§Ù…Ø§Ù‹');
    return false;
}

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ==========

function showCertificate() {
    try {
        document.getElementById('certificateScreen').classList.remove('hidden');
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ø´Ù‡Ø§Ø¯Ø©
        updateCertificatePreview('');
    } catch (error) {
        ErrorHandler.logError(error, 'showCertificate');
    }
}

function closeCertificate() {
    try {
        document.getElementById('certificateScreen').classList.add('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'closeCertificate');
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØµØ¯ÙŠØ± ==========
function loadResultsForTeacher() {
    try {
        console.log('ğŸ“Š Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ù„Ù…...');
        
        const results = getResultsSync();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        console.log(`ğŸ‘¨â€ğŸ« Ø¹Ø¯Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ù„Ù… ${currentUser.name}:`, teacherResults.length);
        
        // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„Ù„ÙÙ„ØªØ±
        updateTestFilterOptions(teacherResults);
        
        // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙØµÙˆÙ„ Ù„Ù„ÙÙ„ØªØ±
        updateClassFilterOptions(teacherResults);
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        setTimeout(() => {
            if (typeof filterResults === 'function') {
                filterResults();
            }
        }, 100);
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ù„Ù…:', error);
        ErrorHandler.logError(error, 'loadResultsForTeacher');
    }
}

function updateTestFilterOptions(results) {
    try {
        const testSelect = document.getElementById('filterTestSelect');
        if (!testSelect) return;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
        const uniqueTests = [...new Set(results.map(r => r.test))].filter(Boolean);
        
        let optionsHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</option>';
        uniqueTests.forEach(test => {
            optionsHTML += `<option value="${test}">${test}</option>`;
        });
        
        testSelect.innerHTML = optionsHTML;
    } catch (error) {
        console.error('Error updating test filter:', error);
    }
}

function updateClassFilterOptions(results) {
    try {
        const classSelect = document.getElementById('filterClassSelect');
        if (!classSelect) return;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„ÙØ±ÙŠØ¯Ø©
        const uniqueClasses = [...new Set(results.map(r => r.class))].filter(Boolean);
        
        let optionsHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>';
        uniqueClasses.forEach(className => {
            optionsHTML += `<option value="${className}">${className}</option>`;
        });
        
        classSelect.innerHTML = optionsHTML;
    } catch (error) {
        console.error('Error updating class filter:', error);
    }
}

function toggleAdvancedFilters() {
    try {
        const advancedFilters = document.getElementById('advancedFilters');
        const toggleButton = document.getElementById('toggleFiltersBtn');
        
        if (advancedFilters && toggleButton) {
            if (advancedFilters.classList.contains('hidden')) {
                advancedFilters.classList.remove('hidden');
                toggleButton.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
            } else {
                advancedFilters.classList.add('hidden');
                toggleButton.textContent = 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
            }
        }
    } catch (error) {
        ErrorHandler.logError(error, 'toggleAdvancedFilters');
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© filterResults Ù„Ø¯Ø¹Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØµØµ
// Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© filterResults
function filterResults() {
    try {
        console.log('ğŸ” Ø¨Ø¯Ø¡ ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬...');
        
        const results = getResultsSync();
        console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙÙŠØ©:', results.length);
        
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ØŒ ØªÙˆÙ‚Ù Ù‡Ù†Ø§
        if (!results || results.length === 0) {
            if (typeof updateResultsTable !== 'undefined') {
                updateResultsTable([]);
            }
            return;
        }
        
        let filtered = [...results];
        
        // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
        const searchName = document.getElementById('searchStudentName')?.value.toLowerCase() || '';
        if (searchName) {
            filtered = filtered.filter(result => 
                result.name && result.name.toLowerCase().includes(searchName)
            );
        }
        
        // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const testFilter = document.getElementById('filterTestSelect')?.value || '';
        if (testFilter) {
            filtered = filtered.filter(result => result.test === testFilter);
        }
        
        // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØµÙ„
        const classFilter = document.getElementById('filterClassSelect')?.value || '';
        if (classFilter) {
            filtered = filtered.filter(result => result.class === classFilter);
        }
        
        // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±
        const gradeFilter = document.getElementById('filterGradeSelect')?.value || '';
        if (gradeFilter) {
            filtered = filtered.filter(result => result.gradeLevel === gradeFilter);
        }
        
        // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
        const percentageFilter = document.getElementById('filterPercentageSelect')?.value || '';
        if (percentageFilter) {
            filtered = filtered.filter(result => {
                const percentage = result.percentage || Math.round((result.score / result.total) * 100);
                switch(percentageFilter) {
                    case '90-100': return percentage >= 90;
                    case '80-89': return percentage >= 80 && percentage < 90;
                    case '70-79': return percentage >= 70 && percentage < 80;
                    case '60-69': return percentage >= 60 && percentage < 70;
                    case '0-59': return percentage < 60;
                    default: return true;
                }
            });
        }
        
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        const scoreFilter = document.getElementById('filterScoreSelect')?.value || '';
        if (scoreFilter === 'score-desc') {
            filtered.sort((a, b) => (b.percentage || 0) - (a.percentage || 0));
        } else if (scoreFilter === 'score-asc') {
            filtered.sort((a, b) => (a.percentage || 0) - (b.percentage || 0));
        }
        
        console.log('âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙÙŠØ©:', filtered.length);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (typeof updateResultsTable !== 'undefined') {
            updateResultsTable(filtered);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateFilterStats(filtered);
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬:', error);
        ErrorHandler.logError(error, 'filterResults');
    }
}

function updateFilterStats(filteredResults) {
    try {
        if (!filteredResults || filteredResults.length === 0) {
            document.getElementById('filteredCount').textContent = '0';
            document.getElementById('filteredAverage').textContent = '0%';
            document.getElementById('filteredPassRate').textContent = '0%';
            document.getElementById('filteredHighest').textContent = '0%';
            return;
        }
        
        const total = filteredResults.length;
        const totalPercentage = filteredResults.reduce((sum, result) => 
            sum + (result.percentage || Math.round((result.score / result.total) * 100)), 0);
        const average = Math.round(totalPercentage / total);
        const passCount = filteredResults.filter(result => 
            (result.percentage || Math.round((result.score / result.total) * 100)) >= 60
        ).length;
        const passRate = Math.round((passCount / total) * 100);
        const highest = Math.max(...filteredResults.map(result => 
            result.percentage || Math.round((result.score / result.total) * 100)
        ));
        
        document.getElementById('filteredCount').textContent = total;
        document.getElementById('filteredAverage').textContent = average + '%';
        document.getElementById('filteredPassRate').textContent = passRate + '%';
        document.getElementById('filteredHighest').textContent = highest + '%';
        
    } catch (error) {
        console.error('Error updating filter stats:', error);
    }
}

// ========== Ø¥ØµÙ„Ø§Ø­ ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯ ==========

function initializeDateFilter() {
    try {
        const dateFilterSelect = document.getElementById('filterDateSelect');
        const customDateFilter = document.getElementById('customDateFilter');
        
        if (!dateFilterSelect || !customDateFilter) {
            console.warn('Ø¹Ù†Ø§ØµØ± ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„ØªØºÙŠÙŠØ± ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
        dateFilterSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateFilter.classList.remove('hidden');
            } else {
                customDateFilter.classList.add('hidden');
                // ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙÙ„ØªØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø®ÙŠØ§Ø± ØºÙŠØ± Ù…Ø®ØµØµ
                filterResults();
            }
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ù„Ø­Ù‚Ù„ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®
        const dateFrom = document.getElementById('filterDateFrom');
        const dateTo = document.getElementById('filterDateTo');
        
        if (dateFrom && dateTo) {
            dateFrom.addEventListener('change', filterResults);
            dateTo.addEventListener('change', filterResults);
        }
        
        console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        ErrorHandler.logError(error, 'initializeDateFilter');
    }
}

function displayFilteredResults(results) {
    try {
        const tableBody = document.getElementById('resultsTableBody');
        if (!tableBody) return;
        
        if (results.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                        <div class="text-4xl mb-2">ğŸ“Š</div>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        let tableHTML = '';
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹
        const filterScore = document.getElementById('filterScoreSelect')?.value || '';
        if (filterScore) {
            const orderText = filterScore === 'score-desc' ? 'ğŸ”º Ù…Ø±ØªØ¨Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©' : 'ğŸ”» Ù…Ø±ØªØ¨Ø© Ù…Ù† Ø§Ù„Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø©';
            tableHTML += `<div class="text-sm text-blue-600 mb-2 p-2 bg-blue-50 rounded-lg text-center">${orderText}</div>`;
        }
        
        results.forEach(result => {
            tableHTML += `
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-all">
                    <td class="px-6 py-4 text-right">${result.name}</td>
                    <td class="px-6 py-4 text-right">${result.grade} - ${result.class}</td>
                    <td class="px-6 py-4 text-right">${result.test}</td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-bold ${result.percentage >= 60 ? 'text-green-600' : 'text-red-600'}">
                            ${result.score}/${result.total}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-bold ${result.percentage >= 60 ? 'text-green-600' : 'text-red-600'}">
                            ${result.percentage}%
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="px-2 py-1 rounded-full text-sm ${getGradeColor(result.gradeLevel)}">
                            ${result.gradeLevel}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">${result.date}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex gap-2 justify-end">
                            <button onclick="viewResultDetails(${result.id})" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                ØªÙØ§ØµÙŠÙ„
                            </button>
                            <button onclick="deleteStudentResult(${result.id})" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"></path>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                    <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                Ø­Ø°Ù
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = tableHTML;
    } catch (error) {
        ErrorHandler.logError(error, 'displayFilteredResults');
    }
}

function getGradeColor(grade) {
    switch (grade) {
        case 'Ù…Ù…ØªØ§Ø²': return 'bg-green-100 text-green-800';
        case 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹': return 'bg-blue-100 text-blue-800';
        case 'Ø¬ÙŠØ¯': return 'bg-yellow-100 text-yellow-800';
        case 'Ù…Ù‚Ø¨ÙˆÙ„': return 'bg-orange-100 text-orange-800';
        case 'Ø¶Ø¹ÙŠÙ': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function updateFilterStats(results) {
    try {
        const stats = {
            count: results.length,
            average: 0,
            passRate: 0,
            highest: 0
        };
        
        if (results.length > 0) {
            stats.average = Math.round(results.reduce((sum, r) => sum + r.percentage, 0) / results.length);
            stats.passRate = Math.round((results.filter(r => r.percentage >= 60).length / results.length) * 100);
            stats.highest = Math.max(...results.map(r => r.percentage));
        }
        
        const elements = {
            filteredCount: document.getElementById('filteredCount'),
            filteredAverage: document.getElementById('filteredAverage'),
            filteredPassRate: document.getElementById('filteredPassRate'),
            filteredHighest: document.getElementById('filteredHighest')
        };
        
        if (elements.filteredCount) elements.filteredCount.textContent = stats.count;
        if (elements.filteredAverage) elements.filteredAverage.textContent = stats.average + '%';
        if (elements.filteredPassRate) elements.filteredPassRate.textContent = stats.passRate + '%';
        if (elements.filteredHighest) elements.filteredHighest.textContent = stats.highest + '%';
    } catch (error) {
        ErrorHandler.logError(error, 'updateFilterStats');
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© clearAllFilters Ù„ØªØ¶Ù…ÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
function clearAllFilters() {
    try {
        const filterElements = [
            'searchStudentName',
            'filterTestSelect',
            'filterClassSelect',
            'filterGradeSelect',
            'filterPercentageSelect',
            'filterDateSelect',
            'filterScoreSelect',
            'filterDateFrom',
            'filterDateTo'
        ];
        
        filterElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.value = '';
            }
        });
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆØ­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØµØµ
        const advancedFilters = document.getElementById('advancedFilters');
        const customDateFilter = document.getElementById('customDateFilter');
        const toggleButton = document.getElementById('toggleFiltersBtn');
        
        if (advancedFilters) advancedFilters.classList.add('hidden');
        if (customDateFilter) customDateFilter.classList.add('hidden');
        if (toggleButton) toggleButton.textContent = 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
        filterResults();
    } catch (error) {
        ErrorHandler.logError(error, 'clearAllFilters');
    }
}

function viewResultDetails(resultId) {
    try {
        const results = loadResults();
        const result = results.find(r => r.id === resultId);
        
        if (!result) {
            alert('Ø§Ù„Ù†ØªÙŠØ¬Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        const modalId = 'resultDetailsModal_' + resultId;
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø£Ø²Ù„Ù’Ù‡Ø§ Ø£ÙˆÙ„Ø§Ù‹
        const existingModal = document.getElementById(modalId);
        if (existingModal) {
            existingModal.remove();
        }
        
        let detailsHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 result-details-modal">
                <div class="bg-white rounded-3xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center sticky top-0 z-10">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©</h2>
                            <button onclick="closeResultDetails('${modalId}')" class="text-white hover:text-gray-200 text-2xl font-bold transition-all">
                                âœ•
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-xl">
                                <div class="text-blue-600 font-semibold">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div>
                                <div class="font-bold text-lg">${result.name}</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl">
                                <div class="text-green-600 font-semibold">Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„</div>
                                <div class="font-bold text-lg">${result.grade} - ${result.class}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-xl mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <span class="text-gray-600">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</span>
                                    <span class="font-bold">${result.test}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Ø§Ù„Ù…Ø§Ø¯Ø©:</span>
                                    <span class="font-bold">${result.subject}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Ø§Ù„Ø¯Ø±Ø¬Ø©:</span>
                                    <span class="font-bold">${result.score}/${result.total}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Ø§Ù„Ù†Ø³Ø¨Ø©:</span>
                                    <span class="font-bold ${result.percentage >= 60 ? 'text-green-600' : 'text-red-600'}">${result.percentage}%</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±:</span>
                                    <span class="font-bold ${getGradeColorClass(result.gradeLevel)}">${result.gradeLevel}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                                    <span class="font-bold">${result.date}</span>
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="font-bold text-gray-800 mb-4">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª (${result.answers.length} Ø³Ø¤Ø§Ù„)</h3>
                        <div class="space-y-4 max-h-96 overflow-y-auto p-2">
        `;
        
        result.answers.forEach((answer, index) => {
            const questionNumber = index + 1;
            const isCorrect = answer.isCorrect;
            const selectedOption = answer.selected !== -1 ? `Ø§Ù„Ø®ÙŠØ§Ø± ${answer.selected + 1}` : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©';
            const correctOption = `Ø§Ù„Ø®ÙŠØ§Ø± ${answer.correct + 1}`;
            
            detailsHTML += `
                <div class="border border-gray-200 rounded-xl p-4 ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} transition-all hover:shadow-md">
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold text-lg flex items-center gap-2">
                            <span class="w-6 h-6 ${isCorrect ? 'bg-green-500' : 'bg-red-500'} text-white rounded-full flex items-center justify-center text-sm">${questionNumber}</span>
                            Ø§Ù„Ø³Ø¤Ø§Ù„ ${questionNumber}
                        </span>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${isCorrect ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                            ${isCorrect ? 'âœ“ ØµØ­ÙŠØ­' : 'âœ— Ø®Ø§Ø·Ø¦'}
                        </span>
                    </div>
                    <div class="grid md:grid-cols-2 gap-3 text-sm">
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="text-gray-600 font-semibold mb-1">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</div>
                            <div class="font-bold ${isCorrect ? 'text-green-600' : 'text-red-600'}">${selectedOption}</div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="text-gray-600 font-semibold mb-1">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</div>
                            <div class="font-bold text-green-600">${correctOption}</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        detailsHTML += `
                        </div>
                        <div class="text-center mt-8 pt-6 border-t border-gray-200">
                            <button onclick="closeResultDetails('${modalId}')" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-3 rounded-xl font-semibold transition-all shadow-lg">
                                Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailsHTML);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeResultDetails(modalId);
            }
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ù„Ø²Ø± ESC
        const closeOnEscape = function(e) {
            if (e.key === 'Escape') {
                closeResultDetails(modalId);
                document.removeEventListener('keydown', closeOnEscape);
            }
        };
        document.addEventListener('keydown', closeOnEscape);
        
    } catch (error) {
        ErrorHandler.logError(error, 'viewResultDetails');
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆÙ† Ø§Ù„ØªÙ‚Ø¯ÙŠØ±
function getGradeColorClass(grade) {
    switch (grade) {
        case 'Ù…Ù…ØªØ§Ø²': return 'text-green-600';
        case 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹': return 'text-blue-600';
        case 'Ø¬ÙŠØ¯': return 'text-yellow-600';
        case 'Ù…Ù‚Ø¨ÙˆÙ„': return 'text-orange-600';
        case 'Ø¶Ø¹ÙŠÙ': return 'text-red-600';
        default: return 'text-gray-600';
    }
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„
function closeResultDetails(modalId) {
    try {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                modal.remove();
            }, 300);
        }
    } catch (error) {
        ErrorHandler.logError(error, 'closeResultDetails');
    }
}

// Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙŠ CSS
const modalStyles = `
@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

.result-details-modal > div {
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from { 
        opacity: 0;
        transform: translateY(20px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}
`;

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
if (!document.getElementById('modalStyles')) {
    const styleSheet = document.createElement("style");
    styleSheet.id = 'modalStyles';
    styleSheet.textContent = modalStyles;
    document.head.appendChild(styleSheet);
}

// Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ù†ØªÙŠØ¬Ø© Ø·Ø§Ù„Ø¨
function deleteStudentResult(resultId) {
    try {
        if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
            return;
        }
        
        const results = loadResults();
        const resultIndex = results.findIndex(r => r.id === resultId);
        
        if (resultIndex === -1) {
            alert('Ø§Ù„Ù†ØªÙŠØ¬Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        const deletedResult = results[resultIndex];
        
        // Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
        results.splice(resultIndex, 1);
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        const success = StorageManager.setItem('testResults', results);
        
        if (success) {
            showSuccessMessage('ØªÙ… Ø§Ù„Ø­Ø°Ù', `ØªÙ… Ø­Ø°Ù Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ${deletedResult.name} Ø¨Ù†Ø¬Ø§Ø­`);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            loadResultsForTeacher();
        } else {
            alert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©');
        }
    } catch (error) {
        ErrorHandler.logError(error, 'deleteStudentResult');
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©');
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± ==========

function exportResults() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        if (teacherResults.length === 0) {
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ØªØµØ¯ÙŠØ±');
            return;
        }
        
        let csvContent = 'data:text/csv;charset=utf-8,\uFEFF';
        csvContent += 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨,Ø§Ù„ØµÙ,Ø§Ù„ÙØµÙ„,Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±,Ø§Ù„Ù…Ø§Ø¯Ø©,Ø§Ù„Ø¯Ø±Ø¬Ø©,Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ,Ø§Ù„Ù†Ø³Ø¨Ø©,Ø§Ù„ØªÙ‚Ø¯ÙŠØ±,Ø§Ù„ØªØ§Ø±ÙŠØ®\n';
        
        teacherResults.forEach(result => {
            const row = [
                result.name,
                result.grade,
                result.class,
                result.test,
                result.subject,
                result.score,
                result.total,
                result.percentage + '%',
                result.gradeLevel,
                result.date
            ].map(field => `"${field}"`).join(',');
            
            csvContent += row + '\n';
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ø·Ù„Ø§Ø¨_${new Date().toLocaleDateString('ar-SA')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        ErrorHandler.logError(error, 'exportResults');
    }
}

function exportToExcel() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        if (teacherResults.length === 0) {
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ØªØµØ¯ÙŠØ±');
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„
        const ws = XLSX.utils.json_to_sheet(teacherResults.map(result => ({
            'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': result.name,
            'Ø§Ù„ØµÙ': result.grade,
            'Ø§Ù„ÙØµÙ„': result.class,
            'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±': result.test,
            'Ø§Ù„Ù…Ø§Ø¯Ø©': result.subject,
            'Ø§Ù„Ø¯Ø±Ø¬Ø©': result.score,
            'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': result.total,
            'Ø§Ù„Ù†Ø³Ø¨Ø©': result.percentage + '%',
            'Ø§Ù„ØªÙ‚Ø¯ÙŠØ±': result.gradeLevel,
            'Ø§Ù„ØªØ§Ø±ÙŠØ®': result.date
        })));
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙ†Ù ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ±Ù‚Ø©
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨');
        
        // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
        XLSX.writeFile(wb, `Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ø·Ù„Ø§Ø¨_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
    } catch (error) {
        ErrorHandler.logError(error, 'exportToExcel');
    }
}

function exportFilteredToExcel() {
    try {
        const searchName = document.getElementById('searchStudentName')?.value.toLowerCase() || '';
        const filterTest = document.getElementById('filterTestSelect')?.value || '';
        const filterClass = document.getElementById('filterClassSelect')?.value || '';
        
        const results = loadResults();
        let filteredResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // ØªØ·Ø¨ÙŠÙ‚ Ù†ÙØ³ ÙÙ„Ø§ØªØ± Ø§Ù„Ø¹Ø±Ø¶
        if (searchName) {
            filteredResults = filteredResults.filter(result => 
                result.name.toLowerCase().includes(searchName)
            );
        }
        
        if (filterTest) {
            filteredResults = filteredResults.filter(result => 
                result.test === filterTest
            );
        }
        
        if (filterClass) {
            filteredResults = filteredResults.filter(result => 
                result.class === filterClass
            );
        }
        
        if (filteredResults.length === 0) {
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ù„Ù„ØªØµØ¯ÙŠØ±');
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„
        const ws = XLSX.utils.json_to_sheet(filteredResults.map(result => ({
            'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': result.name,
            'Ø§Ù„ØµÙ': result.grade,
            'Ø§Ù„ÙØµÙ„': result.class,
            'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±': result.test,
            'Ø§Ù„Ù…Ø§Ø¯Ø©': result.subject,
            'Ø§Ù„Ø¯Ø±Ø¬Ø©': result.score,
            'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': result.total,
            'Ø§Ù„Ù†Ø³Ø¨Ø©': result.percentage + '%',
            'Ø§Ù„ØªÙ‚Ø¯ÙŠØ±': result.gradeLevel,
            'Ø§Ù„ØªØ§Ø±ÙŠØ®': result.date
        })));
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙ†Ù ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ±Ù‚Ø©
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Ù†ØªØ§Ø¦Ø¬ Ù…ÙÙ„ØªØ±Ø©');
        
        // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
        XLSX.writeFile(wb, `Ù†ØªØ§Ø¦Ø¬_Ù…ÙÙ„ØªØ±Ø©_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
    } catch (error) {
        ErrorHandler.logError(error, 'exportFilteredToExcel');
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ==========

function loadTeacherSettings() {
    try {
        if (!currentUser) return;
        
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profileSchool = document.getElementById('profileSchool');
        const profileStage = document.getElementById('profileStage');
        
        if (profileName) profileName.value = currentUser.name || '';
        if (profileEmail) profileEmail.value = currentUser.email || '';
        if (profileSchool) profileSchool.value = currentUser.school || '';
        if (profileStage) profileStage.value = currentUser.stage || '';
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù„Ø¹Ù†ØµØ± profileGrade ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
        // updateGradeOptions(currentUser.stage, 'profileGrade');
        
        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        const systemSettings = StorageManager.getItem('systemSettings') || {};
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†
        updateStorageStats();
    } catch (error) {
        ErrorHandler.logError(error, 'loadTeacherSettings');
    }
}

function saveProfileSettings(event) {
    try {
        event.preventDefault();
        
        const name = DataValidator.sanitizeInput(document.getElementById('profileName').value);
        const email = DataValidator.sanitizeInput(document.getElementById('profileEmail').value);
        const school = DataValidator.sanitizeInput(document.getElementById('profileSchool').value);
        const stage = document.getElementById('profileStage').value;
        
        const errorDiv = document.getElementById('profileError');
        const successDiv = document.getElementById('profileSuccess');
        
        if (!errorDiv || !successDiv) {
            throw new Error('Profile message elements not found');
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        errorDiv.classList.add('hidden');
        successDiv.classList.add('hidden');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!name || !email || !school || !stage) {
            errorDiv.textContent = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        if (!DataValidator.validateEmail(email)) {
            errorDiv.textContent = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        currentUser.name = name;
        currentUser.email = email;
        currentUser.school = school;
        currentUser.stage = stage;
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === currentUser.name) {
                demoData.schools[schoolId].name = school;
                break;
            }
        }
        
        // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        const success = StorageManager.setItem('teacherAccounts', demoData.users);
        StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        if (!success) {
            errorDiv.textContent = 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        successDiv.textContent = 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­';
        successDiv.classList.remove('hidden');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const teacherWelcome = document.getElementById('teacherWelcome');
        if (teacherWelcome) {
            teacherWelcome.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}`;
        }
        
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'saveProfileSettings');
        return false;
    }
}

function saveSystemSettings(event) {
    try {
        event.preventDefault();
        
        const autoSave = document.getElementById('autoSave').checked;
        const notifications = document.getElementById('notifications').checked;
        const darkMode = document.getElementById('darkMode').checked;
        
        const systemSettings = {
            autoSave: autoSave,
            notifications: notifications,
            darkMode: darkMode
        };
        
        const success = StorageManager.setItem('systemSettings', systemSettings);
        
        const messageDiv = document.getElementById('systemMessage');
        if (messageDiv) {
            messageDiv.textContent = success ? 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª';
            messageDiv.className = success ? 
                'bg-green-100 text-green-700 p-3 rounded-lg text-center' : 
                'bg-red-100 text-red-700 p-3 rounded-lg text-center';
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000);
        }
        
        return success;
    } catch (error) {
        ErrorHandler.logError(error, 'saveSystemSettings');
        return false;
    }
}

function updateStorageStats() {
    try {
        const storageInfo = StorageManager.getStorageInfo();
        
        const elements = {
            totalStorage: document.getElementById('totalStorage'),
            itemsCount: document.getElementById('itemsCount'),
            largestItem: document.getElementById('largestItem')
        };
        
        if (elements.totalStorage) {
            elements.totalStorage.textContent = storageInfo.totalSize.toFixed(2) + ' MB';
        }
        
        if (elements.itemsCount) {
            elements.itemsCount.textContent = storageInfo.itemCount;
        }
        
        if (elements.largestItem && storageInfo.items.length > 0) {
            const largest = storageInfo.items[0];
            elements.largestItem.textContent = `${largest.key} (${largest.size.toFixed(2)} KB)`;
        }
    } catch (error) {
        ErrorHandler.logError(error, 'updateStorageStats');
    }
}

function clearAllData() {
    try {
        if (!confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
            return;
        }
        
        if (!confirm('âŒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!\n\nØ§ÙƒØªØ¨ "Ù†Ø¹Ù…" Ù„Ù„ØªØ£ÙƒÙŠØ¯:')) {
            return;
        }
        
        // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        localStorage.clear();
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        demoData.schools = {};
        demoData.users = {
            'chartgain2019@gmail.com': {
                email: 'chartgain2019@gmail.com',
                password: '123456',
                name: 'Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
                school: 'Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙˆÙ„ÙŠØ¯ Ø¨Ù† Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©',
                stage: 'Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©'
            }
        };
        
        currentUser = null;
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        location.reload();
    } catch (error) {
        ErrorHandler.logError(error, 'clearAllData');
    }
}

function clearResultsOnly() {
    try {
        if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
            return;
        }
        
        // Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙ‚Ø·
        localStorage.removeItem('testResults');
        
        showSuccessMessage('ØªÙ… Ø§Ù„Ù…Ø³Ø­', 'ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ù†Ø¬Ø§Ø­');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateStorageStats();
        loadResultsForTeacher();
        loadDashboardData();
    } catch (error) {
        ErrorHandler.logError(error, 'clearResultsOnly');
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© ==========
function updateWelcomeStatistics() {
    try {
        const results = getResultsSync(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const totalSchools = Object.keys(demoData.schools).length;
        const totalTeachers = Object.keys(demoData.users).length;
        const totalTests = Object.values(demoData.schools).reduce((sum, school) => 
            sum + (school.tests ? school.tests.length : 0), 0
        );
        const totalResults = results.length;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ±
        const elements = {
            statsSchools: document.getElementById('statsSchools'),
            statsTeachers: document.getElementById('statsTeachers'),
            statsTests: document.getElementById('statsTests'),
            statsResults: document.getElementById('statsResults')
        };
        
        if (elements.statsSchools) elements.statsSchools.textContent = totalSchools;
        if (elements.statsTeachers) elements.statsTeachers.textContent = totalTeachers;
        if (elements.statsTests) elements.statsTests.textContent = totalTests;
        if (elements.statsResults) elements.statsResults.textContent = totalResults;
        
    } catch (error) {
        ErrorHandler.logError(error, 'updateWelcomeStatistics');
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ù…Ø³Ø¨Ù‚Ø§Ù‹
function loadSchoolsForExistingTeachers() {
    try {
        console.log('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†...');
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø§Ø±Ø³ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†
        for (const email in demoData.users) {
            const teacher = demoData.users[email];
            let teacherHasSchool = false;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ù…Ø¹Ù„Ù… Ù…Ø¯Ø±Ø³Ø© Ù…Ø³Ø¬Ù„Ø©
            for (const schoolId in demoData.schools) {
                if (demoData.schools[schoolId].teacher === teacher.name) {
                    teacherHasSchool = true;
                    console.log('Ø§Ù„Ù…Ø¹Ù„Ù… Ù„Ø¯ÙŠÙ‡ Ù…Ø¯Ø±Ø³Ø© Ù…Ø³Ø¬Ù„Ø©:', teacher.name);
                    break;
                }
            }
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ù„Ù…Ø¹Ù„Ù… Ù…Ø¯Ø±Ø³Ø©ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯Ø©
            if (!teacherHasSchool && teacher.school) {
                const newSchoolId = 'school_' + Date.now() + '_' + email;
                demoData.schools[newSchoolId] = {
                    id: newSchoolId,
                    name: teacher.school,
                    teacher: teacher.name,
                    tests: []
                };
                
                console.log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø¹Ù„Ù…:', teacher.name, '- Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:', teacher.school);
            }
        }
        
        // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        if (Object.keys(demoData.schools).length > 0) {
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            console.log('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:', Object.keys(demoData.schools).length, 'Ù…Ø¯Ø±Ø³Ø©');
        }
    } catch (error) {
        ErrorHandler.logError(error, 'loadSchoolsForExistingTeachers');
    }
}
// ========== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù… ==========
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø³Ù†
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯
async function initializeSystem() {
    try {
        showLoadingMessage('Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«...');
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙØ©
        cleanupCorruptedData();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (Ù„Ù„Ø³Ø±Ø¹Ø©)
        const storedTeachers = StorageManager.getItem('teacherAccounts');
        const storedSchools = StorageManager.getItem('demoSchoolsData');
        const storedResults = StorageManager.getItem('testResults');
        
        if (storedTeachers) Object.assign(demoData.users, storedTeachers);
        if (storedSchools) Object.assign(demoData.schools, storedSchools);
        
        console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ');
        
        // Ø«Ù… Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ (ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)
        setTimeout(async () => {
            try {
                console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¯Ø«...');
                await RemoteAPI.checkEndpoints();
                
                if (RemoteAPI.isAvailable) {
                    console.log('âœ… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ Ù…ØªÙˆÙØ±ØŒ Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
                    const [remoteTeachers, remoteSchools, remoteResults] = await Promise.all([
                        RemoteAPI.getTeachers(),
                        RemoteAPI.getSchools(),
                        RemoteAPI.getResults()
                    ]);
                    
                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    if (remoteTeachers && Object.keys(remoteTeachers).length > 0) {
                        Object.assign(demoData.users, remoteTeachers);
                        StorageManager.setItem('teacherAccounts', demoData.users);
                    }
                    
                    if (remoteSchools && remoteSchools.length > 0) {
                        // ØªØ­ÙˆÙŠÙ„ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù†
                        const schoolsObj = {};
                        remoteSchools.forEach(school => {
                            schoolsObj[school.id] = school;
                        });
                        Object.assign(demoData.schools, schoolsObj);
                        StorageManager.setItem('demoSchoolsData', demoData.schools);
                    }
                    
                    if (remoteResults && remoteResults.length > 0) {
                        StorageManager.setItem('testResults', remoteResults);
                    }
                    
                    console.log('âœ… Ø§ÙƒØªÙ…Ù„Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯');
                } else {
                    console.log('ğŸ’¡ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
                }
                
            } catch (syncError) {
                console.log('ğŸ’¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯ ØºÙŠØ± Ù…ØªØ§Ø­Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
                RemoteAPI.isAvailable = false;
            }
            
            // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            showServerStatus();
        }, 1000);
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†
        loadSchoolsForExistingTeachers();
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹
        SystemRecovery.initialize();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateWelcomeStatistics();
        
        hideLoadingMessage();
        
        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ø®Ø§Ø¯Ù…
        showServerStatus();
        
        console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø« Ø¨Ù†Ø¬Ø§Ø­ - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
        
    } catch (error) {
        hideLoadingMessage();
        ErrorHandler.logError(error, 'initializeSystem');
        showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©', 'ØªØ¹Ø°Ø± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„');
        
        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù… Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        showServerStatus();
    }
}

// ========== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© ==========

// ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
window.addEventListener('error', function(e) {
    if (e.message && (
        e.message.includes('hotkeys') || 
        e.message.includes('chext') ||
        e.filename.includes('chext')
    )) {
        e.preventDefault();
        console.log('â„¹ï¸ Ø®Ø·Ø£ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ù…ØªØµÙØ­ Ø®Ø§Ø±Ø¬ÙŠØ© - ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡');
        return true;
    }
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¹ÙˆØ¯ Ù…Ø±ÙÙˆØ¶Ø© ØºÙŠØ± Ù…Ø¹Ø§Ù„Ø¬Ø©
window.addEventListener('unhandledrejection', function(e) {
    if (e.reason && e.reason.message && (
        e.reason.message.includes('hotkeys') ||
        e.reason.message.includes('chext')
    )) {
        e.preventDefault();
        console.log('â„¹ï¸ ÙˆØ¹Ø¯ Ù…Ø±ÙÙˆØ¶ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ù…ØªØµÙØ­ - ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡');
        return true;
    }
});

// Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
// Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
function showFinalSystemStatus() {
    const teachersCount = Object.keys(demoData.users).length;
    const schoolsCount = Object.keys(demoData.schools).length;
    const resultsCount = getResultsSync().length; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
    
    console.log('ğŸ“‹ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:');
    console.log(`   ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†: ${teachersCount}`);
    console.log(`   ğŸ« Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${schoolsCount}`);
    console.log(`   ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${resultsCount}`);
    console.log(`   ğŸŒ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø¹ÙŠØ¯: ${RemoteAPI.isAvailable ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„'}`);
    
    if (!RemoteAPI.isAvailable) {
        console.log('ğŸ’¡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø©: Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ');
        console.log('ğŸ’¡ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø£Ù…Ø§Ù† Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ');
    }
}

// Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ©
function showWelcomeMessage() {
    console.log('ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ!');
    console.log('ğŸ“š Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ');
}

function setupEventListeners() {
    try {
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        ResourceManager.addEventListener(document.getElementById('schoolSearch'), 'input', searchSchools);
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„ÙÙ„ØªØ±Ø©
        const filterElements = [
            'searchStudentName',
            'filterTestSelect', 
            'filterClassSelect',
            'filterGradeSelect',
            'filterPercentageSelect',
            'filterDateSelect',
            'filterDateFrom',
            'filterDateTo'
        ];
        
        filterElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                ResourceManager.addEventListener(element, 'change', filterResults);
            }
        });
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø¨Ø­Ø«
        const searchInput = document.getElementById('searchStudentName');
        if (searchInput) {
            ResourceManager.addEventListener(searchInput, 'input', filterResults);
        }
        
        console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        ErrorHandler.logError(error, 'setupEventListeners');
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ­ÙŠØ­ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© ==========

function showSystemInfo() {
    try {
        const storageInfo = StorageManager.getStorageInfo();
        const errorLogs = StorageManager.getItem('errorLogs') || [];
        
        let infoHTML = `
            <div class="bg-white rounded-3xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 text-center sticky top-0">
                    <h2 class="text-2xl font-bold">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„ØªØµØ­ÙŠØ­</h2>
                </div>
                <div class="p-6">
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <h3 class="font-bold text-blue-800 mb-2">ğŸ’¾ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†</h3>
                            <div class="space-y-1 text-sm">
                                <div>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong>${storageInfo.totalSize.toFixed(2)} MB</strong></div>
                                <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±: <strong>${storageInfo.itemCount}</strong></div>
                                <div>Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: <strong>${Object.keys(demoData.schools).length}</strong></div>
                                <div>Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ†: <strong>${Object.keys(demoData.users).length}</strong></div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 p-4 rounded-xl">
                            <h3 class="font-bold text-green-800 mb-2">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
                            <div class="space-y-1 text-sm">
                                <div>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©: <strong>${loadResults().length}</strong></div>
                                <div>Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©: <strong>${ResourceManager.activeSessions.size}</strong></div>
                                <div>Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: <strong>${errorLogs.length}</strong></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-xl mb-6">
                        <h3 class="font-bold text-yellow-800 mb-3">âš ï¸ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ (Ø¢Ø®Ø± 5)</h3>
                        <div class="space-y-2 max-h-60 overflow-y-auto">
        `;
        
        const recentErrors = errorLogs.slice(-5).reverse();
        if (recentErrors.length === 0) {
            infoHTML += '<p class="text-gray-600 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ù…Ø³Ø¬Ù„Ø©</p>';
        } else {
            recentErrors.forEach(log => {
                infoHTML += `
                    <div class="bg-white p-3 rounded-lg border border-yellow-200">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-red-600">${log.context}</span>
                            <span class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleString('ar-SA')}</span>
                        </div>
                        <div class="text-sm text-gray-700">${log.error.message}</div>
                    </div>
                `;
            });
        }
        
        infoHTML += `
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-xl mb-6">
                        <h3 class="font-bold text-gray-800 mb-3">ğŸ”§ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                        <div class="grid md:grid-cols-2 gap-3">
                            <button onclick="clearResultsOnly()" class="bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg text-sm font-semibold transition-all">
                                ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙ‚Ø·
                            </button>
                            <button onclick="clearAllData()" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm font-semibold transition-all">
                                ğŸ’¥ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            </button>
                            <button onclick="location.reload()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-semibold transition-all">
                                ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
                            </button>
                            <button onclick="testSystemFunctions()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg text-sm font-semibold transition-all">
                                ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                            Ø¥ØºÙ„Ø§Ù‚
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const modalDiv = document.createElement('div');
        modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
        modalDiv.innerHTML = infoHTML;
        
        document.body.appendChild(modalDiv);
    } catch (error) {
        ErrorHandler.logError(error, 'showSystemInfo');
    }
}

function testSystemFunctions() {
    try {
        console.log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø¸Ø§Ù…...');
        
        const tests = {
            storage: StorageManager.isStorageAvailable(),
            json: (() => {
                try {
                    JSON.parse('{"test": true}');
                    JSON.stringify({test: true});
                    return true;
                } catch {
                    return false;
                }
            })(),
            dom: (() => {
                try {
                    document.createElement('div');
                    return true;
                } catch {
                    return false;
                }
            })()
        };
        
        const failedTests = Object.entries(tests).filter(([_, passed]) => !passed).map(([test]) => test);
        
        if (failedTests.length === 0) {
            showSuccessMessage('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…', 'âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        } else {
            showErrorMessage('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…', `âŒ ÙØ´Ù„ ÙÙŠ: ${failedTests.join(', ')}`);
        }
        
        console.log('Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…:', tests);
    } catch (error) {
        ErrorHandler.logError(error, 'testSystemFunctions');
    }
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
document.addEventListener('DOMContentLoaded', function() {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    const questionsTab = document.getElementById('questionsTab');
    if (questionsTab) {
        questionsTab.addEventListener('click', function() {
            setTimeout(() => {
                initializeDragAndDrop();
            }, 500);
        });
    }
    // ØªÙ‡ÙŠØ¦Ø© ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
    initializeDateFilter();
	
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
    const questionTestSelect = document.getElementById('questionTestSelect');
    if (questionTestSelect) {
        questionTestSelect.addEventListener('change', function() {
            setTimeout(() => {
                initializeDragAndDrop();
            }, 800);
        });
    }
});

function getDragAfterElement(container, y) {
    try {
        const draggableElements = [...container.querySelectorAll('.question-item:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    } catch (error) {
        ErrorHandler.logError(error, 'getDragAfterElement');
        return null;
    }
}

function updateQuestionsOrder() {
    try {
        if (currentManagingTest === null) return;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) return;
        
        const questionsList = document.getElementById('questionsList');
        const questionItems = questionsList.querySelectorAll('.question-item');
        const newQuestions = [];
        
        questionItems.forEach(item => {
            const questionIndex = parseInt(item.dataset.questionIndex);
            newQuestions.push(school.tests[currentManagingTest].questions[questionIndex]);
        });
        
        // ØªØ­Ø¯ÙŠØ« ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        school.tests[currentManagingTest].questions = newQuestions;
        
        // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        loadTestQuestions();
        
    } catch (error) {
        ErrorHandler.logError(error, 'updateQuestionsOrder');
    }
}

// ========== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ==========

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    // Ø¥ØµÙ„Ø§Ø­ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø£Ø­Ø¯Ø§Ø« ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    const questionsTab = document.getElementById('questionsTab');
    if (questionsTab) {
        questionsTab.addEventListener('click', function() {
            console.log('ğŸ“ ØªÙ… ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
            // Ù„Ø§ Ù†Ù‚ÙˆÙ… Ø¨ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø­Ø¨ Ù‡Ù†Ø§ØŒ Ø³ÙŠØªÙ… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        });
    }
    
    const questionTestSelect = document.getElementById('questionTestSelect');
    if (questionTestSelect) {
        questionTestSelect.addEventListener('change', function() {
            console.log('ğŸ¯ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ø®ØªØ¨Ø§Ø±ØŒ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...');
            // loadTestQuestions Ø³ØªÙ‚ÙˆÙ… Ø¨ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø­Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        });
    }
});

// ========== Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ==========

// Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
initializeSystem();

// ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø£Ø®Ø·Ø§Ø¡ Ù…Ù† Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
window.addEventListener('error', function(e) {
    if (e.message.includes('hotkeys') || e.filename.includes('chext')) {
        e.preventDefault();
        console.log('â„¹ï¸ Ø®Ø·Ø£ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ù…ØªØµÙØ­ Ø®Ø§Ø±Ø¬ÙŠØ© - ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡');
        return true;
    }
});

// ========== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ==========
// ========== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª...');
    
    // Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    setTimeout(() => {
        initializeBasicSystem();
    }, 500);
});

function initializeBasicSystem() {
    try {
        console.log('ğŸ”§ Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©...');
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        const storedTeachers = localStorage.getItem('teacherAccounts');
        const storedSchools = localStorage.getItem('demoSchoolsData');
        
        if (storedTeachers) {
            try {
                const teachers = JSON.parse(storedTeachers);
                Object.assign(demoData.users, teachers);
            } catch (e) {
                console.error('Error loading teachers:', e);
            }
        }
        
        if (storedSchools) {
            try {
                const schools = JSON.parse(storedSchools);
                Object.assign(demoData.schools, schools);
            } catch (e) {
                console.error('Error loading schools:', e);
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateWelcomeStatistics();
        
        console.log('âœ… Ø§ÙƒØªÙ…Ù„Øª ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©');
        console.log('ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', {
            Ù…Ø¯Ø§Ø±Ø³: Object.keys(demoData.schools).length,
            Ù…Ø¹Ù„Ù…ÙˆÙ†: Object.keys(demoData.users).length
        });
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…:', error);
    }
}

function updateWelcomeStatistics() {
    try {
        const stats = {
            schools: Object.keys(demoData.schools || {}).length,
            teachers: Object.keys(demoData.users || {}).length,
            tests: Object.values(demoData.schools || {}).reduce((total, school) => 
                total + (school.tests ? school.tests.length : 0), 0),
            results: (() => {
                try {
                    const results = localStorage.getItem('testResults');
                    return results ? JSON.parse(results).length : 0;
                } catch {
                    return 0;
                }
            })()
        };
        
        const elements = {
            statsSchools: document.getElementById('statsSchools'),
            statsTeachers: document.getElementById('statsTeachers'),
            statsTests: document.getElementById('statsTests'),
            statsResults: document.getElementById('statsResults')
        };
        
        if (elements.statsSchools) elements.statsSchools.textContent = stats.schools;
        if (elements.statsTeachers) elements.statsTeachers.textContent = stats.teachers;
        if (elements.statsTests) elements.statsTests.textContent = stats.tests;
        if (elements.statsResults) elements.statsResults.textContent = stats.results;
        
    } catch (error) {
        console.error('Error updating statistics:', error);
    }
}

// ØªØ¹Ø±ÙŠÙ Ø¨Ø¯ÙŠÙ„ Ù„Ù…Ù†Ø¹ Ø£Ø®Ø·Ø§Ø¡ hotkeys Ù…Ù† Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯Ø§Øª
if (typeof hotkeys === 'undefined') {
    var hotkeys = {
        bind: function() { 
            console.log('Hotkeys not available - this is normal');
            return this;
        },
        unbind: function() { 
            console.log('Hotkeys not available - this is normal');
            return this;
        }
    };
}

</script>

</body>
</html>