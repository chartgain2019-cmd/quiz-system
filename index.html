<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الاختبارات التفاعلي</title>
    
    <!-- ⭐⭐ الحل الجذري لأخطاء hotkeys - يتحمّل فوراً ⭐⭐ -->
    <script>
        // تعريف hotkeys فوري ومنع أخطاء الامتدادات
        (function() {
            'use strict';
            // تعريف hotkeys ككائن وكدالة في نفس الوقت
            var hotkeysInstance = function() {
                return hotkeysInstance;
            };
            
            // إضافة الخصائص للكائن
            Object.assign(hotkeysInstance, {
                filter: function() { return hotkeysInstance; },
                key: function() { return hotkeysInstance; },
                unbind: function() { return hotkeysInstance; },
                isPressed: function() { return false; },
                getPressedKeyCodes: function() { return []; },
                shift: function() { return hotkeysInstance; },
                ctrl: function() { return hotkeysInstance; },
                alt: function() { return hotkeysInstance; },
                meta: function() { return hotkeysInstance; }
            });
            
            // تعريف global فوري
            if (typeof window !== 'undefined') {
                window.hotkeys = hotkeysInstance;
            }
            if (typeof global !== 'undefined') {
                global.hotkeys = hotkeysInstance;
            }
            
            console.log('✅ تم تحميل hotkeys البديلة للامتدادات');
        })();
    </script>
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- باقي المكتبات -->
	<!-- إضافة مكتبات التصدير -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// تأكد من أن jsPDF متاح globally
window.jsPDF = window.jspdf.jsPDF;
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- إضافة مكتبة html2canvas لتحويل HTML إلى صورة -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body {
            box-sizing: border-box;
        }
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        * { font-family: 'Cairo', sans-serif; }
        
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .pulse-red { animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 
            0%, 100% { background-color: #ef4444; } 
            50% { background-color: #dc2626; } 
        }
        /* أنماط السحب والإفلات المبسطة */
        .question-item {
          transition: all 0.3s ease;
          cursor: grab;
          user-select: none;
        }

        .question-item:active {
          cursor: grabbing;
        }

       .question-item.dragging {
          opacity: 0.5;
          transform: scale(0.95);
          background: #f0f0f0 !important;
        }

       .question-item.drag-over {
          border: 2px dashed #3b82f6 !important;
          background: #e0f2fe !important;
          transform: scale(1.02);
        }

        .drag-handle {
         opacity: 0.7;
         cursor: grab;
         padding: 8px;
         border-radius: 4px;
         transition: all 0.2s ease;
        }

        .drag-handle:hover {
          opacity: 1;
          background: rgba(0,0,0,0.1);
        }

       .question-item.dragging .drag-handle {
          cursor: grabbing;
        }
        /* أنماط السحب والإفلات */
        .question-item.drag-target {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        
        .question-item.drag-over {
            border-color: #10b981;
            background-color: #f0fdf4;
            transform: scale(1.02);
        }
        
        .question-item:hover .drag-handle {
            opacity: 1;
        }
        
        .drag-handle {
            opacity: 0.6;
            transition: all 0.2s ease;
        }
        
        .drop-indicator {
            animation: pulse-blue 1s infinite;
        }
        
        @keyframes pulse-blue {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* تحسينات الطباعة للشهادة */
        @media print {
            body * {
                visibility: hidden;
            }
            #certificateContent, #certificateContent * {
                visibility: visible;
            }
            #certificateContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 2cm;
            }
            .no-print {
                display: none !important;
            }
        }

        /* تحسينات الاستقرار */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<!-- الشاشة الرئيسية -->
<div id="welcomeScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700">
    <div class="container mx-auto px-6 py-12">
        <div class="max-w-4xl mx-auto text-center text-white">
            <div class="mb-8">
                <div class="w-24 h-24 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h1 class="text-5xl font-bold mb-4">نظام الاختبارات التفاعلي</h1>
                <p class="text-xl mb-12 text-blue-100">منصة تعليمية شاملة وآمنة لإدارة الاختبارات المحاكية لاختبارات نافس</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-12">
                <!-- دخول الطلاب -->
                <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-8 hover:bg-opacity-20 transition-all cursor-pointer" onclick="showStudentAccess()">
                    <div class="text-6xl mb-6">👨‍🎓</div>
                    <h3 class="text-2xl font-bold mb-4">دخول الطلاب</h3>
                    <p class="text-blue-100 mb-6">ابدأ رحلتك التعليمية</p>
                    <button class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-xl font-semibold transition-all">
                        ابدأ الآن
                    </button>
                </div>

                <!-- دخول المعلمين -->
                <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-8 hover:bg-opacity-20 transition-all cursor-pointer" onclick="showTeacherLogin()">
                    <div class="text-6xl mb-6">👨‍💼</div>
                    <h3 class="text-2xl font-bold mb-4">دخول المعلمين</h3>
                    <p class="text-blue-100 mb-6">إدارة الاختبارات</p>
                    <button class="bg-purple-500 hover:bg-purple-600 text-white px-8 py-3 rounded-xl font-semibold transition-all">
                        دخول لوحة التحكم
                    </button>
                </div>
            </div>

            <!-- إحصائيات -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-yellow-300" id="statsSchools">5</div>
                    <div class="text-sm text-blue-100">المدارس</div>
                </div>
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-green-300" id="statsTeachers">12</div>
                    <div class="text-sm text-blue-100">المعلمين</div>
                </div>
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-pink-300" id="statsTests">48</div>
                    <div class="text-sm text-blue-100">الاختبارات</div>
                </div>
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-orange-300" id="statsResults">156</div>
                    <div class="text-sm text-blue-100">النتائج</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- شاشة تسجيل دخول المعلمين -->
<div id="teacherLoginScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-8 text-center">
            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold">تسجيل دخول المعلم</h2>
        </div>
        
        <div class="p-8">
            <form id="teacherLoginForm" onsubmit="return teacherLogin(event)">
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">البريد الإلكتروني</label>
                    <input type="email" id="teacherEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="أدخل البريد الإلكتروني"  required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">كلمة المرور</label>
                    <input type="password" id="teacherPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="أدخل كلمة المرور"  required>
                </div>
                
                
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-xl font-semibold hover:from-purple-700 hover:to-blue-700 transition-all">
                        تسجيل الدخول
                    </button>
                    <button type="button" onclick="closeTeacherLogin()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                        إلغاء
                    </button>
                </div>
                
                <div class="text-center mt-6 pt-6 border-t border-gray-200">
                    <p class="text-gray-600 mb-4">ليس لديك حساب؟</p>
                    <button type="button" onclick="showTeacherSignup()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-all">
                        إنشاء حساب جديد
                    </button>
                </div>
            </form>
            
            <div id="loginError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<!-- شاشة إنشاء حساب معلم جديد -->
<div id="teacherSignupScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-8 text-center">
            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold">إنشاء حساب معلم جديد</h2>
        </div>
        
        <div class="p-8">
            <form id="teacherSignupForm" onsubmit="return teacherSignup(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">الاسم الكامل</label>
                    <input type="text" id="newTeacherName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="أدخل الاسم الكامل" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">البريد الإلكتروني</label>
                    <input type="email" id="newTeacherEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="أدخل البريد الإلكتروني" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">اسم المدرسة</label>
                    <input type="text" id="newTeacherSchool" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="أدخل اسم المدرسة" required>
                </div>
                
                <!-- إضافة المرحلة الدراسية -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">المرحلة الدراسية</label>
                    <select id="newTeacherStage" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" required>
                        <option value="">اختر المرحلة الدراسية</option>
                        <option value="ابتدائية">الابتدائية</option>
                        <option value="متوسطة">المتوسطة</option>
                        <option value="ثانوية">الثانوية</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">كلمة المرور</label>
                    <input type="password" id="newTeacherPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="أدخل كلمة المرور" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">تأكيد كلمة المرور</label>
                    <input type="password" id="confirmTeacherPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="أعد إدخال كلمة المرور" required>
                </div>
                
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 text-white py-3 rounded-xl font-semibold hover:from-green-700 hover:to-blue-700 transition-all">
                        إنشاء الحساب
                    </button>
                    <button type="button" onclick="closeTeacherSignup()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                        إلغاء
                    </button>
                </div>
            </form>
            
            <div id="signupError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
            <div id="signupSuccess" class="hidden mt-4 p-4 bg-green-50 border border-green-200 text-green-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<!-- شاشة اختيار المدرسة للطلاب -->
<div id="studentAccessScreen" class="hidden container mx-auto px-6 py-12">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-8 text-center relative">
                <!-- إضافة زر العودة إلى الشاشة الرئيسية -->
                <button onclick="goBackToWelcome()" class="absolute top-6 right-6 bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-xl transition-all">
                    ← العودة للرئيسية
                </button>
                <div class="text-5xl mb-4">🎓</div>
                <h1 class="text-3xl font-bold mb-2">مرحباً بك عزيزي الطالب</h1>
                <p class="text-blue-100">ابحث عن مدرستك وابدأ الاختبار</p>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl p-8 mb-8">
            <label class="block text-gray-800 font-bold mb-4 text-xl">🔍 ابحث عن مدرستك</label>
            <!-- تغيير من القائمة المنسدلة إلى حقل البحث -->
            <input type="text" id="schoolSearch" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:border-blue-500 focus:outline-none" placeholder="اكتب اسم مدرستك للبحث..." oninput="searchSchools()">
            <p class="text-sm text-gray-500 mt-2">ابدأ بكتابة اسم المدرسة للبحث عنها</p>
            
            <!-- قائمة نتائج البحث -->
            <div id="schoolSearchResults" class="mt-4 max-h-60 overflow-y-auto hidden border border-gray-200 rounded-xl">
                <!-- سيتم تعبئة نتائج البحث هنا -->
            </div>
        </div>

        <div id="selectedSchoolInfo" class="hidden bg-white rounded-3xl shadow-xl p-8">
            <div class="bg-green-50 p-6 rounded-2xl mb-6 border border-green-200">
                <h3 class="text-xl font-bold text-green-800 mb-4">المدرسة المختارة</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-green-600 font-semibold">🏫 اسم المدرسة:</span>
                        <span id="chosenSchoolName" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-green-600 font-semibold">👨‍🏫 المعلم:</span>
                        <span id="chosenTeacher" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                </div>
            </div>
           <button onclick="refreshSchoolData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl font-semibold transition-all flex items-center gap-2">
                🔄 تحديث
           </button>
        </div>
    </div>
            <div class="mb-6">
                <label class="block text-gray-800 font-bold mb-4">📝 اختر الاختبار</label>
                <select id="testSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:border-blue-500 focus:outline-none" onchange="selectTest()">
                    <option value="">اختر الاختبار</option>
                </select>
            </div>

            <div id="testInfo" class="hidden bg-blue-50 p-6 rounded-2xl mb-6 border border-blue-200">
                <h3 class="font-bold text-blue-800 mb-4">معلومات الاختبار</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-blue-600 font-semibold">📖 المادة:</span>
                        <span id="testSubject" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">❓ عدد الأسئلة:</span>
                        <span id="testQuestions" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">🎒 الصف الدراسي:</span>
                        <span id="testGrade" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">⏱️ وقت السؤال:</span>
                        <span id="testTimer" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                </div>
            </div>

            <div id="studentForm" class="hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-6">👤 بيانات الطالب</h3>
                
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">اسم الطالب *</label>
                        <input type="text" id="studentName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="أدخل اسم الطالب">
                    </div>
                    <!-- إضافة الصف الدراسي بعد اسم الطالب -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الصف الدراسي *</label>
                        <select id="studentGrade" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            <option value="">سيتم تعبئته تلقائياً</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">يتم تحديد الصف الدراسي تلقائياً حسب الاختبار المحدد</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الفصل *</label>
                        <input type="text" id="studentClass" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="مثال: 6أ">
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="startTest()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-12 py-4 rounded-xl text-xl font-bold hover:from-green-600 hover:to-blue-600 transition-all shadow-lg">
                        🚀 بدء الاختبار
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- شاشة الاختبار -->
<div id="testScreen" class="hidden container mx-auto px-6 py-8">
    <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
            <div class="flex justify-between items-center text-sm">
                <div class="flex gap-4">
                    <span>🏫 <span id="testSchoolName"></span></span>
                    <span>📖 <span id="testSubjectName"></span></span>
                    <span>🎒 <span id="testGradeLevel"></span></span>
                    <span>👤 <span id="testStudentName"></span></span>
                </div>
                <div class="flex gap-4">
                    <span>❓ <span id="currentQuestion">1</span> من <span id="totalQuestions">5</span></span>
                    <span>⭐ <span id="currentScore">0</span></span>
                </div>
            </div>
        </div>
        
        <div class="p-4 bg-gray-50">
            <div class="bg-gray-200 rounded-full h-3">
                <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl p-8">
            <div class="text-center mb-8">
                <div id="timer" class="inline-block bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-2xl font-bold">30</div>
                <p class="text-gray-600 mt-2">الوقت المتبقي</p>
            </div>
            
            <div class="mb-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center" id="questionText">ما هو ناتج 2 + 2؟</h3>
                
                <div class="grid gap-4" id="optionsContainer">
                    <!-- سيتم إضافة الخيارات هنا -->
                </div>
            </div>
            
            <div id="feedbackArea" class="hidden text-center p-4 rounded-xl mb-6"></div>
            
            <div class="text-center pt-6 border-t border-gray-200">
                <button onclick="confirmExitTest()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                    🚪 الخروج من الاختبار
                </button>
            </div>
        </div>
    </div>
</div>

<!-- نافذة تأكيد الخروج -->
<div id="exitTestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl max-w-md w-full overflow-hidden">
        <div class="bg-red-500 text-white p-6 text-center">
            <div class="text-4xl mb-2">⚠️</div>
            <h2 class="text-xl font-bold">تأكيد الخروج</h2>
        </div>
        <div class="p-6 text-center">
            <p class="text-gray-700 mb-6">هل أنت متأكد من رغبتك في الخروج من الاختبار؟</p>
            <div class="flex gap-4">
                <button onclick="exitTest()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold transition-all">
                    نعم، الخروج
                </button>
                <button onclick="cancelExitTest()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                    إلغاء
                </button>
            </div>
        </div>
    </div>
</div>

<!-- شاشة النتائج -->
<div id="resultsScreen" class="hidden container mx-auto px-6 py-12">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden text-center">
            <div class="bg-gradient-to-r from-green-500 to-blue-500 text-white p-12">
                <div class="text-6xl mb-4">🎉</div>
                <h2 class="text-3xl font-bold mb-2">تهانينا على إكمال الاختبار!</h2>
                <p class="text-green-100">إليك نتائجك التفصيلية</p>
            </div>
            
            <div class="p-12">
                <div class="grid md:grid-cols-3 gap-8 mb-8">
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-200">
                        <div class="text-4xl mb-2">📊</div>
                        <h3 class="font-bold text-blue-800 mb-2">النقاط</h3>
                        <p class="text-3xl font-bold text-blue-600" id="finalScore">0</p>
                    </div>
                    
                    <div class="bg-green-50 p-6 rounded-2xl border border-green-200">
                        <div class="text-4xl mb-2">📈</div>
                        <h3 class="font-bold text-green-800 mb-2">النسبة المئوية</h3>
                        <p class="text-3xl font-bold text-green-600" id="percentage">0%</p>
                    </div>
                    
                    <div class="bg-purple-50 p-6 rounded-2xl border border-purple-200">
                        <div class="text-4xl mb-2">🏆</div>
                        <h3 class="font-bold text-purple-800 mb-2">التقدير</h3>
                        <p class="text-2xl font-bold text-purple-600" id="grade">-</p>
                    </div>
                </div>
                
                <div class="flex flex-wrap justify-center gap-4">
                    <button onclick="showCertificate()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-600 transition-all">
                        🏅 عرض الشهادة
                    </button>
                    
                    <button onclick="shareWhatsApp()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        📱 مشاركة بالواتساب
                    </button>
                    
                    <button onclick="retakeTest()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        🔄 إعادة الاختبار
                    </button>
                    
                    <button onclick="goBackToSchoolSelection()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        ← العودة
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- شاشة الشهادة Canvas المحسنة -->
<div id="certificateScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl max-w-4xl w-full max-h-screen overflow-y-auto no-print">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 text-center no-print">
            <h2 class="text-2xl font-bold">🏆 شهادة إنجاز محسنة</h2>
        </div>
        
        <div class="p-8">
            <!-- معاينة الشهادة -->
            <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-4 border-blue-300 rounded-2xl p-8 mb-6">
                <div id="certificatePreview" class="text-center">
                    <!-- سيتم عرض معاينة الشهادة هنا -->
                </div>
            </div>
            
            <!-- canvas مخفي لرسم الشهادة -->
            <canvas id="certificateCanvas" class="hidden" width="2480" height="3508"></canvas>
        </div>
        
        <div class="p-6 text-center border-t border-gray-200 no-print">
            <button onclick="generateCertificateImage('png')" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all mr-4">
                📸 حفظ كصورة PNG
            </button>
            <button onclick="generateCertificateImage('jpg')" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl font-semibold transition-all mr-4">
                🖼️ حفظ كصورة JPG
            </button>
            <button onclick="closeCertificate()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                إغلاق
            </button>
        </div>
    </div>
</div>

<!-- لوحة تحكم المعلم -->
<div id="teacherDashboard" class="hidden container mx-auto px-6 py-8">
    <!-- محتوى لوحة تحكم المعلم -->
    <div class="bg-white rounded-3xl shadow-xl">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-8 rounded-t-3xl">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">لوحة تحكم المعلم</h1>
                    <p class="text-purple-100" id="teacherWelcome">مرحباً أ. عبدالله الشهري</p>
                </div>
                <button onclick="teacherLogout()" class="bg-red-500 hover:bg-red-600 px-6 py-3 rounded-xl font-semibold transition-all">
                    🚪 تسجيل الخروج
                </button>
            </div>
        </div>
        
        <!-- شريط التبويبات -->
        <div class="bg-gray-50 px-8 py-4 border-b border-gray-200">
            <div class="flex gap-2 overflow-x-auto">
                <button onclick="showTab('dashboard')" id="dashboardTab" class="tab-btn active bg-white text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    📊 لوحة المعلومات
                </button>
                <button onclick="showTab('tests')" id="testsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    📝 إدارة الاختبارات
                </button>
                <button onclick="showTab('questions')" id="questionsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    ❓ إدارة الأسئلة
                </button>
                <button onclick="showTab('results')" id="resultsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    📈 نتائج الطلاب
                </button>
                <button onclick="showTab('settings')" id="settingsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    ⚙️ الإعدادات العامة
                </button>
            </div>
        </div>
        
        <!-- محتوى التبويبات -->
        <div class="p-8">
            <!-- تبويب لوحة المعلومات -->
            <div id="dashboardContent" class="tab-content">
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded-2xl text-center border border-blue-200">
                        <div class="text-4xl mb-2">📝</div>
                        <div class="text-3xl font-bold text-blue-600" id="totalTests">1</div>
                        <div class="text-gray-600">اختباراتي</div>
                    </div>
                    <div class="bg-green-50 p-6 rounded-2xl text-center border border-green-200">
                        <div class="text-4xl mb-2">👥</div>
                        <div class="text-3xl font-bold text-green-600" id="totalStudents">0</div>
                        <div class="text-gray-600">الطلاب</div>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-2xl text-center border border-purple-200">
                        <div class="text-4xl mb-2">📊</div>
                        <div class="text-3xl font-bold text-purple-600" id="averageScore">0%</div>
                        <div class="text-gray-600">متوسط الدرجات</div>
                    </div>
                    <div class="bg-orange-50 p-6 rounded-2xl text-center border border-orange-200">
                        <div class="text-4xl mb-2">🎯</div>
                        <div class="text-3xl font-bold text-orange-600" id="passRate">0%</div>
                        <div class="text-gray-600">معدل النجاح</div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-6 rounded-2xl border border-blue-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📊 إحصائيات سريعة</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">إجمالي المحاولات:</span>
                                <span class="font-bold text-blue-600" id="totalAttempts">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">أعلى درجة:</span>
                                <span class="font-bold text-green-600" id="highestScore">0%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">أقل درجة:</span>
                                <span class="font-bold text-red-600" id="lowestScore">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-50 to-blue-50 p-6 rounded-2xl border border-green-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">🎯 أهداف التحسين</h3>
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded-xl">
                                <div class="text-sm text-gray-600 mb-1">معدل النجاح المستهدف</div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                                    </div>
                                    <span class="text-sm font-bold">85%</span>
                                </div>
                            </div>
                            <div class="bg-white p-3 rounded-xl">
                                <div class="text-sm text-gray-600 mb-1">متوسط الدرجات المستهدف</div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: 80%"></div>
                                    </div>
                                    <span class="text-sm font-bold">80%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- تبويب إدارة الاختبارات -->
            <div id="testsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">📝 إدارة الاختبارات</h3>
                    <button onclick="showCreateTestModal()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-600 transition-all">
                        ➕ إنشاء اختبار جديد
                    </button>
                </div>
                
                <div id="testsGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- سيتم إضافة الاختبارات هنا -->
                </div>
            </div>
            
            <!-- تبويب إدارة الأسئلة -->
            <div id="questionsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">❓ إدارة الأسئلة</h3>
                    <div class="flex gap-4">
                        <select id="questionTestSelect" class="border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="loadTestQuestions()">
                            <option value="">اختر الاختبار</option>
                        </select>
                        <button onclick="showAddQuestionModal()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-green-600 hover:to-blue-600 transition-all">
                            ➕ إضافة سؤال
                        </button>
                    </div>
                </div>
                
                <div id="questionsContainer">
                    <div class="text-center text-gray-500 py-12">
                        <div class="text-6xl mb-4">❓</div>
                        <p>اختر اختباراً لعرض الأسئلة</p>
                    </div>
                </div>
            </div>
            
            <!-- تبويب نتائج الطلاب -->
            <div id="resultsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">📈 نتائج الطلاب</h3>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                            📊 Excel
                        </button>
                        <button onclick="exportFilteredToExcel()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                            🔍 Excel مفلتر
                        </button>
                        <button onclick="exportResults()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                            📝 CSV
                        </button>
                        <button onclick="clearAllFilters()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-xl font-semibold transition-all">
                            🔄 مسح الفلاتر
                        </button>
                    </div>
                </div>
                
                <!-- نظام البحث والفلترة المتقدم -->
                <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="text-2xl">🔍</div>
                        <h4 class="text-lg font-bold text-gray-800">البحث والفلترة المتقدمة</h4>
                        <div class="flex-1"></div>
                        <button onclick="toggleAdvancedFilters()" id="toggleFiltersBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-all">
                            إظهار الفلاتر المتقدمة
                        </button>
                    </div>
                    
                    <!-- مربع البحث -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">🔍 البحث باسم الطالب</label>
                        <input type="text" id="searchStudentName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="اكتب اسم الطالب للبحث..." oninput="filterResults()">
                    </div>
                    
                    <!-- الفلاتر المتقدمة -->
                    <div id="advancedFilters" class="hidden">
                        <div class="grid md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <!-- فلتر الاختبار -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">📝 الاختبار</label>
                                <select id="filterTestSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">جميع الاختبارات</option>
                                </select>
                            </div>
                            
                            <!-- فلتر الفصل -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">🏫 الفصل</label>
                                <select id="filterClassSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">جميع الفصول</option>
                                </select>
                            </div>
                            
                            <!-- فلتر التقدير -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">🏆 التقدير</label>
                                <select id="filterGradeSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">جميع التقديرات</option>
                                    <option value="ممتاز">ممتاز</option>
                                    <option value="جيد جداً">جيد جداً</option>
                                    <option value="جيد">جيد</option>
                                    <option value="مقبول">مقبول</option>
                                    <option value="ضعيف">ضعيف</option>
                                </select>
                            </div>
                            
                            <!-- فلتر النسبة المئوية -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">📊 النسبة المئوية</label>
                                <select id="filterPercentageSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">جميع النسب</option>
                                    <option value="90-100">90% - 100%</option>
                                    <option value="80-89">80% - 89%</option>
                                    <option value="70-79">70% - 79%</option>
                                    <option value="60-69">60% - 69%</option>
                                    <option value="0-59">أقل من 60%</option>
                                </select>
                            </div>
                            
                            <!-- فلتر الدرجة -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">🎯 الدرجة</label>
                                <select id="filterScoreSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">جميع الدرجات</option>
                                </select>
                            </div>
                            
                            <!-- فلتر التاريخ -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">📅 التاريخ</label>
                                <select id="filterDateSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">جميع التواريخ</option>
                                    <option value="today">اليوم</option>
                                    <option value="week">هذا الأسبوع</option>
                                    <option value="month">هذا الشهر</option>
                                    <option value="custom">تاريخ محدد</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- اختيار تاريخ محدد -->
                        <div id="customDateFilter" class="hidden mt-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">من تاريخ</label>
                                    <input type="date" id="filterDateFrom" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">إلى تاريخ</label>
                                    <input type="date" id="filterDateTo" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- إحصائيات النتائج المفلترة -->
                    <div id="filterStats" class="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-blue-600" id="filteredCount">0</div>
                                <div class="text-sm text-blue-600">النتائج المعروضة</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-green-600" id="filteredAverage">0%</div>
                                <div class="text-sm text-green-600">متوسط النسب</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-purple-600" id="filteredPassRate">0%</div>
                                <div class="text-sm text-purple-600">معدل النجاح</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-orange-600" id="filteredHighest">0%</div>
                                <div class="text-sm text-orange-600">أعلى نسبة</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-6 rounded-2xl">
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white rounded-xl overflow-hidden">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">اسم الطالب</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">الصف/الفصل</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">الاختبار</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">الدرجة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">النسبة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">التقدير</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">التاريخ</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- سيتم إضافة النتائج هنا -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- تبويب الإعدادات العامة -->
            <div id="settingsContent" class="tab-content hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">⚙️ الإعدادات العامة</h3>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">👤 معلومات الحساب</h4>
                        <form onsubmit="return updateProfile(event)">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">الاسم الكامل</label>
                                <input type="text" id="profileName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">البريد الإلكتروني</label>
                                <input type="email" id="profileEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 bg-gray-100" readonly>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">اسم المدرسة</label>
                                <input type="text" id="profileSchool" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">المرحلة الدراسية</label>
                                <select id="profileStage" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                                    <option value="ابتدائية">ابتدائية</option>
                                    <option value="متوسطة">متوسطة</option>
                                    <option value="ثانوية">الثانوية</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition-all">
                                حفظ التغييرات
                            </button>
                        </form>
                    </div>
					<!-- أدوات التصحيح - ستظهر فقط لـ chartgain2019@gmail.com -->
                    <div id="debugToolsSection" class="hidden">
                       <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                           <h4 class="text-lg font-bold text-yellow-800 mb-2">🛠️ أدوات التصحيح (خاصة بالمسؤول)</h4>
                           <div class="flex gap-2">
                                <button onclick="initializeDefaultData()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                   إصلاح البيانات
                                </button>
                                <button onclick="debugData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                   فحص البيانات
                                </button>
                                <button onclick="debugSystem()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    فحص النظام
                                </button>
                                <button onclick="showAllSchools()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    عرض المدارس
                                </button>
                            </div>
                            <p class="text-xs text-yellow-700 mt-2">
							    هذه الأدوات خاصة بالمسؤول وتظهر فقط لحساب chartgain2019@gmail.com
							</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">🔒 تغيير كلمة المرور</h4>
                        <form onsubmit="return changePassword(event)">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">كلمة المرور الحالية</label>
                                <input type="password" id="currentPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">كلمة المرور الجديدة</label>
                                <input type="password" id="newPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">تأكيد كلمة المرور الجديدة</label>
                                <input type="password" id="confirmNewPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-all">
                                تغيير كلمة المرور
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== النوافذ المنبثقة الجديدة ========== -->

<!-- نافذة إنشاء وتعديل الاختبار -->
<div id="testModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center sticky top-0 z-10">
            <h2 class="text-2xl font-bold" id="testModalTitle">إنشاء اختبار جديد</h2>
        </div>
        
        <div class="p-8">
            <form id="testModalForm" onsubmit="return handleTestFormSubmit(event)">
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">اسم الاختبار</label>
                        <input type="text" id="modalTestName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="مثال: اختبار الفصل الثاني" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">المادة</label>
                        <input type="text" id="modalTestSubject" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="مثال: الرياضيات، العلوم، اللغة العربية..." required>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">🎒 الصف الدراسي</label>
                        <select id="modalTestGrade" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            <option value="">اختر الصف الدراسي</option>
                            <!-- سيتم تعبئة الخيارات ديناميكياً حسب المرحلة -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">⏱️ وقت كل سؤال (بالثواني)</label>
                        <input type="number" id="modalTestTimer" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="30" min="10" max="300" value="30" required>
                        <p class="text-xs text-gray-500 mt-1">من 10 إلى 300 ثانية</p>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">📊 مستوى الصعوبة</label>
                        <select id="modalTestDifficulty" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none">
                            <option value="سهل">سهل</option>
                            <option value="متوسط" selected>متوسط</option>
                            <option value="صعب">صعب</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">وصف الاختبار</label>
                    <textarea id="modalTestDescription" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" rows="3" placeholder="وصف مختصر للاختبار..."></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        حفظ الاختبار
                    </button>
                    <button type="button" onclick="closeTestModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        إلغاء
                    </button>
                </div>
            </form>
            
            <div id="testModalError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<!-- نافذة إضافة وتعديل السؤال -->
<div id="questionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 text-center sticky top-0 z-10">
            <h2 class="text-2xl font-bold" id="questionModalTitle">إضافة سؤال جديد</h2>
        </div>
        
        <div class="p-8">
            <form id="questionModalForm" onsubmit="return handleQuestionFormSubmit(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">نص السؤال</label>
                    <textarea id="modalQuestionText" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" rows="3" placeholder="اكتب السؤال هنا..." required></textarea>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الخيار الأول</label>
                        <input type="text" id="modalOption1" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="الخيار الأول" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الخيار الثاني</label>
                        <input type="text" id="modalOption2" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="الخيار الثاني" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الخيار الثالث</label>
                        <input type="text" id="modalOption3" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="الخيار الثالث" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الخيار الرابع</label>
                        <input type="text" id="modalOption4" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="الخيار الرابع" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">الإجابة الصحيحة</label>
                    <select id="modalCorrectAnswer" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                        <option value="">اختر الإجابة الصحيحة</option>
                        <option value="0">الخيار الأول</option>
                        <option value="1">الخيار الثاني</option>
                        <option value="2">الخيار الثالث</option>
                        <option value="3">الخيار الرابع</option>
                    </select>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        حفظ السؤال
                    </button>
                    <button type="button" onclick="closeQuestionModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        إلغاء
                    </button>
                </div>
            </form>
            
            <div id="questionModalError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<script>
// ========== أنظمة الاستقرار والأمان المحسنة ==========
// ========== حل نهائي لأخطاء الامتدادات الخارجية ==========
// تعريف hotkeys فارغ لمنع أخطاء الامتدادات
if (typeof hotkeys === 'undefined') {
    window.hotkeys = function() { 
        return {
            filter: function() { return this; },
            key: function() { return this; },
            unbind: function() { return this; },
            isPressed: function() { return false; }
        }; 
    };
}
// نظام معالجة الأخطاء المركزي
const ErrorHandler = {
    logError: function(error, context = '') {
        console.error(`[SYSTEM_ERROR] في ${context}:`, error);
        this.showUserError(error, context);
        
        // تسجيل الخطأ في التخزين المحلي للتحليل
        this.logToStorage(error, context);
    },
    
    showUserError: function(error, context = '') {
        try {
            const errorMessage = this.getUserFriendlyMessage(error);
            this.displayErrorModal(errorMessage, context);
        } catch (modalError) {
            console.error('Failed to show error modal:', modalError);
            // عرض رسالة بديلة بسيطة
            alert('حدث خطأ في النظام. يرجى تحديث الصفحة.');
        }
    },
    
    getUserFriendlyMessage: function(error) {
        if (error.name === 'QuotaExceededError') {
            return 'تم تجاوز سعة التخزين. يرجى حذف بعض البيانات القديمة.';
        } else if (error.name === 'SyntaxError') {
            return 'خطأ في البيانات المخزنة. سيتم إعادة تعيين البيانات تلقائياً.';
        } else if (error.message && error.message.includes('network')) {
            return 'فشل في الاتصال بالشبكة. يرجى التحقق من اتصال الإنترنت.';
        } else {
            return 'حدث خطأ غير متوقع. يرجى تحديث الصفحة والمحاولة مرة أخرى.';
        }
    },
    
    displayErrorModal: function(message, context = '') {
        const modalId = 'errorModal-' + Date.now();
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-3xl max-w-md w-full overflow-hidden">
                    <div class="bg-red-500 text-white p-6 text-center">
                        <div class="text-4xl mb-2">⚠️</div>
                        <h2 class="text-xl font-bold">${context ? `خطأ في ${context}` : 'حدث خطأ'}</h2>
                    </div>
                    <div class="p-6 text-center">
                        <p class="text-gray-700 mb-6">${message}</p>
                        <div class="flex gap-4">
                            <button onclick="document.getElementById('${modalId}').remove()" 
                                    class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold transition-all">
                                موافق
                            </button>
                            <button onclick="location.reload()" 
                                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition-all">
                                تحديث الصفحة
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    },
    
    logToStorage: function(error, context) {
        try {
            const errorLog = {
                timestamp: new Date().toISOString(),
                context: context,
                error: {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                },
                userAgent: navigator.userAgent
            };
            
            const existingLogs = StorageManager.getItem('errorLogs') || [];
            existingLogs.push(errorLog);
            
            // حفظ آخر 50 خطأ فقط
            if (existingLogs.length > 50) {
                existingLogs.splice(0, existingLogs.length - 50);
            }
            
            StorageManager.setItem('errorLogs', existingLogs);
        } catch (logError) {
            console.error('Failed to log error:', logError);
        }
    }
};

// نظام إدارة الموارد
const ResourceManager = {
    timers: new Set(),
    eventListeners: new Map(),
    activeSessions: new Set(),
    
    addTimer: function(timer) {
        this.timers.add(timer);
        return timer;
    },
    
    clearAllTimers: function() {
        this.timers.forEach(timer => {
            try {
                clearInterval(timer);
                clearTimeout(timer);
            } catch (error) {
                console.warn('Error clearing timer:', error);
            }
        });
        this.timers.clear();
    },
    
    addEventListener: function(element, event, handler) {
        if (!element || !element.addEventListener) {
            console.warn('Invalid element for event listener');
            return;
        }
        
        try {
            element.addEventListener(event, handler);
            const key = `${element.id || 'unknown'}-${event}`;
            if (!this.eventListeners.has(key)) {
                this.eventListeners.set(key, []);
            }
            this.eventListeners.get(key).push({element, event, handler});
        } catch (error) {
            ErrorHandler.logError(error, 'addEventListener');
        }
    },
    
    clearAllEventListeners: function() {
        this.eventListeners.forEach((listeners, key) => {
            listeners.forEach(({element, event, handler}) => {
                try {
                    if (element && element.removeEventListener) {
                        element.removeEventListener(event, handler);
                    }
                } catch (error) {
                    console.warn('Error removing event listener:', error);
                }
            });
        });
        this.eventListeners.clear();
    },
    
    registerSession: function(sessionId) {
        this.activeSessions.add(sessionId);
    },
    
    cleanupSession: function(sessionId) {
        this.activeSessions.delete(sessionId);
    },
    
    cleanup: function() {
        this.clearAllTimers();
        this.clearAllEventListeners();
        this.activeSessions.clear();
    }
};

// ========== نظام التخزين المحسّن والمحدث ==========

const StorageManager = {
    setItem: function(key, value) {
    try {
        if (!this.isStorageAvailable()) {
            console.warn('LocalStorage غير متوفر');
            return false;
        }
        
        // تنظيف البيانات قبل الحفظ
        const cleanValue = this.cleanDataBeforeSave(value);
        
        // معالجة خاصة لـ authToken - تخزينه كـ string مباشر
        if (key === 'authToken') {
            localStorage.setItem(key, cleanValue);
            console.log(`تم حفظ ${key} كـ string مباشر`);
            return true;
        }
        
        // لباقي البيانات، استخدم التغليف JSON
        const data = JSON.stringify({
            value: cleanValue,
            timestamp: Date.now(),
            version: '1.0'
        });
        
        // التحقق من حجم البيانات
        if (data.length > 4500000) {
            console.warn(`بيانات كبيرة جداً لـ ${key}: ${data.length} بايت`);
            return this.handleLargeData(key, cleanValue);
        }
        
        localStorage.setItem(key, data);
        console.log(`تم حفظ ${key} بنجاح`);
        return true;
    } catch (error) {
        ErrorHandler.logError(error, `StorageManager.setItem(${key})`);
        return false;
    }
},
    
getItem: function(key) {
    try {
        if (!this.isStorageAvailable()) {
            return this.getDefaultValue(key);
        }
        
        const item = localStorage.getItem(key);
        if (!item) return this.getDefaultValue(key);
        
        // معالجة خاصة لـ authToken - لا نحاول تحليله كـ JSON
        if (key === 'authToken') {
            return item; // إرجاع القيمة مباشرة
        }
        
        try {
            const parsed = JSON.parse(item);
            
            // التحقق من صحة البيانات
            if (!parsed || typeof parsed !== 'object') {
                console.warn(`بيانات غير صالحة لـ ${key}`);
                return this.getDefaultValue(key);
            }
            
            return parsed.value !== undefined ? parsed.value : this.getDefaultValue(key);
        } catch (jsonError) {
            // إذا فشل التحليل JSON، قد تكون القيمة مخزنة كـ string مباشر
            console.warn(`فشل تحليل JSON لـ ${key}، إرجاع القيمة مباشرة:`, item);
            return item;
        }
    } catch (error) {
        ErrorHandler.logError(error, `StorageManager.getItem(${key})`);
        return this.getDefaultValue(key);
    }
},
    
    cleanDataBeforeSave: function(data) {
        if (Array.isArray(data)) {
            return data.map(item => this.cleanDataBeforeSave(item));
        } else if (data && typeof data === 'object') {
            const cleaned = {};
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    cleaned[key] = this.cleanDataBeforeSave(data[key]);
                }
            }
            return cleaned;
        }
        return data;
    },
    
    getDefaultValue: function(key) {
        const defaults = {
            'teacherAccounts': {},
            'demoSchoolsData': {},
            'testResults': [],
            'errorLogs': []
        };
        return defaults[key] || null;
    },
    
    tryRecoverData: function(key) {
        try {
            const item = localStorage.getItem(key);
            if (!item) return null;
            
            // محاولة إصلاح JSON تالف
            const fixedJson = item
                .replace(/[\u0000-\u0019]+/g, "")
                .replace(/([{,]\s*)([a-zA-Z0-9_]+)(\s*:)/g, '$1"$2"$3');
                
            const parsed = JSON.parse(fixedJson);
            return parsed.value || parsed;
        } catch (recoveryError) {
            console.error(`Failed to recover data for ${key}:`, recoveryError);
            // حذف البيانات التالفة
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.error('Failed to remove corrupted data:', e);
            }
            return this.getDefaultValue(key);
        }
    },
    
    isStorageAvailable: function() {
        try {
            const test = 'storage_test';
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
            return true;
        } catch (error) {
            return false;
        }
    },
    
    handleQuotaExceeded: function() {
        // مسح البيانات القديمة تلقائياً
        const cleared = this.clearOldData();
        if (cleared) {
            ErrorHandler.showUserError(new Error('تم تنظيف التخزين تلقائياً. يرجى المحاولة مرة أخرى.'));
        } else {
            ErrorHandler.showUserError(new Error('التخزين ممتلئ. يرجى حذف بعض البيانات يدوياً.'));
        }
    },
    
    handleLargeData: function(key, value) {
        // لمعلومات كبيرة، نقوم بضغطها أو تقسيمها
        if (Array.isArray(value) && value.length > 1000) {
            // حفظ الجزء الأخير فقط من المصفوفات الكبيرة
            const trimmedValue = value.slice(-1000);
            return this.setItem(key, trimmedValue);
        }
        return false;
    },
    
    clearOldData: function() {
        try {
            const oneWeekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            let cleared = false;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('testResult_')) {
                    try {
                        const item = localStorage.getItem(key);
                        if (item) {
                            const parsed = JSON.parse(item);
                            if (parsed.timestamp && parsed.timestamp < oneWeekAgo) {
                                localStorage.removeItem(key);
                                cleared = true;
                            }
                        }
                    } catch (e) {
                        // تخطي العناصر التالفة
                        continue;
                    }
                }
            }
            
            return cleared;
        } catch (error) {
            ErrorHandler.logError(error, 'clearOldData');
            return false;
        }
    },
    
   getStorageInfo: function() {
    let totalSize = 0;
    const items = [];
    
    try {
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            try {
                const value = localStorage.getItem(key);
                if (value) {
                    totalSize += key.length + value.length;
                    items.push({
                        key: key,
                        size: (key.length + value.length) / 1024, // KB
                        timestamp: 'N/A' // لا نحاول تحليل التوقيت لتجنب الأخطاء
                    });
                }
            } catch (e) {
                // تخطي العناصر التي تسبب أخطاء
                console.warn(`تخطي العنصر التالف: ${key}`);
                continue;
            }
        }
    } catch (error) {
        console.error('خطأ في حساب معلومات التخزين:', error);
    }
    
    return {
        totalSize: totalSize / 1024 / 1024, // MB
        itemCount: items.length,
        items: items
    };
},

    // نظام النسخ الاحتياطي الجديد
    createBackup: function() {
        try {
            const backup = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && !key.startsWith('temp_')) {
                    backup[key] = localStorage.getItem(key);
                }
            }
            
            const backupData = JSON.stringify({
                data: backup,
                timestamp: Date.now(),
                version: '1.0'
            });
            
            // حفظ النسخة الاحتياطية في sessionStorage كحل بديل
            sessionStorage.setItem('localStorageBackup', backupData);
            console.log('تم إنشاء نسخة احتياطية');
            return true;
        } catch (error) {
            console.error('فشل في إنشاء نسخة احتياطية:', error);
            return false;
        }
    },

    restoreBackup: function() {
        try {
            const backup = sessionStorage.getItem('localStorageBackup');
            if (!backup) return false;
            
            const parsed = JSON.parse(backup);
            const backupData = parsed.data;
            
            // مسح البيانات الحالية
            localStorage.clear();
            
            // استعادة البيانات
            for (const key in backupData) {
                if (backupData.hasOwnProperty(key)) {
                    localStorage.setItem(key, backupData[key]);
                }
            }
            
            console.log('تم استعادة النسخة الاحتياطية');
            return true;
        } catch (error) {
            console.error('فشل في استعادة النسخة الاحتياطية:', error);
            return false;
        }
    },

    handleStorageError: function(error, operation, key) {
        console.error(`خطأ في التخزين (${operation} لـ ${key}):`, error);
        
        // محاولة إصلاح البيانات التالفة
        if (error.name === 'SyntaxError') {
            console.log('محاولة إصلاح بيانات JSON التالفة...');
            localStorage.removeItem(key);
            this.createBackup();
        }
        
        // إعادة تهيئة البيانات الأساسية إذا لزم الأمر
        if (operation === 'get' && this.isCriticalKey(key)) {
            return this.getDefaultValue(key);
        }
        
        return null;
    },

    isCriticalKey: function(key) {
        const criticalKeys = ['teacherAccounts', 'demoSchoolsData', 'testResults'];
        return criticalKeys.includes(key);
    },

    monitorStorage: function() {
        setInterval(() => {
            const info = this.getStorageInfo();
            if (info.totalSize > 4) { // 4MB
                console.warn('مساحة التخزين قاربة على الامتلاء:', info.totalSize.toFixed(2), 'MB');
                this.clearOldData();
            }
        }, 60000); // كل دقيقة
    },

    // تهيئة التخزين
    initializeStorage: function() {
        console.log('بدء تهيئة نظام التخزين...');
        
        // إنشاء نسخة احتياطية أولية
        this.createBackup();
        
        // تهيئة البيانات الأساسية إذا لم تكن موجودة
        const requiredKeys = ['teacherAccounts', 'demoSchoolsData', 'testResults'];
        requiredKeys.forEach(key => {
            if (!this.getItem(key)) {
                console.log(`تهيئة ${key} بقيم افتراضية...`);
                this.setItem(key, this.getDefaultValue(key));
            }
        });
        
        // بدء مراقبة التخزين
        this.monitorStorage();
        
        console.log('اكتملت تهيئة نظام التخزين');
    }
};

// نظام التحقق من صحة البيانات
const DataValidator = {
    validateStudentData: function(data) {
        const errors = [];
        
        if (!data.name || data.name.trim().length < 2) {
            errors.push('اسم الطالب يجب أن يكون على الأقل حرفين');
        }
        
        if (data.name && data.name.trim().length > 100) {
            errors.push('اسم الطالب طويل جداً (الحد الأقصى 100 حرف)');
        }
        
        if (!data.grade) {
            errors.push('الصف الدراسي مطلوب');
        }
        
        if (!data.class || data.class.trim().length === 0) {
            errors.push('الفصل الدراسي مطلوب');
        }
        
        if (data.class && data.class.trim().length > 50) {
            errors.push('اسم الفصل طويل جداً (الحد الأقصى 50 حرف)');
        }
        
        return {
            isValid: errors.length === 0,
            errors: errors
        };
    },
    
    validateTestData: function(test) {
        const errors = [];
        
        if (!test.questions || test.questions.length === 0) {
            errors.push('الاختبار يجب أن يحتوي على أسئلة');
        }
        
        if (test.questions && test.questions.length > 100) {
            errors.push('عدد الأسئلة كبير جداً (الحد الأقصى 100 سؤال)');
        }
        
        if (!test.timerPerQuestion || test.timerPerQuestion < 10) {
            errors.push('وقت السؤال يجب أن يكون 10 ثواني على الأقل');
        }
        
        if (test.timerPerQuestion > 300) {
            errors.push('وقت السؤال كبير جداً (الحد الأقصى 300 ثانية)');
        }
        
        if (!test.name || test.name.trim().length < 2) {
            errors.push('اسم الاختبار يجب أن يكون على الأقل حرفين');
        }
        
        return {
            isValid: errors.length === 0,
            errors: errors
        };
    },
    
    validateEmail: function(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    },
    
    validatePassword: function(password) {
        if (password.length < 6) {
            return 'كلمة المرور يجب أن تكون 6 أحرف على الأقل';
        }
        if (password.length > 50) {
            return 'كلمة المرور طويلة جداً';
        }
        return null;
    },
    
    sanitizeInput: function(input) {
        if (typeof input !== 'string') return input;
        
        return input
            .trim()
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/'/g, '&#39;')
            .replace(/"/g, '&#34;')
            .substring(0, 1000); // الحد الأقصى للأطوال
    }
};

// نظام استرجاع النظام
const SystemRecovery = {
    initialize: function() {
        this.setupErrorHandling();
        this.setupPerformanceMonitoring();
        
        if (!this.checkSystemHealth()) {
            this.showSystemWarning();
        }
        
        // محاولة استرجاع الجلسة السابقة
        this.recoverPreviousSession();
    },
    
    setupErrorHandling: function() {
        // معالجة أخطاء JavaScript الغير معالجة
        window.addEventListener('error', (event) => {
            ErrorHandler.logError(event.error, 'Unhandled Global Error');
        });
        
        // معالجة وعود مرفوضة غير معالجة
        window.addEventListener('unhandledrejection', (event) => {
            ErrorHandler.logError(event.reason, 'Unhandled Promise Rejection');
        });
        
        // مراقبة تحميل الصور والفشل فيها
        window.addEventListener('error', (event) => {
            if (event.target && (event.target.tagName === 'IMG' || event.target.tagName === 'SCRIPT' || event.target.tagName === 'LINK')) {
                console.warn('Failed to load resource:', event.target.src || event.target.href);
            }
        }, true);
    },
    
    setupPerformanceMonitoring: function() {
        // مراقبة أداء النظام
        if ('performance' in window) {
            const navTiming = performance.getEntriesByType('navigation')[0];
            if (navTiming) {
                console.log(`Page loaded in ${navTiming.loadEventEnd - navTiming.navigationStart}ms`);
            }
        }
        
        // مراقبة استخدام الذاكرة
        if ('memory' in performance) {
            setInterval(() => {
                const memory = performance.memory;
                if (memory.usedJSHeapSize > memory.jsHeapSizeLimit * 0.8) {
                    console.warn('High memory usage detected:', memory);
                }
            }, 30000);
        }
    },
    
    checkSystemHealth: function() {
        const checks = {
            localStorage: this.checkLocalStorage(),
            json: this.checkJSON(),
            timers: this.checkTimers(),
            dom: this.checkDOM()
        };
        
        const failedChecks = Object.entries(checks).filter(([_, passed]) => !passed).map(([check]) => check);
        
        if (failedChecks.length > 0) {
            console.warn('System health check failed for:', failedChecks);
            return false;
        }
        
        return true;
    },
    
    checkLocalStorage: function() {
        return StorageManager.isStorageAvailable();
    },
    
    checkJSON: function() {
        try {
            JSON.parse('{"test": true}');
            JSON.stringify({test: true});
            return true;
        } catch {
            return false;
        }
    },
    
    checkTimers: function() {
        try {
            const testTimer = setTimeout(() => {}, 100);
            clearTimeout(testTimer);
            return true;
        } catch {
            return false;
        }
    },
    
    checkDOM: function() {
        try {
            document.createElement('div');
            return true;
        } catch {
            return false;
        }
    },
    
    showSystemWarning: function() {
        const warning = document.createElement('div');
        warning.className = 'fixed top-4 left-4 right-4 bg-yellow-500 text-white p-4 rounded-xl shadow-lg z-40';
        warning.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">⚠️</span>
                    <div>
                        <div class="font-bold">تحذير النظام</div>
                        <div class="text-sm">قد لا يعمل النظام بشكل مثالي في بيئتك الحالية</div>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                    ✕
                </button>
            </div>
        `;
        document.body.appendChild(warning);
        
        // إزالة التحذير تلقائياً بعد 10 ثوان
        setTimeout(() => {
            if (document.body.contains(warning)) {
                warning.remove();
            }
        }, 10000);
    },
    
    recoverPreviousSession: function() {
        try {
            const session = StorageManager.getItem('currentSession');
            if (session && this.isValidSession(session)) {
                console.log('Recovered previous session:', session);
                return session;
            }
        } catch (error) {
            console.warn('Session recovery failed:', error);
        }
        return null;
    },
    
    isValidSession: function(session) {
        return session && 
               session.timestamp && 
               Date.now() - session.timestamp < 30 * 60 * 1000; // 30 دقيقة كحد أقصى
    },
    
    saveSession: function(sessionData) {
        try {
            const session = {
                ...sessionData,
                timestamp: Date.now(),
                url: window.location.href
            };
            StorageManager.setItem('currentSession', session);
        } catch (error) {
            console.warn('Failed to save session:', error);
        }
    },
    
    clearSession: function() {
        try {
            localStorage.removeItem('currentSession');
        } catch (error) {
            console.warn('Failed to clear session:', error);
        }
    }
};

// ========== خدمة API ==========
const APIService = {
  baseURL: 'https://quiz-system-api.onrender.com/api',
  async request(endpoint, options = {}) {
    try {
		 console.log(`🔄 طلب API: ${this.baseURL}${endpoint}`); // ⬅️ أضف هذا السطر
      const token = localStorage.getItem('authToken');
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };

      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      const response = await fetch(`${this.baseURL}${endpoint}`, {
        ...options,
        headers
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `خطأ في الخادم: ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error('API Error:', error);
      throw error;
    }
  },

  // 🔐 المصادقة
  async register(teacherData) {
    const result = await this.request('/register', {
      method: 'POST',
      body: JSON.stringify(teacherData)
    });
    
    if (result.success && result.token) {
      localStorage.setItem('authToken', result.token);
      localStorage.setItem('currentUser', JSON.stringify(result.user));
    }
    
    return result;
  },

  async login(credentials) {
    const result = await this.request('/login', {
      method: 'POST',
      body: JSON.stringify(credentials)
    });
    
    if (result.success && result.token) {
      localStorage.setItem('authToken', result.token);
      localStorage.setItem('currentUser', JSON.stringify(result.user));
    }
    
    return result;
  },

  // 🏫 المدارس
  async getSchools() {
    return this.request('/schools');
  },

// 🏫 الحصول على جميع المدارس (للبحث - بدون مصادقة)
async getAllSchools() {
  try {
    console.log('🔍 جاري جلب المدارس من الخادم...');
    const response = await fetch(`${this.baseURL}/all-schools`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error(`خطأ في الخادم: ${response.status}`);
    }

    const data = await response.json();
    console.log('✅ تم جلب المدارس بنجاح:', data);
    return data;
  } catch (error) {
    console.error('❌ خطأ في جلب المدارس:', error);
    throw error;
  }
},
// 📊 الحصول على الإحصائيات العامة
async getStatistics() {
  return this.request('/statistics');
},	
  // 📝 الاختبارات
  async getTests(schoolId) {
    return this.request(`/tests/${schoolId}`);
  },

  async createTest(schoolId, testData) {
    return this.request(`/tests/${schoolId}`, {
      method: 'POST',
      body: JSON.stringify(testData)
    });
  },

  // ❓ الأسئلة (سيتم إضافتها لاحقاً)
  async addQuestion(schoolId, testIndex, questionData) {
    // سيتم تحديث هذا لاحقاً
    return { success: true };
  },

  // 📊 النتائج
  async saveResult(resultData) {
    return this.request('/results', {
      method: 'POST',
      body: JSON.stringify(resultData)
    });
  },
// في كائن APIService، أضف:
async changePassword(passwordData) {
  return this.request('/change-password', {
    method: 'POST',
    body: JSON.stringify(passwordData)
  });
}, 
  async getResults() {
    return this.request('/results');
  }
};

// تحديث دوال التسجيل والدخول
async function teacherSignup(event) {
  event.preventDefault();
  
  const name = document.getElementById('newTeacherName').value;
  const email = document.getElementById('newTeacherEmail').value;
  const password = document.getElementById('newTeacherPassword').value;
  const school = document.getElementById('newTeacherSchool').value;
  const stage = document.getElementById('newTeacherStage').value;

  try {
    const result = await APIService.register({
      name, email, password, school, stage
    });
    
    if (result.success) {
      document.getElementById('signupSuccess').textContent = 'تم إنشاء الحساب بنجاح!';
      document.getElementById('signupSuccess').classList.remove('hidden');
      
      setTimeout(() => {
        closeTeacherSignup();
        showTeacherLogin();
      }, 2000);
    }
  } catch (error) {
    document.getElementById('signupError').textContent = error.message;
    document.getElementById('signupError').classList.remove('hidden');
  }
}

async function teacherLogin(event) {
  event.preventDefault();
  
  const email = document.getElementById('teacherEmail').value;
  const password = document.getElementById('teacherPassword').value;

  try {
    const result = await APIService.login({ email, password });
    
    if (result.success) {
      currentUser = result.user;
      closeTeacherLogin();
      showTeacherDashboard();
    }
  } catch (error) {
    document.getElementById('loginError').textContent = error.message;
    document.getElementById('loginError').classList.remove('hidden');
  }
}

// ========== المتغيرات الأساسية للنظام ==========
// بيانات النظام
let currentUser = null;
let currentTest = null;
let currentQuestionIndex = 0;
let timer = null;
let timeLeft = 30;
let studentData = {
    name: '',
    grade: '',
    class: '',
    score: 0,
    answers: []
};

// متغيرات إدارة الاختبارات
let currentManagingTest = null;
let currentManagingTestSchoolId = null;

// متغيرات النوافذ المنبثقة
let currentEditingTestId = null;
let currentEditingQuestionIndex = null;

// بيانات تجريبية
const demoData = {
    schools: {}, // سيتم تحميلها من التخزين المحلي
    users: {
        'chartgain2019@gmail.com': {
            email: 'chartgain2019@gmail.com',
            password: '123456',
            name: 'أ. عبدالله الشهري',
            school: 'مدرسة الوليد بن عمارة الابتدائية',
            stage: 'ابتدائية'
        }
    }
};

// دوال التعامل مع المراحل والصفوف
function getGradeOptions(stage) {
    const grades = {
        'ابتدائية': [
            'الأول ابتدائي', 'الثاني ابتدائي', 'الثالث ابتدائي',
            'الرابع ابتدائي', 'الخامس ابتدائي', 'السادس ابتدائي'
        ],
        'متوسطة': [
            'الأول متوسط', 'الثاني متوسط', 'الثالث متوسط'
        ],
        'ثانوية': [
            'الأول ثانوي', 'الثاني ثانوي', 'الثالث ثانوي'
        ]
    };
    return grades[stage] || [];
}

function updateGradeOptions(stage, targetElementId) {
    try {
        const gradeSelect = document.getElementById(targetElementId);
        if (!gradeSelect) {
            console.warn(`Element not found: ${targetElementId}`);
            return;
        }
        
        gradeSelect.innerHTML = '<option value="">اختر الصف الدراسي</option>';
        
        if (stage) {
            const grades = getGradeOptions(stage);
            grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeSelect.appendChild(option);
            });
        }
    } catch (error) {
        ErrorHandler.logError(error, 'updateGradeOptions');
    }
}

// ========== دوال النظام الأساسية مع معالجة الأخطاء ==========

// تحميل النتائج من التخزين المحلي
function loadResults() {
    try {
        return StorageManager.getItem('testResults') || [];
    } catch (error) {
        ErrorHandler.logError(error, 'loadResults');
        return [];
    }
}

// تحميل حسابات المعلمين المحفوظة - محدثة
function loadTeacherAccounts() {
    try {
        const stored = StorageManager.getItem('teacherAccounts');
        if (stored && typeof stored === 'object') {
            Object.assign(demoData.users, stored);
        } else {
            // تهيئة البيانات الافتراضية إذا لم تكن موجودة
            StorageManager.setItem('teacherAccounts', demoData.users);
        }
    } catch (error) {
        ErrorHandler.logError(error, 'loadTeacherAccounts');
        // إعادة تهيئة البيانات في حالة الخطأ
        StorageManager.setItem('teacherAccounts', demoData.users);
    }
}

function checkAdminPermissions() {
    try {
        // 1. البحث عن عنصر أدوات التصحيح في الصفحة
        const debugToolsSection = document.getElementById('debugToolsSection');
        
        // 2. إذا لم يوجد العنصر، نوقف التنفيذ
        if (!debugToolsSection) {
            console.warn('عنصر أدوات التصحيح غير موجود');
            return;
        }
        
        // 3. التحقق من أن المستخدم الحالي هو المسؤول المحدد
        if (currentUser && currentUser.email === 'chartgain2019@gmail.com') {
            // 4. إذا كان المسؤول، نظهر الأدوات
            debugToolsSection.classList.remove('hidden');
            console.log('✅ تم تفعيل أدوات التصحيح للمسؤول');
        } else {
            // 5. إذا لم يكن المسؤول، نخفي الأدوات
            debugToolsSection.classList.add('hidden');
        }
    } catch (error) {
        // 6. معالجة أي أخطاء قد تحدث
        ErrorHandler.logError(error, 'checkAdminPermissions');
    }
}

// حفظ النتائج في التخزين المحلي
function saveResult(result) {
    try {
        result.timestamp = Date.now();
        const results = loadResults();
        results.push(result);
        
        const success = StorageManager.setItem('testResults', results);
        if (!success) {
            throw new Error('Failed to save result to storage');
        }
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'saveResult');
        return false;
    }
}

async function searchSchools() {
    try {
        const searchTerm = document.getElementById('schoolSearch')?.value.toLowerCase().trim() || '';
        const resultsContainer = document.getElementById('schoolSearchResults');
        
        if (!resultsContainer) return;
        
        // إخفاء النتائج إذا كان البحث أقل من حرفين
        if (searchTerm.length < 2) {
            resultsContainer.classList.add('hidden');
            return;
        }
        
        console.log('🔍 بحث عن:', searchTerm);
        
        let allSchools = [];
        
        try {
            // محاولة جلب البيانات من الخادم
            const response = await fetch('https://quiz-system-api.onrender.com/api/all-schools', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                allSchools = Array.isArray(data) ? data : [];
                console.log('✅ تم جلب البيانات من الخادم:', allSchools.length, 'مدرسة');
            } else {
                throw new Error(`خطأ في الاستجابة: ${response.status}`);
            }
        } catch (error) {
            console.error('❌ خطأ في الاتصال بالخادم:', error);
            // استخدام البيانات المحلية كبديل
            allSchools = Object.values(demoData.schools).map(school => ({
                id: school.id,
                name: school.name,
                teacher: school.teacher
            }));
            console.log('🔄 استخدام البيانات المحلية:', allSchools.length, 'مدرسة');
        }
        
        // البحث في النتائج
        const matchingSchools = allSchools.filter(school => 
            school.name && school.name.toLowerCase().includes(searchTerm)
        );
        
        // عرض النتائج
        if (matchingSchools.length === 0) {
            resultsContainer.innerHTML = '<div class="p-4 text-center text-gray-500">لا توجد نتائج مطابقة</div>';
        } else {
            let resultsHTML = '';
            matchingSchools.forEach(school => {
                resultsHTML += `
                    <div class="p-4 border-b border-gray-200 hover:bg-blue-50 cursor-pointer transition-all" 
                         onclick="('${school.id}')">
                        <div class="font-bold text-gray-800">${school.name}</div>
                        <div class="text-sm text-gray-600">${school.teacher || 'غير محدد'}</div>
                    </div>
                `;
            });
            resultsContainer.innerHTML = resultsHTML;
        }
        
        resultsContainer.classList.remove('hidden');
        
    } catch (error) {
        console.error('خطأ في البحث:', error);
        const resultsContainer = document.getElementById('schoolSearchResults');
        if (resultsContainer) {
            resultsContainer.innerHTML = '<div class="p-4 text-center text-red-500">خطأ في البحث</div>';
            resultsContainer.classList.remove('hidden');
        }
    }
}

async function selectSearchedSchool(schoolId) {
    try {
        const schoolSearch = document.getElementById('schoolSearch');
        const searchResults = document.getElementById('schoolSearchResults');
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        
        if (schoolSearch) schoolSearch.value = '';
        if (searchResults) searchResults.classList.add('hidden');
        
        console.log(`🏫 جاري تحميل بيانات المدرسة: ${schoolId}`);
        
        let school = null;

// استخدام البيانات المحلية أولاً (حيث يتم حفظ الاختبارات الجديدة)
school = demoData.schools[schoolId];

if (school && school.tests && school.tests.length > 0) {
    console.log('✅ استخدام البيانات المحلية التي تحتوي على الاختبارات الجديدة');
} else {
    console.log('❌ لا توجد بيانات محلية، جلب من الخادم...');
    // محاولة جلب البيانات من الخادم كبديل
    try {
        const response = await fetch(`https://quiz-system-api.onrender.com/api/tests/${schoolId}`);
        if (response.ok) {
            const tests = await response.json();
            school = {
                id: schoolId,
                name: 'مدرسة الوليد بن عمارة الابتدائية',
                teacher: 'أ. عبدالله الشهري', 
                tests: tests
            };
            // حفظ البيانات من الخادم في التخزين المحلي
            demoData.schools[schoolId] = school;
            StorageManager.setItem('demoSchoolsData', demoData.schools);
        }
    } catch (error) {
        console.error('❌ خطأ في جلب البيانات من الخادم:', error);
    }
}
                console.log('✅ تم جلب الاختبارات من الخادم:', tests);
                
                // حفظ البيانات في demoData للمستقبل
                demoData.schools[schoolId] = school;
                StorageManager.setItem('demoSchoolsData', demoData.schools);
                
            } else {
                console.error('❌ فشل في جلب الاختبارات من الخادم');
                throw new Error('فشل في جلب البيانات من الخادم');
            }
        } catch (error) {
            console.error('❌ خطأ في جلب البيانات من الخادم:', error);
            
            // استخدام البيانات المحلية كبديل
            school = demoData.schools[schoolId];
            
            if (!school) {
                console.warn('❌ المدرسة غير موجودة في البيانات المحلية، استخدام بيانات افتراضية');
                school = {
                    id: schoolId,
                    name: 'مدرسة الوليد بن عمارة الابتدائية',
                    teacher: 'أ. عبدالله الشهري',
                    tests: [
                        {
                            name: 'اختبار الرياضيات الفصل الأول',
                            subject: 'الرياضيات',
                            grade: 'الرابع ابتدائي',
                            timerPerQuestion: 30,
                            questions: [
                                {
                                    question: 'ما هو ناتج 15 + 27؟',
                                    options: ['42', '32', '52', '37'],
                                    correct: 0
                                },
                                {
                                    question: 'ما هو العدد الذي يمثل خمسة وعشرين؟',
                                    options: ['52', '25', '205', '250'],
                                    correct: 1
                                }
                            ]
                        },
                        {
                            name: 'اختبار العلوم الفصل الأول', 
                            subject: 'العلوم',
                            grade: 'الرابع ابتدائي',
                            timerPerQuestion: 30,
                            questions: [
                                {
                                    question: 'أي من هذه الكواكب أقرب إلى الشمس؟',
                                    options: ['الزهرة', 'المريخ', 'عطارد', 'الأرض'],
                                    correct: 2
                                }
                            ]
                        }
                    ]
                };
                
                // حفظ المدرسة الافتراضية في البيانات المحلية
                demoData.schools[schoolId] = school;
                StorageManager.setItem('demoSchoolsData', demoData.schools);
            }
        }
        
        // عرض معلومات المدرسة
        if (selectedSchoolInfo && school) {
            selectedSchoolInfo.dataset.schoolId = school.id;
            selectedSchoolInfo.classList.remove('hidden');
            
            // تحديث معلومات المدرسة
            const chosenSchoolName = document.getElementById('chosenSchoolName');
            const chosenTeacher = document.getElementById('chosenTeacher');
            
            if (chosenSchoolName) chosenSchoolName.textContent = school.name;
            if (chosenTeacher) chosenTeacher.textContent = school.teacher;
            
            // تحديث قائمة الاختبارات
            const testSelect = document.getElementById('testSelect');
            if (testSelect) {
                testSelect.innerHTML = '<option value="">اختر الاختبار</option>';
                
                // التحقق من وجود الاختبارات وصحتها
                if (school.tests && Array.isArray(school.tests) && school.tests.length > 0) {
                    let validTestsCount = 0;
                    
                    school.tests.forEach((test, index) => {
                        // التحقق من أن الاختبار يحتوي على البيانات الأساسية
                        if (test && test.name && test.subject && test.grade) {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
                            option.dataset.testIndex = index;
                            testSelect.appendChild(option);
                            validTestsCount++;
                        } else {
                            console.warn(`⚠️ اختبار غير صالح في الفهرس ${index}:`, test);
                        }
                    });
                    
                    if (validTestsCount === 0) {
                        testSelect.innerHTML = '<option value="">لا توجد اختبارات صالحة</option>';
                        console.warn('❌ لا توجد اختبارات صالحة في المدرسة');
                    } else {
                        console.log(`✅ تم تحميل ${validTestsCount} اختبار صالح`);
                    }
                } else {
                    testSelect.innerHTML = '<option value="">لا توجد اختبارات</option>';
                    console.warn('❌ لا توجد اختبارات للمدرسة أو البيانات غير صالحة');
                }
                
                // إعادة تعيين النماذج الأخرى
                const testInfo = document.getElementById('testInfo');
                const studentForm = document.getElementById('studentForm');
                
                if (testInfo) testInfo.classList.add('hidden');
                if (studentForm) studentForm.classList.add('hidden');
            }
        } else {
            console.error('❌ عناصر العرض غير موجودة');
            alert('❌ حدث خطأ في تحميل بيانات المدرسة');
        }
        
    } catch (error) {
        console.error('❌ خطأ في تحميل المدرسة:', error);
        ErrorHandler.logError(error, 'selectSearchedSchool');
        
        // عرض رسالة خطأ للمستخدم
        alert('❌ حدث خطأ في تحميل بيانات المدرسة. يرجى المحاولة مرة أخرى.');
        
        // إخفاء نتائج البحث
        const searchResults = document.getElementById('schoolSearchResults');
        if (searchResults) searchResults.classList.add('hidden');
    }
}

// دالة مساعدة لعرض معلومات المدرسة
function displaySchoolInfo(school) {
    const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
    
    if (selectedSchoolInfo) {
        selectedSchoolInfo.dataset.schoolId = school.id;
        
        // عرض معلومات المدرسة المختارة
        selectedSchoolInfo.classList.remove('hidden');
        document.getElementById('chosenSchoolName').textContent = school.name;
        document.getElementById('chosenTeacher').textContent = school.teacher;
        
        // تحديث قائمة الاختبارات
        const testSelect = document.getElementById('testSelect');
        if (testSelect) {
            testSelect.innerHTML = '<option value="">اختر الاختبار</option>';
            
            if (school.tests && school.tests.length > 0) {
                school.tests.forEach((test, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
                    testSelect.appendChild(option);
                });
            } else {
                testSelect.innerHTML = '<option value="">لا توجد اختبارات</option>';
            }
        }
    }
}

// وظائف الشاشة الرئيسية
function showStudentAccess() {
    try {
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('studentAccessScreen').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showStudentAccess');
    }
}

function showTeacherLogin() {
    try {
        document.getElementById('teacherLoginScreen').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherLogin');
    }
}

function closeTeacherLogin() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        const loginError = document.getElementById('loginError');
        if (loginError) loginError.classList.add('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'closeTeacherLogin');
    }
}

function goBackToWelcome() {
    try {
        // تنظيف الموارد أولاً
        ResourceManager.cleanup();
        
        // إخفاء جميع الشاشات
        const screens = [
            'studentAccessScreen',
            'teacherDashboard', 
            'testScreen',
            'resultsScreen'
        ];
        
        screens.forEach(screen => {
            const element = document.getElementById(screen);
            if (element) element.classList.add('hidden');
        });
        
        // إظهار الشاشة الرئيسية
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // إعادة تعيين حقول البحث
        const schoolSearch = document.getElementById('schoolSearch');
        const searchResults = document.getElementById('schoolSearchResults');
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        
        if (schoolSearch) schoolSearch.value = '';
        if (searchResults) searchResults.classList.add('hidden');
        if (selectedSchoolInfo) selectedSchoolInfo.classList.add('hidden');
        
        // تحديث الإحصائيات
        updateWelcomeStatistics();
    } catch (error) {
        ErrorHandler.logError(error, 'goBackToWelcome');
    }
}

// وظائف إنشاء حساب المعلم
function showTeacherSignup() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        document.getElementById('teacherSignupScreen').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherSignup');
    }
}

function closeTeacherSignup() {
    try {
        document.getElementById('teacherSignupScreen').classList.add('hidden');
        const signupError = document.getElementById('signupError');
        const signupSuccess = document.getElementById('signupSuccess');
        const signupForm = document.getElementById('teacherSignupForm');
        
        if (signupError) signupError.classList.add('hidden');
        if (signupSuccess) signupSuccess.classList.add('hidden');
        if (signupForm) signupForm.reset();
    } catch (error) {
        ErrorHandler.logError(error, 'closeTeacherSignup');
    }
}
// وظائف إنشاء حساب المعلم - النسخة المعدلة للخادم
function showTeacherSignup() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        document.getElementById('teacherSignupScreen').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherSignup');
    }
}

function closeTeacherSignup() {
    try {
        document.getElementById('teacherSignupScreen').classList.add('hidden');
        const signupError = document.getElementById('signupError');
        const signupSuccess = document.getElementById('signupSuccess');
        const signupForm = document.getElementById('teacherSignupForm');
        
        if (signupError) signupError.classList.add('hidden');
        if (signupSuccess) signupSuccess.classList.add('hidden');
        if (signupForm) signupForm.reset();
    } catch (error) {
        ErrorHandler.logError(error, 'closeTeacherSignup');
    }
}

async function teacherSignup(event) {
    try {
        event.preventDefault();
        
        const name = DataValidator.sanitizeInput(document.getElementById('newTeacherName').value);
        const email = DataValidator.sanitizeInput(document.getElementById('newTeacherEmail').value);
        const school = DataValidator.sanitizeInput(document.getElementById('newTeacherSchool').value);
        const stage = document.getElementById('newTeacherStage').value;
        const password = document.getElementById('newTeacherPassword').value;
        const confirmPassword = document.getElementById('confirmTeacherPassword').value;
        
        const errorDiv = document.getElementById('signupError');
        const successDiv = document.getElementById('signupSuccess');
        
        // إخفاء الرسائل السابقة
        if (errorDiv) errorDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
        
        // التحقق من صحة البيانات
        const validationErrors = [];
        
        if (!DataValidator.validateEmail(email)) {
            validationErrors.push('البريد الإلكتروني غير صحيح');
        }
        
        const passwordError = DataValidator.validatePassword(password);
        if (passwordError) {
            validationErrors.push(passwordError);
        }
        
        if (password !== confirmPassword) {
            validationErrors.push('كلمة المرور وتأكيدها غير متطابقتين');
        }
        
        if (!stage) {
            validationErrors.push('يرجى اختيار المرحلة الدراسية');
        }
        
        if (validationErrors.length > 0) {
            if (errorDiv) {
                errorDiv.textContent = validationErrors.join('\n');
                errorDiv.classList.remove('hidden');
            }
            return false;
        }
        
        // استخدام API للتسجيل
        const result = await APIService.register({
            name, email, password, school, stage
        });
        
        if (result.success) {
            if (successDiv) {
                successDiv.textContent = 'تم إنشاء الحساب بنجاح! يمكنك الآن تسجيل الدخول';
                successDiv.classList.remove('hidden');
            }
            
            // العودة لشاشة تسجيل الدخول بعد 2 ثانية
            setTimeout(() => {
                closeTeacherSignup();
                showTeacherLogin();
            }, 2000);
        }
        
        return true;
    } catch (error) {
        const errorDiv = document.getElementById('signupError');
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
        }
        return false;
    }
}

// تسجيل دخول المعلم - النسخة المعدلة للخادم
async function teacherLogin(event) {
    try {
        event.preventDefault();
        
        const email = document.getElementById('teacherEmail').value;
        const password = document.getElementById('teacherPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        if (!errorDiv) {
            ErrorHandler.logError(new Error('Login error element not found'), 'teacherLogin');
            return false;
        }
        
        // استخدام API لتسجيل الدخول
        const result = await APIService.login({ email, password });
        
        if (result.success) {
            currentUser = result.user;
            closeTeacherLogin();
            showTeacherDashboard();
            return true;
        } else {
            errorDiv.textContent = result.error || 'بيانات الدخول غير صحيحة';
            errorDiv.classList.remove('hidden');
            return false;
        }
    } catch (error) {
        const errorDiv = document.getElementById('loginError');
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
        }
        return false;
    }
}

// دالة لتحميل المدارس للمعلمين المسجلين مسبقاً
function loadSchoolsForExistingTeachers() {
    try {
        console.log('بدء تحميل المدارس للمعلمين الحاليين...');
        
        // إضافة مدارس لجميع المعلمين المسجلين
        for (const email in demoData.users) {
            const teacher = demoData.users[email];
            let teacherHasSchool = false;
            
            // التحقق إذا كان للمعلم مدرسة مسجلة
            for (const schoolId in demoData.schools) {
                if (demoData.schools[schoolId].teacher === teacher.name) {
                    teacherHasSchool = true;
                    console.log('المعلم لديه مدرسة مسجلة:', teacher.name);
                    break;
                }
            }
            
            // إذا لم يكن للمعلم مدرسة، قم بإنشاء واحدة
            if (!teacherHasSchool && teacher.school) {
                const newSchoolId = 'school_' + Date.now() + '_' + email;
                demoData.schools[newSchoolId] = {
                    id: newSchoolId,
                    name: teacher.school,
                    teacher: teacher.name,
                    tests: []
                };
                
                console.log('تم إنشاء مدرسة جديدة للمعلم:', teacher.name, '- المدرسة:', teacher.school);
            }
        }
        
        // حفظ التحديثات في التخزين المحلي
        if (Object.keys(demoData.schools).length > 0) {
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            console.log('تم حفظ بيانات المدارس:', Object.keys(demoData.schools).length, 'مدرسة');
        }
    } catch (error) {
        ErrorHandler.logError(error, 'loadSchoolsForExistingTeachers');
    }
}

// تسجيل دخول المعلم
// وظائف إنشاء حساب المعلم - النسخة المعدلة للخادم
function showTeacherSignup() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        document.getElementById('teacherSignupScreen').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherSignup');
    }
}

function closeTeacherSignup() {
    try {
        document.getElementById('teacherSignupScreen').classList.add('hidden');
        const signupError = document.getElementById('signupError');
        const signupSuccess = document.getElementById('signupSuccess');
        const signupForm = document.getElementById('teacherSignupForm');
        
        if (signupError) signupError.classList.add('hidden');
        if (signupSuccess) signupSuccess.classList.add('hidden');
        if (signupForm) signupForm.reset();
    } catch (error) {
        ErrorHandler.logError(error, 'closeTeacherSignup');
    }
}

async function teacherSignup(event) {
    try {
        event.preventDefault();
        
        const name = DataValidator.sanitizeInput(document.getElementById('newTeacherName').value);
        const email = DataValidator.sanitizeInput(document.getElementById('newTeacherEmail').value);
        const school = DataValidator.sanitizeInput(document.getElementById('newTeacherSchool').value);
        const stage = document.getElementById('newTeacherStage').value;
        const password = document.getElementById('newTeacherPassword').value;
        const confirmPassword = document.getElementById('confirmTeacherPassword').value;
        
        const errorDiv = document.getElementById('signupError');
        const successDiv = document.getElementById('signupSuccess');
        
        // إخفاء الرسائل السابقة
        if (errorDiv) errorDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
        
        // التحقق من صحة البيانات
        const validationErrors = [];
        
        if (!DataValidator.validateEmail(email)) {
            validationErrors.push('البريد الإلكتروني غير صحيح');
        }
        
        const passwordError = DataValidator.validatePassword(password);
        if (passwordError) {
            validationErrors.push(passwordError);
        }
        
        if (password !== confirmPassword) {
            validationErrors.push('كلمة المرور وتأكيدها غير متطابقتين');
        }
        
        if (!stage) {
            validationErrors.push('يرجى اختيار المرحلة الدراسية');
        }
        
        if (validationErrors.length > 0) {
            if (errorDiv) {
                errorDiv.textContent = validationErrors.join('\n');
                errorDiv.classList.remove('hidden');
            }
            return false;
        }
        
        // استخدام API للتسجيل
        const result = await APIService.register({
            name, email, password, school, stage
        });
        
        if (result.success) {
            if (successDiv) {
                successDiv.textContent = 'تم إنشاء الحساب بنجاح! يمكنك الآن تسجيل الدخول';
                successDiv.classList.remove('hidden');
            }
            
            // العودة لشاشة تسجيل الدخول بعد 2 ثانية
            setTimeout(() => {
                closeTeacherSignup();
                showTeacherLogin();
            }, 2000);
        }
        
        return true;
    } catch (error) {
        const errorDiv = document.getElementById('signupError');
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
        }
        return false;
    }
}

// تسجيل دخول المعلم - النسخة المعدلة للخادم
async function teacherLogin(event) {
    try {
        event.preventDefault();
        
        const email = document.getElementById('teacherEmail').value;
        const password = document.getElementById('teacherPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        if (!errorDiv) {
            ErrorHandler.logError(new Error('Login error element not found'), 'teacherLogin');
            return false;
        }
        
        // استخدام API لتسجيل الدخول
        const result = await APIService.login({ email, password });
        
        if (result.success) {
            currentUser = result.user;
            closeTeacherLogin();
            showTeacherDashboard();
            return true;
        } else {
            errorDiv.textContent = result.error || 'بيانات الدخول غير صحيحة';
            errorDiv.classList.remove('hidden');
            return false;
        }
    } catch (error) {
        const errorDiv = document.getElementById('loginError');
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
        }
        return false;
    }
}

function teacherLogout() {
    try {
        // تنظيف الموارد
        ResourceManager.cleanup();
        SystemRecovery.clearSession();
        
        currentUser = null;
        document.getElementById('teacherDashboard').classList.add('hidden');
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // تحديث الإحصائيات
        updateWelcomeStatistics();
    } catch (error) {
        ErrorHandler.logError(error, 'teacherLogout');
    }
}

function selectTest() {
    try {
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const testSelect = document.getElementById('testSelect');
        
        if (!selectedSchoolInfo || !testSelect) {
            console.warn('Required elements not found for selectTest');
            return;
        }
        
        const schoolId = selectedSchoolInfo.dataset.schoolId;
        const testIndex = testSelect.value;
        
        if (!schoolId || testIndex === '') {
            const testInfo = document.getElementById('testInfo');
            const studentForm = document.getElementById('studentForm');
            
            if (testInfo) testInfo.classList.add('hidden');
            if (studentForm) studentForm.classList.add('hidden');
            return;
        }
        
        // البحث عن المدرسة في البيانات المحلية أولاً
        let school = demoData.schools[schoolId];
        
        // إذا لم توجد في البيانات المحلية، استخدم البيانات من الخادم
        if (!school) {
            console.warn('المدرسة غير موجودة في البيانات المحلية، استخدام البيانات من الخادم');
            // إنشاء كائن مدرسة من البيانات المخزنة في العنصر
            school = {
                id: schoolId,
                name: document.getElementById('chosenSchoolName')?.textContent || 'مدرسة غير معروفة',
                teacher: document.getElementById('chosenTeacher')?.textContent || 'معلم غير معروف',
                tests: []
            };
        }
        
        // التحقق من وجود الاختبارات
        if (!school.tests || !Array.isArray(school.tests)) {
            console.error('لا توجد اختبارات للمدرسة:', schoolId);
            const testInfo = document.getElementById('testInfo');
            const studentForm = document.getElementById('studentForm');
            
            if (testInfo) {
                testInfo.innerHTML = `
                    <h3 class="font-bold text-red-800 mb-4">⚠️ خطأ في البيانات</h3>
                    <div class="text-red-600">
                        لا توجد اختبارات متاحة لهذه المدرسة حالياً.
                    </div>
                `;
                testInfo.classList.remove('hidden');
            }
            if (studentForm) studentForm.classList.add('hidden');
            return;
        }
        
        const test = school.tests[testIndex];
        
        if (!test) {
            console.error('الاختبار غير موجود:', testIndex);
            const testInfo = document.getElementById('testInfo');
            const studentForm = document.getElementById('studentForm');
            
            if (testInfo) {
                testInfo.innerHTML = `
                    <h3 class="font-bold text-red-800 mb-4">⚠️ خطأ في البيانات</h3>
                    <div class="text-red-600">
                        الاختبار المحدد غير موجود.
                    </div>
                `;
                testInfo.classList.remove('hidden');
            }
            if (studentForm) studentForm.classList.add('hidden');
            return;
        }
        
        // تحديث معلومات الاختبار
        const testInfo = document.getElementById('testInfo');
        if (testInfo) {
            testInfo.innerHTML = `
                <h3 class="font-bold text-blue-800 mb-4">معلومات الاختبار</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-blue-600 font-semibold">📖 المادة:</span>
                        <span class="font-bold text-gray-800 mr-2">${test.subject || 'غير محدد'}</span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">❓ عدد الأسئلة:</span>
                        <span class="font-bold text-gray-800 mr-2">${test.questions ? test.questions.length : 0}</span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">🎒 الصف الدراسي:</span>
                        <span class="font-bold text-gray-800 mr-2">${test.grade || 'غير محدد'}</span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">⏱️ وقت السؤال:</span>
                        <span class="font-bold text-gray-800 mr-2">${test.timerPerQuestion || 30} ثانية</span>
                    </div>
                </div>
            `;
            testInfo.classList.remove('hidden');
        }
        
        // تعبئة الصف الدراسي تلقائياً في نموذج الطالب
        const studentGradeSelect = document.getElementById('studentGrade');
        if (studentGradeSelect && test.grade) {
            studentGradeSelect.innerHTML = `<option value="${test.grade}" selected>${test.grade}</option>`;
        }
        
        const studentForm = document.getElementById('studentForm');
        if (studentForm) studentForm.classList.remove('hidden');
        
    } catch (error) {
        console.error('❌ خطأ في selectTest:', error);
        ErrorHandler.logError(error, 'selectTest');
        
        // عرض رسالة خطأ للمستخدم
        const testInfo = document.getElementById('testInfo');
        if (testInfo) {
            testInfo.innerHTML = `
                <h3 class="font-bold text-red-800 mb-4">⚠️ حدث خطأ</h3>
                <div class="text-red-600">
                    تعذر تحميل معلومات الاختبار. يرجى المحاولة مرة أخرى.
                </div>
            `;
            testInfo.classList.remove('hidden');
        }
    }
}

// بدء الاختبار
function startTest() {
    try {
        const name = DataValidator.sanitizeInput(document.getElementById('studentName')?.value || '');
        const studentGrade = document.getElementById('studentGrade')?.value || '';
        const studentClass = DataValidator.sanitizeInput(document.getElementById('studentClass')?.value || '');
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const testSelect = document.getElementById('testSelect');
        
        if (!selectedSchoolInfo || !testSelect) {
            alert('عناصر النظام غير متوفرة. يرجى تحديث الصفحة.');
            return;
        }
        
        const schoolId = selectedSchoolInfo.dataset.schoolId;
        const testIndex = testSelect.value;
        
        // التحقق من صحة البيانات
        const validation = DataValidator.validateStudentData({
            name: name,
            grade: studentGrade,
            class: studentClass
        });
        
        if (!validation.isValid) {
            alert(`يرجى تصحيح الأخطاء التالية:\n${validation.errors.join('\n')}`);
            return;
        }
        
        if (!schoolId || testIndex === '') {
            alert('يرجى اختيار المدرسة والاختبار أولاً');
            return;
        }
        
        const school = demoData.schools[schoolId];
        if (!school) {
            alert('المدرسة المحددة غير موجودة');
            return;
        }
        
        currentTest = school.tests[testIndex];
        if (!currentTest) {
            alert('الاختبار المحدد غير موجود');
            return;
        }
        
        // التحقق من صحة بيانات الاختبار
        const testValidation = DataValidator.validateTestData(currentTest);
        if (!testValidation.isValid) {
            alert(`خطأ في بيانات الاختبار:\n${testValidation.errors.join('\n')}`);
            return;
        }
        
        studentData = {
            name: name,
            grade: studentGrade,
            class: studentClass,
            score: 0,
            answers: [],
            school: school.name,
            teacher: school.teacher
        };
        
        currentQuestionIndex = 0;
        
        document.getElementById('studentAccessScreen').classList.add('hidden');
        document.getElementById('testScreen').classList.remove('hidden');
        
        updateTestInfo();
        showQuestion();
        
        // حفظ حالة الجلسة
        SystemRecovery.saveSession({
            testInProgress: true,
            studentData: studentData,
            currentTest: currentTest.name,
            currentQuestionIndex: currentQuestionIndex
        });
    } catch (error) {
        ErrorHandler.logError(error, 'startTest');
        alert('فشل في بدء الاختبار. يرجى المحاولة مرة أخرى.');
    }
}

function updateTestInfo() {
    try {
        const elements = {
            testSchoolName: document.getElementById('testSchoolName'),
            testSubjectName: document.getElementById('testSubjectName'),
            testGradeLevel: document.getElementById('testGradeLevel'),
            testStudentName: document.getElementById('testStudentName'),
            totalQuestions: document.getElementById('totalQuestions')
        };
        
        if (elements.testSchoolName) elements.testSchoolName.textContent = studentData.school;
        if (elements.testSubjectName) elements.testSubjectName.textContent = currentTest.subject;
        if (elements.testGradeLevel) elements.testGradeLevel.textContent = currentTest.grade;
        if (elements.testStudentName) elements.testStudentName.textContent = studentData.name;
        if (elements.totalQuestions) elements.totalQuestions.textContent = currentTest.questions.length;
    } catch (error) {
        ErrorHandler.logError(error, 'updateTestInfo');
    }
}

// عرض السؤال
function showQuestion() {
    try {
        if (currentQuestionIndex >= currentTest.questions.length) {
            endTest();
            return;
        }
        
        const question = currentTest.questions[currentQuestionIndex];
        
        const currentQuestionElement = document.getElementById('currentQuestion');
        const currentScoreElement = document.getElementById('currentScore');
        const questionTextElement = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedbackArea = document.getElementById('feedbackArea');
        const progressBar = document.getElementById('progressBar');
        
        if (currentQuestionElement) currentQuestionElement.textContent = currentQuestionIndex + 1;
        if (currentScoreElement) currentScoreElement.textContent = studentData.score;
        if (questionTextElement) questionTextElement.textContent = question.question;
        
        if (optionsContainer) {
            optionsContainer.innerHTML = '';
            
            const optionLabels = ['أ', 'ب', 'ج', 'د'];
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn bg-gray-50 hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 p-4 rounded-xl text-right transition-all';
                button.onclick = () => selectAnswer(index);
                button.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">${optionLabels[index]}</span>
                        <span class="flex-1">${option}</span>
                    </div>
                `;
                optionsContainer.appendChild(button);
            });
        }
        
        if (feedbackArea) {
            feedbackArea.classList.add('hidden');
        }
        
        // تحديث شريط التقدم
        if (progressBar) {
            const progress = ((currentQuestionIndex + 1) / currentTest.questions.length) * 100;
            progressBar.style.width = progress + '%';
        }
        
        startTimer();
        
        // تحديث الجلسة
        SystemRecovery.saveSession({
            testInProgress: true,
            studentData: studentData,
            currentTest: currentTest.name,
            currentQuestionIndex: currentQuestionIndex
        });
    } catch (error) {
        ErrorHandler.logError(error, 'showQuestion');
    }
}

function startTimer() {
    try {
        // تنظيف المؤقت السابق
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
        }
        
        // استخدام وقت المؤقت المخصص للاختبار أو القيمة الافتراضية 30 ثانية
        timeLeft = currentTest.timerPerQuestion || 30;
        const timerElement = document.getElementById('timer');
        if (!timerElement) return;
        
        timerElement.textContent = timeLeft;
        timerElement.className = 'inline-block bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-2xl font-bold';
        
        timer = setInterval(() => {
            timeLeft--;
            timerElement.textContent = timeLeft;
            
            // تغيير لون المؤقت عندما يصل إلى ربع الوقت المتبقي
            const warningTime = Math.ceil((currentTest.timerPerQuestion || 30) / 4);
            if (timeLeft <= warningTime) {
                timerElement.className = 'inline-block bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-full text-2xl font-bold pulse-red';
            }
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                ResourceManager.timers.delete(timer);
                timer = null;
                timeUp();
            }
        }, 1000);
        
        ResourceManager.addTimer(timer);
    } catch (error) {
        ErrorHandler.logError(error, 'startTimer');
    }
}

function selectAnswer(selectedIndex) {
    try {
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        const question = currentTest.questions[currentQuestionIndex];
        const isCorrect = selectedIndex === question.correct;
        
        studentData.answers.push({
            questionIndex: currentQuestionIndex,
            selected: selectedIndex,
            correct: question.correct,
            isCorrect: isCorrect
        });
        
        if (isCorrect) {
            studentData.score++;
        }
        
        showFeedback(selectedIndex, question.correct, isCorrect);
        disableOptions();
        
        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
        }, 2000);
    } catch (error) {
        ErrorHandler.logError(error, 'selectAnswer');
    }
}

function timeUp() {
    try {
        const question = currentTest.questions[currentQuestionIndex];
        
        studentData.answers.push({
            questionIndex: currentQuestionIndex,
            selected: -1,
            correct: question.correct,
            isCorrect: false
        });
        
        showTimeUpFeedback(question.correct);
        disableOptions();
        
        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
        }, 2000);
    } catch (error) {
        ErrorHandler.logError(error, 'timeUp');
    }
}

function showFeedback(selectedIndex, correctIndex, isCorrect) {
    try {
        const feedbackArea = document.getElementById('feedbackArea');
        const options = document.querySelectorAll('.option-btn');
        
        if (!feedbackArea) return;
        
        if (isCorrect) {
            feedbackArea.innerHTML = '<div class="text-green-600 font-bold text-xl">✅ أحسنت! إجابة صحيحة</div>';
            feedbackArea.className = 'text-center p-4 rounded-xl mb-6 bg-green-50 border border-green-200';
            if (options[selectedIndex]) {
                options[selectedIndex].className = 'option-btn bg-green-100 border-2 border-green-500 p-4 rounded-xl text-right';
            }
        } else {
            feedbackArea.innerHTML = '<div class="text-red-600 font-bold text-xl">❌ إجابة خاطئة - الإجابة الصحيحة: ' + currentTest.questions[currentQuestionIndex].options[correctIndex] + '</div>';
            feedbackArea.className = 'text-center p-4 rounded-xl mb-6 bg-red-50 border border-red-200';
            if (options[selectedIndex]) {
                options[selectedIndex].className = 'option-btn bg-red-100 border-2 border-red-500 p-4 rounded-xl text-right';
            }
            if (options[correctIndex]) {
                options[correctIndex].className = 'option-btn bg-green-100 border-2 border-green-500 p-4 rounded-xl text-right';
            }
        }
        
        feedbackArea.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showFeedback');
    }
}

function showTimeUpFeedback(correctIndex) {
    try {
        const feedbackArea = document.getElementById('feedbackArea');
        const options = document.querySelectorAll('.option-btn');
        
        if (!feedbackArea) return;
        
        feedbackArea.innerHTML = '<div class="text-orange-600 font-bold text-xl">⏰ انتهى الوقت! الإجابة الصحيحة: ' + currentTest.questions[currentQuestionIndex].options[correctIndex] + '</div>';
        feedbackArea.className = 'text-center p-4 rounded-xl mb-6 bg-orange-50 border border-orange-200';
        
        if (options[correctIndex]) {
            options[correctIndex].className = 'option-btn bg-green-100 border-2 border-green-500 p-4 rounded-xl text-right';
        }
        
        feedbackArea.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTimeUpFeedback');
    }
}

function disableOptions() {
    try {
        const options = document.querySelectorAll('.option-btn');
        options.forEach(option => {
            option.disabled = true;
            option.onclick = null;
            option.style.cursor = 'not-allowed';
        });
    } catch (error) {
        ErrorHandler.logError(error, 'disableOptions');
    }
}

// إنهاء الاختبار
function endTest() {
    try {
        // تنظيف المؤقت
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        const percentage = Math.round((studentData.score / currentTest.questions.length) * 100);
        let grade = '';
        
        if (percentage >= 90) grade = 'ممتاز';
        else if (percentage >= 80) grade = 'جيد جداً';
        else if (percentage >= 70) grade = 'جيد';
        else if (percentage >= 60) grade = 'مقبول';
        else grade = 'ضعيف';
        
        // حفظ النتيجة
        const result = {
            id: Date.now(),
            name: studentData.name,
            grade: studentData.grade,
            class: studentData.class,
            school: studentData.school,
            teacher: studentData.teacher,
            test: currentTest.name,
            subject: currentTest.subject,
            score: studentData.score,
            total: currentTest.questions.length,
            percentage: percentage,
            gradeLevel: grade,
            date: new Date().toLocaleDateString('ar-SA'),
            answers: studentData.answers,
            timestamp: Date.now()
        };
        
        const saveSuccess = saveResult(result);
        
        if (!saveSuccess) {
            alert('فشل في حفظ النتيجة. يرجى التواصل مع المسؤول.');
        }
        
        document.getElementById('testScreen').classList.add('hidden');
        document.getElementById('resultsScreen').classList.remove('hidden');
        
        const finalScoreElement = document.getElementById('finalScore');
        const percentageElement = document.getElementById('percentage');
        const gradeElement = document.getElementById('grade');
        
        if (finalScoreElement) finalScoreElement.textContent = studentData.score + ' من ' + currentTest.questions.length;
        if (percentageElement) percentageElement.textContent = percentage + '%';
        if (gradeElement) gradeElement.textContent = grade;
        
        // تنظيف الجلسة
        SystemRecovery.clearSession();
    } catch (error) {
        ErrorHandler.logError(error, 'endTest');
    }
}

// وظائف النتائج
function shareWhatsApp() {
    try {
        const percentage = Math.round((studentData.score / currentTest.questions.length) * 100);
        let grade = '';
        
        if (percentage >= 90) grade = 'ممتاز';
        else if (percentage >= 80) grade = 'جيد جداً';
        else if (percentage >= 70) grade = 'جيد';
        else if (percentage >= 60) grade = 'مقبول';
        else grade = 'ضعيف';
        
        const message = `🎉 أتممت الاختبار: ${currentTest.name}\n🎉 الطالب: ${studentData.name}\n\n🎉 في مادة: ${currentTest.subject}\n📊 النتيجة: ${studentData.score} من ${currentTest.questions.length}\n📈 النسبة: ${percentage}%\n🏆 التقدير: ${grade}\n🎒 الصف: ${studentData.grade}\n\n#${studentData.school}`;
        
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
    } catch (error) {
        ErrorHandler.logError(error, 'shareWhatsApp');
    }
}

function retakeTest() {
    try {
        studentData.score = 0;
        studentData.answers = [];
        currentQuestionIndex = 0;
        
        document.getElementById('resultsScreen').classList.add('hidden');
        document.getElementById('testScreen').classList.remove('hidden');
        
        showQuestion();
    } catch (error) {
        ErrorHandler.logError(error, 'retakeTest');
    }
}

function goBackToSchoolSelection() {
    try {
        document.getElementById('testScreen').classList.add('hidden');
        document.getElementById('resultsScreen').classList.add('hidden');
        document.getElementById('studentAccessScreen').classList.remove('hidden');
        
        // إعادة تعيين النموذج
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const schoolSearch = document.getElementById('schoolSearch');
        
        if (selectedSchoolInfo) selectedSchoolInfo.classList.add('hidden');
        if (schoolSearch) schoolSearch.value = '';
    } catch (error) {
        ErrorHandler.logError(error, 'goBackToSchoolSelection');
    }
}

// وظائف الخروج من الاختبار
function confirmExitTest() {
    try {
        document.getElementById('exitTestModal').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'confirmExitTest');
    }
}

function cancelExitTest() {
    try {
        document.getElementById('exitTestModal').classList.add('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'cancelExitTest');
    }
}

function exitTest() {
    try {
        // تنظيف جميع الموارد
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        ResourceManager.cleanup();
        SystemRecovery.clearSession();
        
        currentTest = null;
        currentQuestionIndex = 0;
        studentData = { name: '', grade: '', class: '', score: 0, answers: [] };
        
        document.getElementById('exitTestModal').classList.add('hidden');
        document.getElementById('testScreen').classList.add('hidden');
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // تحديث الإحصائيات
        updateWelcomeStatistics();
    } catch (error) {
        ErrorHandler.logError(error, 'exitTest');
    }
}

// ========== دوال الشهادة Canvas المحسنة ==========

async function generateCertificateImage(format) {
    try {
        showLoadingMessage('جاري إنشاء الشهادة...');
        
        // الانتظار حتى يتم تحميل الخطوط والصور
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const canvas = document.getElementById('certificateCanvas');
        if (!canvas) {
            throw new Error('Canvas element not found');
        }
        
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            throw new Error('Canvas context not available');
        }
        
        // مسح Canvas أولاً
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ========== الخلفية الأساسية ==========
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#f8fafc');
        gradient.addColorStop(0.5, '#f0f4ff');
        gradient.addColorStop(1, '#fdf2ff');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ========== الزخارف الخلفية ==========
        ctx.fillStyle = 'rgba(139, 92, 246, 0.03)';
        ctx.font = 'bold 120px Arial';
        ctx.textAlign = 'center';
        
        // زخارف موزعة بشكل متساو
        ctx.fillText('🎓', canvas.width/2, 350);
        ctx.fillText('⭐', canvas.width/4, 450);
        ctx.fillText('📚', canvas.width * 3/4, 400);
        ctx.fillText('🏆', canvas.width/3, 1400);
        ctx.fillText('💫', canvas.width * 2/3, 1500);
        ctx.fillText('🎯', canvas.width/2, 2800);
        ctx.fillText('✨', canvas.width/5, 2700);
        ctx.fillText('🌟', canvas.width * 4/5, 2750);
        
        // ========== الإطار الخارجي ==========
        const borderGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        borderGradient.addColorStop(0, '#3b82f6');
        borderGradient.addColorStop(0.25, '#8b5cf6');
        borderGradient.addColorStop(0.5, '#ec4899');
        borderGradient.addColorStop(0.75, '#f59e0b');
        borderGradient.addColorStop(1, '#10b981');
        
        ctx.strokeStyle = borderGradient;
        ctx.lineWidth = 25;
        ctx.strokeRect(50, 50, canvas.width - 100, canvas.height - 100);
        
        // إطار داخلي ذهبي
        ctx.strokeStyle = '#f59e0b';
        ctx.lineWidth = 8;
        ctx.strokeRect(100, 100, canvas.width - 200, canvas.height - 200);
        
        // ========== العنوان الرئيسي ==========
        const titleGradient = ctx.createLinearGradient(canvas.width/2 - 300, 200, canvas.width/2 + 300, 200);
        titleGradient.addColorStop(0, '#f59e0b');
        titleGradient.addColorStop(0.5, '#fbbf24');
        titleGradient.addColorStop(1, '#f59e0b');
        
        ctx.fillStyle = titleGradient;
        ctx.font = 'bold 140px "Cairo"';
        ctx.textAlign = 'center';
        ctx.fillText('شهادة إنجاز', canvas.width/2, 280);
        
        // العنوان بالإنجليزية
        ctx.fillStyle = '#6b7280';
        ctx.font = 'italic 45px "Cairo"';
        ctx.fillText('Certificate of Achievement', canvas.width/2, 380);
        
        // خط زخرفي تحت العنوان
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 - 250, 410);
        ctx.lineTo(canvas.width/2 + 250, 410);
        ctx.stroke();
        
        // ========== اسم المدرسة ==========
        ctx.fillStyle = '#7c3aed';
        ctx.font = 'bold 75px "Cairo"';
        ctx.fillText(studentData.school, canvas.width/2, 530);
        
        // ========== القسم الأول: بيانات الطالب ==========
        const section1Y = 700;
        
        // النص التمهيدي
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('تشهد هذه المؤسسة التعليمية بأن الطالب/ة', canvas.width/2, section1Y);
        
        // اسم الطالب
        const nameGradient = ctx.createLinearGradient(canvas.width/2 - 400, section1Y + 100, canvas.width/2 + 400, section1Y + 220);
        nameGradient.addColorStop(0, '#7c3aed');
        nameGradient.addColorStop(0.5, '#3b82f6');
        nameGradient.addColorStop(1, '#7c3aed');
        
        ctx.fillStyle = nameGradient;
        ctx.font = 'bold 120px "Cairo"';
        ctx.fillText(studentData.name, canvas.width/2, section1Y + 180);
        
        // خط تحت اسم الطالب
        ctx.strokeStyle = '#c4b5fd';
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 - 350, section1Y + 210);
        ctx.lineTo(canvas.width/2 + 350, section1Y + 210);
        ctx.stroke();
        
        // ========== القسم الثاني: المعلومات الأكاديمية ==========
        const section2Y = 1050;
        
        // الصف والفصل
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText(`من الصف ${studentData.grade} والفصل ${studentData.class}`, canvas.width/2, section2Y);
        
        // النص التالي
        ctx.fillText('قد أتم بنجاح', canvas.width/2, section2Y + 100);
        
        // اسم الاختبار
        ctx.fillStyle = '#3b82f6';
        ctx.font = 'bold 70px "Cairo"';
        ctx.fillText(currentTest.name, canvas.width/2, section2Y + 200);
        
        // المادة
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('في مادة', canvas.width/2, section2Y + 300);
        
        ctx.fillStyle = '#10b981';
        ctx.font = 'bold 60px "Cairo"';
        ctx.fillText(currentTest.subject, canvas.width/2, section2Y + 380);
        
        // ========== القسم الثالث: النتائج ==========
        const resultsBox = {
            x: canvas.width/2 - 450,
            y: 1550,
            width: 900,
            height: 280
        };
        
        // خلفية المربع
        ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
        ctx.strokeStyle = '#d1d5db';
        ctx.lineWidth = 3;
        
        // ظل للمربع
        ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
        ctx.shadowBlur = 20;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 10;
        ctx.fillRect(resultsBox.x, resultsBox.y, resultsBox.width, resultsBox.height);
        ctx.shadowColor = 'transparent';
        ctx.strokeRect(resultsBox.x, resultsBox.y, resultsBox.width, resultsBox.height);
        
        // حساب النسبة والتقدير
        const percentage = Math.round((studentData.score / currentTest.questions.length) * 100);
        const grade = calculateGrade(percentage);
        
        // تقسيم المربع إلى 3 أجزاء
        const sectionWidth = resultsBox.width / 3;
        
        // الدرجة
        ctx.fillStyle = '#3b82f6';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('الدرجة', resultsBox.x + sectionWidth/2, resultsBox.y + 90);
        ctx.font = 'bold 75px "Cairo"';
        ctx.fillText(`${studentData.score}/${currentTest.questions.length}`, resultsBox.x + sectionWidth/2, resultsBox.y + 180);
        
        // النسبة
        ctx.fillStyle = '#10b981';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('النسبة', resultsBox.x + sectionWidth + sectionWidth/2, resultsBox.y + 90);
        ctx.font = 'bold 75px "Cairo"';
        ctx.fillText(`${percentage}%`, resultsBox.x + sectionWidth + sectionWidth/2, resultsBox.y + 180);
        
        // التقدير
        ctx.fillStyle = '#8b5cf6';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('التقدير', resultsBox.x + 2 * sectionWidth + sectionWidth/2, resultsBox.y + 90);
        ctx.font = 'bold 65px "Cairo"';
        ctx.fillText(grade, resultsBox.x + 2 * sectionWidth + sectionWidth/2, resultsBox.y + 180);
        
        // خطوط فاصلة
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(resultsBox.x + sectionWidth, resultsBox.y + 30);
        ctx.lineTo(resultsBox.x + sectionWidth, resultsBox.y + resultsBox.height - 30);
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(resultsBox.x + 2 * sectionWidth, resultsBox.y + 30);
        ctx.lineTo(resultsBox.x + 2 * sectionWidth, resultsBox.y + resultsBox.height - 30);
        ctx.stroke();
        
        // ========== القسم الرابع: رسالة تهنئة موسعة ==========
        const congratulationY = 1950;
        
        ctx.fillStyle = '#7c3aed';
        ctx.font = 'bold 65px "Cairo"';
        ctx.fillText('مبروك على إنجازك!', canvas.width/2, congratulationY);
        
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('نحن نفتخر بإنجازك المتميز ونسأل الله لك دوام التوفيق والنجاح', canvas.width/2, congratulationY + 90);
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '42px "Cairo"';
        ctx.fillText('نتمنى لك مستقبلاً زاهراً مليئاً بالإنجازات والتفوق', canvas.width/2, congratulationY + 180);
        
        // ========== القسم الخامس: التوقيعات ==========
        const signaturesY = 2300;
        
        // مدير المدرسة (على اليمين)
        ctx.textAlign = 'right';
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('مدير المدرسة', 700, signaturesY);
        ctx.fillStyle = '#1f2937';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('أ. خالد الحمرين', 700, signaturesY + 90);
        
        // خط التوقيع
        ctx.strokeStyle = '#9ca3af';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(500, signaturesY + 130);
        ctx.lineTo(800, signaturesY + 130);
        ctx.stroke();
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '38px "Cairo"';
        ctx.fillText('التوقيع', 650, signaturesY + 180);
        
        // معلم المادة (على اليسار)
        ctx.textAlign = 'left';
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('معلم المادة', canvas.width - 700, signaturesY);
        ctx.fillStyle = '#1f2937';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText(studentData.teacher, canvas.width - 700, signaturesY + 90);
        
        // خط التوقيع
        ctx.beginPath();
        ctx.moveTo(canvas.width - 800, signaturesY + 130);
        ctx.lineTo(canvas.width - 500, signaturesY + 130);
        ctx.stroke();
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '38px "Cairo"';
        ctx.fillText('التوقيع', canvas.width - 650, signaturesY + 180);
        
        // ========== القسم السادس: المعلومات الإضافية ==========
        const infoY = 2650;
        
        ctx.textAlign = 'center';
        ctx.fillStyle = '#6b7280';
        ctx.font = '38px "Cairo"';
        const date = new Date().toLocaleDateString('ar-SA');
        ctx.fillText(`تاريخ الإصدار: ${date}`, canvas.width/2, infoY);
        ctx.fillText(`رقم الشهادة: CERT-${Date.now()}`, canvas.width/2, infoY + 70);
        
        // ========== القسم السابع: زخرفة ختامية ==========
        const decorationY = 2850;
        
        // خط زخرفي
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 - 300, decorationY);
        ctx.lineTo(canvas.width/2 + 300, decorationY);
        ctx.stroke();
        
        // نقاط زخرفية
        ctx.fillStyle = '#3b82f6';
        for (let i = -4; i <= 4; i++) {
            const x = canvas.width/2 + (i * 75);
            ctx.beginPath();
            ctx.arc(x, decorationY, 12, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // رسالة شكر
        ctx.fillStyle = '#4b5563';
        ctx.font = '42px "Cairo"';
        ctx.fillText('شكراً لجهودكم المبذولة', canvas.width/2, decorationY + 90);

        // ========== الزخرفة النهائية ==========
        ctx.fillStyle = 'rgba(139, 92, 246, 0.1)';
        ctx.font = 'bold 130px Arial';
        ctx.fillText('🎉', canvas.width/2, canvas.height - 150);

        // تحويل Canvas إلى صورة
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const imageData = canvas.toDataURL(`image/${format}`, 1.0);
        downloadImage(imageData, format);
        
        // تحديث المعاينة
        updateCertificatePreview(imageData);
        
        hideLoadingMessage();
        showSuccessMessage('تم إنشاء الشهادة بنجاح', `تم حفظ الشهادة كصورة ${format.toUpperCase()}`);
        
    } catch (error) {
        console.error('خطأ في إنشاء الشهادة:', error);
        hideLoadingMessage();
        showErrorMessage('خطأ في الإنشاء', 'تعذر إنشاء الشهادة كصورة');
    }
}

// دالة حساب التقدير
function calculateGrade(percentage) {
    if (percentage >= 90) return 'ممتاز';
    else if (percentage >= 80) return 'جيد جداً';
    else if (percentage >= 70) return 'جيد';
    else if (percentage >= 60) return 'مقبول';
    else return 'ضعيف';
}

// دالة تحميل الصورة
function downloadImage(imageData, format) {
    try {
        const downloadLink = document.createElement('a');
        const fileName = `شهادة_${studentData.name}_${currentTest.name}_${new Date().toLocaleDateString('ar-SA')}.${format}`;
        
        downloadLink.href = imageData;
        downloadLink.download = fileName;
        
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    } catch (error) {
        ErrorHandler.logError(error, 'downloadImage');
    }
}

// دالة تحديث معاينة الشهادة
function updateCertificatePreview(imageData) {
    try {
        const preview = document.getElementById('certificatePreview');
        if (preview) {
            preview.innerHTML = `
                <div class="text-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">معاينة الشهادة المحسنة</h3>
                    <p class="text-gray-600">جودة عالية - تصميم احترافي</p>
                </div>
                <img src="${imageData}" alt="شهادة إنجاز" class="w-full h-auto rounded-lg shadow-2xl border-4 border-gold-200 max-h-96 object-contain mx-auto">
                <div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                    <p class="text-green-700 text-sm"><strong>✓ تم إنشاء الشهادة بنجاح:</strong> جودة عالية بدقة 2480×3508 بكسل</p>
                </div>
            `;
        }
    } catch (error) {
        ErrorHandler.logError(error, 'updateCertificatePreview');
    }
}

// دوال الرسائل
function showLoadingMessage(message) {
    try {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingOverlay';
        loadingDiv.className = 'loading-overlay';
        loadingDiv.innerHTML = `
            <div class="bg-white rounded-2xl p-8 text-center shadow-2xl">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-gray-800 font-semibold text-xl">${message}</p>
            </div>
        `;
        document.body.appendChild(loadingDiv);
    } catch (error) {
        ErrorHandler.logError(error, 'showLoadingMessage');
    }
}

function hideLoadingMessage() {
    try {
        const loadingDiv = document.getElementById('loadingOverlay');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'hideLoadingMessage');
    }
}

function showSuccessMessage(title, message) {
    try {
        const messageId = 'successMessage-' + Date.now();
        const messageHTML = `
            <div id="${messageId}" class="fixed top-4 left-4 right-4 bg-green-500 text-white p-4 rounded-xl shadow-lg z-50 flex items-center gap-3">
                <span class="text-2xl">✅</span>
                <div class="flex-1">
                    <div class="font-bold">${title}</div>
                    <div class="text-sm">${message}</div>
                </div>
                <button onclick="document.getElementById('${messageId}').remove()" class="text-white hover:text-gray-200">
                    ✕
                </button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', messageHTML);
        
        setTimeout(() => {
            const element = document.getElementById(messageId);
            if (element) element.remove();
        }, 5000);
    } catch (error) {
        ErrorHandler.logError(error, 'showSuccessMessage');
    }
}

function showErrorMessage(title, message) {
    try {
        const messageId = 'errorMessage-' + Date.now();
        const messageHTML = `
            <div id="${messageId}" class="fixed top-4 left-4 right-4 bg-red-500 text-white p-4 rounded-xl shadow-lg z-50 flex items-center gap-3">
                <span class="text-2xl">❌</span>
                <div class="flex-1">
                    <div class="font-bold">${title}</div>
                    <div class="text-sm">${message}</div>
                </div>
                <button onclick="document.getElementById('${messageId}').remove()" class="text-white hover:text-gray-200">
                    ✕
                </button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', messageHTML);
        
        setTimeout(() => {
            const element = document.getElementById(messageId);
            if (element) element.remove();
        }, 5000);
    } catch (error) {
        ErrorHandler.logError(error, 'showErrorMessage');
    }
}

// ========== لوحة تحكم المعلم المحسنة ==========

function showTeacherDashboard() {
    try {
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('teacherDashboard').classList.remove('hidden');
        
        // تحديث معلومات المعلم
        const teacherWelcome = document.getElementById('teacherWelcome');
        if (teacherWelcome) {
            teacherWelcome.textContent = `مرحباً ${currentUser.name}`;
        }
        
        // تحديث بيانات المدرسة للمعلم الحالي
        updateTeacherSchoolData();
        
        // تحميل لوحة المعلومات
        loadDashboardData();
        
        // تحميل الاختبارات
        loadTeacherTests();
        
        // تحميل قائمة الاختبارات لفلتر الأسئلة
        loadTestSelectForQuestions();
        
        // تحميل النتائج
        loadResultsForTeacher();
        
        // تحميل الإعدادات
        loadTeacherSettings();
        
        // التحقق من صلاحيات المسؤول
        checkAdminPermissions();
       // ========== ⬇️ أضف هذا السطر ⬇️ ==========
        autoFixTeacherOnLogin();
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherDashboard');
    }
}

function updateTeacherSchoolData() {
    try {
        // البحث عن مدرسة المعلم الحالي
        let teacherSchool = null;
        
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === currentUser.name) {
                teacherSchool = demoData.schools[schoolId];
                currentManagingTestSchoolId = schoolId;
                break;
            }
        }
        
        // إذا لم توجد مدرسة للمعلم، قم بإنشائها
        if (!teacherSchool) {
            const newSchoolId = 'school_' + Date.now();
            teacherSchool = {
                id: newSchoolId,
                name: currentUser.school,
                teacher: currentUser.name,
                tests: []
            };
            
            demoData.schools[newSchoolId] = teacherSchool;
            currentManagingTestSchoolId = newSchoolId;
            
            // حفظ التحديثات
            StorageManager.setItem('demoSchoolsData', demoData.schools);
        }
        
        console.log('تم تحديث بيانات المدرسة للمعلم:', currentUser.name);
    } catch (error) {
        ErrorHandler.logError(error, 'updateTeacherSchoolData');
    }
}

function showTab(tabName) {
    try {
        const tabs = ['dashboard', 'tests', 'questions', 'results', 'settings'];
        
        // تحديث التبويبات
        tabs.forEach(tab => {
            const tabBtn = document.getElementById(tab + 'Tab');
            const content = document.getElementById(tab + 'Content');
            
            if (tabBtn && content) {
                if (tab === tabName) {
                    tabBtn.classList.add('active', 'bg-white', 'text-blue-600');
                    tabBtn.classList.remove('bg-transparent', 'text-gray-600');
                    content.classList.remove('hidden');
                } else {
                    tabBtn.classList.remove('active', 'bg-white', 'text-blue-600');
                    tabBtn.classList.add('bg-transparent', 'text-gray-600');
                    content.classList.add('hidden');
                }
            }
        });
        
        // تحميل البيانات الخاصة بكل تبويب
        if (tabName === 'dashboard') {
            loadDashboardData();
        } else if (tabName === 'questions') {
            loadTestSelectForQuestions();
            // إعادة تعيين المتغيرات عند التبديل للتبويب
            draggedQuestion = null;
            dragOverQuestion = null;
        } else if (tabName === 'results') {
            loadResultsForTeacher();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'showTab');
    }
}

function loadDashboardData() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // حساب الإحصائيات
        const totalTests = currentManagingTestSchoolId ? 
            demoData.schools[currentManagingTestSchoolId]?.tests.length || 0 : 0;
        const totalStudents = teacherResults.length;
        const totalScore = teacherResults.reduce((sum, result) => sum + result.percentage, 0);
        const averageScore = totalStudents > 0 ? Math.round(totalScore / totalStudents) : 0;
        const passRate = totalStudents > 0 ? 
            Math.round((teacherResults.filter(r => r.percentage >= 60).length / totalStudents) * 100) : 0;
        
        // تحديث العناصر
        const elements = {
            totalTests: document.getElementById('totalTests'),
            totalStudents: document.getElementById('totalStudents'),
            averageScore: document.getElementById('averageScore'),
            passRate: document.getElementById('passRate'),
            totalAttempts: document.getElementById('totalAttempts'),
            highestScore: document.getElementById('highestScore'),
            lowestScore: document.getElementById('lowestScore')
        };
        
        if (elements.totalTests) elements.totalTests.textContent = totalTests;
        if (elements.totalStudents) elements.totalStudents.textContent = totalStudents;
        if (elements.averageScore) elements.averageScore.textContent = averageScore + '%';
        if (elements.passRate) elements.passRate.textContent = passRate + '%';
        if (elements.totalAttempts) elements.totalAttempts.textContent = totalStudents;
        
        if (totalStudents > 0) {
            const highest = Math.max(...teacherResults.map(r => r.percentage));
            const lowest = Math.min(...teacherResults.map(r => r.percentage));
            
            if (elements.highestScore) elements.highestScore.textContent = highest + '%';
            if (elements.lowestScore) elements.lowestScore.textContent = lowest + '%';
        }
    } catch (error) {
        ErrorHandler.logError(error, 'loadDashboardData');
    }
}

function loadTeacherTests() {
    try {
        const testsGrid = document.getElementById('testsGrid');
        if (!testsGrid) return;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests) {
            testsGrid.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-12">لا توجد اختبارات بعد</div>';
            return;
        }
        
        if (school.tests.length === 0) {
            testsGrid.innerHTML = `
                <div class="col-span-3 text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">📝</div>
                    <p class="text-lg mb-4">لا توجد اختبارات بعد</p>
                    <button onclick="showCreateTestModal()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-600 transition-all">
                        ➕ إنشاء أول اختبار
                    </button>
                </div>
            `;
            return;
        }
        
        let testsHTML = '';
        
        school.tests.forEach((test, index) => {
            testsHTML += `
                <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 hover:shadow-lg transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-xl text-gray-800">${test.name}</h4>
                        <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm">${test.subject}</span>
                    </div>
                    
                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">المادة:</span>
                            <span class="font-semibold">${test.subject}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">الصف:</span>
                            <span class="font-semibold">${test.grade}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">الأسئلة:</span>
                            <span class="font-semibold">${test.questions.length}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">الوقت:</span>
                            <span class="font-semibold">${test.timerPerQuestion || 30} ثانية</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="editTest(${index})" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold transition-all">
                            تعديل
                        </button>
                        <button onclick="deleteTest(${index})" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg text-sm font-semibold transition-all">
                            حذف
                        </button>
                    </div>
                </div>
            `;
        });
        
        testsGrid.innerHTML = testsHTML;
    } catch (error) {
        ErrorHandler.logError(error, 'loadTeacherTests');
    }
}

// ========== النوافذ المنبثقة للاختبارات ==========

function showCreateTestModal() {
    try {
        currentEditingTestId = null;
        
        const modal = document.getElementById('testModal');
        const modalTitle = document.getElementById('testModalTitle');
        const form = document.getElementById('testModalForm');
        const errorDiv = document.getElementById('testModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Test modal elements not found');
        }
        
        modalTitle.textContent = 'إنشاء اختبار جديد';
        form.reset();
        errorDiv.classList.add('hidden');
        
        // تحديث خيارات الصفوف بناءً على مرحلة المعلم
        updateGradeOptions(currentUser.stage, 'modalTestGrade');
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showCreateTestModal');
    }
}

function editTest(testIndex) {
    try {
        currentEditingTestId = testIndex;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[testIndex]) {
            alert('الاختبار غير موجود');
            return;
        }
        
        const test = school.tests[testIndex];
        const modal = document.getElementById('testModal');
        const modalTitle = document.getElementById('testModalTitle');
        const form = document.getElementById('testModalForm');
        const errorDiv = document.getElementById('testModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Test modal elements not found');
        }
        
        modalTitle.textContent = 'تعديل الاختبار';
        errorDiv.classList.add('hidden');
        
        // تعبئة بيانات الاختبار
        document.getElementById('modalTestName').value = test.name || '';
        document.getElementById('modalTestSubject').value = test.subject || '';
        document.getElementById('modalTestTimer').value = test.timerPerQuestion || 30;
        document.getElementById('modalTestDescription').value = test.description || '';
        
        // تحديث خيارات الصفوف
        updateGradeOptions(currentUser.stage, 'modalTestGrade');
        
        // تعيين الصف الحالي
        const gradeSelect = document.getElementById('modalTestGrade');
        if (gradeSelect && test.grade) {
            gradeSelect.value = test.grade;
        }
        
        // تعيين مستوى الصعوبة
        const difficultySelect = document.getElementById('modalTestDifficulty');
        if (difficultySelect && test.difficulty) {
            difficultySelect.value = test.difficulty;
        }
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'editTest');
    }
}

function closeTestModal() {
    try {
        const modal = document.getElementById('testModal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        currentEditingTestId = null;
    } catch (error) {
        ErrorHandler.logError(error, 'closeTestModal');
    }
}

function handleTestFormSubmit(event) {
    try {
        event.preventDefault();
        
        const name = DataValidator.sanitizeInput(document.getElementById('modalTestName').value);
        const subject = DataValidator.sanitizeInput(document.getElementById('modalTestSubject').value);
        const grade = document.getElementById('modalTestGrade').value;
        const timerPerQuestion = parseInt(document.getElementById('modalTestTimer').value) || 30;
        const description = DataValidator.sanitizeInput(document.getElementById('modalTestDescription').value);
        const difficulty = document.getElementById('modalTestDifficulty').value;
        
        const errorDiv = document.getElementById('testModalError');
        if (!errorDiv) {
            throw new Error('Error div not found');
        }
        
        // التحقق من صحة البيانات
        if (!name || !subject || !grade) {
            errorDiv.textContent = 'يرجى ملء جميع الحقول المطلوبة';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        if (timerPerQuestion < 10 || timerPerQuestion > 300) {
            errorDiv.textContent = 'وقت السؤال يجب أن يكون بين 10 و 300 ثانية';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school) {
            errorDiv.textContent = 'المدرسة غير موجودة';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        if (currentEditingTestId === null) {
            // إنشاء اختبار جديد
            const newTest = {
                name: name,
                subject: subject,
                grade: grade,
                timerPerQuestion: timerPerQuestion,
                description: description,
                difficulty: difficulty,
                questions: []
            };
            
            school.tests.push(newTest);
        } else {
            // تعديل اختبار موجود
            school.tests[currentEditingTestId] = {
                ...school.tests[currentEditingTestId],
                name: name,
                subject: subject,
                grade: grade,
                timerPerQuestion: timerPerQuestion,
                description: description,
                difficulty: difficulty
            };
        }
        
        // حفظ البيانات
        const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
		if (success) {
    console.log('✅ تم حفظ الاختبار الجديد في التخزين المحلي');
    
    // إذا كان الطالب في شاشة اختيار الاختبارات، قم بتحديث القائمة فوراً
    const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
    if (selectedSchoolInfo && selectedSchoolInfo.classList.contains('hidden') === false) {
        const schoolId = selectedSchoolInfo.dataset.schoolId;
        if (schoolId) {
            // تحديث قائمة الاختبارات بعد ثانيتين
            setTimeout(() => {
                refreshTestsList(schoolId);
            }, 2000);
        }
    }
    
    // مزامنة مع الخادم إذا كان متصلاً
    syncSchoolData(currentManagingTestSchoolId);
}
        if (!success) {
            errorDiv.textContent = 'فشل في حفظ البيانات';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        closeTestModal();
        loadTeacherTests();
        
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'handleTestFormSubmit');
        return false;
    }
}

function deleteTest(testIndex) {
    try {
        if (!confirm('هل أنت متأكد من حذف هذا الاختبار؟')) {
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (school && school.tests[testIndex]) {
            school.tests.splice(testIndex, 1);
            
            // حفظ البيانات
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            
            // إعادة تحميل الاختبارات
            loadTeacherTests();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'deleteTest');
    }
}

// ========== النوافذ المنبثقة للأسئلة ==========

function loadTestSelectForQuestions() {
    try {
        const testSelect = document.getElementById('questionTestSelect');
        if (!testSelect) return;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school) {
            testSelect.innerHTML = '<option value="">لا توجد اختبارات</option>';
            return;
        }
        
        testSelect.innerHTML = '<option value="">اختر الاختبار</option>';
        
        school.tests.forEach((test, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
            testSelect.appendChild(option);
        });
    } catch (error) {
        ErrorHandler.logError(error, 'loadTestSelectForQuestions');
    }
}

function loadTestQuestions() {
    try {
        const testIndex = document.getElementById('questionTestSelect').value;
        const questionsContainer = document.getElementById('questionsContainer');
        
        if (!questionsContainer) return;
        
        if (testIndex === '') {
            questionsContainer.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">❓</div>
                    <p>اختر اختباراً لعرض الأسئلة</p>
                </div>
            `;
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[testIndex]) {
            questionsContainer.innerHTML = '<div class="text-center text-red-500 py-12">الاختبار غير موجود</div>';
            return;
        }
        
        const test = school.tests[testIndex];
        currentManagingTest = testIndex;
        
        if (test.questions.length === 0) {
            questionsContainer.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">📝</div>
                    <p class="text-lg mb-4">لا توجد أسئلة في هذا الاختبار</p>
                    <button onclick="showAddQuestionModal()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-green-600 hover:to-blue-600 transition-all">
                        ➕ إضافة أول سؤال
                    </button>
                </div>
            `;
            return;
        }
        
        let questionsHTML = `
            <div class="mb-6">
                <h4 class="font-bold text-xl text-gray-800 mb-2">أسئلة اختبار: ${test.name}</h4>
                <p class="text-gray-600">عدد الأسئلة: ${test.questions.length}</p>
                <p class="text-blue-600 text-sm mt-2">🧩 يمكنك سحب الأسئلة وإفلاتها لإعادة ترتيبها</p>
            </div>
            
            <div id="questionsList" class="space-y-4">
        `;
        
        test.questions.forEach((question, index) => {
            const optionLabels = ['أ', 'ب', 'ج', 'د'];
            const correctAnswerLabel = optionLabels[question.correct];
            
            questionsHTML += `
                <div class="question-item bg-white border-2 border-gray-200 rounded-2xl p-6 transition-all duration-300 hover:shadow-lg"
                     draggable="true"
                     data-question-index="${index}"
                     ondragstart="handleDragStart(event)"
                     ondragover="handleDragOver(event)"
                     ondragenter="handleDragEnter(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event)">
                    
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="drag-handle text-gray-400 cursor-grab hover:text-gray-600 transition-all p-2 rounded-lg hover:bg-gray-100">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="9" cy="5" r="1"></circle>
                                    <circle cx="9" cy="12" r="1"></circle>
                                    <circle cx="9" cy="19" r="1"></circle>
                                    <circle cx="15" cy="5" r="1"></circle>
                                    <circle cx="15" cy="12" r="1"></circle>
                                    <circle cx="15" cy="19" r="1"></circle>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h5 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                    <span class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">${index + 1}</span>
                                    السؤال ${index + 1}
                                </h5>
                            </div>
                        </div>
                        <span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-sm font-semibold">
                            ✓ ${correctAnswerLabel}
                        </span>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-gray-700 text-lg bg-gray-50 p-4 rounded-xl border">${question.question}</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-3 mb-4">
                        ${question.options.map((option, optIndex) => `
                            <div class="flex items-center gap-3 p-3 rounded-xl border-2 ${
                                optIndex === question.correct 
                                ? 'bg-green-50 border-green-300 text-green-700' 
                                : 'bg-gray-50 border-gray-200 text-gray-700'
                            } transition-all">
                                <span class="w-8 h-8 ${
                                    optIndex === question.correct 
                                    ? 'bg-green-500 text-white' 
                                    : 'bg-gray-300 text-gray-600'
                                } rounded-full flex items-center justify-center font-bold text-sm">
                                    ${optionLabels[optIndex]}
                                </span>
                                <span class="flex-1 ${optIndex === question.correct ? 'font-semibold' : ''}">${option}</span>
                                ${optIndex === question.correct ? 
                                    '<span class="text-green-500 text-lg">✓</span>' : 
                                    ''
                                }
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex gap-2 pt-4 border-t border-gray-200">
                        <button onclick="editQuestion(${index})" 
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            تعديل
                        </button>
                        <button onclick="deleteQuestion(${index})" 
                                class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            حذف
                        </button>
                    </div>
                </div>
            `;
        });
        
        questionsHTML += `</div>`; // إغلاق questionsList
        
        questionsContainer.innerHTML = questionsHTML;
		// تهيئة أحداث السحب والإفلات بعد تأخير بسيط لضمان تحميل DOM
        setTimeout(() => {
            initDragAndDrop();
        }, 300);
        
    } catch (error) {
        ErrorHandler.logError(error, 'loadTestQuestions');
    }
}

function showAddQuestionModal() {
    try {
        if (currentManagingTest === null) {
            alert('يرجى اختيار اختبار أولاً');
            return;
        }
        
        currentEditingQuestionIndex = null;
        
        const modal = document.getElementById('questionModal');
        const modalTitle = document.getElementById('questionModalTitle');
        const form = document.getElementById('questionModalForm');
        const errorDiv = document.getElementById('questionModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Question modal elements not found');
        }
        
        modalTitle.textContent = 'إضافة سؤال جديد';
        form.reset();
        errorDiv.classList.add('hidden');
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showAddQuestionModal');
    }
}

function editQuestion(questionIndex) {
    try {
        if (currentManagingTest === null) {
            alert('لا يوجد اختبار محدد');
            return;
        }
        
        currentEditingQuestionIndex = questionIndex;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) {
            alert('الاختبار غير موجود');
            return;
        }
        
        const test = school.tests[currentManagingTest];
        const question = test.questions[questionIndex];
        
        if (!question) {
            alert('السؤال غير موجود');
            return;
        }
        
        const modal = document.getElementById('questionModal');
        const modalTitle = document.getElementById('questionModalTitle');
        const form = document.getElementById('questionModalForm');
        const errorDiv = document.getElementById('questionModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Question modal elements not found');
        }
        
        modalTitle.textContent = 'تعديل السؤال';
        errorDiv.classList.add('hidden');
        
        // تعبئة بيانات السؤال
        document.getElementById('modalQuestionText').value = question.question || '';
        document.getElementById('modalOption1').value = question.options[0] || '';
        document.getElementById('modalOption2').value = question.options[1] || '';
        document.getElementById('modalOption3').value = question.options[2] || '';
        document.getElementById('modalOption4').value = question.options[3] || '';
        document.getElementById('modalCorrectAnswer').value = question.correct || '';
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'editQuestion');
    }
}

function closeQuestionModal() {
    try {
        const modal = document.getElementById('questionModal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        currentEditingQuestionIndex = null;
    } catch (error) {
        ErrorHandler.logError(error, 'closeQuestionModal');
    }
}

function handleQuestionFormSubmit(event) {
    try {
        event.preventDefault();
        
        if (currentManagingTest === null) {
            alert('يرجى اختيار اختبار أولاً');
            return false;
        }
        
        const questionText = DataValidator.sanitizeInput(document.getElementById('modalQuestionText').value);
        const option1 = DataValidator.sanitizeInput(document.getElementById('modalOption1').value);
        const option2 = DataValidator.sanitizeInput(document.getElementById('modalOption2').value);
        const option3 = DataValidator.sanitizeInput(document.getElementById('modalOption3').value);
        const option4 = DataValidator.sanitizeInput(document.getElementById('modalOption4').value);
        const correctAnswer = parseInt(document.getElementById('modalCorrectAnswer').value);
        
        const errorDiv = document.getElementById('questionModalError');
        if (!errorDiv) {
            throw new Error('Error div not found');
        }
        
        // التحقق من صحة البيانات
        if (!questionText || !option1 || !option2 || !option3 || !option4 || isNaN(correctAnswer)) {
            errorDiv.textContent = 'يرجى ملء جميع الحقول وتحديد الإجابة الصحيحة';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        if (correctAnswer < 0 || correctAnswer > 3) {
            errorDiv.textContent = 'الإجابة الصحيحة يجب أن تكون بين 0 و 3';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) {
            errorDiv.textContent = 'الاختبار غير موجود';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const test = school.tests[currentManagingTest];
        const newQuestion = {
            question: questionText,
            options: [option1, option2, option3, option4],
            correct: correctAnswer
        };
        
        if (currentEditingQuestionIndex === null) {
            // إضافة سؤال جديد
            test.questions.push(newQuestion);
        } else {
            // تعديل سؤال موجود
            test.questions[currentEditingQuestionIndex] = newQuestion;
        }
        
        // حفظ البيانات
        const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
        if (!success) {
            errorDiv.textContent = 'فشل في حفظ البيانات';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        closeQuestionModal();
        loadTestQuestions();
        
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'handleQuestionFormSubmit');
        return false;
    }
}

function deleteQuestion(questionIndex) {
    try {
        if (currentManagingTest === null) {
            alert('لا يوجد اختبار محدد');
            return;
        }
        
        if (!confirm('هل أنت متأكد من حذف هذا السؤال؟')) {
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (school && school.tests[currentManagingTest] && school.tests[currentManagingTest].questions[questionIndex]) {
            school.tests[currentManagingTest].questions.splice(questionIndex, 1);
            
            // حفظ البيانات
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            
            // إعادة تحميل الأسئلة
            loadTestQuestions();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'deleteQuestion');
    }
}

// ========== نظام السحب والإفلات المبسط والمباشر ==========

let draggedItem = null;
let currentDragIndex = null;

// نظام السحب والإفلات المبسط
function initDragAndDrop() {
    console.log('🔄 بدء تهيئة السحب والإفلات...');
    
    const questions = document.querySelectorAll('.question-item');
    console.log(`📝 عدد الأسئلة: ${questions.length}`);
    
    questions.forEach((item, index) => {
        // إعداد السمات الأساسية
        item.setAttribute('draggable', 'true');
        item.setAttribute('data-index', index);
        
        // إزالة جميع الأحداث السابقة
        item.ondragstart = null;
        item.ondragover = null;
        item.ondragenter = null;
        item.ondragleave = null;
        item.ondrop = null;
        item.ondragend = null;
        
        // ربط الأحداث الجديدة
        item.ondragstart = function(e) {
            console.log('🎯 بدء سحب السؤال:', index);
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', index);
        };
        
        item.ondragover = function(e) {
            e.preventDefault();
        };
        
        item.ondragenter = function(e) {
            e.preventDefault();
            if (this !== e.target.closest('.question-item')) return;
            this.classList.add('drag-over');
        };
        
        item.ondragleave = function() {
            this.classList.remove('drag-over');
        };
        
        item.ondrop = function(e) {
            e.preventDefault();
            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const toIndex = parseInt(this.getAttribute('data-index'));
            
            if (fromIndex !== toIndex) {
                console.log(`🔄 نقل من ${fromIndex} إلى ${toIndex}`);
                swapQuestionPositions(fromIndex, toIndex);
            }
            
            this.classList.remove('drag-over');
        };
        
        item.ondragend = function() {
            console.log('🏁 انتهاء السحب');
            this.classList.remove('dragging');
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        };
    });
    
    console.log('✅ اكتملت تهيئة السحب والإفلات');
}

// دالة تبديل مواقع الأسئلة - نسخة مبسطة
function swapQuestionPositions(fromIndex, toIndex) {
    try {
        console.log(`🔄 تبديل السؤال ${fromIndex} مع ${toIndex}`);
        
        // التحقق من البيانات الأساسية
        if (!currentManagingTestSchoolId || currentManagingTest === null) {
            alert('❌ لم يتم تحديد الاختبار بشكل صحيح');
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests || !school.tests[currentManagingTest]) {
            alert('❌ الاختبار غير موجود');
            return;
        }
        
        const test = school.tests[currentManagingTest];
        const questions = test.questions;
        
        // التحقق من المؤشرات
        if (fromIndex < 0 || fromIndex >= questions.length || toIndex < 0 || toIndex >= questions.length) {
            alert('❌ مؤشرات الأسئلة غير صالحة');
            return;
        }
        
        // تبديل الأسئلة باستخدام طريقة بسيطة
        const temp = questions[fromIndex];
        questions[fromIndex] = questions[toIndex];
        questions[toIndex] = temp;
        
        console.log('✅ تم تبديل الأسئلة في الذاكرة');
        
        // حفظ البيانات
        const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
        if (success) {
            console.log('💾 تم حفظ البيانات بنجاح');
            // إعادة تحميل الأسئلة بعد ثانية
            setTimeout(() => {
                loadTestQuestions();
                showSuccessMessage('تم التعديل', 'تم تغيير ترتيب الأسئلة بنجاح');
            }, 1000);
        } else {
            alert('❌ فشل في حفظ البيانات');
        }
        
    } catch (error) {
        console.error('❌ خطأ في swapQuestionPositions:', error);
        alert('❌ حدث خطأ أثناء إعادة الترتيب: ' + error.message);
    }
}

// ========== دوال الشهادة ==========

function showCertificate() {
    try {
        document.getElementById('certificateScreen').classList.remove('hidden');
        
        // إنشاء معاينة أولية للشهادة
        updateCertificatePreview('');
    } catch (error) {
        ErrorHandler.logError(error, 'showCertificate');
    }
}

function closeCertificate() {
    try {
        document.getElementById('certificateScreen').classList.add('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'closeCertificate');
    }
}

// ========== دوال النتائج والتصدير ==========

function loadResultsForTeacher() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // تحديث قائمة الاختبارات للفلترة
        const filterTestSelect = document.getElementById('filterTestSelect');
        if (filterTestSelect) {
            const uniqueTests = [...new Set(teacherResults.map(r => r.test))];
            filterTestSelect.innerHTML = '<option value="">جميع الاختبارات</option>';
            uniqueTests.forEach(test => {
                const option = document.createElement('option');
                option.value = test;
                option.textContent = test;
                filterTestSelect.appendChild(option);
            });
        }
        
        // تحديث قائمة الفصول للفلترة
        const filterClassSelect = document.getElementById('filterClassSelect');
        if (filterClassSelect) {
            const uniqueClasses = [...new Set(teacherResults.map(r => r.class))];
            filterClassSelect.innerHTML = '<option value="">جميع الفصول</option>';
            uniqueClasses.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                filterClassSelect.appendChild(option);
            });
        }
        
        // تطبيق الفلاتر الحالية
        filterResults();
    } catch (error) {
        ErrorHandler.logError(error, 'loadResultsForTeacher');
    }
}

function toggleAdvancedFilters() {
    try {
        const advancedFilters = document.getElementById('advancedFilters');
        const toggleButton = document.getElementById('toggleFiltersBtn');
        
        if (advancedFilters && toggleButton) {
            if (advancedFilters.classList.contains('hidden')) {
                advancedFilters.classList.remove('hidden');
                toggleButton.textContent = 'إخفاء الفلاتر المتقدمة';
            } else {
                advancedFilters.classList.add('hidden');
                toggleButton.textContent = 'إظهار الفلاتر المتقدمة';
            }
        }
    } catch (error) {
        ErrorHandler.logError(error, 'toggleAdvancedFilters');
    }
}

function filterResults() {
    try {
        const searchName = document.getElementById('searchStudentName')?.value.toLowerCase() || '';
        const filterTest = document.getElementById('filterTestSelect')?.value || '';
        const filterClass = document.getElementById('filterClassSelect')?.value || '';
        const filterGrade = document.getElementById('filterGradeSelect')?.value || '';
        const filterPercentage = document.getElementById('filterPercentageSelect')?.value || '';
        const filterDate = document.getElementById('filterDateSelect')?.value || '';
        const filterDateFrom = document.getElementById('filterDateFrom')?.value || '';
        const filterDateTo = document.getElementById('filterDateTo')?.value || '';
        
        const results = loadResults();
        let filteredResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // تطبيق الفلاتر
        if (searchName) {
            filteredResults = filteredResults.filter(result => 
                result.name.toLowerCase().includes(searchName)
            );
        }
        
        if (filterTest) {
            filteredResults = filteredResults.filter(result => 
                result.test === filterTest
            );
        }
        
        if (filterClass) {
            filteredResults = filteredResults.filter(result => 
                result.class === filterClass
            );
        }
        
        if (filterGrade) {
            filteredResults = filteredResults.filter(result => 
                result.gradeLevel === filterGrade
            );
        }
        
        if (filterPercentage) {
            const [min, max] = filterPercentage.split('-').map(Number);
            filteredResults = filteredResults.filter(result => {
                if (max) {
                    return result.percentage >= min && result.percentage <= max;
                } else {
                    return result.percentage >= min;
                }
            });
        }
        
        if (filterDate) {
            const now = new Date();
            filteredResults = filteredResults.filter(result => {
                const resultDate = new Date(result.timestamp);
                
                switch (filterDate) {
                    case 'today':
                        return resultDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return resultDate >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        return resultDate >= monthAgo;
                    case 'custom':
                        if (filterDateFrom && filterDateTo) {
                            const fromDate = new Date(filterDateFrom);
                            const toDate = new Date(filterDateTo);
                            return resultDate >= fromDate && resultDate <= toDate;
                        }
                        return true;
                    default:
                        return true;
                }
            });
        }
        
        // عرض النتائج المفلترة
        displayFilteredResults(filteredResults);
        
        // تحديث إحصائيات الفلترة
        updateFilterStats();
    } catch (error) {
        ErrorHandler.logError(error, 'filterResults');
    }
}
function displayFilteredResults(results) {
    try {
        const tableBody = document.getElementById('resultsTableBody');
        if (!tableBody) return;
        
        if (results.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                        <div class="text-4xl mb-2">📊</div>
                        <p>لا توجد نتائج مطابقة للبحث</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        let tableHTML = '';
        
        results.sort((a, b) => b.timestamp - a.timestamp).forEach(result => {
            const date = new Date(result.timestamp).toLocaleDateString('ar-SA');
            
            tableHTML += `
                <tr class="border-b border-gray-200 hover:bg-gray-50" id="resultRow-${result.id}">
                    <td class="px-6 py-4 text-right">${result.name}</td>
                    <td class="px-6 py-4 text-right">${result.grade} - ${result.class}</td>
                    <td class="px-6 py-4 text-right">${result.test}</td>
                    <td class="px-6 py-4 text-right font-bold">${result.score}/${result.total}</td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-bold ${result.percentage >= 60 ? 'text-green-600' : 'text-red-600'}">
                            ${result.percentage}%
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${getGradeColor(result.gradeLevel)}">
                            ${result.gradeLevel}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">${date}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex gap-2 justify-end">
                            <button onclick="viewResultDetails(${result.id})" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                تفاصيل
                            </button>
                            <button onclick="deleteStudentResult(${result.id})" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"></path>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                    <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                حذف
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = tableHTML;
    } catch (error) {
        ErrorHandler.logError(error, 'displayFilteredResults');
    }
}

function getGradeColor(grade) {
    switch (grade) {
        case 'ممتاز': return 'bg-green-100 text-green-800';
        case 'جيد جداً': return 'bg-blue-100 text-blue-800';
        case 'جيد': return 'bg-yellow-100 text-yellow-800';
        case 'مقبول': return 'bg-orange-100 text-orange-800';
        case 'ضعيف': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}
function updateFilterStats() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // تطبيق الفلاتر الحالية
        const searchName = document.getElementById('searchStudentName')?.value.toLowerCase() || '';
        const filterTest = document.getElementById('filterTestSelect')?.value || '';
        const filterClass = document.getElementById('filterClassSelect')?.value || '';
        const filterGrade = document.getElementById('filterGradeSelect')?.value || '';
        const filterPercentage = document.getElementById('filterPercentageSelect')?.value || '';
        const filterDate = document.getElementById('filterDateSelect')?.value || '';
        const filterDateFrom = document.getElementById('filterDateFrom')?.value || '';
        const filterDateTo = document.getElementById('filterDateTo')?.value || '';
        
        let filteredResults = teacherResults;
        
        if (searchName) {
            filteredResults = filteredResults.filter(result => 
                result.name.toLowerCase().includes(searchName)
            );
        }
        
        if (filterTest) {
            filteredResults = filteredResults.filter(result => 
                result.test === filterTest
            );
        }
        
        if (filterClass) {
            filteredResults = filteredResults.filter(result => 
                result.class === filterClass
            );
        }
        
        if (filterGrade) {
            filteredResults = filteredResults.filter(result => 
                result.gradeLevel === filterGrade
            );
        }
        
        if (filterPercentage) {
            const [min, max] = filterPercentage.split('-').map(Number);
            filteredResults = filteredResults.filter(result => {
                if (max) {
                    return result.percentage >= min && result.percentage <= max;
                } else {
                    return result.percentage >= min;
                }
            });
        }
        
        if (filterDate) {
            const now = new Date();
            filteredResults = filteredResults.filter(result => {
                const resultDate = new Date(result.timestamp);
                
                switch (filterDate) {
                    case 'today':
                        return resultDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return resultDate >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        return resultDate >= monthAgo;
                    case 'custom':
                        if (filterDateFrom && filterDateTo) {
                            const fromDate = new Date(filterDateFrom);
                            const toDate = new Date(filterDateTo);
                            return resultDate >= fromDate && resultDate <= toDate;
                        }
                        return true;
                    default:
                        return true;
                }
            });
        }
        
        const stats = {
            count: filteredResults.length,
            average: 0,
            passRate: 0,
            highest: 0
        };
        
        if (filteredResults.length > 0) {
            stats.average = Math.round(filteredResults.reduce((sum, r) => sum + r.percentage, 0) / filteredResults.length);
            stats.passRate = Math.round((filteredResults.filter(r => r.percentage >= 60).length / filteredResults.length) * 100);
            stats.highest = Math.max(...filteredResults.map(r => r.percentage));
        }
        
        const elements = {
            filteredCount: document.getElementById('filteredCount'),
            filteredAverage: document.getElementById('filteredAverage'),
            filteredPassRate: document.getElementById('filteredPassRate'),
            filteredHighest: document.getElementById('filteredHighest')
        };
        
        if (elements.filteredCount) elements.filteredCount.textContent = stats.count;
        if (elements.filteredAverage) elements.filteredAverage.textContent = stats.average + '%';
        if (elements.filteredPassRate) elements.filteredPassRate.textContent = stats.passRate + '%';
        if (elements.filteredHighest) elements.filteredHighest.textContent = stats.highest + '%';
    } catch (error) {
        ErrorHandler.logError(error, 'updateFilterStats');
    }
}

function clearAllFilters() {
    try {
        const filterElements = [
            'searchStudentName',
            'filterTestSelect',
            'filterClassSelect',
            'filterGradeSelect',
            'filterPercentageSelect',
            'filterDateSelect',
            'filterDateFrom',
            'filterDateTo'
        ];
        
        filterElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.value = '';
            }
        });
        
        // إخفاء الفلاتر المتقدمة
        const advancedFilters = document.getElementById('advancedFilters');
        const toggleButton = document.getElementById('toggleFiltersBtn');
        
        if (advancedFilters) advancedFilters.classList.add('hidden');
        if (toggleButton) toggleButton.textContent = 'إظهار الفلاتر المتقدمة';
        
        // إعادة تطبيق الفلاتر
        filterResults();
    } catch (error) {
        ErrorHandler.logError(error, 'clearAllFilters');
    }
}
function viewResultDetails(resultId) {
    try {
        const results = loadResults();
        const result = results.find(r => r.id === resultId);
        
        if (!result) {
            alert('النتيجة غير موجودة');
            return;
        }
        
        let detailsHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" id="resultDetailsModal">
                <div class="bg-white rounded-3xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center sticky top-0">
                        <h2 class="text-2xl font-bold">تفاصيل النتيجة</h2>
                        <button onclick="document.getElementById('resultDetailsModal').remove()" class="absolute left-6 top-6 text-white hover:text-gray-200 text-2xl">
                            ✕
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-xl">
                                <div class="text-blue-600 font-semibold">اسم الطالب</div>
                                <div class="font-bold text-lg">${result.name}</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl">
                                <div class="text-green-600 font-semibold">الصف/الفصل</div>
                                <div class="font-bold text-lg">${result.grade} - ${result.class}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-xl mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">تفاصيل الاختبار</h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <span class="text-gray-600">الاختبار:</span>
                                    <span class="font-bold">${result.test}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">المادة:</span>
                                    <span class="font-bold">${result.subject}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">الدرجة:</span>
                                    <span class="font-bold">${result.score}/${result.total}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">النسبة:</span>
                                    <span class="font-bold ${result.percentage >= 60 ? 'text-green-600' : 'text-red-600'}">${result.percentage}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="font-bold text-gray-800 mb-3">تفاصيل الإجابات</h3>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
        `;
        
        result.answers.forEach((answer, index) => {
            const questionNumber = index + 1;
            const isCorrect = answer.isCorrect;
            const selectedOption = answer.selected !== -1 ? 
                `الخيار ${String.fromCharCode(1632 + answer.selected + 1)}` : 'لم يتم الإجابة';
            const correctOption = `الخيار ${String.fromCharCode(1632 + answer.correct + 1)}`;
            
            detailsHTML += `
                <div class="border border-gray-200 rounded-xl p-4 ${isCorrect ? 'bg-green-50' : 'bg-red-50'}">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold">السؤال ${questionNumber}</span>
                        <span class="px-2 py-1 rounded-full text-sm ${isCorrect ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                            ${isCorrect ? 'صحيح' : 'خاطئ'}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <div>الإجابة المختارة: ${selectedOption}</div>
                        <div>الإجابة الصحيحة: ${correctOption}</div>
                    </div>
                </div>
            `;
        });
        
        detailsHTML += `
                        </div>
                        <div class="text-center mt-6">
                            <button onclick="document.getElementById('resultDetailsModal').remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailsHTML);
        
    } catch (error) {
        ErrorHandler.logError(error, 'viewResultDetails');
    }
}
// دالة مساعدة جديدة لإغلاق نافذة التفاصيل
function closeResultDetailsModal() {
    const modal = document.getElementById('resultDetailsModal');
    if (modal) {
        modal.remove();
    }
}

// دالة حذف نتيجة الطالب
function deleteStudentResult(resultId) {
    try {
        // التحقق من صلاحيات المستخدم
        if (!currentUser) {
            alert('يجب تسجيل الدخول أولاً');
            return;
        }
        
        const results = loadResults();
        const resultIndex = results.findIndex(r => r.id === resultId);
        
        if (resultIndex === -1) {
            alert('النتيجة غير موجودة');
            return;
        }
        
        const result = results[resultIndex];
        
        // تأكيد الحذف
        const confirmationMessage = `
⚠️ تأكيد حذف النتيجة

👤 اسم الطالب: ${result.name}
🎒 الصف/الفصل: ${result.grade} - ${result.class}
📝 الاختبار: ${result.test}
📊 النتيجة: ${result.score}/${result.total} (${result.percentage}%)

هل أنت متأكد من رغبتك في حذف هذه النتيجة؟
        `.trim();
        
        if (!confirm(confirmationMessage)) {
            return;
        }
        
        // حذف النتيجة من المصفوفة
        results.splice(resultIndex, 1);
        
        // حفظ البيانات المحدثة
        const success = StorageManager.setItem('testResults', results);
        
        if (success) {
            // إزالة الصف من الجدول
            const resultRow = document.getElementById(`resultRow-${resultId}`);
            if (resultRow) {
                resultRow.remove();
            }
            
            // عرض رسالة نجاح
            showSuccessMessage('تم الحذف', `تم حذف نتيجة الطالب ${result.name} بنجاح`);
            
            // تحديث الإحصائيات
            updateFilterStats();
            
            console.log(`✅ تم حذف نتيجة الطالب: ${result.name}`);
        } else {
            alert('❌ فشل في حذف النتيجة. يرجى المحاولة مرة أخرى.');
        }
        
    } catch (error) {
        console.error('❌ خطأ في حذف النتيجة:', error);
        ErrorHandler.logError(error, 'deleteStudentResult');
        alert('❌ حدث خطأ أثناء حذف النتيجة: ' + error.message);
    }
}

// ========== دوال التصدير ==========

function exportResults() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        if (teacherResults.length === 0) {
            alert('لا توجد نتائج للتصدير');
            return;
        }
        
        let csvContent = 'data:text/csv;charset=utf-8,\uFEFF';
        csvContent += 'اسم الطالب,الصف,الفصل,الاختبار,المادة,الدرجة,الإجمالي,النسبة,التقدير,التاريخ\n';
        
        teacherResults.forEach(result => {
            const row = [
                result.name,
                result.grade,
                result.class,
                result.test,
                result.subject,
                result.score,
                result.total,
                result.percentage + '%',
                result.gradeLevel,
                result.date
            ].map(field => `"${field}"`).join(',');
            
            csvContent += row + '\n';
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `نتائج_الطلاب_${new Date().toLocaleDateString('ar-SA')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        ErrorHandler.logError(error, 'exportResults');
    }
}

function exportToExcel() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        if (teacherResults.length === 0) {
            alert('لا توجد نتائج للتصدير');
            return;
        }
        
        // إنشاء ورقة عمل
        const ws = XLSX.utils.json_to_sheet(teacherResults.map(result => ({
            'اسم الطالب': result.name,
            'الصف': result.grade,
            'الفصل': result.class,
            'الاختبار': result.test,
            'المادة': result.subject,
            'الدرجة': result.score,
            'الإجمالي': result.total,
            'النسبة': result.percentage + '%',
            'التقدير': result.gradeLevel,
            'التاريخ': result.date
        })));
        
        // إنشاء مصنف وإضافة الورقة
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'نتائج الطلاب');
        
        // تصدير الملف
        XLSX.writeFile(wb, `نتائج_الطلاب_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
    } catch (error) {
        ErrorHandler.logError(error, 'exportToExcel');
    }
}

function exportFilteredToExcel() {
    try {
        const searchName = document.getElementById('searchStudentName')?.value.toLowerCase() || '';
        const filterTest = document.getElementById('filterTestSelect')?.value || '';
        const filterClass = document.getElementById('filterClassSelect')?.value || '';
        
        const results = loadResults();
        let filteredResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // تطبيق نفس فلاتر العرض
        if (searchName) {
            filteredResults = filteredResults.filter(result => 
                result.name.toLowerCase().includes(searchName)
            );
        }
        
        if (filterTest) {
            filteredResults = filteredResults.filter(result => 
                result.test === filterTest
            );
        }
        
        if (filterClass) {
            filteredResults = filteredResults.filter(result => 
                result.class === filterClass
            );
        }
        
        if (filteredResults.length === 0) {
            alert('لا توجد نتائج مطابقة للفلاتر للتصدير');
            return;
        }
        
        // إنشاء ورقة عمل
        const ws = XLSX.utils.json_to_sheet(filteredResults.map(result => ({
            'اسم الطالب': result.name,
            'الصف': result.grade,
            'الفصل': result.class,
            'الاختبار': result.test,
            'المادة': result.subject,
            'الدرجة': result.score,
            'الإجمالي': result.total,
            'النسبة': result.percentage + '%',
            'التقدير': result.gradeLevel,
            'التاريخ': result.date
        })));
        
        // إنشاء مصنف وإضافة الورقة
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'نتائج مفلترة');
        
        // تصدير الملف
        XLSX.writeFile(wb, `نتائج_مفلترة_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
    } catch (error) {
        ErrorHandler.logError(error, 'exportFilteredToExcel');
    }
}

// ========== دوال الإعدادات ==========

function loadTeacherSettings() {
    try {
        if (!currentUser) return;
        
        // تحميل بيانات الملف الشخصي
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profileSchool = document.getElementById('profileSchool');
        const profileStage = document.getElementById('profileStage');
        
        if (profileName) profileName.value = currentUser.name || '';
        if (profileEmail) profileEmail.value = currentUser.email || '';
        if (profileSchool) profileSchool.value = currentUser.school || '';
        if (profileStage) profileStage.value = currentUser.stage || '';
    } catch (error) {
        ErrorHandler.logError(error, 'loadTeacherSettings');
    }
}

function updateProfile(event) {
    try {
        event.preventDefault();
        
        if (!currentUser) return false;
        
        const name = DataValidator.sanitizeInput(document.getElementById('profileName').value);
        const school = DataValidator.sanitizeInput(document.getElementById('profileSchool').value);
        const stage = document.getElementById('profileStage').value;
        
        // تحديث بيانات المستخدم
        currentUser.name = name;
        currentUser.school = school;
        currentUser.stage = stage;
        
        // تحديث بيانات المدرسة المرتبطة
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === currentUser.name) {
                demoData.schools[schoolId].name = school;
                break;
            }
        }
        
        // حفظ التحديثات
        StorageManager.setItem('teacherAccounts', demoData.users);
        StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        // تحديث العرض
        const teacherWelcome = document.getElementById('teacherWelcome');
        if (teacherWelcome) {
            teacherWelcome.textContent = `مرحباً ${currentUser.name}`;
        }
        
        alert('تم تحديث الملف الشخصي بنجاح');
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'updateProfile');
        return false;
    }
}

async function changePassword(event) {
  try {
    event.preventDefault();
    
    if (!currentUser) {
      alert('يجب تسجيل الدخول أولاً');
      return false;
    }
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    
    // التحقق من البيانات
    if (!currentPassword || !newPassword || !confirmNewPassword) {
      alert('يرجى ملء جميع الحقول');
      return false;
    }
    
    if (newPassword !== confirmNewPassword) {
      alert('كلمة المرور الجديدة غير متطابقة');
      return false;
    }
    
    if (newPassword.length < 6) {
      alert('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
      return false;
    }
    
    // استخدام API لتغيير كلمة المرور
    const result = await APIService.changePassword({
      currentPassword: currentPassword,
      newPassword: newPassword
    });
    
    if (result.success) {
      alert('تم تغيير كلمة المرور بنجاح');
      event.target.reset();
      return true;
    } else {
      alert(result.error || 'فشل في تغيير كلمة المرور');
      return false;
    }
    
  } catch (error) {
    console.error('خطأ في تغيير كلمة المرور:', error);
    alert('حدث خطأ: ' + error.message);
    return false;
  }
}

// ========== دوال المسؤول وأدوات التصحيح ==========

function initializeDefaultData() {
    try {
        console.log('بدء تهيئة البيانات الافتراضية...');
        
        // 1. إضافة بيانات المعلمين الافتراضية إذا لم تكن موجودة
        if (!demoData.users['chartgain2019@gmail.com']) {
            demoData.users['chartgain2019@gmail.com'] = {
                email: 'chartgain2019@gmail.com',
                password: '123456',
                name: 'أ. عبدالله الشهري',
                school: 'مدرسة الوليد بن عمارة الابتدائية',
                stage: 'ابتدائية'
            };
            console.log('تم إضافة المعلم الافتراضي');
        }
        
        // 2. إضافة مدرسة افتراضية للمعلم
        let defaultSchoolExists = false;
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === 'أ. عبدالله الشهري') {
                defaultSchoolExists = true;
                break;
            }
        }
        
        if (!defaultSchoolExists) {
            const defaultSchoolId = 'school_default';
            demoData.schools[defaultSchoolId] = {
                id: defaultSchoolId,
                name: 'مدرسة الوليد بن عمارة الابتدائية',
                teacher: 'أ. عبدالله الشهري',
                tests: [
                    {
                        name: 'اختبار الرياضيات الفصل الأول',
                        subject: 'الرياضيات',
                        grade: 'الرابع ابتدائي',
                        timerPerQuestion: 30,
                        difficulty: 'متوسط',
                        description: 'اختبار الفصل الأول في مادة الرياضيات',
                        questions: [
                            {
                                question: 'ما هو ناتج 15 + 27؟',
                                options: ['42', '32', '52', '37'],
                                correct: 0
                            },
                            {
                                question: 'ما هو العدد الذي يمثل خمسة وعشرين؟',
                                options: ['52', '25', '205', '250'],
                                correct: 1
                            },
                            {
                                question: 'ما هو ناتج 8 × 7؟',
                                options: ['54', '56', '64', '48'],
                                correct: 1
                            },
                            {
                                question: 'ما هو الكسر الذي يمثل النصف؟',
                                options: ['1/4', '1/2', '1/3', '2/3'],
                                correct: 1
                            },
                            {
                                question: 'ما هو محيط المربع الذي طول ضلعه 5 سم؟',
                                options: ['10 سم', '15 سم', '20 سم', '25 سم'],
                                correct: 2
                            }
                        ]
                    },
                    {
                        name: 'اختبار العلوم الفصل الأول',
                        subject: 'العلوم',
                        grade: 'الرابع ابتدائي',
                        timerPerQuestion: 30,
                        difficulty: 'متوسط',
                        description: 'اختبار الفصل الأول في مادة العلوم',
                        questions: [
                            {
                                question: 'أي من هذه الكواكب أقرب إلى الشمس؟',
                                options: ['الزهرة', 'المريخ', 'عطارد', 'الأرض'],
                                correct: 2
                            },
                            {
                                question: 'ما هي العملية التي تنتج بها النباتات غذاءها؟',
                                options: ['التنفس', 'البناء الضوئي', 'التبخر', 'التكاثر'],
                                correct: 1
                            },
                            {
                                question: 'أي من هذه الحيوانات من الثدييات؟',
                                options: ['التمساح', 'الحوت', 'السلحفاة', 'الأفعى'],
                                correct: 1
                            }
                        ]
                    }
                ]
            };
            console.log('تم إضافة المدرسة الافتراضية مع اختبارين');
        }
        
        // 3. إضافة نتائج تجريبية
        const sampleResults = [
            {
                id: Date.now() - 100000,
                name: 'محمد أحمد',
                grade: 'الرابع ابتدائي',
                class: '4أ',
                school: 'مدرسة الوليد بن عمارة الابتدائية',
                teacher: 'أ. عبدالله الشهري',
                test: 'اختبار الرياضيات الفصل الأول',
                subject: 'الرياضيات',
                score: 4,
                total: 5,
                percentage: 80,
                gradeLevel: 'جيد جداً',
                date: new Date(Date.now() - 86400000).toLocaleDateString('ar-SA'),
                answers: [],
                timestamp: Date.now() - 86400000
            },
            {
                id: Date.now() - 200000,
                name: 'فاطمة خالد',
                grade: 'الرابع ابتدائي',
                class: '4ب',
                school: 'مدرسة الوليد بن عمارة الابتدائية',
                teacher: 'أ. عبدالله الشهري',
                test: 'اختبار الرياضيات الفصل الأول',
                subject: 'الرياضيات',
                score: 5,
                total: 5,
                percentage: 100,
                gradeLevel: 'ممتاز',
                date: new Date(Date.now() - 172800000).toLocaleDateString('ar-SA'),
                answers: [],
                timestamp: Date.now() - 172800000
            }
        ];
        
        const existingResults = StorageManager.getItem('testResults') || [];
        const newResults = [...existingResults];
        let addedCount = 0;
        
        sampleResults.forEach(sample => {
            if (!newResults.find(r => r.id === sample.id)) {
                newResults.push(sample);
                addedCount++;
            }
        });
        
        if (addedCount > 0) {
            StorageManager.setItem('testResults', newResults);
            console.log(`تم إضافة ${addedCount} نتيجة تجريبية`);
        }
        
        // 4. حفظ جميع البيانات
        StorageManager.setItem('teacherAccounts', demoData.users);
        StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        console.log('✅ تمت تهيئة البيانات الافتراضية بنجاح');
        alert(`✅ تمت تهيئة البيانات الافتراضية بنجاح\n\nتم إضافة:\n- المعلم الافتراضي\n- مدرسة افتراضية\n- 2 اختبار\n- 2 نتيجة تجريبية`);
        
        // إعادة تحميل البيانات إذا كان المستخدم في لوحة التحكم
        if (currentUser && document.getElementById('teacherDashboard').classList.contains('hidden') === false) {
            loadTeacherTests();
            loadResultsForTeacher();
            loadDashboardData();
        }
        
    } catch (error) {
        console.error('❌ فشل في تهيئة البيانات:', error);
        alert('❌ فشل في تهيئة البيانات الافتراضية');
        ErrorHandler.logError(error, 'initializeDefaultData');
    }
}

function debugData() {
    try {
        console.log('=== فحص بيانات النظام ===');
        
        // فحص بيانات المعلمين
        console.log('👨‍🏫 بيانات المعلمين:', demoData.users);
        
        // فحص بيانات المدارس
        console.log('🏫 بيانات المدارس:', demoData.schools);
        
        // فحص النتائج
        const results = loadResults();
        console.log('📊 النتائج المحفوظة:', results);
        
        // فحص التخزين
        const storageInfo = StorageManager.getStorageInfo();
        console.log('💾 معلومات التخزين:', storageInfo);
        
        // عرض النتائج في نافذة
        let debugInfo = `
            <div class="bg-white rounded-3xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 text-center">
                    <h2 class="text-2xl font-bold">🛠️ فحص بيانات النظام</h2>
                </div>
                <div class="p-6">
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <h3 class="font-bold text-blue-800 mb-2">👨‍🏫 المعلمون</h3>
                            <div class="text-sm">${Object.keys(demoData.users).length} معلم</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl">
                            <h3 class="font-bold text-green-800 mb-2">🏫 المدارس</h3>
                            <div class="text-sm">${Object.keys(demoData.schools).length} مدرسة</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-xl">
                            <h3 class="font-bold text-purple-800 mb-2">📊 النتائج</h3>
                            <div class="text-sm">${results.length} نتيجة</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-xl">
                            <h3 class="font-bold text-orange-800 mb-2">💾 التخزين</h3>
                            <div class="text-sm">${storageInfo.totalSize.toFixed(2)} MB مستخدم</div>
                        </div>
                    </div>
                    
                    <h3 class="font-bold text-gray-800 mb-3">📋 التفاصيل:</h3>
                    <div class="bg-gray-50 p-4 rounded-xl text-sm font-mono max-h-64 overflow-y-auto">
                        <pre>${JSON.stringify({
                            teachers: demoData.users,
                            schools: demoData.schools,
                            results: results.length,
                            storage: storageInfo
                        }, null, 2)}</pre>
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                            إغلاق
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const modalDiv = document.createElement('div');
        modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
        modalDiv.innerHTML = debugInfo;
        
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        ErrorHandler.logError(error, 'debugData');
    }
}

function debugSystem() {
    try {
        console.log('=== فحص حالة النظام ===');
        
        let systemStatus = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            online: navigator.onLine,
            storage: StorageManager.isStorageAvailable(),
            performance: 'performance' in window,
            canvas: !!document.createElement('canvas').getContext,
            systemHealth: SystemRecovery.checkSystemHealth(),
            resourceCounts: {
                timers: ResourceManager.timers.size,
                eventListeners: ResourceManager.eventListeners.size,
                sessions: ResourceManager.activeSessions.size
            }
        };
        
        console.log('🖥️ حالة النظام:', systemStatus);
        
        // عرض النتائج في نافذة
        let systemInfo = `
            <div class="bg-white rounded-3xl max-w-2xl w-full">
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center">
                    <h2 class="text-2xl font-bold">🖥️ فحص حالة النظام</h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-semibold">التوقيت:</span>
                            <span class="text-sm">${new Date().toLocaleString('ar-SA')}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 ${systemStatus.online ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'} rounded-lg">
                            <span class="font-semibold">الاتصال بالإنترنت:</span>
                            <span>${systemStatus.online ? '🟢 متصل' : '🔴 غير متصل'}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 ${systemStatus.storage ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'} rounded-lg">
                            <span class="font-semibold">التخزين المحلي:</span>
                            <span>${systemStatus.storage ? '🟢 متاح' : '🔴 غير متاح'}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 ${systemStatus.systemHealth ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'} rounded-lg">
                            <span class="font-semibold">صحة النظام:</span>
                            <span>${systemStatus.systemHealth ? '🟢 جيدة' : '🔴 تحتاج اهتمام'}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="font-semibold">المؤقتات النشطة:</span>
                            <span>${systemStatus.resourceCounts.timers}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="font-semibold">مستمعي الأحداث:</span>
                            <span>${systemStatus.resourceCounts.eventListeners.size}</span>
                        </div>
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                            إغلاق
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const modalDiv = document.createElement('div');
        modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
        modalDiv.innerHTML = systemInfo;
        
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        ErrorHandler.logError(error, 'debugSystem');
    }
}

// دالة مساعدة لإغلاق النوافذ المنبثقة
function closeModal(modalElement) {
    try {
        if (modalElement && modalElement.parentNode) {
            modalElement.parentNode.removeChild(modalElement);
        }
    } catch (error) {
        console.error('Error closing modal:', error);
    }
}

// دالة عرض المدارس مع إصلاحات الإغلاق والحذف
function showAllSchools() {
    try {
        let schoolsHTML = `
            <div class="bg-white rounded-3xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 text-center">
                    <h2 class="text-2xl font-bold">🏫 جميع المدارس في النظام</h2>
                    <p class="text-green-100 mt-2">إدارة وحذف حسابات المدارس</p>
                </div>
                <div class="p-6">
                    <div class="mb-4 text-right">
                        <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full">${Object.keys(demoData.schools).length} مدرسة</span>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-yellow-600">⚠️</span>
                            <h3 class="font-bold text-yellow-800">تنبيه مهم</h3>
                        </div>
                        <p class="text-yellow-700 text-sm">
                            عند حذف مدرسة، سيتم حذف جميع الاختبارات والنتائج المرتبطة بها. هذا الإجراء لا يمكن التراجع عنه.
                        </p>
                    </div>
        `;
        
        if (Object.keys(demoData.schools).length === 0) {
            schoolsHTML += `
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">🏫</div>
                    <p>لا توجد مدارس في النظام</p>
                </div>
            `;
        } else {
            schoolsHTML += `<div class="space-y-4">`;
            
            Object.values(demoData.schools).forEach(school => {
                schoolsHTML += `
                    <div class="border border-gray-200 rounded-xl p-4 hover:shadow-lg transition-all">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-800">${school.name}</h3>
                                <p class="text-gray-600 text-sm">المعلم: ${school.teacher}</p>
                            </div>
                            <div class="flex gap-2">
                                <span class="bg-green-100 text-green-600 px-2 py-1 rounded text-sm">${school.tests.length} اختبار</span>
                                <button onclick="deleteSchool('${school.id}')" 
                                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm font-semibold transition-all flex items-center gap-1">
                                    🗑️ حذف
                                </button>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-600 mb-3">
                            <div>
                                <span class="font-semibold">معرف المدرسة:</span>
                                <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">${school.id}</span>
                            </div>
                            <div>
                                <span class="font-semibold">عدد الطلاب:</span>
                                <span>${countStudentsInSchool(school.id)} طالب</span>
                            </div>
                        </div>
                        ${school.tests.length > 0 ? `
                            <div class="mt-3">
                                <h4 class="font-semibold text-gray-700 mb-2">الاختبارات:</h4>
                                <div class="space-y-2">
                                    ${school.tests.map(test => `
                                        <div class="bg-gray-50 p-2 rounded-lg">
                                            <div class="font-medium">${test.name}</div>
                                            <div class="text-xs text-gray-500">${test.subject} - ${test.grade} - ${test.questions.length} سؤال</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : '<div class="text-gray-500 text-sm text-center py-2">لا توجد اختبارات</div>'}
                    </div>
                `;
            });
            
            schoolsHTML += `</div>`;
        }
        
        schoolsHTML += `
                    <div class="text-center mt-6">
                        <button onclick="closeCurrentModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                            إغلاق
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const modalDiv = document.createElement('div');
        modalDiv.id = 'schoolsModal';
        modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
        modalDiv.innerHTML = schoolsHTML;
        
        // إضافة مستمع حدث لإغلاق النافذة عند النقر خارجها
        modalDiv.addEventListener('click', function(event) {
            if (event.target === modalDiv) {
                closeModal(modalDiv);
            }
        });
        
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        ErrorHandler.logError(error, 'showAllSchools');
    }
}

// دالة إغلاق النافذة الحالية
function closeCurrentModal() {
    const modal = document.getElementById('schoolsModal');
    if (modal) {
        closeModal(modal);
    }
}

// دالة حساب عدد الطلاب في المدرسة
function countStudentsInSchool(schoolId) {
    try {
        const results = loadResults();
        const school = demoData.schools[schoolId];
        if (!school) return 0;
        
        const schoolResults = results.filter(result => 
            result.school === school.name && result.teacher === school.teacher
        );
        
        // حساب عدد الطلاب الفريدين
        const uniqueStudents = new Set(schoolResults.map(result => result.name));
        return uniqueStudents.size;
    } catch (error) {
        ErrorHandler.logError(error, 'countStudentsInSchool');
        return 0;
    }
}

// دالة حذف المدرسة - الإصدار المصحح
function deleteSchool(schoolId) {
    try {
        console.log('بدء حذف المدرسة:', schoolId);
        
        // التحقق من صلاحيات المسؤول
        if (!currentUser || currentUser.email !== 'chartgain2019@gmail.com') {
            alert('⚠️ هذه الميزة متاحة فقط للمسؤول');
            return;
        }
        
        const school = demoData.schools[schoolId];
        if (!school) {
            alert('❌ المدرسة غير موجودة');
            return;
        }
        
        // عرض تحذير تأكيدي
        const studentCount = countStudentsInSchool(schoolId);
        const testCount = school.tests.length;
        
        const confirmationMessage = `
⚠️ تأكيد حذف المدرسة

🏫 اسم المدرسة: ${school.name}
👨‍🏫 المعلم: ${school.teacher}
📝 عدد الاختبارات: ${testCount}
👥 عدد الطلاب: ${studentCount}

❌ سيتم حذف:
• جميع الاختبارات في هذه المدرسة (${testCount} اختبار)
• جميع النتائج المرتبطة بها
• حساب المدرسة بالكامل

🛑 هذا الإجراء لا يمكن التراجع عنه

هل أنت متأكد من رغبتك في حذف هذه المدرسة؟
        `.trim();
        
        if (!confirm(confirmationMessage)) {
            console.log('تم إلغاء الحذف من قبل المستخدم');
            return;
        }
        
        // 1. أولاً حذف النتائج المرتبطة بالمدرسة
        console.log('جاري حذف النتائج المرتبطة...');
        deleteSchoolResults(schoolId);
        
        // 2. ثم حذف المدرسة من البيانات
        console.log('جاري حذف المدرسة من البيانات...');
        delete demoData.schools[schoolId];
        
        // 3. حفظ البيانات المحدثة في التخزين المحلي
        console.log('جاري حفظ البيانات المحدثة...');
        const schoolsSuccess = StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        if (schoolsSuccess) {
            console.log('✅ تم حفظ بيانات المدارس بنجاح');
            
            // 4. تنظيف النتائج المحفوظة
            const results = loadResults();
            const updatedResults = results.filter(result => {
                for (const existingSchool of Object.values(demoData.schools)) {
                    if (result.school === existingSchool.name && result.teacher === existingSchool.teacher) {
                        return true;
                    }
                }
                return false;
            });
            
            const resultsSuccess = StorageManager.setItem('testResults', updatedResults);
            if (resultsSuccess) {
                console.log('✅ تم تحديث النتائج بنجاح');
            }
            
            // عرض رسالة نجاح
            showSuccessMessage('تم الحذف بنجاح', `تم حذف مدرسة "${school.name}" وجميع بياناتها المرتبطة`);
            
            console.log('✅ تم حذف المدرسة بنجاح:', schoolId);
            
            // إعادة تحميل قائمة المدارس بعد تأخير بسيط
            setTimeout(() => {
                // إغلاق النافذة الحالية وفتحها مجدداً
                const currentModal = document.getElementById('schoolsModal');
                if (currentModal) {
                    closeModal(currentModal);
                }
                showAllSchools();
            }, 1500);
            
        } else {
            console.error('❌ فشل في حفظ بيانات المدارس بعد الحذف');
            alert('❌ فشل في حذف المدرسة. يرجى المحاولة مرة أخرى.');
        }
        
    } catch (error) {
        console.error('❌ خطأ في حذف المدرسة:', error);
        ErrorHandler.logError(error, 'deleteSchool');
        alert('❌ حدث خطأ أثناء حذف المدرسة: ' + error.message);
    }
}

// دالة حذف نتائج المدرسة - الإصدار المصحح
function deleteSchoolResults(schoolId) {
    try {
        const school = demoData.schools[schoolId];
        if (!school) {
            console.log('المدرسة غير موجودة لحذف النتائج:', schoolId);
            return;
        }
        
        const results = loadResults();
        const schoolName = school.name;
        const teacherName = school.teacher;
        
        console.log(`جاري حذف نتائج المدرسة: ${schoolName} - ${teacherName}`);
        
        const updatedResults = results.filter(result => {
            const shouldKeep = !(result.school === schoolName && result.teacher === teacherName);
            if (!shouldKeep) {
                console.log('حذف نتيجة:', result.name, result.test);
            }
            return shouldKeep;
        });
        
        const success = StorageManager.setItem('testResults', updatedResults);
        
        if (success) {
            console.log(`✅ تم حذف ${results.length - updatedResults.length} نتيجة مرتبطة بالمدرسة`);
        } else {
            console.error('❌ فشل في حفظ النتائج المحدثة');
        }
        
        return success;
    } catch (error) {
        console.error('❌ خطأ في حذف نتائج المدرسة:', error);
        ErrorHandler.logError(error, 'deleteSchoolResults');
        return false;
    }
}

// ========== تحديث الإحصائيات ==========

async function updateWelcomeStatistics() {
    try {
        console.log('📊 جاري تحديث الإحصائيات...');
        
        let stats;
        try {
            // محاولة جلب الإحصائيات من الخادم
            stats = await APIService.getStatistics();
            console.log('✅ الإحصائيات من الخادم:', stats);
        } catch (error) {
            console.error('❌ فشل في جلب الإحصائيات من الخادم:', error);
            // استخدام البيانات المحلية كنسخة احتياطية
            stats = {
                totalSchools: Object.keys(demoData.schools).length,
                totalTeachers: Object.keys(demoData.users).length,
                totalTests: Object.values(demoData.schools).reduce((sum, school) => 
                    sum + (school.tests ? school.tests.length : 0), 0
                ),
                totalResults: loadResults().length
            };
        }
        
        // تحديث العناصر
        const elements = {
            statsSchools: document.getElementById('statsSchools'),
            statsTeachers: document.getElementById('statsTeachers'),
            statsTests: document.getElementById('statsTests'),
            statsResults: document.getElementById('statsResults')
        };
        
        if (elements.statsSchools) elements.statsSchools.textContent = stats.totalSchools;
        if (elements.statsTeachers) elements.statsTeachers.textContent = stats.totalTeachers;
        if (elements.statsTests) elements.statsTests.textContent = stats.totalTests;
        if (elements.statsResults) elements.statsResults.textContent = stats.totalResults;
        
        console.log('📈 الإحصائيات المحدثة:', stats);
        
    } catch (error) {
        console.error('❌ خطأ في تحديث الإحصائيات:', error);
    }
}

// ========== تهيئة النظام عند التحميل ==========

document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log('🚀 بدء تحميل نظام الاختبارات التفاعلي...');
        
        // تهيئة أنظمة الاستقرار
        SystemRecovery.initialize();
        
        // تهيئة نظام التخزين
        StorageManager.initializeStorage();
        
        // تحميل البيانات المحفوظة
        loadTeacherAccounts();
        
        // تحميل بيانات المدارس
        const storedSchools = StorageManager.getItem('demoSchoolsData');
        if (storedSchools) {
            demoData.schools = storedSchools;
            console.log('تم تحميل بيانات المدارس:', Object.keys(storedSchools).length, 'مدرسة');
        }
        
        // تحميل المدارس للمعلمين الحاليين
        loadSchoolsForExistingTeachers();
        
        // تحديث الإحصائيات
        updateWelcomeStatistics();
        
        // إعداد مستمعي الأحداث
        setupEventListeners();
        
        // التحقق من وجود جلسة سابقة واستعادتها
        const previousSession = SystemRecovery.recoverPreviousSession();
        if (previousSession && previousSession.testInProgress) {
            console.log('تم اكتشاف جلسة اختبار سابقة:', previousSession);
            // يمكن إضافة منطق استعادة الجلسة هنا إذا لزم الأمر
        }
        
        console.log('✅ تم تحميل النظام بنجاح');
        
    } catch (error) {
        ErrorHandler.logError(error, 'DOMContentLoaded');
    }
});

document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log('🚀 بدء تحميل نظام الاختبارات التفاعلي...');
        
        // تهيئة أنظمة الاستقرار
        SystemRecovery.initialize();
        
        // تهيئة نظام التخزين
        StorageManager.initializeStorage();
        
        // تحميل البيانات المحفوظة
        loadTeacherAccounts();
        
        // تحميل بيانات المدارس
        const storedSchools = StorageManager.getItem('demoSchoolsData');
        if (storedSchools) {
            demoData.schools = storedSchools;
            console.log('تم تحميل بيانات المدارس:', Object.keys(storedSchools).length, 'مدرسة');
        }
        
        // تحميل المدارس للمعلمين الحاليين
        loadSchoolsForExistingTeachers();
        
        // تحديث الإحصائيات من الخادم ← أضف هذا السطر
        updateWelcomeStatistics();
        
        // إعداد مستمعي الأحداث
        setupEventListeners();
        
        // التحقق من وجود جلسة سابقة واستعادتها
        const previousSession = SystemRecovery.recoverPreviousSession();
        if (previousSession && previousSession.testInProgress) {
            console.log('تم اكتشاف جلسة اختبار سابقة:', previousSession);
        }
        
        console.log('✅ تم تحميل النظام بنجاح');
        
    } catch (error) {
        ErrorHandler.logError(error, 'DOMContentLoaded');
    }
});
	
function setupEventListeners() {
    try {
        // إعداد مستمعي الأحداث للنوافذ المنبثقة
        const testModal = document.getElementById('testModal');
        const questionModal = document.getElementById('questionModal');
        
        // إغلاق النوافذ المنبثقة عند النقر خارجها
        if (testModal) {
            ResourceManager.addEventListener(testModal, 'click', function(event) {
                if (event.target === testModal) {
                    closeTestModal();
                }
            });
        }
        
        if (questionModal) {
            ResourceManager.addEventListener(questionModal, 'click', function(event) {
                if (event.target === questionModal) {
                    closeQuestionModal();
                }
            });
        }
        
        // إعداد فلتر التاريخ المخصص
        const dateFilter = document.getElementById('filterDateSelect');
        const customDateFilter = document.getElementById('customDateFilter');
        
        if (dateFilter && customDateFilter) {
            ResourceManager.addEventListener(dateFilter, 'change', function() {
                if (this.value === 'custom') {
                    customDateFilter.classList.remove('hidden');
                } else {
                    customDateFilter.classList.add('hidden');
                }
            });
        }
        
        console.log('✅ تم إعداد مستمعي الأحداث');
    } catch (error) {
        ErrorHandler.logError(error, 'setupEventListeners');
    }
}

// ========== تنظيف النظام عند إغلاق الصفحة ==========

window.addEventListener('beforeunload', function() {
    try {
        // تنظيف الموارد
        ResourceManager.cleanup();
        
        // حفظ حالة النظام
        SystemRecovery.saveSession({
            lastActivity: Date.now(),
            currentScreen: getCurrentScreen()
        });
    } catch (error) {
        console.error('Error during cleanup:', error);
    }
});

function getCurrentScreen() {
    const screens = [
        'welcomeScreen',
        'studentAccessScreen', 
        'teacherDashboard',
        'testScreen',
        'resultsScreen'
    ];
    
    for (const screen of screens) {
        const element = document.getElementById(screen);
        if (element && !element.classList.contains('hidden')) {
            return screen;
        }
    }
    return 'unknown';
}

// ========== معالجة الأخطاء العالمية ==========

// معالجة الأخطاء العالمية
window.addEventListener('error', function(e) {
    console.error('❌ خطأ عام:', e.error);
    console.error('❌ في الملف:', e.filename);
    console.error('❌ السطر:', e.lineno);
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('❌ Promise مرفوض:', e.reason);
});

function checkLibraries() {
    console.log('🔍 فحص المكتبات...');
    
    if (typeof XLSX === 'undefined') {
        console.warn('⚠️ مكتبة XLSX غير محملة');
    } else {
        console.log('✅ مكتبة XLSX محملة');
    }
    
    if (typeof html2canvas === 'undefined') {
        console.warn('⚠️ مكتبة html2canvas غير محملة');
    } else {
        console.log('✅ مكتبة html2canvas محملة');
    }
    
    if (typeof jsPDF === 'undefined') {
        console.warn('⚠️ مكتبة jsPDF غير محملة');
    } else {
        console.log('✅ مكتبة jsPDF محملة');
    }
}

// استدعاء التحقق بعد تحميل الصفحة
setTimeout(checkLibraries, 2000);

// التحقق من حالة النظام
function checkSystemStatus() {
    console.log('🖥️ حالة النظام:');
    console.log('📍 Online:', navigator.onLine);
    console.log('📍 LocalStorage:', typeof Storage !== 'undefined');
    console.log('📍 Canvas:', !!document.createElement('canvas').getContext);
    console.log('📍 موقع الصفحة:', window.location.href);
}
	
// تشغيل فحص النظام
setTimeout(checkSystemStatus, 1000);
		
// ========== تجاهل كامل لأخطاء الامتدادات ==========
(function() {
    'use strict';
    
    // تجاهل أخطاء hotkeys من الامتدادات
    const originalOnError = window.onerror;
    window.onerror = function(message, source, lineno, colno, error) {
        if (message && typeof message === 'string' && message.includes('hotkeys')) {
            console.log('🔇 تم تجاهل خطأ امتداد: hotkeys');
            return true; // منع انتشار الخطأ
        }
        if (originalOnError) {
            return originalOnError.apply(this, arguments);
        }
        return false;
    };
    
    // تجاهل أخطاء الوعود من الامتدادات
    window.addEventListener('unhandledrejection', function(event) {
        if (event.reason && 
            (event.reason.message && event.reason.message.includes('hotkeys')) ||
            (typeof event.reason === 'string' && event.reason.includes('hotkeys'))) {
            event.preventDefault();
            console.log('🔇 تم تجاهل خطأ promise امتداد');
        }
    });
    
    console.log('✅ تم تفعيل نظام تجاهل أخطاء الامتدادات');
})();

// منع ظهور أخطاء الامتدادات في الكونسول
(function() {
    'use strict';
    
    // حفظ الكونسول الأصلي
    const originalError = console.error;
    const originalWarn = console.warn;
    
    // تصفية الأخطاء المرتبطة بالامتدادات
    console.error = function(...args) {
        if (args.some(arg => 
            (typeof arg === 'string' && arg.includes('hotkeys')) ||
            (arg && arg.message && arg.message.includes('hotkeys'))
        )) {
            console.log('🔇 خطأ امتداد تم تصفيته');
            return;
        }
        originalError.apply(console, args);
    };
    
    console.warn = function(...args) {
        if (args.some(arg => 
            typeof arg === 'string' && arg.includes('hotkeys')
        )) {
            console.log('🔇 تحذير امتداد تم تصفيته');
            return;
        }
        originalWarn.apply(console, args);
    };
})();

// الحل الشامل النهائي
(function() {
    'use strict';
    
    // 1. تعريف شامل لـ hotkeys
    if (typeof hotkeys === 'undefined') {
        window.hotkeys = function Hotkeys() { return window.hotkeys; };
        Object.assign(window.hotkeys, {
            filter: () => window.hotkeys,
            key: () => window.hotkeys, 
            unbind: () => window.hotkeys,
            isPressed: () => false,
            getPressedKeyCodes: () => [],
            shift: () => window.hotkeys,
            ctrl: () => window.hotkeys,
            alt: () => window.hotkeys,
            meta: () => window.hotkeys
        });
    }
    
    // 2. منع كافة أخطاء الامتدادات
    const safeErrorHandler = function(event) {
        if (event.error && event.error.message && event.error.message.includes('hotkeys')) {
            event.preventDefault();
            event.stopImmediatePropagation();
            return true;
        }
        return false;
    };
    
    window.addEventListener('error', safeErrorHandler, true);
    window.addEventListener('unhandledrejection', safeErrorHandler, true);
    
    console.log('🛡️  النظام محمي من أخطاء الامتدادات');
})();	

// دالة مساعدة للتحقق من صحة بيانات الاختبار
function validateTestData(test) {
    if (!test) return false;
    if (!test.name || !test.subject || !test.grade) return false;
    if (!test.questions || !Array.isArray(test.questions)) return false;
    return true;
}

// تحديث بيانات demoData لتضمين المدرسة الافتراضية
function updateDemoDataWithDefaultSchool() {
    if (!demoData.schools['school_default']) {
        demoData.schools['school_default'] = {
            id: 'school_default',
            name: 'مدرسة الوليد بن عمارة الابتدائية',
            teacher: 'أ. عبدالله الشهري',
            tests: []
        };
        console.log('✅ تم إضافة المدرسة الافتراضية إلى demoData');
    }
}

// تشغيل عند تحميل الصفحة
setTimeout(updateDemoDataWithDefaultSchool, 1000);

// تنظيف البيانات التالفة في localStorage
function cleanupCorruptedData() {
    try {
        console.log('🧹 جاري تنظيف البيانات التالفة...');
        
        // قائمة بالمفاتيح التي قد تحتوي على بيانات تالفة
        const potentialCorruptedKeys = ['authToken', 'currentUser', 'currentSession'];
        
        potentialCorruptedKeys.forEach(key => {
            try {
                const item = localStorage.getItem(key);
                if (item) {
                    // إذا كان المفتاح يحتوي على JSON تالف، حاول إصلاحه
                    if (item.startsWith('{') || item.startsWith('[')) {
                        JSON.parse(item); // مجرد محاولة تحقق
                        console.log(`✅ ${key}: بيانات سليمة`);
                    } else {
                        console.log(`✅ ${key}: بيانات string عادية`);
                    }
                }
            } catch (error) {
                console.warn(`❌ ${key}: بيانات تالفة - جاري الإصلاح...`);
                // حذف البيانات التالفة
                localStorage.removeItem(key);
                console.log(`✅ ${key}: تم تنظيف البيانات التالفة`);
            }
        });
        
        console.log('✅ اكتمل تنظيف البيانات التالفة');
    } catch (error) {
        console.error('❌ فشل في تنظيف البيانات التالفة:', error);
    }
}

// تشغيل التنظيف بعد تحميل الصفحة
setTimeout(cleanupCorruptedData, 2000);

// دالة لمزامنة البيانات بين الخادم والتخزين المحلي
async function syncSchoolData(schoolId) {
    try {
        console.log('🔄 مزامنة بيانات المدرسة مع الخادم...');
        
        const school = demoData.schools[schoolId];
        if (!school) {
            console.warn('❌ المدرسة غير موجودة محلياً للمزامنة');
            return;
        }
        
        // هنا يمكنك إضافة كود لإرسال البيانات إلى الخادم
        // إذا كان الخادم يدعم تحديث البيانات
        
        console.log('✅ تمت مزامنة بيانات المدرسة');
        
    } catch (error) {
        console.error('❌ خطأ في مزامنة البيانات:', error);
    }
}

// دالة لتحديث قائمة الاختبارات مباشرة
function refreshTestsList(schoolId) {
    try {
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const testSelect = document.getElementById('testSelect');
        
        if (!selectedSchoolInfo || !testSelect) return;
        
        const school = demoData.schools[schoolId];
        if (!school || !school.tests) return;
        
        // تحديث قائمة الاختبارات
        testSelect.innerHTML = '<option value="">اختر الاختبار</option>';
        
        if (school.tests.length > 0) {
            school.tests.forEach((test, index) => {
                if (test && test.name && test.subject && test.grade) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
                    testSelect.appendChild(option);
                }
            });
        }
        
        console.log('✅ تم تحديث قائمة الاختبارات مع البيانات الجديدة');
        
    } catch (error) {
        console.error('❌ خطأ في تحديث قائمة الاختبارات:', error);
    }
}
// ========== دوال التحديث والمزامنة الجديدة ==========

// دالة لتحديث قائمة الاختبارات مباشرة
function refreshTestsList(schoolId) {
    try {
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const testSelect = document.getElementById('testSelect');
        
        if (!selectedSchoolInfo || !testSelect) {
            console.warn('❌ عناصر تحديث الاختبارات غير موجودة');
            return;
        }
        
        const school = demoData.schools[schoolId];
        if (!school || !school.tests) {
            console.warn('❌ لا توجد بيانات مدرسة للاختبارات');
            return;
        }
        
        // تحديث قائمة الاختبارات
        testSelect.innerHTML = '<option value="">اختر الاختبار</option>';
        
        let validTestsCount = 0;
        if (school.tests.length > 0) {
            school.tests.forEach((test, index) => {
                if (test && test.name && test.subject && test.grade) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
                    testSelect.appendChild(option);
                    validTestsCount++;
                }
            });
        }
        
        console.log(`✅ تم تحديث قائمة الاختبارات - ${validTestsCount} اختبار صالح`);
        
    } catch (error) {
        console.error('❌ خطأ في تحديث قائمة الاختبارات:', error);
        ErrorHandler.logError(error, 'refreshTestsList');
    }
}

// دالة لتحديث بيانات المدرسة يدوياً
function refreshSchoolData() {
    try {
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        if (!selectedSchoolInfo) {
            showErrorMessage('خطأ', 'لم يتم تحديد مدرسة');
            return;
        }
        
        const schoolId = selectedSchoolInfo.dataset.schoolId;
        if (!schoolId) {
            showErrorMessage('خطأ', 'معرف المدرسة غير موجود');
            return;
        }
        
        console.log('🔄 تحديث بيانات المدرسة يدوياً...');
        
        // إعادة تحميل البيانات من التخزين المحلي
        const school = demoData.schools[schoolId];
        if (school) {
            refreshTestsList(schoolId);
            showSuccessMessage('تم التحديث', 'تم تحديث قائمة الاختبارات بنجاح');
        } else {
            showErrorMessage('خطأ', 'لم يتم العثور على بيانات المدرسة');
        }
        
    } catch (error) {
        console.error('❌ خطأ في تحديث البيانات:', error);
        showErrorMessage('خطأ', 'فشل في تحديث البيانات');
    }
}

// دالة لمزامنة البيانات بين الخادم والتخزين المحلي
async function syncSchoolData(schoolId) {
    try {
        console.log('🔄 مزامنة بيانات المدرسة مع الخادم...');
        
        const school = demoData.schools[schoolId];
        if (!school) {
            console.warn('❌ المدرسة غير موجودة محلياً للمزامنة');
            return;
        }
        
        // هنا يمكنك إضافة كود لإرسال البيانات إلى الخادم
        // إذا كان الخادم يدعم تحديث البيانات
        console.log('📤 جاهز لإرسال بيانات المدرسة إلى الخادم:', school.tests.length, 'اختبار');
        
        // محاكاة الإرسال إلى الخادم (يمكنك استبدال هذا بالكود الفعلي)
        try {
            // const response = await fetch(`https://quiz-system-api.onrender.com/api/tests/${schoolId}`, {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify(school.tests)
            // });
            console.log('✅ تمت مزامنة بيانات المدرسة (محاكاة)');
        } catch (syncError) {
            console.warn('⚠️ فشل في مزامنة البيانات مع الخادم:', syncError);
        }
        
    } catch (error) {
        console.error('❌ خطأ في مزامنة البيانات:', error);
        ErrorHandler.logError(error, 'syncSchoolData');
    }
}	

// إصلاح بيانات المعلم الحالي
function fixTeacherData() {
    try {
        console.log('🔧 إصلاح بيانات المعلم...');
        
        if (!currentUser) {
            console.warn('❌ لا يوجد مستخدم مسجل');
            return;
        }
        
        // البحث عن مدرسة المعلم الحالي
        let teacherSchool = null;
        let teacherSchoolId = null;
        
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === currentUser.name) {
                teacherSchool = demoData.schools[schoolId];
                teacherSchoolId = schoolId;
                break;
            }
        }
        
        // إذا لم توجد مدرسة للمعلم، إنشاؤها
        if (!teacherSchool) {
            teacherSchoolId = 'school_' + Date.now();
            teacherSchool = {
                id: teacherSchoolId,
                name: currentUser.school,
                teacher: currentUser.name,
                tests: []
            };
            demoData.schools[teacherSchoolId] = teacherSchool;
            console.log('✅ تم إنشاء مدرسة جديدة للمعلم');
        }
        
        // نسخ الاختبارات من المدرسة الافتراضية إذا كانت فارغة
        const defaultSchool = demoData.schools['school_default'];
        if (defaultSchool && defaultSchool.tests && defaultSchool.tests.length > 0) {
            if (!teacherSchool.tests || teacherSchool.tests.length === 0) {
                teacherSchool.tests = JSON.parse(JSON.stringify(defaultSchool.tests)); // نسخ عميق
                console.log('✅ تم نسخ الاختبارات من المدرسة الافتراضية');
            }
        }
        
        // تحديث المتغير الحالي
        currentManagingTestSchoolId = teacherSchoolId;
        
        // حفظ البيانات
        StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        console.log('✅ تم إصلاح بيانات المعلم:', {
            schoolId: teacherSchoolId,
            testsCount: teacherSchool.tests ? teacherSchool.tests.length : 0
        });
        
        // إعادة تحميل الاختبارات
        loadTeacherTests();
        
    } catch (error) {
        console.error('❌ خطأ في إصلاح بيانات المعلم:', error);
    }
}

// تشغيل الإصلاح تلقائياً عند دخول المعلم
function autoFixTeacherOnLogin() {
    if (currentUser && currentUser.email === 'chartgain2019@gmail.com') {
        setTimeout(fixTeacherData, 1000);
    }
}
	
</script>
   <!-- تذييل متميز -->
    <footer class="bg-gradient-to-r from-blue-800 to-purple-900 text-white py-4 text-center border-t border-blue-600">
        <div class="container mx-auto px-6">
            <p class="text-sm text-blue-200">
              © 2025 جميع الحقوق محفوظة | تم إنشاء هذه الصفحة لأغراض تعليمية برمجة وتصميم الأستاذ عبدالله الشهري
            </p>
        </div>
    </footer>
</body>
</html>
