<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الاختبارات التفاعلي</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">    
	
    <!-- إضافة مكتبات التصدير -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- إضافة مكتبة html2canvas لتحويل HTML إلى صورة -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
	    /* إصلاح تنسيقات الأزرار */
        button {
          border: none !important;
          outline: none !important;
        }

        .bg-gradient-to-r {
          background-image: linear-gradient(to right, var(--tw-gradient-from), var(--tw-gradient-to)) !important;
        }

        /* تأكيد ألوان الأزرار */
        .from-orange-500 {
          --tw-gradient-from: #f97316 !important;
        }

        .to-red-500 {
            --tw-gradient-to: #ef4444 !important;
        }

       .hover\:from-orange-600:hover {
          --tw-gradient-from: #ea580c !important;
       }

       .hover\:to-red-600:hover {
           --tw-gradient-to: #dc2626 !important;
        }
	    /* تنسيقات الأزرار المفقودة */
		.btn-retake {
           background: linear-gradient(to right, #f59e0b, #f97316) !important;
           color: white !important;
            padding: 12px 24px !important;
            border-radius: 12px !important;
            font-weight: 600 !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.2) !important;
        }

        .btn-retake:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 8px rgba(245, 158, 11, 0.3) !important;
           background: linear-gradient(to right, #d97706, #ea580c) !important;
        }

        .btn-clear-filters {
            background: linear-gradient(to right, #ef4444, #dc2626);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2);
        }

        .btn-clear-filters:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(239, 68, 68, 0.3);
            background: linear-gradient(to right, #dc2626, #b91c1c);
        }
		
        .result-details-modal {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
           from { opacity: 0; }
           to { opacity: 1; }
        }
		/* تنسيقات إضافية لتبويب الإعدادات */
        .tab-content {
           min-height: 400px;
        }

        #settingsContent {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
		
		@keyframes fadeOut {
           from { opacity: 1; }
           to { opacity: 0; }
        }
		
		/* تخصيص ألوان التغذية الراجعة */
        .feedback-time-up {
           background: linear-gradient(135deg, #fed7aa, #fdba74) !important;
           border: 2px solid #f97316 !important;
           color: #7c2d12 !important;
        }

        .feedback-correct {
            background: linear-gradient(135deg, #bbf7d0, #86efac) !important;
            border: 2px solid #16a34a !important;
            color: #166534 !important;
        }

        .feedback-wrong {
            background: linear-gradient(135deg, #fecaca, #fca5a5) !important;
            border: 2px solid #dc2626 !important;
            color: #991b1b !important;
        }

        /* تحسين مظهر الحقول */
        #settingsContent input:not([readonly]):focus,
        #settingsContent select:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }

        #settingsContent input[readonly] {
            background-color: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }

        /* تحسين أزرار التبويبات */
        .tab-btn.active {
           box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* تأكد من أن المحتوى ظاهر */
        #settingsContent:not(.hidden) {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* تحسين مظهر النافذة المنبثقة */
        .result-details-modal > div {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { 
               opacity: 0;
               transform: translateY(20px);
            }
            to { 
               opacity: 1;
               transform: translateY(0);
            }
        }
		
		/* تنسيقات النطاق التاريخي */
        #customDateRange {
            animation: slideDown 0.3s ease-out;
        }
		
		#customDateFilter {
           animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* تحسين مظهر حقول التاريخ */
        input[type="date"] {
            direction: ltr;
            text-align: right;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
           filter: invert(0.5);
           cursor: pointer;
        }

        /* تنسيقات إضافية للأزرار الأخرى */
        .btn-whatsapp {
            background: linear-gradient(to right, #22c55e, #16a34a);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(34, 197, 94, 0.2);
        }

        .btn-whatsapp:hover {
           transform: translateY(-2px);
           box-shadow: 0 6px 8px rgba(34, 197, 94, 0.3);
           background: linear-gradient(to right, #16a34a, #15803d);
        }

        .btn-certificate {
            background: linear-gradient(to right, #3b82f6, #1d4ed8);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
        }

        .btn-certificate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(59, 130, 246, 0.3);
            background: linear-gradient(to right, #2563eb, #1e40af);
        }
		
		/* إصلاح أزرار أدوات المسؤول */
        .bg-orange-500 {
           background-color: #f97316 !important;
        }

        .hover\:bg-orange-600:hover {
            background-color: #ea580c !important;
        }

        .bg-red-500 {
            background-color: #ef4444 !important;
        }

       .hover\:bg-red-600:hover {
           background-color: #dc2626 !important;
        }

       .bg-green-500 {
            background-color: #10b981 !important;
        }

       .hover\:bg-green-600:hover {
           background-color: #059669 !important;
        }

       .bg-blue-500 {
            background-color: #3b82f6 !important;
        }

        .hover\:bg-blue-600:hover {
            background-color: #2563eb !important;
        }

        .bg-purple-500 {
            background-color: #8b5cf6 !important;
        }

        .hover\:bg-purple-600:hover {
            background-color: #7c3aed !important;
        }
		
      	/* تحسين تنسيق أزرار الإجراءات في الجدول */
        .flex.gap-2 .bg-blue-500, 
        .flex.gap-2 .bg-red-500 {
           min-width: 80px;
           justify-content: center;
        }

        .flex.gap-2 .bg-blue-500:hover, 
        .flex.gap-2 .bg-red-500:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        body {
            box-sizing: border-box;
        }
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        * { font-family: 'Cairo', sans-serif; }
        
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .pulse-red { animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 
            0%, 100% { background-color: #ef4444; } 
            50% { background-color: #dc2626; } 
        }
        /* أنماط السحب والإفلات المبسطة */
		/* ========== أنماط السحب والإفلات المحسنة والمدمجة ========== */

        .question-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: grab;
            user-select: none;
            position: relative;
        }

        .question-item:active {
            cursor: grabbing;
        }

        .question-item.dragging {
            opacity: 0.6;
            transform: scale(0.95) rotate(1deg);
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe) !important;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3) !important;
            z-index: 1000;
        }

        .question-item.drag-over {
            border: 2px dashed #3b82f6 !important;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7) !important;
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
        }

        /* الحفاظ على الأنماط الأصلية مع التحسينات */
        .question-item.drag-target {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9) !important;
        }

        .drag-handle {
            opacity: 0.6;
            cursor: grab;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drag-handle:hover {
            opacity: 1;
            background: rgba(59, 130, 246, 0.15) !important;
            transform: scale(1.05);
        }

        .question-item.dragging .drag-handle {
            cursor: grabbing;
            opacity: 0.9;
            background: rgba(59, 130, 246, 0.2) !important;
        }

        .question-item:hover .drag-handle {
            opacity: 0.9;
        }

        /* مؤشرات السحب */
        .drop-indicator {
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            margin: 8px 0;
            border-radius: 3px;
            animation: pulse-blue 1.5s infinite;
        }

        @keyframes pulse-blue {
            0%, 100% { 
              opacity: 0.6;
              transform: scaleX(0.95);
            }
            50% { 
             opacity: 1;
             transform: scaleX(1);
            }
        }

        /* تأثيرات إضافية للتحسين البصري */
        .question-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .question-item.drag-over::before {
            opacity: 1;
        }

        /* تحسينات للأجهزة المحمولة */
        @media (max-width: 768px) {
            .question-item {
              cursor: pointer;
            }
    
            .question-item.dragging {
               transform: scale(0.93);
            }
    
            .drag-handle {
               padding: 10px;
               opacity: 0.8;
            }
        }

        /* حالة السحب النشط */
        .question-item.dragging { 
           border: 2px solid #3b82f6 !important;
           box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4) !important;
        }

        /* تأثير الانتقال السلس عند إعادة الترتيب */
       .questions-list {
           transition: all 0.3s ease;
        }
        
        /* تحسينات الطباعة للشهادة */
        @media print {
            body * {
                visibility: hidden;
            }
            #certificateContent, #certificateContent * {
                visibility: visible;
            }
            #certificateContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 2cm;
            }
            .no-print {
                display: none !important;
            }
        }
		
		/* مؤشرات حالة الخادم */
        #serverStatusIndicator {
           animation: slideInUp 0.5s ease-out;
           font-family: 'Cairo', sans-serif;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
           to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #serverStatusIndicator.offline {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
        }

        #serverStatusIndicator.online {
            background: linear-gradient(135deg, #10b981, #059669) !important;
        }

        /* تحسينات الاستقرار */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<!-- الشاشة الرئيسية -->
<div id="welcomeScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700">
    <div class="container mx-auto px-6 py-12">
        <div class="max-w-4xl mx-auto text-center text-white">
            <div class="mb-8">
                <div class="w-24 h-24 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h1 class="text-5xl font-bold mb-4">نظام الاختبارات التفاعلي</h1>
                <p class="text-xl mb-12 text-blue-100">منصة تعليمية شاملة وآمنة لإدارة الاختبارات المحاكية لاختبارات نافس</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-12">
                <!-- دخول الطلاب -->
                <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-8 hover:bg-opacity-20 transition-all cursor-pointer" onclick="showStudentAccess()">
                    <div class="text-6xl mb-6">👨‍🎓</div>
                    <h3 class="text-2xl font-bold mb-4">دخول الطلاب</h3>
                    <p class="text-blue-100 mb-6">ابدأ رحلتك التعليمية</p>
                    <button class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-xl font-semibold transition-all">
                        ابدأ الآن
                    </button>
                </div>

                <!-- دخول المعلمين -->
                <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-8 hover:bg-opacity-20 transition-all cursor-pointer" onclick="showTeacherLogin()">
                    <div class="text-6xl mb-6">👨‍💼</div>
                    <h3 class="text-2xl font-bold mb-4">دخول المعلمين</h3>
                    <p class="text-blue-100 mb-6">إدارة الاختبارات</p>
                    <button class="bg-purple-500 hover:bg-purple-600 text-white px-8 py-3 rounded-xl font-semibold transition-all">
                        دخول لوحة التحكم
                    </button>
                </div>
            </div>

            <!-- إحصائيات -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-yellow-300" id="statsSchools">5</div>
                    <div class="text-sm text-blue-100">المدارس</div>
                </div>
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-green-300" id="statsTeachers">12</div>
                    <div class="text-sm text-blue-100">المعلمين</div>
                </div>
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-pink-300" id="statsTests">48</div>
                    <div class="text-sm text-blue-100">الاختبارات</div>
                </div>
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-orange-300" id="statsResults">156</div>
                    <div class="text-sm text-blue-100">النتائج</div>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- التذييل المضاف -->
    <footer class="absolute bottom-0 left-0 right-0 bg-gradient-to-r from-blue-800 to-purple-900 text-white py-4 text-center border-t border-blue-600">
        <div class="container mx-auto px-6">
            <p class="text-sm text-blue-200">
                © 2025 جميع الحقوق محفوظة | تم إنشاء هذه الصفحة لأغراض تعليمية برمجة وتصميم الأستاذ عبدالله الشهري
            </p>
        </div>
    </footer>
</div>
<!-- شاشة تسجيل دخول المعلمين -->
<div id="teacherLoginScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-8 text-center">
            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold">تسجيل دخول المعلم</h2>
        </div>
        
        <div class="p-8">
            <form id="teacherLoginForm" onsubmit="return teacherLogin(event)">
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">البريد الإلكتروني</label>
                    <input type="email" id="teacherEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="أدخل البريد الإلكتروني"  required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">كلمة المرور</label>
                    <input type="password" id="teacherPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="أدخل كلمة المرور"  required>
                </div>
                
                
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-xl font-semibold hover:from-purple-700 hover:to-blue-700 transition-all">
                        تسجيل الدخول
                    </button>
                    <button type="button" onclick="closeTeacherLogin()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                        إلغاء
                    </button>
                </div>
                
                <div class="text-center mt-6 pt-6 border-t border-gray-200">
                    <p class="text-gray-600 mb-4">ليس لديك حساب؟</p>
                    <button type="button" onclick="showTeacherSignup()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-all">
                        إنشاء حساب جديد
                    </button>
                </div>
            </form>
            
            <div id="loginError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<!-- شاشة إنشاء حساب معلم جديد -->
<div id="teacherSignupScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-8 text-center">
            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold">إنشاء حساب معلم جديد</h2>
        </div>
        
        <div class="p-8">
            <form id="teacherSignupForm" onsubmit="return teacherSignup(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">الاسم الكامل</label>
                    <input type="text" id="newTeacherName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="أدخل الاسم الكامل" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">البريد الإلكتروني</label>
                    <input type="email" id="newTeacherEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="أدخل البريد الإلكتروني" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">اسم المدرسة</label>
                    <input type="text" id="newTeacherSchool" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="أدخل اسم المدرسة" required>
                </div>
                
                <!-- إضافة المرحلة الدراسية -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">المرحلة الدراسية</label>
                    <select id="newTeacherStage" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" required>
                        <option value="">اختر المرحلة الدراسية</option>
                        <option value="ابتدائية">الابتدائية</option>
                        <option value="متوسطة">المتوسطة</option>
                        <option value="ثانوية">الثانوية</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">كلمة المرور</label>
                    <input type="password" id="newTeacherPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="أدخل كلمة المرور" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">تأكيد كلمة المرور</label>
                    <input type="password" id="confirmTeacherPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="أعد إدخال كلمة المرور" required>
                </div>
                
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 text-white py-3 rounded-xl font-semibold hover:from-green-700 hover:to-blue-700 transition-all">
                        إنشاء الحساب
                    </button>
                    <button type="button" onclick="closeTeacherSignup()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                        إلغاء
                    </button>
                </div>
            </form>
            
            <div id="signupError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
            <div id="signupSuccess" class="hidden mt-4 p-4 bg-green-50 border border-green-200 text-green-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<!-- شاشة اختيار المدرسة للطلاب -->
<div id="studentAccessScreen" class="hidden container mx-auto px-6 py-12">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-8 text-center relative">
                <!-- إضافة زر العودة إلى الشاشة الرئيسية -->
                <button onclick="goBackToWelcome()" class="absolute top-6 right-6 bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-xl transition-all">
                    ← العودة للرئيسية
                </button>
                <div class="text-5xl mb-4">🎓</div>
                <h1 class="text-3xl font-bold mb-2">مرحباً بك عزيزي الطالب</h1>
                <p class="text-blue-100">ابحث عن مدرستك وابدأ الاختبار</p>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl p-8 mb-8">
            <label class="block text-gray-800 font-bold mb-4 text-xl">🔍 ابحث عن مدرستك</label>
            <!-- تغيير من القائمة المنسدلة إلى حقل البحث -->
            <input type="text" id="schoolSearch" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:border-blue-500 focus:outline-none" placeholder="اكتب اسم مدرستك للبحث..." oninput="searchSchools()">
            <p class="text-sm text-gray-500 mt-2">ابدأ بكتابة اسم المدرسة للبحث عنها</p>
            
            <!-- قائمة نتائج البحث -->
            <div id="schoolSearchResults" class="mt-4 max-h-60 overflow-y-auto hidden border border-gray-200 rounded-xl">
                <!-- سيتم تعبئة نتائج البحث هنا -->
            </div>
        </div>

        <div id="selectedSchoolInfo" class="hidden bg-white rounded-3xl shadow-xl p-8">
            <div class="bg-green-50 p-6 rounded-2xl mb-6 border border-green-200">
                <h3 class="text-xl font-bold text-green-800 mb-4">المدرسة المختارة</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-green-600 font-semibold">🏫 اسم المدرسة:</span>
                        <span id="chosenSchoolName" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-green-600 font-semibold">👨‍🏫 المعلم:</span>
                        <span id="chosenTeacher" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-gray-800 font-bold mb-4">📝 اختر الاختبار</label>
                <select id="testSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:border-blue-500 focus:outline-none" onchange="selectTest()">
                    <option value="">اختر الاختبار</option>
                </select>
            </div>

            <div id="testInfo" class="hidden bg-blue-50 p-6 rounded-2xl mb-6 border border-blue-200">
                <h3 class="font-bold text-blue-800 mb-4">معلومات الاختبار</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-blue-600 font-semibold">📖 المادة:</span>
                        <span id="testSubject" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">❓ عدد الأسئلة:</span>
                        <span id="testQuestions" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">🎒 الصف الدراسي:</span>
                        <span id="testGrade" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">⏱️ وقت السؤال:</span>
                        <span id="testTimer" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                </div>
            </div>

            <div id="studentForm" class="hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-6">👤 بيانات الطالب</h3>
                
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">اسم الطالب *</label>
                        <input type="text" id="studentName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="أدخل اسم الطالب">
                    </div>
                    <!-- إضافة الصف الدراسي بعد اسم الطالب -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الصف الدراسي *</label>
                        <select id="studentGrade" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            <option value="">سيتم تعبئته تلقائياً</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">يتم تحديد الصف الدراسي تلقائياً حسب الاختبار المحدد</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الفصل *</label>
                        <input type="text" id="studentClass" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="مثال: 6أ">
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="startTest()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-12 py-4 rounded-xl text-xl font-bold hover:from-green-600 hover:to-blue-600 transition-all shadow-lg">
                        🚀 بدء الاختبار
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- شاشة الاختبار -->
<div id="testScreen" class="hidden container mx-auto px-6 py-8">
    <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
            <div class="flex justify-between items-center text-sm">
                <div class="flex gap-4">
                    <span>🏫 <span id="testSchoolName"></span></span>
                    <span>📖 <span id="testSubjectName"></span></span>
                    <span>🎒 <span id="testGradeLevel"></span></span>
                    <span>👤 <span id="testStudentName"></span></span>
                </div>
                <div class="flex gap-4">
                    <span>❓ <span id="currentQuestion">1</span> من <span id="totalQuestions">5</span></span>
                    <span>⭐ <span id="currentScore">0</span></span>
                </div>
            </div>
        </div>
        
        <div class="p-4 bg-gray-50">
            <div class="bg-gray-200 rounded-full h-3">
                <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl p-8">
            <div class="text-center mb-8">
                <div id="timer" class="inline-block bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-2xl font-bold">30</div>
                <p class="text-gray-600 mt-2">الوقت المتبقي</p>
            </div>
            
            <div class="mb-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center" id="questionText">ما هو ناتج 2 + 2؟</h3>
                
                <div class="grid gap-4" id="optionsContainer">
                    <!-- سيتم إضافة الخيارات هنا -->
                </div>
            </div>
            
            <div id="feedbackArea" class="hidden text-center p-4 rounded-xl mb-6"></div>
            
            <div class="text-center pt-6 border-t border-gray-200">
                <button onclick="confirmExitTest()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                    🚪 الخروج من الاختبار
                </button>
            </div>
        </div>
    </div>
</div>

<!-- نافذة تأكيد الخروج -->
<div id="exitTestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl max-w-md w-full overflow-hidden">
        <div class="bg-red-500 text-white p-6 text-center">
            <div class="text-4xl mb-2">⚠️</div>
            <h2 class="text-xl font-bold">تأكيد الخروج</h2>
        </div>
        <div class="p-6 text-center">
            <p class="text-gray-700 mb-6">هل أنت متأكد من رغبتك في الخروج من الاختبار؟</p>
            <div class="flex gap-4">
                <button onclick="exitTest()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold transition-all">
                    نعم، الخروج
                </button>
                <button onclick="cancelExitTest()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                    إلغاء
                </button>
            </div>
        </div>
    </div>
</div>

<!-- شاشة النتائج -->
<div id="resultsScreen" class="hidden container mx-auto px-6 py-12">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden text-center">
            <div class="bg-gradient-to-r from-green-500 to-blue-500 text-white p-12">
                <div class="text-6xl mb-4">🎉</div>
                <h2 class="text-3xl font-bold mb-2">تهانينا على إكمال الاختبار!</h2>
                <p class="text-green-100">إليك نتائجك التفصيلية</p>
            </div>
            
            <div class="p-12">
                <div class="grid md:grid-cols-3 gap-8 mb-8">
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-200">
                        <div class="text-4xl mb-2">📊</div>
                        <h3 class="font-bold text-blue-800 mb-2">النقاط</h3>
                        <p class="text-3xl font-bold text-blue-600" id="finalScore">0</p>
                    </div>
                    
                    <div class="bg-green-50 p-6 rounded-2xl border border-green-200">
                        <div class="text-4xl mb-2">📈</div>
                        <h3 class="font-bold text-green-800 mb-2">النسبة المئوية</h3>
                        <p class="text-3xl font-bold text-green-600" id="percentage">0%</p>
                    </div>
                    
                    <div class="bg-purple-50 p-6 rounded-2xl border border-purple-200">
                        <div class="text-4xl mb-2">🏆</div>
                        <h3 class="font-bold text-purple-800 mb-2">التقدير</h3>
                        <p class="text-2xl font-bold text-purple-600" id="grade">-</p>
                    </div>
                </div>
                
                <div class="flex flex-wrap justify-center gap-4">
                    <button onclick="showCertificate()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-600 transition-all">
                        🏅 عرض الشهادة
                    </button>
                    
                    <button onclick="shareWhatsApp()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        📱 مشاركة بالواتساب
                    </button>
					
                    <button onclick="retakeTest()" class="btn-retake">
                       🔄 إعادة الاختبار
                    </button>
                    
                    <button onclick="goBackToSchoolSelection()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        ← العودة
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- شاشة الشهادة Canvas المحسنة -->
<div id="certificateScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl max-w-4xl w-full max-h-screen overflow-y-auto no-print">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 text-center no-print">
            <h2 class="text-2xl font-bold">🏆 شهادة إنجاز محسنة</h2>
        </div>
        
        <div class="p-8">
            <!-- معاينة الشهادة -->
            <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-4 border-blue-300 rounded-2xl p-8 mb-6">
                <div id="certificatePreview" class="text-center">
                    <!-- سيتم عرض معاينة الشهادة هنا -->
                </div>
            </div>
            
            <!-- canvas مخفي لرسم الشهادة -->
            <canvas id="certificateCanvas" class="hidden" width="2480" height="3508"></canvas>
        </div>
        
        <div class="p-6 text-center border-t border-gray-200 no-print">
            <button onclick="generateCertificateImage('png')" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all mr-4">
                📸 حفظ كصورة PNG
            </button>
            <button onclick="generateCertificateImage('jpg')" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl font-semibold transition-all mr-4">
                🖼️ حفظ كصورة JPG
            </button>
            <button onclick="closeCertificate()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                إغلاق
            </button>
        </div>
    </div>
</div>

<!-- لوحة تحكم المعلم -->
<div id="teacherDashboard" class="hidden container mx-auto px-6 py-8">
    <!-- محتوى لوحة تحكم المعلم -->
    <div class="bg-white rounded-3xl shadow-xl">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-8 rounded-t-3xl">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">لوحة تحكم المعلم</h1>
                    <p class="text-purple-100" id="teacherWelcome">مرحباً أ. عبدالله الشهري</p>
                </div>
                <button onclick="teacherLogout()" class="bg-red-500 hover:bg-red-600 px-6 py-3 rounded-xl font-semibold transition-all">
                    🚪 تسجيل الخروج
                </button>
            </div>
        </div>
        
        <!-- شريط التبويبات -->
        <div class="bg-gray-50 px-8 py-4 border-b border-gray-200">
            <div class="flex gap-2 overflow-x-auto">
                <button onclick="showTab('dashboard')" id="dashboardTab" class="tab-btn active bg-white text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    📊 لوحة المعلومات
                </button>
                <button onclick="showTab('tests')" id="testsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    📝 إدارة الاختبارات
                </button>
                <button onclick="showTab('questions')" id="questionsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    ❓ إدارة الأسئلة
                </button>
                <button onclick="showTab('results')" id="resultsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    📈 نتائج الطلاب
                </button>
                <button onclick="showTab('settings')" id="settingsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    ⚙️ الإعدادات العامة
                </button>
            </div>
        </div>
        
        <!-- محتوى التبويبات -->
        <div class="p-8">
            <!-- تبويب لوحة المعلومات -->
            <div id="dashboardContent" class="tab-content">
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded-2xl text-center border border-blue-200">
                        <div class="text-4xl mb-2">📝</div>
                        <div class="text-3xl font-bold text-blue-600" id="totalTests">1</div>
                        <div class="text-gray-600">اختباراتي</div>
                    </div>
                    <div class="bg-green-50 p-6 rounded-2xl text-center border border-green-200">
                        <div class="text-4xl mb-2">👥</div>
                        <div class="text-3xl font-bold text-green-600" id="totalStudents">0</div>
                        <div class="text-gray-600">الطلاب</div>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-2xl text-center border border-purple-200">
                        <div class="text-4xl mb-2">📊</div>
                        <div class="text-3xl font-bold text-purple-600" id="averageScore">0%</div>
                        <div class="text-gray-600">متوسط الدرجات</div>
                    </div>
                    <div class="bg-orange-50 p-6 rounded-2xl text-center border border-orange-200">
                        <div class="text-4xl mb-2">🎯</div>
                        <div class="text-3xl font-bold text-orange-600" id="passRate">0%</div>
                        <div class="text-gray-600">معدل النجاح</div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-6 rounded-2xl border border-blue-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📊 إحصائيات سريعة</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">إجمالي المحاولات:</span>
                                <span class="font-bold text-blue-600" id="totalAttempts">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">أعلى درجة:</span>
                                <span class="font-bold text-green-600" id="highestScore">0%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">أقل درجة:</span>
                                <span class="font-bold text-red-600" id="lowestScore">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-50 to-blue-50 p-6 rounded-2xl border border-green-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">🎯 أهداف التحسين</h3>
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded-xl">
                                <div class="text-sm text-gray-600 mb-1">معدل النجاح المستهدف</div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                                    </div>
                                    <span class="text-sm font-bold">85%</span>
                                </div>
                            </div>
                            <div class="bg-white p-3 rounded-xl">
                                <div class="text-sm text-gray-600 mb-1">متوسط الدرجات المستهدف</div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: 80%"></div>
                                    </div>
                                    <span class="text-sm font-bold">80%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- تبويب إدارة الاختبارات -->
            <div id="testsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">📝 إدارة الاختبارات</h3>
                    <button onclick="showCreateTestModal()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-600 transition-all">
                        ➕ إنشاء اختبار جديد
                    </button>
                </div>
                
                <div id="testsGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- سيتم إضافة الاختبارات هنا -->
                </div>
            </div>
            
            <!-- تبويب إدارة الأسئلة -->
            <div id="questionsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">❓ إدارة الأسئلة</h3>
                    <div class="flex gap-4">
                        <select id="questionTestSelect" class="border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="loadTestQuestions()">
                            <option value="">اختر الاختبار</option>
                        </select>
                        <button onclick="showAddQuestionModal()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-green-600 hover:to-blue-600 transition-all">
                            ➕ إضافة سؤال
                        </button>
                    </div>
                </div>
                
                <div id="questionsContainer">
                    <div class="text-center text-gray-500 py-12">
                        <div class="text-6xl mb-4">❓</div>
                        <p>اختر اختباراً لعرض الأسئلة</p>
                    </div>
                </div>
            </div>
            
            <!-- تبويب نتائج الطلاب -->
            <div id="resultsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">📈 نتائج الطلاب</h3>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                            📊 Excel
                        </button>
                        <button onclick="exportFilteredToExcel()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                            🔍 Excel مفلتر
                        </button>
                        <button onclick="exportResults()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                            📝 CSV
                        </button>
                        <button onclick="clearAllFilters()" class="btn-clear-filters">
                            🔄 مسح الفلاتر
                        </button>
                    </div>
                </div>
                
                <!-- نظام البحث والفلترة المتقدم -->
                <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="text-2xl">🔍</div>
                        <h4 class="text-lg font-bold text-gray-800">البحث والفلترة المتقدمة</h4>
                        <div class="flex-1"></div>
                        <button onclick="toggleAdvancedFilters()" id="toggleFiltersBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-all">
                            إظهار الفلاتر المتقدمة
                        </button>
                    </div>
                    
                    <!-- مربع البحث -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">🔍 البحث باسم الطالب</label>
                        <input type="text" id="searchStudentName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="اكتب اسم الطالب للبحث..." oninput="filterResults()">
                    </div>
                    
                    <!-- الفلاتر المتقدمة -->
                    <div id="advancedFilters" class="hidden">
                        <div class="grid md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <!-- فلتر الاختبار -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">📝 الاختبار</label>
                                <select id="filterTestSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">جميع الاختبارات</option>
                                </select>
                            </div>
                            
                            <!-- فلتر الفصل -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">🏫 الفصل</label>
                                <select id="filterClassSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">جميع الفصول</option>
                                </select>
                            </div>
                            
                            <!-- فلتر التقدير -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">🏆 التقدير</label>
                                <select id="filterGradeSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">جميع التقديرات</option>
                                    <option value="ممتاز">ممتاز</option>
                                    <option value="جيد جداً">جيد جداً</option>
                                    <option value="جيد">جيد</option>
                                    <option value="مقبول">مقبول</option>
                                    <option value="ضعيف">ضعيف</option>
                                </select>
                            </div>
                            
                            <!-- فلتر النسبة المئوية -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">📊 النسبة المئوية</label>
                                <select id="filterPercentageSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">جميع النسب</option>
                                    <option value="90-100">90% - 100%</option>
                                    <option value="80-89">80% - 89%</option>
                                    <option value="70-79">70% - 79%</option>
                                    <option value="60-69">60% - 69%</option>
                                    <option value="0-59">أقل من 60%</option>
                                </select>
                            </div>
                            
							<!-- فلتر الترتيب حسب الدرجة -->
                            <div>
                               <label class="block text-gray-700 font-semibold mb-2">🎯 ترتيب حسب الدرجة</label>
                               <select id="filterScoreSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value=""> جميع الدرجات </option>
                                    <option value="score-desc">الأعلى درجة (تصاعدي)</option>
                                    <option value="score-asc">الأقل درجة (تنازلي)</option>
                                </select>
                            </div>
                            
                            <!-- فلتر التاريخ -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">📅 التاريخ</label>
                                <select id="filterDateSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">جميع التواريخ</option>
                                    <option value="today">اليوم</option>
                                    <option value="week">هذا الأسبوع</option>
                                    <option value="month">هذا الشهر</option>
                                    <option value="custom">تاريخ محدد</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- اختيار تاريخ محدد -->
                        <div id="customDateFilter" class="hidden mt-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">من تاريخ</label>
                                    <input type="date" id="filterDateFrom" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">إلى تاريخ</label>
                                    <input type="date" id="filterDateTo" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- إحصائيات النتائج المفلترة -->
                    <div id="filterStats" class="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-blue-600" id="filteredCount">0</div>
                                <div class="text-sm text-blue-600">النتائج المعروضة</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-green-600" id="filteredAverage">0%</div>
                                <div class="text-sm text-green-600">متوسط النسب</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-purple-600" id="filteredPassRate">0%</div>
                                <div class="text-sm text-purple-600">معدل النجاح</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-orange-600" id="filteredHighest">0%</div>
                                <div class="text-sm text-orange-600">أعلى نسبة</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-6 rounded-2xl">
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white rounded-xl overflow-hidden">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">اسم الطالب</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">الصف/الفصل</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">الاختبار</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">الدرجة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">النسبة</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">التقدير</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">التاريخ</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- سيتم إضافة النتائج هنا -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- تبويب الإعدادات العامة -->
            <div id="settingsContent" class="tab-content hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">⚙️ الإعدادات العامة</h3>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">👤 معلومات الحساب</h4>
                        <form onsubmit="return updateProfile(event)">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">الاسم الكامل</label>
                                <input type="text" id="profileName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">البريد الإلكتروني</label>
                                <input type="email" id="profileEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 bg-gray-100" readonly>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">اسم المدرسة</label>
                                <input type="text" id="profileSchool" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">المرحلة الدراسية</label>
                                <select id="profileStage" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                                    <option value="ابتدائية">ابتدائية</option>
                                    <option value="متوسطة">متوسطة</option>
                                    <option value="ثانوية">الثانوية</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition-all">
                                حفظ التغييرات
                            </button>
                        </form>
                    </div>
					<!-- أدوات التصحيح - ستظهر فقط لـ chartgain2019@gmail.com -->
                    <div id="debugToolsSection" class="hidden">
                       <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                           <h4 class="text-lg font-bold text-yellow-800 mb-2">🛠️ أدوات التصحيح (خاصة بالمسؤول)</h4>
                           <div class="flex gap-2">
                                <button onclick="initializeDefaultData()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                   إصلاح البيانات
                                </button>
                                <button onclick="debugData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                   فحص البيانات
                                </button>
                                <button onclick="debugSystem()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    فحص النظام
                                </button>
                                <button onclick="showAllSchools()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    عرض المدارس
                                </button>
								<!-- أضف هذه الأزرار الجديدة -->
                                <button onclick="createBackup()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    💾 نسخ احتياطي
                                </button>
                                <button onclick="showRestoreBackupModal()" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    📥 استعادة
                                </button>
                                <button onclick="showBackupManager()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold transition-all shadow-sm">   
                                    🗂️ إدارة النسخ
                                </button>
                            </div>
                            <p class="text-xs text-yellow-700 mt-2">
							    هذه الأدوات خاصة بالمسؤول وتظهر فقط لحساب chartgain2019@gmail.com
							</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">🔒 تغيير كلمة المرور</h4>
                        <form onsubmit="return changePassword(event)">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">كلمة المرور الحالية</label>
                                <input type="password" id="currentPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">كلمة المرور الجديدة</label>
                                <input type="password" id="newPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">تأكيد كلمة المرور الجديدة</label>
                                <input type="password" id="confirmNewPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-all">
                                تغيير كلمة المرور
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== النوافذ المنبثقة الجديدة ========== -->

<!-- نافذة إنشاء وتعديل الاختبار -->
<div id="testModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center sticky top-0 z-10">
            <h2 class="text-2xl font-bold" id="testModalTitle">إنشاء اختبار جديد</h2>
        </div>
        
        <div class="p-8">
            <form id="testModalForm" onsubmit="return handleTestFormSubmit(event)">
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">اسم الاختبار</label>
                        <input type="text" id="modalTestName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="مثال: اختبار الفصل الثاني" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">المادة</label>
                        <input type="text" id="modalTestSubject" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="مثال: الرياضيات، العلوم، اللغة العربية..." required>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">🎒 الصف الدراسي</label>
                        <select id="modalTestGrade" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            <option value="">اختر الصف الدراسي</option>
                            <!-- سيتم تعبئة الخيارات ديناميكياً حسب المرحلة -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">⏱️ وقت كل سؤال (بالثواني)</label>
                        <input type="number" id="modalTestTimer" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="30" min="10" max="300" value="30" required>
                        <p class="text-xs text-gray-500 mt-1">من 10 إلى 300 ثانية</p>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">📊 مستوى الصعوبة</label>
                        <select id="modalTestDifficulty" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none">
                            <option value="سهل">سهل</option>
                            <option value="متوسط" selected>متوسط</option>
                            <option value="صعب">صعب</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">وصف الاختبار</label>
                    <textarea id="modalTestDescription" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" rows="3" placeholder="وصف مختصر للاختبار..."></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        حفظ الاختبار
                    </button>
                    <button type="button" onclick="closeTestModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        إلغاء
                    </button>
                </div>
            </form>
            
            <div id="testModalError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<!-- نافذة إضافة وتعديل السؤال -->
<div id="questionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 text-center sticky top-0 z-10">
            <h2 class="text-2xl font-bold" id="questionModalTitle">إضافة سؤال جديد</h2>
        </div>
        
        <div class="p-8">
            <form id="questionModalForm" onsubmit="return handleQuestionFormSubmit(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">نص السؤال</label>
                    <textarea id="modalQuestionText" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" rows="3" placeholder="اكتب السؤال هنا..." required></textarea>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الخيار الأول</label>
                        <input type="text" id="modalOption1" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="الخيار الأول" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الخيار الثاني</label>
                        <input type="text" id="modalOption2" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="الخيار الثاني" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الخيار الثالث</label>
                        <input type="text" id="modalOption3" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="الخيار الثالث" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">الخيار الرابع</label>
                        <input type="text" id="modalOption4" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="الخيار الرابع" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">الإجابة الصحيحة</label>
                    <select id="modalCorrectAnswer" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                        <option value="">اختر الإجابة الصحيحة</option>
                        <option value="0">الخيار الأول</option>
                        <option value="1">الخيار الثاني</option>
                        <option value="2">الخيار الثالث</option>
                        <option value="3">الخيار الرابع</option>
                    </select>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        حفظ السؤال
                    </button>
                    <button type="button" onclick="closeQuestionModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        إلغاء
                    </button>
                </div>
            </form>
            
            <div id="questionModalError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<script>
// ========== أنظمة الاستقرار والأمان المحسنة ==========

// نظام معالجة الأخطاء المركزي
const ErrorHandler = {
    logError: function(error, context = '') {
        console.error(`[SYSTEM_ERROR] في ${context}:`, error);
        this.showUserError(error, context);
        
        // تسجيل الخطأ في التخزين المحلي للتحليل
        this.logToStorage(error, context);
    },
    
    showUserError: function(error, context = '') {
        try {
            const errorMessage = this.getUserFriendlyMessage(error);
            this.displayErrorModal(errorMessage, context);
        } catch (modalError) {
            console.error('Failed to show error modal:', modalError);
            // عرض رسالة بديلة بسيطة
            alert('حدث خطأ في النظام. يرجى تحديث الصفحة.');
        }
    },
    
    getUserFriendlyMessage: function(error) {
        if (error.name === 'QuotaExceededError') {
            return 'تم تجاوز سعة التخزين. يرجى حذف بعض البيانات القديمة.';
        } else if (error.name === 'SyntaxError') {
            return 'خطأ في البيانات المخزنة. سيتم إعادة تعيين البيانات تلقائياً.';
        } else if (error.message && error.message.includes('network')) {
            return 'فشل في الاتصال بالشبكة. يرجى التحقق من اتصال الإنترنت.';
        } else {
            return 'حدث خطأ غير متوقع. يرجى تحديث الصفحة والمحاولة مرة أخرى.';
        }
    },
    
    displayErrorModal: function(message, context = '') {
        const modalId = 'errorModal-' + Date.now();
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-3xl max-w-md w-full overflow-hidden">
                    <div class="bg-red-500 text-white p-6 text-center">
                        <div class="text-4xl mb-2">⚠️</div>
                        <h2 class="text-xl font-bold">${context ? `خطأ في ${context}` : 'حدث خطأ'}</h2>
                    </div>
                    <div class="p-6 text-center">
                        <p class="text-gray-700 mb-6">${message}</p>
                        <div class="flex gap-4">
                            <button onclick="document.getElementById('${modalId}').remove()" 
                                    class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold transition-all">
                                موافق
                            </button>
                            <button onclick="location.reload()" 
                                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition-all">
                                تحديث الصفحة
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    },
    
    logToStorage: function(error, context) {
        try {
            const errorLog = {
                timestamp: new Date().toISOString(),
                context: context,
                error: {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                },
                userAgent: navigator.userAgent
            };
            
            const existingLogs = StorageManager.getItem('errorLogs') || [];
            existingLogs.push(errorLog);
            
            // حفظ آخر 50 خطأ فقط
            if (existingLogs.length > 50) {
                existingLogs.splice(0, existingLogs.length - 50);
            }
            
            StorageManager.setItem('errorLogs', existingLogs);
        } catch (logError) {
            console.error('Failed to log error:', logError);
        }
    }
};

// نظام إدارة الموارد
const ResourceManager = {
    timers: new Set(),
    eventListeners: new Map(),
    activeSessions: new Set(),
    
    addTimer: function(timer) {
        this.timers.add(timer);
        return timer;
    },
    
    clearAllTimers: function() {
        this.timers.forEach(timer => {
            try {
                clearInterval(timer);
                clearTimeout(timer);
            } catch (error) {
                console.warn('Error clearing timer:', error);
            }
        });
        this.timers.clear();
    },
    
    addEventListener: function(element, event, handler) {
        if (!element || !element.addEventListener) {
            console.warn('Invalid element for event listener');
            return;
        }
        
        try {
            element.addEventListener(event, handler);
            const key = `${element.id || 'unknown'}-${event}`;
            if (!this.eventListeners.has(key)) {
                this.eventListeners.set(key, []);
            }
            this.eventListeners.get(key).push({element, event, handler});
        } catch (error) {
            ErrorHandler.logError(error, 'addEventListener');
        }
    },
    
    clearAllEventListeners: function() {
        this.eventListeners.forEach((listeners, key) => {
            listeners.forEach(({element, event, handler}) => {
                try {
                    if (element && element.removeEventListener) {
                        element.removeEventListener(event, handler);
                    }
                } catch (error) {
                    console.warn('Error removing event listener:', error);
                }
            });
        });
        this.eventListeners.clear();
    },
    
    registerSession: function(sessionId) {
        this.activeSessions.add(sessionId);
    },
    
    cleanupSession: function(sessionId) {
        this.activeSessions.delete(sessionId);
    },
    
    cleanup: function() {
        this.clearAllTimers();
        this.clearAllEventListeners();
        this.activeSessions.clear();
    }
};


// ========== الدوال الأساسية للشاشات ==========
function showStudentAccess() {
    try {
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('studentAccessScreen').classList.remove('hidden');
    } catch (error) {
        console.error('Error in showStudentAccess:', error);
    }
}

function showTeacherLogin() {
    try {
        document.getElementById('teacherLoginScreen').classList.remove('hidden');
    } catch (error) {
        console.error('Error in showTeacherLogin:', error);
    }
}

function closeTeacherLogin() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        const loginError = document.getElementById('loginError');
        if (loginError) loginError.classList.add('hidden');
    } catch (error) {
        console.error('Error in closeTeacherLogin:', error);
    }
}

function showTeacherSignup() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        document.getElementById('teacherSignupScreen').classList.remove('hidden');
    } catch (error) {
        console.error('Error in showTeacherSignup:', error);
    }
}

function closeTeacherSignup() {
    try {
        document.getElementById('teacherSignupScreen').classList.add('hidden');
        const signupError = document.getElementById('signupError');
        const signupSuccess = document.getElementById('signupSuccess');
        const signupForm = document.getElementById('teacherSignupForm');
        
        if (signupError) signupError.classList.add('hidden');
        if (signupSuccess) signupSuccess.classList.add('hidden');
        if (signupForm) signupForm.reset();
    } catch (error) {
        console.error('Error in closeTeacherSignup:', error);
    }
}

function goBackToWelcome() {
    try {
        // تنظيف الموارد أولاً
        if (typeof ResourceManager !== 'undefined') {
            ResourceManager.cleanup();
        }
        
        // إخفاء جميع الشاشات
        const screens = [
            'studentAccessScreen',
            'teacherDashboard', 
            'testScreen',
            'resultsScreen'
        ];
        
        screens.forEach(screen => {
            const element = document.getElementById(screen);
            if (element) element.classList.add('hidden');
        });
        
        // إظهار الشاشة الرئيسية
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // إعادة تعيين حقول البحث
        const schoolSearch = document.getElementById('schoolSearch');
        const searchResults = document.getElementById('schoolSearchResults');
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        
        if (schoolSearch) schoolSearch.value = '';
        if (searchResults) searchResults.classList.add('hidden');
        if (selectedSchoolInfo) selectedSchoolInfo.classList.add('hidden');
        
    } catch (error) {
        console.error('Error in goBackToWelcome:', error);
    }
}

// دالة إغلاق النافذة المنبثقة مع تأثيرات بصرية ومعالجة أخطاء
function closeModal(modalId) {
    try {
        const modal = document.getElementById(modalId);
        if (modal) {
            // إضافة تأثير fadeOut إذا لم يكن موجوداً
            if (!modal.style.animation) {
                modal.style.animation = 'fadeOut 0.3s ease-out';
            }
            
            // إزالة النافذة بعد انتهاء التأثير
            setTimeout(() => {
                if (modal && modal.parentNode) {
                    modal.remove();
                }
            }, 300);
        }
    } catch (error) {
        // استخدام ErrorHandler إذا كان متاحاً، وإلا استخدام console.error
        if (typeof ErrorHandler !== 'undefined' && ErrorHandler.logError) {
            ErrorHandler.logError(error, 'closeModal');
        } else {
            console.error('Error closing modal:', error);
        }
    }
}

// ========== دوال نتائج الطلاب ==========
function updateResultsTable(filteredResults) {
    try {
        const tableBody = document.getElementById('resultsTableBody');
        if (!tableBody) return;

        if (!filteredResults || filteredResults.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                        <div class="text-4xl mb-2">📭</div>
                        <p>لا توجد نتائج مطابقة للبحث</p>
                    </td>
                </tr>
            `;
            return;
        }

        let tableHTML = '';
        filteredResults.forEach(result => {
            const percentage = result.percentage || Math.round((result.score / result.total) * 100);
            const grade = result.gradeLevel || calculateGrade(percentage);
            
            tableHTML += `
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-all">
                    <td class="px-6 py-4 text-right">
                        <div class="font-semibold text-gray-800">${result.name}</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-sm">
                            ${result.grade} - ${result.class}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="font-semibold">${result.test}</div>
                        <div class="text-sm text-gray-600">${result.subject}</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-bold text-blue-600">${result.score}/${result.total}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-bold ${percentage >= 60 ? 'text-green-600' : 'text-red-600'}">
                            ${percentage}%
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="px-2 py-1 rounded-full text-sm font-semibold ${getGradeColor(grade)}">
                            ${grade}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right text-sm text-gray-600">
                        ${result.date || new Date(result.timestamp).toLocaleDateString('ar-SA')}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex gap-2 justify-end">
                            <button onclick="showResultDetails(${result.id})" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-semibold transition-all">
                                تفاصيل
                            </button>
                            <button onclick="deleteResult(${result.id})" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-semibold transition-all">
                                حذف
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        tableBody.innerHTML = tableHTML;
    } catch (error) {
        console.error('Error updating results table:', error);
        ErrorHandler.logError(error, 'updateResultsTable');
    }
}

function getGradeColor(grade) {
    const colors = {
        'ممتاز': 'bg-green-100 text-green-600',
        'جيد جداً': 'bg-blue-100 text-blue-600',
        'جيد': 'bg-yellow-100 text-yellow-600',
        'مقبول': 'bg-orange-100 text-orange-600',
        'ضعيف': 'bg-red-100 text-red-600'
    };
    return colors[grade] || 'bg-gray-100 text-gray-600';
}

function calculateGrade(percentage) {
    if (percentage >= 90) return 'ممتاز';
    else if (percentage >= 80) return 'جيد جداً';
    else if (percentage >= 70) return 'جيد';
    else if (percentage >= 60) return 'مقبول';
    else return 'ضعيف';
}

function showResultDetails(resultId) {
    try {
        const results = getResultsSync();
        const result = results.find(r => r.id === resultId);
        
        if (!result) {
            alert('النتيجة غير موجودة');
            return;
        }
        
        const modalId = 'resultDetailsModal_' + Date.now();
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center">
                        <h2 class="text-2xl font-bold">تفاصيل النتيجة</h2>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-xl">
                                    <div class="text-gray-600">اسم الطالب</div>
                                    <div class="font-bold">${result.name}</div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-xl">
                                    <div class="text-gray-600">الصف/الفصل</div>
                                    <div class="font-bold">${result.grade} - ${result.class}</div>
                                </div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-xl">
                                <div class="text-blue-600">الاختبار</div>
                                <div class="font-bold">${result.test} - ${result.subject}</div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-green-50 p-4 rounded-xl text-center">
                                    <div class="text-green-600">الدرجة</div>
                                    <div class="font-bold text-2xl">${result.score}/${result.total}</div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-xl text-center">
                                    <div class="text-purple-600">النسبة</div>
                                    <div class="font-bold text-2xl">${result.percentage}%</div>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-xl text-center">
                                    <div class="text-orange-600">التقدير</div>
                                    <div class="font-bold text-xl">${result.gradeLevel}</div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <button onclick="closeModal('${modalId}')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    } catch (error) {
        console.error('Error showing result details:', error);
        ErrorHandler.logError(error, 'showResultDetails');
    }
}

function deleteResult(resultId) {
    try {
        if (!confirm('هل أنت متأكد من حذف هذه النتيجة؟')) {
            return;
        }
        
        const results = getResultsSync();
        const updatedResults = results.filter(r => r.id !== resultId);
        
        const success = StorageManager.setItem('testResults', updatedResults);
        if (success) {
            showSuccessMessage('تم الحذف', 'تم حذف النتيجة بنجاح');
            filterResults(); // إعادة تحميل النتائج
        } else {
            showErrorMessage('خطأ', 'فشل في حذف النتيجة');
        }
    } catch (error) {
        console.error('Error deleting result:', error);
        ErrorHandler.logError(error, 'deleteResult');
    }
}

// ========== نظام API للخادم البعيد ==========
// ========== نظام API للخادم البعيد المحسن ==========
// ========== نظام API للخادم البعيد المحسن ==========
// ========== نظام API للخادم البعيد المحدث ==========
// ========== نظام API للخادم البعيد المحدث ==========
const RemoteAPI = {
    baseURL: 'https://quiz-system-api.onrender.com',
    isAvailable: false,
    endpointsChecked: false,
    
    async request(endpoint, options = {}) {
        const apiEndpoint = endpoint.startsWith('/api') ? endpoint : `/api${endpoint}`;
        const url = `${this.baseURL}${apiEndpoint}`;
        
        try {
            const response = await fetch(url, {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers,
                },
                ...options,
            });

            if (!response.ok) {
                if (response.status === 404) {
                    console.log(`ℹ️ Endpoint ${apiEndpoint} غير موجود`);
                    return null;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.warn(`فشل الاتصال بـ ${apiEndpoint}:`, error.message);
            this.isAvailable = false;
            return null;
        }
    },

    // التحقق من توفر الخادم
    async checkEndpoints() {
        if (this.endpointsChecked) return this.isAvailable;
        
        try {
            console.log('🔍 التحقق من توفر الخادم...');
            
            // اختبار الاتصال الأساسي
            const testResponse = await fetch(`${this.baseURL}/api/health`, { 
                method: 'GET'
            }).catch(() => null);
            
            this.isAvailable = testResponse && testResponse.ok;
            this.endpointsChecked = true;
            
            console.log(`✅ الخادم ${this.isAvailable ? 'متوفر' : 'غير متوفر'}`);
            return this.isAvailable;
            
        } catch (error) {
            console.log('❌ الخادم غير متوفر:', error.message);
            this.isAvailable = false;
            this.endpointsChecked = true;
            return false;
        }
    },

    // دالة التحقق من صحة الخادم
    async getHealth() {
        try {
            const response = await fetch(`${this.baseURL}/api/health`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            return response.ok;
        } catch (error) {
            return false;
        }
    },

    // ========== المدارس ==========
    async getSchools() {
        if (!this.isAvailable) return {};
        const result = await this.request('/all-schools');
        return result || [];
    },

    async createSchool(schoolData) {
        if (!this.isAvailable) {
            console.log('💾 حفظ المدرسة محلياً (الخادم غير متوفر)');
            return null;
        }
        return this.request('/schools', {
            method: 'POST',
            body: JSON.stringify(schoolData),
        });
    },

    // ========== المعلمين ==========
    async getTeachers() {
        if (!this.isAvailable) return {};
        const result = await this.request('/teachers');
        return result || {};
    },

    async createTeacher(teacherData) {
        if (!this.isAvailable) {
            console.log('💾 حفظ المعلم محلياً (الخادم غير متوفر)');
            return null;
        }
        return this.request('/register', {
            method: 'POST',
            body: JSON.stringify(teacherData),
        });
    },

    // ========== النتائج ==========
    async getResults() {
        if (!this.isAvailable) return [];
        const result = await this.request('/results');
        return result || [];
    },

    async createResult(resultData) {
        if (!this.isAvailable) {
            console.log('💾 حفظ النتيجة محلياً (الخادم غير متوفر)');
            return null;
        }
        return this.request('/results', {
            method: 'POST',
            body: JSON.stringify(resultData),
        });
    },

    // ========== دوال تسجيل الدخول ==========
    async login(loginData) {
        if (!this.isAvailable) {
            console.log('🔐 استخدام تسجيل الدخول المحلي');
            return null;
        }
        return this.request('/login', {
            method: 'POST',
            body: JSON.stringify(loginData),
        });
    },

    async changePassword(passwordData) {
        if (!this.isAvailable) {
            console.log('🔐 تغيير كلمة المرور محلياً');
            return null;
        }
        return this.request('/change-password', {
            method: 'POST',
            body: JSON.stringify(passwordData),
        });
    }
};

// ========== دوال حالة النظام والاتصال ==========

// عرض حالة اتصال الخادم
function showServerStatus() {
    const status = RemoteAPI.isAvailable ? '🟢 متصل' : '🔴 غير متصل';
    console.log(`حالة الخادم البعيد: ${status}`);
    
    // عرض مؤشر مرئي في الواجهة
    if (!RemoteAPI.isAvailable) {
        console.log('💡 النظام يعمل في الوضع المحلي - البيانات محفوظة على جهازك');
        
        // إضافة مؤشر مرئي في الصفحة (اختياري)
        const statusIndicator = document.createElement('div');
        statusIndicator.id = 'serverStatusIndicator';
        statusIndicator.className = 'fixed bottom-4 left-4 bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg z-40 flex items-center gap-2';
        statusIndicator.innerHTML = `
            <span class="text-sm">🔴 وضع عدم الاتصال</span>
            <span class="text-xs">البيانات محفوظة محلياً</span>
        `;
        document.body.appendChild(statusIndicator);
        
        // إزالة المؤشر بعد 5 ثواني
        setTimeout(() => {
            if (document.body.contains(statusIndicator)) {
                statusIndicator.remove();
            }
        }, 5000);
    } else {
        console.log('✅ الاتصال بالخادم البعيد نشط');
        
        // مؤشر اتصال ناجح (اختياري)
        const statusIndicator = document.createElement('div');
        statusIndicator.id = 'serverStatusIndicator';
        statusIndicator.className = 'fixed bottom-4 left-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-40 flex items-center gap-2';
        statusIndicator.innerHTML = `
            <span class="text-sm">🟢 متصل بالخادم</span>
            <span class="text-xs">المزامنة نشطة</span>
        `;
        document.body.appendChild(statusIndicator);
        
        // إزالة المؤشر بعد 3 ثواني
        setTimeout(() => {
            if (document.body.contains(statusIndicator)) {
                statusIndicator.remove();
            }
        }, 3000);
    }
}

// تهيئة النظام مع دعم الخادم البعيد المحسن
// استبدل دالة initializeSystem بالكود التالي
async function initializeSystem() {
    try {
        showLoadingMessage('جاري تهيئة النظام...');
        
        // تنظيف البيانات التالفة
        cleanupCorruptedData();
        
        // تحميل البيانات الأساسية أولاً من التخزين المحلي (للسرعة)
        const storedTeachers = StorageManager.getItem('teacherAccounts');
        const storedSchools = StorageManager.getItem('demoSchoolsData');
        const storedResults = StorageManager.getItem('testResults');
        
        if (storedTeachers) Object.assign(demoData.users, storedTeachers);
        if (storedSchools) Object.assign(demoData.schools, storedSchools);
        
        console.log('✅ تم التحميل المبدئي من التخزين المحلي');
        
        // ثم محاولة مزامنة مع الخادم البعيد (في الخلفية)
        setTimeout(async () => {
            try {
                console.log('🔄 محاولة المزامنة مع الخادم البعيد...');
                
                // التحقق من توفر الخادم أولاً
                const isServerAvailable = await RemoteAPI.checkEndpoints();
                
                if (isServerAvailable) {
                    await Promise.all([
                        loadTeacherAccounts(),
                        loadSchools(),
                        loadResults()
                    ]);
                    
                    // مزامنة البيانات المحلية مع الخادم
                    await RemoteAPI.syncLocalDataToRemote();
                    
                    console.log('✅ اكتملت مزامنة البيانات مع الخادم البعيد');
                } else {
                    console.log('ℹ️ الخادم البعيد غير متوفر، استخدام البيانات المحلية');
                }
                
            } catch (syncError) {
                console.log('ℹ️ المزامنة مع الخادم البعيد غير متاحة، استخدام البيانات المحلية');
            }
            
            // عرض حالة الخادم بعد المحاولة
            showServerStatus();
        }, 1000);
        
        // تحميل المدارس للمعلمين الحاليين
        loadSchoolsForExistingTeachers();
        
        // إعداد نظام الاسترجاع
        SystemRecovery.initialize();
        
        // تحديث الإحصائيات
        updateWelcomeStatistics();
        
        hideLoadingMessage();
        
        // عرض حالة أولية للخادم
        showServerStatus();
        
        console.log('✅ تم تهيئة النظام بنجاح - جاهز للاستخدام');
        
    } catch (error) {
        hideLoadingMessage();
        ErrorHandler.logError(error, 'initializeSystem');
        showErrorMessage('خطأ في التهيئة', 'تعذر تهيئة النظام بالكامل');
        
        // عرض حالة الخادم حتى في حالة الخطأ
        showServerStatus();
    }
}

// أضف هذه الدالة المساعدة
function loadSchoolsForExistingTeachers() {
    try {
        console.log('بدء تحميل المدارس للمعلمين الحاليين...');
        
        // لكل معلم، تأكد من وجود مدرسته
        Object.values(demoData.users).forEach(teacher => {
            if (teacher.school && teacher.name) {
                let schoolExists = false;
                
                // البحث عن مدرسة المعلم
                for (const schoolId in demoData.schools) {
                    if (demoData.schools[schoolId].teacher === teacher.name) {
                        schoolExists = true;
                        break;
                    }
                }
                
                // إذا لم توجد مدرسة، إنشاؤها
                if (!schoolExists) {
                    const newSchoolId = 'school_' + Date.now();
                    demoData.schools[newSchoolId] = {
                        id: newSchoolId,
                        name: teacher.school,
                        teacher: teacher.name,
                        tests: []
                    };
                    console.log(`تم إنشاء مدرسة جديدة للمعلم: ${teacher.name}`);
                }
            }
        });
        
        // حفظ التحديثات
        StorageManager.setItem('demoSchoolsData', demoData.schools);
        console.log('تم حفظ بيانات المدارس:', Object.keys(demoData.schools).length, 'مدرسة');
        
    } catch (error) {
        console.error('خطأ في تحميل المدارس للمعلمين:', error);
        ErrorHandler.logError(error, 'loadSchoolsForExistingTeachers');
    }
}

// نظام التخزين المحسّن
const StorageManager = {
    setItem: function(key, value) {
        try {
            // التحقق من سعة التخزين المتاحة
            if (!this.isStorageAvailable()) {
                throw new Error('LocalStorage not available');
            }
            
            const data = JSON.stringify({
                value: value,
                timestamp: Date.now(),
                version: '1.0'
            });
            
            // التحقق من حجم البيانات
            if (data.length > 5000000) { // 5MB
                console.warn(`Large data detected for ${key}: ${data.length} bytes`);
                this.handleLargeData(key, value);
                return false;
            }
            
            localStorage.setItem(key, data);
            return true;
        } catch (error) {
            if (error.name === 'QuotaExceededError') {
                this.handleQuotaExceeded();
            }
            ErrorHandler.logError(error, `StorageManager.setItem(${key})`);
            return false;
        }
    },
	getItem: function(key) {
       try {
          if (!this.isStorageAvailable()) return null;
        
          const item = localStorage.getItem(key);
          if (!item) return null;
        
          // معالجة أفضل للأنواع المختلفة
           if (key === 'authToken' && item.startsWith('eyJ')) {
               return item;
            }
        
           try {
              return JSON.parse(item).value;
            } catch {
                return item; // إرجاع القيمة الأصلية إذا فشل التحليل
            }
        } catch (error) {
            ErrorHandler.logError(error, `StorageManager.getItem(${key})`);
            return null;
        }
    },
    
    tryRecoverData: function(key) {
        try {
            const item = localStorage.getItem(key);
            if (!item) return null;
            
            // محاولة إصلاح JSON تالف
            const fixedJson = item
                .replace(/[\u0000-\u0019]+/g, "")
                .replace(/([{,]\s*)([a-zA-Z0-9_]+)(\s*:)/g, '$1"$2"$3');
                
            const parsed = JSON.parse(fixedJson);
            return parsed.value || parsed;
        } catch (recoveryError) {
            console.error(`Failed to recover data for ${key}:`, recoveryError);
            // حذف البيانات التالفة
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.error('Failed to remove corrupted data:', e);
            }
            return null;
        }
    },
    
    isStorageAvailable: function() {
        try {
            const test = 'storage_test';
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
            return true;
        } catch (error) {
            return false;
        }
    },
    
    handleQuotaExceeded: function() {
        // مسح البيانات القديمة تلقائياً
        const cleared = this.clearOldData();
        if (cleared) {
            ErrorHandler.showUserError(new Error('تم تنظيف التخزين تلقائياً. يرجى المحاولة مرة أخرى.'));
        } else {
            ErrorHandler.showUserError(new Error('التخزين ممتلئ. يرجى حذف بعض البيانات يدوياً.'));
        }
    },
    
    handleLargeData: function(key, value) {
        // لمعلومات كبيرة، نقوم بضغطها أو تقسيمها
        if (Array.isArray(value) && value.length > 1000) {
            // حفظ الجزء الأخير فقط من المصفوفات الكبيرة
            const trimmedValue = value.slice(-1000);
            return this.setItem(key, trimmedValue);
        }
        return false;
    },
    
    clearOldData: function() {
        try {
            const oneWeekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            let cleared = false;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('testResult_')) {
                    try {
                        const item = localStorage.getItem(key);
                        if (item) {
                            const parsed = JSON.parse(item);
                            if (parsed.timestamp && parsed.timestamp < oneWeekAgo) {
                                localStorage.removeItem(key);
                                cleared = true;
                            }
                        }
                    } catch (e) {
                        // تخطي العناصر التالفة
                        continue;
                    }
                }
            }
            
            return cleared;
        } catch (error) {
            ErrorHandler.logError(error, 'clearOldData');
            return false;
        }
    },
    
    getStorageInfo: function() {
        let totalSize = 0;
        const items = [];
        
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            const value = localStorage.getItem(key);
            totalSize += key.length + (value ? value.length : 0);
            items.push({
                key: key,
                size: (key.length + (value ? value.length : 0)) / 1024, // KB
                timestamp: this.getItem(key)?.timestamp || 'unknown'
            });
        }
        
        return {
            totalSize: totalSize / 1024 / 1024, // MB
            itemCount: localStorage.length,
            items: items.sort((a, b) => b.size - a.size)
        };
    }
};

function cleanupCorruptedData() {
    try {
        const keysToCheck = ['authToken', 'sessionData', 'userData'];
        
        keysToCheck.forEach(key => {
            try {
                const item = localStorage.getItem(key);
                if (item) {
                    // محاولة تحليل JSON للتأكد من صحته
                    JSON.parse(item);
                }
            } catch (error) {
                // إذا فشل التحليل، احذف البيانات التالفة
                console.warn(`Removing corrupted data for key: ${key}`);
                localStorage.removeItem(key);
            }
        });
    } catch (error) {
        console.error('Error in cleanupCorruptedData:', error);
    }
}

// نظام التحقق من صحة البيانات
const DataValidator = {
    validateStudentData: function(data) {
        const errors = [];
        
        if (!data.name || data.name.trim().length < 2) {
            errors.push('اسم الطالب يجب أن يكون على الأقل حرفين');
        }
        
        if (data.name && data.name.trim().length > 100) {
            errors.push('اسم الطالب طويل جداً (الحد الأقصى 100 حرف)');
        }
        
        if (!data.grade) {
            errors.push('الصف الدراسي مطلوب');
        }
        
        if (!data.class || data.class.trim().length === 0) {
            errors.push('الفصل الدراسي مطلوب');
        }
        
        if (data.class && data.class.trim().length > 50) {
            errors.push('اسم الفصل طويل جداً (الحد الأقصى 50 حرف)');
        }
        
        return {
            isValid: errors.length === 0,
            errors: errors
        };
    },
    
    validateTestData: function(test) {
        const errors = [];
        
        if (!test.questions || test.questions.length === 0) {
            errors.push('الاختبار يجب أن يحتوي على أسئلة');
        }
        
        if (test.questions && test.questions.length > 100) {
            errors.push('عدد الأسئلة كبير جداً (الحد الأقصى 100 سؤال)');
        }
        
        if (!test.timerPerQuestion || test.timerPerQuestion < 10) {
            errors.push('وقت السؤال يجب أن يكون 10 ثواني على الأقل');
        }
        
        if (test.timerPerQuestion > 300) {
            errors.push('وقت السؤال كبير جداً (الحد الأقصى 300 ثانية)');
        }
        
        if (!test.name || test.name.trim().length < 2) {
            errors.push('اسم الاختبار يجب أن يكون على الأقل حرفين');
        }
        
        return {
            isValid: errors.length === 0,
            errors: errors
        };
    },
    
    validateEmail: function(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    },
    
    validatePassword: function(password) {
        if (password.length < 6) {
            return 'كلمة المرور يجب أن تكون 6 أحرف على الأقل';
        }
        if (password.length > 50) {
            return 'كلمة المرور طويلة جداً';
        }
        return null;
    },
    
    sanitizeInput: function(input) {
        if (typeof input !== 'string') return input;
        
        return input
            .trim()
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/'/g, '&#39;')
            .replace(/"/g, '&#34;')
            .substring(0, 1000); // الحد الأقصى للأطوال
    }
};

// نظام استرجاع النظام
const SystemRecovery = {
    initialize: function() {
        this.setupErrorHandling();
        this.setupPerformanceMonitoring();
        
        if (!this.checkSystemHealth()) {
            this.showSystemWarning();
        }
        
        // محاولة استرجاع الجلسة السابقة
        this.recoverPreviousSession();
    },
    
    setupErrorHandling: function() {
        // معالجة أخطاء JavaScript الغير معالجة
        window.addEventListener('error', (event) => {
            ErrorHandler.logError(event.error, 'Unhandled Global Error');
        });
        
        // معالجة وعود مرفوضة غير معالجة
        window.addEventListener('unhandledrejection', (event) => {
            ErrorHandler.logError(event.reason, 'Unhandled Promise Rejection');
        });
        
        // مراقبة تحميل الصور والفشل فيها
        window.addEventListener('error', (event) => {
            if (event.target && (event.target.tagName === 'IMG' || event.target.tagName === 'SCRIPT' || event.target.tagName === 'LINK')) {
                console.warn('Failed to load resource:', event.target.src || event.target.href);
            }
        }, true);
    },
    
    setupPerformanceMonitoring: function() {
        // مراقبة أداء النظام
        if ('performance' in window) {
            const navTiming = performance.getEntriesByType('navigation')[0];
            if (navTiming) {
                console.log(`Page loaded in ${navTiming.loadEventEnd - navTiming.navigationStart}ms`);
            }
        }
        
        // مراقبة استخدام الذاكرة
        if ('memory' in performance) {
            setInterval(() => {
                const memory = performance.memory;
                if (memory.usedJSHeapSize > memory.jsHeapSizeLimit * 0.8) {
                    console.warn('High memory usage detected:', memory);
                }
            }, 30000);
        }
    },
    
    checkSystemHealth: function() {
        const checks = {
            localStorage: this.checkLocalStorage(),
            json: this.checkJSON(),
            timers: this.checkTimers(),
            dom: this.checkDOM()
        };
        
        const failedChecks = Object.entries(checks).filter(([_, passed]) => !passed).map(([check]) => check);
        
        if (failedChecks.length > 0) {
            console.warn('System health check failed for:', failedChecks);
            return false;
        }
        
        return true;
    },
    
    checkLocalStorage: function() {
        return StorageManager.isStorageAvailable();
    },
    
    checkJSON: function() {
        try {
            JSON.parse('{"test": true}');
            JSON.stringify({test: true});
            return true;
        } catch {
            return false;
        }
    },
    
    checkTimers: function() {
        try {
            const testTimer = setTimeout(() => {}, 100);
            clearTimeout(testTimer);
            return true;
        } catch {
            return false;
        }
    },
    
    checkDOM: function() {
        try {
            document.createElement('div');
            return true;
        } catch {
            return false;
        }
    },
    
    showSystemWarning: function() {
        const warning = document.createElement('div');
        warning.className = 'fixed top-4 left-4 right-4 bg-yellow-500 text-white p-4 rounded-xl shadow-lg z-40';
        warning.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">⚠️</span>
                    <div>
                        <div class="font-bold">تحذير النظام</div>
                        <div class="text-sm">قد لا يعمل النظام بشكل مثالي في بيئتك الحالية</div>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                    ✕
                </button>
            </div>
        `;
        document.body.appendChild(warning);
        
        // إزالة التحذير تلقائياً بعد 10 ثوان
        setTimeout(() => {
            if (document.body.contains(warning)) {
                warning.remove();
            }
        }, 10000);
    },
    
    recoverPreviousSession: function() {
        try {
            const session = StorageManager.getItem('currentSession');
            if (session && this.isValidSession(session)) {
                console.log('Recovered previous session:', session);
                return session;
            }
        } catch (error) {
            console.warn('Session recovery failed:', error);
        }
        return null;
    },
    
    isValidSession: function(session) {
        return session && 
               session.timestamp && 
               Date.now() - session.timestamp < 30 * 60 * 1000; // 30 دقيقة كحد أقصى
    },
    
    saveSession: function(sessionData) {
        try {
            const session = {
                ...sessionData,
                timestamp: Date.now(),
                url: window.location.href
            };
            StorageManager.setItem('currentSession', session);
        } catch (error) {
            console.warn('Failed to save session:', error);
        }
    },
    
    clearSession: function() {
        try {
            localStorage.removeItem('currentSession');
        } catch (error) {
            console.warn('Failed to clear session:', error);
        }
    }
};

// ========== المتغيرات الأساسية للنظام ==========
// ========== المتغيرات الأساسية للنظام ==========
// بيانات النظام
let currentUser = null;
let currentTest = null;
let currentQuestionIndex = 0;
let timer = null;
let timeLeft = 30;
let studentData = {
    name: '',
    grade: '',
    class: '',
    score: 0,
    answers: []
};

// متغيرات إدارة الاختبارات
let currentManagingTest = null;
let currentManagingTestSchoolId = null;

// بيانات تجريبية
const demoData = {
    schools: {},
    users: {
        'chartgain2019@gmail.com': {
            email: 'chartgain2019@gmail.com',
            password: '123456',
            name: 'أ. عبدالله الشهري',
            school: 'مدرسة الوليد بن عمارة الابتدائية',
            stage: 'ابتدائية'
        }
    }
};

function updateGradeOptions(stage, targetElementId) {
    try {
        const gradeSelect = document.getElementById(targetElementId);
        if (!gradeSelect) {
            console.warn(`Element not found: ${targetElementId}`);
            return;
        }
        
        gradeSelect.innerHTML = '<option value="">اختر الصف الدراسي</option>';
        
        if (stage) {
            const grades = getGradeOptions(stage);
            grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeSelect.appendChild(option);
            });
        }
    } catch (error) {
        ErrorHandler.logError(error, 'updateGradeOptions');
    }
}


// ========== دوال النظام الأساسية مع معالجة الأخطاء ==========
// تحميل النتائج مع دعم الخادم البعيد المحسن
// تحميل النتائج مع معالجة محسنة للأخطاء وضمان إرجاع مصفوفة
async function loadResults() {
    try {
        console.log('🔄 بدء تحميل النتائج...');
        
        // إذا كان الخادم غير متوفر، استخدام التخزين المحلي مباشرة
        if (!RemoteAPI.isAvailable) {
            const localResults = StorageManager.getItem('testResults');
            console.log('💾 استخدام النتائج المحلية:', Array.isArray(localResults) ? localResults.length : 0, 'نتيجة');
            return Array.isArray(localResults) ? localResults : [];
        }

        // محاولة التحميل من الخادم
        console.log('🌐 محاولة تحميل النتائج من الخادم...');
        const remoteResults = await RemoteAPI.getResults();
        
        if (remoteResults && Array.isArray(remoteResults) && remoteResults.length > 0) {
            console.log('✅ تم تحميل النتائج من الخادم:', remoteResults.length, 'نتيجة');
            
            // حفظ نسخة محلية للمرة القادمة
            StorageManager.setItem('testResults', remoteResults);
            return remoteResults;
        } else {
            // إذا لم تكن هناك نتائج على الخادم، استخدام المحلية
            console.log('📭 لا توجد نتائج على الخادم، استخدام المحلية');
            const localResults = StorageManager.getItem('testResults');
            return Array.isArray(localResults) ? localResults : [];
        }
        
    } catch (error) {
        console.warn('❌ استخدام التخزين المحلي للنتائج:', error.message);
        const localResults = StorageManager.getItem('testResults');
        return Array.isArray(localResults) ? localResults : [];
    }
}

// دالة مساعدة للحصول على النتائج بشكل متزامن (للاستخدام في الدوال غير المتزامنة)
// دالة مساعدة للحصول على النتائج بشكل متزامن - محدثة
function getResultsSync() {
    try {
        const results = StorageManager.getItem('testResults');
        // التأكد من أن المخرجات مصفوفة
        if (Array.isArray(results)) {
            return results;
        } else if (results && typeof results === 'object') {
            // إذا كانت كائن، تحويل إلى مصفوفة
            return Object.values(results);
        } else {
            return [];
        }
    } catch (error) {
        console.warn('خطأ في الحصول على النتائج بشكل متزامن:', error);
        return [];
    }
}

// حفظ النتائج مع دعم الخادم البعيد
// حفظ النتائج مع معالجة محسنة للأخطاء وضمان حفظ محلي
async function saveResult(result) {
    try {
        result.timestamp = Date.now();
        
        // أولاً: الحفظ محلياً دائماً (لضمان عدم فقدان البيانات)
        const results = getResultsSync();
        results.push(result);
        const localSuccess = StorageManager.setItem('testResults', results);
        
        if (!localSuccess) {
            throw new Error('فشل في الحفظ المحلي');
        }
        
        console.log('💾 تم حفظ النتيجة محلياً بنجاح');
        
        // ثانياً: محاولة الحفظ في الخادم البعيد (إذا كان متوفراً)
        if (RemoteAPI.isAvailable) {
            try {
                await RemoteAPI.createResult(result);
                console.log('🌐 تم حفظ النتيجة في الخادم البعيد');
            } catch (apiError) {
                console.warn('⚠️ فشل حفظ النتيجة في الخادم البعيد:', apiError.message);
                // لا نرمي خطأ هنا لأن الحفظ المحلي نجح
            }
        } else {
            console.log('💡 النتيجة محفوظة محلياً فقط (الخادم غير متوفر)');
        }
        
        return true;
        
    } catch (error) {
        console.error('❌ فشل في حفظ النتيجة:', error);
        ErrorHandler.logError(error, 'saveResult');
        return false;
    }
}

// تحميل حسابات المعلمين مع دعم الخادم البعيد
// تحميل حسابات المعلمين مع دعم الخادم البعيد المحسن
async function loadTeacherAccounts() {
    try {
        // إذا كان الخادم غير متوفر، استخدام التخزين المحلي مباشرة
        if (!RemoteAPI.isAvailable) {
            const localTeachers = StorageManager.getItem('teacherAccounts') || {};
            console.log('💾 استخدام المعلمين المحليين:', Object.keys(localTeachers).length, 'معلم');
            Object.assign(demoData.users, localTeachers);
            return;
        }

        // محاولة التحميل من الخادم
        console.log('🔄 محاولة تحميل المعلمين من الخادم...');
        const remoteTeachers = await RemoteAPI.getTeachers();
        
        if (remoteTeachers && Object.keys(remoteTeachers).length > 0) {
            console.log('✅ تم تحميل المعلمين من الخادم:', Object.keys(remoteTeachers).length, 'معلم');
            Object.assign(demoData.users, remoteTeachers);
            
            // حفظ نسخة محلية للمرة القادمة
            StorageManager.setItem('teacherAccounts', remoteTeachers);
        } else {
            // إذا لم يكن هناك معلمين على الخادم، استخدام المحليين
            console.log('📭 لا توجد معلمين على الخادم');
            const localTeachers = StorageManager.getItem('teacherAccounts') || {};
            Object.assign(demoData.users, localTeachers);
        }
        
    } catch (error) {
        console.warn('❌ استخدام التخزين المحلي للمعلمين:', error.message);
        const localTeachers = StorageManager.getItem('teacherAccounts') || {};
        Object.assign(demoData.users, localTeachers);
    }
}


function checkAdminPermissions() {
    try {
        const debugToolsSection = document.getElementById('debugToolsSection');
        
        if (!debugToolsSection) {
            console.warn('عنصر أدوات التصحيح غير موجود');
            return;
        }
        
        if (currentUser && currentUser.email === 'chartgain2019@gmail.com') {
            debugToolsSection.classList.remove('hidden');
            console.log('✅ تم تفعيل أدوات التصحيح للمسؤول');
        } else {
            debugToolsSection.classList.add('hidden');
        }
    } catch (error) {
        ErrorHandler.logError(error, 'checkAdminPermissions');
    }
}

// ========== أدوات التصحيح للمسؤول ==========

function initializeDefaultData() {
    try {
        if (!confirm('⚠️ هل تريد تهيئة البيانات الافتراضية؟ هذا سيستبدل جميع البيانات الحالية.')) {
            return;
        }
        
        // بيانات المعلم الافتراضية
        const defaultUsers = {
            'chartgain2019@gmail.com': {
                email: 'chartgain2019@gmail.com',
                password: '123456',
                name: 'أ. عبدالله الشهري',
                school: 'مدرسة الوليد بن عمارة الابتدائية',
                stage: 'ابتدائية'
            }
        };
        
        // بيانات المدارس الافتراضية
        const defaultSchools = {
            'school_default_1': {
                id: 'school_default_1',
                name: 'مدرسة الوليد بن عمارة الابتدائية',
                teacher: 'أ. عبدالله الشهري',
                tests: []
            }
        };
        
        // حفظ البيانات
        StorageManager.setItem('teacherAccounts', defaultUsers);
        StorageManager.setItem('demoSchoolsData', defaultSchools);
        StorageManager.setItem('testResults', []);
        
        showSuccessMessage('تم التهيئة', 'تم تهيئة البيانات الافتراضية بنجاح');
        setTimeout(() => {
            location.reload();
        }, 2000);
        
    } catch (error) {
        ErrorHandler.logError(error, 'initializeDefaultData');
    }
}

function debugData() {
    try {
        const storageInfo = StorageManager.getStorageInfo();
        const results = loadResults();
        const errorLogs = StorageManager.getItem('errorLogs') || [];

        // إنشاء نافذة منبثقة مصغرة
        const modalId = 'debugDataModal_' + Date.now();
        
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[85vh] overflow-y-auto"> <!-- تم تصغير max-w من 6xl إلى 2xl -->
                    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 text-center sticky top-0 z-10"> <!-- تم تصغير padding -->
                        <h2 class="text-xl font-bold">🔍 فحص البيانات</h2> <!-- تم تصغير الخط -->
                        <p class="text-purple-100 text-sm">عرض سريع لحالة النظام</p> <!-- تم تصغير الخط -->
                    </div>
                    
                    <div class="p-4"> <!-- تم تصغير padding -->
                        <!-- قسم معلومات التخزين - مصغر -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">💾 التخزين</h3> <!-- تم تصغير الخط -->
                            <div class="grid grid-cols-3 gap-3"> <!-- تم تصغير gap -->
                                <div class="bg-blue-50 p-3 rounded-xl border border-blue-200 text-center"> <!-- تم تصغير padding -->
                                    <div class="text-blue-600 font-semibold text-sm">الحجم</div> <!-- تم تصغير الخط -->
                                    <div class="text-lg font-bold text-blue-600">${storageInfo.totalSize.toFixed(2)} MB</div> <!-- تم تصغير الخط -->
                                </div>
                                <div class="bg-green-50 p-3 rounded-xl border border-green-200 text-center">
                                    <div class="text-green-600 font-semibold text-sm">العناصر</div>
                                    <div class="text-lg font-bold text-green-600">${storageInfo.itemCount}</div>
                                </div>
                                <div class="bg-purple-50 p-3 rounded-xl border border-purple-200 text-center">
                                    <div class="text-purple-600 font-semibold text-sm">الأخطاء</div>
                                    <div class="text-lg font-bold text-purple-600">${errorLogs.length}</div>
                                </div>
                            </div>
                        </div>

                        <!-- قسم إحصائيات البيانات - مصغر -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">📊 البيانات</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-orange-50 p-3 rounded-xl border border-orange-200 text-center">
                                    <div class="text-orange-600 font-semibold text-sm">المدارس</div>
                                    <div class="text-lg font-bold text-orange-600">${Object.keys(demoData.schools).length}</div>
                                </div>
                                <div class="bg-red-50 p-3 rounded-xl border border-red-200 text-center">
                                    <div class="text-red-600 font-semibold text-sm">المعلمين</div>
                                    <div class="text-lg font-bold text-red-600">${Object.keys(demoData.users).length}</div>
                                </div>
                                <div class="bg-green-50 p-3 rounded-xl border border-green-200 text-center">
                                    <div class="text-green-600 font-semibold text-sm">النتائج</div>
                                    <div class="text-lg font-bold text-green-600">${results.length}</div>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-xl border border-blue-200 text-center">
                                    <div class="text-blue-600 font-semibold text-sm">المستخدم</div>
                                    <div class="text-xs font-bold text-blue-600 truncate" title="${currentUser?.name || 'غير مسجل'}">
                                        ${currentUser?.name ? currentUser.name.split(' ').slice(-1)[0] : 'غير مسجل'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- قسم العناصر المخزنة - مصغر -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">🗂️ العناصر</h3>
                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 max-h-40 overflow-y-auto"> <!-- تم تصغير الارتفاع -->
                                <div class="space-y-2">
                                    ${storageInfo.items.slice(0, 6).map(item => ` <!-- عرض 6 عناصر فقط -->
                                        <div class="flex justify-between items-center bg-white p-2 rounded border text-xs"> <!-- تم تصغير padding والخط -->
                                            <span class="truncate flex-1 mr-2" title="${item.key}">${item.key}</span>
                                            <span class="text-blue-600 font-semibold whitespace-nowrap">${item.size.toFixed(1)} KB</span>
                                        </div>
                                    `).join('')}
                                    ${storageInfo.items.length > 6 ? 
                                        `<div class="text-center text-gray-500 text-xs mt-2">+ ${storageInfo.items.length - 6} عنصر إضافي</div>` : 
                                        ''
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- قسم آخر الأخطاء - مصغر -->
                        ${errorLogs.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">⚠️ آخر الأخطاء</h3>
                            <div class="bg-red-50 p-3 rounded-xl border border-red-200 max-h-32 overflow-y-auto"> <!-- تم تصغير الارتفاع -->
                                <div class="space-y-2">
                                    ${errorLogs.slice(-3).reverse().map(log => ` <!-- عرض 3 أخطاء فقط -->
                                        <div class="bg-white p-2 rounded border border-red-200">
                                            <div class="flex justify-between items-center">
                                                <span class="text-red-600 text-xs font-semibold truncate">${log.context}</span>
                                                <span class="text-gray-500 text-xs">${new Date(log.timestamp).toLocaleTimeString('ar-SA')}</span>
                                            </div>
                                            <div class="text-xs text-gray-700 truncate mt-1">${log.error.message}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- أزرار الإجراءات - مصغرة -->
                        <div class="flex gap-2 justify-center mt-6 pt-4 border-t border-gray-200"> <!-- تم تصغير gap وpadding -->
                            <button onclick="copyDebugDataToClipboard()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                📋 نسخ
                            </button>
                            <button onclick="exportDebugData()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                📤 تصدير
                            </button>
                            <button onclick="closeDebugModal('${modalId}')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all">
                                إغلاق
                            </button>
                        </div>

                        <!-- معلومات سريعة -->
                        <div class="text-center mt-4">
                            <p class="text-xs text-gray-500">
                                آخر تحديث: ${new Date().toLocaleTimeString('ar-SA')}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // إضافة النافذة إلى body
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // إضافة مستمع حدث لإغلاق النافذة عند النقر خارجها
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeDebugModal(modalId);
            }
        });

        // إضافة مستمع حدث للزر ESC
        const closeOnEscape = function(e) {
            if (e.key === 'Escape') {
                closeDebugModal(modalId);
                document.removeEventListener('keydown', closeOnEscape);
            }
        };
        document.addEventListener('keydown', closeOnEscape);

    } catch (error) {
        ErrorHandler.logError(error, 'debugData');
        showErrorMessage('خطأ في الفحص', 'تعذر فحص البيانات');
    }
}

// دالة إغلاق النافذة
function closeDebugModal(modalId) {
    try {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                modal.remove();
            }, 300);
        }
    } catch (error) {
        ErrorHandler.logError(error, 'closeDebugModal');
    }
}

// دالة نسخ التقرير إلى الحافظة
function copyDebugDataToClipboard() {
    try {
        const storageInfo = StorageManager.getStorageInfo();
        const results = loadResults();
        const errorLogs = StorageManager.getItem('errorLogs') || [];

        const report = `
تقرير فحص البيانات - نظام الاختبارات التفاعلي
تاريخ الفحص: ${new Date().toLocaleString('ar-SA')}

💾 معلومات التخزين:
- الحجم الكلي: ${storageInfo.totalSize.toFixed(2)} MB
- عدد العناصر: ${storageInfo.itemCount}

📊 إحصائيات البيانات:
- عدد المدارس: ${Object.keys(demoData.schools).length}
- عدد المعلمين: ${Object.keys(demoData.users).length}
- عدد النتائج: ${results.length}
- عدد الأخطاء المسجلة: ${errorLogs.length}

👤 المستخدم الحالي:
${JSON.stringify(currentUser, null, 2)}

🗂️ العناصر المخزنة:
${storageInfo.items.map(item => `- ${item.key}: ${item.size.toFixed(2)} KB`).join('\n')}
        `.trim();

        navigator.clipboard.writeText(report).then(() => {
            showSuccessMessage('تم النسخ', 'تم نسخ التقرير إلى الحافظة بنجاح');
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = report;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showSuccessMessage('تم النسخ', 'تم نسخ التقرير إلى الحافظة بنجاح');
        });
    } catch (error) {
        ErrorHandler.logError(error, 'copyDebugDataToClipboard');
        showErrorMessage('خطأ في النسخ', 'تعذر نسخ التقرير');
    }
}

// دالة تصدير التقرير
function exportDebugData() {
    try {
        const storageInfo = StorageManager.getStorageInfo();
        const results = loadResults();
        const errorLogs = StorageManager.getItem('errorLogs') || [];

        const report = {
            timestamp: new Date().toISOString(),
            storage: storageInfo,
            statistics: {
                schools: Object.keys(demoData.schools).length,
                teachers: Object.keys(demoData.users).length,
                results: results.length,
                errors: errorLogs.length
            },
            currentUser: currentUser,
            items: storageInfo.items
        };

        const dataStr = JSON.stringify(report, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `debug_report_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showSuccessMessage('تم التصدير', 'تم تصدير التقرير بنجاح');
    } catch (error) {
        ErrorHandler.logError(error, 'exportDebugData');
        showErrorMessage('خطأ في التصدير', 'تعذر تصدير التقرير');
    }
}

function debugSystem() {
    try {
        // جمع معلومات شاملة عن النظام
        const systemInfo = {
            // معلومات المتصفح
            browser: {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cookiesEnabled: navigator.cookieEnabled,
                online: navigator.onLine
            },
            // معلومات الشاشة
            screen: {
                width: window.screen.width,
                height: window.screen.height,
                innerWidth: window.innerWidth,
                innerHeight: window.innerHeight,
                colorDepth: window.screen.colorDepth + ' bit'
            },
            // معلومات الأداء
            performance: {
                memory: performance.memory ? {
                    used: Math.round(performance.memory.usedJSHeapSize / 1048576) + ' MB',
                    total: Math.round(performance.memory.totalJSHeapSize / 1048576) + ' MB',
                    limit: Math.round(performance.memory.jsHeapSizeLimit / 1048576) + ' MB'
                } : 'غير متوفر',
                timing: performance.timing ? {
                    loadTime: (performance.timing.loadEventEnd - performance.timing.navigationStart) + ' ms',
                    domReady: (performance.timing.domContentLoadedEventStart - performance.timing.navigationStart) + ' ms'
                } : 'غير متوفر'
            },
            // معلومات التخزين
            storage: StorageManager.getStorageInfo(),
            // فحوصات النظام
            tests: {
                localStorage: StorageManager.isStorageAvailable(),
                sessionStorage: (() => {
                    try {
                        sessionStorage.setItem('test', 'test');
                        sessionStorage.removeItem('test');
                        return true;
                    } catch {
                        return false;
                    }
                })(),
                JSON: (() => {
                    try { JSON.parse('{"test": true}'); return true; } catch { return false; }
                })(),
                DOM: (() => {
                    try { document.createElement('div'); return true; } catch { return false; }
                })(),
                Canvas: (() => {
                    try { document.createElement('canvas').getContext('2d'); return true; } catch { return false; }
                })()
            },
            // بيانات التطبيق
            appData: {
                schoolsCount: Object.keys(demoData.schools).length,
                teachersCount: Object.keys(demoData.users).length,
                resultsCount: loadResults().length,
                currentUser: currentUser ? currentUser.name : 'غير مسجل',
                activeTimers: ResourceManager.timers.size,
                activeSessions: ResourceManager.activeSessions.size
            },
            // الأخطاء المسجلة
            errorLogs: StorageManager.getItem('errorLogs') || []
        };

        // إنشاء نافذة منبثقة مصغرة
        const modalId = 'systemDebugModal_' + Date.now();
        let modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-4xl max-h-[85vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 text-center sticky top-0 z-10">
                        <h2 class="text-xl font-bold">🔍 فحص النظام</h2>
                        <p class="text-purple-100 text-sm">معلومات مختصرة عن حالة النظام</p>
                    </div>
                    <div class="p-4">
                        <!-- شبكة المعلومات الرئيسية المصغرة -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <!-- معلومات المتصفح -->
                            <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                <h3 class="font-bold text-blue-800 text-sm mb-2">🌐 المتصفح</h3>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span>اللغة:</span>
                                        <span class="font-semibold">${systemInfo.browser.language}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>المنصة:</span>
                                        <span class="font-semibold">${systemInfo.browser.platform}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>الاتصال:</span>
                                        <span class="${systemInfo.browser.online ? 'text-green-600' : 'text-red-600'} font-semibold">
                                            ${systemInfo.browser.online ? '🟢 متصل' : '🔴 غير متصل'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>الكوكيز:</span>
                                        <span>${systemInfo.browser.cookiesEnabled ? 'مفعلة' : 'غير مفعلة'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- حالة التخزين -->
                            <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                                <h3 class="font-bold text-yellow-800 text-sm mb-2">💾 التخزين</h3>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span>الحجم:</span>
                                        <span class="font-semibold">${systemInfo.storage.totalSize.toFixed(1)} MB</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>العناصر:</span>
                                        <span class="font-semibold">${systemInfo.storage.itemCount}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>الحالة:</span>
                                        <span class="${systemInfo.tests.localStorage ? 'text-green-600' : 'text-red-600'} font-semibold">
                                            ${systemInfo.tests.localStorage ? '🟢 نشط' : '🔴 معطل'}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- بيانات التطبيق -->
                            <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                                <h3 class="font-bold text-purple-800 text-sm mb-2">📊 التطبيق</h3>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span>المدارس:</span>
                                        <span class="font-semibold">${systemInfo.appData.schoolsCount}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>المعلمون:</span>
                                        <span class="font-semibold">${systemInfo.appData.teachersCount}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>النتائج:</span>
                                        <span class="font-semibold">${systemInfo.appData.resultsCount}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>المستخدم:</span>
                                        <span class="font-semibold">${systemInfo.appData.currentUser}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- فحوصات النظام -->
                            <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                                <h3 class="font-bold text-green-800 text-sm mb-2">🔧 الفحوصات</h3>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span>التخزين:</span>
                                        <span class="${systemInfo.tests.localStorage ? 'text-green-600' : 'text-red-600'} font-semibold">
                                            ${systemInfo.tests.localStorage ? '🟢' : '🔴'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>الجلسات:</span>
                                        <span class="${systemInfo.tests.sessionStorage ? 'text-green-600' : 'text-red-600'} font-semibold">
                                            ${systemInfo.tests.sessionStorage ? '🟢' : '🔴'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>JSON:</span>
                                        <span class="${systemInfo.tests.JSON ? 'text-green-600' : 'text-red-600'} font-semibold">
                                            ${systemInfo.tests.JSON ? '🟢' : '🔴'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Canvas:</span>
                                        <span class="${systemInfo.tests.Canvas ? 'text-green-600' : 'text-red-600'} font-semibold">
                                            ${systemInfo.tests.Canvas ? '🟢' : '🔴'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- معلومات الأداء في صف واحد -->
                        <div class="bg-gray-50 p-3 rounded-lg mb-3">
                            <h3 class="font-bold text-gray-800 text-sm mb-2">⚡ الأداء</h3>
                            <div class="grid grid-cols-3 gap-2 text-xs">
                                <div class="text-center">
                                    <div class="font-semibold">${systemInfo.appData.activeTimers}</div>
                                    <div class="text-gray-600">مؤقت</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold">${systemInfo.appData.activeSessions}</div>
                                    <div class="text-gray-600">جلسة</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold">${systemInfo.performance.memory.used ? systemInfo.performance.memory.used.split(' ')[0] : 'N/A'}</div>
                                    <div class="text-gray-600">ذاكرة</div>
                                </div>
                            </div>
                        </div>

                        <!-- الأخطاء الحديثة مصغرة -->
                        <div class="bg-red-50 p-3 rounded-lg mb-3">
                            <h3 class="font-bold text-red-800 text-sm mb-2">⚠️ آخر الأخطاء</h3>
                            <div class="space-y-1 max-h-20 overflow-y-auto">
                                ${systemInfo.errorLogs.length === 0 ? 
                                    '<p class="text-gray-500 text-center text-xs py-2">لا توجد أخطاء</p>' : 
                                    systemInfo.errorLogs.slice(-3).reverse().map(log => `
                                        <div class="bg-white p-2 rounded border border-red-200">
                                            <div class="flex justify-between items-center">
                                                <span class="text-red-600 text-xs font-semibold truncate">${log.context}</span>
                                                <span class="text-gray-500 text-xs">${new Date(log.timestamp).toLocaleTimeString('ar-SA')}</span>
                                            </div>
                                            <div class="text-xs text-gray-700 truncate mt-1">${log.error.message}</div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>

                        <!-- أكبر العناصر في التخزين مصغرة -->
                        <div class="bg-orange-50 p-3 rounded-lg mb-4">
                            <h3 class="font-bold text-orange-800 text-sm mb-2">🗃️ أكبر الملفات</h3>
                            <div class="space-y-1">
                                ${systemInfo.storage.items.slice(0, 3).map(item => `
                                    <div class="flex justify-between items-center bg-white p-2 rounded border text-xs">
                                        <span class="truncate flex-1 mr-2" title="${item.key}">${item.key}</span>
                                        <span class="text-orange-600 font-semibold whitespace-nowrap">${item.size.toFixed(1)} KB</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- أزرار الإجراءات مصغرة -->
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-3 rounded-lg border border-blue-200">
                            <h3 class="font-bold text-blue-800 text-sm mb-2">🛠️ إجراءات سريعة</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="runSystemCleanup()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-1">
                                    🧹 تنظيف
                                </button>
                                <button onclick="clearResultsOnly()" class="bg-orange-500 hover:bg-orange-600 text-white py-2 px-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-1">
                                    🗑️ نتائج
                                </button>
                                <button onclick="location.reload()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-1">
                                    🔄 تحديث
                                </button>
                                <button onclick="closeModal('${modalId}')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-1">
                                    إغلاق
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // إضافة مستمع حدث لإغلاق النافذة عند النقر خارجها
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(modalId);
            }
        });

        // إضافة مستمع حدث للزر ESC
        const closeOnEscape = function(e) {
            if (e.key === 'Escape') {
                closeModal(modalId);
                document.removeEventListener('keydown', closeOnEscape);
            }
        };
        document.addEventListener('keydown', closeOnEscape);

        console.log('فحص النظام:', systemInfo);

    } catch (error) {
        ErrorHandler.logError(error, 'debugSystem');
        showErrorMessage('خطأ في الفحص', 'تعذر فحص النظام. راجع وحدة التحكم.');
    }
}

// دالة تنظيف النظام
function runSystemCleanup() {
    try {
        showLoadingMessage('جاري تنظيف النظام...');
        
        // تنظيف الموارد
        ResourceManager.cleanup();
        
        // تنظيف البيانات القديمة
        StorageManager.clearOldData();
        
        // تنظيف الأخطاء القديمة (احتفظ بآخر 10 فقط)
        const errorLogs = StorageManager.getItem('errorLogs') || [];
        if (errorLogs.length > 10) {
            StorageManager.setItem('errorLogs', errorLogs.slice(-10));
        }
        
        setTimeout(() => {
            hideLoadingMessage();
            showSuccessMessage('تم التنظيف', 'تم تنظيف النظام بنجاح');
            
            // إعادة فتح نافذة الفحص بعد التنظيف
            const existingModal = document.querySelector('[id^="systemDebugModal_"]');
            if (existingModal) {
                existingModal.remove();
            }
            setTimeout(() => {
                debugSystem();
            }, 500);
        }, 1000);
        
    } catch (error) {
        hideLoadingMessage();
        ErrorHandler.logError(error, 'runSystemCleanup');
        showErrorMessage('خطأ في التنظيف', 'تعذر تنظيف النظام');
    }
}

// دالة تنظيف النظام
function runSystemCleanup() {
    try {
        showLoadingMessage('جاري تنظيف النظام...');
        
        // تنظيف الموارد
        ResourceManager.cleanup();
        
        // تنظيف البيانات القديمة
        StorageManager.clearOldData();
        
        // تنظيف الأخطاء القديمة (احتفظ بآخر 10 فقط)
        const errorLogs = StorageManager.getItem('errorLogs') || [];
        if (errorLogs.length > 10) {
            StorageManager.setItem('errorLogs', errorLogs.slice(-10));
        }
        
        setTimeout(() => {
            hideLoadingMessage();
            showSuccessMessage('تم التنظيف', 'تم تنظيف النظام بنجاح');
            debugSystem(); // إعادة فتح نافذة الفحص
        }, 1000);
        
    } catch (error) {
        hideLoadingMessage();
        ErrorHandler.logError(error, 'runSystemCleanup');
    }
}

function showAllSchools() {
    try {
        console.log('=== جميع المدارس ===');
        console.log('المدارس:', demoData.schools);
        
        // إنشاء نافذة منبثقة
        const modalId = 'schoolsModal_' + Date.now();
        let modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-6xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 text-center sticky top-0 z-10">
                        <h2 class="text-2xl font-bold">إدارة المدارس</h2>
                        <p class="text-purple-100">عرض وإدارة جميع المدارس المسجلة في النظام</p>
                    </div>
                    <div class="p-6">
                        <div class="mb-6 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">قائمة المدارس</h3>
                            <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm">
                                ${Object.keys(demoData.schools).length} مدرسة
                            </span>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full bg-white rounded-xl overflow-hidden">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">اسم المدرسة</th>
                                        <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">المعلم</th>
                                        <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">عدد الاختبارات</th>
                                        <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
        `;
        
        // إضافة كل مدرسة إلى الجدول
        Object.values(demoData.schools).forEach((school, index) => {
            modalHTML += `
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-all">
                    <td class="px-6 py-4 text-right">
                        <div class="font-bold text-gray-800">${school.name}</div>
                    </td>
                    <td class="px-6 py-4 text-right">${school.teacher}</td>
                    <td class="px-6 py-4 text-right">
                        <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-sm">
                            ${school.tests ? school.tests.length : 0} اختبار
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex gap-2 justify-end">
                            <button onclick="showSchoolDetails('${school.id}')" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                تفاصيل
                            </button>
                            <button onclick="deleteSchool('${school.id}')" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"></path>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                    <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                حذف
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        modalHTML += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="text-center mt-8 pt-6 border-t border-gray-200">
                            <button onclick="closeModal('${modalId}')" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-3 rounded-xl font-semibold transition-all shadow-lg">
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // إضافة مستمع حدث لإغلاق النافذة عند النقر خارجها
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(modalId);
            }
        });
        
        console.log('تم عرض النافذة المنبثقة للمدارس');
        
    } catch (error) {
        ErrorHandler.logError(error, 'showAllSchools');
    }
}

// ========== نظام النسخ الاحتياطي المتكامل ==========

// إنشاء نسخة احتياطية
// إنشاء نسخة احتياطية مع دعم الخادم البعيد
async function createBackup() {
    try {
        showLoadingMessage('جاري إنشاء النسخة الاحتياطية...');
        
        // جمع البيانات من الخادم البعيد والتخزين المحلي
        let remoteData = {};
        try {
            remoteData = {
                teacherAccounts: await RemoteAPI.getTeachers(),
                schools: await RemoteAPI.getSchools(),
                results: await RemoteAPI.getResults()
            };
        } catch (apiError) {
            console.warn('فشل تحميل البيانات من الخادم البعيد للنسخ الاحتياطي:', apiError);
        }
        
        const backupData = {
            version: '2.0',
            timestamp: new Date().toISOString(),
            createdBy: currentUser?.email || 'unknown',
            source: 'remote_and_local',
            
            // دمج البيانات من الخادم البعيد والمحلي
            teacherAccounts: remoteData.teacherAccounts || demoData.users,
            schools: remoteData.schools || demoData.schools,
            testResults: remoteData.results || loadResults(),
            
            // البيانات المحلية الإضافية
            systemSettings: StorageManager.getItem('systemSettings') || {},
            errorLogs: StorageManager.getItem('errorLogs') || []
        };

        // تحويل إلى JSON مع تنسيق
        const backupJson = JSON.stringify(backupData, null, 2);
        
        // إنشاء ملف للتحميل
        const blob = new Blob([backupJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `نظام_الاختبارات_النسخة_الاحتياطية_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // تحرير الذاكرة
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        
        // حفظ معلومات النسخة الاحتياطية
        saveBackupInfo(backupData);
        
        hideLoadingMessage();
        showSuccessMessage('تم النسخ الاحتياطي', 'تم حفظ النسخة الاحتياطية بنجاح!');
        
    } catch (error) {
        hideLoadingMessage();
        ErrorHandler.logError(error, 'createBackup');
        showErrorMessage('خطأ في النسخ', 'تعذر إنشاء النسخة الاحتياطية');
    }
}

// حفظ معلومات النسخة الاحتياطية
function saveBackupInfo(backupData) {
    try {
        const backupHistory = StorageManager.getItem('backupHistory') || [];
        
        const backupInfo = {
            id: Date.now(),
            timestamp: backupData.timestamp,
            size: JSON.stringify(backupData).length,
            items: {
                teachers: Object.keys(backupData.teacherAccounts || {}).length,
                schools: Object.keys(backupData.demoSchoolsData || {}).length,
                results: (backupData.testResults || []).length,
                errors: (backupData.errorLogs || []).length
            },
            createdBy: backupData.createdBy
        };
        
        backupHistory.unshift(backupInfo); // إضافة في البداية
        
        // حفظ آخر 10 نسخ فقط
        if (backupHistory.length > 10) {
            backupHistory.splice(10);
        }
        
        StorageManager.setItem('backupHistory', backupHistory);
        
    } catch (error) {
        console.warn('Failed to save backup info:', error);
    }
}

// عرض نافذة استعادة النسخة الاحتياطية
function showRestoreBackupModal() {
    try {
        const modalId = 'restoreBackupModal_' + Date.now();
        
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-md">
                    <div class="bg-gradient-to-r from-pink-600 to-purple-600 text-white p-6 text-center">
                        <h2 class="text-xl font-bold">📥 استعادة نسخة احتياطية</h2>
                        <p class="text-pink-100 text-sm">اختر ملف النسخة الاحتياطية للاستعادة</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">اختر ملف النسخة الاحتياطية (.json)</label>
                            <input type="file" id="backupFileInput" accept=".json" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-pink-500 focus:outline-none">
                            <p class="text-xs text-gray-500 mt-2">يجب أن يكون الملف من نوع JSON من نظام الاختبارات</p>
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-4">
                            <div class="flex items-start gap-2">
                                <span class="text-yellow-600">⚠️</span>
                                <div class="text-sm text-yellow-700">
                                    <strong>تحذير:</strong> الاستعادة ستستبدل جميع البيانات الحالية ولا يمكن التراجع عنها!
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="restoreBackup('${modalId}')" class="flex-1 bg-pink-500 hover:bg-pink-600 text-white py-3 rounded-xl font-semibold transition-all">
                                استعادة
                            </button>
                            <button onclick="closeModal('${modalId}')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                                إلغاء
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // إضافة مستمع حدث لإغلاق النافذة
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(modalId);
            }
        });
        
    } catch (error) {
        ErrorHandler.logError(error, 'showRestoreBackupModal');
    }
}

// استعادة النسخة الاحتياطية
function restoreBackup(modalId) {
    try {
        const fileInput = document.getElementById('backupFileInput');
        const file = fileInput?.files[0];
        
        if (!file) {
            showErrorMessage('خطأ', 'يرجى اختيار ملف النسخة الاحتياطية أولاً');
            return;
        }
        
        if (!file.name.endsWith('.json')) {
            showErrorMessage('خطأ', 'الملف يجب أن يكون من نوع JSON');
            return;
        }
        
        if (!confirm('⚠️ تحذير: هذا الإجراء سيستبدل جميع البيانات الحالية!\n\nهل أنت متأكد من الاستمرار في استعادة النسخة الاحتياطية؟')) {
            return;
        }
        
        showLoadingMessage('جاري استعادة النسخة الاحتياطية...');
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const backupData = JSON.parse(e.target.result);
                
                // التحقق من صحة البيانات
                if (!isValidBackup(backupData)) {
                    throw new Error('ملف النسخة الاحتياطية غير صالح');
                }
                
                // استعادة البيانات
                if (backupData.teacherAccounts) {
                    StorageManager.setItem('teacherAccounts', backupData.teacherAccounts);
                    demoData.users = backupData.teacherAccounts;
                }
                
                if (backupData.demoSchoolsData) {
                    StorageManager.setItem('demoSchoolsData', backupData.demoSchoolsData);
                    demoData.schools = backupData.demoSchoolsData;
                }
                
                if (backupData.testResults) {
                    StorageManager.setItem('testResults', backupData.testResults);
                }
                
                if (backupData.systemSettings) {
                    StorageManager.setItem('systemSettings', backupData.systemSettings);
                }
                
                if (backupData.errorLogs) {
                    StorageManager.setItem('errorLogs', backupData.errorLogs);
                }
                
                closeModal(modalId);
                hideLoadingMessage();
                
                showSuccessMessage('تم الاستعادة', 'تم استعادة النسخة الاحتياطية بنجاح!');
                
                // إعادة تحميل الصفحة بعد ثانيتين
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } catch (error) {
                hideLoadingMessage();
                ErrorHandler.logError(error, 'restoreBackup.parse');
                showErrorMessage('خطأ في الاستعادة', 'ملف النسخة الاحتياطية تالف أو غير صالح');
            }
        };
        
        reader.onerror = function() {
            hideLoadingMessage();
            showErrorMessage('خطأ في القراءة', 'تعذر قراءة الملف');
        };
        
        reader.readAsText(file);
        
    } catch (error) {
        hideLoadingMessage();
        ErrorHandler.logError(error, 'restoreBackup');
        showErrorMessage('خطأ', 'تعذر استعادة النسخة الاحتياطية');
    }
}

// التحقق من صحة النسخة الاحتياطية
function isValidBackup(backupData) {
    return backupData && 
           typeof backupData === 'object' &&
           backupData.version &&
           backupData.timestamp &&
           (backupData.teacherAccounts || backupData.demoSchoolsData || backupData.testResults);
}

// عرض مدير النسخ الاحتياطية
function showBackupManager() {
    try {
        const backupHistory = StorageManager.getItem('backupHistory') || [];
        
        const modalId = 'backupManagerModal_' + Date.now();
        
        let historyHTML = '';
        if (backupHistory.length === 0) {
            historyHTML = `
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-2">📭</div>
                    <p>لا توجد نسخ احتياطية سابقة</p>
                </div>
            `;
        } else {
            historyHTML = `
                <div class="space-y-3 max-h-60 overflow-y-auto">
                    ${backupHistory.map(backup => `
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">نسخة ${new Date(backup.timestamp).toLocaleString('ar-SA')}</div>
                                    <div class="text-sm text-gray-600">بواسطة: ${backup.createdBy}</div>
                                </div>
                                <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-xs">${(backup.size / 1024).toFixed(2)} KB</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 text-xs">
                                <div class="text-center">
                                    <div class="font-bold">${backup.items.teachers}</div>
                                    <div class="text-gray-500">معلم</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold">${backup.items.schools}</div>
                                    <div class="text-gray-500">مدرسة</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold">${backup.items.results}</div>
                                    <div class="text-gray-500">نتيجة</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold">${backup.items.errors}</div>
                                    <div class="text-gray-500">خطأ</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-teal-600 to-blue-600 text-white p-6 text-center sticky top-0 z-10">
                        <h2 class="text-2xl font-bold">🗂️ إدارة النسخ الاحتياطية</h2>
                        <p class="text-teal-100">عرض وإدارة النسخ الاحتياطية السابقة</p>
                    </div>
                    
                    <div class="p-6">
                        <!-- إحصائيات سريعة -->
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-blue-600">${backupHistory.length}</div>
                                <div class="text-sm text-blue-600">النسخ المحفوظة</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-green-600">${Math.max(...backupHistory.map(b => b.items.teachers)) || 0}</div>
                                <div class="text-sm text-green-600">أكثر معلم</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-xl text-center">
                                <div class="text-2xl font-bold text-purple-600">${new Date(Math.max(...backupHistory.map(b => new Date(b.timestamp).getTime()))).toLocaleDateString('ar-SA') || 'لا يوجد'}</div>
                                <div class="text-sm text-purple-600">آخر نسخة</div>
                            </div>
                        </div>
                        
                        <!-- قائمة النسخ -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">📋 النسخ الاحتياطية السابقة</h3>
                            ${historyHTML}
                        </div>
                        
                        <!-- أزرار الإجراءات -->
                        <div class="flex gap-2 justify-center border-t border-gray-200 pt-6">
                            <button onclick="createBackup()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                                💾 إنشاء نسخة جديدة
                            </button>
                            <button onclick="showRestoreBackupModal()" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                                📥 استعادة نسخة
                            </button>
                            <button onclick="closeModal('${modalId}')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // إضافة مستمع حدث لإغلاق النافذة
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(modalId);
            }
        });
        
    } catch (error) {
        ErrorHandler.logError(error, 'showBackupManager');
    }
}


// دالة عرض تفاصيل المدرسة
function showSchoolDetails(schoolId) {
    try {
        const school = demoData.schools[schoolId];
        if (!school) {
            alert('المدرسة غير موجودة');
            return;
        }
        
        const modalId = 'schoolDetailsModal_' + Date.now();
        let detailsHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 text-center sticky top-0 z-10">
                        <h2 class="text-2xl font-bold">تفاصيل المدرسة</h2>
                    </div>
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-blue-50 p-4 rounded-xl">
                                <div class="text-blue-600 font-semibold">اسم المدرسة</div>
                                <div class="font-bold text-lg">${school.name}</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl">
                                <div class="text-green-600 font-semibold">المعلم المسؤول</div>
                                <div class="font-bold text-lg">${school.teacher}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-xl mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">الاختبارات (${school.tests ? school.tests.length : 0})</h3>
        `;
        
        if (!school.tests || school.tests.length === 0) {
            detailsHTML += `
                <div class="text-center text-gray-500 py-4">
                    <div class="text-4xl mb-2">📝</div>
                    <p>لا توجد اختبارات في هذه المدرسة</p>
                </div>
            `;
        } else {
            detailsHTML += `<div class="space-y-3">`;
            
            school.tests.forEach((test, index) => {
                detailsHTML += `
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-gray-800">${test.name}</h4>
                            <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-sm">${test.subject}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                            <div>الصف: ${test.grade}</div>
                            <div>الأسئلة: ${test.questions ? test.questions.length : 0}</div>
                            <div>الوقت: ${test.timerPerQuestion || 30} ثانية</div>
                            <div>المستوى: ${test.difficulty || 'متوسط'}</div>
                        </div>
                    </div>
                `;
            });
            
            detailsHTML += `</div>`;
        }
        
        detailsHTML += `
                        </div>
                        
                        <div class="text-center mt-6">
                            <button onclick="closeModal('${modalId}')" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailsHTML);
        
        // إضافة مستمع حدث لإغلاق النافذة عند النقر خارجها
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(modalId);
            }
        });
        
    } catch (error) {
        ErrorHandler.logError(error, 'showSchoolDetails');
    }
}

// دالة حذف المدرسة
function deleteSchool(schoolId) {
    try {
        const school = demoData.schools[schoolId];
        if (!school) {
            alert('المدرسة غير موجودة');
            return;
        }
        
        if (!confirm(`⚠️ هل أنت متأكد من حذف المدرسة التالية؟\n\nاسم المدرسة: ${school.name}\nالمعلم: ${school.teacher}\n\nهذا الإجراء سيحذف جميع الاختبارات المرتبطة بهذه المدرسة ولا يمكن التراجع عنه!`)) {
            return;
        }
        
        // حذف المدرسة
        delete demoData.schools[schoolId];
        
        // حفظ التغييرات
        const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        if (success) {
            showSuccessMessage('تم الحذف', `تم حذف المدرسة "${school.name}" بنجاح`);
            
            // إعادة تحميل النافذة المنبثقة للمدارس
            closeAllModals();
            setTimeout(() => {
                showAllSchools();
            }, 500);
        } else {
            alert('فشل في حذف المدرسة');
        }
        
    } catch (error) {
        ErrorHandler.logError(error, 'deleteSchool');
    }
}

// دالة إغلاق جميع النوافذ المنبثقة
function closeAllModals() {
    try {
        const modals = document.querySelectorAll('[id^="schoolsModal_"], [id^="schoolDetailsModal_"]');
        modals.forEach(modal => modal.remove());
    } catch (error) {
        ErrorHandler.logError(error, 'closeAllModals');
    }
}

// وظيفة البحث عن المدارس
function searchSchools() {
    try {
        const searchTerm = document.getElementById('schoolSearch')?.value.toLowerCase().trim() || '';
        const resultsContainer = document.getElementById('schoolSearchResults');
        
        if (!resultsContainer) {
            console.warn('Search results container not found');
            return;
        }
        
        if (searchTerm.length < 2) {
            resultsContainer.classList.add('hidden');
            return;
        }
        
        // البحث فقط في اسم المدرسة والمعلم
        const matchingSchools = Object.values(demoData.schools).filter(school => 
            school.name.toLowerCase().includes(searchTerm) || 
            school.teacher.toLowerCase().includes(searchTerm)
        );
        
        if (matchingSchools.length === 0) {
            resultsContainer.innerHTML = '<div class="p-4 text-center text-gray-500">لا توجد نتائج مطابقة</div>';
            resultsContainer.classList.remove('hidden');
            return;
        }
        
        let resultsHTML = '';
        matchingSchools.forEach(school => {
            resultsHTML += `
                <div class="p-4 border-b border-gray-200 hover:bg-blue-50 cursor-pointer transition-all" onclick="selectSearchedSchool('${school.id}')">
                    <div class="font-bold text-gray-800">${school.name}</div>
                    <div class="text-sm text-gray-600">${school.teacher}</div>
                </div>
            `;
        });
        
        resultsContainer.innerHTML = resultsHTML;
        resultsContainer.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'searchSchools');
    }
}

// وظيفة اختيار مدرسة من نتائج البحث
function selectSearchedSchool(schoolId) {
    try {
        const school = demoData.schools[schoolId];
        if (!school) {
            console.warn('School not found:', schoolId);
            return;
        }
        
        const schoolSearch = document.getElementById('schoolSearch');
        const searchResults = document.getElementById('schoolSearchResults');
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        
        if (schoolSearch) schoolSearch.value = school.name;
        if (searchResults) searchResults.classList.add('hidden');
        
        // تخزين معرف المدرسة المختارة في حقل مخفي
        if (selectedSchoolInfo) {
            selectedSchoolInfo.dataset.schoolId = schoolId;
            
            // عرض معلومات المدرسة المختارة
            selectedSchoolInfo.classList.remove('hidden');
            document.getElementById('chosenSchoolName').textContent = school.name;
            document.getElementById('chosenTeacher').textContent = school.teacher;
            
            // تحديث قائمة الاختبارات
            const testSelect = document.getElementById('testSelect');
            if (testSelect) {
                testSelect.innerHTML = '<option value="">اختر الاختبار</option>';
                
                school.tests.forEach((test, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
                    testSelect.appendChild(option);
                });
            }
        }
    } catch (error) {
        ErrorHandler.logError(error, 'selectSearchedSchool');
    }
}

// وظائف الشاشة الرئيسية

// وظائف إنشاء حساب المعلم
function showTeacherSignup() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        document.getElementById('teacherSignupScreen').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherSignup');
    }
}

function closeTeacherSignup() {
    try {
        document.getElementById('teacherSignupScreen').classList.add('hidden');
        const signupError = document.getElementById('signupError');
        const signupSuccess = document.getElementById('signupSuccess');
        const signupForm = document.getElementById('teacherSignupForm');
        
        if (signupError) signupError.classList.add('hidden');
        if (signupSuccess) signupSuccess.classList.add('hidden');
        if (signupForm) signupForm.reset();
    } catch (error) {
        ErrorHandler.logError(error, 'closeTeacherSignup');
    }
}

// إنشاء حساب معلم مع دعم الخادم البعيد
// إنشاء حساب معلم محدث مع دعم الخادم البعيد
async function teacherSignup(event) {
    try {
        event.preventDefault();
        
        const name = DataValidator.sanitizeInput(document.getElementById('newTeacherName').value);
        const email = DataValidator.sanitizeInput(document.getElementById('newTeacherEmail').value);
        const school = DataValidator.sanitizeInput(document.getElementById('newTeacherSchool').value);
        const stage = document.getElementById('newTeacherStage').value;
        const password = document.getElementById('newTeacherPassword').value;
        const confirmPassword = document.getElementById('confirmTeacherPassword').value;
        
        const errorDiv = document.getElementById('signupError');
        const successDiv = document.getElementById('signupSuccess');
        
        // إخفاء الرسائل السابقة
        if (errorDiv) errorDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
        
        // التحقق من صحة البيانات
        const validationErrors = [];
        
        if (!DataValidator.validateEmail(email)) {
            validationErrors.push('البريد الإلكتروني غير صحيح');
        }
        
        const passwordError = DataValidator.validatePassword(password);
        if (passwordError) {
            validationErrors.push(passwordError);
        }
        
        if (password !== confirmPassword) {
            validationErrors.push('كلمة المرور وتأكيدها غير متطابقتين');
        }
        
        if (!stage) {
            validationErrors.push('يرجى اختيار المرحلة الدراسية');
        }
        
        if (validationErrors.length > 0) {
            if (errorDiv) {
                errorDiv.textContent = validationErrors.join('\n');
                errorDiv.classList.remove('hidden');
            }
            return false;
        }
        
        // التحقق من وجود البريد الإلكتروني مسبقاً
        if (demoData.users[email]) {
            if (errorDiv) {
                errorDiv.textContent = 'هذا البريد الإلكتروني مسجل مسبقاً';
                errorDiv.classList.remove('hidden');
            }
            return false;
        }
        
        // إنشاء الحساب الجديد
        const teacherData = {
            name: name,
            email: email,
            password: password,
            school: school,
            stage: stage
        };

        try {
            // محاولة التسجيل في الخادم البعيد أولاً
            const signupResult = await RemoteAPI.createTeacher(teacherData);
            
            if (signupResult && signupResult.success) {
                // النجاح - حفظ محلياً أيضاً
                currentUser = {
                    email: email,
                    password: password,
                    name: name,
                    school: school,
                    stage: stage
                };
                
                demoData.users[email] = currentUser;
                StorageManager.setItem('teacherAccounts', demoData.users);
                
                // إنشاء مدرسة تلقائياً محلياً
                const schoolData = {
                    id: 'school_' + Date.now(),
                    name: school,
                    teacher: name,
                    tests: []
                };
                
                demoData.schools[schoolData.id] = schoolData;
                StorageManager.setItem('demoSchoolsData', demoData.schools);
                
            } else {
                throw new Error(signupResult?.error || 'فشل في إنشاء الحساب');
            }
            
        } catch (apiError) {
            // إذا فشل الخادم البعيد، الحفظ محلياً فقط
            console.warn('فشل التسجيل في الخادم البعيد، استخدام التخزين المحلي:', apiError);
            
            demoData.users[email] = {
                email: email,
                password: password,
                name: name,
                school: school,
                stage: stage
            };
            
            const schoolData = {
                id: 'school_' + Date.now(),
                name: school,
                teacher: name,
                tests: []
            };
            
            demoData.schools[schoolData.id] = schoolData;
            
            StorageManager.setItem('teacherAccounts', demoData.users);
            StorageManager.setItem('demoSchoolsData', demoData.schools);
        }
        
        // عرض رسالة النجاح
        if (successDiv) {
            successDiv.textContent = 'تم إنشاء الحساب بنجاح! يمكنك الآن تسجيل الدخول';
            successDiv.classList.remove('hidden');
        }
        
        // العودة لشاشة تسجيل الدخول بعد 2 ثانية
        setTimeout(() => {
            closeTeacherSignup();
            showTeacherLogin();
        }, 2000);
        
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'teacherSignup');
        return false;
    }
}

// تحميل المدارس مع دعم الخادم البعيد
// تحميل المدارس مع دعم الخادم البعيد المحسن
async function loadSchools() {
    try {
        // إذا كان الخادم غير متوفر، استخدام التخزين المحلي مباشرة
        if (!RemoteAPI.isAvailable) {
            const localSchools = StorageManager.getItem('demoSchoolsData') || {};
            console.log('💾 استخدام المدارس المحلية:', Object.keys(localSchools).length, 'مدرسة');
            Object.assign(demoData.schools, localSchools);
            return;
        }

        // محاولة التحميل من الخادم
        console.log('🔄 محاولة تحميل المدارس من الخادم...');
        const remoteSchools = await RemoteAPI.getSchools();
        
        if (remoteSchools && Object.keys(remoteSchools).length > 0) {
            console.log('✅ تم تحميل المدارس من الخادم:', Object.keys(remoteSchools).length, 'مدرسة');
            Object.assign(demoData.schools, remoteSchools);
            
            // حفظ نسخة محلية للمرة القادمة
            StorageManager.setItem('demoSchoolsData', remoteSchools);
        } else {
            // إذا لم تكن هناك مدارس على الخادم، استخدام المحلية
            console.log('📭 لا توجد مدارس على الخادم');
            const localSchools = StorageManager.getItem('demoSchoolsData') || {};
            Object.assign(demoData.schools, localSchools);
        }
        
    } catch (error) {
        console.warn('❌ استخدام التخزين المحلي للمدارس:', error.message);
        const localSchools = StorageManager.getItem('demoSchoolsData') || {};
        Object.assign(demoData.schools, localSchools);
    }
}

// تسجيل دخول المعلم
// تسجيل دخول المعلم مع دعم الخادم البعيد
// تسجيل دخول المعلم المحدث مع دعم الخادم البعيد
async function teacherLogin(event) {
    try {
        event.preventDefault();
        
        const email = document.getElementById('teacherEmail').value;
        const password = document.getElementById('teacherPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        if (!errorDiv) {
            ErrorHandler.logError(new Error('Login error element not found'), 'teacherLogin');
            return false;
        }
        
        // إخفاء رسائل الخطأ السابقة
        errorDiv.classList.add('hidden');
        
        // البحث في البيانات المحلية أولاً (للسرعة)
        if (demoData.users[email] && demoData.users[email].password === password) {
            currentUser = demoData.users[email];
            closeTeacherLogin();
            showTeacherDashboard();
            return true;
        }
        
        // إذا لم يكن موجوداً محلياً، البحث في الخادم البعيد
        try {
            const loginResult = await RemoteAPI.login({ email, password });
            
            if (loginResult && loginResult.success) {
                currentUser = {
                    email: loginResult.user.email,
                    password: password, // حفظ محلياً للمرة القادمة
                    name: loginResult.user.name,
                    school: loginResult.user.school,
                    stage: loginResult.user.stage
                };
                
                // حفظ محلياً للمرة القادمة
                demoData.users[email] = currentUser;
                StorageManager.setItem('teacherAccounts', demoData.users);
                
                closeTeacherLogin();
                showTeacherDashboard();
                return true;
            } else {
                errorDiv.textContent = loginResult?.error || 'بيانات الدخول غير صحيحة';
                errorDiv.classList.remove('hidden');
                return false;
            }
        } catch (apiError) {
            // إذا فشل الخادم البعيد، استخدام البيانات المحلية فقط
            console.warn('فشل الاتصال بالخادم البعيد:', apiError);
            errorDiv.textContent = 'بيانات الدخول غير صحيحة أو مشكلة في الاتصال';
            errorDiv.classList.remove('hidden');
            return false;
        }
    } catch (error) {
        ErrorHandler.logError(error, 'teacherLogin');
        return false;
    }
}

function teacherLogout() {
    try {
        // تنظيف الموارد
        ResourceManager.cleanup();
        SystemRecovery.clearSession();
        
        currentUser = null;
        document.getElementById('teacherDashboard').classList.add('hidden');
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // تحديث الإحصائيات
        updateWelcomeStatistics();
    } catch (error) {
        ErrorHandler.logError(error, 'teacherLogout');
    }
}

// اختيار الاختبار
function selectTest() {
    try {
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const testSelect = document.getElementById('testSelect');
        
        if (!selectedSchoolInfo || !testSelect) {
            console.warn('Required elements not found for selectTest');
            return;
        }
        
        const schoolId = selectedSchoolInfo.dataset.schoolId;
        const testIndex = testSelect.value;
        
        if (!schoolId || testIndex === '') {
            const testInfo = document.getElementById('testInfo');
            const studentForm = document.getElementById('studentForm');
            
            if (testInfo) testInfo.classList.add('hidden');
            if (studentForm) studentForm.classList.add('hidden');
            return;
        }
        
        const school = demoData.schools[schoolId];
        const test = school.tests[testIndex];
        
        if (test) {
            // تحديث معلومات الاختبار
            const testInfo = document.getElementById('testInfo');
            if (testInfo) {
                testInfo.innerHTML = `
                    <h3 class="font-bold text-blue-800 mb-4">معلومات الاختبار</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <span class="text-blue-600 font-semibold">📖 المادة:</span>
                            <span class="font-bold text-gray-800 mr-2">${test.subject}</span>
                        </div>
                        <div>
                            <span class="text-blue-600 font-semibold">❓ عدد الأسئلة:</span>
                            <span class="font-bold text-gray-800 mr-2">${test.questions.length}</span>
                        </div>
                        <div>
                            <span class="text-blue-600 font-semibold">🎒 الصف الدراسي:</span>
                            <span class="font-bold text-gray-800 mr-2">${test.grade}</span>
                        </div>
                        <div>
                            <span class="text-blue-600 font-semibold">⏱️ وقت السؤال:</span>
                            <span class="font-bold text-gray-800 mr-2">${test.timerPerQuestion || 30} ثانية</span>
                        </div>
                    </div>
                `;
                testInfo.classList.remove('hidden');
            }
            
            // تعبئة الصف الدراسي تلقائياً في نموذج الطالب
            const studentGradeSelect = document.getElementById('studentGrade');
            if (studentGradeSelect) {
                studentGradeSelect.innerHTML = `<option value="${test.grade}" selected>${test.grade}</option>`;
            }
            
            const studentForm = document.getElementById('studentForm');
            if (studentForm) studentForm.classList.remove('hidden');
        }
    } catch (error) {
        ErrorHandler.logError(error, 'selectTest');
    }
}

// بدء الاختبار
function startTest() {
    try {
        const name = DataValidator.sanitizeInput(document.getElementById('studentName')?.value || '');
        const studentGrade = document.getElementById('studentGrade')?.value || '';
        const studentClass = DataValidator.sanitizeInput(document.getElementById('studentClass')?.value || '');
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const testSelect = document.getElementById('testSelect');
        
        if (!selectedSchoolInfo || !testSelect) {
            alert('عناصر النظام غير متوفرة. يرجى تحديث الصفحة.');
            return;
        }
        
        const schoolId = selectedSchoolInfo.dataset.schoolId;
        const testIndex = testSelect.value;
        
        // التحقق من صحة البيانات
        const validation = DataValidator.validateStudentData({
            name: name,
            grade: studentGrade,
            class: studentClass
        });
        
        if (!validation.isValid) {
            alert(`يرجى تصحيح الأخطاء التالية:\n${validation.errors.join('\n')}`);
            return;
        }
        
        if (!schoolId || testIndex === '') {
            alert('يرجى اختيار المدرسة والاختبار أولاً');
            return;
        }
        
        const school = demoData.schools[schoolId];
        if (!school) {
            alert('المدرسة المحددة غير موجودة');
            return;
        }
        
        currentTest = school.tests[testIndex];
        if (!currentTest) {
            alert('الاختبار المحدد غير موجود');
            return;
        }
        
        // التحقق من صحة بيانات الاختبار
        const testValidation = DataValidator.validateTestData(currentTest);
        if (!testValidation.isValid) {
            alert(`خطأ في بيانات الاختبار:\n${testValidation.errors.join('\n')}`);
            return;
        }
        
        studentData = {
            name: name,
            grade: studentGrade,
            class: studentClass,
            score: 0,
            answers: [],
            school: school.name,
            teacher: school.teacher
        };
        
        currentQuestionIndex = 0;
        
        document.getElementById('studentAccessScreen').classList.add('hidden');
        document.getElementById('testScreen').classList.remove('hidden');
        
        updateTestInfo();
        showQuestion();
        
        // حفظ حالة الجلسة
        SystemRecovery.saveSession({
            testInProgress: true,
            studentData: studentData,
            currentTest: currentTest.name,
            currentQuestionIndex: currentQuestionIndex
        });
    } catch (error) {
        ErrorHandler.logError(error, 'startTest');
        alert('فشل في بدء الاختبار. يرجى المحاولة مرة أخرى.');
    }
}

function updateTestInfo() {
    try {
        const elements = {
            testSchoolName: document.getElementById('testSchoolName'),
            testSubjectName: document.getElementById('testSubjectName'),
            testGradeLevel: document.getElementById('testGradeLevel'),
            testStudentName: document.getElementById('testStudentName'),
            totalQuestions: document.getElementById('totalQuestions')
        };
        
        if (elements.testSchoolName) elements.testSchoolName.textContent = studentData.school;
        if (elements.testSubjectName) elements.testSubjectName.textContent = currentTest.subject;
        if (elements.testGradeLevel) elements.testGradeLevel.textContent = currentTest.grade;
        if (elements.testStudentName) elements.testStudentName.textContent = studentData.name;
        if (elements.totalQuestions) elements.totalQuestions.textContent = currentTest.questions.length;
    } catch (error) {
        ErrorHandler.logError(error, 'updateTestInfo');
    }
}

// عرض السؤال
function showQuestion() {
    try {
        if (currentQuestionIndex >= currentTest.questions.length) {
            endTest();
            return;
        }
        
        const question = currentTest.questions[currentQuestionIndex];
        
        const currentQuestionElement = document.getElementById('currentQuestion');
        const currentScoreElement = document.getElementById('currentScore');
        const questionTextElement = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedbackArea = document.getElementById('feedbackArea');
        const progressBar = document.getElementById('progressBar');
        
        if (currentQuestionElement) currentQuestionElement.textContent = currentQuestionIndex + 1;
        if (currentScoreElement) currentScoreElement.textContent = studentData.score;
        if (questionTextElement) questionTextElement.textContent = question.question;
        
        if (optionsContainer) {
            optionsContainer.innerHTML = '';
            
            const optionLabels = ['أ', 'ب', 'ج', 'د'];
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn bg-gray-50 hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 p-4 rounded-xl text-right transition-all';
                button.onclick = () => selectAnswer(index);
                button.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">${optionLabels[index]}</span>
                        <span class="flex-1">${option}</span>
                    </div>
                `;
                optionsContainer.appendChild(button);
            });
        }
        
        if (feedbackArea) {
            feedbackArea.classList.add('hidden');
        }
        
        // تحديث شريط التقدم
        if (progressBar) {
            const progress = ((currentQuestionIndex + 1) / currentTest.questions.length) * 100;
            progressBar.style.width = progress + '%';
        }
        
        startTimer();
        
        // تحديث الجلسة
        SystemRecovery.saveSession({
            testInProgress: true,
            studentData: studentData,
            currentTest: currentTest.name,
            currentQuestionIndex: currentQuestionIndex
        });
    } catch (error) {
        ErrorHandler.logError(error, 'showQuestion');
    }
}

function startTimer() {
    try {  
        // تنظيف كامل للمؤقت السابق
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        // استخدام وقت المؤقت المخصص للاختبار أو القيمة الافتراضية 30 ثانية
        timeLeft = currentTest.timerPerQuestion || 30;
        const timerElement = document.getElementById('timer');
        if (!timerElement) return;
        
        timerElement.textContent = timeLeft;
        timerElement.className = 'inline-block bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-2xl font-bold';
        
        timer = setInterval(() => {
            timeLeft--;
            timerElement.textContent = timeLeft;
            
            // تغيير لون المؤقت عندما يصل إلى 10 ثواني فقط
            const warningTime = 10; // ثابت عند 10 ثواني بدلاً من ربع الوقت
            if (timeLeft <= warningTime) {
                timerElement.className = 'inline-block bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-full text-2xl font-bold pulse-red';
            }
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                ResourceManager.timers.delete(timer);
                timer = null;
                timeUp();
            }
        }, 1000);
        
        ResourceManager.addTimer(timer);
    } catch (error) {
        ErrorHandler.logError(error, 'startTimer');
    }
}

function selectAnswer(selectedIndex) {
    try {
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        const question = currentTest.questions[currentQuestionIndex];
        const isCorrect = selectedIndex === question.correct;
        
        studentData.answers.push({
            questionIndex: currentQuestionIndex,
            selected: selectedIndex,
            correct: question.correct,
            isCorrect: isCorrect
        });
        
        if (isCorrect) {
            studentData.score++;
        }
        
        showFeedback(selectedIndex, question.correct, isCorrect);
        disableOptions();
        
        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
        }, 2000);
    } catch (error) {
        ErrorHandler.logError(error, 'selectAnswer');
    }
}

function timeUp() {
    try {
        const question = currentTest.questions[currentQuestionIndex];
        
        studentData.answers.push({
            questionIndex: currentQuestionIndex,
            selected: -1,
            correct: question.correct,
            isCorrect: false
        });
        
        showTimeUpFeedback(question.correct);
        disableOptions();
        
        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
        }, 2000);
    } catch (error) {
        ErrorHandler.logError(error, 'timeUp');
    }
}

function showFeedback(selectedIndex, correctIndex, isCorrect) {
    try {
        const feedbackArea = document.getElementById('feedbackArea');
        const options = document.querySelectorAll('.option-btn');
        
        if (!feedbackArea) return;
        
        if (isCorrect) {
            feedbackArea.innerHTML = '<div class="text-green-600 font-bold text-xl">✅ أحسنت! إجابة صحيحة</div>';
            feedbackArea.className = 'text-center p-4 rounded-xl mb-6 feedback-correct';
            if (options[selectedIndex]) {
                options[selectedIndex].className = 'option-btn bg-green-100 border-2 border-green-500 p-4 rounded-xl text-right';
            }
        } else {
            feedbackArea.innerHTML = '<div class="text-red-600 font-bold text-xl">❌ إجابة خاطئة - الإجابة الصحيحة: ' + currentTest.questions[currentQuestionIndex].options[correctIndex] + '</div>';
            feedbackArea.className = 'text-center p-4 rounded-xl mb-6 feedback-wrong';
            if (options[selectedIndex]) {
                options[selectedIndex].className = 'option-btn bg-red-100 border-2 border-red-500 p-4 rounded-xl text-right';
            }
            if (options[correctIndex]) {
                options[correctIndex].className = 'option-btn bg-green-100 border-2 border-green-500 p-4 rounded-xl text-right';
            }
        }
        
        feedbackArea.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showFeedback');
    }
}

function showTimeUpFeedback(correctIndex) {
    try {
        const feedbackArea = document.getElementById('feedbackArea');
        const options = document.querySelectorAll('.option-btn');
        
        if (!feedbackArea) return;
        
        feedbackArea.innerHTML = '<div class="text-orange-600 font-bold text-xl">⏰ انتهى الوقت! الإجابة الصحيحة: ' + currentTest.questions[currentQuestionIndex].options[correctIndex] + '</div>';
        feedbackArea.className = 'text-center p-4 rounded-xl mb-6 feedback-time-up';
        
        if (options[correctIndex]) {
            options[correctIndex].className = 'option-btn bg-green-100 border-2 border-green-500 p-4 rounded-xl text-right';
        }
        
        feedbackArea.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTimeUpFeedback');
    }
}

function disableOptions() {
    try {
        const options = document.querySelectorAll('.option-btn');
        options.forEach(option => {
            option.disabled = true;
            option.onclick = null;
            option.style.cursor = 'not-allowed';
        });
    } catch (error) {
        ErrorHandler.logError(error, 'disableOptions');
    }
}

// إنهاء الاختبار
function endTest() {
    try {
        // تنظيف المؤقت
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        const percentage = Math.round((studentData.score / currentTest.questions.length) * 100);
        let grade = '';
        
        if (percentage >= 90) grade = 'ممتاز';
        else if (percentage >= 80) grade = 'جيد جداً';
        else if (percentage >= 70) grade = 'جيد';
        else if (percentage >= 60) grade = 'مقبول';
        else grade = 'ضعيف';
        
        // حفظ النتيجة
        const result = {
            id: Date.now(),
            name: studentData.name,
            grade: studentData.grade,
            class: studentData.class,
            school: studentData.school,
            teacher: studentData.teacher,
            test: currentTest.name,
            subject: currentTest.subject,
            score: studentData.score,
            total: currentTest.questions.length,
            percentage: percentage,
            gradeLevel: grade,
            date: new Date().toLocaleDateString('ar-SA'),
            answers: studentData.answers,
            timestamp: Date.now()
        };
        
        const saveSuccess = saveResult(result);
        
        if (!saveSuccess) {
            alert('فشل في حفظ النتيجة. يرجى التواصل مع المسؤول.');
        }
        
        document.getElementById('testScreen').classList.add('hidden');
        document.getElementById('resultsScreen').classList.remove('hidden');
        
        const finalScoreElement = document.getElementById('finalScore');
        const percentageElement = document.getElementById('percentage');
        const gradeElement = document.getElementById('grade');
        
        if (finalScoreElement) finalScoreElement.textContent = studentData.score + ' من ' + currentTest.questions.length;
        if (percentageElement) percentageElement.textContent = percentage + '%';
        if (gradeElement) gradeElement.textContent = grade;
        
        // تنظيف الجلسة
        SystemRecovery.clearSession();
    } catch (error) {
        ErrorHandler.logError(error, 'endTest');
    }
}

// وظائف النتائج
function shareWhatsApp() {
    try {
        const percentage = Math.round((studentData.score / currentTest.questions.length) * 100);
        let grade = '';
        
        if (percentage >= 90) grade = 'ممتاز';
        else if (percentage >= 80) grade = 'جيد جداً';
        else if (percentage >= 70) grade = 'جيد';
        else if (percentage >= 60) grade = 'مقبول';
        else grade = 'ضعيف';
        
        const message = `🎉 أتممت الاختبار: ${currentTest.name}\n🎉 الطالب: ${studentData.name}\n\n🎉 في مادة: ${currentTest.subject}\n📊 النتيجة: ${studentData.score} من ${currentTest.questions.length}\n📈 النسبة: ${percentage}%\n🏆 التقدير: ${grade}\n🎒 الصف: ${studentData.grade}\n\n#${studentData.school}`;
        
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
    } catch (error) {
        ErrorHandler.logError(error, 'shareWhatsApp');
    }
}

function retakeTest() {
    try {
        studentData.score = 0;
        studentData.answers = [];
        currentQuestionIndex = 0;
        
        document.getElementById('resultsScreen').classList.add('hidden');
        document.getElementById('testScreen').classList.remove('hidden');
        
        showQuestion();
    } catch (error) {
        ErrorHandler.logError(error, 'retakeTest');
    }
}

function goBackToSchoolSelection() {
    try {
        document.getElementById('testScreen').classList.add('hidden');
        document.getElementById('resultsScreen').classList.add('hidden');
        document.getElementById('studentAccessScreen').classList.remove('hidden');
        
        // إعادة تعيين النموذج
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const schoolSearch = document.getElementById('schoolSearch');
        
        if (selectedSchoolInfo) selectedSchoolInfo.classList.add('hidden');
        if (schoolSearch) schoolSearch.value = '';
    } catch (error) {
        ErrorHandler.logError(error, 'goBackToSchoolSelection');
    }
}

// وظائف الخروج من الاختبار
function confirmExitTest() {
    try {
        document.getElementById('exitTestModal').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'confirmExitTest');
    }
}

function cancelExitTest() {
    try {
        document.getElementById('exitTestModal').classList.add('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'cancelExitTest');
    }
}

function exitTest() {
    try {
        // تنظيف جميع الموارد
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        ResourceManager.cleanup();
        SystemRecovery.clearSession();
        
        currentTest = null;
        currentQuestionIndex = 0;
        studentData = { name: '', grade: '', class: '', score: 0, answers: [] };
        
        document.getElementById('exitTestModal').classList.add('hidden');
        document.getElementById('testScreen').classList.add('hidden');
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // تحديث الإحصائيات
        updateWelcomeStatistics();
    } catch (error) {
        ErrorHandler.logError(error, 'exitTest');
    }
}

// ========== دوال الشهادة Canvas المحسنة ==========

async function generateCertificateImage(format) {
    try {
        showLoadingMessage('جاري إنشاء الشهادة...');
        
        const canvas = document.getElementById('certificateCanvas');
        if (!canvas) {
            throw new Error('Canvas element not found');
        }
        
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            throw new Error('Canvas context not available');
        }
        
        // مسح Canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ========== الخلفية الأساسية ==========
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#f8fafc');
        gradient.addColorStop(0.5, '#f0f4ff');
        gradient.addColorStop(1, '#fdf2ff');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ========== الزخارف الخلفية ==========
        ctx.fillStyle = 'rgba(139, 92, 246, 0.03)';
        ctx.font = 'bold 120px Arial';
        ctx.textAlign = 'center';
        
        // زخارف موزعة بشكل متساو
        ctx.fillText('🎓', canvas.width/2, 350);
        ctx.fillText('⭐', canvas.width/4, 450);
        ctx.fillText('📚', canvas.width * 3/4, 400);
        ctx.fillText('🏆', canvas.width/3, 1400);
        ctx.fillText('💫', canvas.width * 2/3, 1500);
        ctx.fillText('🎯', canvas.width/2, 2800);
        ctx.fillText('✨', canvas.width/5, 2700);
        ctx.fillText('🌟', canvas.width * 4/5, 2750);
        
        // ========== الإطار الخارجي ==========
        const borderGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        borderGradient.addColorStop(0, '#3b82f6');
        borderGradient.addColorStop(0.25, '#8b5cf6');
        borderGradient.addColorStop(0.5, '#ec4899');
        borderGradient.addColorStop(0.75, '#f59e0b');
        borderGradient.addColorStop(1, '#10b981');
        
        ctx.strokeStyle = borderGradient;
        ctx.lineWidth = 25;
        ctx.strokeRect(50, 50, canvas.width - 100, canvas.height - 100);
        
        // إطار داخلي ذهبي
        ctx.strokeStyle = '#f59e0b';
        ctx.lineWidth = 8;
        ctx.strokeRect(100, 100, canvas.width - 200, canvas.height - 200);
        
        // ========== العنوان الرئيسي ==========
        const titleGradient = ctx.createLinearGradient(canvas.width/2 - 300, 200, canvas.width/2 + 300, 200);
        titleGradient.addColorStop(0, '#f59e0b');
        titleGradient.addColorStop(0.5, '#fbbf24');
        titleGradient.addColorStop(1, '#f59e0b');
        
        ctx.fillStyle = titleGradient;
        ctx.font = 'bold 140px "Cairo"';
        ctx.textAlign = 'center';
        ctx.fillText('شهادة إنجاز', canvas.width/2, 280);
        
        // العنوان بالإنجليزية
        ctx.fillStyle = '#6b7280';
        ctx.font = 'italic 45px "Cairo"';
        ctx.fillText('Certificate of Achievement', canvas.width/2, 380);
        
        // خط زخرفي تحت العنوان
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 - 250, 410);
        ctx.lineTo(canvas.width/2 + 250, 410);
        ctx.stroke();
        
        // ========== اسم المدرسة ==========
        ctx.fillStyle = '#7c3aed';
        ctx.font = 'bold 75px "Cairo"';
        ctx.fillText(studentData.school, canvas.width/2, 530);
        
        // ========== القسم الأول: بيانات الطالب ==========
        const section1Y = 700;
        
        // النص التمهيدي
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('تشهد هذه المؤسسة التعليمية بأن الطالب/ة', canvas.width/2, section1Y);
        
        // اسم الطالب
        const nameGradient = ctx.createLinearGradient(canvas.width/2 - 400, section1Y + 100, canvas.width/2 + 400, section1Y + 220);
        nameGradient.addColorStop(0, '#7c3aed');
        nameGradient.addColorStop(0.5, '#3b82f6');
        nameGradient.addColorStop(1, '#7c3aed');
        
        ctx.fillStyle = nameGradient;
        ctx.font = 'bold 120px "Cairo"';
        ctx.fillText(studentData.name, canvas.width/2, section1Y + 180);
        
        // خط تحت اسم الطالب
        ctx.strokeStyle = '#c4b5fd';
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 - 350, section1Y + 210);
        ctx.lineTo(canvas.width/2 + 350, section1Y + 210);
        ctx.stroke();
        
        // ========== القسم الثاني: المعلومات الأكاديمية ==========
        const section2Y = 1050;
        
        // الصف والفصل
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText(`من الصف ${studentData.grade} والفصل ${studentData.class}`, canvas.width/2, section2Y);
        
        // النص التالي
        ctx.fillText('قد أتم بنجاح', canvas.width/2, section2Y + 100);
        
        // اسم الاختبار
        ctx.fillStyle = '#3b82f6';
        ctx.font = 'bold 70px "Cairo"';
        ctx.fillText(currentTest.name, canvas.width/2, section2Y + 200);
        
        // المادة
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('في مادة', canvas.width/2, section2Y + 300);
        
        ctx.fillStyle = '#10b981';
        ctx.font = 'bold 60px "Cairo"';
        ctx.fillText(currentTest.subject, canvas.width/2, section2Y + 380);
        
        // ========== القسم الثالث: النتائج ==========
        const resultsBox = {
            x: canvas.width/2 - 450,
            y: 1550,
            width: 900,
            height: 280
        };
        
        // خلفية المربع
        ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
        ctx.strokeStyle = '#d1d5db';
        ctx.lineWidth = 3;
        
        // ظل للمربع
        ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
        ctx.shadowBlur = 20;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 10;
        ctx.fillRect(resultsBox.x, resultsBox.y, resultsBox.width, resultsBox.height);
        ctx.shadowColor = 'transparent';
        ctx.strokeRect(resultsBox.x, resultsBox.y, resultsBox.width, resultsBox.height);
        
        // حساب النسبة والتقدير
        const percentage = Math.round((studentData.score / currentTest.questions.length) * 100);
        const grade = calculateGrade(percentage);
        
        // تقسيم المربع إلى 3 أجزاء
        const sectionWidth = resultsBox.width / 3;
        
        // الدرجة
        ctx.fillStyle = '#3b82f6';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('الدرجة', resultsBox.x + sectionWidth/2, resultsBox.y + 90);
        ctx.font = 'bold 75px "Cairo"';
        ctx.fillText(`${studentData.score}/${currentTest.questions.length}`, resultsBox.x + sectionWidth/2, resultsBox.y + 180);
        
        // النسبة
        ctx.fillStyle = '#10b981';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('النسبة', resultsBox.x + sectionWidth + sectionWidth/2, resultsBox.y + 90);
        ctx.font = 'bold 75px "Cairo"';
        ctx.fillText(`${percentage}%`, resultsBox.x + sectionWidth + sectionWidth/2, resultsBox.y + 180);
        
        // التقدير
        ctx.fillStyle = '#8b5cf6';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('التقدير', resultsBox.x + 2 * sectionWidth + sectionWidth/2, resultsBox.y + 90);
        ctx.font = 'bold 65px "Cairo"';
        ctx.fillText(grade, resultsBox.x + 2 * sectionWidth + sectionWidth/2, resultsBox.y + 180);
        
        // خطوط فاصلة
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(resultsBox.x + sectionWidth, resultsBox.y + 30);
        ctx.lineTo(resultsBox.x + sectionWidth, resultsBox.y + resultsBox.height - 30);
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(resultsBox.x + 2 * sectionWidth, resultsBox.y + 30);
        ctx.lineTo(resultsBox.x + 2 * sectionWidth, resultsBox.y + resultsBox.height - 30);
        ctx.stroke();
        
        // ========== القسم الرابع: رسالة تهنئة موسعة ==========
        const congratulationY = 1950;
        
        ctx.fillStyle = '#7c3aed';
        ctx.font = 'bold 65px "Cairo"';
        ctx.fillText('مبروك على إنجازك!', canvas.width/2, congratulationY);
        
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('نحن نفتخر بإنجازك المتميز ونسأل الله لك دوام التوفيق والنجاح', canvas.width/2, congratulationY + 90);
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '42px "Cairo"';
        ctx.fillText('نتمنى لك مستقبلاً زاهراً مليئاً بالإنجازات والتفوق', canvas.width/2, congratulationY + 180);
        
        // ========== القسم الخامس: التوقيعات ==========
        const signaturesY = 2300;
        
        // مدير المدرسة (على اليمين)
        ctx.textAlign = 'right';
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('مدير المدرسة', 700, signaturesY);
        ctx.fillStyle = '#1f2937';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('أ. خالد الحمرين', 700, signaturesY + 90);
        
        // خط التوقيع
        ctx.strokeStyle = '#9ca3af';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(500, signaturesY + 130);
        ctx.lineTo(800, signaturesY + 130);
        ctx.stroke();
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '38px "Cairo"';
        ctx.fillText('التوقيع', 650, signaturesY + 180);
        
        // معلم المادة (على اليسار)
        ctx.textAlign = 'left';
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('معلم المادة', canvas.width - 700, signaturesY);
        ctx.fillStyle = '#1f2937';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText(studentData.teacher, canvas.width - 700, signaturesY + 90);
        
        // خط التوقيع
        ctx.beginPath();
        ctx.moveTo(canvas.width - 800, signaturesY + 130);
        ctx.lineTo(canvas.width - 500, signaturesY + 130);
        ctx.stroke();
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '38px "Cairo"';
        ctx.fillText('التوقيع', canvas.width - 650, signaturesY + 180);
        
        // ========== القسم السادس: المعلومات الإضافية ==========
        const infoY = 2650;
        
        ctx.textAlign = 'center';
        ctx.fillStyle = '#6b7280';
        ctx.font = '38px "Cairo"';
        const date = new Date().toLocaleDateString('ar-SA');
        ctx.fillText(`تاريخ الإصدار: ${date}`, canvas.width/2, infoY);
        ctx.fillText(`رقم الشهادة: CERT-${Date.now()}`, canvas.width/2, infoY + 70);
        
        // ========== القسم السابع: زخرفة ختامية ==========
        const decorationY = 2850;
        
        // خط زخرفي
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 - 300, decorationY);
        ctx.lineTo(canvas.width/2 + 300, decorationY);
        ctx.stroke();
        
        // نقاط زخرفية
        ctx.fillStyle = '#3b82f6';
        for (let i = -4; i <= 4; i++) {
            const x = canvas.width/2 + (i * 75);
            ctx.beginPath();
            ctx.arc(x, decorationY, 12, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // رسالة شكر
        ctx.fillStyle = '#4b5563';
        ctx.font = '42px "Cairo"';
        ctx.fillText('شكراً لجهودكم المبذولة', canvas.width/2, decorationY + 90);

        // ========== الزخرفة النهائية ==========
        ctx.fillStyle = 'rgba(139, 92, 246, 0.1)';
        ctx.font = 'bold 130px Arial';
        ctx.fillText('🎉', canvas.width/2, canvas.height - 150);

        // تحويل Canvas إلى صورة
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const imageData = canvas.toDataURL(`image/${format}`, 1.0);
        downloadImage(imageData, format);
        
        // تحديث المعاينة
        updateCertificatePreview(imageData);
        
        hideLoadingMessage();
        showSuccessMessage('تم إنشاء الشهادة بنجاح', `تم حفظ الشهادة كصورة ${format.toUpperCase()}`);
        
    } catch (error) {
        console.error('خطأ في إنشاء الشهادة:', error);
        hideLoadingMessage();
        showErrorMessage('خطأ في الإنشاء', 'تعذر إنشاء الشهادة كصورة');
    }
}

// دالة حساب التقدير
function calculateGrade(percentage) {
    if (percentage >= 90) return 'ممتاز';
    else if (percentage >= 80) return 'جيد جداً';
    else if (percentage >= 70) return 'جيد';
    else if (percentage >= 60) return 'مقبول';
    else return 'ضعيف';
}

// دالة تحميل الصورة
function downloadImage(imageData, format) {
    try {
        const downloadLink = document.createElement('a');
        const fileName = `شهادة_${studentData.name}_${currentTest.name}_${new Date().toLocaleDateString('ar-SA')}.${format}`;
        
        downloadLink.href = imageData;
        downloadLink.download = fileName;
        
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    } catch (error) {
        ErrorHandler.logError(error, 'downloadImage');
    }
}

// دالة تحديث معاينة الشهادة
function updateCertificatePreview(imageData) {
    try {
        const preview = document.getElementById('certificatePreview');
        if (preview) {
            preview.innerHTML = `
                <div class="text-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">معاينة الشهادة المحسنة</h3>
                    <p class="text-gray-600">جودة عالية - تصميم احترافي</p>
                </div>
                <img src="${imageData}" alt="شهادة إنجاز" class="w-full h-auto rounded-lg shadow-2xl border-4 border-gold-200 max-h-96 object-contain mx-auto">
                <div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                    <p class="text-green-700 text-sm"><strong>✓ تم إنشاء الشهادة بنجاح:</strong> جودة عالية بدقة 2480×3508 بكسل</p>
                </div>
            `;
        }
    } catch (error) {
        ErrorHandler.logError(error, 'updateCertificatePreview');
    }
}

// دوال الرسائل
function showLoadingMessage(message) {
    try {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingOverlay';
        loadingDiv.className = 'loading-overlay';
        loadingDiv.innerHTML = `
            <div class="bg-white rounded-2xl p-8 text-center shadow-2xl">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-gray-800 font-semibold text-xl">${message}</p>
            </div>
        `;
        document.body.appendChild(loadingDiv);
    } catch (error) {
        ErrorHandler.logError(error, 'showLoadingMessage');
    }
}

function hideLoadingMessage() {
    try {
        const loadingDiv = document.getElementById('loadingOverlay');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'hideLoadingMessage');
    }
}

function showSuccessMessage(title, message) {
    try {
        const messageId = 'successMessage-' + Date.now();
        const messageHTML = `
            <div id="${messageId}" class="fixed top-4 left-4 right-4 bg-green-500 text-white p-4 rounded-xl shadow-lg z-50 flex items-center gap-3">
                <span class="text-2xl">✅</span>
                <div class="flex-1">
                    <div class="font-bold">${title}</div>
                    <div class="text-sm">${message}</div>
                </div>
                <button onclick="document.getElementById('${messageId}').remove()" class="text-white hover:text-gray-200">
                    ✕
                </button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', messageHTML);
        
        setTimeout(() => {
            const element = document.getElementById(messageId);
            if (element) element.remove();
        }, 5000);
    } catch (error) {
        ErrorHandler.logError(error, 'showSuccessMessage');
    }
}

function showErrorMessage(title, message) {
    try {
        const messageId = 'errorMessage-' + Date.now();
        const messageHTML = `
            <div id="${messageId}" class="fixed top-4 left-4 right-4 bg-red-500 text-white p-4 rounded-xl shadow-lg z-50 flex items-center gap-3">
                <span class="text-2xl">❌</span>
                <div class="flex-1">
                    <div class="font-bold">${title}</div>
                    <div class="text-sm">${message}</div>
                </div>
                <button onclick="document.getElementById('${messageId}').remove()" class="text-white hover:text-gray-200">
                    ✕
                </button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', messageHTML);
        
        setTimeout(() => {
            const element = document.getElementById(messageId);
            if (element) element.remove();
        }, 5000);
    } catch (error) {
        ErrorHandler.logError(error, 'showErrorMessage');
    }
}

// ========== لوحة تحكم المعلم المحسنة ==========

function showTeacherDashboard() {
    try {
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('teacherDashboard').classList.remove('hidden');
        
        // تحديث معلومات المعلم
        const teacherWelcome = document.getElementById('teacherWelcome');
        if (teacherWelcome) {
            teacherWelcome.textContent = `مرحباً ${currentUser.name}`;
        }
        
        // تحديث بيانات المدرسة للمعلم الحالي
        updateTeacherSchoolData();
        
        // تحميل لوحة المعلومات
        loadDashboardData();
        
        // تحميل الاختبارات
        loadTeacherTests();
        
        // تحميل قائمة الاختبارات لفلتر الأسئلة
        loadTestSelectForQuestions();
        
        // تحميل النتائج
        loadResultsForTeacher();
        
        // تحميل الإعدادات
        loadTeacherSettings();
        
        // التحقق من صلاحيات المسؤول
        checkAdminPermissions();
        
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherDashboard');
    }
}

function updateTeacherSchoolData() {
    try {
        // البحث عن مدرسة المعلم الحالي
        let teacherSchool = null;
        
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === currentUser.name) {
                teacherSchool = demoData.schools[schoolId];
                currentManagingTestSchoolId = schoolId;
                break;
            }
        }
        
        // إذا لم توجد مدرسة للمعلم، قم بإنشائها
        if (!teacherSchool) {
            const newSchoolId = 'school_' + Date.now();
            teacherSchool = {
                id: newSchoolId,
                name: currentUser.school,
                teacher: currentUser.name,
                tests: []
            };
            
            demoData.schools[newSchoolId] = teacherSchool;
            currentManagingTestSchoolId = newSchoolId;
            
            // حفظ التحديثات
            StorageManager.setItem('demoSchoolsData', demoData.schools);
        }
        
        console.log('تم تحديث بيانات المدرسة للمعلم:', currentUser.name);
    } catch (error) {
        ErrorHandler.logError(error, 'updateTeacherSchoolData');
    }
}

function showTab(tabName) {
    try {
        const tabs = ['dashboard', 'tests', 'questions', 'results', 'settings'];
        
        // تحديث التبويبات
        tabs.forEach(tab => {
            const tabBtn = document.getElementById(tab + 'Tab');
            const content = document.getElementById(tab + 'Content');
            
            if (tabBtn && content) {
                if (tab === tabName) {
                    tabBtn.classList.add('active', 'bg-white', 'text-blue-600');
                    tabBtn.classList.remove('bg-transparent', 'text-gray-600');
                    content.classList.remove('hidden');
                } else {
                    tabBtn.classList.remove('active', 'bg-white', 'text-blue-600');
                    tabBtn.classList.add('bg-transparent', 'text-gray-600');
                    content.classList.add('hidden');
                }
            }
        });
        
        // تحميل البيانات الخاصة بكل تبويب
        if (tabName === 'dashboard') {
            loadDashboardData();
        } else if (tabName === 'questions') {
            loadTestSelectForQuestions();
        } else if (tabName === 'results') {
            loadResultsForTeacher();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'showTab');
    }
}

function loadDashboardData() {
    try {
        const results = getResultsSync(); // استخدام الدالة المتزامنة
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // حساب الإحصائيات
        const totalTests = currentManagingTestSchoolId ? 
            demoData.schools[currentManagingTestSchoolId]?.tests.length || 0 : 0;
        const totalStudents = teacherResults.length;
        const totalScore = teacherResults.reduce((sum, result) => sum + result.percentage, 0);
        const averageScore = totalStudents > 0 ? Math.round(totalScore / totalStudents) : 0;
        const passRate = totalStudents > 0 ? 
            Math.round((teacherResults.filter(r => r.percentage >= 60).length / totalStudents) * 100) : 0;
        
        // تحديث العناصر
        const elements = {
            totalTests: document.getElementById('totalTests'),
            totalStudents: document.getElementById('totalStudents'),
            averageScore: document.getElementById('averageScore'),
            passRate: document.getElementById('passRate'),
            totalAttempts: document.getElementById('totalAttempts'),
            highestScore: document.getElementById('highestScore'),
            lowestScore: document.getElementById('lowestScore')
        };
        
        if (elements.totalTests) elements.totalTests.textContent = totalTests;
        if (elements.totalStudents) elements.totalStudents.textContent = totalStudents;
        if (elements.averageScore) elements.averageScore.textContent = averageScore + '%';
        if (elements.passRate) elements.passRate.textContent = passRate + '%';
        if (elements.totalAttempts) elements.totalAttempts.textContent = totalStudents;
        
        if (totalStudents > 0) {
            const highest = Math.max(...teacherResults.map(r => r.percentage));
            const lowest = Math.min(...teacherResults.map(r => r.percentage));
            
            if (elements.highestScore) elements.highestScore.textContent = highest + '%';
            if (elements.lowestScore) elements.lowestScore.textContent = lowest + '%';
        }
    } catch (error) {
        ErrorHandler.logError(error, 'loadDashboardData');
    }
}

function loadTeacherTests() {
    try {
        const testsGrid = document.getElementById('testsGrid');
        if (!testsGrid) return;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests) {
            testsGrid.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-12">لا توجد اختبارات بعد</div>';
            return;
        }
        
        if (school.tests.length === 0) {
            testsGrid.innerHTML = `
                <div class="col-span-3 text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">📝</div>
                    <p class="text-lg mb-4">لا توجد اختبارات بعد</p>
                    <button onclick="showCreateTestModal()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-600 transition-all">
                        ➕ إنشاء أول اختبار
                    </button>
                </div>
            `;
            return;
        }
        
        let testsHTML = '';
        
        school.tests.forEach((test, index) => {
            testsHTML += `
                <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 hover:shadow-lg transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-xl text-gray-800">${test.name}</h4>
                        <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm">${test.subject}</span>
                    </div>
                    
                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">المادة:</span>
                            <span class="font-semibold">${test.subject}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">الصف:</span>
                            <span class="font-semibold">${test.grade}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">الأسئلة:</span>
                            <span class="font-semibold">${test.questions.length}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">الوقت:</span>
                            <span class="font-semibold">${test.timerPerQuestion || 30} ثانية</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="editTest(${index})" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold transition-all">
                            تعديل
                        </button>
                        <button onclick="deleteTest(${index})" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg text-sm font-semibold transition-all">
                            حذف
                        </button>
                    </div>
                </div>
            `;
        });
        
        testsGrid.innerHTML = testsHTML;
    } catch (error) {
        ErrorHandler.logError(error, 'loadTeacherTests');
    }
}

// ========== النوافذ المنبثقة للاختبارات ==========

function showCreateTestModal() {
    try {
        currentEditingTestId = null;
        
        const modal = document.getElementById('testModal');
        const modalTitle = document.getElementById('testModalTitle');
        const form = document.getElementById('testModalForm');
        const errorDiv = document.getElementById('testModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Test modal elements not found');
        }
        
        modalTitle.textContent = 'إنشاء اختبار جديد';
        form.reset();
        errorDiv.classList.add('hidden');
        
        // تحديث خيارات الصفوف بناءً على مرحلة المعلم
        updateGradeOptions(currentUser.stage, 'modalTestGrade');
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showCreateTestModal');
    }
}

function editTest(testIndex) {
    try {
        currentEditingTestId = testIndex;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[testIndex]) {
            alert('الاختبار غير موجود');
            return;
        }
        
        const test = school.tests[testIndex];
        const modal = document.getElementById('testModal');
        const modalTitle = document.getElementById('testModalTitle');
        const form = document.getElementById('testModalForm');
        const errorDiv = document.getElementById('testModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Test modal elements not found');
        }
        
        modalTitle.textContent = 'تعديل الاختبار';
        errorDiv.classList.add('hidden');
        
        // تعبئة بيانات الاختبار
        document.getElementById('modalTestName').value = test.name || '';
        document.getElementById('modalTestSubject').value = test.subject || '';
        document.getElementById('modalTestTimer').value = test.timerPerQuestion || 30;
        document.getElementById('modalTestDescription').value = test.description || '';
        
        // تحديث خيارات الصفوف
        updateGradeOptions(currentUser.stage, 'modalTestGrade');
        
        // تعيين الصف الحالي
        const gradeSelect = document.getElementById('modalTestGrade');
        if (gradeSelect && test.grade) {
            gradeSelect.value = test.grade;
        }
        
        // تعيين مستوى الصعوبة
        const difficultySelect = document.getElementById('modalTestDifficulty');
        if (difficultySelect && test.difficulty) {
            difficultySelect.value = test.difficulty;
        }
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'editTest');
    }
}

function closeTestModal() {
    try {
        const modal = document.getElementById('testModal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        currentEditingTestId = null;
    } catch (error) {
        ErrorHandler.logError(error, 'closeTestModal');
    }
}

// حفظ الاختبار مع دعم الخادم البعيد
async function handleTestFormSubmit(event) {
    try {
        event.preventDefault();
        
        const name = DataValidator.sanitizeInput(document.getElementById('modalTestName').value);
        const subject = DataValidator.sanitizeInput(document.getElementById('modalTestSubject').value);
        const grade = document.getElementById('modalTestGrade').value;
        const timerPerQuestion = parseInt(document.getElementById('modalTestTimer').value) || 30;
        const description = DataValidator.sanitizeInput(document.getElementById('modalTestDescription').value);
        const difficulty = document.getElementById('modalTestDifficulty').value;
        
        const errorDiv = document.getElementById('testModalError');
        if (!errorDiv) {
            throw new Error('Error div not found');
        }
        
        // التحقق من صحة البيانات
        if (!name || !subject || !grade) {
            errorDiv.textContent = 'يرجى ملء جميع الحقول المطلوبة';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        if (timerPerQuestion < 10 || timerPerQuestion > 300) {
            errorDiv.textContent = 'وقت السؤال يجب أن يكون بين 10 و 300 ثانية';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school) {
            errorDiv.textContent = 'المدرسة غير موجودة';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const newTest = {
            name: name,
            subject: subject,
            grade: grade,
            timerPerQuestion: timerPerQuestion,
            description: description,
            difficulty: difficulty,
            questions: []
        };
        
        if (currentEditingTestId === null) {
            // إنشاء اختبار جديد
            school.tests.push(newTest);
        } else {
            // تعديل اختبار موجود
            school.tests[currentEditingTestId] = {
                ...school.tests[currentEditingTestId],
                ...newTest
            };
        }
        
        try {
            // محاولة الحفظ في الخادم البعيد
            await RemoteAPI.updateSchool(currentManagingTestSchoolId, school);
            
            // ثم الحفظ محلياً
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            
        } catch (apiError) {
            // إذا فشل الخادم البعيد، الحفظ محلياً فقط
            console.warn('فشل تحديث المدرسة في الخادم البعيد، استخدام التخزين المحلي:', apiError);
            const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
            if (!success) {
                errorDiv.textContent = 'فشل في حفظ البيانات';
                errorDiv.classList.remove('hidden');
                return false;
            }
        }
        
        closeTestModal();
        loadTeacherTests();
        
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'handleTestFormSubmit');
        return false;
    }
}

function deleteTest(testIndex) {
    try {
        if (!confirm('هل أنت متأكد من حذف هذا الاختبار؟')) {
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (school && school.tests[testIndex]) {
            school.tests.splice(testIndex, 1);
            
            // حفظ البيانات
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            
            // إعادة تحميل الاختبارات
            loadTeacherTests();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'deleteTest');
    }
}

// ========== النوافذ المنبثقة للأسئلة ==========

function loadTestSelectForQuestions() {
    try {
        const testSelect = document.getElementById('questionTestSelect');
        if (!testSelect) return;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school) {
            testSelect.innerHTML = '<option value="">لا توجد اختبارات</option>';
            return;
        }
        
        testSelect.innerHTML = '<option value="">اختر الاختبار</option>';
        
        school.tests.forEach((test, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
            testSelect.appendChild(option);
        });
    } catch (error) {
        ErrorHandler.logError(error, 'loadTestSelectForQuestions');
    }
}

function loadTestQuestions() {
    try {
        console.log('🎯 بدء تحميل الأسئلة...');
        
        const testIndex = document.getElementById('questionTestSelect').value;
        const questionsContainer = document.getElementById('questionsContainer');
        
        if (!questionsContainer) {
            console.error('❌ questionsContainer غير موجود');
            return;
        }
        
        if (testIndex === '') {
            questionsContainer.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">❓</div>
                    <p>اختر اختباراً لعرض الأسئلة</p>
                </div>
            `;
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school) {
            console.error('❌ المدرسة غير موجودة');
            questionsContainer.innerHTML = '<div class="text-center text-red-500 py-12">المدرسة غير موجودة</div>';
            return;
        }
        
        if (!school.tests || !school.tests[testIndex]) {
            console.error('❌ الاختبار غير موجود');
            questionsContainer.innerHTML = '<div class="text-center text-red-500 py-12">الاختبار غير موجود</div>';
            return;
        }
        
        const test = school.tests[testIndex];
        currentManagingTest = testIndex;
        
        console.log('📝 تم العثور على الاختبار:', test.name);
        
        // التأكد من وجود مصفوفة الأسئلة
        if (!test.questions || !Array.isArray(test.questions)) {
            console.warn('⚠️ بيانات الأسئلة غير صالحة، يتم تهيئتها من جديد');
            test.questions = [];
        }
        
        if (test.questions.length === 0) {
            questionsContainer.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">📝</div>
                    <p class="text-lg mb-4">لا توجد أسئلة في هذا الاختبار</p>
                    <button onclick="showAddQuestionModal()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-green-600 hover:to-blue-600 transition-all">
                        ➕ إضافة أول سؤال
                    </button>
                </div>
            `;
            return;
        }
        
        let questionsHTML = `
            <div class="mb-6">
                <h4 class="font-bold text-xl text-gray-800 mb-2">أسئلة اختبار: ${test.name}</h4>
                <p class="text-gray-600">عدد الأسئلة: ${test.questions.length}</p>
            </div>
            
            <div id="questionsList" class="space-y-4">
        `;
        
        test.questions.forEach((question, index) => {
            if (!question) {
                console.warn(`⚠️ سؤال في الفهرس ${index} غير معرف، يتم تخطيه`);
                return;
            }
            
            const optionLabels = ['أ', 'ب', 'ج', 'د'];
            const correctAnswer = question.correct !== undefined ? question.correct : 0;
            const correctAnswerLabel = optionLabels[correctAnswer] || 'أ';
            
            questionsHTML += `
                <div class="question-item bg-white border-2 border-gray-200 rounded-2xl p-6 transition-all duration-300 hover:shadow-lg"
                     data-question-index="${index}">
                    
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="flex-1">
                                <h5 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                    <span class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">${index + 1}</span>
                                    السؤال ${index + 1}
                                </h5>
                            </div>
                        </div>
                        <span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-sm font-semibold">
                            ✓ ${correctAnswerLabel}
                        </span>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-gray-700 text-lg bg-gray-50 p-4 rounded-xl border">${question.question || 'لا يوجد نص للسؤال'}</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-3 mb-4">
                        ${(question.options || ['', '', '', '']).map((option, optIndex) => `
                            <div class="flex items-center gap-3 p-3 rounded-xl border-2 ${
                                optIndex === correctAnswer 
                                ? 'bg-green-50 border-green-300 text-green-700' 
                                : 'bg-gray-50 border-gray-200 text-gray-700'
                            } transition-all">
                                <span class="w-8 h-8 ${
                                    optIndex === correctAnswer 
                                    ? 'bg-green-500 text-white' 
                                    : 'bg-gray-300 text-gray-600'
                                } rounded-full flex items-center justify-center font-bold text-sm">
                                    ${optionLabels[optIndex]}
                                </span>
                                <span class="flex-1 ${optIndex === correctAnswer ? 'font-semibold' : ''}">${option || 'خيار فارغ'}</span>
                                ${optIndex === correctAnswer ? 
                                    '<span class="text-green-500 text-lg">✓</span>' : 
                                    ''
                                }
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex gap-2 pt-4 border-t border-gray-200">
                        <button onclick="editQuestion(${index})" 
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                            تعديل
                        </button>
                        <button onclick="deleteQuestion(${index})" 
                                class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                            حذف
                        </button>
                    </div>
                </div>
            `;
        });
        
        questionsHTML += `</div>`; // إغلاق questionsList
        
        questionsContainer.innerHTML = questionsHTML;
        
        // نظام السحب والإفلات معطل تماماً
        console.log('🚫 نظام السحب والإفلات معطل - التحميل مكتمل');
        
    } catch (error) {
        console.error('❌ خطأ في تحميل الأسئلة:', error);
        ErrorHandler.logError(error, 'loadTestQuestions');
        
        questionsContainer.innerHTML = `
            <div class="text-center text-red-500 py-12">
                <div class="text-6xl mb-4">❌</div>
                <p class="text-lg mb-4">حدث خطأ في تحميل الأسئلة</p>
                <button onclick="loadTestQuestions()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                    🔄 إعادة المحاولة
                </button>
            </div>
        `;
    }
}

// ========== نظام السحب والإفلات للأسئلة ==========
function initializeDragAndDrop() {
    try {
        console.log('🚀 بدء تهيئة نظام السحب والإفلات...');
        
        const questionsList = document.getElementById('questionsList');
        if (!questionsList) {
            console.log('⏳ قائمة الأسئلة غير جاهزة بعد');
            return false;
        }

        // إزالة جميع مستمعات الأحداث الحالية أولاً
        const newQuestionsList = questionsList.cloneNode(true);
        questionsList.parentNode.replaceChild(newQuestionsList, questionsList);

        const questionItems = newQuestionsList.querySelectorAll('.question-item');
        if (questionItems.length === 0) {
            console.log('ℹ️ لا توجد أسئلة لسحبها');
            return false;
        }

        console.log(`✅ تم العثور على ${questionItems.length} سؤال للتهيئة`);
        
        let draggedItem = null;
        let dragStartIndex = null;

        // إعادة تعيين جميع العناصر للسحب
        questionItems.forEach(item => {
            item.setAttribute('draggable', 'true');
            item.classList.remove('dragging', 'drag-over');
        });

        // إنشاء مؤشر الإفلات
        function createDropIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'drop-indicator';
            indicator.style.height = '3px';
            indicator.style.background = 'linear-gradient(90deg, #3b82f6, #8b5cf6)';
            indicator.style.margin = '8px 0';
            indicator.style.borderRadius = '3px';
            return indicator;
        }

        // الحصول على العنصر الذي يلي موضع السحب
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.question-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // أحداث السحب - مع منع الانتشار
        newQuestionsList.addEventListener('dragstart', function(e) {
            draggedItem = e.target.closest('.question-item');
            if (!draggedItem) return;
            
            e.stopPropagation();
            dragStartIndex = parseInt(draggedItem.dataset.questionIndex);
            draggedItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedItem.dataset.questionIndex);
            
            console.log('📦 بدء سحب السؤال:', dragStartIndex);
        });

        newQuestionsList.addEventListener('dragend', function(e) {
            e.stopPropagation();
            if (!draggedItem) return;
            
            draggedItem.classList.remove('dragging');
            draggedItem.style.opacity = '1';
            draggedItem.style.transform = 'none';
            
            // إزالة جميع مؤشرات الإفلات
            const indicators = newQuestionsList.querySelectorAll('.drop-indicator');
            indicators.forEach(indicator => indicator.remove());
            
            // إزالة تأثيرات السحب من جميع العناصر
            const allItems = newQuestionsList.querySelectorAll('.question-item');
            allItems.forEach(item => {
                item.classList.remove('drag-over');
            });
            
            draggedItem = null;
            dragStartIndex = null;
            
            console.log('✅ انتهاء السحب');
        });

        newQuestionsList.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!draggedItem) return;
            
            const afterElement = getDragAfterElement(newQuestionsList, e.clientY);
            const draggable = newQuestionsList.querySelector('.dragging');
            
            if (!draggable) return;

            // إزالة مؤشرات الإفلات القديمة
            const oldIndicators = newQuestionsList.querySelectorAll('.drop-indicator');
            oldIndicators.forEach(indicator => indicator.remove());

            // إضافة مؤشر الإفلات الجديد
            if (afterElement == null) {
                const indicator = createDropIndicator();
                newQuestionsList.appendChild(indicator);
            } else {
                const indicator = createDropIndicator();
                newQuestionsList.insertBefore(indicator, afterElement);
            }
        });

        newQuestionsList.addEventListener('dragenter', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!draggedItem) return;
            
            const target = e.target.closest('.question-item');
            if (target && target !== draggedItem) {
                target.classList.add('drag-over');
            }
        });

        newQuestionsList.addEventListener('dragleave', function(e) {
            e.stopPropagation();
            if (!e.relatedTarget || !newQuestionsList.contains(e.relatedTarget)) {
                const allItems = newQuestionsList.querySelectorAll('.question-item');
                allItems.forEach(item => {
                    item.classList.remove('drag-over');
                });
            }
        });

        newQuestionsList.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!draggedItem) return;
            
            console.log('🎯 إفلات السؤال');
            
            const afterElement = getDragAfterElement(newQuestionsList, e.clientY);
            const dragEndIndex = afterElement ? 
                parseInt(afterElement.dataset.questionIndex) : 
                newQuestionsList.children.length - 1;
            
            // إزالة مؤشرات الإفلات
            const indicators = newQuestionsList.querySelectorAll('.drop-indicator');
            indicators.forEach(indicator => indicator.remove());
            
            // إزالة تأثيرات السحب
            const allItems = newQuestionsList.querySelectorAll('.question-item');
            allItems.forEach(item => {
                item.classList.remove('drag-over');
            });
            
            if (afterElement == null) {
                newQuestionsList.appendChild(draggedItem);
            } else {
                newQuestionsList.insertBefore(draggedItem, afterElement);
            }
            
            // تحديث ترتيب الأسئلة في البيانات
            updateQuestionsOrder(dragStartIndex, dragEndIndex);
            
            console.log('🔄 تم نقل السؤال من', dragStartIndex, 'إلى', dragEndIndex);
        });

        console.log('🎉 نظام السحب والإفلات جاهز للاستخدام');
        return true;
        
    } catch (error) {
        console.error('❌ فشل في تهيئة السحب والإفلات:', error);
        ErrorHandler.logError(error, 'initializeDragAndDrop');
        return false;
    }
}

// ========== النوافذ المنبثقة للأسئلة ==========
function showAddQuestionModal() {
    try {
        if (currentManagingTest === null) {
            alert('يرجى اختيار اختبار أولاً');
            return;
        }
        
        currentEditingQuestionIndex = null;
        
        const modal = document.getElementById('questionModal');
        const modalTitle = document.getElementById('questionModalTitle');
        const form = document.getElementById('questionModalForm');
        const errorDiv = document.getElementById('questionModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Question modal elements not found');
        }
        
        modalTitle.textContent = 'إضافة سؤال جديد';
        form.reset();
        errorDiv.classList.add('hidden');
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showAddQuestionModal');
    }
}

function editQuestion(questionIndex) {
    try {
        if (currentManagingTest === null) {
            alert('لا يوجد اختبار محدد');
            return;
        }
        
        currentEditingQuestionIndex = questionIndex;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) {
            alert('الاختبار غير موجود');
            return;
        }
        
        const test = school.tests[currentManagingTest];
        const question = test.questions[questionIndex];
        
        if (!question) {
            alert('السؤال غير موجود');
            return;
        }
        
        const modal = document.getElementById('questionModal');
        const modalTitle = document.getElementById('questionModalTitle');
        const form = document.getElementById('questionModalForm');
        const errorDiv = document.getElementById('questionModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Question modal elements not found');
        }
        
        modalTitle.textContent = 'تعديل السؤال';
        errorDiv.classList.add('hidden');
        
        // تعبئة بيانات السؤال
        document.getElementById('modalQuestionText').value = question.question || '';
        document.getElementById('modalOption1').value = question.options[0] || '';
        document.getElementById('modalOption2').value = question.options[1] || '';
        document.getElementById('modalOption3').value = question.options[2] || '';
        document.getElementById('modalOption4').value = question.options[3] || '';
        document.getElementById('modalCorrectAnswer').value = question.correct || '';
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'editQuestion');
    }
}

function closeQuestionModal() {
    try {
        const modal = document.getElementById('questionModal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        currentEditingQuestionIndex = null;
    } catch (error) {
        ErrorHandler.logError(error, 'closeQuestionModal');
    }
}

function handleQuestionFormSubmit(event) {
    try {
        event.preventDefault();
        
        if (currentManagingTest === null) {
            alert('يرجى اختيار اختبار أولاً');
            return false;
        }
        
        const questionText = DataValidator.sanitizeInput(document.getElementById('modalQuestionText').value);
        const option1 = DataValidator.sanitizeInput(document.getElementById('modalOption1').value);
        const option2 = DataValidator.sanitizeInput(document.getElementById('modalOption2').value);
        const option3 = DataValidator.sanitizeInput(document.getElementById('modalOption3').value);
        const option4 = DataValidator.sanitizeInput(document.getElementById('modalOption4').value);
        const correctAnswer = parseInt(document.getElementById('modalCorrectAnswer').value);
        
        const errorDiv = document.getElementById('questionModalError');
        if (!errorDiv) {
            throw new Error('Error div not found');
        }
        
        // التحقق من صحة البيانات
        if (!questionText || !option1 || !option2 || !option3 || !option4 || isNaN(correctAnswer)) {
            errorDiv.textContent = 'يرجى ملء جميع الحقول وتحديد الإجابة الصحيحة';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        if (correctAnswer < 0 || correctAnswer > 3) {
            errorDiv.textContent = 'الإجابة الصحيحة يجب أن تكون بين 0 و 3';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) {
            errorDiv.textContent = 'الاختبار غير موجود';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const test = school.tests[currentManagingTest];
        const newQuestion = {
            question: questionText,
            options: [option1, option2, option3, option4],
            correct: correctAnswer
        };
        
        if (currentEditingQuestionIndex === null) {
            // إضافة سؤال جديد
            test.questions.push(newQuestion);
        } else {
            // تعديل سؤال موجود
            test.questions[currentEditingQuestionIndex] = newQuestion;
        }
        
        // حفظ البيانات
        const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
        if (!success) {
            errorDiv.textContent = 'فشل في حفظ البيانات';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        closeQuestionModal();
        loadTestQuestions();
        
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'handleQuestionFormSubmit');
        return false;
    }
}

function deleteQuestion(questionIndex) {
    try {
        if (currentManagingTest === null) {
            alert('لا يوجد اختبار محدد');
            return;
        }
        
        if (!confirm('هل أنت متأكد من حذف هذا السؤال؟')) {
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (school && school.tests[currentManagingTest] && school.tests[currentManagingTest].questions[questionIndex]) {
            school.tests[currentManagingTest].questions.splice(questionIndex, 1);
            
            // حفظ البيانات
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            
            // إعادة تحميل الأسئلة
            loadTestQuestions();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'deleteQuestion');
    }
}

// ========== إعادة ترتيب الأسئلة بالسحب والإفلات ==========
function updateQuestionsOrder(oldIndex, newIndex) {
    try {
        if (currentManagingTest === null) {
            console.warn('❌ لا يوجد اختبار محدد لتحديث الترتيب');
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) {
            console.warn('❌ الاختبار غير موجود');
            return;
        }
        
        const questions = school.tests[currentManagingTest].questions;
        
        if (oldIndex === newIndex) {
            console.log('ℹ️ لم يتغير ترتيب الأسئلة');
            return;
        }
        
        // نقل السؤال من الموضع القديم إلى الموضع الجديد
        const [movedQuestion] = questions.splice(oldIndex, 1);
        questions.splice(newIndex, 0, movedQuestion);
        
        // حفظ التغييرات
        const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        if (success) {
            console.log('✅ تم تحديث ترتيب الأسئلة بنجاح');
            
            // تحديث الواجهة دون إعادة تحميل كامل
            updateQuestionsUI();
            
            showSuccessMessage('تم التحديث', 'تم إعادة ترتيب الأسئلة بنجاح');
        } else {
            console.error('❌ فشل في حفظ ترتيب الأسئلة');
            showErrorMessage('خطأ', 'فشل في حفظ الترتيب الجديد');
        }
        
    } catch (error) {
        ErrorHandler.logError(error, 'updateQuestionsOrder');
    }
}

// دالة جديدة لتحديث واجهة الأسئلة دون إعادة تحميل كامل
function updateQuestionsUI() {
    try {
        const questionsList = document.getElementById('questionsList');
        if (!questionsList) return;

        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) return;

        const test = school.tests[currentManagingTest];
        const questionItems = questionsList.querySelectorAll('.question-item');

        // تحديث أرقام الأسئلة في الواجهة
        questionItems.forEach((item, index) => {
            const questionNumber = item.querySelector('.bg-blue-500');
            if (questionNumber) {
                questionNumber.textContent = index + 1;
            }
            
            const questionTitle = item.querySelector('h5');
            if (questionTitle) {
                questionTitle.innerHTML = `<span class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">${index + 1}</span> السؤال ${index + 1}`;
            }

            // تحديث data-question-index
            item.dataset.questionIndex = index;
        });

        // إعادة تهيئة السحب والإفلات بعد تحديث الواجهة
        setTimeout(() => {
            initializeDragAndDrop();
        }, 100);
    } catch (error) {
        ErrorHandler.logError(error, 'updateQuestionsUI');
    }
}

// ========== دوال إعدادات المعلم ==========
function changePassword(event) {
    event.preventDefault();
    
    try {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;
        
        // التحقق من صحة البيانات
        if (!currentPassword || !newPassword || !confirmNewPassword) {
            showErrorMessage('خطأ', 'يرجى ملء جميع الحقول');
            return false;
        }
        
        if (newPassword !== confirmNewPassword) {
            showErrorMessage('خطأ', 'كلمة المرور الجديدة غير متطابقة');
            return false;
        }
        
        if (newPassword.length < 6) {
            showErrorMessage('خطأ', 'كلمة المرور يجب أن تكون 6 أحرف على الأقل');
            return false;
        }
        
        // التحقق من كلمة المرور الحالية
        if (currentUser.password !== currentPassword) {
            showErrorMessage('خطأ', 'كلمة المرور الحالية غير صحيحة');
            return false;
        }
        
        // تحديث كلمة المرور
        currentUser.password = newPassword;
        demoData.users[currentUser.email] = currentUser;
        
        // حفظ التغييرات
        const success = StorageManager.setItem('teacherAccounts', demoData.users);
        
        if (success) {
            showSuccessMessage('تم التغيير', 'تم تغيير كلمة المرور بنجاح');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        } else {
            showErrorMessage('خطأ', 'فشل في حفظ كلمة المرور الجديدة');
        }
        
        return success;
        
    } catch (error) {
        ErrorHandler.logError(error, 'changePassword');
        showErrorMessage('خطأ', 'حدث خطأ أثناء تغيير كلمة المرور');
        return false;
    }
}

function updateProfile(event) {
    event.preventDefault();
    
    try {
        const name = DataValidator.sanitizeInput(document.getElementById('profileName').value);
        const email = DataValidator.sanitizeInput(document.getElementById('profileEmail').value);
        const school = DataValidator.sanitizeInput(document.getElementById('profileSchool').value);
        const stage = document.getElementById('profileStage').value;
        
        // التحقق من صحة البيانات
        if (!name || !email || !school || !stage) {
            showErrorMessage('خطأ', 'يرجى ملء جميع الحقول المطلوبة');
            return false;
        }
        
        if (!DataValidator.validateEmail(email)) {
            showErrorMessage('خطأ', 'البريد الإلكتروني غير صحيح');
            return false;
        }
        
        // حفظ البيانات القديمة للتراجع إذا لزم الأمر
        const oldEmail = currentUser.email;
        const oldName = currentUser.name;
        
        // تحديث بيانات المستخدم
        currentUser.name = name;
        currentUser.email = email;
        currentUser.school = school;
        currentUser.stage = stage;
        
        // إذا تغير البريد الإلكتروني، نقل البيانات إلى المفتاح الجديد
        if (oldEmail !== email) {
            delete demoData.users[oldEmail];
        }
        
        demoData.users[email] = currentUser;
        
        // تحديث بيانات المدرسة المرتبطة
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === oldName) {
                demoData.schools[schoolId].name = school;
                demoData.schools[schoolId].teacher = name;
                break;
            }
        }
        
        // حفظ التغييرات
        const success1 = StorageManager.setItem('teacherAccounts', demoData.users);
        const success2 = StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        if (success1 && success2) {
            showSuccessMessage('تم الحفظ', 'تم تحديث الملف الشخصي بنجاح');
            
            // تحديث الواجهة
            const teacherWelcome = document.getElementById('teacherWelcome');
            if (teacherWelcome) {
                teacherWelcome.textContent = `مرحباً ${currentUser.name}`;
            }
        } else {
            showErrorMessage('خطأ', 'فشل في حفظ التغييرات');
            // التراجع عن التغييرات في الذاكرة
            currentUser.email = oldEmail;
            currentUser.name = oldName;
        }
        
        return success1 && success2;
        
    } catch (error) {
        ErrorHandler.logError(error, 'updateProfile');
        showErrorMessage('خطأ', 'حدث خطأ أثناء تحديث الملف الشخصي');
        return false;
    }
}

// ========== نظام السحب والإفلات معطل ==========
function initializeDragAndDrop() {
    console.log('🚫 نظام السحب والإفلات معطل تماماً ولا يعمل');
    return false;
}

function updateQuestionsOrder(oldIndex, newIndex) {
    console.log('🚫 نظام إعادة الترتيب معطل تماماً');
    return false;
}

function updateQuestionsUI() {
    console.log('🚫 نظام تحديث الواجهة معطل تماماً');
    return false;
}

// ========== دوال الشهادة ==========

function showCertificate() {
    try {
        document.getElementById('certificateScreen').classList.remove('hidden');
        
        // إنشاء معاينة أولية للشهادة
        updateCertificatePreview('');
    } catch (error) {
        ErrorHandler.logError(error, 'showCertificate');
    }
}

function closeCertificate() {
    try {
        document.getElementById('certificateScreen').classList.add('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'closeCertificate');
    }
}

// ========== دوال النتائج والتصدير ==========
function loadResultsForTeacher() {
    try {
        console.log('📊 جاري تحميل نتائج المعلم...');
        
        const results = getResultsSync();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        console.log(`👨‍🏫 عدد نتائج المعلم ${currentUser.name}:`, teacherResults.length);
        
        // تحديث خيارات الاختبارات للفلتر
        updateTestFilterOptions(teacherResults);
        
        // تحديث خيارات الفصول للفلتر
        updateClassFilterOptions(teacherResults);
        
        // تطبيق الفلاتر الحالية
        setTimeout(() => {
            if (typeof filterResults === 'function') {
                filterResults();
            }
        }, 100);
        
    } catch (error) {
        console.error('❌ خطأ في تحميل نتائج المعلم:', error);
        ErrorHandler.logError(error, 'loadResultsForTeacher');
    }
}

function updateTestFilterOptions(results) {
    try {
        const testSelect = document.getElementById('filterTestSelect');
        if (!testSelect) return;
        
        // الحصول على الاختبارات الفريدة
        const uniqueTests = [...new Set(results.map(r => r.test))].filter(Boolean);
        
        let optionsHTML = '<option value="">جميع الاختبارات</option>';
        uniqueTests.forEach(test => {
            optionsHTML += `<option value="${test}">${test}</option>`;
        });
        
        testSelect.innerHTML = optionsHTML;
    } catch (error) {
        console.error('Error updating test filter:', error);
    }
}

function updateClassFilterOptions(results) {
    try {
        const classSelect = document.getElementById('filterClassSelect');
        if (!classSelect) return;
        
        // الحصول على الفصول الفريدة
        const uniqueClasses = [...new Set(results.map(r => r.class))].filter(Boolean);
        
        let optionsHTML = '<option value="">جميع الفصول</option>';
        uniqueClasses.forEach(className => {
            optionsHTML += `<option value="${className}">${className}</option>`;
        });
        
        classSelect.innerHTML = optionsHTML;
    } catch (error) {
        console.error('Error updating class filter:', error);
    }
}

function toggleAdvancedFilters() {
    try {
        const advancedFilters = document.getElementById('advancedFilters');
        const toggleButton = document.getElementById('toggleFiltersBtn');
        
        if (advancedFilters && toggleButton) {
            if (advancedFilters.classList.contains('hidden')) {
                advancedFilters.classList.remove('hidden');
                toggleButton.textContent = 'إخفاء الفلاتر المتقدمة';
            } else {
                advancedFilters.classList.add('hidden');
                toggleButton.textContent = 'إظهار الفلاتر المتقدمة';
            }
        }
    } catch (error) {
        ErrorHandler.logError(error, 'toggleAdvancedFilters');
    }
}

// تحديث دالة filterResults لدعم التاريخ المخصص
// إصلاح دالة filterResults
function filterResults() {
    try {
        console.log('🔍 بدء تصفية النتائج...');
        
        const results = getResultsSync();
        console.log('📊 عدد النتائج قبل التصفية:', results.length);
        
        // إذا لم توجد نتائج، توقف هنا
        if (!results || results.length === 0) {
            if (typeof updateResultsTable !== 'undefined') {
                updateResultsTable([]);
            }
            return;
        }
        
        let filtered = [...results];
        
        // تصفية حسب اسم الطالب
        const searchName = document.getElementById('searchStudentName')?.value.toLowerCase() || '';
        if (searchName) {
            filtered = filtered.filter(result => 
                result.name && result.name.toLowerCase().includes(searchName)
            );
        }
        
        // تصفية حسب الاختبار
        const testFilter = document.getElementById('filterTestSelect')?.value || '';
        if (testFilter) {
            filtered = filtered.filter(result => result.test === testFilter);
        }
        
        // تصفية حسب الفصل
        const classFilter = document.getElementById('filterClassSelect')?.value || '';
        if (classFilter) {
            filtered = filtered.filter(result => result.class === classFilter);
        }
        
        // تصفية حسب التقدير
        const gradeFilter = document.getElementById('filterGradeSelect')?.value || '';
        if (gradeFilter) {
            filtered = filtered.filter(result => result.gradeLevel === gradeFilter);
        }
        
        // تصفية حسب النسبة المئوية
        const percentageFilter = document.getElementById('filterPercentageSelect')?.value || '';
        if (percentageFilter) {
            filtered = filtered.filter(result => {
                const percentage = result.percentage || Math.round((result.score / result.total) * 100);
                switch(percentageFilter) {
                    case '90-100': return percentage >= 90;
                    case '80-89': return percentage >= 80 && percentage < 90;
                    case '70-79': return percentage >= 70 && percentage < 80;
                    case '60-69': return percentage >= 60 && percentage < 70;
                    case '0-59': return percentage < 60;
                    default: return true;
                }
            });
        }
        
        // ترتيب النتائج
        const scoreFilter = document.getElementById('filterScoreSelect')?.value || '';
        if (scoreFilter === 'score-desc') {
            filtered.sort((a, b) => (b.percentage || 0) - (a.percentage || 0));
        } else if (scoreFilter === 'score-asc') {
            filtered.sort((a, b) => (a.percentage || 0) - (b.percentage || 0));
        }
        
        console.log('✅ عدد النتائج بعد التصفية:', filtered.length);
        
        // تحديث الجدول إذا كانت الدالة موجودة
        if (typeof updateResultsTable !== 'undefined') {
            updateResultsTable(filtered);
        }
        
        // تحديث الإحصائيات
        updateFilterStats(filtered);
        
    } catch (error) {
        console.error('❌ خطأ في تصفية النتائج:', error);
        ErrorHandler.logError(error, 'filterResults');
    }
}

function updateFilterStats(filteredResults) {
    try {
        if (!filteredResults || filteredResults.length === 0) {
            document.getElementById('filteredCount').textContent = '0';
            document.getElementById('filteredAverage').textContent = '0%';
            document.getElementById('filteredPassRate').textContent = '0%';
            document.getElementById('filteredHighest').textContent = '0%';
            return;
        }
        
        const total = filteredResults.length;
        const totalPercentage = filteredResults.reduce((sum, result) => 
            sum + (result.percentage || Math.round((result.score / result.total) * 100)), 0);
        const average = Math.round(totalPercentage / total);
        const passCount = filteredResults.filter(result => 
            (result.percentage || Math.round((result.score / result.total) * 100)) >= 60
        ).length;
        const passRate = Math.round((passCount / total) * 100);
        const highest = Math.max(...filteredResults.map(result => 
            result.percentage || Math.round((result.score / result.total) * 100)
        ));
        
        document.getElementById('filteredCount').textContent = total;
        document.getElementById('filteredAverage').textContent = average + '%';
        document.getElementById('filteredPassRate').textContent = passRate + '%';
        document.getElementById('filteredHighest').textContent = highest + '%';
        
    } catch (error) {
        console.error('Error updating filter stats:', error);
    }
}

// ========== إصلاح فلتر التاريخ المحدد ==========

function initializeDateFilter() {
    try {
        const dateFilterSelect = document.getElementById('filterDateSelect');
        const customDateFilter = document.getElementById('customDateFilter');
        
        if (!dateFilterSelect || !customDateFilter) {
            console.warn('عناصر فلتر التاريخ غير موجودة');
            return;
        }
        
        // إضافة مستمع حدث لتغيير فلتر التاريخ
        dateFilterSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateFilter.classList.remove('hidden');
            } else {
                customDateFilter.classList.add('hidden');
                // تفعيل الفلترة تلقائياً عند اختيار خيار غير مخصص
                filterResults();
            }
        });
        
        // إضافة مستمعات أحداث لحقلي التاريخ
        const dateFrom = document.getElementById('filterDateFrom');
        const dateTo = document.getElementById('filterDateTo');
        
        if (dateFrom && dateTo) {
            dateFrom.addEventListener('change', filterResults);
            dateTo.addEventListener('change', filterResults);
        }
        
        console.log('✅ تم تهيئة فلتر التاريخ بنجاح');
    } catch (error) {
        ErrorHandler.logError(error, 'initializeDateFilter');
    }
}

function displayFilteredResults(results) {
    try {
        const tableBody = document.getElementById('resultsTableBody');
        if (!tableBody) return;
        
        if (results.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                        <div class="text-4xl mb-2">📊</div>
                        <p>لا توجد نتائج مطابقة للبحث</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        let tableHTML = '';
        
        // إضافة مؤشر الترتيب إذا كان مفعلاً
        const filterScore = document.getElementById('filterScoreSelect')?.value || '';
        if (filterScore) {
            const orderText = filterScore === 'score-desc' ? '🔺 مرتبة من الأعلى درجة' : '🔻 مرتبة من الأقل درجة';
            tableHTML += `<div class="text-sm text-blue-600 mb-2 p-2 bg-blue-50 rounded-lg text-center">${orderText}</div>`;
        }
        
        results.forEach(result => {
            tableHTML += `
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-all">
                    <td class="px-6 py-4 text-right">${result.name}</td>
                    <td class="px-6 py-4 text-right">${result.grade} - ${result.class}</td>
                    <td class="px-6 py-4 text-right">${result.test}</td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-bold ${result.percentage >= 60 ? 'text-green-600' : 'text-red-600'}">
                            ${result.score}/${result.total}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-bold ${result.percentage >= 60 ? 'text-green-600' : 'text-red-600'}">
                            ${result.percentage}%
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="px-2 py-1 rounded-full text-sm ${getGradeColor(result.gradeLevel)}">
                            ${result.gradeLevel}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">${result.date}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex gap-2 justify-end">
                            <button onclick="viewResultDetails(${result.id})" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                تفاصيل
                            </button>
                            <button onclick="deleteStudentResult(${result.id})" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"></path>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                    <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                حذف
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = tableHTML;
    } catch (error) {
        ErrorHandler.logError(error, 'displayFilteredResults');
    }
}

function getGradeColor(grade) {
    switch (grade) {
        case 'ممتاز': return 'bg-green-100 text-green-800';
        case 'جيد جداً': return 'bg-blue-100 text-blue-800';
        case 'جيد': return 'bg-yellow-100 text-yellow-800';
        case 'مقبول': return 'bg-orange-100 text-orange-800';
        case 'ضعيف': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function updateFilterStats(results) {
    try {
        const stats = {
            count: results.length,
            average: 0,
            passRate: 0,
            highest: 0
        };
        
        if (results.length > 0) {
            stats.average = Math.round(results.reduce((sum, r) => sum + r.percentage, 0) / results.length);
            stats.passRate = Math.round((results.filter(r => r.percentage >= 60).length / results.length) * 100);
            stats.highest = Math.max(...results.map(r => r.percentage));
        }
        
        const elements = {
            filteredCount: document.getElementById('filteredCount'),
            filteredAverage: document.getElementById('filteredAverage'),
            filteredPassRate: document.getElementById('filteredPassRate'),
            filteredHighest: document.getElementById('filteredHighest')
        };
        
        if (elements.filteredCount) elements.filteredCount.textContent = stats.count;
        if (elements.filteredAverage) elements.filteredAverage.textContent = stats.average + '%';
        if (elements.filteredPassRate) elements.filteredPassRate.textContent = stats.passRate + '%';
        if (elements.filteredHighest) elements.filteredHighest.textContent = stats.highest + '%';
    } catch (error) {
        ErrorHandler.logError(error, 'updateFilterStats');
    }
}

// تحديث دالة clearAllFilters لتضمين حقول التاريخ
function clearAllFilters() {
    try {
        const filterElements = [
            'searchStudentName',
            'filterTestSelect',
            'filterClassSelect',
            'filterGradeSelect',
            'filterPercentageSelect',
            'filterDateSelect',
            'filterScoreSelect',
            'filterDateFrom',
            'filterDateTo'
        ];
        
        filterElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.value = '';
            }
        });
        
        // إخفاء الفلاتر المتقدمة وحقل التاريخ المخصص
        const advancedFilters = document.getElementById('advancedFilters');
        const customDateFilter = document.getElementById('customDateFilter');
        const toggleButton = document.getElementById('toggleFiltersBtn');
        
        if (advancedFilters) advancedFilters.classList.add('hidden');
        if (customDateFilter) customDateFilter.classList.add('hidden');
        if (toggleButton) toggleButton.textContent = 'إظهار الفلاتر المتقدمة';
        
        // إعادة تطبيق الفلاتر
        filterResults();
    } catch (error) {
        ErrorHandler.logError(error, 'clearAllFilters');
    }
}

function viewResultDetails(resultId) {
    try {
        const results = loadResults();
        const result = results.find(r => r.id === resultId);
        
        if (!result) {
            alert('النتيجة غير موجودة');
            return;
        }
        
        const modalId = 'resultDetailsModal_' + resultId;
        
        // إذا كانت النافذة مفتوحة مسبقاً، أزلْها أولاً
        const existingModal = document.getElementById(modalId);
        if (existingModal) {
            existingModal.remove();
        }
        
        let detailsHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 result-details-modal">
                <div class="bg-white rounded-3xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center sticky top-0 z-10">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold">تفاصيل النتيجة</h2>
                            <button onclick="closeResultDetails('${modalId}')" class="text-white hover:text-gray-200 text-2xl font-bold transition-all">
                                ✕
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-xl">
                                <div class="text-blue-600 font-semibold">اسم الطالب</div>
                                <div class="font-bold text-lg">${result.name}</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl">
                                <div class="text-green-600 font-semibold">الصف/الفصل</div>
                                <div class="font-bold text-lg">${result.grade} - ${result.class}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-xl mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">تفاصيل الاختبار</h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <span class="text-gray-600">الاختبار:</span>
                                    <span class="font-bold">${result.test}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">المادة:</span>
                                    <span class="font-bold">${result.subject}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">الدرجة:</span>
                                    <span class="font-bold">${result.score}/${result.total}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">النسبة:</span>
                                    <span class="font-bold ${result.percentage >= 60 ? 'text-green-600' : 'text-red-600'}">${result.percentage}%</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">التقدير:</span>
                                    <span class="font-bold ${getGradeColorClass(result.gradeLevel)}">${result.gradeLevel}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">التاريخ:</span>
                                    <span class="font-bold">${result.date}</span>
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="font-bold text-gray-800 mb-4">تفاصيل الإجابات (${result.answers.length} سؤال)</h3>
                        <div class="space-y-4 max-h-96 overflow-y-auto p-2">
        `;
        
        result.answers.forEach((answer, index) => {
            const questionNumber = index + 1;
            const isCorrect = answer.isCorrect;
            const selectedOption = answer.selected !== -1 ? `الخيار ${answer.selected + 1}` : 'لم يتم الإجابة';
            const correctOption = `الخيار ${answer.correct + 1}`;
            
            detailsHTML += `
                <div class="border border-gray-200 rounded-xl p-4 ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} transition-all hover:shadow-md">
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold text-lg flex items-center gap-2">
                            <span class="w-6 h-6 ${isCorrect ? 'bg-green-500' : 'bg-red-500'} text-white rounded-full flex items-center justify-center text-sm">${questionNumber}</span>
                            السؤال ${questionNumber}
                        </span>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${isCorrect ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                            ${isCorrect ? '✓ صحيح' : '✗ خاطئ'}
                        </span>
                    </div>
                    <div class="grid md:grid-cols-2 gap-3 text-sm">
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="text-gray-600 font-semibold mb-1">الإجابة المختارة:</div>
                            <div class="font-bold ${isCorrect ? 'text-green-600' : 'text-red-600'}">${selectedOption}</div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="text-gray-600 font-semibold mb-1">الإجابة الصحيحة:</div>
                            <div class="font-bold text-green-600">${correctOption}</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        detailsHTML += `
                        </div>
                        <div class="text-center mt-8 pt-6 border-t border-gray-200">
                            <button onclick="closeResultDetails('${modalId}')" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-3 rounded-xl font-semibold transition-all shadow-lg">
                                إغلاق التفاصيل
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailsHTML);
        
        // إضافة مستمع حدث لإغلاق النافذة عند النقر خارجها
        const modal = document.getElementById(modalId);
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeResultDetails(modalId);
            }
        });
        
        // إضافة مستمع حدث للزر ESC
        const closeOnEscape = function(e) {
            if (e.key === 'Escape') {
                closeResultDetails(modalId);
                document.removeEventListener('keydown', closeOnEscape);
            }
        };
        document.addEventListener('keydown', closeOnEscape);
        
    } catch (error) {
        ErrorHandler.logError(error, 'viewResultDetails');
    }
}

// دالة مساعدة للحصول على لون التقدير
function getGradeColorClass(grade) {
    switch (grade) {
        case 'ممتاز': return 'text-green-600';
        case 'جيد جداً': return 'text-blue-600';
        case 'جيد': return 'text-yellow-600';
        case 'مقبول': return 'text-orange-600';
        case 'ضعيف': return 'text-red-600';
        default: return 'text-gray-600';
    }
}

// دالة إغلاق التفاصيل
function closeResultDetails(modalId) {
    try {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                modal.remove();
            }, 300);
        }
    } catch (error) {
        ErrorHandler.logError(error, 'closeResultDetails');
    }
}

// إضافة تأثير الخروج في CSS
const modalStyles = `
@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

.result-details-modal > div {
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from { 
        opacity: 0;
        transform: translateY(20px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}
`;

// إضافة الأنماط إذا لم تكن موجودة
if (!document.getElementById('modalStyles')) {
    const styleSheet = document.createElement("style");
    styleSheet.id = 'modalStyles';
    styleSheet.textContent = modalStyles;
    document.head.appendChild(styleSheet);
}

// دالة حذف نتيجة طالب
function deleteStudentResult(resultId) {
    try {
        if (!confirm('⚠️ هل أنت متأكد من رغبتك في حذف هذه النتيجة؟\n\nهذا الإجراء لا يمكن التراجع عنه.')) {
            return;
        }
        
        const results = loadResults();
        const resultIndex = results.findIndex(r => r.id === resultId);
        
        if (resultIndex === -1) {
            alert('النتيجة غير موجودة');
            return;
        }
        
        const deletedResult = results[resultIndex];
        
        // حذف النتيجة من المصفوفة
        results.splice(resultIndex, 1);
        
        // حفظ البيانات المحدثة
        const success = StorageManager.setItem('testResults', results);
        
        if (success) {
            showSuccessMessage('تم الحذف', `تم حذف نتيجة الطالب ${deletedResult.name} بنجاح`);
            
            // إعادة تحميل النتائج
            loadResultsForTeacher();
        } else {
            alert('فشل في حذف النتيجة');
        }
    } catch (error) {
        ErrorHandler.logError(error, 'deleteStudentResult');
        alert('حدث خطأ أثناء حذف النتيجة');
    }
}

// ========== دوال التصدير ==========

function exportResults() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        if (teacherResults.length === 0) {
            alert('لا توجد نتائج للتصدير');
            return;
        }
        
        let csvContent = 'data:text/csv;charset=utf-8,\uFEFF';
        csvContent += 'اسم الطالب,الصف,الفصل,الاختبار,المادة,الدرجة,الإجمالي,النسبة,التقدير,التاريخ\n';
        
        teacherResults.forEach(result => {
            const row = [
                result.name,
                result.grade,
                result.class,
                result.test,
                result.subject,
                result.score,
                result.total,
                result.percentage + '%',
                result.gradeLevel,
                result.date
            ].map(field => `"${field}"`).join(',');
            
            csvContent += row + '\n';
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `نتائج_الطلاب_${new Date().toLocaleDateString('ar-SA')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        ErrorHandler.logError(error, 'exportResults');
    }
}

function exportToExcel() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        if (teacherResults.length === 0) {
            alert('لا توجد نتائج للتصدير');
            return;
        }
        
        // إنشاء ورقة عمل
        const ws = XLSX.utils.json_to_sheet(teacherResults.map(result => ({
            'اسم الطالب': result.name,
            'الصف': result.grade,
            'الفصل': result.class,
            'الاختبار': result.test,
            'المادة': result.subject,
            'الدرجة': result.score,
            'الإجمالي': result.total,
            'النسبة': result.percentage + '%',
            'التقدير': result.gradeLevel,
            'التاريخ': result.date
        })));
        
        // إنشاء مصنف وإضافة الورقة
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'نتائج الطلاب');
        
        // تصدير الملف
        XLSX.writeFile(wb, `نتائج_الطلاب_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
    } catch (error) {
        ErrorHandler.logError(error, 'exportToExcel');
    }
}

function exportFilteredToExcel() {
    try {
        const searchName = document.getElementById('searchStudentName')?.value.toLowerCase() || '';
        const filterTest = document.getElementById('filterTestSelect')?.value || '';
        const filterClass = document.getElementById('filterClassSelect')?.value || '';
        
        const results = loadResults();
        let filteredResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // تطبيق نفس فلاتر العرض
        if (searchName) {
            filteredResults = filteredResults.filter(result => 
                result.name.toLowerCase().includes(searchName)
            );
        }
        
        if (filterTest) {
            filteredResults = filteredResults.filter(result => 
                result.test === filterTest
            );
        }
        
        if (filterClass) {
            filteredResults = filteredResults.filter(result => 
                result.class === filterClass
            );
        }
        
        if (filteredResults.length === 0) {
            alert('لا توجد نتائج مطابقة للفلاتر للتصدير');
            return;
        }
        
        // إنشاء ورقة عمل
        const ws = XLSX.utils.json_to_sheet(filteredResults.map(result => ({
            'اسم الطالب': result.name,
            'الصف': result.grade,
            'الفصل': result.class,
            'الاختبار': result.test,
            'المادة': result.subject,
            'الدرجة': result.score,
            'الإجمالي': result.total,
            'النسبة': result.percentage + '%',
            'التقدير': result.gradeLevel,
            'التاريخ': result.date
        })));
        
        // إنشاء مصنف وإضافة الورقة
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'نتائج مفلترة');
        
        // تصدير الملف
        XLSX.writeFile(wb, `نتائج_مفلترة_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
    } catch (error) {
        ErrorHandler.logError(error, 'exportFilteredToExcel');
    }
}

// ========== دوال الإعدادات ==========

function loadTeacherSettings() {
    try {
        if (!currentUser) return;
        
        // تحميل بيانات الملف الشخصي
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profileSchool = document.getElementById('profileSchool');
        const profileStage = document.getElementById('profileStage');
        
        if (profileName) profileName.value = currentUser.name || '';
        if (profileEmail) profileEmail.value = currentUser.email || '';
        if (profileSchool) profileSchool.value = currentUser.school || '';
        if (profileStage) profileStage.value = currentUser.stage || '';
        
        // إزالة الاستدعاء لعنصر profileGrade غير الموجود
        // updateGradeOptions(currentUser.stage, 'profileGrade');
        
        // تحميل إعدادات النظام
        const systemSettings = StorageManager.getItem('systemSettings') || {};
        
        // تحديث إحصائيات التخزين
        updateStorageStats();
    } catch (error) {
        ErrorHandler.logError(error, 'loadTeacherSettings');
    }
}

function saveProfileSettings(event) {
    try {
        event.preventDefault();
        
        const name = DataValidator.sanitizeInput(document.getElementById('profileName').value);
        const email = DataValidator.sanitizeInput(document.getElementById('profileEmail').value);
        const school = DataValidator.sanitizeInput(document.getElementById('profileSchool').value);
        const stage = document.getElementById('profileStage').value;
        
        const errorDiv = document.getElementById('profileError');
        const successDiv = document.getElementById('profileSuccess');
        
        if (!errorDiv || !successDiv) {
            throw new Error('Profile message elements not found');
        }
        
        // إخفاء الرسائل السابقة
        errorDiv.classList.add('hidden');
        successDiv.classList.add('hidden');
        
        // التحقق من صحة البيانات
        if (!name || !email || !school || !stage) {
            errorDiv.textContent = 'يرجى ملء جميع الحقول المطلوبة';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        if (!DataValidator.validateEmail(email)) {
            errorDiv.textContent = 'البريد الإلكتروني غير صحيح';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        // تحديث بيانات المستخدم
        currentUser.name = name;
        currentUser.email = email;
        currentUser.school = school;
        currentUser.stage = stage;
        
        // تحديث بيانات المدرسة المرتبطة
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === currentUser.name) {
                demoData.schools[schoolId].name = school;
                break;
            }
        }
        
        // حفظ التحديثات
        const success = StorageManager.setItem('teacherAccounts', demoData.users);
        StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        if (!success) {
            errorDiv.textContent = 'فشل في حفظ البيانات';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        successDiv.textContent = 'تم حفظ التغييرات بنجاح';
        successDiv.classList.remove('hidden');
        
        // تحديث الواجهة
        const teacherWelcome = document.getElementById('teacherWelcome');
        if (teacherWelcome) {
            teacherWelcome.textContent = `مرحباً ${currentUser.name}`;
        }
        
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'saveProfileSettings');
        return false;
    }
}

function saveSystemSettings(event) {
    try {
        event.preventDefault();
        
        const autoSave = document.getElementById('autoSave').checked;
        const notifications = document.getElementById('notifications').checked;
        const darkMode = document.getElementById('darkMode').checked;
        
        const systemSettings = {
            autoSave: autoSave,
            notifications: notifications,
            darkMode: darkMode
        };
        
        const success = StorageManager.setItem('systemSettings', systemSettings);
        
        const messageDiv = document.getElementById('systemMessage');
        if (messageDiv) {
            messageDiv.textContent = success ? 'تم حفظ الإعدادات بنجاح' : 'فشل في حفظ الإعدادات';
            messageDiv.className = success ? 
                'bg-green-100 text-green-700 p-3 rounded-lg text-center' : 
                'bg-red-100 text-red-700 p-3 rounded-lg text-center';
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000);
        }
        
        return success;
    } catch (error) {
        ErrorHandler.logError(error, 'saveSystemSettings');
        return false;
    }
}

function updateStorageStats() {
    try {
        const storageInfo = StorageManager.getStorageInfo();
        
        const elements = {
            totalStorage: document.getElementById('totalStorage'),
            itemsCount: document.getElementById('itemsCount'),
            largestItem: document.getElementById('largestItem')
        };
        
        if (elements.totalStorage) {
            elements.totalStorage.textContent = storageInfo.totalSize.toFixed(2) + ' MB';
        }
        
        if (elements.itemsCount) {
            elements.itemsCount.textContent = storageInfo.itemCount;
        }
        
        if (elements.largestItem && storageInfo.items.length > 0) {
            const largest = storageInfo.items[0];
            elements.largestItem.textContent = `${largest.key} (${largest.size.toFixed(2)} KB)`;
        }
    } catch (error) {
        ErrorHandler.logError(error, 'updateStorageStats');
    }
}

function clearAllData() {
    try {
        if (!confirm('⚠️ تحذير: هذا الإجراء سيحذف جميع البيانات!\n\nسيتم حذف:\n• جميع النتائج المحفوظة\n• جميع الاختبارات\n• جميع حسابات المعلمين\n• جميع الإعدادات\n\nهل أنت متأكد من المتابعة؟')) {
            return;
        }
        
        if (!confirm('❌ هذا الإجراء لا يمكن التراجع عنه!\n\nاكتب "نعم" للتأكيد:')) {
            return;
        }
        
        // مسح جميع البيانات
        localStorage.clear();
        
        // إعادة تعيين المتغيرات
        demoData.schools = {};
        demoData.users = {
            'chartgain2019@gmail.com': {
                email: 'chartgain2019@gmail.com',
                password: '123456',
                name: 'أ. عبدالله الشهري',
                school: 'مدرسة الوليد بن عمارة الابتدائية',
                stage: 'ابتدائية'
            }
        };
        
        currentUser = null;
        
        // إعادة تحميل الصفحة
        location.reload();
    } catch (error) {
        ErrorHandler.logError(error, 'clearAllData');
    }
}

function clearResultsOnly() {
    try {
        if (!confirm('⚠️ هل أنت متأكد من حذف جميع النتائج؟\n\nهذا الإجراء لا يمكن التراجع عنه.')) {
            return;
        }
        
        // مسح النتائج فقط
        localStorage.removeItem('testResults');
        
        showSuccessMessage('تم المسح', 'تم حذف جميع النتائج بنجاح');
        
        // تحديث الإحصائيات
        updateStorageStats();
        loadResultsForTeacher();
        loadDashboardData();
    } catch (error) {
        ErrorHandler.logError(error, 'clearResultsOnly');
    }
}

// ========== دوال إضافية ==========
function updateWelcomeStatistics() {
    try {
        const results = getResultsSync(); // استخدام الدالة المتزامنة
        
        // حساب الإحصائيات
        const totalSchools = Object.keys(demoData.schools).length;
        const totalTeachers = Object.keys(demoData.users).length;
        const totalTests = Object.values(demoData.schools).reduce((sum, school) => 
            sum + (school.tests ? school.tests.length : 0), 0
        );
        const totalResults = results.length;
        
        // تحديث العناصر
        const elements = {
            statsSchools: document.getElementById('statsSchools'),
            statsTeachers: document.getElementById('statsTeachers'),
            statsTests: document.getElementById('statsTests'),
            statsResults: document.getElementById('statsResults')
        };
        
        if (elements.statsSchools) elements.statsSchools.textContent = totalSchools;
        if (elements.statsTeachers) elements.statsTeachers.textContent = totalTeachers;
        if (elements.statsTests) elements.statsTests.textContent = totalTests;
        if (elements.statsResults) elements.statsResults.textContent = totalResults;
        
    } catch (error) {
        ErrorHandler.logError(error, 'updateWelcomeStatistics');
    }
}

// دالة لتحميل المدارس للمعلمين المسجلين مسبقاً
function loadSchoolsForExistingTeachers() {
    try {
        console.log('بدء تحميل المدارس للمعلمين الحاليين...');
        
        // إضافة مدارس لجميع المعلمين المسجلين
        for (const email in demoData.users) {
            const teacher = demoData.users[email];
            let teacherHasSchool = false;
            
            // التحقق إذا كان للمعلم مدرسة مسجلة
            for (const schoolId in demoData.schools) {
                if (demoData.schools[schoolId].teacher === teacher.name) {
                    teacherHasSchool = true;
                    console.log('المعلم لديه مدرسة مسجلة:', teacher.name);
                    break;
                }
            }
            
            // إذا لم يكن للمعلم مدرسة، قم بإنشاء واحدة
            if (!teacherHasSchool && teacher.school) {
                const newSchoolId = 'school_' + Date.now() + '_' + email;
                demoData.schools[newSchoolId] = {
                    id: newSchoolId,
                    name: teacher.school,
                    teacher: teacher.name,
                    tests: []
                };
                
                console.log('تم إنشاء مدرسة جديدة للمعلم:', teacher.name, '- المدرسة:', teacher.school);
            }
        }
        
        // حفظ التحديثات في التخزين المحلي
        if (Object.keys(demoData.schools).length > 0) {
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            console.log('تم حفظ بيانات المدارس:', Object.keys(demoData.schools).length, 'مدرسة');
        }
    } catch (error) {
        ErrorHandler.logError(error, 'loadSchoolsForExistingTeachers');
    }
}
// ========== التهيئة الأولية للنظام ==========
// تهيئة النظام مع دعم الخادم البعيد
// تهيئة النظام مع دعم الخادم البعيد المحسن
// تهيئة النظام مع معالجة محسنة للخادم البعيد
// تهيئة النظام المحدثة مع دعم الخادم البعيد
async function initializeSystem() {
    try {
        showLoadingMessage('جاري تهيئة النظام المحدث...');
        
        // تنظيف البيانات التالفة
        cleanupCorruptedData();
        
        // تحميل البيانات الأساسية أولاً من التخزين المحلي (للسرعة)
        const storedTeachers = StorageManager.getItem('teacherAccounts');
        const storedSchools = StorageManager.getItem('demoSchoolsData');
        const storedResults = StorageManager.getItem('testResults');
        
        if (storedTeachers) Object.assign(demoData.users, storedTeachers);
        if (storedSchools) Object.assign(demoData.schools, storedSchools);
        
        console.log('✅ تم التحميل المبدئي من التخزين المحلي');
        
        // ثم محاولة مزامنة مع الخادم البعيد (في الخلفية)
        setTimeout(async () => {
            try {
                console.log('🔄 محاولة المزامنة مع الخادم البعيد المحدث...');
                await RemoteAPI.checkEndpoints();
                
                if (RemoteAPI.isAvailable) {
                    console.log('✅ الخادم البعيد متوفر، جاري مزامنة البيانات...');
                    
                    // تحميل البيانات من الخادم
                    const [remoteTeachers, remoteSchools, remoteResults] = await Promise.all([
                        RemoteAPI.getTeachers(),
                        RemoteAPI.getSchools(),
                        RemoteAPI.getResults()
                    ]);
                    
                    // دمج البيانات مع المحلية
                    if (remoteTeachers && Object.keys(remoteTeachers).length > 0) {
                        Object.assign(demoData.users, remoteTeachers);
                        StorageManager.setItem('teacherAccounts', demoData.users);
                    }
                    
                    if (remoteSchools && remoteSchools.length > 0) {
                        // تحويل مصفوفة المدارس إلى كائن
                        const schoolsObj = {};
                        remoteSchools.forEach(school => {
                            schoolsObj[school.id] = school;
                        });
                        Object.assign(demoData.schools, schoolsObj);
                        StorageManager.setItem('demoSchoolsData', demoData.schools);
                    }
                    
                    if (remoteResults && remoteResults.length > 0) {
                        StorageManager.setItem('testResults', remoteResults);
                    }
                    
                    console.log('✅ اكتملت مزامنة البيانات مع الخادم البعيد');
                } else {
                    console.log('💡 الخادم البعيد غير متوفر، استخدام البيانات المحلية');
                }
                
            } catch (syncError) {
                console.log('💡 المزامنة مع الخادم البعيد غير متاحة، استخدام البيانات المحلية');
                RemoteAPI.isAvailable = false;
            }
            
            // عرض حالة الخادم بعد المحاولة
            showServerStatus();
        }, 1000);
        
        // تحميل المدارس للمعلمين الحاليين
        loadSchoolsForExistingTeachers();
        
        // إعداد نظام الاسترجاع
        SystemRecovery.initialize();
        
        // تحديث الإحصائيات
        updateWelcomeStatistics();
        
        hideLoadingMessage();
        
        // عرض حالة أولية للخادم
        showServerStatus();
        
        console.log('✅ تم تهيئة النظام المحدث بنجاح - جاهز للاستخدام');
        
    } catch (error) {
        hideLoadingMessage();
        ErrorHandler.logError(error, 'initializeSystem');
        showErrorMessage('خطأ في التهيئة', 'تعذر تهيئة النظام بالكامل');
        
        // عرض حالة الخادم حتى في حالة الخطأ
        showServerStatus();
    }
}

// ========== معالجة الأخطاء العالمية ==========

// تجاهل أخطاء إضافات المتصفح الخارجية
window.addEventListener('error', function(e) {
    if (e.message && (
        e.message.includes('hotkeys') || 
        e.message.includes('chext') ||
        e.filename.includes('chext')
    )) {
        e.preventDefault();
        console.log('ℹ️ خطأ من إضافة متصفح خارجية - تم تجاهله');
        return true;
    }
});

// معالجة وعود مرفوضة غير معالجة
window.addEventListener('unhandledrejection', function(e) {
    if (e.reason && e.reason.message && (
        e.reason.message.includes('hotkeys') ||
        e.reason.message.includes('chext')
    )) {
        e.preventDefault();
        console.log('ℹ️ وعد مرفوض من إضافة متصفح - تم تجاهله');
        return true;
    }
});

// عرض حالة النظام النهائية
// عرض حالة النظام النهائية
function showFinalSystemStatus() {
    const teachersCount = Object.keys(demoData.users).length;
    const schoolsCount = Object.keys(demoData.schools).length;
    const resultsCount = getResultsSync().length; // استخدام الدالة المتزامنة
    
    console.log('📋 حالة النظام النهائية:');
    console.log(`   👨‍🏫 المعلمين: ${teachersCount}`);
    console.log(`   🏫 المدارس: ${schoolsCount}`);
    console.log(`   📊 النتائج: ${resultsCount}`);
    console.log(`   🌐 الخادم البعيد: ${RemoteAPI.isAvailable ? '🟢 متصل' : '🔴 غير متصل'}`);
    
    if (!RemoteAPI.isAvailable) {
        console.log('💡 المعلومة: النظام يعمل بشكل كامل في الوضع المحلي');
        console.log('💡 جميع بياناتك محفوظة بأمان على جهازك');
    }
}

// عرض رسالة ترحيبية
function showWelcomeMessage() {
    console.log('👋 مرحباً بك في نظام الاختبارات التفاعلي!');
    console.log('📚 النظام جاهز لاستخدامك');
}

function setupEventListeners() {
    try {
        // إعداد مستمعي الأحداث الأساسية
        ResourceManager.addEventListener(document.getElementById('schoolSearch'), 'input', searchSchools);
        
        // إعداد مستمعي الأحداث للفلترة
        const filterElements = [
            'searchStudentName',
            'filterTestSelect', 
            'filterClassSelect',
            'filterGradeSelect',
            'filterPercentageSelect',
            'filterDateSelect',
            'filterDateFrom',
            'filterDateTo'
        ];
        
        filterElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                ResourceManager.addEventListener(element, 'change', filterResults);
            }
        });
        
        // إعداد مستمعي الأحداث للبحث
        const searchInput = document.getElementById('searchStudentName');
        if (searchInput) {
            ResourceManager.addEventListener(searchInput, 'input', filterResults);
        }
        
        console.log('✅ تم إعداد مستمعي الأحداث بنجاح');
    } catch (error) {
        ErrorHandler.logError(error, 'setupEventListeners');
    }
}

// ========== دوال التصحيح والإدارة ==========

function showSystemInfo() {
    try {
        const storageInfo = StorageManager.getStorageInfo();
        const errorLogs = StorageManager.getItem('errorLogs') || [];
        
        let infoHTML = `
            <div class="bg-white rounded-3xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 text-center sticky top-0">
                    <h2 class="text-2xl font-bold">معلومات النظام والتصحيح</h2>
                </div>
                <div class="p-6">
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <h3 class="font-bold text-blue-800 mb-2">💾 معلومات التخزين</h3>
                            <div class="space-y-1 text-sm">
                                <div>الحجم الإجمالي: <strong>${storageInfo.totalSize.toFixed(2)} MB</strong></div>
                                <div>عدد العناصر: <strong>${storageInfo.itemCount}</strong></div>
                                <div>المدارس: <strong>${Object.keys(demoData.schools).length}</strong></div>
                                <div>المعلمون: <strong>${Object.keys(demoData.users).length}</strong></div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 p-4 rounded-xl">
                            <h3 class="font-bold text-green-800 mb-2">📊 الإحصائيات</h3>
                            <div class="space-y-1 text-sm">
                                <div>النتائج المحفوظة: <strong>${loadResults().length}</strong></div>
                                <div>الجلسات النشطة: <strong>${ResourceManager.activeSessions.size}</strong></div>
                                <div>الأخطاء المسجلة: <strong>${errorLogs.length}</strong></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-xl mb-6">
                        <h3 class="font-bold text-yellow-800 mb-3">⚠️ سجل الأخطاء (آخر 5)</h3>
                        <div class="space-y-2 max-h-60 overflow-y-auto">
        `;
        
        const recentErrors = errorLogs.slice(-5).reverse();
        if (recentErrors.length === 0) {
            infoHTML += '<p class="text-gray-600 text-center">لا توجد أخطاء مسجلة</p>';
        } else {
            recentErrors.forEach(log => {
                infoHTML += `
                    <div class="bg-white p-3 rounded-lg border border-yellow-200">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-red-600">${log.context}</span>
                            <span class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleString('ar-SA')}</span>
                        </div>
                        <div class="text-sm text-gray-700">${log.error.message}</div>
                    </div>
                `;
            });
        }
        
        infoHTML += `
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-xl mb-6">
                        <h3 class="font-bold text-gray-800 mb-3">🔧 أدوات النظام</h3>
                        <div class="grid md:grid-cols-2 gap-3">
                            <button onclick="clearResultsOnly()" class="bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg text-sm font-semibold transition-all">
                                🗑️ مسح النتائج فقط
                            </button>
                            <button onclick="clearAllData()" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm font-semibold transition-all">
                                💥 مسح كل البيانات
                            </button>
                            <button onclick="location.reload()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-semibold transition-all">
                                🔄 إعادة تحميل
                            </button>
                            <button onclick="testSystemFunctions()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg text-sm font-semibold transition-all">
                                🧪 اختبار النظام
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                            إغلاق
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const modalDiv = document.createElement('div');
        modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
        modalDiv.innerHTML = infoHTML;
        
        document.body.appendChild(modalDiv);
    } catch (error) {
        ErrorHandler.logError(error, 'showSystemInfo');
    }
}

function testSystemFunctions() {
    try {
        console.log('🧪 بدء اختبار وظائف النظام...');
        
        const tests = {
            storage: StorageManager.isStorageAvailable(),
            json: (() => {
                try {
                    JSON.parse('{"test": true}');
                    JSON.stringify({test: true});
                    return true;
                } catch {
                    return false;
                }
            })(),
            dom: (() => {
                try {
                    document.createElement('div');
                    return true;
                } catch {
                    return false;
                }
            })()
        };
        
        const failedTests = Object.entries(tests).filter(([_, passed]) => !passed).map(([test]) => test);
        
        if (failedTests.length === 0) {
            showSuccessMessage('اختبار النظام', '✅ جميع الوظائف تعمل بشكل صحيح');
        } else {
            showErrorMessage('اختبار النظام', `❌ فشل في: ${failedTests.join(', ')}`);
        }
        
        console.log('نتائج اختبار النظام:', tests);
    } catch (error) {
        ErrorHandler.logError(error, 'testSystemFunctions');
    }
}

// استدعاء التهيئة عند تحميل الصفحة وعند التبديل بين التبويبات
document.addEventListener('DOMContentLoaded', function() {
    // إعادة تهيئة نظام السحب والإفلات عند التبديل إلى تبويب الأسئلة
    const questionsTab = document.getElementById('questionsTab');
    if (questionsTab) {
        questionsTab.addEventListener('click', function() {
            setTimeout(() => {
                initializeDragAndDrop();
            }, 500);
        });
    }
    // تهيئة فلتر التاريخ
    initializeDateFilter();
	
    // إعادة التهيئة عند تغيير الاختبار المحدد
    const questionTestSelect = document.getElementById('questionTestSelect');
    if (questionTestSelect) {
        questionTestSelect.addEventListener('change', function() {
            setTimeout(() => {
                initializeDragAndDrop();
            }, 800);
        });
    }
});

function getDragAfterElement(container, y) {
    try {
        const draggableElements = [...container.querySelectorAll('.question-item:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    } catch (error) {
        ErrorHandler.logError(error, 'getDragAfterElement');
        return null;
    }
}

function updateQuestionsOrder() {
    try {
        if (currentManagingTest === null) return;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) return;
        
        const questionsList = document.getElementById('questionsList');
        const questionItems = questionsList.querySelectorAll('.question-item');
        const newQuestions = [];
        
        questionItems.forEach(item => {
            const questionIndex = parseInt(item.dataset.questionIndex);
            newQuestions.push(school.tests[currentManagingTest].questions[questionIndex]);
        });
        
        // تحديث ترتيب الأسئلة
        school.tests[currentManagingTest].questions = newQuestions;
        
        // حفظ التغييرات
        StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        // إعادة تحميل الأسئلة لتحديث الأرقام
        loadTestQuestions();
        
    } catch (error) {
        ErrorHandler.logError(error, 'updateQuestionsOrder');
    }
}

// ========== التهيئة النهائية ==========

// استدعاء التهيئة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // إصلاح مستمعات أحداث تبويب الأسئلة
    const questionsTab = document.getElementById('questionsTab');
    if (questionsTab) {
        questionsTab.addEventListener('click', function() {
            console.log('📝 تم فتح تبويب الأسئلة');
            // لا نقوم بتهيئة السحب هنا، سيتم عند تحميل الأسئلة
        });
    }
    
    const questionTestSelect = document.getElementById('questionTestSelect');
    if (questionTestSelect) {
        questionTestSelect.addEventListener('change', function() {
            console.log('🎯 تم اختيار اختبار، جاري تحميل الأسئلة...');
            // loadTestQuestions ستقوم بتهيئة السحب تلقائياً
        });
    }
});

// ========== بدء تشغيل النظام ==========

// بدء تشغيل النظام
initializeSystem();

// تجاهل أي أخطاء من إضافات المتصفح الخارجية
window.addEventListener('error', function(e) {
    if (e.message.includes('hotkeys') || e.filename.includes('chext')) {
        e.preventDefault();
        console.log('ℹ️ خطأ من إضافة متصفح خارجية - تم تجاهله');
        return true;
    }
});

// ========== تهيئة النظام عند التحميل ==========
// ========== تهيئة النظام عند التحميل ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 جاري تحميل نظام الاختبارات...');
    
    // بدء تهيئة النظام بعد تحميل الصفحة
    setTimeout(() => {
        initializeBasicSystem();
    }, 500);
});

function initializeBasicSystem() {
    try {
        console.log('🔧 جاري تهيئة النظام الأساسية...');
        
        // تحميل البيانات من التخزين المحلي إذا كانت موجودة
        const storedTeachers = localStorage.getItem('teacherAccounts');
        const storedSchools = localStorage.getItem('demoSchoolsData');
        
        if (storedTeachers) {
            try {
                const teachers = JSON.parse(storedTeachers);
                Object.assign(demoData.users, teachers);
            } catch (e) {
                console.error('Error loading teachers:', e);
            }
        }
        
        if (storedSchools) {
            try {
                const schools = JSON.parse(storedSchools);
                Object.assign(demoData.schools, schools);
            } catch (e) {
                console.error('Error loading schools:', e);
            }
        }
        
        // تحديث الإحصائيات
        updateWelcomeStatistics();
        
        console.log('✅ اكتملت تهيئة النظام الأساسية');
        console.log('📊 الإحصائيات:', {
            مدارس: Object.keys(demoData.schools).length,
            معلمون: Object.keys(demoData.users).length
        });
        
    } catch (error) {
        console.error('❌ خطأ في تهيئة النظام:', error);
    }
}

function updateWelcomeStatistics() {
    try {
        const stats = {
            schools: Object.keys(demoData.schools || {}).length,
            teachers: Object.keys(demoData.users || {}).length,
            tests: Object.values(demoData.schools || {}).reduce((total, school) => 
                total + (school.tests ? school.tests.length : 0), 0),
            results: (() => {
                try {
                    const results = localStorage.getItem('testResults');
                    return results ? JSON.parse(results).length : 0;
                } catch {
                    return 0;
                }
            })()
        };
        
        const elements = {
            statsSchools: document.getElementById('statsSchools'),
            statsTeachers: document.getElementById('statsTeachers'),
            statsTests: document.getElementById('statsTests'),
            statsResults: document.getElementById('statsResults')
        };
        
        if (elements.statsSchools) elements.statsSchools.textContent = stats.schools;
        if (elements.statsTeachers) elements.statsTeachers.textContent = stats.teachers;
        if (elements.statsTests) elements.statsTests.textContent = stats.tests;
        if (elements.statsResults) elements.statsResults.textContent = stats.results;
        
    } catch (error) {
        console.error('Error updating statistics:', error);
    }
}

// تعريف بديل لمنع أخطاء hotkeys من الامتدادات
if (typeof hotkeys === 'undefined') {
    var hotkeys = {
        bind: function() { 
            console.log('Hotkeys not available - this is normal');
            return this;
        },
        unbind: function() { 
            console.log('Hotkeys not available - this is normal');
            return this;
        }
    };
}

</script>

</body>
</html>