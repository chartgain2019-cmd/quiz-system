<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุงูุงุฎุชุจุงุฑุงุช ุงูุชูุงุนูู</title>
    
    <!-- โญโญ ุงูุญู ุงูุฌุฐุฑู ูุฃุฎุทุงุก hotkeys - ูุชุญููู ููุฑุงู โญโญ -->
    <script>
        // ุชุนุฑูู hotkeys ููุฑู ูููุน ุฃุฎุทุงุก ุงูุงูุชุฏุงุฏุงุช
        (function() {
            'use strict';
            // ุชุนุฑูู hotkeys ููุงุฆู ููุฏุงูุฉ ูู ููุณ ุงูููุช
            var hotkeysInstance = function() {
                return hotkeysInstance;
            };
            
            // ุฅุถุงูุฉ ุงูุฎุตุงุฆุต ูููุงุฆู
            Object.assign(hotkeysInstance, {
                filter: function() { return hotkeysInstance; },
                key: function() { return hotkeysInstance; },
                unbind: function() { return hotkeysInstance; },
                isPressed: function() { return false; },
                getPressedKeyCodes: function() { return []; },
                shift: function() { return hotkeysInstance; },
                ctrl: function() { return hotkeysInstance; },
                alt: function() { return hotkeysInstance; },
                meta: function() { return hotkeysInstance; }
            });
            
            // ุชุนุฑูู global ููุฑู
            if (typeof window !== 'undefined') {
                window.hotkeys = hotkeysInstance;
            }
            if (typeof global !== 'undefined') {
                global.hotkeys = hotkeysInstance;
            }
            
            console.log('โ ุชู ุชุญููู hotkeys ุงูุจุฏููุฉ ููุงูุชุฏุงุฏุงุช');
        })();
    </script>
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- ุจุงูู ุงูููุชุจุงุช -->
	<!-- ุฅุถุงูุฉ ููุชุจุงุช ุงูุชุตุฏูุฑ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// ุชุฃูุฏ ูู ุฃู jsPDF ูุชุงุญ globally
window.jsPDF = window.jspdf.jsPDF;
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- ุฅุถุงูุฉ ููุชุจุฉ html2canvas ูุชุญููู HTML ุฅูู ุตูุฑุฉ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body {
            box-sizing: border-box;
        }
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        * { font-family: 'Cairo', sans-serif; }
        
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .pulse-red { animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 
            0%, 100% { background-color: #ef4444; } 
            50% { background-color: #dc2626; } 
        }
        /* ุฃููุงุท ุงูุณุญุจ ูุงูุฅููุงุช ุงููุจุณุทุฉ */
        .question-item {
          transition: all 0.3s ease;
          cursor: grab;
          user-select: none;
        }

        .question-item:active {
          cursor: grabbing;
        }

       .question-item.dragging {
          opacity: 0.5;
          transform: scale(0.95);
          background: #f0f0f0 !important;
        }

       .question-item.drag-over {
          border: 2px dashed #3b82f6 !important;
          background: #e0f2fe !important;
          transform: scale(1.02);
        }

        .drag-handle {
         opacity: 0.7;
         cursor: grab;
         padding: 8px;
         border-radius: 4px;
         transition: all 0.2s ease;
        }

        .drag-handle:hover {
          opacity: 1;
          background: rgba(0,0,0,0.1);
        }

       .question-item.dragging .drag-handle {
          cursor: grabbing;
        }
        /* ุฃููุงุท ุงูุณุญุจ ูุงูุฅููุงุช */
        .question-item.drag-target {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        
        .question-item.drag-over {
            border-color: #10b981;
            background-color: #f0fdf4;
            transform: scale(1.02);
        }
        
        .question-item:hover .drag-handle {
            opacity: 1;
        }
        
        .drag-handle {
            opacity: 0.6;
            transition: all 0.2s ease;
        }
        
        .drop-indicator {
            animation: pulse-blue 1s infinite;
        }
        
        @keyframes pulse-blue {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* ุชุญุณููุงุช ุงูุทุจุงุนุฉ ููุดูุงุฏุฉ */
        @media print {
            body * {
                visibility: hidden;
            }
            #certificateContent, #certificateContent * {
                visibility: visible;
            }
            #certificateContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 2cm;
            }
            .no-print {
                display: none !important;
            }
        }

        /* ุชุญุณููุงุช ุงูุงุณุชูุฑุงุฑ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<!-- ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ -->
<div id="welcomeScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700">
    <div class="container mx-auto px-6 py-12">
        <div class="max-w-4xl mx-auto text-center text-white">
            <div class="mb-8">
                <div class="w-24 h-24 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h1 class="text-5xl font-bold mb-4">ูุธุงู ุงูุงุฎุชุจุงุฑุงุช ุงูุชูุงุนูู</h1>
                <p class="text-xl mb-12 text-blue-100">ููุตุฉ ุชุนููููุฉ ุดุงููุฉ ูุขููุฉ ูุฅุฏุงุฑุฉ ุงูุงุฎุชุจุงุฑุงุช ุงููุญุงููุฉ ูุงุฎุชุจุงุฑุงุช ูุงูุณ</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-12">
                <!-- ุฏุฎูู ุงูุทูุงุจ -->
                <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-8 hover:bg-opacity-20 transition-all cursor-pointer" onclick="showStudentAccess()">
                    <div class="text-6xl mb-6">๐จโ๐</div>
                    <h3 class="text-2xl font-bold mb-4">ุฏุฎูู ุงูุทูุงุจ</h3>
                    <p class="text-blue-100 mb-6">ุงุจุฏุฃ ุฑุญูุชู ุงูุชุนููููุฉ</p>
                    <button class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-xl font-semibold transition-all">
                        ุงุจุฏุฃ ุงูุขู
                    </button>
                </div>

                <!-- ุฏุฎูู ุงููุนูููู -->
                <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-8 hover:bg-opacity-20 transition-all cursor-pointer" onclick="showTeacherLogin()">
                    <div class="text-6xl mb-6">๐จโ๐ผ</div>
                    <h3 class="text-2xl font-bold mb-4">ุฏุฎูู ุงููุนูููู</h3>
                    <p class="text-blue-100 mb-6">ุฅุฏุงุฑุฉ ุงูุงุฎุชุจุงุฑุงุช</p>
                    <button class="bg-purple-500 hover:bg-purple-600 text-white px-8 py-3 rounded-xl font-semibold transition-all">
                        ุฏุฎูู ููุญุฉ ุงูุชุญูู
                    </button>
                </div>
            </div>

            <!-- ุฅุญุตุงุฆูุงุช -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-yellow-300" id="statsSchools">5</div>
                    <div class="text-sm text-blue-100">ุงููุฏุงุฑุณ</div>
                </div>
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-green-300" id="statsTeachers">12</div>
                    <div class="text-sm text-blue-100">ุงููุนูููู</div>
                </div>
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-pink-300" id="statsTests">48</div>
                    <div class="text-sm text-blue-100">ุงูุงุฎุชุจุงุฑุงุช</div>
                </div>
                <div class="bg-white bg-opacity-10 rounded-2xl p-6 text-center">
                    <div class="text-3xl font-bold text-orange-300" id="statsResults">156</div>
                    <div class="text-sm text-blue-100">ุงููุชุงุฆุฌ</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ุดุงุดุฉ ุชุณุฌูู ุฏุฎูู ุงููุนูููู -->
<div id="teacherLoginScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-8 text-center">
            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold">ุชุณุฌูู ุฏุฎูู ุงููุนูู</h2>
        </div>
        
        <div class="p-8">
            <form id="teacherLoginForm" onsubmit="return teacherLogin(event)">
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                    <input type="email" id="teacherEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="ุฃุฏุฎู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"  required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">ูููุฉ ุงููุฑูุฑ</label>
                    <input type="password" id="teacherPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ"  required>
                </div>
                
                
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-xl font-semibold hover:from-purple-700 hover:to-blue-700 transition-all">
                        ุชุณุฌูู ุงูุฏุฎูู
                    </button>
                    <button type="button" onclick="closeTeacherLogin()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                        ุฅูุบุงุก
                    </button>
                </div>
                
                <div class="text-center mt-6 pt-6 border-t border-gray-200">
                    <p class="text-gray-600 mb-4">ููุณ ูุฏูู ุญุณุงุจุ</p>
                    <button type="button" onclick="showTeacherSignup()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-all">
                        ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
                    </button>
                </div>
            </form>
            
            <div id="loginError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<!-- ุดุงุดุฉ ุฅูุดุงุก ุญุณุงุจ ูุนูู ุฌุฏูุฏ -->
<div id="teacherSignupScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-8 text-center">
            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold">ุฅูุดุงุก ุญุณุงุจ ูุนูู ุฌุฏูุฏ</h2>
        </div>
        
        <div class="p-8">
            <form id="teacherSignupForm" onsubmit="return teacherSignup(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">ุงูุงุณู ุงููุงูู</label>
                    <input type="text" id="newTeacherName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="ุฃุฏุฎู ุงูุงุณู ุงููุงูู" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                    <input type="email" id="newTeacherEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="ุฃุฏุฎู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">ุงุณู ุงููุฏุฑุณุฉ</label>
                    <input type="text" id="newTeacherSchool" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="ุฃุฏุฎู ุงุณู ุงููุฏุฑุณุฉ" required>
                </div>
                
                <!-- ุฅุถุงูุฉ ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ</label>
                    <select id="newTeacherStage" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" required>
                        <option value="">ุงุฎุชุฑ ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ</option>
                        <option value="ุงุจุชุฏุงุฆูุฉ">ุงูุงุจุชุฏุงุฆูุฉ</option>
                        <option value="ูุชูุณุทุฉ">ุงููุชูุณุทุฉ</option>
                        <option value="ุซุงูููุฉ">ุงูุซุงูููุฉ</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">ูููุฉ ุงููุฑูุฑ</label>
                    <input type="password" id="newTeacherPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ</label>
                    <input type="password" id="confirmTeacherPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="ุฃุนุฏ ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ" required>
                </div>
                
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 text-white py-3 rounded-xl font-semibold hover:from-green-700 hover:to-blue-700 transition-all">
                        ุฅูุดุงุก ุงูุญุณุงุจ
                    </button>
                    <button type="button" onclick="closeTeacherSignup()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                        ุฅูุบุงุก
                    </button>
                </div>
            </form>
            
            <div id="signupError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
            <div id="signupSuccess" class="hidden mt-4 p-4 bg-green-50 border border-green-200 text-green-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<!-- ุดุงุดุฉ ุงุฎุชูุงุฑ ุงููุฏุฑุณุฉ ููุทูุงุจ -->
<div id="studentAccessScreen" class="hidden container mx-auto px-6 py-12">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-8 text-center relative">
                <!-- ุฅุถุงูุฉ ุฒุฑ ุงูุนูุฏุฉ ุฅูู ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ -->
                <button onclick="goBackToWelcome()" class="absolute top-6 right-6 bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-xl transition-all">
                    โ ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ
                </button>
                <div class="text-5xl mb-4">๐</div>
                <h1 class="text-3xl font-bold mb-2">ูุฑุญุจุงู ุจู ุนุฒูุฒู ุงูุทุงูุจ</h1>
                <p class="text-blue-100">ุงุจุญุซ ุนู ูุฏุฑุณุชู ูุงุจุฏุฃ ุงูุงุฎุชุจุงุฑ</p>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl p-8 mb-8">
            <label class="block text-gray-800 font-bold mb-4 text-xl">๐ ุงุจุญุซ ุนู ูุฏุฑุณุชู</label>
            <!-- ุชุบููุฑ ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ุฅูู ุญูู ุงูุจุญุซ -->
            <input type="text" id="schoolSearch" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:border-blue-500 focus:outline-none" placeholder="ุงูุชุจ ุงุณู ูุฏุฑุณุชู ููุจุญุซ..." oninput="searchSchools()">
            <p class="text-sm text-gray-500 mt-2">ุงุจุฏุฃ ุจูุชุงุจุฉ ุงุณู ุงููุฏุฑุณุฉ ููุจุญุซ ุนููุง</p>
            
            <!-- ูุงุฆูุฉ ูุชุงุฆุฌ ุงูุจุญุซ -->
            <div id="schoolSearchResults" class="mt-4 max-h-60 overflow-y-auto hidden border border-gray-200 rounded-xl">
                <!-- ุณูุชู ุชุนุจุฆุฉ ูุชุงุฆุฌ ุงูุจุญุซ ููุง -->
            </div>
        </div>

        <div id="selectedSchoolInfo" class="hidden bg-white rounded-3xl shadow-xl p-8">
            <div class="bg-green-50 p-6 rounded-2xl mb-6 border border-green-200">
                <h3 class="text-xl font-bold text-green-800 mb-4">ุงููุฏุฑุณุฉ ุงููุฎุชุงุฑุฉ</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-green-600 font-semibold">๐ซ ุงุณู ุงููุฏุฑุณุฉ:</span>
                        <span id="chosenSchoolName" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-green-600 font-semibold">๐จโ๐ซ ุงููุนูู:</span>
                        <span id="chosenTeacher" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                </div>
            </div>
           <button onclick="refreshSchoolData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl font-semibold transition-all flex items-center gap-2">
                ๐ ุชุญุฏูุซ
           </button>
        </div>
    </div>
            <div class="mb-6">
                <label class="block text-gray-800 font-bold mb-4">๐ ุงุฎุชุฑ ุงูุงุฎุชุจุงุฑ</label>
                <select id="testSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:border-blue-500 focus:outline-none" onchange="selectTest()">
                    <option value="">ุงุฎุชุฑ ุงูุงุฎุชุจุงุฑ</option>
                </select>
            </div>

            <div id="testInfo" class="hidden bg-blue-50 p-6 rounded-2xl mb-6 border border-blue-200">
                <h3 class="font-bold text-blue-800 mb-4">ูุนูููุงุช ุงูุงุฎุชุจุงุฑ</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-blue-600 font-semibold">๐ ุงููุงุฏุฉ:</span>
                        <span id="testSubject" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">โ ุนุฏุฏ ุงูุฃุณุฆูุฉ:</span>
                        <span id="testQuestions" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">๐ ุงูุตู ุงูุฏุฑุงุณู:</span>
                        <span id="testGrade" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">โฑ๏ธ ููุช ุงูุณุคุงู:</span>
                        <span id="testTimer" class="font-bold text-gray-800 mr-2"></span>
                    </div>
                </div>
            </div>

            <div id="studentForm" class="hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-6">๐ค ุจูุงูุงุช ุงูุทุงูุจ</h3>
                
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ุงุณู ุงูุทุงูุจ *</label>
                        <input type="text" id="studentName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="ุฃุฏุฎู ุงุณู ุงูุทุงูุจ">
                    </div>
                    <!-- ุฅุถุงูุฉ ุงูุตู ุงูุฏุฑุงุณู ุจุนุฏ ุงุณู ุงูุทุงูุจ -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ุงูุตู ุงูุฏุฑุงุณู *</label>
                        <select id="studentGrade" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            <option value="">ุณูุชู ุชุนุจุฆุชู ุชููุงุฆูุงู</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">ูุชู ุชุญุฏูุฏ ุงูุตู ุงูุฏุฑุงุณู ุชููุงุฆูุงู ุญุณุจ ุงูุงุฎุชุจุงุฑ ุงููุญุฏุฏ</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ุงููุตู *</label>
                        <input type="text" id="studentClass" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="ูุซุงู: 6ุฃ">
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="startTest()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-12 py-4 rounded-xl text-xl font-bold hover:from-green-600 hover:to-blue-600 transition-all shadow-lg">
                        ๐ ุจุฏุก ุงูุงุฎุชุจุงุฑ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ุดุงุดุฉ ุงูุงุฎุชุจุงุฑ -->
<div id="testScreen" class="hidden container mx-auto px-6 py-8">
    <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
            <div class="flex justify-between items-center text-sm">
                <div class="flex gap-4">
                    <span>๐ซ <span id="testSchoolName"></span></span>
                    <span>๐ <span id="testSubjectName"></span></span>
                    <span>๐ <span id="testGradeLevel"></span></span>
                    <span>๐ค <span id="testStudentName"></span></span>
                </div>
                <div class="flex gap-4">
                    <span>โ <span id="currentQuestion">1</span> ูู <span id="totalQuestions">5</span></span>
                    <span>โญ <span id="currentScore">0</span></span>
                </div>
            </div>
        </div>
        
        <div class="p-4 bg-gray-50">
            <div class="bg-gray-200 rounded-full h-3">
                <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl p-8">
            <div class="text-center mb-8">
                <div id="timer" class="inline-block bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-2xl font-bold">30</div>
                <p class="text-gray-600 mt-2">ุงูููุช ุงููุชุจูู</p>
            </div>
            
            <div class="mb-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center" id="questionText">ูุง ูู ูุงุชุฌ 2 + 2ุ</h3>
                
                <div class="grid gap-4" id="optionsContainer">
                    <!-- ุณูุชู ุฅุถุงูุฉ ุงูุฎูุงุฑุงุช ููุง -->
                </div>
            </div>
            
            <div id="feedbackArea" class="hidden text-center p-4 rounded-xl mb-6"></div>
            
            <div class="text-center pt-6 border-t border-gray-200">
                <button onclick="confirmExitTest()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                    ๐ช ุงูุฎุฑูุฌ ูู ุงูุงุฎุชุจุงุฑ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ูุงูุฐุฉ ุชุฃููุฏ ุงูุฎุฑูุฌ -->
<div id="exitTestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl max-w-md w-full overflow-hidden">
        <div class="bg-red-500 text-white p-6 text-center">
            <div class="text-4xl mb-2">โ๏ธ</div>
            <h2 class="text-xl font-bold">ุชุฃููุฏ ุงูุฎุฑูุฌ</h2>
        </div>
        <div class="p-6 text-center">
            <p class="text-gray-700 mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ุงูุฎุฑูุฌ ูู ุงูุงุฎุชุจุงุฑุ</p>
            <div class="flex gap-4">
                <button onclick="exitTest()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold transition-all">
                    ูุนูุ ุงูุฎุฑูุฌ
                </button>
                <button onclick="cancelExitTest()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-semibold transition-all">
                    ุฅูุบุงุก
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ุดุงุดุฉ ุงููุชุงุฆุฌ -->
<div id="resultsScreen" class="hidden container mx-auto px-6 py-12">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden text-center">
            <div class="bg-gradient-to-r from-green-500 to-blue-500 text-white p-12">
                <div class="text-6xl mb-4">๐</div>
                <h2 class="text-3xl font-bold mb-2">ุชูุงูููุง ุนูู ุฅููุงู ุงูุงุฎุชุจุงุฑ!</h2>
                <p class="text-green-100">ุฅููู ูุชุงุฆุฌู ุงูุชูุตูููุฉ</p>
            </div>
            
            <div class="p-12">
                <div class="grid md:grid-cols-3 gap-8 mb-8">
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-200">
                        <div class="text-4xl mb-2">๐</div>
                        <h3 class="font-bold text-blue-800 mb-2">ุงูููุงุท</h3>
                        <p class="text-3xl font-bold text-blue-600" id="finalScore">0</p>
                    </div>
                    
                    <div class="bg-green-50 p-6 rounded-2xl border border-green-200">
                        <div class="text-4xl mb-2">๐</div>
                        <h3 class="font-bold text-green-800 mb-2">ุงููุณุจุฉ ุงููุฆููุฉ</h3>
                        <p class="text-3xl font-bold text-green-600" id="percentage">0%</p>
                    </div>
                    
                    <div class="bg-purple-50 p-6 rounded-2xl border border-purple-200">
                        <div class="text-4xl mb-2">๐</div>
                        <h3 class="font-bold text-purple-800 mb-2">ุงูุชูุฏูุฑ</h3>
                        <p class="text-2xl font-bold text-purple-600" id="grade">-</p>
                    </div>
                </div>
                
                <div class="flex flex-wrap justify-center gap-4">
                    <button onclick="showCertificate()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-600 transition-all">
                        ๐ ุนุฑุถ ุงูุดูุงุฏุฉ
                    </button>
                    
                    <button onclick="shareWhatsApp()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        ๐ฑ ูุดุงุฑูุฉ ุจุงููุงุชุณุงุจ
                    </button>
                    
                    <button onclick="retakeTest()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        ๐ ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ
                    </button>
                    
                    <button onclick="goBackToSchoolSelection()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        โ ุงูุนูุฏุฉ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ุดุงุดุฉ ุงูุดูุงุฏุฉ Canvas ุงููุญุณูุฉ -->
<div id="certificateScreen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl max-w-4xl w-full max-h-screen overflow-y-auto no-print">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 text-center no-print">
            <h2 class="text-2xl font-bold">๐ ุดูุงุฏุฉ ุฅูุฌุงุฒ ูุญุณูุฉ</h2>
        </div>
        
        <div class="p-8">
            <!-- ูุนุงููุฉ ุงูุดูุงุฏุฉ -->
            <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-4 border-blue-300 rounded-2xl p-8 mb-6">
                <div id="certificatePreview" class="text-center">
                    <!-- ุณูุชู ุนุฑุถ ูุนุงููุฉ ุงูุดูุงุฏุฉ ููุง -->
                </div>
            </div>
            
            <!-- canvas ูุฎูู ูุฑุณู ุงูุดูุงุฏุฉ -->
            <canvas id="certificateCanvas" class="hidden" width="2480" height="3508"></canvas>
        </div>
        
        <div class="p-6 text-center border-t border-gray-200 no-print">
            <button onclick="generateCertificateImage('png')" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all mr-4">
                ๐ธ ุญูุธ ูุตูุฑุฉ PNG
            </button>
            <button onclick="generateCertificateImage('jpg')" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl font-semibold transition-all mr-4">
                ๐ผ๏ธ ุญูุธ ูุตูุฑุฉ JPG
            </button>
            <button onclick="closeCertificate()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                ุฅุบูุงู
            </button>
        </div>
    </div>
</div>

<!-- ููุญุฉ ุชุญูู ุงููุนูู -->
<div id="teacherDashboard" class="hidden container mx-auto px-6 py-8">
    <!-- ูุญุชูู ููุญุฉ ุชุญูู ุงููุนูู -->
    <div class="bg-white rounded-3xl shadow-xl">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-8 rounded-t-3xl">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">ููุญุฉ ุชุญูู ุงููุนูู</h1>
                    <p class="text-purple-100" id="teacherWelcome">ูุฑุญุจุงู ุฃ. ุนุจุฏุงููู ุงูุดูุฑู</p>
                </div>
                <button onclick="teacherLogout()" class="bg-red-500 hover:bg-red-600 px-6 py-3 rounded-xl font-semibold transition-all">
                    ๐ช ุชุณุฌูู ุงูุฎุฑูุฌ
                </button>
            </div>
        </div>
        
        <!-- ุดุฑูุท ุงูุชุจููุจุงุช -->
        <div class="bg-gray-50 px-8 py-4 border-b border-gray-200">
            <div class="flex gap-2 overflow-x-auto">
                <button onclick="showTab('dashboard')" id="dashboardTab" class="tab-btn active bg-white text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    ๐ ููุญุฉ ุงููุนูููุงุช
                </button>
                <button onclick="showTab('tests')" id="testsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    ๐ ุฅุฏุงุฑุฉ ุงูุงุฎุชุจุงุฑุงุช
                </button>
                <button onclick="showTab('questions')" id="questionsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    โ ุฅุฏุงุฑุฉ ุงูุฃุณุฆูุฉ
                </button>
                <button onclick="showTab('results')" id="resultsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    ๐ ูุชุงุฆุฌ ุงูุทูุงุจ
                </button>
                <button onclick="showTab('settings')" id="settingsTab" class="tab-btn bg-transparent text-gray-600 hover:text-blue-600 px-6 py-3 rounded-xl font-semibold whitespace-nowrap transition-all">
                    โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ
                </button>
            </div>
        </div>
        
        <!-- ูุญุชูู ุงูุชุจููุจุงุช -->
        <div class="p-8">
            <!-- ุชุจููุจ ููุญุฉ ุงููุนูููุงุช -->
            <div id="dashboardContent" class="tab-content">
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded-2xl text-center border border-blue-200">
                        <div class="text-4xl mb-2">๐</div>
                        <div class="text-3xl font-bold text-blue-600" id="totalTests">1</div>
                        <div class="text-gray-600">ุงุฎุชุจุงุฑุงุชู</div>
                    </div>
                    <div class="bg-green-50 p-6 rounded-2xl text-center border border-green-200">
                        <div class="text-4xl mb-2">๐ฅ</div>
                        <div class="text-3xl font-bold text-green-600" id="totalStudents">0</div>
                        <div class="text-gray-600">ุงูุทูุงุจ</div>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-2xl text-center border border-purple-200">
                        <div class="text-4xl mb-2">๐</div>
                        <div class="text-3xl font-bold text-purple-600" id="averageScore">0%</div>
                        <div class="text-gray-600">ูุชูุณุท ุงูุฏุฑุฌุงุช</div>
                    </div>
                    <div class="bg-orange-50 p-6 rounded-2xl text-center border border-orange-200">
                        <div class="text-4xl mb-2">๐ฏ</div>
                        <div class="text-3xl font-bold text-orange-600" id="passRate">0%</div>
                        <div class="text-gray-600">ูุนุฏู ุงููุฌุงุญ</div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-6 rounded-2xl border border-blue-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">๐ ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">ุฅุฌูุงูู ุงููุญุงููุงุช:</span>
                                <span class="font-bold text-blue-600" id="totalAttempts">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ุฃุนูู ุฏุฑุฌุฉ:</span>
                                <span class="font-bold text-green-600" id="highestScore">0%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ุฃูู ุฏุฑุฌุฉ:</span>
                                <span class="font-bold text-red-600" id="lowestScore">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-50 to-blue-50 p-6 rounded-2xl border border-green-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">๐ฏ ุฃูุฏุงู ุงูุชุญุณูู</h3>
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded-xl">
                                <div class="text-sm text-gray-600 mb-1">ูุนุฏู ุงููุฌุงุญ ุงููุณุชูุฏู</div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                                    </div>
                                    <span class="text-sm font-bold">85%</span>
                                </div>
                            </div>
                            <div class="bg-white p-3 rounded-xl">
                                <div class="text-sm text-gray-600 mb-1">ูุชูุณุท ุงูุฏุฑุฌุงุช ุงููุณุชูุฏู</div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: 80%"></div>
                                    </div>
                                    <span class="text-sm font-bold">80%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ุชุจููุจ ุฅุฏุงุฑุฉ ุงูุงุฎุชุจุงุฑุงุช -->
            <div id="testsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">๐ ุฅุฏุงุฑุฉ ุงูุงุฎุชุจุงุฑุงุช</h3>
                    <button onclick="showCreateTestModal()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-600 transition-all">
                        โ ุฅูุดุงุก ุงุฎุชุจุงุฑ ุฌุฏูุฏ
                    </button>
                </div>
                
                <div id="testsGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- ุณูุชู ุฅุถุงูุฉ ุงูุงุฎุชุจุงุฑุงุช ููุง -->
                </div>
            </div>
            
            <!-- ุชุจููุจ ุฅุฏุงุฑุฉ ุงูุฃุณุฆูุฉ -->
            <div id="questionsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">โ ุฅุฏุงุฑุฉ ุงูุฃุณุฆูุฉ</h3>
                    <div class="flex gap-4">
                        <select id="questionTestSelect" class="border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="loadTestQuestions()">
                            <option value="">ุงุฎุชุฑ ุงูุงุฎุชุจุงุฑ</option>
                        </select>
                        <button onclick="showAddQuestionModal()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-green-600 hover:to-blue-600 transition-all">
                            โ ุฅุถุงูุฉ ุณุคุงู
                        </button>
                    </div>
                </div>
                
                <div id="questionsContainer">
                    <div class="text-center text-gray-500 py-12">
                        <div class="text-6xl mb-4">โ</div>
                        <p>ุงุฎุชุฑ ุงุฎุชุจุงุฑุงู ูุนุฑุถ ุงูุฃุณุฆูุฉ</p>
                    </div>
                </div>
            </div>
            
            <!-- ุชุจููุจ ูุชุงุฆุฌ ุงูุทูุงุจ -->
            <div id="resultsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">๐ ูุชุงุฆุฌ ุงูุทูุงุจ</h3>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                            ๐ Excel
                        </button>
                        <button onclick="exportFilteredToExcel()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                            ๐ Excel ูููุชุฑ
                        </button>
                        <button onclick="exportResults()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
                            ๐ CSV
                        </button>
                        <button onclick="clearAllFilters()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-xl font-semibold transition-all">
                            ๐ ูุณุญ ุงูููุงุชุฑ
                        </button>
                    </div>
                </div>
                
                <!-- ูุธุงู ุงูุจุญุซ ูุงูููุชุฑุฉ ุงููุชูุฏู -->
                <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="text-2xl">๐</div>
                        <h4 class="text-lg font-bold text-gray-800">ุงูุจุญุซ ูุงูููุชุฑุฉ ุงููุชูุฏูุฉ</h4>
                        <div class="flex-1"></div>
                        <button onclick="toggleAdvancedFilters()" id="toggleFiltersBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-all">
                            ุฅุธูุงุฑ ุงูููุงุชุฑ ุงููุชูุฏูุฉ
                        </button>
                    </div>
                    
                    <!-- ูุฑุจุน ุงูุจุญุซ -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">๐ ุงูุจุญุซ ุจุงุณู ุงูุทุงูุจ</label>
                        <input type="text" id="searchStudentName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="ุงูุชุจ ุงุณู ุงูุทุงูุจ ููุจุญุซ..." oninput="filterResults()">
                    </div>
                    
                    <!-- ุงูููุงุชุฑ ุงููุชูุฏูุฉ -->
                    <div id="advancedFilters" class="hidden">
                        <div class="grid md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <!-- ููุชุฑ ุงูุงุฎุชุจุงุฑ -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">๐ ุงูุงุฎุชุจุงุฑ</label>
                                <select id="filterTestSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">ุฌููุน ุงูุงุฎุชุจุงุฑุงุช</option>
                                </select>
                            </div>
                            
                            <!-- ููุชุฑ ุงููุตู -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">๐ซ ุงููุตู</label>
                                <select id="filterClassSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">ุฌููุน ุงููุตูู</option>
                                </select>
                            </div>
                            
                            <!-- ููุชุฑ ุงูุชูุฏูุฑ -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">๐ ุงูุชูุฏูุฑ</label>
                                <select id="filterGradeSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">ุฌููุน ุงูุชูุฏูุฑุงุช</option>
                                    <option value="ููุชุงุฒ">ููุชุงุฒ</option>
                                    <option value="ุฌูุฏ ุฌุฏุงู">ุฌูุฏ ุฌุฏุงู</option>
                                    <option value="ุฌูุฏ">ุฌูุฏ</option>
                                    <option value="ููุจูู">ููุจูู</option>
                                    <option value="ุถุนูู">ุถุนูู</option>
                                </select>
                            </div>
                            
                            <!-- ููุชุฑ ุงููุณุจุฉ ุงููุฆููุฉ -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">๐ ุงููุณุจุฉ ุงููุฆููุฉ</label>
                                <select id="filterPercentageSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">ุฌููุน ุงููุณุจ</option>
                                    <option value="90-100">90% - 100%</option>
                                    <option value="80-89">80% - 89%</option>
                                    <option value="70-79">70% - 79%</option>
                                    <option value="60-69">60% - 69%</option>
                                    <option value="0-59">ุฃูู ูู 60%</option>
                                </select>
                            </div>
                            
                            <!-- ููุชุฑ ุงูุฏุฑุฌุฉ -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">๐ฏ ุงูุฏุฑุฌุฉ</label>
                                <select id="filterScoreSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">ุฌููุน ุงูุฏุฑุฌุงุช</option>
                                </select>
                            </div>
                            
                            <!-- ููุชุฑ ุงูุชุงุฑูุฎ -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">๐ ุงูุชุงุฑูุฎ</label>
                                <select id="filterDateSelect" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                    <option value="">ุฌููุน ุงูุชูุงุฑูุฎ</option>
                                    <option value="today">ุงูููู</option>
                                    <option value="week">ูุฐุง ุงูุฃุณุจูุน</option>
                                    <option value="month">ูุฐุง ุงูุดูุฑ</option>
                                    <option value="custom">ุชุงุฑูุฎ ูุญุฏุฏ</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ุงุฎุชูุงุฑ ุชุงุฑูุฎ ูุญุฏุฏ -->
                        <div id="customDateFilter" class="hidden mt-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">ูู ุชุงุฑูุฎ</label>
                                    <input type="date" id="filterDateFrom" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">ุฅูู ุชุงุฑูุฎ</label>
                                    <input type="date" id="filterDateTo" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" onchange="filterResults()">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ุฅุญุตุงุฆูุงุช ุงููุชุงุฆุฌ ุงููููุชุฑุฉ -->
                    <div id="filterStats" class="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-blue-600" id="filteredCount">0</div>
                                <div class="text-sm text-blue-600">ุงููุชุงุฆุฌ ุงููุนุฑูุถุฉ</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-green-600" id="filteredAverage">0%</div>
                                <div class="text-sm text-green-600">ูุชูุณุท ุงููุณุจ</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-purple-600" id="filteredPassRate">0%</div>
                                <div class="text-sm text-purple-600">ูุนุฏู ุงููุฌุงุญ</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-orange-600" id="filteredHighest">0%</div>
                                <div class="text-sm text-orange-600">ุฃุนูู ูุณุจุฉ</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-6 rounded-2xl">
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white rounded-xl overflow-hidden">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">ุงุณู ุงูุทุงูุจ</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">ุงูุตู/ุงููุตู</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">ุงูุงุฎุชุจุงุฑ</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">ุงูุฏุฑุฌุฉ</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">ุงููุณุจุฉ</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">ุงูุชูุฏูุฑ</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">ุงูุชุงุฑูุฎ</th>
                                    <th class="px-6 py-4 text-right text-sm font-bold text-gray-700">ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- ุณูุชู ุฅุถุงูุฉ ุงููุชุงุฆุฌ ููุง -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ุชุจููุจ ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ -->
            <div id="settingsContent" class="tab-content hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ</h3>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">๐ค ูุนูููุงุช ุงูุญุณุงุจ</h4>
                        <form onsubmit="return updateProfile(event)">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">ุงูุงุณู ุงููุงูู</label>
                                <input type="text" id="profileName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                                <input type="email" id="profileEmail" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 bg-gray-100" readonly>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">ุงุณู ุงููุฏุฑุณุฉ</label>
                                <input type="text" id="profileSchool" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ</label>
                                <select id="profileStage" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                                    <option value="ุงุจุชุฏุงุฆูุฉ">ุงุจุชุฏุงุฆูุฉ</option>
                                    <option value="ูุชูุณุทุฉ">ูุชูุณุทุฉ</option>
                                    <option value="ุซุงูููุฉ">ุงูุซุงูููุฉ</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition-all">
                                ุญูุธ ุงูุชุบููุฑุงุช
                            </button>
                        </form>
                    </div>
					<!-- ุฃุฏูุงุช ุงูุชุตุญูุญ - ุณุชุธูุฑ ููุท ูู chartgain2019@gmail.com -->
                    <div id="debugToolsSection" class="hidden">
                       <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                           <h4 class="text-lg font-bold text-yellow-800 mb-2">๐๏ธ ุฃุฏูุงุช ุงูุชุตุญูุญ (ุฎุงุตุฉ ุจุงููุณุคูู)</h4>
                           <div class="flex gap-2">
                                <button onclick="initializeDefaultData()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                   ุฅุตูุงุญ ุงูุจูุงูุงุช
                                </button>
                                <button onclick="debugData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                   ูุญุต ุงูุจูุงูุงุช
                                </button>
                                <button onclick="debugSystem()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    ูุญุต ุงููุธุงู
                                </button>
                                <button onclick="showAllSchools()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    ุนุฑุถ ุงููุฏุงุฑุณ
                                </button>
                            </div>
                            <p class="text-xs text-yellow-700 mt-2">
							    ูุฐู ุงูุฃุฏูุงุช ุฎุงุตุฉ ุจุงููุณุคูู ูุชุธูุฑ ููุท ูุญุณุงุจ chartgain2019@gmail.com
							</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">๐ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</h4>
                        <form onsubmit="return changePassword(event)">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ</label>
                                <input type="password" id="currentPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
                                <input type="password" id="newPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
                                <input type="password" id="confirmNewPassword" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-all">
                                ุชุบููุฑ ูููุฉ ุงููุฑูุฑ
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== ุงูููุงูุฐ ุงูููุจุซูุฉ ุงูุฌุฏูุฏุฉ ========== -->

<!-- ูุงูุฐุฉ ุฅูุดุงุก ูุชุนุฏูู ุงูุงุฎุชุจุงุฑ -->
<div id="testModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center sticky top-0 z-10">
            <h2 class="text-2xl font-bold" id="testModalTitle">ุฅูุดุงุก ุงุฎุชุจุงุฑ ุฌุฏูุฏ</h2>
        </div>
        
        <div class="p-8">
            <form id="testModalForm" onsubmit="return handleTestFormSubmit(event)">
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ุงุณู ุงูุงุฎุชุจุงุฑ</label>
                        <input type="text" id="modalTestName" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="ูุซุงู: ุงุฎุชุจุงุฑ ุงููุตู ุงูุซุงูู" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ุงููุงุฏุฉ</label>
                        <input type="text" id="modalTestSubject" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="ูุซุงู: ุงูุฑูุงุถูุงุชุ ุงูุนูููุ ุงููุบุฉ ุงูุนุฑุจูุฉ..." required>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">๐ ุงูุตู ุงูุฏุฑุงุณู</label>
                        <select id="modalTestGrade" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                            <option value="">ุงุฎุชุฑ ุงูุตู ุงูุฏุฑุงุณู</option>
                            <!-- ุณูุชู ุชุนุจุฆุฉ ุงูุฎูุงุฑุงุช ุฏููุงููููุงู ุญุณุจ ุงููุฑุญูุฉ -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">โฑ๏ธ ููุช ูู ุณุคุงู (ุจุงูุซูุงูู)</label>
                        <input type="number" id="modalTestTimer" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="30" min="10" max="300" value="30" required>
                        <p class="text-xs text-gray-500 mt-1">ูู 10 ุฅูู 300 ุซุงููุฉ</p>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">๐ ูุณุชูู ุงูุตุนูุจุฉ</label>
                        <select id="modalTestDifficulty" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none">
                            <option value="ุณูู">ุณูู</option>
                            <option value="ูุชูุณุท" selected>ูุชูุณุท</option>
                            <option value="ุตุนุจ">ุตุนุจ</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">ูุตู ุงูุงุฎุชุจุงุฑ</label>
                    <textarea id="modalTestDescription" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" rows="3" placeholder="ูุตู ูุฎุชุตุฑ ููุงุฎุชุจุงุฑ..."></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        ุญูุธ ุงูุงุฎุชุจุงุฑ
                    </button>
                    <button type="button" onclick="closeTestModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        ุฅูุบุงุก
                    </button>
                </div>
            </form>
            
            <div id="testModalError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<!-- ูุงูุฐุฉ ุฅุถุงูุฉ ูุชุนุฏูู ุงูุณุคุงู -->
<div id="questionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 text-center sticky top-0 z-10">
            <h2 class="text-2xl font-bold" id="questionModalTitle">ุฅุถุงูุฉ ุณุคุงู ุฌุฏูุฏ</h2>
        </div>
        
        <div class="p-8">
            <form id="questionModalForm" onsubmit="return handleQuestionFormSubmit(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">ูุต ุงูุณุคุงู</label>
                    <textarea id="modalQuestionText" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" rows="3" placeholder="ุงูุชุจ ุงูุณุคุงู ููุง..." required></textarea>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ุงูุฎูุงุฑ ุงูุฃูู</label>
                        <input type="text" id="modalOption1" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="ุงูุฎูุงุฑ ุงูุฃูู" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ุงูุฎูุงุฑ ุงูุซุงูู</label>
                        <input type="text" id="modalOption2" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="ุงูุฎูุงุฑ ุงูุซุงูู" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ุงูุฎูุงุฑ ุงูุซุงูุซ</label>
                        <input type="text" id="modalOption3" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="ุงูุฎูุงุฑ ุงูุซุงูุซ" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ุงูุฎูุงุฑ ุงูุฑุงุจุน</label>
                        <input type="text" id="modalOption4" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="ุงูุฎูุงุฑ ุงูุฑุงุจุน" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</label>
                    <select id="modalCorrectAnswer" class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" required>
                        <option value="">ุงุฎุชุฑ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</option>
                        <option value="0">ุงูุฎูุงุฑ ุงูุฃูู</option>
                        <option value="1">ุงูุฎูุงุฑ ุงูุซุงูู</option>
                        <option value="2">ุงูุฎูุงุฑ ุงูุซุงูุซ</option>
                        <option value="3">ุงูุฎูุงุฑ ุงูุฑุงุจุน</option>
                    </select>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        ุญูุธ ุงูุณุคุงู
                    </button>
                    <button type="button" onclick="closeQuestionModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                        ุฅูุบุงุก
                    </button>
                </div>
            </form>
            
            <div id="questionModalError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-center"></div>
        </div>
    </div>
</div>

<script>
// ========== ุฃูุธูุฉ ุงูุงุณุชูุฑุงุฑ ูุงูุฃูุงู ุงููุญุณูุฉ ==========
// ========== ุญู ููุงุฆู ูุฃุฎุทุงุก ุงูุงูุชุฏุงุฏุงุช ุงูุฎุงุฑุฌูุฉ ==========
// ุชุนุฑูู hotkeys ูุงุฑุบ ูููุน ุฃุฎุทุงุก ุงูุงูุชุฏุงุฏุงุช
if (typeof hotkeys === 'undefined') {
    window.hotkeys = function() { 
        return {
            filter: function() { return this; },
            key: function() { return this; },
            unbind: function() { return this; },
            isPressed: function() { return false; }
        }; 
    };
}
// ูุธุงู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงููุฑูุฒู
const ErrorHandler = {
    logError: function(error, context = '') {
        console.error(`[SYSTEM_ERROR] ูู ${context}:`, error);
        this.showUserError(error, context);
        
        // ุชุณุฌูู ุงูุฎุทุฃ ูู ุงูุชุฎุฒูู ุงููุญูู ููุชุญููู
        this.logToStorage(error, context);
    },
    
    showUserError: function(error, context = '') {
        try {
            const errorMessage = this.getUserFriendlyMessage(error);
            this.displayErrorModal(errorMessage, context);
        } catch (modalError) {
            console.error('Failed to show error modal:', modalError);
            // ุนุฑุถ ุฑุณุงูุฉ ุจุฏููุฉ ุจุณูุทุฉ
            alert('ุญุฏุซ ุฎุทุฃ ูู ุงููุธุงู. ูุฑุฌู ุชุญุฏูุซ ุงูุตูุญุฉ.');
        }
    },
    
    getUserFriendlyMessage: function(error) {
        if (error.name === 'QuotaExceededError') {
            return 'ุชู ุชุฌุงูุฒ ุณุนุฉ ุงูุชุฎุฒูู. ูุฑุฌู ุญุฐู ุจุนุถ ุงูุจูุงูุงุช ุงููุฏููุฉ.';
        } else if (error.name === 'SyntaxError') {
            return 'ุฎุทุฃ ูู ุงูุจูุงูุงุช ุงููุฎุฒูุฉ. ุณูุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุจูุงูุงุช ุชููุงุฆูุงู.';
        } else if (error.message && error.message.includes('network')) {
            return 'ูุดู ูู ุงูุงุชุตุงู ุจุงูุดุจูุฉ. ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช.';
        } else {
            return 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน. ูุฑุฌู ุชุญุฏูุซ ุงูุตูุญุฉ ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
        }
    },
    
    displayErrorModal: function(message, context = '') {
        const modalId = 'errorModal-' + Date.now();
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-3xl max-w-md w-full overflow-hidden">
                    <div class="bg-red-500 text-white p-6 text-center">
                        <div class="text-4xl mb-2">โ๏ธ</div>
                        <h2 class="text-xl font-bold">${context ? `ุฎุทุฃ ูู ${context}` : 'ุญุฏุซ ุฎุทุฃ'}</h2>
                    </div>
                    <div class="p-6 text-center">
                        <p class="text-gray-700 mb-6">${message}</p>
                        <div class="flex gap-4">
                            <button onclick="document.getElementById('${modalId}').remove()" 
                                    class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold transition-all">
                                ููุงูู
                            </button>
                            <button onclick="location.reload()" 
                                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition-all">
                                ุชุญุฏูุซ ุงูุตูุญุฉ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    },
    
    logToStorage: function(error, context) {
        try {
            const errorLog = {
                timestamp: new Date().toISOString(),
                context: context,
                error: {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                },
                userAgent: navigator.userAgent
            };
            
            const existingLogs = StorageManager.getItem('errorLogs') || [];
            existingLogs.push(errorLog);
            
            // ุญูุธ ุขุฎุฑ 50 ุฎุทุฃ ููุท
            if (existingLogs.length > 50) {
                existingLogs.splice(0, existingLogs.length - 50);
            }
            
            StorageManager.setItem('errorLogs', existingLogs);
        } catch (logError) {
            console.error('Failed to log error:', logError);
        }
    }
};

// ูุธุงู ุฅุฏุงุฑุฉ ุงูููุงุฑุฏ
const ResourceManager = {
    timers: new Set(),
    eventListeners: new Map(),
    activeSessions: new Set(),
    
    addTimer: function(timer) {
        this.timers.add(timer);
        return timer;
    },
    
    clearAllTimers: function() {
        this.timers.forEach(timer => {
            try {
                clearInterval(timer);
                clearTimeout(timer);
            } catch (error) {
                console.warn('Error clearing timer:', error);
            }
        });
        this.timers.clear();
    },
    
    addEventListener: function(element, event, handler) {
        if (!element || !element.addEventListener) {
            console.warn('Invalid element for event listener');
            return;
        }
        
        try {
            element.addEventListener(event, handler);
            const key = `${element.id || 'unknown'}-${event}`;
            if (!this.eventListeners.has(key)) {
                this.eventListeners.set(key, []);
            }
            this.eventListeners.get(key).push({element, event, handler});
        } catch (error) {
            ErrorHandler.logError(error, 'addEventListener');
        }
    },
    
    clearAllEventListeners: function() {
        this.eventListeners.forEach((listeners, key) => {
            listeners.forEach(({element, event, handler}) => {
                try {
                    if (element && element.removeEventListener) {
                        element.removeEventListener(event, handler);
                    }
                } catch (error) {
                    console.warn('Error removing event listener:', error);
                }
            });
        });
        this.eventListeners.clear();
    },
    
    registerSession: function(sessionId) {
        this.activeSessions.add(sessionId);
    },
    
    cleanupSession: function(sessionId) {
        this.activeSessions.delete(sessionId);
    },
    
    cleanup: function() {
        this.clearAllTimers();
        this.clearAllEventListeners();
        this.activeSessions.clear();
    }
};

// ========== ูุธุงู ุงูุชุฎุฒูู ุงููุญุณูู ูุงููุญุฏุซ ==========

const StorageManager = {
    setItem: function(key, value) {
    try {
        if (!this.isStorageAvailable()) {
            console.warn('LocalStorage ุบูุฑ ูุชููุฑ');
            return false;
        }
        
        // ุชูุธูู ุงูุจูุงูุงุช ูุจู ุงูุญูุธ
        const cleanValue = this.cleanDataBeforeSave(value);
        
        // ูุนุงูุฌุฉ ุฎุงุตุฉ ูู authToken - ุชุฎุฒููู ูู string ูุจุงุดุฑ
        if (key === 'authToken') {
            localStorage.setItem(key, cleanValue);
            console.log(`ุชู ุญูุธ ${key} ูู string ูุจุงุดุฑ`);
            return true;
        }
        
        // ูุจุงูู ุงูุจูุงูุงุชุ ุงุณุชุฎุฏู ุงูุชุบููู JSON
        const data = JSON.stringify({
            value: cleanValue,
            timestamp: Date.now(),
            version: '1.0'
        });
        
        // ุงูุชุญูู ูู ุญุฌู ุงูุจูุงูุงุช
        if (data.length > 4500000) {
            console.warn(`ุจูุงูุงุช ูุจูุฑุฉ ุฌุฏุงู ูู ${key}: ${data.length} ุจุงูุช`);
            return this.handleLargeData(key, cleanValue);
        }
        
        localStorage.setItem(key, data);
        console.log(`ุชู ุญูุธ ${key} ุจูุฌุงุญ`);
        return true;
    } catch (error) {
        ErrorHandler.logError(error, `StorageManager.setItem(${key})`);
        return false;
    }
},
    
getItem: function(key) {
    try {
        if (!this.isStorageAvailable()) {
            return this.getDefaultValue(key);
        }
        
        const item = localStorage.getItem(key);
        if (!item) return this.getDefaultValue(key);
        
        // ูุนุงูุฌุฉ ุฎุงุตุฉ ูู authToken - ูุง ูุญุงูู ุชุญูููู ูู JSON
        if (key === 'authToken') {
            return item; // ุฅุฑุฌุงุน ุงููููุฉ ูุจุงุดุฑุฉ
        }
        
        try {
            const parsed = JSON.parse(item);
            
            // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
            if (!parsed || typeof parsed !== 'object') {
                console.warn(`ุจูุงูุงุช ุบูุฑ ุตุงูุญุฉ ูู ${key}`);
                return this.getDefaultValue(key);
            }
            
            return parsed.value !== undefined ? parsed.value : this.getDefaultValue(key);
        } catch (jsonError) {
            // ุฅุฐุง ูุดู ุงูุชุญููู JSONุ ูุฏ ุชููู ุงููููุฉ ูุฎุฒูุฉ ูู string ูุจุงุดุฑ
            console.warn(`ูุดู ุชุญููู JSON ูู ${key}ุ ุฅุฑุฌุงุน ุงููููุฉ ูุจุงุดุฑุฉ:`, item);
            return item;
        }
    } catch (error) {
        ErrorHandler.logError(error, `StorageManager.getItem(${key})`);
        return this.getDefaultValue(key);
    }
},
    
    cleanDataBeforeSave: function(data) {
        if (Array.isArray(data)) {
            return data.map(item => this.cleanDataBeforeSave(item));
        } else if (data && typeof data === 'object') {
            const cleaned = {};
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    cleaned[key] = this.cleanDataBeforeSave(data[key]);
                }
            }
            return cleaned;
        }
        return data;
    },
    
    getDefaultValue: function(key) {
        const defaults = {
            'teacherAccounts': {},
            'demoSchoolsData': {},
            'testResults': [],
            'errorLogs': []
        };
        return defaults[key] || null;
    },
    
    tryRecoverData: function(key) {
        try {
            const item = localStorage.getItem(key);
            if (!item) return null;
            
            // ูุญุงููุฉ ุฅุตูุงุญ JSON ุชุงูู
            const fixedJson = item
                .replace(/[\u0000-\u0019]+/g, "")
                .replace(/([{,]\s*)([a-zA-Z0-9_]+)(\s*:)/g, '$1"$2"$3');
                
            const parsed = JSON.parse(fixedJson);
            return parsed.value || parsed;
        } catch (recoveryError) {
            console.error(`Failed to recover data for ${key}:`, recoveryError);
            // ุญุฐู ุงูุจูุงูุงุช ุงูุชุงููุฉ
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.error('Failed to remove corrupted data:', e);
            }
            return this.getDefaultValue(key);
        }
    },
    
    isStorageAvailable: function() {
        try {
            const test = 'storage_test';
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
            return true;
        } catch (error) {
            return false;
        }
    },
    
    handleQuotaExceeded: function() {
        // ูุณุญ ุงูุจูุงูุงุช ุงููุฏููุฉ ุชููุงุฆูุงู
        const cleared = this.clearOldData();
        if (cleared) {
            ErrorHandler.showUserError(new Error('ุชู ุชูุธูู ุงูุชุฎุฒูู ุชููุงุฆูุงู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.'));
        } else {
            ErrorHandler.showUserError(new Error('ุงูุชุฎุฒูู ููุชูุฆ. ูุฑุฌู ุญุฐู ุจุนุถ ุงูุจูุงูุงุช ูุฏููุงู.'));
        }
    },
    
    handleLargeData: function(key, value) {
        // ููุนูููุงุช ูุจูุฑุฉุ ูููู ุจุถุบุทูุง ุฃู ุชูุณูููุง
        if (Array.isArray(value) && value.length > 1000) {
            // ุญูุธ ุงูุฌุฒุก ุงูุฃุฎูุฑ ููุท ูู ุงููุตูููุงุช ุงููุจูุฑุฉ
            const trimmedValue = value.slice(-1000);
            return this.setItem(key, trimmedValue);
        }
        return false;
    },
    
    clearOldData: function() {
        try {
            const oneWeekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            let cleared = false;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('testResult_')) {
                    try {
                        const item = localStorage.getItem(key);
                        if (item) {
                            const parsed = JSON.parse(item);
                            if (parsed.timestamp && parsed.timestamp < oneWeekAgo) {
                                localStorage.removeItem(key);
                                cleared = true;
                            }
                        }
                    } catch (e) {
                        // ุชุฎุทู ุงูุนูุงุตุฑ ุงูุชุงููุฉ
                        continue;
                    }
                }
            }
            
            return cleared;
        } catch (error) {
            ErrorHandler.logError(error, 'clearOldData');
            return false;
        }
    },
    
   getStorageInfo: function() {
    let totalSize = 0;
    const items = [];
    
    try {
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            try {
                const value = localStorage.getItem(key);
                if (value) {
                    totalSize += key.length + value.length;
                    items.push({
                        key: key,
                        size: (key.length + value.length) / 1024, // KB
                        timestamp: 'N/A' // ูุง ูุญุงูู ุชุญููู ุงูุชูููุช ูุชุฌูุจ ุงูุฃุฎุทุงุก
                    });
                }
            } catch (e) {
                // ุชุฎุทู ุงูุนูุงุตุฑ ุงูุชู ุชุณุจุจ ุฃุฎุทุงุก
                console.warn(`ุชุฎุทู ุงูุนูุตุฑ ุงูุชุงูู: ${key}`);
                continue;
            }
        }
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุญุณุงุจ ูุนูููุงุช ุงูุชุฎุฒูู:', error);
    }
    
    return {
        totalSize: totalSize / 1024 / 1024, // MB
        itemCount: items.length,
        items: items
    };
},

    // ูุธุงู ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุฌุฏูุฏ
    createBackup: function() {
        try {
            const backup = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && !key.startsWith('temp_')) {
                    backup[key] = localStorage.getItem(key);
                }
            }
            
            const backupData = JSON.stringify({
                data: backup,
                timestamp: Date.now(),
                version: '1.0'
            });
            
            // ุญูุธ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ูู sessionStorage ูุญู ุจุฏูู
            sessionStorage.setItem('localStorageBackup', backupData);
            console.log('ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ');
            return true;
        } catch (error) {
            console.error('ูุดู ูู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ:', error);
            return false;
        }
    },

    restoreBackup: function() {
        try {
            const backup = sessionStorage.getItem('localStorageBackup');
            if (!backup) return false;
            
            const parsed = JSON.parse(backup);
            const backupData = parsed.data;
            
            // ูุณุญ ุงูุจูุงูุงุช ุงูุญุงููุฉ
            localStorage.clear();
            
            // ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช
            for (const key in backupData) {
                if (backupData.hasOwnProperty(key)) {
                    localStorage.setItem(key, backupData[key]);
                }
            }
            
            console.log('ุชู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ');
            return true;
        } catch (error) {
            console.error('ูุดู ูู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:', error);
            return false;
        }
    },

    handleStorageError: function(error, operation, key) {
        console.error(`ุฎุทุฃ ูู ุงูุชุฎุฒูู (${operation} ูู ${key}):`, error);
        
        // ูุญุงููุฉ ุฅุตูุงุญ ุงูุจูุงูุงุช ุงูุชุงููุฉ
        if (error.name === 'SyntaxError') {
            console.log('ูุญุงููุฉ ุฅุตูุงุญ ุจูุงูุงุช JSON ุงูุชุงููุฉ...');
            localStorage.removeItem(key);
            this.createBackup();
        }
        
        // ุฅุนุงุฏุฉ ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ุฅุฐุง ูุฒู ุงูุฃูุฑ
        if (operation === 'get' && this.isCriticalKey(key)) {
            return this.getDefaultValue(key);
        }
        
        return null;
    },

    isCriticalKey: function(key) {
        const criticalKeys = ['teacherAccounts', 'demoSchoolsData', 'testResults'];
        return criticalKeys.includes(key);
    },

    monitorStorage: function() {
        setInterval(() => {
            const info = this.getStorageInfo();
            if (info.totalSize > 4) { // 4MB
                console.warn('ูุณุงุญุฉ ุงูุชุฎุฒูู ูุงุฑุจุฉ ุนูู ุงูุงูุชูุงุก:', info.totalSize.toFixed(2), 'MB');
                this.clearOldData();
            }
        }, 60000); // ูู ุฏูููุฉ
    },

    // ุชููุฆุฉ ุงูุชุฎุฒูู
    initializeStorage: function() {
        console.log('ุจุฏุก ุชููุฆุฉ ูุธุงู ุงูุชุฎุฒูู...');
        
        // ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฃูููุฉ
        this.createBackup();
        
        // ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
        const requiredKeys = ['teacherAccounts', 'demoSchoolsData', 'testResults'];
        requiredKeys.forEach(key => {
            if (!this.getItem(key)) {
                console.log(`ุชููุฆุฉ ${key} ุจููู ุงูุชุฑุงุถูุฉ...`);
                this.setItem(key, this.getDefaultValue(key));
            }
        });
        
        // ุจุฏุก ูุฑุงูุจุฉ ุงูุชุฎุฒูู
        this.monitorStorage();
        
        console.log('ุงูุชููุช ุชููุฆุฉ ูุธุงู ุงูุชุฎุฒูู');
    }
};

// ูุธุงู ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
const DataValidator = {
    validateStudentData: function(data) {
        const errors = [];
        
        if (!data.name || data.name.trim().length < 2) {
            errors.push('ุงุณู ุงูุทุงูุจ ูุฌุจ ุฃู ูููู ุนูู ุงูุฃูู ุญุฑููู');
        }
        
        if (data.name && data.name.trim().length > 100) {
            errors.push('ุงุณู ุงูุทุงูุจ ุทููู ุฌุฏุงู (ุงูุญุฏ ุงูุฃูุตู 100 ุญุฑู)');
        }
        
        if (!data.grade) {
            errors.push('ุงูุตู ุงูุฏุฑุงุณู ูุทููุจ');
        }
        
        if (!data.class || data.class.trim().length === 0) {
            errors.push('ุงููุตู ุงูุฏุฑุงุณู ูุทููุจ');
        }
        
        if (data.class && data.class.trim().length > 50) {
            errors.push('ุงุณู ุงููุตู ุทููู ุฌุฏุงู (ุงูุญุฏ ุงูุฃูุตู 50 ุญุฑู)');
        }
        
        return {
            isValid: errors.length === 0,
            errors: errors
        };
    },
    
    validateTestData: function(test) {
        const errors = [];
        
        if (!test.questions || test.questions.length === 0) {
            errors.push('ุงูุงุฎุชุจุงุฑ ูุฌุจ ุฃู ูุญุชูู ุนูู ุฃุณุฆูุฉ');
        }
        
        if (test.questions && test.questions.length > 100) {
            errors.push('ุนุฏุฏ ุงูุฃุณุฆูุฉ ูุจูุฑ ุฌุฏุงู (ุงูุญุฏ ุงูุฃูุตู 100 ุณุคุงู)');
        }
        
        if (!test.timerPerQuestion || test.timerPerQuestion < 10) {
            errors.push('ููุช ุงูุณุคุงู ูุฌุจ ุฃู ูููู 10 ุซูุงูู ุนูู ุงูุฃูู');
        }
        
        if (test.timerPerQuestion > 300) {
            errors.push('ููุช ุงูุณุคุงู ูุจูุฑ ุฌุฏุงู (ุงูุญุฏ ุงูุฃูุตู 300 ุซุงููุฉ)');
        }
        
        if (!test.name || test.name.trim().length < 2) {
            errors.push('ุงุณู ุงูุงุฎุชุจุงุฑ ูุฌุจ ุฃู ูููู ุนูู ุงูุฃูู ุญุฑููู');
        }
        
        return {
            isValid: errors.length === 0,
            errors: errors
        };
    },
    
    validateEmail: function(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    },
    
    validatePassword: function(password) {
        if (password.length < 6) {
            return 'ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู';
        }
        if (password.length > 50) {
            return 'ูููุฉ ุงููุฑูุฑ ุทูููุฉ ุฌุฏุงู';
        }
        return null;
    },
    
    sanitizeInput: function(input) {
        if (typeof input !== 'string') return input;
        
        return input
            .trim()
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/'/g, '&#39;')
            .replace(/"/g, '&#34;')
            .substring(0, 1000); // ุงูุญุฏ ุงูุฃูุตู ููุฃุทูุงู
    }
};

// ูุธุงู ุงุณุชุฑุฌุงุน ุงููุธุงู
const SystemRecovery = {
    initialize: function() {
        this.setupErrorHandling();
        this.setupPerformanceMonitoring();
        
        if (!this.checkSystemHealth()) {
            this.showSystemWarning();
        }
        
        // ูุญุงููุฉ ุงุณุชุฑุฌุงุน ุงูุฌูุณุฉ ุงูุณุงุจูุฉ
        this.recoverPreviousSession();
    },
    
    setupErrorHandling: function() {
        // ูุนุงูุฌุฉ ุฃุฎุทุงุก JavaScript ุงูุบูุฑ ูุนุงูุฌุฉ
        window.addEventListener('error', (event) => {
            ErrorHandler.logError(event.error, 'Unhandled Global Error');
        });
        
        // ูุนุงูุฌุฉ ูุนูุฏ ูุฑููุถุฉ ุบูุฑ ูุนุงูุฌุฉ
        window.addEventListener('unhandledrejection', (event) => {
            ErrorHandler.logError(event.reason, 'Unhandled Promise Rejection');
        });
        
        // ูุฑุงูุจุฉ ุชุญููู ุงูุตูุฑ ูุงููุดู ูููุง
        window.addEventListener('error', (event) => {
            if (event.target && (event.target.tagName === 'IMG' || event.target.tagName === 'SCRIPT' || event.target.tagName === 'LINK')) {
                console.warn('Failed to load resource:', event.target.src || event.target.href);
            }
        }, true);
    },
    
    setupPerformanceMonitoring: function() {
        // ูุฑุงูุจุฉ ุฃุฏุงุก ุงููุธุงู
        if ('performance' in window) {
            const navTiming = performance.getEntriesByType('navigation')[0];
            if (navTiming) {
                console.log(`Page loaded in ${navTiming.loadEventEnd - navTiming.navigationStart}ms`);
            }
        }
        
        // ูุฑุงูุจุฉ ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ
        if ('memory' in performance) {
            setInterval(() => {
                const memory = performance.memory;
                if (memory.usedJSHeapSize > memory.jsHeapSizeLimit * 0.8) {
                    console.warn('High memory usage detected:', memory);
                }
            }, 30000);
        }
    },
    
    checkSystemHealth: function() {
        const checks = {
            localStorage: this.checkLocalStorage(),
            json: this.checkJSON(),
            timers: this.checkTimers(),
            dom: this.checkDOM()
        };
        
        const failedChecks = Object.entries(checks).filter(([_, passed]) => !passed).map(([check]) => check);
        
        if (failedChecks.length > 0) {
            console.warn('System health check failed for:', failedChecks);
            return false;
        }
        
        return true;
    },
    
    checkLocalStorage: function() {
        return StorageManager.isStorageAvailable();
    },
    
    checkJSON: function() {
        try {
            JSON.parse('{"test": true}');
            JSON.stringify({test: true});
            return true;
        } catch {
            return false;
        }
    },
    
    checkTimers: function() {
        try {
            const testTimer = setTimeout(() => {}, 100);
            clearTimeout(testTimer);
            return true;
        } catch {
            return false;
        }
    },
    
    checkDOM: function() {
        try {
            document.createElement('div');
            return true;
        } catch {
            return false;
        }
    },
    
    showSystemWarning: function() {
        const warning = document.createElement('div');
        warning.className = 'fixed top-4 left-4 right-4 bg-yellow-500 text-white p-4 rounded-xl shadow-lg z-40';
        warning.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">โ๏ธ</span>
                    <div>
                        <div class="font-bold">ุชุญุฐูุฑ ุงููุธุงู</div>
                        <div class="text-sm">ูุฏ ูุง ูุนูู ุงููุธุงู ุจุดูู ูุซุงูู ูู ุจูุฆุชู ุงูุญุงููุฉ</div>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                    โ
                </button>
            </div>
        `;
        document.body.appendChild(warning);
        
        // ุฅุฒุงูุฉ ุงูุชุญุฐูุฑ ุชููุงุฆูุงู ุจุนุฏ 10 ุซูุงู
        setTimeout(() => {
            if (document.body.contains(warning)) {
                warning.remove();
            }
        }, 10000);
    },
    
    recoverPreviousSession: function() {
        try {
            const session = StorageManager.getItem('currentSession');
            if (session && this.isValidSession(session)) {
                console.log('Recovered previous session:', session);
                return session;
            }
        } catch (error) {
            console.warn('Session recovery failed:', error);
        }
        return null;
    },
    
    isValidSession: function(session) {
        return session && 
               session.timestamp && 
               Date.now() - session.timestamp < 30 * 60 * 1000; // 30 ุฏูููุฉ ูุญุฏ ุฃูุตู
    },
    
    saveSession: function(sessionData) {
        try {
            const session = {
                ...sessionData,
                timestamp: Date.now(),
                url: window.location.href
            };
            StorageManager.setItem('currentSession', session);
        } catch (error) {
            console.warn('Failed to save session:', error);
        }
    },
    
    clearSession: function() {
        try {
            localStorage.removeItem('currentSession');
        } catch (error) {
            console.warn('Failed to clear session:', error);
        }
    }
};

// ========== ุฎุฏูุฉ API ==========
const APIService = {
  baseURL: 'https://quiz-system-api.onrender.com/api',
  async request(endpoint, options = {}) {
    try {
		 console.log(`๐ ุทูุจ API: ${this.baseURL}${endpoint}`); // โฌ๏ธ ุฃุถู ูุฐุง ุงูุณุทุฑ
      const token = localStorage.getItem('authToken');
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };

      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      const response = await fetch(`${this.baseURL}${endpoint}`, {
        ...options,
        headers
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `ุฎุทุฃ ูู ุงูุฎุงุฏู: ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error('API Error:', error);
      throw error;
    }
  },

  // ๐ ุงููุตุงุฏูุฉ
  async register(teacherData) {
    const result = await this.request('/register', {
      method: 'POST',
      body: JSON.stringify(teacherData)
    });
    
    if (result.success && result.token) {
      localStorage.setItem('authToken', result.token);
      localStorage.setItem('currentUser', JSON.stringify(result.user));
    }
    
    return result;
  },

  async login(credentials) {
    const result = await this.request('/login', {
      method: 'POST',
      body: JSON.stringify(credentials)
    });
    
    if (result.success && result.token) {
      localStorage.setItem('authToken', result.token);
      localStorage.setItem('currentUser', JSON.stringify(result.user));
    }
    
    return result;
  },

  // ๐ซ ุงููุฏุงุฑุณ
  async getSchools() {
    return this.request('/schools');
  },

// ๐ซ ุงูุญุตูู ุนูู ุฌููุน ุงููุฏุงุฑุณ (ููุจุญุซ - ุจุฏูู ูุตุงุฏูุฉ)
async getAllSchools() {
  try {
    console.log('๐ ุฌุงุฑู ุฌูุจ ุงููุฏุงุฑุณ ูู ุงูุฎุงุฏู...');
    const response = await fetch(`${this.baseURL}/all-schools`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error(`ุฎุทุฃ ูู ุงูุฎุงุฏู: ${response.status}`);
    }

    const data = await response.json();
    console.log('โ ุชู ุฌูุจ ุงููุฏุงุฑุณ ุจูุฌุงุญ:', data);
    return data;
  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุฌูุจ ุงููุฏุงุฑุณ:', error);
    throw error;
  }
},
// ๐ ุงูุญุตูู ุนูู ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ
async getStatistics() {
  return this.request('/statistics');
},	
  // ๐ ุงูุงุฎุชุจุงุฑุงุช
  async getTests(schoolId) {
    return this.request(`/tests/${schoolId}`);
  },

  async createTest(schoolId, testData) {
    return this.request(`/tests/${schoolId}`, {
      method: 'POST',
      body: JSON.stringify(testData)
    });
  },

  // โ ุงูุฃุณุฆูุฉ (ุณูุชู ุฅุถุงูุชูุง ูุงุญูุงู)
  async addQuestion(schoolId, testIndex, questionData) {
    // ุณูุชู ุชุญุฏูุซ ูุฐุง ูุงุญูุงู
    return { success: true };
  },

  // ๐ ุงููุชุงุฆุฌ
  async saveResult(resultData) {
    return this.request('/results', {
      method: 'POST',
      body: JSON.stringify(resultData)
    });
  },
// ูู ูุงุฆู APIServiceุ ุฃุถู:
async changePassword(passwordData) {
  return this.request('/change-password', {
    method: 'POST',
    body: JSON.stringify(passwordData)
  });
}, 
  async getResults() {
    return this.request('/results');
  }
};

// ุชุญุฏูุซ ุฏูุงู ุงูุชุณุฌูู ูุงูุฏุฎูู
async function teacherSignup(event) {
  event.preventDefault();
  
  const name = document.getElementById('newTeacherName').value;
  const email = document.getElementById('newTeacherEmail').value;
  const password = document.getElementById('newTeacherPassword').value;
  const school = document.getElementById('newTeacherSchool').value;
  const stage = document.getElementById('newTeacherStage').value;

  try {
    const result = await APIService.register({
      name, email, password, school, stage
    });
    
    if (result.success) {
      document.getElementById('signupSuccess').textContent = 'ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ!';
      document.getElementById('signupSuccess').classList.remove('hidden');
      
      setTimeout(() => {
        closeTeacherSignup();
        showTeacherLogin();
      }, 2000);
    }
  } catch (error) {
    document.getElementById('signupError').textContent = error.message;
    document.getElementById('signupError').classList.remove('hidden');
  }
}

async function teacherLogin(event) {
  event.preventDefault();
  
  const email = document.getElementById('teacherEmail').value;
  const password = document.getElementById('teacherPassword').value;

  try {
    const result = await APIService.login({ email, password });
    
    if (result.success) {
      currentUser = result.user;
      closeTeacherLogin();
      showTeacherDashboard();
    }
  } catch (error) {
    document.getElementById('loginError').textContent = error.message;
    document.getElementById('loginError').classList.remove('hidden');
  }
}

// ========== ุงููุชุบูุฑุงุช ุงูุฃุณุงุณูุฉ ูููุธุงู ==========
// ุจูุงูุงุช ุงููุธุงู
let currentUser = null;
let currentTest = null;
let currentQuestionIndex = 0;
let timer = null;
let timeLeft = 30;
let studentData = {
    name: '',
    grade: '',
    class: '',
    score: 0,
    answers: []
};

// ูุชุบูุฑุงุช ุฅุฏุงุฑุฉ ุงูุงุฎุชุจุงุฑุงุช
let currentManagingTest = null;
let currentManagingTestSchoolId = null;

// ูุชุบูุฑุงุช ุงูููุงูุฐ ุงูููุจุซูุฉ
let currentEditingTestId = null;
let currentEditingQuestionIndex = null;

// ุจูุงูุงุช ุชุฌุฑูุจูุฉ
const demoData = {
    schools: {}, // ุณูุชู ุชุญููููุง ูู ุงูุชุฎุฒูู ุงููุญูู
    users: {
        'chartgain2019@gmail.com': {
            email: 'chartgain2019@gmail.com',
            password: '123456',
            name: 'ุฃ. ุนุจุฏุงููู ุงูุดูุฑู',
            school: 'ูุฏุฑุณุฉ ุงููููุฏ ุจู ุนูุงุฑุฉ ุงูุงุจุชุฏุงุฆูุฉ',
            stage: 'ุงุจุชุฏุงุฆูุฉ'
        }
    }
};

// ุฏูุงู ุงูุชุนุงูู ูุน ุงููุฑุงุญู ูุงูุตููู
function getGradeOptions(stage) {
    const grades = {
        'ุงุจุชุฏุงุฆูุฉ': [
            'ุงูุฃูู ุงุจุชุฏุงุฆู', 'ุงูุซุงูู ุงุจุชุฏุงุฆู', 'ุงูุซุงูุซ ุงุจุชุฏุงุฆู',
            'ุงูุฑุงุจุน ุงุจุชุฏุงุฆู', 'ุงูุฎุงูุณ ุงุจุชุฏุงุฆู', 'ุงูุณุงุฏุณ ุงุจุชุฏุงุฆู'
        ],
        'ูุชูุณุทุฉ': [
            'ุงูุฃูู ูุชูุณุท', 'ุงูุซุงูู ูุชูุณุท', 'ุงูุซุงูุซ ูุชูุณุท'
        ],
        'ุซุงูููุฉ': [
            'ุงูุฃูู ุซุงููู', 'ุงูุซุงูู ุซุงููู', 'ุงูุซุงูุซ ุซุงููู'
        ]
    };
    return grades[stage] || [];
}

function updateGradeOptions(stage, targetElementId) {
    try {
        const gradeSelect = document.getElementById(targetElementId);
        if (!gradeSelect) {
            console.warn(`Element not found: ${targetElementId}`);
            return;
        }
        
        gradeSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุตู ุงูุฏุฑุงุณู</option>';
        
        if (stage) {
            const grades = getGradeOptions(stage);
            grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeSelect.appendChild(option);
            });
        }
    } catch (error) {
        ErrorHandler.logError(error, 'updateGradeOptions');
    }
}

// ========== ุฏูุงู ุงููุธุงู ุงูุฃุณุงุณูุฉ ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ==========

// ุชุญููู ุงููุชุงุฆุฌ ูู ุงูุชุฎุฒูู ุงููุญูู
function loadResults() {
    try {
        return StorageManager.getItem('testResults') || [];
    } catch (error) {
        ErrorHandler.logError(error, 'loadResults');
        return [];
    }
}

// ุชุญููู ุญุณุงุจุงุช ุงููุนูููู ุงููุญููุธุฉ - ูุญุฏุซุฉ
function loadTeacherAccounts() {
    try {
        const stored = StorageManager.getItem('teacherAccounts');
        if (stored && typeof stored === 'object') {
            Object.assign(demoData.users, stored);
        } else {
            // ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
            StorageManager.setItem('teacherAccounts', demoData.users);
        }
    } catch (error) {
        ErrorHandler.logError(error, 'loadTeacherAccounts');
        // ุฅุนุงุฏุฉ ุชููุฆุฉ ุงูุจูุงูุงุช ูู ุญุงูุฉ ุงูุฎุทุฃ
        StorageManager.setItem('teacherAccounts', demoData.users);
    }
}

function checkAdminPermissions() {
    try {
        // 1. ุงูุจุญุซ ุนู ุนูุตุฑ ุฃุฏูุงุช ุงูุชุตุญูุญ ูู ุงูุตูุญุฉ
        const debugToolsSection = document.getElementById('debugToolsSection');
        
        // 2. ุฅุฐุง ูู ููุฌุฏ ุงูุนูุตุฑุ ูููู ุงูุชูููุฐ
        if (!debugToolsSection) {
            console.warn('ุนูุตุฑ ุฃุฏูุงุช ุงูุชุตุญูุญ ุบูุฑ ููุฌูุฏ');
            return;
        }
        
        // 3. ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ุงูุญุงูู ูู ุงููุณุคูู ุงููุญุฏุฏ
        if (currentUser && currentUser.email === 'chartgain2019@gmail.com') {
            // 4. ุฅุฐุง ูุงู ุงููุณุคููุ ูุธูุฑ ุงูุฃุฏูุงุช
            debugToolsSection.classList.remove('hidden');
            console.log('โ ุชู ุชูุนูู ุฃุฏูุงุช ุงูุชุตุญูุญ ูููุณุคูู');
        } else {
            // 5. ุฅุฐุง ูู ููู ุงููุณุคููุ ูุฎูู ุงูุฃุฏูุงุช
            debugToolsSection.classList.add('hidden');
        }
    } catch (error) {
        // 6. ูุนุงูุฌุฉ ุฃู ุฃุฎุทุงุก ูุฏ ุชุญุฏุซ
        ErrorHandler.logError(error, 'checkAdminPermissions');
    }
}

// ุญูุธ ุงููุชุงุฆุฌ ูู ุงูุชุฎุฒูู ุงููุญูู
function saveResult(result) {
    try {
        result.timestamp = Date.now();
        const results = loadResults();
        results.push(result);
        
        const success = StorageManager.setItem('testResults', results);
        if (!success) {
            throw new Error('Failed to save result to storage');
        }
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'saveResult');
        return false;
    }
}

async function searchSchools() {
    try {
        const searchTerm = document.getElementById('schoolSearch')?.value.toLowerCase().trim() || '';
        const resultsContainer = document.getElementById('schoolSearchResults');
        
        if (!resultsContainer) return;
        
        // ุฅุฎูุงุก ุงููุชุงุฆุฌ ุฅุฐุง ูุงู ุงูุจุญุซ ุฃูู ูู ุญุฑููู
        if (searchTerm.length < 2) {
            resultsContainer.classList.add('hidden');
            return;
        }
        
        console.log('๐ ุจุญุซ ุนู:', searchTerm);
        
        let allSchools = [];
        
        try {
            // ูุญุงููุฉ ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุฎุงุฏู
            const response = await fetch('https://quiz-system-api.onrender.com/api/all-schools', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                allSchools = Array.isArray(data) ? data : [];
                console.log('โ ุชู ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุฎุงุฏู:', allSchools.length, 'ูุฏุฑุณุฉ');
            } else {
                throw new Error(`ุฎุทุฃ ูู ุงูุงุณุชุฌุงุจุฉ: ${response.status}`);
            }
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู:', error);
            // ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ ูุจุฏูู
            allSchools = Object.values(demoData.schools).map(school => ({
                id: school.id,
                name: school.name,
                teacher: school.teacher
            }));
            console.log('๐ ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ:', allSchools.length, 'ูุฏุฑุณุฉ');
        }
        
        // ุงูุจุญุซ ูู ุงููุชุงุฆุฌ
        const matchingSchools = allSchools.filter(school => 
            school.name && school.name.toLowerCase().includes(searchTerm)
        );
        
        // ุนุฑุถ ุงููุชุงุฆุฌ
        if (matchingSchools.length === 0) {
            resultsContainer.innerHTML = '<div class="p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุทุงุจูุฉ</div>';
        } else {
            let resultsHTML = '';
            matchingSchools.forEach(school => {
                resultsHTML += `
                    <div class="p-4 border-b border-gray-200 hover:bg-blue-50 cursor-pointer transition-all" 
                         onclick="('${school.id}')">
                        <div class="font-bold text-gray-800">${school.name}</div>
                        <div class="text-sm text-gray-600">${school.teacher || 'ุบูุฑ ูุญุฏุฏ'}</div>
                    </div>
                `;
            });
            resultsContainer.innerHTML = resultsHTML;
        }
        
        resultsContainer.classList.remove('hidden');
        
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุงูุจุญุซ:', error);
        const resultsContainer = document.getElementById('schoolSearchResults');
        if (resultsContainer) {
            resultsContainer.innerHTML = '<div class="p-4 text-center text-red-500">ุฎุทุฃ ูู ุงูุจุญุซ</div>';
            resultsContainer.classList.remove('hidden');
        }
    }
}

async function selectSearchedSchool(schoolId) {
    try {
        const schoolSearch = document.getElementById('schoolSearch');
        const searchResults = document.getElementById('schoolSearchResults');
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        
        if (schoolSearch) schoolSearch.value = '';
        if (searchResults) searchResults.classList.add('hidden');
        
        console.log(`๐ซ ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงููุฏุฑุณุฉ: ${schoolId}`);
        
        let school = null;

// ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ ุฃููุงู (ุญูุซ ูุชู ุญูุธ ุงูุงุฎุชุจุงุฑุงุช ุงูุฌุฏูุฏุฉ)
school = demoData.schools[schoolId];

if (school && school.tests && school.tests.length > 0) {
    console.log('โ ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ ุงูุชู ุชุญุชูู ุนูู ุงูุงุฎุชุจุงุฑุงุช ุงูุฌุฏูุฏุฉ');
} else {
    console.log('โ ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุฉุ ุฌูุจ ูู ุงูุฎุงุฏู...');
    // ูุญุงููุฉ ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุฎุงุฏู ูุจุฏูู
    try {
        const response = await fetch(`https://quiz-system-api.onrender.com/api/tests/${schoolId}`);
        if (response.ok) {
            const tests = await response.json();
            school = {
                id: schoolId,
                name: 'ูุฏุฑุณุฉ ุงููููุฏ ุจู ุนูุงุฑุฉ ุงูุงุจุชุฏุงุฆูุฉ',
                teacher: 'ุฃ. ุนุจุฏุงููู ุงูุดูุฑู', 
                tests: tests
            };
            // ุญูุธ ุงูุจูุงูุงุช ูู ุงูุฎุงุฏู ูู ุงูุชุฎุฒูู ุงููุญูู
            demoData.schools[schoolId] = school;
            StorageManager.setItem('demoSchoolsData', demoData.schools);
        }
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุฎุงุฏู:', error);
    }
}
                console.log('โ ุชู ุฌูุจ ุงูุงุฎุชุจุงุฑุงุช ูู ุงูุฎุงุฏู:', tests);
                
                // ุญูุธ ุงูุจูุงูุงุช ูู demoData ูููุณุชูุจู
                demoData.schools[schoolId] = school;
                StorageManager.setItem('demoSchoolsData', demoData.schools);
                
            } else {
                console.error('โ ูุดู ูู ุฌูุจ ุงูุงุฎุชุจุงุฑุงุช ูู ุงูุฎุงุฏู');
                throw new Error('ูุดู ูู ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุฎุงุฏู');
            }
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุฎุงุฏู:', error);
            
            // ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ ูุจุฏูู
            school = demoData.schools[schoolId];
            
            if (!school) {
                console.warn('โ ุงููุฏุฑุณุฉ ุบูุฑ ููุฌูุฏุฉ ูู ุงูุจูุงูุงุช ุงููุญููุฉุ ุงุณุชุฎุฏุงู ุจูุงูุงุช ุงูุชุฑุงุถูุฉ');
                school = {
                    id: schoolId,
                    name: 'ูุฏุฑุณุฉ ุงููููุฏ ุจู ุนูุงุฑุฉ ุงูุงุจุชุฏุงุฆูุฉ',
                    teacher: 'ุฃ. ุนุจุฏุงููู ุงูุดูุฑู',
                    tests: [
                        {
                            name: 'ุงุฎุชุจุงุฑ ุงูุฑูุงุถูุงุช ุงููุตู ุงูุฃูู',
                            subject: 'ุงูุฑูุงุถูุงุช',
                            grade: 'ุงูุฑุงุจุน ุงุจุชุฏุงุฆู',
                            timerPerQuestion: 30,
                            questions: [
                                {
                                    question: 'ูุง ูู ูุงุชุฌ 15 + 27ุ',
                                    options: ['42', '32', '52', '37'],
                                    correct: 0
                                },
                                {
                                    question: 'ูุง ูู ุงูุนุฏุฏ ุงูุฐู ููุซู ุฎูุณุฉ ูุนุดุฑููุ',
                                    options: ['52', '25', '205', '250'],
                                    correct: 1
                                }
                            ]
                        },
                        {
                            name: 'ุงุฎุชุจุงุฑ ุงูุนููู ุงููุตู ุงูุฃูู', 
                            subject: 'ุงูุนููู',
                            grade: 'ุงูุฑุงุจุน ุงุจุชุฏุงุฆู',
                            timerPerQuestion: 30,
                            questions: [
                                {
                                    question: 'ุฃู ูู ูุฐู ุงูููุงูุจ ุฃูุฑุจ ุฅูู ุงูุดูุณุ',
                                    options: ['ุงูุฒูุฑุฉ', 'ุงููุฑูุฎ', 'ุนุทุงุฑุฏ', 'ุงูุฃุฑุถ'],
                                    correct: 2
                                }
                            ]
                        }
                    ]
                };
                
                // ุญูุธ ุงููุฏุฑุณุฉ ุงูุงูุชุฑุงุถูุฉ ูู ุงูุจูุงูุงุช ุงููุญููุฉ
                demoData.schools[schoolId] = school;
                StorageManager.setItem('demoSchoolsData', demoData.schools);
            }
        }
        
        // ุนุฑุถ ูุนูููุงุช ุงููุฏุฑุณุฉ
        if (selectedSchoolInfo && school) {
            selectedSchoolInfo.dataset.schoolId = school.id;
            selectedSchoolInfo.classList.remove('hidden');
            
            // ุชุญุฏูุซ ูุนูููุงุช ุงููุฏุฑุณุฉ
            const chosenSchoolName = document.getElementById('chosenSchoolName');
            const chosenTeacher = document.getElementById('chosenTeacher');
            
            if (chosenSchoolName) chosenSchoolName.textContent = school.name;
            if (chosenTeacher) chosenTeacher.textContent = school.teacher;
            
            // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช
            const testSelect = document.getElementById('testSelect');
            if (testSelect) {
                testSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุงุฎุชุจุงุฑ</option>';
                
                // ุงูุชุญูู ูู ูุฌูุฏ ุงูุงุฎุชุจุงุฑุงุช ูุตุญุชูุง
                if (school.tests && Array.isArray(school.tests) && school.tests.length > 0) {
                    let validTestsCount = 0;
                    
                    school.tests.forEach((test, index) => {
                        // ุงูุชุญูู ูู ุฃู ุงูุงุฎุชุจุงุฑ ูุญุชูู ุนูู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
                        if (test && test.name && test.subject && test.grade) {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
                            option.dataset.testIndex = index;
                            testSelect.appendChild(option);
                            validTestsCount++;
                        } else {
                            console.warn(`โ๏ธ ุงุฎุชุจุงุฑ ุบูุฑ ุตุงูุญ ูู ุงูููุฑุณ ${index}:`, test);
                        }
                    });
                    
                    if (validTestsCount === 0) {
                        testSelect.innerHTML = '<option value="">ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ุตุงูุญุฉ</option>';
                        console.warn('โ ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ุตุงูุญุฉ ูู ุงููุฏุฑุณุฉ');
                    } else {
                        console.log(`โ ุชู ุชุญููู ${validTestsCount} ุงุฎุชุจุงุฑ ุตุงูุญ`);
                    }
                } else {
                    testSelect.innerHTML = '<option value="">ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช</option>';
                    console.warn('โ ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ูููุฏุฑุณุฉ ุฃู ุงูุจูุงูุงุช ุบูุฑ ุตุงูุญุฉ');
                }
                
                // ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุฐุฌ ุงูุฃุฎุฑู
                const testInfo = document.getElementById('testInfo');
                const studentForm = document.getElementById('studentForm');
                
                if (testInfo) testInfo.classList.add('hidden');
                if (studentForm) studentForm.classList.add('hidden');
            }
        } else {
            console.error('โ ุนูุงุตุฑ ุงูุนุฑุถ ุบูุฑ ููุฌูุฏุฉ');
            alert('โ ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงููุฏุฑุณุฉ');
        }
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญููู ุงููุฏุฑุณุฉ:', error);
        ErrorHandler.logError(error, 'selectSearchedSchool');
        
        // ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูููุณุชุฎุฏู
        alert('โ ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงููุฏุฑุณุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
        
        // ุฅุฎูุงุก ูุชุงุฆุฌ ุงูุจุญุซ
        const searchResults = document.getElementById('schoolSearchResults');
        if (searchResults) searchResults.classList.add('hidden');
    }
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุนุฑุถ ูุนูููุงุช ุงููุฏุฑุณุฉ
function displaySchoolInfo(school) {
    const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
    
    if (selectedSchoolInfo) {
        selectedSchoolInfo.dataset.schoolId = school.id;
        
        // ุนุฑุถ ูุนูููุงุช ุงููุฏุฑุณุฉ ุงููุฎุชุงุฑุฉ
        selectedSchoolInfo.classList.remove('hidden');
        document.getElementById('chosenSchoolName').textContent = school.name;
        document.getElementById('chosenTeacher').textContent = school.teacher;
        
        // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช
        const testSelect = document.getElementById('testSelect');
        if (testSelect) {
            testSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุงุฎุชุจุงุฑ</option>';
            
            if (school.tests && school.tests.length > 0) {
                school.tests.forEach((test, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
                    testSelect.appendChild(option);
                });
            } else {
                testSelect.innerHTML = '<option value="">ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช</option>';
            }
        }
    }
}

// ูุธุงุฆู ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ
function showStudentAccess() {
    try {
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('studentAccessScreen').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showStudentAccess');
    }
}

function showTeacherLogin() {
    try {
        document.getElementById('teacherLoginScreen').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherLogin');
    }
}

function closeTeacherLogin() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        const loginError = document.getElementById('loginError');
        if (loginError) loginError.classList.add('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'closeTeacherLogin');
    }
}

function goBackToWelcome() {
    try {
        // ุชูุธูู ุงูููุงุฑุฏ ุฃููุงู
        ResourceManager.cleanup();
        
        // ุฅุฎูุงุก ุฌููุน ุงูุดุงุดุงุช
        const screens = [
            'studentAccessScreen',
            'teacherDashboard', 
            'testScreen',
            'resultsScreen'
        ];
        
        screens.forEach(screen => {
            const element = document.getElementById(screen);
            if (element) element.classList.add('hidden');
        });
        
        // ุฅุธูุงุฑ ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // ุฅุนุงุฏุฉ ุชุนููู ุญููู ุงูุจุญุซ
        const schoolSearch = document.getElementById('schoolSearch');
        const searchResults = document.getElementById('schoolSearchResults');
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        
        if (schoolSearch) schoolSearch.value = '';
        if (searchResults) searchResults.classList.add('hidden');
        if (selectedSchoolInfo) selectedSchoolInfo.classList.add('hidden');
        
        // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
        updateWelcomeStatistics();
    } catch (error) {
        ErrorHandler.logError(error, 'goBackToWelcome');
    }
}

// ูุธุงุฆู ุฅูุดุงุก ุญุณุงุจ ุงููุนูู
function showTeacherSignup() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        document.getElementById('teacherSignupScreen').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherSignup');
    }
}

function closeTeacherSignup() {
    try {
        document.getElementById('teacherSignupScreen').classList.add('hidden');
        const signupError = document.getElementById('signupError');
        const signupSuccess = document.getElementById('signupSuccess');
        const signupForm = document.getElementById('teacherSignupForm');
        
        if (signupError) signupError.classList.add('hidden');
        if (signupSuccess) signupSuccess.classList.add('hidden');
        if (signupForm) signupForm.reset();
    } catch (error) {
        ErrorHandler.logError(error, 'closeTeacherSignup');
    }
}
// ูุธุงุฆู ุฅูุดุงุก ุญุณุงุจ ุงููุนูู - ุงููุณุฎุฉ ุงููุนุฏูุฉ ููุฎุงุฏู
function showTeacherSignup() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        document.getElementById('teacherSignupScreen').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherSignup');
    }
}

function closeTeacherSignup() {
    try {
        document.getElementById('teacherSignupScreen').classList.add('hidden');
        const signupError = document.getElementById('signupError');
        const signupSuccess = document.getElementById('signupSuccess');
        const signupForm = document.getElementById('teacherSignupForm');
        
        if (signupError) signupError.classList.add('hidden');
        if (signupSuccess) signupSuccess.classList.add('hidden');
        if (signupForm) signupForm.reset();
    } catch (error) {
        ErrorHandler.logError(error, 'closeTeacherSignup');
    }
}

async function teacherSignup(event) {
    try {
        event.preventDefault();
        
        const name = DataValidator.sanitizeInput(document.getElementById('newTeacherName').value);
        const email = DataValidator.sanitizeInput(document.getElementById('newTeacherEmail').value);
        const school = DataValidator.sanitizeInput(document.getElementById('newTeacherSchool').value);
        const stage = document.getElementById('newTeacherStage').value;
        const password = document.getElementById('newTeacherPassword').value;
        const confirmPassword = document.getElementById('confirmTeacherPassword').value;
        
        const errorDiv = document.getElementById('signupError');
        const successDiv = document.getElementById('signupSuccess');
        
        // ุฅุฎูุงุก ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ
        if (errorDiv) errorDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
        
        // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
        const validationErrors = [];
        
        if (!DataValidator.validateEmail(email)) {
            validationErrors.push('ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุบูุฑ ุตุญูุญ');
        }
        
        const passwordError = DataValidator.validatePassword(password);
        if (passwordError) {
            validationErrors.push(passwordError);
        }
        
        if (password !== confirmPassword) {
            validationErrors.push('ูููุฉ ุงููุฑูุฑ ูุชุฃููุฏูุง ุบูุฑ ูุชุทุงุจูุชูู');
        }
        
        if (!stage) {
            validationErrors.push('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ');
        }
        
        if (validationErrors.length > 0) {
            if (errorDiv) {
                errorDiv.textContent = validationErrors.join('\n');
                errorDiv.classList.remove('hidden');
            }
            return false;
        }
        
        // ุงุณุชุฎุฏุงู API ููุชุณุฌูู
        const result = await APIService.register({
            name, email, password, school, stage
        });
        
        if (result.success) {
            if (successDiv) {
                successDiv.textContent = 'ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ! ููููู ุงูุขู ุชุณุฌูู ุงูุฏุฎูู';
                successDiv.classList.remove('hidden');
            }
            
            // ุงูุนูุฏุฉ ูุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู ุจุนุฏ 2 ุซุงููุฉ
            setTimeout(() => {
                closeTeacherSignup();
                showTeacherLogin();
            }, 2000);
        }
        
        return true;
    } catch (error) {
        const errorDiv = document.getElementById('signupError');
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
        }
        return false;
    }
}

// ุชุณุฌูู ุฏุฎูู ุงููุนูู - ุงููุณุฎุฉ ุงููุนุฏูุฉ ููุฎุงุฏู
async function teacherLogin(event) {
    try {
        event.preventDefault();
        
        const email = document.getElementById('teacherEmail').value;
        const password = document.getElementById('teacherPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        if (!errorDiv) {
            ErrorHandler.logError(new Error('Login error element not found'), 'teacherLogin');
            return false;
        }
        
        // ุงุณุชุฎุฏุงู API ูุชุณุฌูู ุงูุฏุฎูู
        const result = await APIService.login({ email, password });
        
        if (result.success) {
            currentUser = result.user;
            closeTeacherLogin();
            showTeacherDashboard();
            return true;
        } else {
            errorDiv.textContent = result.error || 'ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ';
            errorDiv.classList.remove('hidden');
            return false;
        }
    } catch (error) {
        const errorDiv = document.getElementById('loginError');
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
        }
        return false;
    }
}

// ุฏุงูุฉ ูุชุญููู ุงููุฏุงุฑุณ ูููุนูููู ุงููุณุฌููู ูุณุจูุงู
function loadSchoolsForExistingTeachers() {
    try {
        console.log('ุจุฏุก ุชุญููู ุงููุฏุงุฑุณ ูููุนูููู ุงูุญุงูููู...');
        
        // ุฅุถุงูุฉ ูุฏุงุฑุณ ูุฌููุน ุงููุนูููู ุงููุณุฌููู
        for (const email in demoData.users) {
            const teacher = demoData.users[email];
            let teacherHasSchool = false;
            
            // ุงูุชุญูู ุฅุฐุง ูุงู ูููุนูู ูุฏุฑุณุฉ ูุณุฌูุฉ
            for (const schoolId in demoData.schools) {
                if (demoData.schools[schoolId].teacher === teacher.name) {
                    teacherHasSchool = true;
                    console.log('ุงููุนูู ูุฏูู ูุฏุฑุณุฉ ูุณุฌูุฉ:', teacher.name);
                    break;
                }
            }
            
            // ุฅุฐุง ูู ููู ูููุนูู ูุฏุฑุณุฉุ ูู ุจุฅูุดุงุก ูุงุญุฏุฉ
            if (!teacherHasSchool && teacher.school) {
                const newSchoolId = 'school_' + Date.now() + '_' + email;
                demoData.schools[newSchoolId] = {
                    id: newSchoolId,
                    name: teacher.school,
                    teacher: teacher.name,
                    tests: []
                };
                
                console.log('ุชู ุฅูุดุงุก ูุฏุฑุณุฉ ุฌุฏูุฏุฉ ูููุนูู:', teacher.name, '- ุงููุฏุฑุณุฉ:', teacher.school);
            }
        }
        
        // ุญูุธ ุงูุชุญุฏูุซุงุช ูู ุงูุชุฎุฒูู ุงููุญูู
        if (Object.keys(demoData.schools).length > 0) {
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            console.log('ุชู ุญูุธ ุจูุงูุงุช ุงููุฏุงุฑุณ:', Object.keys(demoData.schools).length, 'ูุฏุฑุณุฉ');
        }
    } catch (error) {
        ErrorHandler.logError(error, 'loadSchoolsForExistingTeachers');
    }
}

// ุชุณุฌูู ุฏุฎูู ุงููุนูู
// ูุธุงุฆู ุฅูุดุงุก ุญุณุงุจ ุงููุนูู - ุงููุณุฎุฉ ุงููุนุฏูุฉ ููุฎุงุฏู
function showTeacherSignup() {
    try {
        document.getElementById('teacherLoginScreen').classList.add('hidden');
        document.getElementById('teacherSignupScreen').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherSignup');
    }
}

function closeTeacherSignup() {
    try {
        document.getElementById('teacherSignupScreen').classList.add('hidden');
        const signupError = document.getElementById('signupError');
        const signupSuccess = document.getElementById('signupSuccess');
        const signupForm = document.getElementById('teacherSignupForm');
        
        if (signupError) signupError.classList.add('hidden');
        if (signupSuccess) signupSuccess.classList.add('hidden');
        if (signupForm) signupForm.reset();
    } catch (error) {
        ErrorHandler.logError(error, 'closeTeacherSignup');
    }
}

async function teacherSignup(event) {
    try {
        event.preventDefault();
        
        const name = DataValidator.sanitizeInput(document.getElementById('newTeacherName').value);
        const email = DataValidator.sanitizeInput(document.getElementById('newTeacherEmail').value);
        const school = DataValidator.sanitizeInput(document.getElementById('newTeacherSchool').value);
        const stage = document.getElementById('newTeacherStage').value;
        const password = document.getElementById('newTeacherPassword').value;
        const confirmPassword = document.getElementById('confirmTeacherPassword').value;
        
        const errorDiv = document.getElementById('signupError');
        const successDiv = document.getElementById('signupSuccess');
        
        // ุฅุฎูุงุก ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ
        if (errorDiv) errorDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
        
        // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
        const validationErrors = [];
        
        if (!DataValidator.validateEmail(email)) {
            validationErrors.push('ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุบูุฑ ุตุญูุญ');
        }
        
        const passwordError = DataValidator.validatePassword(password);
        if (passwordError) {
            validationErrors.push(passwordError);
        }
        
        if (password !== confirmPassword) {
            validationErrors.push('ูููุฉ ุงููุฑูุฑ ูุชุฃููุฏูุง ุบูุฑ ูุชุทุงุจูุชูู');
        }
        
        if (!stage) {
            validationErrors.push('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ');
        }
        
        if (validationErrors.length > 0) {
            if (errorDiv) {
                errorDiv.textContent = validationErrors.join('\n');
                errorDiv.classList.remove('hidden');
            }
            return false;
        }
        
        // ุงุณุชุฎุฏุงู API ููุชุณุฌูู
        const result = await APIService.register({
            name, email, password, school, stage
        });
        
        if (result.success) {
            if (successDiv) {
                successDiv.textContent = 'ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ! ููููู ุงูุขู ุชุณุฌูู ุงูุฏุฎูู';
                successDiv.classList.remove('hidden');
            }
            
            // ุงูุนูุฏุฉ ูุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู ุจุนุฏ 2 ุซุงููุฉ
            setTimeout(() => {
                closeTeacherSignup();
                showTeacherLogin();
            }, 2000);
        }
        
        return true;
    } catch (error) {
        const errorDiv = document.getElementById('signupError');
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
        }
        return false;
    }
}

// ุชุณุฌูู ุฏุฎูู ุงููุนูู - ุงููุณุฎุฉ ุงููุนุฏูุฉ ููุฎุงุฏู
async function teacherLogin(event) {
    try {
        event.preventDefault();
        
        const email = document.getElementById('teacherEmail').value;
        const password = document.getElementById('teacherPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        if (!errorDiv) {
            ErrorHandler.logError(new Error('Login error element not found'), 'teacherLogin');
            return false;
        }
        
        // ุงุณุชุฎุฏุงู API ูุชุณุฌูู ุงูุฏุฎูู
        const result = await APIService.login({ email, password });
        
        if (result.success) {
            currentUser = result.user;
            closeTeacherLogin();
            showTeacherDashboard();
            return true;
        } else {
            errorDiv.textContent = result.error || 'ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ';
            errorDiv.classList.remove('hidden');
            return false;
        }
    } catch (error) {
        const errorDiv = document.getElementById('loginError');
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
        }
        return false;
    }
}

function teacherLogout() {
    try {
        // ุชูุธูู ุงูููุงุฑุฏ
        ResourceManager.cleanup();
        SystemRecovery.clearSession();
        
        currentUser = null;
        document.getElementById('teacherDashboard').classList.add('hidden');
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
        updateWelcomeStatistics();
    } catch (error) {
        ErrorHandler.logError(error, 'teacherLogout');
    }
}

function selectTest() {
    try {
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const testSelect = document.getElementById('testSelect');
        
        if (!selectedSchoolInfo || !testSelect) {
            console.warn('Required elements not found for selectTest');
            return;
        }
        
        const schoolId = selectedSchoolInfo.dataset.schoolId;
        const testIndex = testSelect.value;
        
        if (!schoolId || testIndex === '') {
            const testInfo = document.getElementById('testInfo');
            const studentForm = document.getElementById('studentForm');
            
            if (testInfo) testInfo.classList.add('hidden');
            if (studentForm) studentForm.classList.add('hidden');
            return;
        }
        
        // ุงูุจุญุซ ุนู ุงููุฏุฑุณุฉ ูู ุงูุจูุงูุงุช ุงููุญููุฉ ุฃููุงู
        let school = demoData.schools[schoolId];
        
        // ุฅุฐุง ูู ุชูุฌุฏ ูู ุงูุจูุงูุงุช ุงููุญููุฉุ ุงุณุชุฎุฏู ุงูุจูุงูุงุช ูู ุงูุฎุงุฏู
        if (!school) {
            console.warn('ุงููุฏุฑุณุฉ ุบูุฑ ููุฌูุฏุฉ ูู ุงูุจูุงูุงุช ุงููุญููุฉุ ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ูู ุงูุฎุงุฏู');
            // ุฅูุดุงุก ูุงุฆู ูุฏุฑุณุฉ ูู ุงูุจูุงูุงุช ุงููุฎุฒูุฉ ูู ุงูุนูุตุฑ
            school = {
                id: schoolId,
                name: document.getElementById('chosenSchoolName')?.textContent || 'ูุฏุฑุณุฉ ุบูุฑ ูุนุฑููุฉ',
                teacher: document.getElementById('chosenTeacher')?.textContent || 'ูุนูู ุบูุฑ ูุนุฑูู',
                tests: []
            };
        }
        
        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุงุฎุชุจุงุฑุงุช
        if (!school.tests || !Array.isArray(school.tests)) {
            console.error('ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ูููุฏุฑุณุฉ:', schoolId);
            const testInfo = document.getElementById('testInfo');
            const studentForm = document.getElementById('studentForm');
            
            if (testInfo) {
                testInfo.innerHTML = `
                    <h3 class="font-bold text-red-800 mb-4">โ๏ธ ุฎุทุฃ ูู ุงูุจูุงูุงุช</h3>
                    <div class="text-red-600">
                        ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ูุชุงุญุฉ ููุฐู ุงููุฏุฑุณุฉ ุญุงููุงู.
                    </div>
                `;
                testInfo.classList.remove('hidden');
            }
            if (studentForm) studentForm.classList.add('hidden');
            return;
        }
        
        const test = school.tests[testIndex];
        
        if (!test) {
            console.error('ุงูุงุฎุชุจุงุฑ ุบูุฑ ููุฌูุฏ:', testIndex);
            const testInfo = document.getElementById('testInfo');
            const studentForm = document.getElementById('studentForm');
            
            if (testInfo) {
                testInfo.innerHTML = `
                    <h3 class="font-bold text-red-800 mb-4">โ๏ธ ุฎุทุฃ ูู ุงูุจูุงูุงุช</h3>
                    <div class="text-red-600">
                        ุงูุงุฎุชุจุงุฑ ุงููุญุฏุฏ ุบูุฑ ููุฌูุฏ.
                    </div>
                `;
                testInfo.classList.remove('hidden');
            }
            if (studentForm) studentForm.classList.add('hidden');
            return;
        }
        
        // ุชุญุฏูุซ ูุนูููุงุช ุงูุงุฎุชุจุงุฑ
        const testInfo = document.getElementById('testInfo');
        if (testInfo) {
            testInfo.innerHTML = `
                <h3 class="font-bold text-blue-800 mb-4">ูุนูููุงุช ุงูุงุฎุชุจุงุฑ</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-blue-600 font-semibold">๐ ุงููุงุฏุฉ:</span>
                        <span class="font-bold text-gray-800 mr-2">${test.subject || 'ุบูุฑ ูุญุฏุฏ'}</span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">โ ุนุฏุฏ ุงูุฃุณุฆูุฉ:</span>
                        <span class="font-bold text-gray-800 mr-2">${test.questions ? test.questions.length : 0}</span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">๐ ุงูุตู ุงูุฏุฑุงุณู:</span>
                        <span class="font-bold text-gray-800 mr-2">${test.grade || 'ุบูุฑ ูุญุฏุฏ'}</span>
                    </div>
                    <div>
                        <span class="text-blue-600 font-semibold">โฑ๏ธ ููุช ุงูุณุคุงู:</span>
                        <span class="font-bold text-gray-800 mr-2">${test.timerPerQuestion || 30} ุซุงููุฉ</span>
                    </div>
                </div>
            `;
            testInfo.classList.remove('hidden');
        }
        
        // ุชุนุจุฆุฉ ุงูุตู ุงูุฏุฑุงุณู ุชููุงุฆูุงู ูู ูููุฐุฌ ุงูุทุงูุจ
        const studentGradeSelect = document.getElementById('studentGrade');
        if (studentGradeSelect && test.grade) {
            studentGradeSelect.innerHTML = `<option value="${test.grade}" selected>${test.grade}</option>`;
        }
        
        const studentForm = document.getElementById('studentForm');
        if (studentForm) studentForm.classList.remove('hidden');
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู selectTest:', error);
        ErrorHandler.logError(error, 'selectTest');
        
        // ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูููุณุชุฎุฏู
        const testInfo = document.getElementById('testInfo');
        if (testInfo) {
            testInfo.innerHTML = `
                <h3 class="font-bold text-red-800 mb-4">โ๏ธ ุญุฏุซ ุฎุทุฃ</h3>
                <div class="text-red-600">
                    ุชุนุฐุฑ ุชุญููู ูุนูููุงุช ุงูุงุฎุชุจุงุฑ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.
                </div>
            `;
            testInfo.classList.remove('hidden');
        }
    }
}

// ุจุฏุก ุงูุงุฎุชุจุงุฑ
function startTest() {
    try {
        const name = DataValidator.sanitizeInput(document.getElementById('studentName')?.value || '');
        const studentGrade = document.getElementById('studentGrade')?.value || '';
        const studentClass = DataValidator.sanitizeInput(document.getElementById('studentClass')?.value || '');
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const testSelect = document.getElementById('testSelect');
        
        if (!selectedSchoolInfo || !testSelect) {
            alert('ุนูุงุตุฑ ุงููุธุงู ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุชุญุฏูุซ ุงูุตูุญุฉ.');
            return;
        }
        
        const schoolId = selectedSchoolInfo.dataset.schoolId;
        const testIndex = testSelect.value;
        
        // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
        const validation = DataValidator.validateStudentData({
            name: name,
            grade: studentGrade,
            class: studentClass
        });
        
        if (!validation.isValid) {
            alert(`ูุฑุฌู ุชุตุญูุญ ุงูุฃุฎุทุงุก ุงูุชุงููุฉ:\n${validation.errors.join('\n')}`);
            return;
        }
        
        if (!schoolId || testIndex === '') {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุฏุฑุณุฉ ูุงูุงุฎุชุจุงุฑ ุฃููุงู');
            return;
        }
        
        const school = demoData.schools[schoolId];
        if (!school) {
            alert('ุงููุฏุฑุณุฉ ุงููุญุฏุฏุฉ ุบูุฑ ููุฌูุฏุฉ');
            return;
        }
        
        currentTest = school.tests[testIndex];
        if (!currentTest) {
            alert('ุงูุงุฎุชุจุงุฑ ุงููุญุฏุฏ ุบูุฑ ููุฌูุฏ');
            return;
        }
        
        // ุงูุชุญูู ูู ุตุญุฉ ุจูุงูุงุช ุงูุงุฎุชุจุงุฑ
        const testValidation = DataValidator.validateTestData(currentTest);
        if (!testValidation.isValid) {
            alert(`ุฎุทุฃ ูู ุจูุงูุงุช ุงูุงุฎุชุจุงุฑ:\n${testValidation.errors.join('\n')}`);
            return;
        }
        
        studentData = {
            name: name,
            grade: studentGrade,
            class: studentClass,
            score: 0,
            answers: [],
            school: school.name,
            teacher: school.teacher
        };
        
        currentQuestionIndex = 0;
        
        document.getElementById('studentAccessScreen').classList.add('hidden');
        document.getElementById('testScreen').classList.remove('hidden');
        
        updateTestInfo();
        showQuestion();
        
        // ุญูุธ ุญุงูุฉ ุงูุฌูุณุฉ
        SystemRecovery.saveSession({
            testInProgress: true,
            studentData: studentData,
            currentTest: currentTest.name,
            currentQuestionIndex: currentQuestionIndex
        });
    } catch (error) {
        ErrorHandler.logError(error, 'startTest');
        alert('ูุดู ูู ุจุฏุก ุงูุงุฎุชุจุงุฑ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

function updateTestInfo() {
    try {
        const elements = {
            testSchoolName: document.getElementById('testSchoolName'),
            testSubjectName: document.getElementById('testSubjectName'),
            testGradeLevel: document.getElementById('testGradeLevel'),
            testStudentName: document.getElementById('testStudentName'),
            totalQuestions: document.getElementById('totalQuestions')
        };
        
        if (elements.testSchoolName) elements.testSchoolName.textContent = studentData.school;
        if (elements.testSubjectName) elements.testSubjectName.textContent = currentTest.subject;
        if (elements.testGradeLevel) elements.testGradeLevel.textContent = currentTest.grade;
        if (elements.testStudentName) elements.testStudentName.textContent = studentData.name;
        if (elements.totalQuestions) elements.totalQuestions.textContent = currentTest.questions.length;
    } catch (error) {
        ErrorHandler.logError(error, 'updateTestInfo');
    }
}

// ุนุฑุถ ุงูุณุคุงู
function showQuestion() {
    try {
        if (currentQuestionIndex >= currentTest.questions.length) {
            endTest();
            return;
        }
        
        const question = currentTest.questions[currentQuestionIndex];
        
        const currentQuestionElement = document.getElementById('currentQuestion');
        const currentScoreElement = document.getElementById('currentScore');
        const questionTextElement = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedbackArea = document.getElementById('feedbackArea');
        const progressBar = document.getElementById('progressBar');
        
        if (currentQuestionElement) currentQuestionElement.textContent = currentQuestionIndex + 1;
        if (currentScoreElement) currentScoreElement.textContent = studentData.score;
        if (questionTextElement) questionTextElement.textContent = question.question;
        
        if (optionsContainer) {
            optionsContainer.innerHTML = '';
            
            const optionLabels = ['ุฃ', 'ุจ', 'ุฌ', 'ุฏ'];
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn bg-gray-50 hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 p-4 rounded-xl text-right transition-all';
                button.onclick = () => selectAnswer(index);
                button.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">${optionLabels[index]}</span>
                        <span class="flex-1">${option}</span>
                    </div>
                `;
                optionsContainer.appendChild(button);
            });
        }
        
        if (feedbackArea) {
            feedbackArea.classList.add('hidden');
        }
        
        // ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู
        if (progressBar) {
            const progress = ((currentQuestionIndex + 1) / currentTest.questions.length) * 100;
            progressBar.style.width = progress + '%';
        }
        
        startTimer();
        
        // ุชุญุฏูุซ ุงูุฌูุณุฉ
        SystemRecovery.saveSession({
            testInProgress: true,
            studentData: studentData,
            currentTest: currentTest.name,
            currentQuestionIndex: currentQuestionIndex
        });
    } catch (error) {
        ErrorHandler.logError(error, 'showQuestion');
    }
}

function startTimer() {
    try {
        // ุชูุธูู ุงููุคูุช ุงูุณุงุจู
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
        }
        
        // ุงุณุชุฎุฏุงู ููุช ุงููุคูุช ุงููุฎุตุต ููุงุฎุชุจุงุฑ ุฃู ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ 30 ุซุงููุฉ
        timeLeft = currentTest.timerPerQuestion || 30;
        const timerElement = document.getElementById('timer');
        if (!timerElement) return;
        
        timerElement.textContent = timeLeft;
        timerElement.className = 'inline-block bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-2xl font-bold';
        
        timer = setInterval(() => {
            timeLeft--;
            timerElement.textContent = timeLeft;
            
            // ุชุบููุฑ ููู ุงููุคูุช ุนูุฏูุง ูุตู ุฅูู ุฑุจุน ุงูููุช ุงููุชุจูู
            const warningTime = Math.ceil((currentTest.timerPerQuestion || 30) / 4);
            if (timeLeft <= warningTime) {
                timerElement.className = 'inline-block bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-full text-2xl font-bold pulse-red';
            }
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                ResourceManager.timers.delete(timer);
                timer = null;
                timeUp();
            }
        }, 1000);
        
        ResourceManager.addTimer(timer);
    } catch (error) {
        ErrorHandler.logError(error, 'startTimer');
    }
}

function selectAnswer(selectedIndex) {
    try {
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        const question = currentTest.questions[currentQuestionIndex];
        const isCorrect = selectedIndex === question.correct;
        
        studentData.answers.push({
            questionIndex: currentQuestionIndex,
            selected: selectedIndex,
            correct: question.correct,
            isCorrect: isCorrect
        });
        
        if (isCorrect) {
            studentData.score++;
        }
        
        showFeedback(selectedIndex, question.correct, isCorrect);
        disableOptions();
        
        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
        }, 2000);
    } catch (error) {
        ErrorHandler.logError(error, 'selectAnswer');
    }
}

function timeUp() {
    try {
        const question = currentTest.questions[currentQuestionIndex];
        
        studentData.answers.push({
            questionIndex: currentQuestionIndex,
            selected: -1,
            correct: question.correct,
            isCorrect: false
        });
        
        showTimeUpFeedback(question.correct);
        disableOptions();
        
        setTimeout(() => {
            currentQuestionIndex++;
            showQuestion();
        }, 2000);
    } catch (error) {
        ErrorHandler.logError(error, 'timeUp');
    }
}

function showFeedback(selectedIndex, correctIndex, isCorrect) {
    try {
        const feedbackArea = document.getElementById('feedbackArea');
        const options = document.querySelectorAll('.option-btn');
        
        if (!feedbackArea) return;
        
        if (isCorrect) {
            feedbackArea.innerHTML = '<div class="text-green-600 font-bold text-xl">โ ุฃุญุณูุช! ุฅุฌุงุจุฉ ุตุญูุญุฉ</div>';
            feedbackArea.className = 'text-center p-4 rounded-xl mb-6 bg-green-50 border border-green-200';
            if (options[selectedIndex]) {
                options[selectedIndex].className = 'option-btn bg-green-100 border-2 border-green-500 p-4 rounded-xl text-right';
            }
        } else {
            feedbackArea.innerHTML = '<div class="text-red-600 font-bold text-xl">โ ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ - ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: ' + currentTest.questions[currentQuestionIndex].options[correctIndex] + '</div>';
            feedbackArea.className = 'text-center p-4 rounded-xl mb-6 bg-red-50 border border-red-200';
            if (options[selectedIndex]) {
                options[selectedIndex].className = 'option-btn bg-red-100 border-2 border-red-500 p-4 rounded-xl text-right';
            }
            if (options[correctIndex]) {
                options[correctIndex].className = 'option-btn bg-green-100 border-2 border-green-500 p-4 rounded-xl text-right';
            }
        }
        
        feedbackArea.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showFeedback');
    }
}

function showTimeUpFeedback(correctIndex) {
    try {
        const feedbackArea = document.getElementById('feedbackArea');
        const options = document.querySelectorAll('.option-btn');
        
        if (!feedbackArea) return;
        
        feedbackArea.innerHTML = '<div class="text-orange-600 font-bold text-xl">โฐ ุงูุชูู ุงูููุช! ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: ' + currentTest.questions[currentQuestionIndex].options[correctIndex] + '</div>';
        feedbackArea.className = 'text-center p-4 rounded-xl mb-6 bg-orange-50 border border-orange-200';
        
        if (options[correctIndex]) {
            options[correctIndex].className = 'option-btn bg-green-100 border-2 border-green-500 p-4 rounded-xl text-right';
        }
        
        feedbackArea.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showTimeUpFeedback');
    }
}

function disableOptions() {
    try {
        const options = document.querySelectorAll('.option-btn');
        options.forEach(option => {
            option.disabled = true;
            option.onclick = null;
            option.style.cursor = 'not-allowed';
        });
    } catch (error) {
        ErrorHandler.logError(error, 'disableOptions');
    }
}

// ุฅููุงุก ุงูุงุฎุชุจุงุฑ
function endTest() {
    try {
        // ุชูุธูู ุงููุคูุช
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        const percentage = Math.round((studentData.score / currentTest.questions.length) * 100);
        let grade = '';
        
        if (percentage >= 90) grade = 'ููุชุงุฒ';
        else if (percentage >= 80) grade = 'ุฌูุฏ ุฌุฏุงู';
        else if (percentage >= 70) grade = 'ุฌูุฏ';
        else if (percentage >= 60) grade = 'ููุจูู';
        else grade = 'ุถุนูู';
        
        // ุญูุธ ุงููุชูุฌุฉ
        const result = {
            id: Date.now(),
            name: studentData.name,
            grade: studentData.grade,
            class: studentData.class,
            school: studentData.school,
            teacher: studentData.teacher,
            test: currentTest.name,
            subject: currentTest.subject,
            score: studentData.score,
            total: currentTest.questions.length,
            percentage: percentage,
            gradeLevel: grade,
            date: new Date().toLocaleDateString('ar-SA'),
            answers: studentData.answers,
            timestamp: Date.now()
        };
        
        const saveSuccess = saveResult(result);
        
        if (!saveSuccess) {
            alert('ูุดู ูู ุญูุธ ุงููุชูุฌุฉ. ูุฑุฌู ุงูุชูุงุตู ูุน ุงููุณุคูู.');
        }
        
        document.getElementById('testScreen').classList.add('hidden');
        document.getElementById('resultsScreen').classList.remove('hidden');
        
        const finalScoreElement = document.getElementById('finalScore');
        const percentageElement = document.getElementById('percentage');
        const gradeElement = document.getElementById('grade');
        
        if (finalScoreElement) finalScoreElement.textContent = studentData.score + ' ูู ' + currentTest.questions.length;
        if (percentageElement) percentageElement.textContent = percentage + '%';
        if (gradeElement) gradeElement.textContent = grade;
        
        // ุชูุธูู ุงูุฌูุณุฉ
        SystemRecovery.clearSession();
    } catch (error) {
        ErrorHandler.logError(error, 'endTest');
    }
}

// ูุธุงุฆู ุงููุชุงุฆุฌ
function shareWhatsApp() {
    try {
        const percentage = Math.round((studentData.score / currentTest.questions.length) * 100);
        let grade = '';
        
        if (percentage >= 90) grade = 'ููุชุงุฒ';
        else if (percentage >= 80) grade = 'ุฌูุฏ ุฌุฏุงู';
        else if (percentage >= 70) grade = 'ุฌูุฏ';
        else if (percentage >= 60) grade = 'ููุจูู';
        else grade = 'ุถุนูู';
        
        const message = `๐ ุฃุชููุช ุงูุงุฎุชุจุงุฑ: ${currentTest.name}\n๐ ุงูุทุงูุจ: ${studentData.name}\n\n๐ ูู ูุงุฏุฉ: ${currentTest.subject}\n๐ ุงููุชูุฌุฉ: ${studentData.score} ูู ${currentTest.questions.length}\n๐ ุงููุณุจุฉ: ${percentage}%\n๐ ุงูุชูุฏูุฑ: ${grade}\n๐ ุงูุตู: ${studentData.grade}\n\n#${studentData.school}`;
        
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
    } catch (error) {
        ErrorHandler.logError(error, 'shareWhatsApp');
    }
}

function retakeTest() {
    try {
        studentData.score = 0;
        studentData.answers = [];
        currentQuestionIndex = 0;
        
        document.getElementById('resultsScreen').classList.add('hidden');
        document.getElementById('testScreen').classList.remove('hidden');
        
        showQuestion();
    } catch (error) {
        ErrorHandler.logError(error, 'retakeTest');
    }
}

function goBackToSchoolSelection() {
    try {
        document.getElementById('testScreen').classList.add('hidden');
        document.getElementById('resultsScreen').classList.add('hidden');
        document.getElementById('studentAccessScreen').classList.remove('hidden');
        
        // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const schoolSearch = document.getElementById('schoolSearch');
        
        if (selectedSchoolInfo) selectedSchoolInfo.classList.add('hidden');
        if (schoolSearch) schoolSearch.value = '';
    } catch (error) {
        ErrorHandler.logError(error, 'goBackToSchoolSelection');
    }
}

// ูุธุงุฆู ุงูุฎุฑูุฌ ูู ุงูุงุฎุชุจุงุฑ
function confirmExitTest() {
    try {
        document.getElementById('exitTestModal').classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'confirmExitTest');
    }
}

function cancelExitTest() {
    try {
        document.getElementById('exitTestModal').classList.add('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'cancelExitTest');
    }
}

function exitTest() {
    try {
        // ุชูุธูู ุฌููุน ุงูููุงุฑุฏ
        if (timer) {
            clearInterval(timer);
            ResourceManager.timers.delete(timer);
            timer = null;
        }
        
        ResourceManager.cleanup();
        SystemRecovery.clearSession();
        
        currentTest = null;
        currentQuestionIndex = 0;
        studentData = { name: '', grade: '', class: '', score: 0, answers: [] };
        
        document.getElementById('exitTestModal').classList.add('hidden');
        document.getElementById('testScreen').classList.add('hidden');
        document.getElementById('welcomeScreen').classList.remove('hidden');
        
        // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
        updateWelcomeStatistics();
    } catch (error) {
        ErrorHandler.logError(error, 'exitTest');
    }
}

// ========== ุฏูุงู ุงูุดูุงุฏุฉ Canvas ุงููุญุณูุฉ ==========

async function generateCertificateImage(format) {
    try {
        showLoadingMessage('ุฌุงุฑู ุฅูุดุงุก ุงูุดูุงุฏุฉ...');
        
        // ุงูุงูุชุธุงุฑ ุญุชู ูุชู ุชุญููู ุงูุฎุทูุท ูุงูุตูุฑ
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const canvas = document.getElementById('certificateCanvas');
        if (!canvas) {
            throw new Error('Canvas element not found');
        }
        
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            throw new Error('Canvas context not available');
        }
        
        // ูุณุญ Canvas ุฃููุงู
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ========== ุงูุฎูููุฉ ุงูุฃุณุงุณูุฉ ==========
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#f8fafc');
        gradient.addColorStop(0.5, '#f0f4ff');
        gradient.addColorStop(1, '#fdf2ff');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ========== ุงูุฒุฎุงุฑู ุงูุฎูููุฉ ==========
        ctx.fillStyle = 'rgba(139, 92, 246, 0.03)';
        ctx.font = 'bold 120px Arial';
        ctx.textAlign = 'center';
        
        // ุฒุฎุงุฑู ููุฒุนุฉ ุจุดูู ูุชุณุงู
        ctx.fillText('๐', canvas.width/2, 350);
        ctx.fillText('โญ', canvas.width/4, 450);
        ctx.fillText('๐', canvas.width * 3/4, 400);
        ctx.fillText('๐', canvas.width/3, 1400);
        ctx.fillText('๐ซ', canvas.width * 2/3, 1500);
        ctx.fillText('๐ฏ', canvas.width/2, 2800);
        ctx.fillText('โจ', canvas.width/5, 2700);
        ctx.fillText('๐', canvas.width * 4/5, 2750);
        
        // ========== ุงูุฅุทุงุฑ ุงูุฎุงุฑุฌู ==========
        const borderGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        borderGradient.addColorStop(0, '#3b82f6');
        borderGradient.addColorStop(0.25, '#8b5cf6');
        borderGradient.addColorStop(0.5, '#ec4899');
        borderGradient.addColorStop(0.75, '#f59e0b');
        borderGradient.addColorStop(1, '#10b981');
        
        ctx.strokeStyle = borderGradient;
        ctx.lineWidth = 25;
        ctx.strokeRect(50, 50, canvas.width - 100, canvas.height - 100);
        
        // ุฅุทุงุฑ ุฏุงุฎูู ุฐูุจู
        ctx.strokeStyle = '#f59e0b';
        ctx.lineWidth = 8;
        ctx.strokeRect(100, 100, canvas.width - 200, canvas.height - 200);
        
        // ========== ุงูุนููุงู ุงูุฑุฆูุณู ==========
        const titleGradient = ctx.createLinearGradient(canvas.width/2 - 300, 200, canvas.width/2 + 300, 200);
        titleGradient.addColorStop(0, '#f59e0b');
        titleGradient.addColorStop(0.5, '#fbbf24');
        titleGradient.addColorStop(1, '#f59e0b');
        
        ctx.fillStyle = titleGradient;
        ctx.font = 'bold 140px "Cairo"';
        ctx.textAlign = 'center';
        ctx.fillText('ุดูุงุฏุฉ ุฅูุฌุงุฒ', canvas.width/2, 280);
        
        // ุงูุนููุงู ุจุงูุฅูุฌููุฒูุฉ
        ctx.fillStyle = '#6b7280';
        ctx.font = 'italic 45px "Cairo"';
        ctx.fillText('Certificate of Achievement', canvas.width/2, 380);
        
        // ุฎุท ุฒุฎุฑูู ุชุญุช ุงูุนููุงู
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 - 250, 410);
        ctx.lineTo(canvas.width/2 + 250, 410);
        ctx.stroke();
        
        // ========== ุงุณู ุงููุฏุฑุณุฉ ==========
        ctx.fillStyle = '#7c3aed';
        ctx.font = 'bold 75px "Cairo"';
        ctx.fillText(studentData.school, canvas.width/2, 530);
        
        // ========== ุงููุณู ุงูุฃูู: ุจูุงูุงุช ุงูุทุงูุจ ==========
        const section1Y = 700;
        
        // ุงููุต ุงูุชูููุฏู
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('ุชุดูุฏ ูุฐู ุงููุคุณุณุฉ ุงูุชุนููููุฉ ุจุฃู ุงูุทุงูุจ/ุฉ', canvas.width/2, section1Y);
        
        // ุงุณู ุงูุทุงูุจ
        const nameGradient = ctx.createLinearGradient(canvas.width/2 - 400, section1Y + 100, canvas.width/2 + 400, section1Y + 220);
        nameGradient.addColorStop(0, '#7c3aed');
        nameGradient.addColorStop(0.5, '#3b82f6');
        nameGradient.addColorStop(1, '#7c3aed');
        
        ctx.fillStyle = nameGradient;
        ctx.font = 'bold 120px "Cairo"';
        ctx.fillText(studentData.name, canvas.width/2, section1Y + 180);
        
        // ุฎุท ุชุญุช ุงุณู ุงูุทุงูุจ
        ctx.strokeStyle = '#c4b5fd';
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 - 350, section1Y + 210);
        ctx.lineTo(canvas.width/2 + 350, section1Y + 210);
        ctx.stroke();
        
        // ========== ุงููุณู ุงูุซุงูู: ุงููุนูููุงุช ุงูุฃูุงุฏูููุฉ ==========
        const section2Y = 1050;
        
        // ุงูุตู ูุงููุตู
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText(`ูู ุงูุตู ${studentData.grade} ูุงููุตู ${studentData.class}`, canvas.width/2, section2Y);
        
        // ุงููุต ุงูุชุงูู
        ctx.fillText('ูุฏ ุฃุชู ุจูุฌุงุญ', canvas.width/2, section2Y + 100);
        
        // ุงุณู ุงูุงุฎุชุจุงุฑ
        ctx.fillStyle = '#3b82f6';
        ctx.font = 'bold 70px "Cairo"';
        ctx.fillText(currentTest.name, canvas.width/2, section2Y + 200);
        
        // ุงููุงุฏุฉ
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('ูู ูุงุฏุฉ', canvas.width/2, section2Y + 300);
        
        ctx.fillStyle = '#10b981';
        ctx.font = 'bold 60px "Cairo"';
        ctx.fillText(currentTest.subject, canvas.width/2, section2Y + 380);
        
        // ========== ุงููุณู ุงูุซุงูุซ: ุงููุชุงุฆุฌ ==========
        const resultsBox = {
            x: canvas.width/2 - 450,
            y: 1550,
            width: 900,
            height: 280
        };
        
        // ุฎูููุฉ ุงููุฑุจุน
        ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
        ctx.strokeStyle = '#d1d5db';
        ctx.lineWidth = 3;
        
        // ุธู ูููุฑุจุน
        ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
        ctx.shadowBlur = 20;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 10;
        ctx.fillRect(resultsBox.x, resultsBox.y, resultsBox.width, resultsBox.height);
        ctx.shadowColor = 'transparent';
        ctx.strokeRect(resultsBox.x, resultsBox.y, resultsBox.width, resultsBox.height);
        
        // ุญุณุงุจ ุงููุณุจุฉ ูุงูุชูุฏูุฑ
        const percentage = Math.round((studentData.score / currentTest.questions.length) * 100);
        const grade = calculateGrade(percentage);
        
        // ุชูุณูู ุงููุฑุจุน ุฅูู 3 ุฃุฌุฒุงุก
        const sectionWidth = resultsBox.width / 3;
        
        // ุงูุฏุฑุฌุฉ
        ctx.fillStyle = '#3b82f6';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('ุงูุฏุฑุฌุฉ', resultsBox.x + sectionWidth/2, resultsBox.y + 90);
        ctx.font = 'bold 75px "Cairo"';
        ctx.fillText(`${studentData.score}/${currentTest.questions.length}`, resultsBox.x + sectionWidth/2, resultsBox.y + 180);
        
        // ุงููุณุจุฉ
        ctx.fillStyle = '#10b981';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('ุงููุณุจุฉ', resultsBox.x + sectionWidth + sectionWidth/2, resultsBox.y + 90);
        ctx.font = 'bold 75px "Cairo"';
        ctx.fillText(`${percentage}%`, resultsBox.x + sectionWidth + sectionWidth/2, resultsBox.y + 180);
        
        // ุงูุชูุฏูุฑ
        ctx.fillStyle = '#8b5cf6';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('ุงูุชูุฏูุฑ', resultsBox.x + 2 * sectionWidth + sectionWidth/2, resultsBox.y + 90);
        ctx.font = 'bold 65px "Cairo"';
        ctx.fillText(grade, resultsBox.x + 2 * sectionWidth + sectionWidth/2, resultsBox.y + 180);
        
        // ุฎุทูุท ูุงุตูุฉ
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(resultsBox.x + sectionWidth, resultsBox.y + 30);
        ctx.lineTo(resultsBox.x + sectionWidth, resultsBox.y + resultsBox.height - 30);
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(resultsBox.x + 2 * sectionWidth, resultsBox.y + 30);
        ctx.lineTo(resultsBox.x + 2 * sectionWidth, resultsBox.y + resultsBox.height - 30);
        ctx.stroke();
        
        // ========== ุงููุณู ุงูุฑุงุจุน: ุฑุณุงูุฉ ุชููุฆุฉ ููุณุนุฉ ==========
        const congratulationY = 1950;
        
        ctx.fillStyle = '#7c3aed';
        ctx.font = 'bold 65px "Cairo"';
        ctx.fillText('ูุจุฑูู ุนูู ุฅูุฌุงุฒู!', canvas.width/2, congratulationY);
        
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('ูุญู ููุชุฎุฑ ุจุฅูุฌุงุฒู ุงููุชููุฒ ููุณุฃู ุงููู ูู ุฏูุงู ุงูุชูููู ูุงููุฌุงุญ', canvas.width/2, congratulationY + 90);
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '42px "Cairo"';
        ctx.fillText('ูุชููู ูู ูุณุชูุจูุงู ุฒุงูุฑุงู ูููุฆุงู ุจุงูุฅูุฌุงุฒุงุช ูุงูุชููู', canvas.width/2, congratulationY + 180);
        
        // ========== ุงููุณู ุงูุฎุงูุณ: ุงูุชูููุนุงุช ==========
        const signaturesY = 2300;
        
        // ูุฏูุฑ ุงููุฏุฑุณุฉ (ุนูู ุงููููู)
        ctx.textAlign = 'right';
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('ูุฏูุฑ ุงููุฏุฑุณุฉ', 700, signaturesY);
        ctx.fillStyle = '#1f2937';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText('ุฃ. ุฎุงูุฏ ุงูุญูุฑูู', 700, signaturesY + 90);
        
        // ุฎุท ุงูุชูููุน
        ctx.strokeStyle = '#9ca3af';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(500, signaturesY + 130);
        ctx.lineTo(800, signaturesY + 130);
        ctx.stroke();
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '38px "Cairo"';
        ctx.fillText('ุงูุชูููุน', 650, signaturesY + 180);
        
        // ูุนูู ุงููุงุฏุฉ (ุนูู ุงููุณุงุฑ)
        ctx.textAlign = 'left';
        ctx.fillStyle = '#4b5563';
        ctx.font = '48px "Cairo"';
        ctx.fillText('ูุนูู ุงููุงุฏุฉ', canvas.width - 700, signaturesY);
        ctx.fillStyle = '#1f2937';
        ctx.font = 'bold 55px "Cairo"';
        ctx.fillText(studentData.teacher, canvas.width - 700, signaturesY + 90);
        
        // ุฎุท ุงูุชูููุน
        ctx.beginPath();
        ctx.moveTo(canvas.width - 800, signaturesY + 130);
        ctx.lineTo(canvas.width - 500, signaturesY + 130);
        ctx.stroke();
        
        ctx.fillStyle = '#6b7280';
        ctx.font = '38px "Cairo"';
        ctx.fillText('ุงูุชูููุน', canvas.width - 650, signaturesY + 180);
        
        // ========== ุงููุณู ุงูุณุงุฏุณ: ุงููุนูููุงุช ุงูุฅุถุงููุฉ ==========
        const infoY = 2650;
        
        ctx.textAlign = 'center';
        ctx.fillStyle = '#6b7280';
        ctx.font = '38px "Cairo"';
        const date = new Date().toLocaleDateString('ar-SA');
        ctx.fillText(`ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ: ${date}`, canvas.width/2, infoY);
        ctx.fillText(`ุฑูู ุงูุดูุงุฏุฉ: CERT-${Date.now()}`, canvas.width/2, infoY + 70);
        
        // ========== ุงููุณู ุงูุณุงุจุน: ุฒุฎุฑูุฉ ุฎุชุงููุฉ ==========
        const decorationY = 2850;
        
        // ุฎุท ุฒุฎุฑูู
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 - 300, decorationY);
        ctx.lineTo(canvas.width/2 + 300, decorationY);
        ctx.stroke();
        
        // ููุงุท ุฒุฎุฑููุฉ
        ctx.fillStyle = '#3b82f6';
        for (let i = -4; i <= 4; i++) {
            const x = canvas.width/2 + (i * 75);
            ctx.beginPath();
            ctx.arc(x, decorationY, 12, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // ุฑุณุงูุฉ ุดูุฑ
        ctx.fillStyle = '#4b5563';
        ctx.font = '42px "Cairo"';
        ctx.fillText('ุดูุฑุงู ูุฌููุฏูู ุงููุจุฐููุฉ', canvas.width/2, decorationY + 90);

        // ========== ุงูุฒุฎุฑูุฉ ุงูููุงุฆูุฉ ==========
        ctx.fillStyle = 'rgba(139, 92, 246, 0.1)';
        ctx.font = 'bold 130px Arial';
        ctx.fillText('๐', canvas.width/2, canvas.height - 150);

        // ุชุญููู Canvas ุฅูู ุตูุฑุฉ
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const imageData = canvas.toDataURL(`image/${format}`, 1.0);
        downloadImage(imageData, format);
        
        // ุชุญุฏูุซ ุงููุนุงููุฉ
        updateCertificatePreview(imageData);
        
        hideLoadingMessage();
        showSuccessMessage('ุชู ุฅูุดุงุก ุงูุดูุงุฏุฉ ุจูุฌุงุญ', `ุชู ุญูุธ ุงูุดูุงุฏุฉ ูุตูุฑุฉ ${format.toUpperCase()}`);
        
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุฅูุดุงุก ุงูุดูุงุฏุฉ:', error);
        hideLoadingMessage();
        showErrorMessage('ุฎุทุฃ ูู ุงูุฅูุดุงุก', 'ุชุนุฐุฑ ุฅูุดุงุก ุงูุดูุงุฏุฉ ูุตูุฑุฉ');
    }
}

// ุฏุงูุฉ ุญุณุงุจ ุงูุชูุฏูุฑ
function calculateGrade(percentage) {
    if (percentage >= 90) return 'ููุชุงุฒ';
    else if (percentage >= 80) return 'ุฌูุฏ ุฌุฏุงู';
    else if (percentage >= 70) return 'ุฌูุฏ';
    else if (percentage >= 60) return 'ููุจูู';
    else return 'ุถุนูู';
}

// ุฏุงูุฉ ุชุญููู ุงูุตูุฑุฉ
function downloadImage(imageData, format) {
    try {
        const downloadLink = document.createElement('a');
        const fileName = `ุดูุงุฏุฉ_${studentData.name}_${currentTest.name}_${new Date().toLocaleDateString('ar-SA')}.${format}`;
        
        downloadLink.href = imageData;
        downloadLink.download = fileName;
        
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    } catch (error) {
        ErrorHandler.logError(error, 'downloadImage');
    }
}

// ุฏุงูุฉ ุชุญุฏูุซ ูุนุงููุฉ ุงูุดูุงุฏุฉ
function updateCertificatePreview(imageData) {
    try {
        const preview = document.getElementById('certificatePreview');
        if (preview) {
            preview.innerHTML = `
                <div class="text-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">ูุนุงููุฉ ุงูุดูุงุฏุฉ ุงููุญุณูุฉ</h3>
                    <p class="text-gray-600">ุฌูุฏุฉ ุนุงููุฉ - ุชุตููู ุงุญุชุฑุงูู</p>
                </div>
                <img src="${imageData}" alt="ุดูุงุฏุฉ ุฅูุฌุงุฒ" class="w-full h-auto rounded-lg shadow-2xl border-4 border-gold-200 max-h-96 object-contain mx-auto">
                <div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                    <p class="text-green-700 text-sm"><strong>โ ุชู ุฅูุดุงุก ุงูุดูุงุฏุฉ ุจูุฌุงุญ:</strong> ุฌูุฏุฉ ุนุงููุฉ ุจุฏูุฉ 2480ร3508 ุจูุณู</p>
                </div>
            `;
        }
    } catch (error) {
        ErrorHandler.logError(error, 'updateCertificatePreview');
    }
}

// ุฏูุงู ุงูุฑุณุงุฆู
function showLoadingMessage(message) {
    try {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingOverlay';
        loadingDiv.className = 'loading-overlay';
        loadingDiv.innerHTML = `
            <div class="bg-white rounded-2xl p-8 text-center shadow-2xl">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-gray-800 font-semibold text-xl">${message}</p>
            </div>
        `;
        document.body.appendChild(loadingDiv);
    } catch (error) {
        ErrorHandler.logError(error, 'showLoadingMessage');
    }
}

function hideLoadingMessage() {
    try {
        const loadingDiv = document.getElementById('loadingOverlay');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'hideLoadingMessage');
    }
}

function showSuccessMessage(title, message) {
    try {
        const messageId = 'successMessage-' + Date.now();
        const messageHTML = `
            <div id="${messageId}" class="fixed top-4 left-4 right-4 bg-green-500 text-white p-4 rounded-xl shadow-lg z-50 flex items-center gap-3">
                <span class="text-2xl">โ</span>
                <div class="flex-1">
                    <div class="font-bold">${title}</div>
                    <div class="text-sm">${message}</div>
                </div>
                <button onclick="document.getElementById('${messageId}').remove()" class="text-white hover:text-gray-200">
                    โ
                </button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', messageHTML);
        
        setTimeout(() => {
            const element = document.getElementById(messageId);
            if (element) element.remove();
        }, 5000);
    } catch (error) {
        ErrorHandler.logError(error, 'showSuccessMessage');
    }
}

function showErrorMessage(title, message) {
    try {
        const messageId = 'errorMessage-' + Date.now();
        const messageHTML = `
            <div id="${messageId}" class="fixed top-4 left-4 right-4 bg-red-500 text-white p-4 rounded-xl shadow-lg z-50 flex items-center gap-3">
                <span class="text-2xl">โ</span>
                <div class="flex-1">
                    <div class="font-bold">${title}</div>
                    <div class="text-sm">${message}</div>
                </div>
                <button onclick="document.getElementById('${messageId}').remove()" class="text-white hover:text-gray-200">
                    โ
                </button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', messageHTML);
        
        setTimeout(() => {
            const element = document.getElementById(messageId);
            if (element) element.remove();
        }, 5000);
    } catch (error) {
        ErrorHandler.logError(error, 'showErrorMessage');
    }
}

// ========== ููุญุฉ ุชุญูู ุงููุนูู ุงููุญุณูุฉ ==========

function showTeacherDashboard() {
    try {
        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('teacherDashboard').classList.remove('hidden');
        
        // ุชุญุฏูุซ ูุนูููุงุช ุงููุนูู
        const teacherWelcome = document.getElementById('teacherWelcome');
        if (teacherWelcome) {
            teacherWelcome.textContent = `ูุฑุญุจุงู ${currentUser.name}`;
        }
        
        // ุชุญุฏูุซ ุจูุงูุงุช ุงููุฏุฑุณุฉ ูููุนูู ุงูุญุงูู
        updateTeacherSchoolData();
        
        // ุชุญููู ููุญุฉ ุงููุนูููุงุช
        loadDashboardData();
        
        // ุชุญููู ุงูุงุฎุชุจุงุฑุงุช
        loadTeacherTests();
        
        // ุชุญููู ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช ูููุชุฑ ุงูุฃุณุฆูุฉ
        loadTestSelectForQuestions();
        
        // ุชุญููู ุงููุชุงุฆุฌ
        loadResultsForTeacher();
        
        // ุชุญููู ุงูุฅุนุฏุงุฏุงุช
        loadTeacherSettings();
        
        // ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุคูู
        checkAdminPermissions();
       // ========== โฌ๏ธ ุฃุถู ูุฐุง ุงูุณุทุฑ โฌ๏ธ ==========
        autoFixTeacherOnLogin();
    } catch (error) {
        ErrorHandler.logError(error, 'showTeacherDashboard');
    }
}

function updateTeacherSchoolData() {
    try {
        // ุงูุจุญุซ ุนู ูุฏุฑุณุฉ ุงููุนูู ุงูุญุงูู
        let teacherSchool = null;
        
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === currentUser.name) {
                teacherSchool = demoData.schools[schoolId];
                currentManagingTestSchoolId = schoolId;
                break;
            }
        }
        
        // ุฅุฐุง ูู ุชูุฌุฏ ูุฏุฑุณุฉ ูููุนููุ ูู ุจุฅูุดุงุฆูุง
        if (!teacherSchool) {
            const newSchoolId = 'school_' + Date.now();
            teacherSchool = {
                id: newSchoolId,
                name: currentUser.school,
                teacher: currentUser.name,
                tests: []
            };
            
            demoData.schools[newSchoolId] = teacherSchool;
            currentManagingTestSchoolId = newSchoolId;
            
            // ุญูุธ ุงูุชุญุฏูุซุงุช
            StorageManager.setItem('demoSchoolsData', demoData.schools);
        }
        
        console.log('ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงููุฏุฑุณุฉ ูููุนูู:', currentUser.name);
    } catch (error) {
        ErrorHandler.logError(error, 'updateTeacherSchoolData');
    }
}

function showTab(tabName) {
    try {
        const tabs = ['dashboard', 'tests', 'questions', 'results', 'settings'];
        
        // ุชุญุฏูุซ ุงูุชุจููุจุงุช
        tabs.forEach(tab => {
            const tabBtn = document.getElementById(tab + 'Tab');
            const content = document.getElementById(tab + 'Content');
            
            if (tabBtn && content) {
                if (tab === tabName) {
                    tabBtn.classList.add('active', 'bg-white', 'text-blue-600');
                    tabBtn.classList.remove('bg-transparent', 'text-gray-600');
                    content.classList.remove('hidden');
                } else {
                    tabBtn.classList.remove('active', 'bg-white', 'text-blue-600');
                    tabBtn.classList.add('bg-transparent', 'text-gray-600');
                    content.classList.add('hidden');
                }
            }
        });
        
        // ุชุญููู ุงูุจูุงูุงุช ุงูุฎุงุตุฉ ุจูู ุชุจููุจ
        if (tabName === 'dashboard') {
            loadDashboardData();
        } else if (tabName === 'questions') {
            loadTestSelectForQuestions();
            // ุฅุนุงุฏุฉ ุชุนููู ุงููุชุบูุฑุงุช ุนูุฏ ุงูุชุจุฏูู ููุชุจููุจ
            draggedQuestion = null;
            dragOverQuestion = null;
        } else if (tabName === 'results') {
            loadResultsForTeacher();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'showTab');
    }
}

function loadDashboardData() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
        const totalTests = currentManagingTestSchoolId ? 
            demoData.schools[currentManagingTestSchoolId]?.tests.length || 0 : 0;
        const totalStudents = teacherResults.length;
        const totalScore = teacherResults.reduce((sum, result) => sum + result.percentage, 0);
        const averageScore = totalStudents > 0 ? Math.round(totalScore / totalStudents) : 0;
        const passRate = totalStudents > 0 ? 
            Math.round((teacherResults.filter(r => r.percentage >= 60).length / totalStudents) * 100) : 0;
        
        // ุชุญุฏูุซ ุงูุนูุงุตุฑ
        const elements = {
            totalTests: document.getElementById('totalTests'),
            totalStudents: document.getElementById('totalStudents'),
            averageScore: document.getElementById('averageScore'),
            passRate: document.getElementById('passRate'),
            totalAttempts: document.getElementById('totalAttempts'),
            highestScore: document.getElementById('highestScore'),
            lowestScore: document.getElementById('lowestScore')
        };
        
        if (elements.totalTests) elements.totalTests.textContent = totalTests;
        if (elements.totalStudents) elements.totalStudents.textContent = totalStudents;
        if (elements.averageScore) elements.averageScore.textContent = averageScore + '%';
        if (elements.passRate) elements.passRate.textContent = passRate + '%';
        if (elements.totalAttempts) elements.totalAttempts.textContent = totalStudents;
        
        if (totalStudents > 0) {
            const highest = Math.max(...teacherResults.map(r => r.percentage));
            const lowest = Math.min(...teacherResults.map(r => r.percentage));
            
            if (elements.highestScore) elements.highestScore.textContent = highest + '%';
            if (elements.lowestScore) elements.lowestScore.textContent = lowest + '%';
        }
    } catch (error) {
        ErrorHandler.logError(error, 'loadDashboardData');
    }
}

function loadTeacherTests() {
    try {
        const testsGrid = document.getElementById('testsGrid');
        if (!testsGrid) return;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests) {
            testsGrid.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-12">ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ุจุนุฏ</div>';
            return;
        }
        
        if (school.tests.length === 0) {
            testsGrid.innerHTML = `
                <div class="col-span-3 text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">๐</div>
                    <p class="text-lg mb-4">ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ุจุนุฏ</p>
                    <button onclick="showCreateTestModal()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-600 transition-all">
                        โ ุฅูุดุงุก ุฃูู ุงุฎุชุจุงุฑ
                    </button>
                </div>
            `;
            return;
        }
        
        let testsHTML = '';
        
        school.tests.forEach((test, index) => {
            testsHTML += `
                <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 hover:shadow-lg transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-xl text-gray-800">${test.name}</h4>
                        <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm">${test.subject}</span>
                    </div>
                    
                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">ุงููุงุฏุฉ:</span>
                            <span class="font-semibold">${test.subject}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ุงูุตู:</span>
                            <span class="font-semibold">${test.grade}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ุงูุฃุณุฆูุฉ:</span>
                            <span class="font-semibold">${test.questions.length}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ุงูููุช:</span>
                            <span class="font-semibold">${test.timerPerQuestion || 30} ุซุงููุฉ</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="editTest(${index})" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold transition-all">
                            ุชุนุฏูู
                        </button>
                        <button onclick="deleteTest(${index})" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg text-sm font-semibold transition-all">
                            ุญุฐู
                        </button>
                    </div>
                </div>
            `;
        });
        
        testsGrid.innerHTML = testsHTML;
    } catch (error) {
        ErrorHandler.logError(error, 'loadTeacherTests');
    }
}

// ========== ุงูููุงูุฐ ุงูููุจุซูุฉ ููุงุฎุชุจุงุฑุงุช ==========

function showCreateTestModal() {
    try {
        currentEditingTestId = null;
        
        const modal = document.getElementById('testModal');
        const modalTitle = document.getElementById('testModalTitle');
        const form = document.getElementById('testModalForm');
        const errorDiv = document.getElementById('testModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Test modal elements not found');
        }
        
        modalTitle.textContent = 'ุฅูุดุงุก ุงุฎุชุจุงุฑ ุฌุฏูุฏ';
        form.reset();
        errorDiv.classList.add('hidden');
        
        // ุชุญุฏูุซ ุฎูุงุฑุงุช ุงูุตููู ุจูุงุกู ุนูู ูุฑุญูุฉ ุงููุนูู
        updateGradeOptions(currentUser.stage, 'modalTestGrade');
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showCreateTestModal');
    }
}

function editTest(testIndex) {
    try {
        currentEditingTestId = testIndex;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[testIndex]) {
            alert('ุงูุงุฎุชุจุงุฑ ุบูุฑ ููุฌูุฏ');
            return;
        }
        
        const test = school.tests[testIndex];
        const modal = document.getElementById('testModal');
        const modalTitle = document.getElementById('testModalTitle');
        const form = document.getElementById('testModalForm');
        const errorDiv = document.getElementById('testModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Test modal elements not found');
        }
        
        modalTitle.textContent = 'ุชุนุฏูู ุงูุงุฎุชุจุงุฑ';
        errorDiv.classList.add('hidden');
        
        // ุชุนุจุฆุฉ ุจูุงูุงุช ุงูุงุฎุชุจุงุฑ
        document.getElementById('modalTestName').value = test.name || '';
        document.getElementById('modalTestSubject').value = test.subject || '';
        document.getElementById('modalTestTimer').value = test.timerPerQuestion || 30;
        document.getElementById('modalTestDescription').value = test.description || '';
        
        // ุชุญุฏูุซ ุฎูุงุฑุงุช ุงูุตููู
        updateGradeOptions(currentUser.stage, 'modalTestGrade');
        
        // ุชุนููู ุงูุตู ุงูุญุงูู
        const gradeSelect = document.getElementById('modalTestGrade');
        if (gradeSelect && test.grade) {
            gradeSelect.value = test.grade;
        }
        
        // ุชุนููู ูุณุชูู ุงูุตุนูุจุฉ
        const difficultySelect = document.getElementById('modalTestDifficulty');
        if (difficultySelect && test.difficulty) {
            difficultySelect.value = test.difficulty;
        }
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'editTest');
    }
}

function closeTestModal() {
    try {
        const modal = document.getElementById('testModal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        currentEditingTestId = null;
    } catch (error) {
        ErrorHandler.logError(error, 'closeTestModal');
    }
}

function handleTestFormSubmit(event) {
    try {
        event.preventDefault();
        
        const name = DataValidator.sanitizeInput(document.getElementById('modalTestName').value);
        const subject = DataValidator.sanitizeInput(document.getElementById('modalTestSubject').value);
        const grade = document.getElementById('modalTestGrade').value;
        const timerPerQuestion = parseInt(document.getElementById('modalTestTimer').value) || 30;
        const description = DataValidator.sanitizeInput(document.getElementById('modalTestDescription').value);
        const difficulty = document.getElementById('modalTestDifficulty').value;
        
        const errorDiv = document.getElementById('testModalError');
        if (!errorDiv) {
            throw new Error('Error div not found');
        }
        
        // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
        if (!name || !subject || !grade) {
            errorDiv.textContent = 'ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        if (timerPerQuestion < 10 || timerPerQuestion > 300) {
            errorDiv.textContent = 'ููุช ุงูุณุคุงู ูุฌุจ ุฃู ูููู ุจูู 10 ู 300 ุซุงููุฉ';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school) {
            errorDiv.textContent = 'ุงููุฏุฑุณุฉ ุบูุฑ ููุฌูุฏุฉ';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        if (currentEditingTestId === null) {
            // ุฅูุดุงุก ุงุฎุชุจุงุฑ ุฌุฏูุฏ
            const newTest = {
                name: name,
                subject: subject,
                grade: grade,
                timerPerQuestion: timerPerQuestion,
                description: description,
                difficulty: difficulty,
                questions: []
            };
            
            school.tests.push(newTest);
        } else {
            // ุชุนุฏูู ุงุฎุชุจุงุฑ ููุฌูุฏ
            school.tests[currentEditingTestId] = {
                ...school.tests[currentEditingTestId],
                name: name,
                subject: subject,
                grade: grade,
                timerPerQuestion: timerPerQuestion,
                description: description,
                difficulty: difficulty
            };
        }
        
        // ุญูุธ ุงูุจูุงูุงุช
        const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
		if (success) {
    console.log('โ ุชู ุญูุธ ุงูุงุฎุชุจุงุฑ ุงูุฌุฏูุฏ ูู ุงูุชุฎุฒูู ุงููุญูู');
    
    // ุฅุฐุง ูุงู ุงูุทุงูุจ ูู ุดุงุดุฉ ุงุฎุชูุงุฑ ุงูุงุฎุชุจุงุฑุงุชุ ูู ุจุชุญุฏูุซ ุงููุงุฆูุฉ ููุฑุงู
    const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
    if (selectedSchoolInfo && selectedSchoolInfo.classList.contains('hidden') === false) {
        const schoolId = selectedSchoolInfo.dataset.schoolId;
        if (schoolId) {
            // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช ุจุนุฏ ุซุงููุชูู
            setTimeout(() => {
                refreshTestsList(schoolId);
            }, 2000);
        }
    }
    
    // ูุฒุงููุฉ ูุน ุงูุฎุงุฏู ุฅุฐุง ูุงู ูุชุตูุงู
    syncSchoolData(currentManagingTestSchoolId);
}
        if (!success) {
            errorDiv.textContent = 'ูุดู ูู ุญูุธ ุงูุจูุงูุงุช';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        closeTestModal();
        loadTeacherTests();
        
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'handleTestFormSubmit');
        return false;
    }
}

function deleteTest(testIndex) {
    try {
        if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุงุฎุชุจุงุฑุ')) {
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (school && school.tests[testIndex]) {
            school.tests.splice(testIndex, 1);
            
            // ุญูุธ ุงูุจูุงูุงุช
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            
            // ุฅุนุงุฏุฉ ุชุญููู ุงูุงุฎุชุจุงุฑุงุช
            loadTeacherTests();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'deleteTest');
    }
}

// ========== ุงูููุงูุฐ ุงูููุจุซูุฉ ููุฃุณุฆูุฉ ==========

function loadTestSelectForQuestions() {
    try {
        const testSelect = document.getElementById('questionTestSelect');
        if (!testSelect) return;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school) {
            testSelect.innerHTML = '<option value="">ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช</option>';
            return;
        }
        
        testSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุงุฎุชุจุงุฑ</option>';
        
        school.tests.forEach((test, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
            testSelect.appendChild(option);
        });
    } catch (error) {
        ErrorHandler.logError(error, 'loadTestSelectForQuestions');
    }
}

function loadTestQuestions() {
    try {
        const testIndex = document.getElementById('questionTestSelect').value;
        const questionsContainer = document.getElementById('questionsContainer');
        
        if (!questionsContainer) return;
        
        if (testIndex === '') {
            questionsContainer.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">โ</div>
                    <p>ุงุฎุชุฑ ุงุฎุชุจุงุฑุงู ูุนุฑุถ ุงูุฃุณุฆูุฉ</p>
                </div>
            `;
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[testIndex]) {
            questionsContainer.innerHTML = '<div class="text-center text-red-500 py-12">ุงูุงุฎุชุจุงุฑ ุบูุฑ ููุฌูุฏ</div>';
            return;
        }
        
        const test = school.tests[testIndex];
        currentManagingTest = testIndex;
        
        if (test.questions.length === 0) {
            questionsContainer.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">๐</div>
                    <p class="text-lg mb-4">ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูู ูุฐุง ุงูุงุฎุชุจุงุฑ</p>
                    <button onclick="showAddQuestionModal()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-green-600 hover:to-blue-600 transition-all">
                        โ ุฅุถุงูุฉ ุฃูู ุณุคุงู
                    </button>
                </div>
            `;
            return;
        }
        
        let questionsHTML = `
            <div class="mb-6">
                <h4 class="font-bold text-xl text-gray-800 mb-2">ุฃุณุฆูุฉ ุงุฎุชุจุงุฑ: ${test.name}</h4>
                <p class="text-gray-600">ุนุฏุฏ ุงูุฃุณุฆูุฉ: ${test.questions.length}</p>
                <p class="text-blue-600 text-sm mt-2">๐งฉ ููููู ุณุญุจ ุงูุฃุณุฆูุฉ ูุฅููุงุชูุง ูุฅุนุงุฏุฉ ุชุฑุชูุจูุง</p>
            </div>
            
            <div id="questionsList" class="space-y-4">
        `;
        
        test.questions.forEach((question, index) => {
            const optionLabels = ['ุฃ', 'ุจ', 'ุฌ', 'ุฏ'];
            const correctAnswerLabel = optionLabels[question.correct];
            
            questionsHTML += `
                <div class="question-item bg-white border-2 border-gray-200 rounded-2xl p-6 transition-all duration-300 hover:shadow-lg"
                     draggable="true"
                     data-question-index="${index}"
                     ondragstart="handleDragStart(event)"
                     ondragover="handleDragOver(event)"
                     ondragenter="handleDragEnter(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event)">
                    
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="drag-handle text-gray-400 cursor-grab hover:text-gray-600 transition-all p-2 rounded-lg hover:bg-gray-100">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="9" cy="5" r="1"></circle>
                                    <circle cx="9" cy="12" r="1"></circle>
                                    <circle cx="9" cy="19" r="1"></circle>
                                    <circle cx="15" cy="5" r="1"></circle>
                                    <circle cx="15" cy="12" r="1"></circle>
                                    <circle cx="15" cy="19" r="1"></circle>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h5 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                    <span class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">${index + 1}</span>
                                    ุงูุณุคุงู ${index + 1}
                                </h5>
                            </div>
                        </div>
                        <span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-sm font-semibold">
                            โ ${correctAnswerLabel}
                        </span>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-gray-700 text-lg bg-gray-50 p-4 rounded-xl border">${question.question}</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-3 mb-4">
                        ${question.options.map((option, optIndex) => `
                            <div class="flex items-center gap-3 p-3 rounded-xl border-2 ${
                                optIndex === question.correct 
                                ? 'bg-green-50 border-green-300 text-green-700' 
                                : 'bg-gray-50 border-gray-200 text-gray-700'
                            } transition-all">
                                <span class="w-8 h-8 ${
                                    optIndex === question.correct 
                                    ? 'bg-green-500 text-white' 
                                    : 'bg-gray-300 text-gray-600'
                                } rounded-full flex items-center justify-center font-bold text-sm">
                                    ${optionLabels[optIndex]}
                                </span>
                                <span class="flex-1 ${optIndex === question.correct ? 'font-semibold' : ''}">${option}</span>
                                ${optIndex === question.correct ? 
                                    '<span class="text-green-500 text-lg">โ</span>' : 
                                    ''
                                }
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex gap-2 pt-4 border-t border-gray-200">
                        <button onclick="editQuestion(${index})" 
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            ุชุนุฏูู
                        </button>
                        <button onclick="deleteQuestion(${index})" 
                                class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            ุญุฐู
                        </button>
                    </div>
                </div>
            `;
        });
        
        questionsHTML += `</div>`; // ุฅุบูุงู questionsList
        
        questionsContainer.innerHTML = questionsHTML;
		// ุชููุฆุฉ ุฃุญุฏุงุซ ุงูุณุญุจ ูุงูุฅููุงุช ุจุนุฏ ุชุฃุฎูุฑ ุจุณูุท ูุถูุงู ุชุญููู DOM
        setTimeout(() => {
            initDragAndDrop();
        }, 300);
        
    } catch (error) {
        ErrorHandler.logError(error, 'loadTestQuestions');
    }
}

function showAddQuestionModal() {
    try {
        if (currentManagingTest === null) {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงุฎุชุจุงุฑ ุฃููุงู');
            return;
        }
        
        currentEditingQuestionIndex = null;
        
        const modal = document.getElementById('questionModal');
        const modalTitle = document.getElementById('questionModalTitle');
        const form = document.getElementById('questionModalForm');
        const errorDiv = document.getElementById('questionModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Question modal elements not found');
        }
        
        modalTitle.textContent = 'ุฅุถุงูุฉ ุณุคุงู ุฌุฏูุฏ';
        form.reset();
        errorDiv.classList.add('hidden');
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'showAddQuestionModal');
    }
}

function editQuestion(questionIndex) {
    try {
        if (currentManagingTest === null) {
            alert('ูุง ููุฌุฏ ุงุฎุชุจุงุฑ ูุญุฏุฏ');
            return;
        }
        
        currentEditingQuestionIndex = questionIndex;
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) {
            alert('ุงูุงุฎุชุจุงุฑ ุบูุฑ ููุฌูุฏ');
            return;
        }
        
        const test = school.tests[currentManagingTest];
        const question = test.questions[questionIndex];
        
        if (!question) {
            alert('ุงูุณุคุงู ุบูุฑ ููุฌูุฏ');
            return;
        }
        
        const modal = document.getElementById('questionModal');
        const modalTitle = document.getElementById('questionModalTitle');
        const form = document.getElementById('questionModalForm');
        const errorDiv = document.getElementById('questionModalError');
        
        if (!modal || !modalTitle || !form || !errorDiv) {
            throw new Error('Question modal elements not found');
        }
        
        modalTitle.textContent = 'ุชุนุฏูู ุงูุณุคุงู';
        errorDiv.classList.add('hidden');
        
        // ุชุนุจุฆุฉ ุจูุงูุงุช ุงูุณุคุงู
        document.getElementById('modalQuestionText').value = question.question || '';
        document.getElementById('modalOption1').value = question.options[0] || '';
        document.getElementById('modalOption2').value = question.options[1] || '';
        document.getElementById('modalOption3').value = question.options[2] || '';
        document.getElementById('modalOption4').value = question.options[3] || '';
        document.getElementById('modalCorrectAnswer').value = question.correct || '';
        
        modal.classList.remove('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'editQuestion');
    }
}

function closeQuestionModal() {
    try {
        const modal = document.getElementById('questionModal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        currentEditingQuestionIndex = null;
    } catch (error) {
        ErrorHandler.logError(error, 'closeQuestionModal');
    }
}

function handleQuestionFormSubmit(event) {
    try {
        event.preventDefault();
        
        if (currentManagingTest === null) {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงุฎุชุจุงุฑ ุฃููุงู');
            return false;
        }
        
        const questionText = DataValidator.sanitizeInput(document.getElementById('modalQuestionText').value);
        const option1 = DataValidator.sanitizeInput(document.getElementById('modalOption1').value);
        const option2 = DataValidator.sanitizeInput(document.getElementById('modalOption2').value);
        const option3 = DataValidator.sanitizeInput(document.getElementById('modalOption3').value);
        const option4 = DataValidator.sanitizeInput(document.getElementById('modalOption4').value);
        const correctAnswer = parseInt(document.getElementById('modalCorrectAnswer').value);
        
        const errorDiv = document.getElementById('questionModalError');
        if (!errorDiv) {
            throw new Error('Error div not found');
        }
        
        // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
        if (!questionText || !option1 || !option2 || !option3 || !option4 || isNaN(correctAnswer)) {
            errorDiv.textContent = 'ูุฑุฌู ููุก ุฌููุน ุงูุญููู ูุชุญุฏูุฏ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        if (correctAnswer < 0 || correctAnswer > 3) {
            errorDiv.textContent = 'ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูุฌุจ ุฃู ุชููู ุจูู 0 ู 3';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests[currentManagingTest]) {
            errorDiv.textContent = 'ุงูุงุฎุชุจุงุฑ ุบูุฑ ููุฌูุฏ';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        const test = school.tests[currentManagingTest];
        const newQuestion = {
            question: questionText,
            options: [option1, option2, option3, option4],
            correct: correctAnswer
        };
        
        if (currentEditingQuestionIndex === null) {
            // ุฅุถุงูุฉ ุณุคุงู ุฌุฏูุฏ
            test.questions.push(newQuestion);
        } else {
            // ุชุนุฏูู ุณุคุงู ููุฌูุฏ
            test.questions[currentEditingQuestionIndex] = newQuestion;
        }
        
        // ุญูุธ ุงูุจูุงูุงุช
        const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
        if (!success) {
            errorDiv.textContent = 'ูุดู ูู ุญูุธ ุงูุจูุงูุงุช';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        closeQuestionModal();
        loadTestQuestions();
        
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'handleQuestionFormSubmit');
        return false;
    }
}

function deleteQuestion(questionIndex) {
    try {
        if (currentManagingTest === null) {
            alert('ูุง ููุฌุฏ ุงุฎุชุจุงุฑ ูุญุฏุฏ');
            return;
        }
        
        if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุคุงูุ')) {
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (school && school.tests[currentManagingTest] && school.tests[currentManagingTest].questions[questionIndex]) {
            school.tests[currentManagingTest].questions.splice(questionIndex, 1);
            
            // ุญูุธ ุงูุจูุงูุงุช
            StorageManager.setItem('demoSchoolsData', demoData.schools);
            
            // ุฅุนุงุฏุฉ ุชุญููู ุงูุฃุณุฆูุฉ
            loadTestQuestions();
        }
    } catch (error) {
        ErrorHandler.logError(error, 'deleteQuestion');
    }
}

// ========== ูุธุงู ุงูุณุญุจ ูุงูุฅููุงุช ุงููุจุณุท ูุงููุจุงุดุฑ ==========

let draggedItem = null;
let currentDragIndex = null;

// ูุธุงู ุงูุณุญุจ ูุงูุฅููุงุช ุงููุจุณุท
function initDragAndDrop() {
    console.log('๐ ุจุฏุก ุชููุฆุฉ ุงูุณุญุจ ูุงูุฅููุงุช...');
    
    const questions = document.querySelectorAll('.question-item');
    console.log(`๐ ุนุฏุฏ ุงูุฃุณุฆูุฉ: ${questions.length}`);
    
    questions.forEach((item, index) => {
        // ุฅุนุฏุงุฏ ุงูุณูุงุช ุงูุฃุณุงุณูุฉ
        item.setAttribute('draggable', 'true');
        item.setAttribute('data-index', index);
        
        // ุฅุฒุงูุฉ ุฌููุน ุงูุฃุญุฏุงุซ ุงูุณุงุจูุฉ
        item.ondragstart = null;
        item.ondragover = null;
        item.ondragenter = null;
        item.ondragleave = null;
        item.ondrop = null;
        item.ondragend = null;
        
        // ุฑุจุท ุงูุฃุญุฏุงุซ ุงูุฌุฏูุฏุฉ
        item.ondragstart = function(e) {
            console.log('๐ฏ ุจุฏุก ุณุญุจ ุงูุณุคุงู:', index);
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', index);
        };
        
        item.ondragover = function(e) {
            e.preventDefault();
        };
        
        item.ondragenter = function(e) {
            e.preventDefault();
            if (this !== e.target.closest('.question-item')) return;
            this.classList.add('drag-over');
        };
        
        item.ondragleave = function() {
            this.classList.remove('drag-over');
        };
        
        item.ondrop = function(e) {
            e.preventDefault();
            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const toIndex = parseInt(this.getAttribute('data-index'));
            
            if (fromIndex !== toIndex) {
                console.log(`๐ ููู ูู ${fromIndex} ุฅูู ${toIndex}`);
                swapQuestionPositions(fromIndex, toIndex);
            }
            
            this.classList.remove('drag-over');
        };
        
        item.ondragend = function() {
            console.log('๐ ุงูุชูุงุก ุงูุณุญุจ');
            this.classList.remove('dragging');
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        };
    });
    
    console.log('โ ุงูุชููุช ุชููุฆุฉ ุงูุณุญุจ ูุงูุฅููุงุช');
}

// ุฏุงูุฉ ุชุจุฏูู ููุงูุน ุงูุฃุณุฆูุฉ - ูุณุฎุฉ ูุจุณุทุฉ
function swapQuestionPositions(fromIndex, toIndex) {
    try {
        console.log(`๐ ุชุจุฏูู ุงูุณุคุงู ${fromIndex} ูุน ${toIndex}`);
        
        // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
        if (!currentManagingTestSchoolId || currentManagingTest === null) {
            alert('โ ูู ูุชู ุชุญุฏูุฏ ุงูุงุฎุชุจุงุฑ ุจุดูู ุตุญูุญ');
            return;
        }
        
        const school = demoData.schools[currentManagingTestSchoolId];
        if (!school || !school.tests || !school.tests[currentManagingTest]) {
            alert('โ ุงูุงุฎุชุจุงุฑ ุบูุฑ ููุฌูุฏ');
            return;
        }
        
        const test = school.tests[currentManagingTest];
        const questions = test.questions;
        
        // ุงูุชุญูู ูู ุงููุคุดุฑุงุช
        if (fromIndex < 0 || fromIndex >= questions.length || toIndex < 0 || toIndex >= questions.length) {
            alert('โ ูุคุดุฑุงุช ุงูุฃุณุฆูุฉ ุบูุฑ ุตุงูุญุฉ');
            return;
        }
        
        // ุชุจุฏูู ุงูุฃุณุฆูุฉ ุจุงุณุชุฎุฏุงู ุทุฑููุฉ ุจุณูุทุฉ
        const temp = questions[fromIndex];
        questions[fromIndex] = questions[toIndex];
        questions[toIndex] = temp;
        
        console.log('โ ุชู ุชุจุฏูู ุงูุฃุณุฆูุฉ ูู ุงูุฐุงูุฑุฉ');
        
        // ุญูุธ ุงูุจูุงูุงุช
        const success = StorageManager.setItem('demoSchoolsData', demoData.schools);
        if (success) {
            console.log('๐พ ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ');
            // ุฅุนุงุฏุฉ ุชุญููู ุงูุฃุณุฆูุฉ ุจุนุฏ ุซุงููุฉ
            setTimeout(() => {
                loadTestQuestions();
                showSuccessMessage('ุชู ุงูุชุนุฏูู', 'ุชู ุชุบููุฑ ุชุฑุชูุจ ุงูุฃุณุฆูุฉ ุจูุฌุงุญ');
            }, 1000);
        } else {
            alert('โ ูุดู ูู ุญูุธ ุงูุจูุงูุงุช');
        }
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู swapQuestionPositions:', error);
        alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุนุงุฏุฉ ุงูุชุฑุชูุจ: ' + error.message);
    }
}

// ========== ุฏูุงู ุงูุดูุงุฏุฉ ==========

function showCertificate() {
    try {
        document.getElementById('certificateScreen').classList.remove('hidden');
        
        // ุฅูุดุงุก ูุนุงููุฉ ุฃูููุฉ ููุดูุงุฏุฉ
        updateCertificatePreview('');
    } catch (error) {
        ErrorHandler.logError(error, 'showCertificate');
    }
}

function closeCertificate() {
    try {
        document.getElementById('certificateScreen').classList.add('hidden');
    } catch (error) {
        ErrorHandler.logError(error, 'closeCertificate');
    }
}

// ========== ุฏูุงู ุงููุชุงุฆุฌ ูุงูุชุตุฏูุฑ ==========

function loadResultsForTeacher() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช ููููุชุฑุฉ
        const filterTestSelect = document.getElementById('filterTestSelect');
        if (filterTestSelect) {
            const uniqueTests = [...new Set(teacherResults.map(r => r.test))];
            filterTestSelect.innerHTML = '<option value="">ุฌููุน ุงูุงุฎุชุจุงุฑุงุช</option>';
            uniqueTests.forEach(test => {
                const option = document.createElement('option');
                option.value = test;
                option.textContent = test;
                filterTestSelect.appendChild(option);
            });
        }
        
        // ุชุญุฏูุซ ูุงุฆูุฉ ุงููุตูู ููููุชุฑุฉ
        const filterClassSelect = document.getElementById('filterClassSelect');
        if (filterClassSelect) {
            const uniqueClasses = [...new Set(teacherResults.map(r => r.class))];
            filterClassSelect.innerHTML = '<option value="">ุฌููุน ุงููุตูู</option>';
            uniqueClasses.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                filterClassSelect.appendChild(option);
            });
        }
        
        // ุชุทุจูู ุงูููุงุชุฑ ุงูุญุงููุฉ
        filterResults();
    } catch (error) {
        ErrorHandler.logError(error, 'loadResultsForTeacher');
    }
}

function toggleAdvancedFilters() {
    try {
        const advancedFilters = document.getElementById('advancedFilters');
        const toggleButton = document.getElementById('toggleFiltersBtn');
        
        if (advancedFilters && toggleButton) {
            if (advancedFilters.classList.contains('hidden')) {
                advancedFilters.classList.remove('hidden');
                toggleButton.textContent = 'ุฅุฎูุงุก ุงูููุงุชุฑ ุงููุชูุฏูุฉ';
            } else {
                advancedFilters.classList.add('hidden');
                toggleButton.textContent = 'ุฅุธูุงุฑ ุงูููุงุชุฑ ุงููุชูุฏูุฉ';
            }
        }
    } catch (error) {
        ErrorHandler.logError(error, 'toggleAdvancedFilters');
    }
}

function filterResults() {
    try {
        const searchName = document.getElementById('searchStudentName')?.value.toLowerCase() || '';
        const filterTest = document.getElementById('filterTestSelect')?.value || '';
        const filterClass = document.getElementById('filterClassSelect')?.value || '';
        const filterGrade = document.getElementById('filterGradeSelect')?.value || '';
        const filterPercentage = document.getElementById('filterPercentageSelect')?.value || '';
        const filterDate = document.getElementById('filterDateSelect')?.value || '';
        const filterDateFrom = document.getElementById('filterDateFrom')?.value || '';
        const filterDateTo = document.getElementById('filterDateTo')?.value || '';
        
        const results = loadResults();
        let filteredResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // ุชุทุจูู ุงูููุงุชุฑ
        if (searchName) {
            filteredResults = filteredResults.filter(result => 
                result.name.toLowerCase().includes(searchName)
            );
        }
        
        if (filterTest) {
            filteredResults = filteredResults.filter(result => 
                result.test === filterTest
            );
        }
        
        if (filterClass) {
            filteredResults = filteredResults.filter(result => 
                result.class === filterClass
            );
        }
        
        if (filterGrade) {
            filteredResults = filteredResults.filter(result => 
                result.gradeLevel === filterGrade
            );
        }
        
        if (filterPercentage) {
            const [min, max] = filterPercentage.split('-').map(Number);
            filteredResults = filteredResults.filter(result => {
                if (max) {
                    return result.percentage >= min && result.percentage <= max;
                } else {
                    return result.percentage >= min;
                }
            });
        }
        
        if (filterDate) {
            const now = new Date();
            filteredResults = filteredResults.filter(result => {
                const resultDate = new Date(result.timestamp);
                
                switch (filterDate) {
                    case 'today':
                        return resultDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return resultDate >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        return resultDate >= monthAgo;
                    case 'custom':
                        if (filterDateFrom && filterDateTo) {
                            const fromDate = new Date(filterDateFrom);
                            const toDate = new Date(filterDateTo);
                            return resultDate >= fromDate && resultDate <= toDate;
                        }
                        return true;
                    default:
                        return true;
                }
            });
        }
        
        // ุนุฑุถ ุงููุชุงุฆุฌ ุงููููุชุฑุฉ
        displayFilteredResults(filteredResults);
        
        // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูููุชุฑุฉ
        updateFilterStats();
    } catch (error) {
        ErrorHandler.logError(error, 'filterResults');
    }
}
function displayFilteredResults(results) {
    try {
        const tableBody = document.getElementById('resultsTableBody');
        if (!tableBody) return;
        
        if (results.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                        <div class="text-4xl mb-2">๐</div>
                        <p>ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุทุงุจูุฉ ููุจุญุซ</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        let tableHTML = '';
        
        results.sort((a, b) => b.timestamp - a.timestamp).forEach(result => {
            const date = new Date(result.timestamp).toLocaleDateString('ar-SA');
            
            tableHTML += `
                <tr class="border-b border-gray-200 hover:bg-gray-50" id="resultRow-${result.id}">
                    <td class="px-6 py-4 text-right">${result.name}</td>
                    <td class="px-6 py-4 text-right">${result.grade} - ${result.class}</td>
                    <td class="px-6 py-4 text-right">${result.test}</td>
                    <td class="px-6 py-4 text-right font-bold">${result.score}/${result.total}</td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-bold ${result.percentage >= 60 ? 'text-green-600' : 'text-red-600'}">
                            ${result.percentage}%
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${getGradeColor(result.gradeLevel)}">
                            ${result.gradeLevel}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">${date}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex gap-2 justify-end">
                            <button onclick="viewResultDetails(${result.id})" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                ุชูุงุตูู
                            </button>
                            <button onclick="deleteStudentResult(${result.id})" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm font-semibold transition-all flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"></path>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                    <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                ุญุฐู
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = tableHTML;
    } catch (error) {
        ErrorHandler.logError(error, 'displayFilteredResults');
    }
}

function getGradeColor(grade) {
    switch (grade) {
        case 'ููุชุงุฒ': return 'bg-green-100 text-green-800';
        case 'ุฌูุฏ ุฌุฏุงู': return 'bg-blue-100 text-blue-800';
        case 'ุฌูุฏ': return 'bg-yellow-100 text-yellow-800';
        case 'ููุจูู': return 'bg-orange-100 text-orange-800';
        case 'ุถุนูู': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}
function updateFilterStats() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // ุชุทุจูู ุงูููุงุชุฑ ุงูุญุงููุฉ
        const searchName = document.getElementById('searchStudentName')?.value.toLowerCase() || '';
        const filterTest = document.getElementById('filterTestSelect')?.value || '';
        const filterClass = document.getElementById('filterClassSelect')?.value || '';
        const filterGrade = document.getElementById('filterGradeSelect')?.value || '';
        const filterPercentage = document.getElementById('filterPercentageSelect')?.value || '';
        const filterDate = document.getElementById('filterDateSelect')?.value || '';
        const filterDateFrom = document.getElementById('filterDateFrom')?.value || '';
        const filterDateTo = document.getElementById('filterDateTo')?.value || '';
        
        let filteredResults = teacherResults;
        
        if (searchName) {
            filteredResults = filteredResults.filter(result => 
                result.name.toLowerCase().includes(searchName)
            );
        }
        
        if (filterTest) {
            filteredResults = filteredResults.filter(result => 
                result.test === filterTest
            );
        }
        
        if (filterClass) {
            filteredResults = filteredResults.filter(result => 
                result.class === filterClass
            );
        }
        
        if (filterGrade) {
            filteredResults = filteredResults.filter(result => 
                result.gradeLevel === filterGrade
            );
        }
        
        if (filterPercentage) {
            const [min, max] = filterPercentage.split('-').map(Number);
            filteredResults = filteredResults.filter(result => {
                if (max) {
                    return result.percentage >= min && result.percentage <= max;
                } else {
                    return result.percentage >= min;
                }
            });
        }
        
        if (filterDate) {
            const now = new Date();
            filteredResults = filteredResults.filter(result => {
                const resultDate = new Date(result.timestamp);
                
                switch (filterDate) {
                    case 'today':
                        return resultDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return resultDate >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        return resultDate >= monthAgo;
                    case 'custom':
                        if (filterDateFrom && filterDateTo) {
                            const fromDate = new Date(filterDateFrom);
                            const toDate = new Date(filterDateTo);
                            return resultDate >= fromDate && resultDate <= toDate;
                        }
                        return true;
                    default:
                        return true;
                }
            });
        }
        
        const stats = {
            count: filteredResults.length,
            average: 0,
            passRate: 0,
            highest: 0
        };
        
        if (filteredResults.length > 0) {
            stats.average = Math.round(filteredResults.reduce((sum, r) => sum + r.percentage, 0) / filteredResults.length);
            stats.passRate = Math.round((filteredResults.filter(r => r.percentage >= 60).length / filteredResults.length) * 100);
            stats.highest = Math.max(...filteredResults.map(r => r.percentage));
        }
        
        const elements = {
            filteredCount: document.getElementById('filteredCount'),
            filteredAverage: document.getElementById('filteredAverage'),
            filteredPassRate: document.getElementById('filteredPassRate'),
            filteredHighest: document.getElementById('filteredHighest')
        };
        
        if (elements.filteredCount) elements.filteredCount.textContent = stats.count;
        if (elements.filteredAverage) elements.filteredAverage.textContent = stats.average + '%';
        if (elements.filteredPassRate) elements.filteredPassRate.textContent = stats.passRate + '%';
        if (elements.filteredHighest) elements.filteredHighest.textContent = stats.highest + '%';
    } catch (error) {
        ErrorHandler.logError(error, 'updateFilterStats');
    }
}

function clearAllFilters() {
    try {
        const filterElements = [
            'searchStudentName',
            'filterTestSelect',
            'filterClassSelect',
            'filterGradeSelect',
            'filterPercentageSelect',
            'filterDateSelect',
            'filterDateFrom',
            'filterDateTo'
        ];
        
        filterElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.value = '';
            }
        });
        
        // ุฅุฎูุงุก ุงูููุงุชุฑ ุงููุชูุฏูุฉ
        const advancedFilters = document.getElementById('advancedFilters');
        const toggleButton = document.getElementById('toggleFiltersBtn');
        
        if (advancedFilters) advancedFilters.classList.add('hidden');
        if (toggleButton) toggleButton.textContent = 'ุฅุธูุงุฑ ุงูููุงุชุฑ ุงููุชูุฏูุฉ';
        
        // ุฅุนุงุฏุฉ ุชุทุจูู ุงูููุงุชุฑ
        filterResults();
    } catch (error) {
        ErrorHandler.logError(error, 'clearAllFilters');
    }
}
function viewResultDetails(resultId) {
    try {
        const results = loadResults();
        const result = results.find(r => r.id === resultId);
        
        if (!result) {
            alert('ุงููุชูุฌุฉ ุบูุฑ ููุฌูุฏุฉ');
            return;
        }
        
        let detailsHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" id="resultDetailsModal">
                <div class="bg-white rounded-3xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center sticky top-0">
                        <h2 class="text-2xl font-bold">ุชูุงุตูู ุงููุชูุฌุฉ</h2>
                        <button onclick="document.getElementById('resultDetailsModal').remove()" class="absolute left-6 top-6 text-white hover:text-gray-200 text-2xl">
                            โ
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-xl">
                                <div class="text-blue-600 font-semibold">ุงุณู ุงูุทุงูุจ</div>
                                <div class="font-bold text-lg">${result.name}</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl">
                                <div class="text-green-600 font-semibold">ุงูุตู/ุงููุตู</div>
                                <div class="font-bold text-lg">${result.grade} - ${result.class}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-xl mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">ุชูุงุตูู ุงูุงุฎุชุจุงุฑ</h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <span class="text-gray-600">ุงูุงุฎุชุจุงุฑ:</span>
                                    <span class="font-bold">${result.test}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">ุงููุงุฏุฉ:</span>
                                    <span class="font-bold">${result.subject}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">ุงูุฏุฑุฌุฉ:</span>
                                    <span class="font-bold">${result.score}/${result.total}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">ุงููุณุจุฉ:</span>
                                    <span class="font-bold ${result.percentage >= 60 ? 'text-green-600' : 'text-red-600'}">${result.percentage}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="font-bold text-gray-800 mb-3">ุชูุงุตูู ุงูุฅุฌุงุจุงุช</h3>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
        `;
        
        result.answers.forEach((answer, index) => {
            const questionNumber = index + 1;
            const isCorrect = answer.isCorrect;
            const selectedOption = answer.selected !== -1 ? 
                `ุงูุฎูุงุฑ ${String.fromCharCode(1632 + answer.selected + 1)}` : 'ูู ูุชู ุงูุฅุฌุงุจุฉ';
            const correctOption = `ุงูุฎูุงุฑ ${String.fromCharCode(1632 + answer.correct + 1)}`;
            
            detailsHTML += `
                <div class="border border-gray-200 rounded-xl p-4 ${isCorrect ? 'bg-green-50' : 'bg-red-50'}">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold">ุงูุณุคุงู ${questionNumber}</span>
                        <span class="px-2 py-1 rounded-full text-sm ${isCorrect ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                            ${isCorrect ? 'ุตุญูุญ' : 'ุฎุงุทุฆ'}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <div>ุงูุฅุฌุงุจุฉ ุงููุฎุชุงุฑุฉ: ${selectedOption}</div>
                        <div>ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: ${correctOption}</div>
                    </div>
                </div>
            `;
        });
        
        detailsHTML += `
                        </div>
                        <div class="text-center mt-6">
                            <button onclick="document.getElementById('resultDetailsModal').remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                                ุฅุบูุงู
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailsHTML);
        
    } catch (error) {
        ErrorHandler.logError(error, 'viewResultDetails');
    }
}
// ุฏุงูุฉ ูุณุงุนุฏุฉ ุฌุฏูุฏุฉ ูุฅุบูุงู ูุงูุฐุฉ ุงูุชูุงุตูู
function closeResultDetailsModal() {
    const modal = document.getElementById('resultDetailsModal');
    if (modal) {
        modal.remove();
    }
}

// ุฏุงูุฉ ุญุฐู ูุชูุฌุฉ ุงูุทุงูุจ
function deleteStudentResult(resultId) {
    try {
        // ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู
        if (!currentUser) {
            alert('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู');
            return;
        }
        
        const results = loadResults();
        const resultIndex = results.findIndex(r => r.id === resultId);
        
        if (resultIndex === -1) {
            alert('ุงููุชูุฌุฉ ุบูุฑ ููุฌูุฏุฉ');
            return;
        }
        
        const result = results[resultIndex];
        
        // ุชุฃููุฏ ุงูุญุฐู
        const confirmationMessage = `
โ๏ธ ุชุฃููุฏ ุญุฐู ุงููุชูุฌุฉ

๐ค ุงุณู ุงูุทุงูุจ: ${result.name}
๐ ุงูุตู/ุงููุตู: ${result.grade} - ${result.class}
๐ ุงูุงุฎุชุจุงุฑ: ${result.test}
๐ ุงููุชูุฌุฉ: ${result.score}/${result.total} (${result.percentage}%)

ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ุญุฐู ูุฐู ุงููุชูุฌุฉุ
        `.trim();
        
        if (!confirm(confirmationMessage)) {
            return;
        }
        
        // ุญุฐู ุงููุชูุฌุฉ ูู ุงููุตูููุฉ
        results.splice(resultIndex, 1);
        
        // ุญูุธ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
        const success = StorageManager.setItem('testResults', results);
        
        if (success) {
            // ุฅุฒุงูุฉ ุงูุตู ูู ุงูุฌุฏูู
            const resultRow = document.getElementById(`resultRow-${resultId}`);
            if (resultRow) {
                resultRow.remove();
            }
            
            // ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ
            showSuccessMessage('ุชู ุงูุญุฐู', `ุชู ุญุฐู ูุชูุฌุฉ ุงูุทุงูุจ ${result.name} ุจูุฌุงุญ`);
            
            // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
            updateFilterStats();
            
            console.log(`โ ุชู ุญุฐู ูุชูุฌุฉ ุงูุทุงูุจ: ${result.name}`);
        } else {
            alert('โ ูุดู ูู ุญุฐู ุงููุชูุฌุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
        }
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุงููุชูุฌุฉ:', error);
        ErrorHandler.logError(error, 'deleteStudentResult');
        alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุชูุฌุฉ: ' + error.message);
    }
}

// ========== ุฏูุงู ุงูุชุตุฏูุฑ ==========

function exportResults() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        if (teacherResults.length === 0) {
            alert('ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุชุตุฏูุฑ');
            return;
        }
        
        let csvContent = 'data:text/csv;charset=utf-8,\uFEFF';
        csvContent += 'ุงุณู ุงูุทุงูุจ,ุงูุตู,ุงููุตู,ุงูุงุฎุชุจุงุฑ,ุงููุงุฏุฉ,ุงูุฏุฑุฌุฉ,ุงูุฅุฌูุงูู,ุงููุณุจุฉ,ุงูุชูุฏูุฑ,ุงูุชุงุฑูุฎ\n';
        
        teacherResults.forEach(result => {
            const row = [
                result.name,
                result.grade,
                result.class,
                result.test,
                result.subject,
                result.score,
                result.total,
                result.percentage + '%',
                result.gradeLevel,
                result.date
            ].map(field => `"${field}"`).join(',');
            
            csvContent += row + '\n';
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `ูุชุงุฆุฌ_ุงูุทูุงุจ_${new Date().toLocaleDateString('ar-SA')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        ErrorHandler.logError(error, 'exportResults');
    }
}

function exportToExcel() {
    try {
        const results = loadResults();
        const teacherResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        if (teacherResults.length === 0) {
            alert('ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุชุตุฏูุฑ');
            return;
        }
        
        // ุฅูุดุงุก ูุฑูุฉ ุนูู
        const ws = XLSX.utils.json_to_sheet(teacherResults.map(result => ({
            'ุงุณู ุงูุทุงูุจ': result.name,
            'ุงูุตู': result.grade,
            'ุงููุตู': result.class,
            'ุงูุงุฎุชุจุงุฑ': result.test,
            'ุงููุงุฏุฉ': result.subject,
            'ุงูุฏุฑุฌุฉ': result.score,
            'ุงูุฅุฌูุงูู': result.total,
            'ุงููุณุจุฉ': result.percentage + '%',
            'ุงูุชูุฏูุฑ': result.gradeLevel,
            'ุงูุชุงุฑูุฎ': result.date
        })));
        
        // ุฅูุดุงุก ูุตูู ูุฅุถุงูุฉ ุงููุฑูุฉ
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'ูุชุงุฆุฌ ุงูุทูุงุจ');
        
        // ุชุตุฏูุฑ ุงูููู
        XLSX.writeFile(wb, `ูุชุงุฆุฌ_ุงูุทูุงุจ_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
    } catch (error) {
        ErrorHandler.logError(error, 'exportToExcel');
    }
}

function exportFilteredToExcel() {
    try {
        const searchName = document.getElementById('searchStudentName')?.value.toLowerCase() || '';
        const filterTest = document.getElementById('filterTestSelect')?.value || '';
        const filterClass = document.getElementById('filterClassSelect')?.value || '';
        
        const results = loadResults();
        let filteredResults = results.filter(result => 
            result.teacher === currentUser.name
        );
        
        // ุชุทุจูู ููุณ ููุงุชุฑ ุงูุนุฑุถ
        if (searchName) {
            filteredResults = filteredResults.filter(result => 
                result.name.toLowerCase().includes(searchName)
            );
        }
        
        if (filterTest) {
            filteredResults = filteredResults.filter(result => 
                result.test === filterTest
            );
        }
        
        if (filterClass) {
            filteredResults = filteredResults.filter(result => 
                result.class === filterClass
            );
        }
        
        if (filteredResults.length === 0) {
            alert('ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุทุงุจูุฉ ููููุงุชุฑ ููุชุตุฏูุฑ');
            return;
        }
        
        // ุฅูุดุงุก ูุฑูุฉ ุนูู
        const ws = XLSX.utils.json_to_sheet(filteredResults.map(result => ({
            'ุงุณู ุงูุทุงูุจ': result.name,
            'ุงูุตู': result.grade,
            'ุงููุตู': result.class,
            'ุงูุงุฎุชุจุงุฑ': result.test,
            'ุงููุงุฏุฉ': result.subject,
            'ุงูุฏุฑุฌุฉ': result.score,
            'ุงูุฅุฌูุงูู': result.total,
            'ุงููุณุจุฉ': result.percentage + '%',
            'ุงูุชูุฏูุฑ': result.gradeLevel,
            'ุงูุชุงุฑูุฎ': result.date
        })));
        
        // ุฅูุดุงุก ูุตูู ูุฅุถุงูุฉ ุงููุฑูุฉ
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'ูุชุงุฆุฌ ูููุชุฑุฉ');
        
        // ุชุตุฏูุฑ ุงูููู
        XLSX.writeFile(wb, `ูุชุงุฆุฌ_ูููุชุฑุฉ_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
    } catch (error) {
        ErrorHandler.logError(error, 'exportFilteredToExcel');
    }
}

// ========== ุฏูุงู ุงูุฅุนุฏุงุฏุงุช ==========

function loadTeacherSettings() {
    try {
        if (!currentUser) return;
        
        // ุชุญููู ุจูุงูุงุช ุงูููู ุงูุดุฎุตู
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profileSchool = document.getElementById('profileSchool');
        const profileStage = document.getElementById('profileStage');
        
        if (profileName) profileName.value = currentUser.name || '';
        if (profileEmail) profileEmail.value = currentUser.email || '';
        if (profileSchool) profileSchool.value = currentUser.school || '';
        if (profileStage) profileStage.value = currentUser.stage || '';
    } catch (error) {
        ErrorHandler.logError(error, 'loadTeacherSettings');
    }
}

function updateProfile(event) {
    try {
        event.preventDefault();
        
        if (!currentUser) return false;
        
        const name = DataValidator.sanitizeInput(document.getElementById('profileName').value);
        const school = DataValidator.sanitizeInput(document.getElementById('profileSchool').value);
        const stage = document.getElementById('profileStage').value;
        
        // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู
        currentUser.name = name;
        currentUser.school = school;
        currentUser.stage = stage;
        
        // ุชุญุฏูุซ ุจูุงูุงุช ุงููุฏุฑุณุฉ ุงููุฑุชุจุทุฉ
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === currentUser.name) {
                demoData.schools[schoolId].name = school;
                break;
            }
        }
        
        // ุญูุธ ุงูุชุญุฏูุซุงุช
        StorageManager.setItem('teacherAccounts', demoData.users);
        StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        // ุชุญุฏูุซ ุงูุนุฑุถ
        const teacherWelcome = document.getElementById('teacherWelcome');
        if (teacherWelcome) {
            teacherWelcome.textContent = `ูุฑุญุจุงู ${currentUser.name}`;
        }
        
        alert('ุชู ุชุญุฏูุซ ุงูููู ุงูุดุฎุตู ุจูุฌุงุญ');
        return true;
    } catch (error) {
        ErrorHandler.logError(error, 'updateProfile');
        return false;
    }
}

async function changePassword(event) {
  try {
    event.preventDefault();
    
    if (!currentUser) {
      alert('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู');
      return false;
    }
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    
    // ุงูุชุญูู ูู ุงูุจูุงูุงุช
    if (!currentPassword || !newPassword || !confirmNewPassword) {
      alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู');
      return false;
    }
    
    if (newPassword !== confirmNewPassword) {
      alert('ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ุบูุฑ ูุชุทุงุจูุฉ');
      return false;
    }
    
    if (newPassword.length < 6) {
      alert('ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู');
      return false;
    }
    
    // ุงุณุชุฎุฏุงู API ูุชุบููุฑ ูููุฉ ุงููุฑูุฑ
    const result = await APIService.changePassword({
      currentPassword: currentPassword,
      newPassword: newPassword
    });
    
    if (result.success) {
      alert('ุชู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ');
      event.target.reset();
      return true;
    } else {
      alert(result.error || 'ูุดู ูู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ');
      return false;
    }
    
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ:', error);
    alert('ุญุฏุซ ุฎุทุฃ: ' + error.message);
    return false;
  }
}

// ========== ุฏูุงู ุงููุณุคูู ูุฃุฏูุงุช ุงูุชุตุญูุญ ==========

function initializeDefaultData() {
    try {
        console.log('ุจุฏุก ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ...');
        
        // 1. ุฅุถุงูุฉ ุจูุงูุงุช ุงููุนูููู ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
        if (!demoData.users['chartgain2019@gmail.com']) {
            demoData.users['chartgain2019@gmail.com'] = {
                email: 'chartgain2019@gmail.com',
                password: '123456',
                name: 'ุฃ. ุนุจุฏุงููู ุงูุดูุฑู',
                school: 'ูุฏุฑุณุฉ ุงููููุฏ ุจู ุนูุงุฑุฉ ุงูุงุจุชุฏุงุฆูุฉ',
                stage: 'ุงุจุชุฏุงุฆูุฉ'
            };
            console.log('ุชู ุฅุถุงูุฉ ุงููุนูู ุงูุงูุชุฑุงุถู');
        }
        
        // 2. ุฅุถุงูุฉ ูุฏุฑุณุฉ ุงูุชุฑุงุถูุฉ ูููุนูู
        let defaultSchoolExists = false;
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === 'ุฃ. ุนุจุฏุงููู ุงูุดูุฑู') {
                defaultSchoolExists = true;
                break;
            }
        }
        
        if (!defaultSchoolExists) {
            const defaultSchoolId = 'school_default';
            demoData.schools[defaultSchoolId] = {
                id: defaultSchoolId,
                name: 'ูุฏุฑุณุฉ ุงููููุฏ ุจู ุนูุงุฑุฉ ุงูุงุจุชุฏุงุฆูุฉ',
                teacher: 'ุฃ. ุนุจุฏุงููู ุงูุดูุฑู',
                tests: [
                    {
                        name: 'ุงุฎุชุจุงุฑ ุงูุฑูุงุถูุงุช ุงููุตู ุงูุฃูู',
                        subject: 'ุงูุฑูุงุถูุงุช',
                        grade: 'ุงูุฑุงุจุน ุงุจุชุฏุงุฆู',
                        timerPerQuestion: 30,
                        difficulty: 'ูุชูุณุท',
                        description: 'ุงุฎุชุจุงุฑ ุงููุตู ุงูุฃูู ูู ูุงุฏุฉ ุงูุฑูุงุถูุงุช',
                        questions: [
                            {
                                question: 'ูุง ูู ูุงุชุฌ 15 + 27ุ',
                                options: ['42', '32', '52', '37'],
                                correct: 0
                            },
                            {
                                question: 'ูุง ูู ุงูุนุฏุฏ ุงูุฐู ููุซู ุฎูุณุฉ ูุนุดุฑููุ',
                                options: ['52', '25', '205', '250'],
                                correct: 1
                            },
                            {
                                question: 'ูุง ูู ูุงุชุฌ 8 ร 7ุ',
                                options: ['54', '56', '64', '48'],
                                correct: 1
                            },
                            {
                                question: 'ูุง ูู ุงููุณุฑ ุงูุฐู ููุซู ุงููุตูุ',
                                options: ['1/4', '1/2', '1/3', '2/3'],
                                correct: 1
                            },
                            {
                                question: 'ูุง ูู ูุญูุท ุงููุฑุจุน ุงูุฐู ุทูู ุถูุนู 5 ุณูุ',
                                options: ['10 ุณู', '15 ุณู', '20 ุณู', '25 ุณู'],
                                correct: 2
                            }
                        ]
                    },
                    {
                        name: 'ุงุฎุชุจุงุฑ ุงูุนููู ุงููุตู ุงูุฃูู',
                        subject: 'ุงูุนููู',
                        grade: 'ุงูุฑุงุจุน ุงุจุชุฏุงุฆู',
                        timerPerQuestion: 30,
                        difficulty: 'ูุชูุณุท',
                        description: 'ุงุฎุชุจุงุฑ ุงููุตู ุงูุฃูู ูู ูุงุฏุฉ ุงูุนููู',
                        questions: [
                            {
                                question: 'ุฃู ูู ูุฐู ุงูููุงูุจ ุฃูุฑุจ ุฅูู ุงูุดูุณุ',
                                options: ['ุงูุฒูุฑุฉ', 'ุงููุฑูุฎ', 'ุนุทุงุฑุฏ', 'ุงูุฃุฑุถ'],
                                correct: 2
                            },
                            {
                                question: 'ูุง ูู ุงูุนูููุฉ ุงูุชู ุชูุชุฌ ุจูุง ุงููุจุงุชุงุช ุบุฐุงุกูุงุ',
                                options: ['ุงูุชููุณ', 'ุงูุจูุงุก ุงูุถูุฆู', 'ุงูุชุจุฎุฑ', 'ุงูุชูุงุซุฑ'],
                                correct: 1
                            },
                            {
                                question: 'ุฃู ูู ูุฐู ุงูุญููุงูุงุช ูู ุงูุซุฏููุงุชุ',
                                options: ['ุงูุชูุณุงุญ', 'ุงูุญูุช', 'ุงูุณูุญูุงุฉ', 'ุงูุฃูุนู'],
                                correct: 1
                            }
                        ]
                    }
                ]
            };
            console.log('ุชู ุฅุถุงูุฉ ุงููุฏุฑุณุฉ ุงูุงูุชุฑุงุถูุฉ ูุน ุงุฎุชุจุงุฑูู');
        }
        
        // 3. ุฅุถุงูุฉ ูุชุงุฆุฌ ุชุฌุฑูุจูุฉ
        const sampleResults = [
            {
                id: Date.now() - 100000,
                name: 'ูุญูุฏ ุฃุญูุฏ',
                grade: 'ุงูุฑุงุจุน ุงุจุชุฏุงุฆู',
                class: '4ุฃ',
                school: 'ูุฏุฑุณุฉ ุงููููุฏ ุจู ุนูุงุฑุฉ ุงูุงุจุชุฏุงุฆูุฉ',
                teacher: 'ุฃ. ุนุจุฏุงููู ุงูุดูุฑู',
                test: 'ุงุฎุชุจุงุฑ ุงูุฑูุงุถูุงุช ุงููุตู ุงูุฃูู',
                subject: 'ุงูุฑูุงุถูุงุช',
                score: 4,
                total: 5,
                percentage: 80,
                gradeLevel: 'ุฌูุฏ ุฌุฏุงู',
                date: new Date(Date.now() - 86400000).toLocaleDateString('ar-SA'),
                answers: [],
                timestamp: Date.now() - 86400000
            },
            {
                id: Date.now() - 200000,
                name: 'ูุงุทูุฉ ุฎุงูุฏ',
                grade: 'ุงูุฑุงุจุน ุงุจุชุฏุงุฆู',
                class: '4ุจ',
                school: 'ูุฏุฑุณุฉ ุงููููุฏ ุจู ุนูุงุฑุฉ ุงูุงุจุชุฏุงุฆูุฉ',
                teacher: 'ุฃ. ุนุจุฏุงููู ุงูุดูุฑู',
                test: 'ุงุฎุชุจุงุฑ ุงูุฑูุงุถูุงุช ุงููุตู ุงูุฃูู',
                subject: 'ุงูุฑูุงุถูุงุช',
                score: 5,
                total: 5,
                percentage: 100,
                gradeLevel: 'ููุชุงุฒ',
                date: new Date(Date.now() - 172800000).toLocaleDateString('ar-SA'),
                answers: [],
                timestamp: Date.now() - 172800000
            }
        ];
        
        const existingResults = StorageManager.getItem('testResults') || [];
        const newResults = [...existingResults];
        let addedCount = 0;
        
        sampleResults.forEach(sample => {
            if (!newResults.find(r => r.id === sample.id)) {
                newResults.push(sample);
                addedCount++;
            }
        });
        
        if (addedCount > 0) {
            StorageManager.setItem('testResults', newResults);
            console.log(`ุชู ุฅุถุงูุฉ ${addedCount} ูุชูุฌุฉ ุชุฌุฑูุจูุฉ`);
        }
        
        // 4. ุญูุธ ุฌููุน ุงูุจูุงูุงุช
        StorageManager.setItem('teacherAccounts', demoData.users);
        StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        console.log('โ ุชูุช ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ ุจูุฌุงุญ');
        alert(`โ ุชูุช ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ ุจูุฌุงุญ\n\nุชู ุฅุถุงูุฉ:\n- ุงููุนูู ุงูุงูุชุฑุงุถู\n- ูุฏุฑุณุฉ ุงูุชุฑุงุถูุฉ\n- 2 ุงุฎุชุจุงุฑ\n- 2 ูุชูุฌุฉ ุชุฌุฑูุจูุฉ`);
        
        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูู ููุญุฉ ุงูุชุญูู
        if (currentUser && document.getElementById('teacherDashboard').classList.contains('hidden') === false) {
            loadTeacherTests();
            loadResultsForTeacher();
            loadDashboardData();
        }
        
    } catch (error) {
        console.error('โ ูุดู ูู ุชููุฆุฉ ุงูุจูุงูุงุช:', error);
        alert('โ ูุดู ูู ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ');
        ErrorHandler.logError(error, 'initializeDefaultData');
    }
}

function debugData() {
    try {
        console.log('=== ูุญุต ุจูุงูุงุช ุงููุธุงู ===');
        
        // ูุญุต ุจูุงูุงุช ุงููุนูููู
        console.log('๐จโ๐ซ ุจูุงูุงุช ุงููุนูููู:', demoData.users);
        
        // ูุญุต ุจูุงูุงุช ุงููุฏุงุฑุณ
        console.log('๐ซ ุจูุงูุงุช ุงููุฏุงุฑุณ:', demoData.schools);
        
        // ูุญุต ุงููุชุงุฆุฌ
        const results = loadResults();
        console.log('๐ ุงููุชุงุฆุฌ ุงููุญููุธุฉ:', results);
        
        // ูุญุต ุงูุชุฎุฒูู
        const storageInfo = StorageManager.getStorageInfo();
        console.log('๐พ ูุนูููุงุช ุงูุชุฎุฒูู:', storageInfo);
        
        // ุนุฑุถ ุงููุชุงุฆุฌ ูู ูุงูุฐุฉ
        let debugInfo = `
            <div class="bg-white rounded-3xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 text-center">
                    <h2 class="text-2xl font-bold">๐๏ธ ูุญุต ุจูุงูุงุช ุงููุธุงู</h2>
                </div>
                <div class="p-6">
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <h3 class="font-bold text-blue-800 mb-2">๐จโ๐ซ ุงููุนูููู</h3>
                            <div class="text-sm">${Object.keys(demoData.users).length} ูุนูู</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl">
                            <h3 class="font-bold text-green-800 mb-2">๐ซ ุงููุฏุงุฑุณ</h3>
                            <div class="text-sm">${Object.keys(demoData.schools).length} ูุฏุฑุณุฉ</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-xl">
                            <h3 class="font-bold text-purple-800 mb-2">๐ ุงููุชุงุฆุฌ</h3>
                            <div class="text-sm">${results.length} ูุชูุฌุฉ</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-xl">
                            <h3 class="font-bold text-orange-800 mb-2">๐พ ุงูุชุฎุฒูู</h3>
                            <div class="text-sm">${storageInfo.totalSize.toFixed(2)} MB ูุณุชุฎุฏู</div>
                        </div>
                    </div>
                    
                    <h3 class="font-bold text-gray-800 mb-3">๐ ุงูุชูุงุตูู:</h3>
                    <div class="bg-gray-50 p-4 rounded-xl text-sm font-mono max-h-64 overflow-y-auto">
                        <pre>${JSON.stringify({
                            teachers: demoData.users,
                            schools: demoData.schools,
                            results: results.length,
                            storage: storageInfo
                        }, null, 2)}</pre>
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                            ุฅุบูุงู
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const modalDiv = document.createElement('div');
        modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
        modalDiv.innerHTML = debugInfo;
        
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        ErrorHandler.logError(error, 'debugData');
    }
}

function debugSystem() {
    try {
        console.log('=== ูุญุต ุญุงูุฉ ุงููุธุงู ===');
        
        let systemStatus = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            online: navigator.onLine,
            storage: StorageManager.isStorageAvailable(),
            performance: 'performance' in window,
            canvas: !!document.createElement('canvas').getContext,
            systemHealth: SystemRecovery.checkSystemHealth(),
            resourceCounts: {
                timers: ResourceManager.timers.size,
                eventListeners: ResourceManager.eventListeners.size,
                sessions: ResourceManager.activeSessions.size
            }
        };
        
        console.log('๐ฅ๏ธ ุญุงูุฉ ุงููุธุงู:', systemStatus);
        
        // ุนุฑุถ ุงููุชุงุฆุฌ ูู ูุงูุฐุฉ
        let systemInfo = `
            <div class="bg-white rounded-3xl max-w-2xl w-full">
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center">
                    <h2 class="text-2xl font-bold">๐ฅ๏ธ ูุญุต ุญุงูุฉ ุงููุธุงู</h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-semibold">ุงูุชูููุช:</span>
                            <span class="text-sm">${new Date().toLocaleString('ar-SA')}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 ${systemStatus.online ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'} rounded-lg">
                            <span class="font-semibold">ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช:</span>
                            <span>${systemStatus.online ? '๐ข ูุชุตู' : '๐ด ุบูุฑ ูุชุตู'}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 ${systemStatus.storage ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'} rounded-lg">
                            <span class="font-semibold">ุงูุชุฎุฒูู ุงููุญูู:</span>
                            <span>${systemStatus.storage ? '๐ข ูุชุงุญ' : '๐ด ุบูุฑ ูุชุงุญ'}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 ${systemStatus.systemHealth ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'} rounded-lg">
                            <span class="font-semibold">ุตุญุฉ ุงููุธุงู:</span>
                            <span>${systemStatus.systemHealth ? '๐ข ุฌูุฏุฉ' : '๐ด ุชุญุชุงุฌ ุงูุชูุงู'}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="font-semibold">ุงููุคูุชุงุช ุงููุดุทุฉ:</span>
                            <span>${systemStatus.resourceCounts.timers}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="font-semibold">ูุณุชูุนู ุงูุฃุญุฏุงุซ:</span>
                            <span>${systemStatus.resourceCounts.eventListeners.size}</span>
                        </div>
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                            ุฅุบูุงู
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const modalDiv = document.createElement('div');
        modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
        modalDiv.innerHTML = systemInfo;
        
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        ErrorHandler.logError(error, 'debugSystem');
    }
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุฅุบูุงู ุงูููุงูุฐ ุงูููุจุซูุฉ
function closeModal(modalElement) {
    try {
        if (modalElement && modalElement.parentNode) {
            modalElement.parentNode.removeChild(modalElement);
        }
    } catch (error) {
        console.error('Error closing modal:', error);
    }
}

// ุฏุงูุฉ ุนุฑุถ ุงููุฏุงุฑุณ ูุน ุฅุตูุงุญุงุช ุงูุฅุบูุงู ูุงูุญุฐู
function showAllSchools() {
    try {
        let schoolsHTML = `
            <div class="bg-white rounded-3xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 text-center">
                    <h2 class="text-2xl font-bold">๐ซ ุฌููุน ุงููุฏุงุฑุณ ูู ุงููุธุงู</h2>
                    <p class="text-green-100 mt-2">ุฅุฏุงุฑุฉ ูุญุฐู ุญุณุงุจุงุช ุงููุฏุงุฑุณ</p>
                </div>
                <div class="p-6">
                    <div class="mb-4 text-right">
                        <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full">${Object.keys(demoData.schools).length} ูุฏุฑุณุฉ</span>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-yellow-600">โ๏ธ</span>
                            <h3 class="font-bold text-yellow-800">ุชูุจูู ููู</h3>
                        </div>
                        <p class="text-yellow-700 text-sm">
                            ุนูุฏ ุญุฐู ูุฏุฑุณุฉุ ุณูุชู ุญุฐู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุงููุชุงุฆุฌ ุงููุฑุชุจุทุฉ ุจูุง. ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.
                        </p>
                    </div>
        `;
        
        if (Object.keys(demoData.schools).length === 0) {
            schoolsHTML += `
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">๐ซ</div>
                    <p>ูุง ุชูุฌุฏ ูุฏุงุฑุณ ูู ุงููุธุงู</p>
                </div>
            `;
        } else {
            schoolsHTML += `<div class="space-y-4">`;
            
            Object.values(demoData.schools).forEach(school => {
                schoolsHTML += `
                    <div class="border border-gray-200 rounded-xl p-4 hover:shadow-lg transition-all">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-800">${school.name}</h3>
                                <p class="text-gray-600 text-sm">ุงููุนูู: ${school.teacher}</p>
                            </div>
                            <div class="flex gap-2">
                                <span class="bg-green-100 text-green-600 px-2 py-1 rounded text-sm">${school.tests.length} ุงุฎุชุจุงุฑ</span>
                                <button onclick="deleteSchool('${school.id}')" 
                                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm font-semibold transition-all flex items-center gap-1">
                                    ๐๏ธ ุญุฐู
                                </button>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-600 mb-3">
                            <div>
                                <span class="font-semibold">ูุนุฑู ุงููุฏุฑุณุฉ:</span>
                                <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">${school.id}</span>
                            </div>
                            <div>
                                <span class="font-semibold">ุนุฏุฏ ุงูุทูุงุจ:</span>
                                <span>${countStudentsInSchool(school.id)} ุทุงูุจ</span>
                            </div>
                        </div>
                        ${school.tests.length > 0 ? `
                            <div class="mt-3">
                                <h4 class="font-semibold text-gray-700 mb-2">ุงูุงุฎุชุจุงุฑุงุช:</h4>
                                <div class="space-y-2">
                                    ${school.tests.map(test => `
                                        <div class="bg-gray-50 p-2 rounded-lg">
                                            <div class="font-medium">${test.name}</div>
                                            <div class="text-xs text-gray-500">${test.subject} - ${test.grade} - ${test.questions.length} ุณุคุงู</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : '<div class="text-gray-500 text-sm text-center py-2">ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช</div>'}
                    </div>
                `;
            });
            
            schoolsHTML += `</div>`;
        }
        
        schoolsHTML += `
                    <div class="text-center mt-6">
                        <button onclick="closeCurrentModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
                            ุฅุบูุงู
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const modalDiv = document.createElement('div');
        modalDiv.id = 'schoolsModal';
        modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
        modalDiv.innerHTML = schoolsHTML;
        
        // ุฅุถุงูุฉ ูุณุชูุน ุญุฏุซ ูุฅุบูุงู ุงููุงูุฐุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
        modalDiv.addEventListener('click', function(event) {
            if (event.target === modalDiv) {
                closeModal(modalDiv);
            }
        });
        
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        ErrorHandler.logError(error, 'showAllSchools');
    }
}

// ุฏุงูุฉ ุฅุบูุงู ุงููุงูุฐุฉ ุงูุญุงููุฉ
function closeCurrentModal() {
    const modal = document.getElementById('schoolsModal');
    if (modal) {
        closeModal(modal);
    }
}

// ุฏุงูุฉ ุญุณุงุจ ุนุฏุฏ ุงูุทูุงุจ ูู ุงููุฏุฑุณุฉ
function countStudentsInSchool(schoolId) {
    try {
        const results = loadResults();
        const school = demoData.schools[schoolId];
        if (!school) return 0;
        
        const schoolResults = results.filter(result => 
            result.school === school.name && result.teacher === school.teacher
        );
        
        // ุญุณุงุจ ุนุฏุฏ ุงูุทูุงุจ ุงููุฑูุฏูู
        const uniqueStudents = new Set(schoolResults.map(result => result.name));
        return uniqueStudents.size;
    } catch (error) {
        ErrorHandler.logError(error, 'countStudentsInSchool');
        return 0;
    }
}

// ุฏุงูุฉ ุญุฐู ุงููุฏุฑุณุฉ - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
function deleteSchool(schoolId) {
    try {
        console.log('ุจุฏุก ุญุฐู ุงููุฏุฑุณุฉ:', schoolId);
        
        // ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุคูู
        if (!currentUser || currentUser.email !== 'chartgain2019@gmail.com') {
            alert('โ๏ธ ูุฐู ุงูููุฒุฉ ูุชุงุญุฉ ููุท ูููุณุคูู');
            return;
        }
        
        const school = demoData.schools[schoolId];
        if (!school) {
            alert('โ ุงููุฏุฑุณุฉ ุบูุฑ ููุฌูุฏุฉ');
            return;
        }
        
        // ุนุฑุถ ุชุญุฐูุฑ ุชุฃููุฏู
        const studentCount = countStudentsInSchool(schoolId);
        const testCount = school.tests.length;
        
        const confirmationMessage = `
โ๏ธ ุชุฃููุฏ ุญุฐู ุงููุฏุฑุณุฉ

๐ซ ุงุณู ุงููุฏุฑุณุฉ: ${school.name}
๐จโ๐ซ ุงููุนูู: ${school.teacher}
๐ ุนุฏุฏ ุงูุงุฎุชุจุงุฑุงุช: ${testCount}
๐ฅ ุนุฏุฏ ุงูุทูุงุจ: ${studentCount}

โ ุณูุชู ุญุฐู:
โข ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูู ูุฐู ุงููุฏุฑุณุฉ (${testCount} ุงุฎุชุจุงุฑ)
โข ุฌููุน ุงููุชุงุฆุฌ ุงููุฑุชุจุทุฉ ุจูุง
โข ุญุณุงุจ ุงููุฏุฑุณุฉ ุจุงููุงูู

๐ ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู

ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ุญุฐู ูุฐู ุงููุฏุฑุณุฉุ
        `.trim();
        
        if (!confirm(confirmationMessage)) {
            console.log('ุชู ุฅูุบุงุก ุงูุญุฐู ูู ูุจู ุงููุณุชุฎุฏู');
            return;
        }
        
        // 1. ุฃููุงู ุญุฐู ุงููุชุงุฆุฌ ุงููุฑุชุจุทุฉ ุจุงููุฏุฑุณุฉ
        console.log('ุฌุงุฑู ุญุฐู ุงููุชุงุฆุฌ ุงููุฑุชุจุทุฉ...');
        deleteSchoolResults(schoolId);
        
        // 2. ุซู ุญุฐู ุงููุฏุฑุณุฉ ูู ุงูุจูุงูุงุช
        console.log('ุฌุงุฑู ุญุฐู ุงููุฏุฑุณุฉ ูู ุงูุจูุงูุงุช...');
        delete demoData.schools[schoolId];
        
        // 3. ุญูุธ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ ูู ุงูุชุฎุฒูู ุงููุญูู
        console.log('ุฌุงุฑู ุญูุธ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ...');
        const schoolsSuccess = StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        if (schoolsSuccess) {
            console.log('โ ุชู ุญูุธ ุจูุงูุงุช ุงููุฏุงุฑุณ ุจูุฌุงุญ');
            
            // 4. ุชูุธูู ุงููุชุงุฆุฌ ุงููุญููุธุฉ
            const results = loadResults();
            const updatedResults = results.filter(result => {
                for (const existingSchool of Object.values(demoData.schools)) {
                    if (result.school === existingSchool.name && result.teacher === existingSchool.teacher) {
                        return true;
                    }
                }
                return false;
            });
            
            const resultsSuccess = StorageManager.setItem('testResults', updatedResults);
            if (resultsSuccess) {
                console.log('โ ุชู ุชุญุฏูุซ ุงููุชุงุฆุฌ ุจูุฌุงุญ');
            }
            
            // ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ
            showSuccessMessage('ุชู ุงูุญุฐู ุจูุฌุงุญ', `ุชู ุญุฐู ูุฏุฑุณุฉ "${school.name}" ูุฌููุน ุจูุงูุงุชูุง ุงููุฑุชุจุทุฉ`);
            
            console.log('โ ุชู ุญุฐู ุงููุฏุฑุณุฉ ุจูุฌุงุญ:', schoolId);
            
            // ุฅุนุงุฏุฉ ุชุญููู ูุงุฆูุฉ ุงููุฏุงุฑุณ ุจุนุฏ ุชุฃุฎูุฑ ุจุณูุท
            setTimeout(() => {
                // ุฅุบูุงู ุงููุงูุฐุฉ ุงูุญุงููุฉ ููุชุญูุง ูุฌุฏุฏุงู
                const currentModal = document.getElementById('schoolsModal');
                if (currentModal) {
                    closeModal(currentModal);
                }
                showAllSchools();
            }, 1500);
            
        } else {
            console.error('โ ูุดู ูู ุญูุธ ุจูุงูุงุช ุงููุฏุงุฑุณ ุจุนุฏ ุงูุญุฐู');
            alert('โ ูุดู ูู ุญุฐู ุงููุฏุฑุณุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
        }
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุงููุฏุฑุณุฉ:', error);
        ErrorHandler.logError(error, 'deleteSchool');
        alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุฏุฑุณุฉ: ' + error.message);
    }
}

// ุฏุงูุฉ ุญุฐู ูุชุงุฆุฌ ุงููุฏุฑุณุฉ - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
function deleteSchoolResults(schoolId) {
    try {
        const school = demoData.schools[schoolId];
        if (!school) {
            console.log('ุงููุฏุฑุณุฉ ุบูุฑ ููุฌูุฏุฉ ูุญุฐู ุงููุชุงุฆุฌ:', schoolId);
            return;
        }
        
        const results = loadResults();
        const schoolName = school.name;
        const teacherName = school.teacher;
        
        console.log(`ุฌุงุฑู ุญุฐู ูุชุงุฆุฌ ุงููุฏุฑุณุฉ: ${schoolName} - ${teacherName}`);
        
        const updatedResults = results.filter(result => {
            const shouldKeep = !(result.school === schoolName && result.teacher === teacherName);
            if (!shouldKeep) {
                console.log('ุญุฐู ูุชูุฌุฉ:', result.name, result.test);
            }
            return shouldKeep;
        });
        
        const success = StorageManager.setItem('testResults', updatedResults);
        
        if (success) {
            console.log(`โ ุชู ุญุฐู ${results.length - updatedResults.length} ูุชูุฌุฉ ูุฑุชุจุทุฉ ุจุงููุฏุฑุณุฉ`);
        } else {
            console.error('โ ูุดู ูู ุญูุธ ุงููุชุงุฆุฌ ุงููุญุฏุซุฉ');
        }
        
        return success;
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ูุชุงุฆุฌ ุงููุฏุฑุณุฉ:', error);
        ErrorHandler.logError(error, 'deleteSchoolResults');
        return false;
    }
}

// ========== ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ==========

async function updateWelcomeStatistics() {
    try {
        console.log('๐ ุฌุงุฑู ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช...');
        
        let stats;
        try {
            // ูุญุงููุฉ ุฌูุจ ุงูุฅุญุตุงุฆูุงุช ูู ุงูุฎุงุฏู
            stats = await APIService.getStatistics();
            console.log('โ ุงูุฅุญุตุงุฆูุงุช ูู ุงูุฎุงุฏู:', stats);
        } catch (error) {
            console.error('โ ูุดู ูู ุฌูุจ ุงูุฅุญุตุงุฆูุงุช ูู ุงูุฎุงุฏู:', error);
            // ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ ููุณุฎุฉ ุงุญุชูุงุทูุฉ
            stats = {
                totalSchools: Object.keys(demoData.schools).length,
                totalTeachers: Object.keys(demoData.users).length,
                totalTests: Object.values(demoData.schools).reduce((sum, school) => 
                    sum + (school.tests ? school.tests.length : 0), 0
                ),
                totalResults: loadResults().length
            };
        }
        
        // ุชุญุฏูุซ ุงูุนูุงุตุฑ
        const elements = {
            statsSchools: document.getElementById('statsSchools'),
            statsTeachers: document.getElementById('statsTeachers'),
            statsTests: document.getElementById('statsTests'),
            statsResults: document.getElementById('statsResults')
        };
        
        if (elements.statsSchools) elements.statsSchools.textContent = stats.totalSchools;
        if (elements.statsTeachers) elements.statsTeachers.textContent = stats.totalTeachers;
        if (elements.statsTests) elements.statsTests.textContent = stats.totalTests;
        if (elements.statsResults) elements.statsResults.textContent = stats.totalResults;
        
        console.log('๐ ุงูุฅุญุตุงุฆูุงุช ุงููุญุฏุซุฉ:', stats);
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช:', error);
    }
}

// ========== ุชููุฆุฉ ุงููุธุงู ุนูุฏ ุงูุชุญููู ==========

document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log('๐ ุจุฏุก ุชุญููู ูุธุงู ุงูุงุฎุชุจุงุฑุงุช ุงูุชูุงุนูู...');
        
        // ุชููุฆุฉ ุฃูุธูุฉ ุงูุงุณุชูุฑุงุฑ
        SystemRecovery.initialize();
        
        // ุชููุฆุฉ ูุธุงู ุงูุชุฎุฒูู
        StorageManager.initializeStorage();
        
        // ุชุญููู ุงูุจูุงูุงุช ุงููุญููุธุฉ
        loadTeacherAccounts();
        
        // ุชุญููู ุจูุงูุงุช ุงููุฏุงุฑุณ
        const storedSchools = StorageManager.getItem('demoSchoolsData');
        if (storedSchools) {
            demoData.schools = storedSchools;
            console.log('ุชู ุชุญููู ุจูุงูุงุช ุงููุฏุงุฑุณ:', Object.keys(storedSchools).length, 'ูุฏุฑุณุฉ');
        }
        
        // ุชุญููู ุงููุฏุงุฑุณ ูููุนูููู ุงูุญุงูููู
        loadSchoolsForExistingTeachers();
        
        // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
        updateWelcomeStatistics();
        
        // ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ
        setupEventListeners();
        
        // ุงูุชุญูู ูู ูุฌูุฏ ุฌูุณุฉ ุณุงุจูุฉ ูุงุณุชุนุงุฏุชูุง
        const previousSession = SystemRecovery.recoverPreviousSession();
        if (previousSession && previousSession.testInProgress) {
            console.log('ุชู ุงูุชุดุงู ุฌูุณุฉ ุงุฎุชุจุงุฑ ุณุงุจูุฉ:', previousSession);
            // ูููู ุฅุถุงูุฉ ููุทู ุงุณุชุนุงุฏุฉ ุงูุฌูุณุฉ ููุง ุฅุฐุง ูุฒู ุงูุฃูุฑ
        }
        
        console.log('โ ุชู ุชุญููู ุงููุธุงู ุจูุฌุงุญ');
        
    } catch (error) {
        ErrorHandler.logError(error, 'DOMContentLoaded');
    }
});

document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log('๐ ุจุฏุก ุชุญููู ูุธุงู ุงูุงุฎุชุจุงุฑุงุช ุงูุชูุงุนูู...');
        
        // ุชููุฆุฉ ุฃูุธูุฉ ุงูุงุณุชูุฑุงุฑ
        SystemRecovery.initialize();
        
        // ุชููุฆุฉ ูุธุงู ุงูุชุฎุฒูู
        StorageManager.initializeStorage();
        
        // ุชุญููู ุงูุจูุงูุงุช ุงููุญููุธุฉ
        loadTeacherAccounts();
        
        // ุชุญููู ุจูุงูุงุช ุงููุฏุงุฑุณ
        const storedSchools = StorageManager.getItem('demoSchoolsData');
        if (storedSchools) {
            demoData.schools = storedSchools;
            console.log('ุชู ุชุญููู ุจูุงูุงุช ุงููุฏุงุฑุณ:', Object.keys(storedSchools).length, 'ูุฏุฑุณุฉ');
        }
        
        // ุชุญููู ุงููุฏุงุฑุณ ูููุนูููู ุงูุญุงูููู
        loadSchoolsForExistingTeachers();
        
        // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ูู ุงูุฎุงุฏู โ ุฃุถู ูุฐุง ุงูุณุทุฑ
        updateWelcomeStatistics();
        
        // ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ
        setupEventListeners();
        
        // ุงูุชุญูู ูู ูุฌูุฏ ุฌูุณุฉ ุณุงุจูุฉ ูุงุณุชุนุงุฏุชูุง
        const previousSession = SystemRecovery.recoverPreviousSession();
        if (previousSession && previousSession.testInProgress) {
            console.log('ุชู ุงูุชุดุงู ุฌูุณุฉ ุงุฎุชุจุงุฑ ุณุงุจูุฉ:', previousSession);
        }
        
        console.log('โ ุชู ุชุญููู ุงููุธุงู ุจูุฌุงุญ');
        
    } catch (error) {
        ErrorHandler.logError(error, 'DOMContentLoaded');
    }
});
	
function setupEventListeners() {
    try {
        // ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ ููููุงูุฐ ุงูููุจุซูุฉ
        const testModal = document.getElementById('testModal');
        const questionModal = document.getElementById('questionModal');
        
        // ุฅุบูุงู ุงูููุงูุฐ ุงูููุจุซูุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
        if (testModal) {
            ResourceManager.addEventListener(testModal, 'click', function(event) {
                if (event.target === testModal) {
                    closeTestModal();
                }
            });
        }
        
        if (questionModal) {
            ResourceManager.addEventListener(questionModal, 'click', function(event) {
                if (event.target === questionModal) {
                    closeQuestionModal();
                }
            });
        }
        
        // ุฅุนุฏุงุฏ ููุชุฑ ุงูุชุงุฑูุฎ ุงููุฎุตุต
        const dateFilter = document.getElementById('filterDateSelect');
        const customDateFilter = document.getElementById('customDateFilter');
        
        if (dateFilter && customDateFilter) {
            ResourceManager.addEventListener(dateFilter, 'change', function() {
                if (this.value === 'custom') {
                    customDateFilter.classList.remove('hidden');
                } else {
                    customDateFilter.classList.add('hidden');
                }
            });
        }
        
        console.log('โ ุชู ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ');
    } catch (error) {
        ErrorHandler.logError(error, 'setupEventListeners');
    }
}

// ========== ุชูุธูู ุงููุธุงู ุนูุฏ ุฅุบูุงู ุงูุตูุญุฉ ==========

window.addEventListener('beforeunload', function() {
    try {
        // ุชูุธูู ุงูููุงุฑุฏ
        ResourceManager.cleanup();
        
        // ุญูุธ ุญุงูุฉ ุงููุธุงู
        SystemRecovery.saveSession({
            lastActivity: Date.now(),
            currentScreen: getCurrentScreen()
        });
    } catch (error) {
        console.error('Error during cleanup:', error);
    }
});

function getCurrentScreen() {
    const screens = [
        'welcomeScreen',
        'studentAccessScreen', 
        'teacherDashboard',
        'testScreen',
        'resultsScreen'
    ];
    
    for (const screen of screens) {
        const element = document.getElementById(screen);
        if (element && !element.classList.contains('hidden')) {
            return screen;
        }
    }
    return 'unknown';
}

// ========== ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงูุนุงูููุฉ ==========

// ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงูุนุงูููุฉ
window.addEventListener('error', function(e) {
    console.error('โ ุฎุทุฃ ุนุงู:', e.error);
    console.error('โ ูู ุงูููู:', e.filename);
    console.error('โ ุงูุณุทุฑ:', e.lineno);
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('โ Promise ูุฑููุถ:', e.reason);
});

function checkLibraries() {
    console.log('๐ ูุญุต ุงูููุชุจุงุช...');
    
    if (typeof XLSX === 'undefined') {
        console.warn('โ๏ธ ููุชุจุฉ XLSX ุบูุฑ ูุญููุฉ');
    } else {
        console.log('โ ููุชุจุฉ XLSX ูุญููุฉ');
    }
    
    if (typeof html2canvas === 'undefined') {
        console.warn('โ๏ธ ููุชุจุฉ html2canvas ุบูุฑ ูุญููุฉ');
    } else {
        console.log('โ ููุชุจุฉ html2canvas ูุญููุฉ');
    }
    
    if (typeof jsPDF === 'undefined') {
        console.warn('โ๏ธ ููุชุจุฉ jsPDF ุบูุฑ ูุญููุฉ');
    } else {
        console.log('โ ููุชุจุฉ jsPDF ูุญููุฉ');
    }
}

// ุงุณุชุฏุนุงุก ุงูุชุญูู ุจุนุฏ ุชุญููู ุงูุตูุญุฉ
setTimeout(checkLibraries, 2000);

// ุงูุชุญูู ูู ุญุงูุฉ ุงููุธุงู
function checkSystemStatus() {
    console.log('๐ฅ๏ธ ุญุงูุฉ ุงููุธุงู:');
    console.log('๐ Online:', navigator.onLine);
    console.log('๐ LocalStorage:', typeof Storage !== 'undefined');
    console.log('๐ Canvas:', !!document.createElement('canvas').getContext);
    console.log('๐ ูููุน ุงูุตูุญุฉ:', window.location.href);
}
	
// ุชุดุบูู ูุญุต ุงููุธุงู
setTimeout(checkSystemStatus, 1000);
		
// ========== ุชุฌุงูู ูุงูู ูุฃุฎุทุงุก ุงูุงูุชุฏุงุฏุงุช ==========
(function() {
    'use strict';
    
    // ุชุฌุงูู ุฃุฎุทุงุก hotkeys ูู ุงูุงูุชุฏุงุฏุงุช
    const originalOnError = window.onerror;
    window.onerror = function(message, source, lineno, colno, error) {
        if (message && typeof message === 'string' && message.includes('hotkeys')) {
            console.log('๐ ุชู ุชุฌุงูู ุฎุทุฃ ุงูุชุฏุงุฏ: hotkeys');
            return true; // ููุน ุงูุชุดุงุฑ ุงูุฎุทุฃ
        }
        if (originalOnError) {
            return originalOnError.apply(this, arguments);
        }
        return false;
    };
    
    // ุชุฌุงูู ุฃุฎุทุงุก ุงููุนูุฏ ูู ุงูุงูุชุฏุงุฏุงุช
    window.addEventListener('unhandledrejection', function(event) {
        if (event.reason && 
            (event.reason.message && event.reason.message.includes('hotkeys')) ||
            (typeof event.reason === 'string' && event.reason.includes('hotkeys'))) {
            event.preventDefault();
            console.log('๐ ุชู ุชุฌุงูู ุฎุทุฃ promise ุงูุชุฏุงุฏ');
        }
    });
    
    console.log('โ ุชู ุชูุนูู ูุธุงู ุชุฌุงูู ุฃุฎุทุงุก ุงูุงูุชุฏุงุฏุงุช');
})();

// ููุน ุธููุฑ ุฃุฎุทุงุก ุงูุงูุชุฏุงุฏุงุช ูู ุงููููุณูู
(function() {
    'use strict';
    
    // ุญูุธ ุงููููุณูู ุงูุฃุตูู
    const originalError = console.error;
    const originalWarn = console.warn;
    
    // ุชุตููุฉ ุงูุฃุฎุทุงุก ุงููุฑุชุจุทุฉ ุจุงูุงูุชุฏุงุฏุงุช
    console.error = function(...args) {
        if (args.some(arg => 
            (typeof arg === 'string' && arg.includes('hotkeys')) ||
            (arg && arg.message && arg.message.includes('hotkeys'))
        )) {
            console.log('๐ ุฎุทุฃ ุงูุชุฏุงุฏ ุชู ุชุตููุชู');
            return;
        }
        originalError.apply(console, args);
    };
    
    console.warn = function(...args) {
        if (args.some(arg => 
            typeof arg === 'string' && arg.includes('hotkeys')
        )) {
            console.log('๐ ุชุญุฐูุฑ ุงูุชุฏุงุฏ ุชู ุชุตููุชู');
            return;
        }
        originalWarn.apply(console, args);
    };
})();

// ุงูุญู ุงูุดุงูู ุงูููุงุฆู
(function() {
    'use strict';
    
    // 1. ุชุนุฑูู ุดุงูู ูู hotkeys
    if (typeof hotkeys === 'undefined') {
        window.hotkeys = function Hotkeys() { return window.hotkeys; };
        Object.assign(window.hotkeys, {
            filter: () => window.hotkeys,
            key: () => window.hotkeys, 
            unbind: () => window.hotkeys,
            isPressed: () => false,
            getPressedKeyCodes: () => [],
            shift: () => window.hotkeys,
            ctrl: () => window.hotkeys,
            alt: () => window.hotkeys,
            meta: () => window.hotkeys
        });
    }
    
    // 2. ููุน ูุงูุฉ ุฃุฎุทุงุก ุงูุงูุชุฏุงุฏุงุช
    const safeErrorHandler = function(event) {
        if (event.error && event.error.message && event.error.message.includes('hotkeys')) {
            event.preventDefault();
            event.stopImmediatePropagation();
            return true;
        }
        return false;
    };
    
    window.addEventListener('error', safeErrorHandler, true);
    window.addEventListener('unhandledrejection', safeErrorHandler, true);
    
    console.log('๐ก๏ธ  ุงููุธุงู ูุญูู ูู ุฃุฎุทุงุก ุงูุงูุชุฏุงุฏุงุช');
})();	

// ุฏุงูุฉ ูุณุงุนุฏุฉ ููุชุญูู ูู ุตุญุฉ ุจูุงูุงุช ุงูุงุฎุชุจุงุฑ
function validateTestData(test) {
    if (!test) return false;
    if (!test.name || !test.subject || !test.grade) return false;
    if (!test.questions || !Array.isArray(test.questions)) return false;
    return true;
}

// ุชุญุฏูุซ ุจูุงูุงุช demoData ูุชุถููู ุงููุฏุฑุณุฉ ุงูุงูุชุฑุงุถูุฉ
function updateDemoDataWithDefaultSchool() {
    if (!demoData.schools['school_default']) {
        demoData.schools['school_default'] = {
            id: 'school_default',
            name: 'ูุฏุฑุณุฉ ุงููููุฏ ุจู ุนูุงุฑุฉ ุงูุงุจุชุฏุงุฆูุฉ',
            teacher: 'ุฃ. ุนุจุฏุงููู ุงูุดูุฑู',
            tests: []
        };
        console.log('โ ุชู ุฅุถุงูุฉ ุงููุฏุฑุณุฉ ุงูุงูุชุฑุงุถูุฉ ุฅูู demoData');
    }
}

// ุชุดุบูู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
setTimeout(updateDemoDataWithDefaultSchool, 1000);

// ุชูุธูู ุงูุจูุงูุงุช ุงูุชุงููุฉ ูู localStorage
function cleanupCorruptedData() {
    try {
        console.log('๐งน ุฌุงุฑู ุชูุธูู ุงูุจูุงูุงุช ุงูุชุงููุฉ...');
        
        // ูุงุฆูุฉ ุจุงูููุงุชูุญ ุงูุชู ูุฏ ุชุญุชูู ุนูู ุจูุงูุงุช ุชุงููุฉ
        const potentialCorruptedKeys = ['authToken', 'currentUser', 'currentSession'];
        
        potentialCorruptedKeys.forEach(key => {
            try {
                const item = localStorage.getItem(key);
                if (item) {
                    // ุฅุฐุง ูุงู ุงูููุชุงุญ ูุญุชูู ุนูู JSON ุชุงููุ ุญุงูู ุฅุตูุงุญู
                    if (item.startsWith('{') || item.startsWith('[')) {
                        JSON.parse(item); // ูุฌุฑุฏ ูุญุงููุฉ ุชุญูู
                        console.log(`โ ${key}: ุจูุงูุงุช ุณูููุฉ`);
                    } else {
                        console.log(`โ ${key}: ุจูุงูุงุช string ุนุงุฏูุฉ`);
                    }
                }
            } catch (error) {
                console.warn(`โ ${key}: ุจูุงูุงุช ุชุงููุฉ - ุฌุงุฑู ุงูุฅุตูุงุญ...`);
                // ุญุฐู ุงูุจูุงูุงุช ุงูุชุงููุฉ
                localStorage.removeItem(key);
                console.log(`โ ${key}: ุชู ุชูุธูู ุงูุจูุงูุงุช ุงูุชุงููุฉ`);
            }
        });
        
        console.log('โ ุงูุชูู ุชูุธูู ุงูุจูุงูุงุช ุงูุชุงููุฉ');
    } catch (error) {
        console.error('โ ูุดู ูู ุชูุธูู ุงูุจูุงูุงุช ุงูุชุงููุฉ:', error);
    }
}

// ุชุดุบูู ุงูุชูุธูู ุจุนุฏ ุชุญููู ุงูุตูุญุฉ
setTimeout(cleanupCorruptedData, 2000);

// ุฏุงูุฉ ููุฒุงููุฉ ุงูุจูุงูุงุช ุจูู ุงูุฎุงุฏู ูุงูุชุฎุฒูู ุงููุญูู
async function syncSchoolData(schoolId) {
    try {
        console.log('๐ ูุฒุงููุฉ ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุน ุงูุฎุงุฏู...');
        
        const school = demoData.schools[schoolId];
        if (!school) {
            console.warn('โ ุงููุฏุฑุณุฉ ุบูุฑ ููุฌูุฏุฉ ูุญููุงู ูููุฒุงููุฉ');
            return;
        }
        
        // ููุง ููููู ุฅุถุงูุฉ ููุฏ ูุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู ุงูุฎุงุฏู
        // ุฅุฐุง ูุงู ุงูุฎุงุฏู ูุฏุนู ุชุญุฏูุซ ุงูุจูุงูุงุช
        
        console.log('โ ุชูุช ูุฒุงููุฉ ุจูุงูุงุช ุงููุฏุฑุณุฉ');
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ูุฒุงููุฉ ุงูุจูุงูุงุช:', error);
    }
}

// ุฏุงูุฉ ูุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช ูุจุงุดุฑุฉ
function refreshTestsList(schoolId) {
    try {
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const testSelect = document.getElementById('testSelect');
        
        if (!selectedSchoolInfo || !testSelect) return;
        
        const school = demoData.schools[schoolId];
        if (!school || !school.tests) return;
        
        // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช
        testSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุงุฎุชุจุงุฑ</option>';
        
        if (school.tests.length > 0) {
            school.tests.forEach((test, index) => {
                if (test && test.name && test.subject && test.grade) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
                    testSelect.appendChild(option);
                }
            });
        }
        
        console.log('โ ุชู ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช ูุน ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ');
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช:', error);
    }
}
// ========== ุฏูุงู ุงูุชุญุฏูุซ ูุงููุฒุงููุฉ ุงูุฌุฏูุฏุฉ ==========

// ุฏุงูุฉ ูุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช ูุจุงุดุฑุฉ
function refreshTestsList(schoolId) {
    try {
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        const testSelect = document.getElementById('testSelect');
        
        if (!selectedSchoolInfo || !testSelect) {
            console.warn('โ ุนูุงุตุฑ ุชุญุฏูุซ ุงูุงุฎุชุจุงุฑุงุช ุบูุฑ ููุฌูุฏุฉ');
            return;
        }
        
        const school = demoData.schools[schoolId];
        if (!school || !school.tests) {
            console.warn('โ ูุง ุชูุฌุฏ ุจูุงูุงุช ูุฏุฑุณุฉ ููุงุฎุชุจุงุฑุงุช');
            return;
        }
        
        // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช
        testSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุงุฎุชุจุงุฑ</option>';
        
        let validTestsCount = 0;
        if (school.tests.length > 0) {
            school.tests.forEach((test, index) => {
                if (test && test.name && test.subject && test.grade) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${test.name} - ${test.subject} - ${test.grade}`;
                    testSelect.appendChild(option);
                    validTestsCount++;
                }
            });
        }
        
        console.log(`โ ุชู ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช - ${validTestsCount} ุงุฎุชุจุงุฑ ุตุงูุญ`);
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช:', error);
        ErrorHandler.logError(error, 'refreshTestsList');
    }
}

// ุฏุงูุฉ ูุชุญุฏูุซ ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุฏููุงู
function refreshSchoolData() {
    try {
        const selectedSchoolInfo = document.getElementById('selectedSchoolInfo');
        if (!selectedSchoolInfo) {
            showErrorMessage('ุฎุทุฃ', 'ูู ูุชู ุชุญุฏูุฏ ูุฏุฑุณุฉ');
            return;
        }
        
        const schoolId = selectedSchoolInfo.dataset.schoolId;
        if (!schoolId) {
            showErrorMessage('ุฎุทุฃ', 'ูุนุฑู ุงููุฏุฑุณุฉ ุบูุฑ ููุฌูุฏ');
            return;
        }
        
        console.log('๐ ุชุญุฏูุซ ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุฏููุงู...');
        
        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูู ุงูุชุฎุฒูู ุงููุญูู
        const school = demoData.schools[schoolId];
        if (school) {
            refreshTestsList(schoolId);
            showSuccessMessage('ุชู ุงูุชุญุฏูุซ', 'ุชู ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช ุจูุฌุงุญ');
        } else {
            showErrorMessage('ุฎุทุฃ', 'ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ุงููุฏุฑุณุฉ');
        }
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุจูุงูุงุช:', error);
        showErrorMessage('ุฎุทุฃ', 'ูุดู ูู ุชุญุฏูุซ ุงูุจูุงูุงุช');
    }
}

// ุฏุงูุฉ ููุฒุงููุฉ ุงูุจูุงูุงุช ุจูู ุงูุฎุงุฏู ูุงูุชุฎุฒูู ุงููุญูู
async function syncSchoolData(schoolId) {
    try {
        console.log('๐ ูุฒุงููุฉ ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุน ุงูุฎุงุฏู...');
        
        const school = demoData.schools[schoolId];
        if (!school) {
            console.warn('โ ุงููุฏุฑุณุฉ ุบูุฑ ููุฌูุฏุฉ ูุญููุงู ูููุฒุงููุฉ');
            return;
        }
        
        // ููุง ููููู ุฅุถุงูุฉ ููุฏ ูุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู ุงูุฎุงุฏู
        // ุฅุฐุง ูุงู ุงูุฎุงุฏู ูุฏุนู ุชุญุฏูุซ ุงูุจูุงูุงุช
        console.log('๐ค ุฌุงูุฒ ูุฅุฑุณุงู ุจูุงูุงุช ุงููุฏุฑุณุฉ ุฅูู ุงูุฎุงุฏู:', school.tests.length, 'ุงุฎุชุจุงุฑ');
        
        // ูุญุงูุงุฉ ุงูุฅุฑุณุงู ุฅูู ุงูุฎุงุฏู (ููููู ุงุณุชุจุฏุงู ูุฐุง ุจุงูููุฏ ุงููุนูู)
        try {
            // const response = await fetch(`https://quiz-system-api.onrender.com/api/tests/${schoolId}`, {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify(school.tests)
            // });
            console.log('โ ุชูุช ูุฒุงููุฉ ุจูุงูุงุช ุงููุฏุฑุณุฉ (ูุญุงูุงุฉ)');
        } catch (syncError) {
            console.warn('โ๏ธ ูุดู ูู ูุฒุงููุฉ ุงูุจูุงูุงุช ูุน ุงูุฎุงุฏู:', syncError);
        }
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ูุฒุงููุฉ ุงูุจูุงูุงุช:', error);
        ErrorHandler.logError(error, 'syncSchoolData');
    }
}	

// ุฅุตูุงุญ ุจูุงูุงุช ุงููุนูู ุงูุญุงูู
function fixTeacherData() {
    try {
        console.log('๐ง ุฅุตูุงุญ ุจูุงูุงุช ุงููุนูู...');
        
        if (!currentUser) {
            console.warn('โ ูุง ููุฌุฏ ูุณุชุฎุฏู ูุณุฌู');
            return;
        }
        
        // ุงูุจุญุซ ุนู ูุฏุฑุณุฉ ุงููุนูู ุงูุญุงูู
        let teacherSchool = null;
        let teacherSchoolId = null;
        
        for (const schoolId in demoData.schools) {
            if (demoData.schools[schoolId].teacher === currentUser.name) {
                teacherSchool = demoData.schools[schoolId];
                teacherSchoolId = schoolId;
                break;
            }
        }
        
        // ุฅุฐุง ูู ุชูุฌุฏ ูุฏุฑุณุฉ ูููุนููุ ุฅูุดุงุคูุง
        if (!teacherSchool) {
            teacherSchoolId = 'school_' + Date.now();
            teacherSchool = {
                id: teacherSchoolId,
                name: currentUser.school,
                teacher: currentUser.name,
                tests: []
            };
            demoData.schools[teacherSchoolId] = teacherSchool;
            console.log('โ ุชู ุฅูุดุงุก ูุฏุฑุณุฉ ุฌุฏูุฏุฉ ูููุนูู');
        }
        
        // ูุณุฎ ุงูุงุฎุชุจุงุฑุงุช ูู ุงููุฏุฑุณุฉ ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ูุงูุช ูุงุฑุบุฉ
        const defaultSchool = demoData.schools['school_default'];
        if (defaultSchool && defaultSchool.tests && defaultSchool.tests.length > 0) {
            if (!teacherSchool.tests || teacherSchool.tests.length === 0) {
                teacherSchool.tests = JSON.parse(JSON.stringify(defaultSchool.tests)); // ูุณุฎ ุนููู
                console.log('โ ุชู ูุณุฎ ุงูุงุฎุชุจุงุฑุงุช ูู ุงููุฏุฑุณุฉ ุงูุงูุชุฑุงุถูุฉ');
            }
        }
        
        // ุชุญุฏูุซ ุงููุชุบูุฑ ุงูุญุงูู
        currentManagingTestSchoolId = teacherSchoolId;
        
        // ุญูุธ ุงูุจูุงูุงุช
        StorageManager.setItem('demoSchoolsData', demoData.schools);
        
        console.log('โ ุชู ุฅุตูุงุญ ุจูุงูุงุช ุงููุนูู:', {
            schoolId: teacherSchoolId,
            testsCount: teacherSchool.tests ? teacherSchool.tests.length : 0
        });
        
        // ุฅุนุงุฏุฉ ุชุญููู ุงูุงุฎุชุจุงุฑุงุช
        loadTeacherTests();
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅุตูุงุญ ุจูุงูุงุช ุงููุนูู:', error);
    }
}

// ุชุดุบูู ุงูุฅุตูุงุญ ุชููุงุฆูุงู ุนูุฏ ุฏุฎูู ุงููุนูู
function autoFixTeacherOnLogin() {
    if (currentUser && currentUser.email === 'chartgain2019@gmail.com') {
        setTimeout(fixTeacherData, 1000);
    }
}
	
</script>
   <!-- ุชุฐููู ูุชููุฒ -->
    <footer class="bg-gradient-to-r from-blue-800 to-purple-900 text-white py-4 text-center border-t border-blue-600">
        <div class="container mx-auto px-6">
            <p class="text-sm text-blue-200">
              ยฉ 2025 ุฌููุน ุงูุญููู ูุญููุธุฉ | ุชู ุฅูุดุงุก ูุฐู ุงูุตูุญุฉ ูุฃุบุฑุงุถ ุชุนููููุฉ ุจุฑูุฌุฉ ูุชุตููู ุงูุฃุณุชุงุฐ ุนุจุฏุงููู ุงูุดูุฑู
            </p>
        </div>
    </footer>
</body>
</html>
